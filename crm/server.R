source("global.R", local=TRUE)

server <- function(input, output, session){
  options(shiny.maxRequestSize=50*1024^2)
  
  
  vars <- reactiveValues(search_com = NA)
  vars$view <- place %>% st_as_sf(coords = c("lng", "lat"), crs = crs)
  vars$start <- TRUE
  vars$user <- NA
  vars$place <- data.frame()
  vars$place_agencia <- NA
  vars$pos_ini <- NA
  vars$mail_code <- NA
  vars$foto_inmo_file <- NA
  vars$galeria_fotos_inmo <- c()
  vars$click <- NA
  vars$foto_cliente <- NULL
  vars$busqueda_area <- NA
  vars$area_busqueda <- data.frame()
  vars$busqueda <- NA
  vars$click_busqueda <- NA
  vars$map_coinci <- NA
  vars$inmo_propio <- NA
  vars$clientes_all <- NA
  vars$data_all_pages <- NA
  vars$cliente_vinc <- NULL
  vars$list_clientes_vinc <- NA
  vars$list_inmuebles_vinc <- NA
  vars$list_clien_buscando <- NA
  vars$data_tab_task <- NA
  vars$id_fav <- NA
  vars$capa_list_all <- NA
  vars$tipologia_list_all <- data.frame()
  vars$link_capacitacion <- NA
  vars$new_agente <- FALSE
  vars$new_agencia <- FALSE
  vars$new_franquicia <- FALSE
  vars$image_perfil_new <- FALSE
  vars$galeria_inmo_order <- c()
  vars$galeria_tipo_order <- c()
  vars$change_cliente <- FALSE
  vars$image_perfil_edit <- FALSE
  vars$menu_selected <- NA
  vars$last_zoom_new_inmo <- 12
  vars$last_zoom_view <- 13
  vars$office_prop_list <- data.frame()
  vars$office_trans_list <- data.frame()
  vars$m2_casa <- 0
  vars$lujo <- FALSE
  vars$map_coords <- FALSE
  vars$text_coords <- FALSE
  vars$report_new <- FALSE
  
  fp <- reactive({
    req(input$fingerprint)
    input$fingerprint
  })
  
  
  date <- function(){
    date <- now("America/Asuncion")
    as.character(date)
  }
  
  observeEvent(input$map_agenda_inmo_draw_new_feature, {
    vars$place <- leaflet_draw(input$map_agenda_inmo_draw_new_feature)
    vars$place <- vars$place$df
  })
  
  observeEvent(input$map_new_busqueda_draw_new_feature, {
    vars$place <- leaflet_draw(input$map_new_busqueda_draw_new_feature)
    vars$area_busqueda <- vars$place$sf
    print("vars$area_busqueda event")
    print(vars$area_busqueda)
  })
  
#  output$keepAlive <- renderText({
#    req(input$count)
#    paste("  Online ", input$count, ifelse(input$count == 1, " minuto", " minutos"))
#  })  
  
  skyone_marker <- makeIcon(
    iconUrl = "skyone_marker.png",
    iconWidth = 60, iconHeight = 60,
    iconAnchorX = 30, iconAnchorY = 60
  )
  
  rosarioIcon <- makeIcon(
    iconUrl = "https://place-storage.nyc3.digitaloceanspaces.com/Marker%20Place.png",
    iconWidth = 54, iconHeight = 67,
    iconAnchorX = 21, iconAnchorY = 65
  )
  
  pin_360 <- makeIcon(
    iconUrl = "https://place-storage.nyc3.digitaloceanspaces.com/pins/photo.png",
    iconWidth = 30, iconHeight = 30,
    iconAnchorX = 15, iconAnchorY = 30
  )
  
  pin_360_visto <- makeIcon(
    iconUrl = "https://place-storage.nyc3.digitaloceanspaces.com/pins/photo_visto.png",
    iconWidth = 30, iconHeight = 30,
    iconAnchorX = 15, iconAnchorY = 30
  )
  
  observeEvent(getQueryString(), {
    if(vars$start == FALSE){
      req(getQueryString())
      query <- names(getQueryString())
      print(query)
      if(!is.null(query)){
        if(query == "home"){
          updateTabsetPanel(session, "menu",
                            selected = "home")
        }
        if(query == "asesoresoficina"){
          updateTabItems(session, "menu", selected = "office_agen")
        }
        if(query == "clientes"){
          updateTabsetPanel(session, "menu", selected = "clientes")
        }
        if(query == "estados"){
          updateTabsetPanel(session, "menu", selected = "estados")
        }
        if(query == "mispropiedades"){
          updateTabItems(session, "menu", selected = "prop_mios")
        }
        if(query == "crearpropiedades"){
          updateTabItems(session, "menu", selected = "prop_crear")
        }
        if(query == "todaslaspropiedades"){
          updateTabItems(session, "menu", selected = "prop_todas")
        }
        if(query == "misbusquedas"){
          updateTabItems(session, "menu", selected = "prop_bus")
        }
        if(query == "crearbusquedas"){
          updateTabItems(session, "menu", selected = "prop_bus_crear")
        }
        if(query == "todaslasbusquedas"){
          updateTabItems(session, "menu", selected = "bus_todas")
        }
        if(query == "minube"){
          updateTabsetPanel(session, "menu", selected = "mi_nube")
        }
        if(query == "capacitaciones"){
          updateTabsetPanel(session, "menu", selected = "capacitacion")
        }
      }
    }
  })
  
  ip <- reactive(input$getIP)
  
  output$menu_ui <- renderMenu({
    #req(vars$user)
    sidebarMenu(id = "menu", 
                menuItem(HTML("<p><span style='font-size: 120%; font-weight: bold'><i class='fa fa-home'></i> Home</span></p>"), 
                         tabName = "home", selected = TRUE),
                menuItem(HTML("<p><span style='font-size: 120%; font-weight: bold'><i class='fa fa-group'></i> My Office</span></p>"), 
                         tabName = "office",
                         menuSubItem('Asesores', tabName = 'office_agen'),
                         menuSubItem('Transacciones', tabName = 'office_trans'),
                         menuSubItem('Propiedades', tabName = 'office_prop'),
                         menuSubItem('Contabilidad', tabName = 'office_cont')
                ),
                menuItem(HTML("<p><span style='font-size: 120%; font-weight: bold'><i class='fa fa-clipboard-check'></i> Estados</span></p>"), 
                         tabName = "estados"),
                menuItem(HTML("<p><span style='font-size: 120%; font-weight: bold'><i class='fa fa-building'></i> Propiedades</span></p>"), 
                         tabName = "propiedades",
                         menuSubItem('Crear propiedad', tabName = 'prop_crear'),
                         menuSubItem('Mis propiedades', tabName = 'prop_mios'),
                         menuSubItem('Todas las propiedades', tabName = 'prop_todas')),
                menuItem(HTML("<p><span style='font-size: 120%; font-weight: bold'><i class='fa fa-search'></i> Búsquedas</span></p>"), 
                         tabName = "busquedas",
                         menuSubItem('Crear búsqueda', tabName = 'prop_bus_crear'),
                         menuSubItem('Mis búsquedas', tabName = 'prop_bus'),
                         menuSubItem('Todas las búsquedas', tabName = 'bus_todas')),
                menuItem(HTML("<p><span style='font-size: 120%; font-weight: bold'><i class='fa fa-users'></i> Clientes</span></p>"), 
                         tabName = "clientes"),
                menuItem(HTML("<p><span style='font-size: 120%; font-weight: bold'><i class='fa fa-cloud'></i> Mi nube</span></p>"), 
                         tabName = "mi_nube"),
                menuItem(HTML("<p><span style='font-size: 120%; font-weight: bold'><i class='fa fa-map-marker'></i> Place</span></p>"), 
                         tabName = "place",
                         menuSubItem('MyPlace', tabName = 'myplace'),
                         menuSubItem('PlaceAnalyzer', tabName = 'place_analyzer'),
                         menuSubItem('PlaceView', tabName = 'place_view')),
                menuItem(HTML("<p><span style='font-size: 120%; font-weight: bold'><i class='fa fa-chalkboard-teacher'></i> Capacitaciones</span></p>"), 
                         tabName = "capacitacion")
    )
  })
  
  home_on <- reactiveVal(0)
  task_on <- reactiveVal(0)
  eventos_on <- reactiveVal(0)
  office_agen_on <- reactiveVal(0)
  office_stat_on <- reactiveVal(0)
  new_inmo_on <- reactiveVal(0)
  edit_inmo_on <- reactiveVal(0)
  new_busqueda_on <- reactiveVal(0)
  clientes_on <- reactiveVal(0)
  mi_nube_on <- reactiveVal(0)
  capacitacion_on <- reactiveVal(0)
  inmo_input_on <- reactiveVal(0)
  busqueda_on <- reactiveVal(0)
  tipologia_on <- reactiveVal(0)
  page_on <- reactiveVal(0)
  show_inmo_on <- reactiveVal(0)
  show_clien_on <- reactiveVal(0)
  edit_clien_on <- reactiveVal(0)
  estado_on <- reactiveVal(0)
  captacion_on <- reactiveVal(0)
  colocacion_on <- reactiveVal(0)
  cierres_on <- reactiveVal(0)
  busquedas_on <- reactiveVal(0)
  coordinadora_on <- reactiveVal(0)
  alarmas_on <- reactiveVal(0)
  prop_todas_on <- reactiveVal(0)
  bus_todas_on <- reactiveVal(0)
  office_trans_on <- reactiveVal(0)
  office_prop_on <- reactiveVal(0)
  office_cont_on <- reactiveVal(0)
  office_cont_caja_on <- reactiveVal(0)
  office_cont_cobro_on <- reactiveVal(0)
  office_cont_pago_on <- reactiveVal(0)
  myplace_on <- reactiveVal(0)
  place_on <- reactiveVal(0)
  place_view_on <- reactiveVal(0)
  
  observe({
    if(vars$start == FALSE){
      req(input$menu)
      home_on(0)
      office_agen_on(0)
      office_stat_on(0)
      task_on(0)
      eventos_on(0)
      inmo_input_on(0)
      busqueda_on(0)
      clientes_on(0)
      new_inmo_on(0)
      new_busqueda_on(0)
      capacitacion_on(0)
      mi_nube_on(0)
      page_on(0)
      show_inmo_on(0)
      show_clien_on(0)
      edit_clien_on(0)
      estado_on(0)
      prop_todas_on(0)
      office_trans_on(0)
      office_prop_on(0)
      office_cont_on(0)
      office_cont_caja_on(0)
      office_cont_cobro_on(0)
      office_cont_pago_on(0)
      bus_todas_on(0)
      alarmas_on(0)
      myplace_on(0)
      place_view_on(0)
      place_on(0)
      
      isolate({  
        vars$new_cal <- list_table_var1_var2_var3_mysql(paste0(co, "_llamadas"), "user", vars$user$user, "realizado", "no", "fecha_agendada", "IN", as.character(as_date(now("America/Asuncion")))) %>%
          nrow()
        vars$new_eve <- list_table_var_mysql(paste0(co, "_eventos"), "fecha_agendada", as.character(as_date(now("America/Asuncion")))) %>% nrow()
        alarmas_all <- list_table_var1_var2_mysql(paste0(co, "_alarmas"), "destino", "all", "fecha", as.character(as_date(now("America/Asuncion"))))
        alarmas_mias <- list_table_var1_var2_mysql(paste0(co, "_alarmas"), "destino", vars$user$user, "fecha", as.character(as_date(now("America/Asuncion"))))
        new_bell <- rbind(alarmas_all, alarmas_mias) %>% filter(user != vars$user$user) %>% nrow()
        
        campana <- list_table_var_mysql("myplace_campana", "user", "gmayeregger@gmail.com")
        
        if(nrow(campana) == 0){
          campana <- data.frame(id = new_id_table_mysql("id", "myplace_campana", "campana_", 12),
                                user = vars$user$user,
                                alarmas_vistas = 0,
                                fecha_ultima_alarma = as.character(now("America/Asuncion"))
          )
          save_mysql(campana, "myplace_campana", FALSE)
        }
        
        if(as_date(campana$fecha_ultima_alarma) == as_date(now("America/Asuncion"))){
          vars$new_bell <- new_bell - campana$alarmas_vistas
        }else{
          vars$new_bell <- new_bell
        }
        update_var_table_mysql(new_bell, "alarmas_vistas", "user", vars$user$user, "myplace_campana")
        update_var_table_mysql(as.character(now("America/Asuncion")), "fecha_ultima_alarma", "user", vars$user$user, "myplace_campana")
        print("cargo contadores")
      })
      vars$galeria_inmo_order <- c()
      vars$galeria_fotos_inmo <- c()
      vars$foto_inmo_file <- NA
      vars$upload_inmo <- NULL
      vars$galeria_cont_order <- c()
      vars$galeria_fotos_cont <- c()
      vars$foto_cont_file <- NA
      vars$ind_galeria_fotos_cont <- 0
      vars$upload_cont <- NULL
      
      vars$data_per_page_back <- data.frame()
      vars$data_all_pages <- data.frame()
      vars$page_selected <- 1
      vars$data_per_page <- data.frame()
      
      open_scroll_1$boxes = list()
      open_scroll_1$obs_open_scroll = list()
      open_scroll_1$obs_new_comentario = list()
      vars$n_scroll_1 <- 0
      vars$list_scroll_1 <- data.frame()
    
      open_scroll_2$boxes = list()
      open_scroll_2$obs_open_scroll = list()
      open_scroll_2$obs_new_comentario = list()
      vars$n_scroll_2 <- 0
      vars$list_scroll_2 <- data.frame()
      
      open_scroll_3$boxes = list()
      open_scroll_3$obs_open_scroll = list()
      open_scroll_3$obs_new_comentario = list()
      vars$n_scroll_3 <- 0
      vars$list_scroll_3 <- data.frame()
      
      hideElement("home_ui")
      hideElement("box_inmo_ui")
      hideElement("box_office_trans_ui")
      hideElement("box_office_prop_ui")
      hideElement("box_clien_ui")
      hideElement("box_busqueda_ui")
      hideElement("prop_todas_ui")
      
      if(input$menu == "home"){
        updateQueryString("?home", mode = "push")
        edit_inmo_on(0)
        home_on(1)
        showElement("home_ui")
      }
      if(input$menu == "estados"){
        updateQueryString("?estados", mode = "push")
        isolate({
          ind_hoy_on(1)
          ind_vencido_on(0)
          ind_aldia_on(0)
          ind_manana_on(0)
          ind_siguientes_on(0)
        })
        edit_inmo_on(0)
        estado_on(1)
        colocacion_on(0)
        cierres_on(0)
        captacion_on(1)
        busquedas_on(0)
        coordinadora_on(0)
        
      }
      if(input$menu == "office_agen"){
        updateQueryString("?asesoresoficina", mode = "push")
        isolate({
          vars$n_per_page <- clien_per_page
          vars$max_pages <- clien_max_pages
          
          vars$office_agen_all <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "agencia", vars$user$agencia) %>% arrange(desc(cargo))
          vars$office_agen_all_pages <- vars$office_agen_all
        }) 
        edit_inmo_on(0)
        office_agen_on(1)
        print("inicio office agen")
      }
      if(input$menu == "office_trans"){
        
        updateQueryString("?transacciones", mode = "push")
        isolate({
          if(vars$user$cargo %in% c("Global Master Office", "Global Office Assistant", "Global Office Manager")){
            office_trans_list <- load_mysql(paste0(co, "_transacciones"))
            users <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", office_trans_list$user)
          }else{
            if(vars$user$cargo %in% c("Broker Assistant", "Broker Manager", "Broker Office", "Country Office Manager", "Country Master Office")){
              users <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "agencia", vars$user$agencia)
              office_trans_list <- list_table_var_mysql(paste0(co, "_transacciones"), "user", users$user)
            }else{
              office_trans_list <- data.frame()
            }
          }
          if(nrow(office_trans_list) != 0){
            users <- users %>% mutate(
              pais_agencia = sapply(agencia, FUN = function(x){
                ifelse(x == "Global Master Office", "Paraguay", ifelse(x %in% vars$agencias$id, vars$agencias$pais[vars$agencias$id == x], vars$franquicias$pais[vars$franquicias$id == x]))}),
              name_agencia = sapply(agencia, FUN = function(x){
                ifelse(x == "Global Master Office", "Global Master Office", ifelse(x %in% vars$agencias$id, vars$agencias$name[vars$agencias$id == x], vars$franquicias$name[vars$franquicias$id == x]))})
            )
            users <- users %>% select(user = user, user_name = name, pais_agencia = pais_agencia, name_agencia = name_agencia)
            vars$office_trans_list <- left_join(office_trans_list, users, by = "user")
          }else{
            vars$office_trans_list <- data.frame()
          }
          vars$trans_paices <- unique(vars$office_trans_list$pais_agencia)
        })
        edit_inmo_on(0)
        office_trans_on(1)
        showElement("box_office_trans_ui")
      }
      if(input$menu == "office_prop"){
        updateQueryString("?office_propiedades", mode = "push")
        isolate({
          vars$n_per_page <- office_prop_per_page
          vars$max_pages <- office_prop_max_pages
          
          if(vars$user$cargo %in% c("Global Master Office", "Global Office Assistant", "Global Office Manager")){
            office_prop_list <- query_mysql("SELECT * FROM myplace_inmuebles WHERE company = 'skyone' ORDER BY fecha DESC")
            users <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", office_prop_list$user)
          }else{
            if(vars$user$cargo %in% c("Broker Assistant", "Broker Manager", "Broker Office", "Country Office Manager", "Country Master Office")){
              users <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "agencia", vars$user$agencia)
              office_prop_list <- query_mysql(paste0("SELECT * FROM myplace_inmuebles WHERE company = 'skyone' AND user IN ",
                                                     paste("(", paste(paste0("'", users$user,"'"),collapse = ","), ")"),
                                                     " ORDER BY fecha DESC;"))
            }else{
              office_prop_list <- data.frame()
            }
          }
          if(nrow(office_prop_list) != 0){
            users <- users %>% mutate(
              pais_agencia = sapply(agencia, FUN = function(x){
                ifelse(x == "Global Master Office", "Paraguay", ifelse(x %in% vars$agencias$id, vars$agencias$pais[vars$agencias$id == x], vars$franquicias$pais[vars$franquicias$id == x]))}),
              name_agencia = sapply(agencia, FUN = function(x){
                ifelse(x == "Global Master Office", "Global Master Office", ifelse(x %in% vars$agencias$id, vars$agencias$name[vars$agencias$id == x], vars$franquicias$name[vars$franquicias$id == x]))})
            )
            users <- users %>% select(user, name, pais_agencia, name_agencia)
            vars$office_prop_list <- left_join(office_prop_list, users, by = "user")
          }else{
            vars$office_prop_list <- data.frame()
          }
          vars$data_all_pages <- vars$office_prop_list
          vars$page_selected <- 1
          vars$data_per_page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, 1)$data
        })
        edit_inmo_on(0)
        office_prop_on(1)
        page_on(1)
        showElement("box_office_prop_ui")
      }
      if(input$menu == "office_cont"){
        updateQueryString("?office_contabilidad", mode = "push")
        isolate({
          vars$office_cont_list_all <- load_mysql(paste0(co, "_pagos"))
          office_cont_caja_on(1)
        })
        edit_inmo_on(0)
        office_cont_on(1)
      }
      if(input$menu == "clientes"){
        updateQueryString("?clientes", mode = "push")
        isolate({
          vars$n_per_page <- clien_per_page
          vars$max_pages <- clien_max_pages
          vars$clientes_all <- list_table_var_mysql(paste0(co, "_clientes"), "user", vars$user$user)
          vars$clientes_all_pages <- vars$clientes_all
        })
        edit_inmo_on(0)
        clientes_on(1)
        page_on(1)
        showElement("box_clien_ui")
      }
      if(input$menu == "prop_crear") {
        updateQueryString("?crearpropiedades", mode = "push")
        vars$foto_inmo_file <- NA
        vars$galeria_fotos_inmo <- c()
        new_inmo_on(1)
      }
      if(input$menu == "prop_bus_crear") {
        updateQueryString("?crearbusquedas", mode = "push")
        output$map_new_busqueda <- renderLeaflet({
          leaflet() %>% addSearchOSM() %>%
            setView(st_coordinates(vars$view)[1], st_coordinates(vars$view)[2], zoom = 12) %>%
            addMarkers(data = vars$view, icon = skyone_marker) %>%
            addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
            addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
            addLayersControl(baseGroups = c("mapa", "satélite"),
                             options = layersControlOptions(collapsed=FALSE), position = "bottomleft") %>%
            addDrawToolbar(polylineOptions = FALSE, circleOptions = FALSE, rectangleOptions = FALSE,
                           circleMarkerOptions = FALSE, markerOptions = FALSE, polygonOptions = TRUE,
                           editOptions = editToolbarOptions(selectedPathOptions = selectedPathOptions())) 
        })
        vars$area_busqueda <- data.frame()
        edit_inmo_on(0)
        new_busqueda_on(1)
      }
      if(input$menu == "prop_mios") {
        updateQueryString("?mispropiedades", mode = "push")
        isolate({
          vars$n_per_page <- inmo_per_page
          vars$max_pages <- inmo_max_pages
          vars$inmo_propio_list <- list_table_var1_var2_mysql("myplace_inmuebles", "user", vars$user$user, "company", co)
        })
        edit_inmo_on(0)
        inmo_input_on(1)
        page_on(1)
        showElement("box_inmo_ui")
      }
      if(input$menu == "prop_todas"){
        updateQueryString("?propiedadesoficina", mode = "push")
        isolate({
          vars$n_per_page <- busqueda_per_page
          vars$max_pages <- busqueda_max_pages
          vars$users_office_all <- list_table_var_mysql("myplace_usuarios", "company", co)
          vars$prop_todas_list_all <- query_mysql("SELECT id, user, tipoPropiedad, venta_alquiler, externa, descripcion, publicado,
                                                       borrador, fecha, precio_cierre, titulo, lat, lon, precio, dormitorios, moneda_contrato,
                                                       banios, garajes, m2, m2_cons, pais, departamento, ciudad, distrito, img,
                                                       oficinas
                                                       FROM myplace_inmuebles 
                                                       WHERE company = 'skyone' AND borrador = 'no' AND 
                                                       externa = 'no' AND activo = 'si';")
        })
        
        edit_inmo_on(0)
        prop_todas_on(1)
        page_on(1)
        showElement("prop_todas_ui")
      }
      if(input$menu == "prop_bus"){
        updateQueryString("?misbusquedas", mode = "push")
        isolate({
          vars$n_per_page <- busqueda_per_page
          vars$max_pages <- busqueda_max_pages
          
          busquedas <- list_table_var1_var2_var3_mysql("myplace_busquedas", "user", vars$user$user, "company", co, "activo", "IN", "si")
          print("numero de busquedas")
          print(nrow(busquedas))
          if(nrow(busquedas) != 0){
            for(i in 1:nrow(busquedas)){
              coinci <- list_table_var1_var2_var3_mysql("myplace_coincidencias", "user_busq", vars$user$user, "busqueda", busquedas$id[i], "activo", "IN", "si")
              inmos_sky <- list_table_var_mysql("myplace_inmuebles", "id", coinci$inmueble)
              del_inmo <- coinci[str_detect(coinci$inmueble, "skyone") & !coinci$inmueble %in% inmos_sky$id,]
              if(nrow(del_inmo) != 0){
                coinci <- coinci[!coinci$inmueble %in% del_inmo$inmueble,]
                update_var_table_mysql("no", "activo", "inmueble", del_inmo$inmueble, "myplace_coincidencias")
                update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "inmueble", del_inmo$inmueble, "myplace_coincidencias")
                del_var_table_mysql("id_inmo", del_inmo$inmueble, paste0(co, "_estados"))
                del_var_table_mysql("id_inmo", del_inmo$inmueble, paste0(co, "_llamadas"))
                del_var_table_mysql("id_inmo", del_inmo$inmueble, paste0(co, "_alarmas"))
                del_var_table_mysql("id_inmo", del_inmo$inmueble, paste0(co, "_seguidas"))
                del_var_table_mysql("id_inmo", del_inmo$inmueble, paste0(co, "_transacciones"))
                del_var_table_mysql("id_inmo", del_inmo$inmueble, "place_seguidas")
              }
              
              busquedas$fecha_last_coinci[i] <- max(coinci$fecha)
              busquedas$time_diff <- difftime(now("America/Asuncion"), as_datetime(busquedas$fecha_last_coinci, tz = "America/Asuncion"), units = "days")
              busquedas$color <- case_when(busquedas$time_diff <= 1 ~ "green",
                                           busquedas$time_diff > 1 & busquedas$time_diff <= 2 ~ "orange",
                                           busquedas$time_diff > 2 | is.na(busquedas$time_diff) ~ "red")
            }
            busquedas <- busquedas %>% arrange(desc(fecha_last_coinci))
            vars$data_all_pages <- busquedas
            vars$page_selected <- 1
            vars$data_per_page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, 1)$data
            vars$data_per_page_back <- vars$data_all_pages
          }else{
            vars$data_all_pages <- data.frame()
            vars$page_selected <- 1
            vars$data_per_page <- data.frame()
            vars$data_per_page_back <- data.frame()
          }
        })
        edit_inmo_on(0)
        busqueda_on(1)
        page_on(1)
        showElement("box_busqueda_ui")
      }
      if(input$menu == "bus_todas"){
        updateQueryString("?todaslasbusquedas", mode = "push")
        isolate({
          all_busquedas <- list_table_var1_var2_mysql("myplace_busquedas", "company", co, "activo", "si")
          vars$all_busquedas <- all_busquedas
          all_busquedas$geometry <- NULL
          all_busquedas <- all_busquedas %>% mutate(lat = (lat_min + lat_max)/2, lon = (lon_min + lon_max)/2)
          vars$bus_todas_all <- all_busquedas %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
        })
        edit_inmo_on(0)
        bus_todas_on(1)
      }
      if(input$menu == "myplace"){
        updateQueryString("?myplace", mode = "push")
        vars$list_myplace_all <- query_mysql("SELECT id, company, user, tipoPropiedad, venta_alquiler, fecha, precio_cierre, externa, lat, lon 
                                             FROM myplace_inmuebles WHERE borrador = 'no' AND activo = 'si' ORDER BY fecha DESC;")
        print("Inmuebles de place 2")
        print(nrow(vars$list_myplace_all %>% filter(company == "place2")))
        print(vars$list_myplace_all %>% filter(company == "place2"))
        vars$n_per_page <- myplace_per_page
        vars$max_pages <- myplace_max_pages
        edit_inmo_on(0)
        myplace_on(1)
      }
      if(input$menu == "place_analyzer"){
        updateQueryString("?place", mode = "push")
        edit_inmo_on(0)
        place_on(1)
      }
      if(input$menu == "place_view"){
        updateQueryString("?placeview", mode = "push")
        fotos_mes <- list_last_fotos_mysql(vars$user$user, as.character(now("America/Asuncion") - months(1)))
        vars$fotos_vistas <- list_table_var_mysql("fotos_street360", "id", fotos_mes$foto_id)
        vars$fotos_no_vistas <- data.frame()
        edit_inmo_on(0)
        place_view_on(1)
      }
      if(input$menu == "mi_nube"){
        updateQueryString("?minube", mode = "push")
        isolate({
          agencia_nam <- agencia_name(vars$user$agencia, vars$agencias, vars$franquicias)
          print(agencia_nam)
          root <- paste0(co, "/minube/", str_replace_all(agencia_nam, " ", "_"), "/")
          list_all <- list_spaces_do(root)
          if(nrow(list_all) > 0)
            list_all$Order <- list_all$Order - 2
          vars$minube_list_all <- list_all
        })
        edit_inmo_on(0)
        mi_nube_on(1)
        minube_compartidos_on(1)
      }
      if(input$menu == "capacitacion"){
        updateQueryString("?capacitaciones", mode = "push")
        vars$capa_list_all <- load_mysql(paste0(co, "_capacitaciones"))
        vars$capa_folders <- c("Todos", unique(vars$capa_list_all$tipo[!is.na(vars$capa_list_all$tipo)]))
        vars$capa_selected <- "Todos"
        edit_inmo_on(0)
        capacitacion_on(1)
      }
    }
  })
  
  
  ###################################################################################################################################  
  ###################################################################################################################################  
  #automatizados
  
  
  searching_new_comentario <- function(noticia){
    stop <- 0
    while(stop == 0 ){
      Sys.sleep(5)
      data <- list_table_var_mysql(paste0(co, "_noticias"), "id", noticia$id)
      if(data$n_comen != noticia$n_comen){
        stop <- 1
      }
    }
  }
  
  long_run_comen <- eventReactive(comentarios_on(), {
    if(comentarios_on() == 1){
      noticia <- vars$show_noticia
      x <- callr::r_bg(
        func = searching_new_comentario,
        args = list(noticia),
        supervise = TRUE
      )
      return(x)
    }
  })
  
  check_comen <- reactive({
    if(comentarios_on() == 1){
      invalidateLater(millis = 2000, session = session)
      if (long_run_comen()$is_alive()) {
        x <- FALSE
      } else {
        x <- TRUE
      }
      return(x)
    }
  })
  
  observeEvent(check_comen(), {
    if(comentarios_on() == 1){
      print("comentario waiting...")
      if(check_comen() == TRUE){
        noticia <- vars$show_noticia
        noticia_new <- list_table_var_mysql(paste0(co, "_noticias"), "id", noticia$id)
        if(noticia$n_comen != noticia_new$n_comen){
          
          n_comen <- list_table_var1_var2_mysql(paste0(co, "_comentarios"), "noticia", noticia$id, "activo", "si") %>% nrow() %>% as.character()
          ind <- which(vars$all_scroll_1$id == noticia$id)
          vars$all_scroll_1$n_comen[vars$all_scroll_1$id == noticia$id] <- n_comen
          vars$from_1 <- ind
          vars$to_1 <- ind
          vars$list_scroll_1$n_comen[vars$list_scroll_1$id == noticia$id] <- n_comen
          back <- vars$list_comentarios
          all <- list_table_var_mysql(paste0(co, "_comentarios"), "noticia", noticia$id)
          new <- all[!all$id %in% back$id, ]
          vars$from_comen <- nrow(back) + 1
          vars$to_comen <- nrow(all)
          vars$list_comentarios <- all
          vars$show_noticia$n_comen <- noticia_new$n_comen
        }
      }
    }
  })
  
  ###################################################################################################################################  
  ###################################################################################################################################  
  #Galeria de fotos
  
  output$galeria_fotos_ui <- renderUI({
    div(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; width: 342px; height: 335px;
                           border-radius: 10px 10px 10px 10px; background-color: white",
        uiOutput("main_foto_gal_ui"),
        div(style = paste0("background-color: #aaaaaa; color: white;
                           height: 22px; border-radius: 0px 5px 0px 0px; 
                    padding: 5px; padding-top: 0px; position: absolute; margin-top: -22px; margin-left: 0px;
          z-index: 5;"), align = "center", 
            HTML(paste0("<p><span style='font-size: 110%; font-weight: bold'>", vars$gal_now, " - ", length(vars$gal), "</span></p>"))
        ),
        div(style = "padding: 5px", align = "left",
            if(vars$index + 1 > 1)
              actionButton("gal_prev", NULL, icon = icon("chevron-left"), style = paste0('font-size: 130%; z-index: 3;
                                                                      background-color: transparent; color: #888888;
                                                                      position: absolute; margin-left: -10px;
                                                                      boder-weight: 0px; border-color: transparent;
                                                                      margin-top: 13px')),
            if(vars$index + 4 < length(vars$gal))
              actionButton("gal_next", NULL, icon = icon("chevron-right"), style = paste0('font-size: 130%; z-index: 3;
                                                                      background-color: transparent; color: #888888;
                                                                      position: absolute; margin-left: 304px;
                                                                      boder-weight: 0px; border-color: transparent;
                                                                      margin-top: 13px')),
            uiOutput("gal1_ui"),
            uiOutput("gal2_ui"),
            uiOutput("gal3_ui"),
            uiOutput("gal4_ui")
        )
    )
  })
  
  output$main_foto_gal_ui <- renderUI({
    a(href = str_remove(vars$main_foto_gal, "-small"), target = "_blank",
      actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:340px; height: 255px; margin: 0px;
                                                             background-image: url("', vars$main_foto_gal, '");
                                                             background-size: cover, 340px 255px;
                                                             border-radius: 8px 8px 0px 0px')))
  })
  
  output$gal1_ui <- renderUI({
    if(vars$index + 1 <= length(vars$gal)){
      div(
        div(style = paste0(ifelse(vars$gal_now == (1 + vars$index), "background-color: #666666; color: white;",
                                  "background-color: #dddddd; color: black;"),
                           "width: 22px; height: 22px; border-radius: 11px;
                    padding: 0px; position: absolute; margin-top: 45px; margin-left: 48px;
          z-index: 5;"), align = "center", 
            HTML(paste0("<p><span style='font-size: 80%; font-weight: normal'>", 1 + vars$index, "</span></p>"))
        ),
        actionButton("gal1", NULL, style = paste0('border-radius: 5px; 
                                                  background-image: url("', vars$gal[1 + vars$index], '");
                                                                      background-size: cover, 72px 54px;
                                                                      width: 72px; height: 54px; z-index: 3;',
                                                  'position: absolute; margin-left: 23px; margin-top: 5px'))
      )
    }
  })
  
  output$gal2_ui <- renderUI({
    if(vars$index + 2 <= length(vars$gal)){
      div(
        div(style = paste0(ifelse(vars$gal_now == (2 + vars$index), "background-color: #666666; color: white;",
                                  "background-color: #dddddd; color: black;"),
                           "width: 22px; height: 22px; border-radius: 11px;
                    padding: 0px; position: absolute; margin-top: 45px; margin-left: 120px;
          z-index: 5;"), align = "center", 
            HTML(paste0("<p><span style='font-size: 80%; font-weight: normal'>", 2 + vars$index, "</span></p>"))
        ), #dataURI(file = vars$gal[2 + vars$index])
        actionButton("gal2", NULL, style = paste0('border-radius: 5px; 
                                                  background-image: url("', vars$gal[2 + vars$index], '");
                                                                      background-size: cover, 72px 54px;
                                                                      width: 72px; height: 54px; z-index: 3;
                                                                      position: absolute; margin-left: 95px; margin-top: 5px'))
      )
    }
  })
  
  output$gal3_ui <- renderUI({
    if(vars$index + 3 <= length(vars$gal)){
      div(
        div(style = paste0(ifelse(vars$gal_now == (3 + vars$index), "background-color: #666666; color: white;",
                                  "background-color: #dddddd; color: black;"),
                           "width: 22px; height: 22px; border-radius: 11px;
                    padding: 0px; position: absolute; margin-top: 45px; margin-left: 192px;
          z-index: 5;"), align = "center", 
            HTML(paste0("<p><span style='font-size: 80%; font-weight: normal'>", 3 + vars$index, "</span></p>"))
        ),
        actionButton("gal3", NULL, style = paste0('border-radius: 5px; 
                                                  background-image: url("', vars$gal[3 + vars$index], '");
                                                                      background-size: cover, 72px 54px;
                                                                      width: 72px; height: 54px; z-index: 3;
                                                                      position: absolute; margin-left: 167px; margin-top: 5px'))
      )
    }
  })
  
  output$gal4_ui <- renderUI({
    if(vars$index + 4 <= length(vars$gal)){
      div(
        div(style = paste0(ifelse(vars$gal_now == (4 + vars$index), "background-color: #666666; color: white;",
                                  "background-color: #dddddd; color: black;"),
                           "width: 22px; height: 22px; border-radius: 11px;
                    padding: 0px; position: absolute; margin-top: 45px; margin-left: 264px;
          z-index: 5;"), align = "center", 
            HTML(paste0("<p><span style='font-size: 80%; font-weight: normal'>", 4 + vars$index, "</span></p>"))
        ),
        actionButton("gal4", NULL, style = paste0('border-radius: 5px; 
                                                  background-image: url("', vars$gal[4 + vars$index], '");
                                                                      background-size: cover, 72px 54px;
                                                                      width: 72px; height: 54px; z-index: 3;
                                                                      position: absolute; margin-left: 239px; margin-top: 5px'))
      )
    }
  })
  
  observeEvent(input$gal1, {
    vars$gal_now <- 1 + vars$index
    vars$main_foto_gal <- vars$gal[1 + vars$index]
  })
  
  observeEvent(input$gal2, {
    vars$gal_now <- 2 + vars$index
    vars$main_foto_gal <- vars$gal[2 + vars$index]
  })
  
  observeEvent(input$gal3, {
    vars$gal_now <- 3 + vars$index
    vars$main_foto_gal <- vars$gal[3 + vars$index]
  })
  
  observeEvent(input$gal4, {
    vars$gal_now <- 4 + vars$index
    vars$main_foto_gal <- vars$gal[4 + vars$index]
  })
  
  observeEvent(input$gal_prev, {
    if(vars$index - 4 >= 0){
      vars$index <- vars$index - 4
    }else{
      if(vars$index - 3 >= 0){
        vars$index <- vars$index - 3
      }else{
        if(vars$index - 2 >= 0){
          vars$index <- vars$index - 2
        }else{
          if(vars$index - 1 >= 0){
            vars$index <- vars$index - 1
          }
        }
      }
    }
    print(vars$index)
  })
  
  observeEvent(input$gal_next, {
    tot <- length(vars$gal)
    if(vars$index + 4 < tot){
      vars$index <- vars$index + 4
    }else{
      if(vars$index + 3 < tot){
        vars$index <- vars$index + 3
      }else{
        if(vars$index + 2 < tot){
          vars$index <- vars$index + 2
        }else{
          if(vars$index + 1 < tot){
            vars$index <- vars$index + 1
          }
        }
      }
    }
    print(vars$index)
  })
  
  
  ###################################################################################################################################  
  ###################################################################################################################################  
  #Pages
  
  obs_page <- list()
  
  observe({
    if(page_on() == 1){
      req(vars$data_all_pages)
      if(nrow(vars$data_all_pages) != 0){
        page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, vars$page_selected)
        output$page_ui <- renderUI({
          pages <- as.list(page$min:page$max)
          pages <- lapply(pages, function(i){
            btSelPage <- paste0("inmo_page_sel", i)
            obs_page[[btSelPage]] <<- observeEvent(input[[btSelPage]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btSelPage)
              isolate({
                vars$page_selected <- i
                if(i == page$n_pages){
                  vars$data_per_page <- vars$data_all_pages[(vars$n_per_page*i-vars$n_per_page + 1):(vars$n_per_page*(i - 1) + page$last_page),]
                }else{
                  vars$data_per_page <- vars$data_all_pages[(vars$n_per_page*i-vars$n_per_page + 1):(vars$n_per_page*i),]
                }
              })
            })
            div(style = "padding: 5px; display:inline-block",
                if(i == page$min & page$min != page$max){
                  tags$div(class = "btn-group",
                           actionButton("go_first_page", "", icon = icon("angle-double-left"),
                                        style = paste0("background-color: white; color: ", main_color, "; border: 1px;  border-radius: 5px;
                                                border-color: ", main_color, "; margin-right: 10px")),
                           actionButton(btSelPage, as.character(i), 
                                        style = ifelse(i == vars$page_selected, 
                                                       paste0("background-color: ", main_color, "; color: white; border: 1px; border-radius: 5px;
                                                border-color: ", main_color),
                                                       paste0("background-color: white; color: ", main_color, "; border: 1px;  border-radius: 5px;
                                                border-color: ", main_color)))
                  )
                },
                if(i == page$max & page$min != page$max){
                  tags$div(class = "btn-group",
                           actionButton(btSelPage, as.character(i), 
                                        style = ifelse(i == vars$page_selected, 
                                                       paste0("background-color: ", main_color, "; color: white; border: 1px; border-radius: 5px;
                                                border-color: ", main_color),
                                                       paste0("background-color: white; color: ", main_color, "; border: 1px;  border-radius: 5px;
                                                border-color: ", main_color))),
                           actionButton("go_last_page", "", icon = icon("angle-double-right"),
                                        style = paste0("background-color: white; color: ", main_color, "; border: 1px;  border-radius: 5px;
                                                border-color: ", main_color, "; margin-left: 10px"))
                  )
                },
                if((i != page$min & i != page$max) | page$min == page$max){
                  actionButton(btSelPage, as.character(i), 
                               style = ifelse(i == vars$page_selected, 
                                              paste0("background-color: ", main_color, "; color: white; border: 1px; border-radius: 5px;
                                                border-color: ", main_color),
                                              paste0("background-color: white; color: ", main_color, "; border: 1px;  border-radius: 5px;
                                                border-color: ", main_color)))
                }
            )
          })
        })
      }else{
        output$page_ui <- renderUI({
          div()
        })
      }
    }
  })
  
  output$cont_page_ui <- renderUI({
    req(vars$data_all_pages)
    if(nrow(vars$data_all_pages) != 0){
      vars$data_per_page <- vars$data_per_page[!is.na(vars$data_per_page$id),]
      paste0("  Mostrando ", (vars$page_selected - 1)*vars$n_per_page + 1, "-", 
             (vars$page_selected - 1)*vars$n_per_page + nrow(vars$data_per_page), " de ",
             nrow(vars$data_all_pages))
    }
  })
  
  observeEvent(input$go_first_page, {
    isolate({
      if(nrow(vars$data_all_pages) != 0){
        vars$data_per_page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, 1)$data
      }else{
        vars$data_per_page <- data.frame()
      }
      vars$page_selected <- 1
    })
  })
  
  observeEvent(input$go_last_page, {
    isolate({
      if(nrow(vars$data_all_pages) != 0){
        page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, 1)
        vars$page_selected <- page$n_pages
        vars$data_per_page <- vars$data_all_pages[(vars$n_per_page*page$n_pages-vars$n_per_page + 1):(vars$n_per_page*(page$n_pages - 1) + page$last_page),]
      }else{
        vars$data_per_page <- data.frame()
        vars$page_selected <- 1
      }
    })
  })
  
  
  ###################################################################################################################################  
  ###################################################################################################################################  
  #scroll
  
  open_scroll_1 <- reactiveValues(boxes = list(), obs_open_scroll = list(), 
                                  obs_new_comentario = list(),
                                  obs_new_comen = list())
  
  observeEvent(vars$list_scroll_1,{
    if(home_on() == 1){
      print(vars$list_scroll_1$id)
      if(nrow(vars$list_scroll_1) > 0){
        for(i in vars$from_1:vars$to_1){
          btOpenNoticia <- paste0("open_noticia_button", i)
          btNewComen <- paste0("new_comen_button", i)
          txtComenHome <- paste0("text_comen_home", i)
          isolate({
            noticia <- vars$all_scroll_1[i,]
            print(i)
            print(noticia$id)
            agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", noticia$user)
            diff <- round(difftime(as_datetime(now("America/Asuncion")), as_datetime(noticia$fecha, tz = "America/Asuncion"), units = "mins")) %>% as.integer()
            if(diff < 60){
              diff <- paste0(diff, " minutos")
            }else{
              if(diff < 1440){
                diff <- paste0(round(diff/60), " horas")
              }else{
                diff <- paste0(round(diff/1140), " días")
              }
            }
            n_comen <- as.integer(noticia$n_comen)
            n_img <- as.integer(noticia$n_img)
            if(noticia$activo == "si"){
              open_scroll_1$boxes[[i]] <- div(style = "padding: 0px; display:inline-block", align = "left",
                                              div(
                                                div(style = paste0("border-style: solid; border-width: 0px; border-color: ", main_color, "; 
                                                              border-radius: 0px; background-color: white; width: 100%;
                                                              margin: 0px; padding: 0px"),
                                                    div(style = "padding: 10px; padding-top: 0px; padding-bottom: 5px",
                                                        div(class = "btn-group", actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 40px; height: 40px; margin: 0px; margin-left: 0px;
                                                             background-image: url("', agente$img, '");
                                                             background-size: cover, 40px 40px;
                                                             border-radius: 20px'))
                                                        ),
                                                        div(class = "btn-group", style = "margin-left: 10px",
                                                            div(
                                                              h4(HTML(paste0("<p><span style='color: #888888; font-weight: bold'>", agente$name, "</span></p>"))),
                                                              h5(HTML(paste0("<p><span style='color: #888888; font-weight: lighter'>", diff, "</span></p>")), style = "margin-top: -5px")
                                                            )
                                                        ),
                                                        
                                                        h5(noticia$text, style = "width: 100%; word-break: break-word;"),
                                                    ),
                                                    hr(style = "margin: 0px; border-top: 1px solid #aaaaaa;"),
                                                    tags$button(id = btOpenNoticia,
                                                                class = "btn action-button", 
                                                                style='background-color:transparent; padding: 0px',
                                                                img(src = str_remove(noticia$img, "-small"),
                                                                    width = '100%',
                                                                    style = "border-radius: 0px;border-width: 0px;"
                                                                )
                                                    ),
                                                    hr(style = "margin: 0px; border-top: 1px solid #aaaaaa;"),
                                                    
                                                    div(style = "width: 400px; height: 45px; margin-top: -10px", align = "center",
                                                      div(class = "btn-group", actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 30px; height: 30px; margin: 5px; margin-left: 20px;
                                                             background-image: url("', vars$user$img, '");
                                                             background-size: cover, 30px 30px;
                                                             border-radius: 15px'))
                                                      ),
                                                      div(class = "btn-group", style = "margin-top: 10px",
                                                          div(id = "text_transp", textAreaInput(txtComenHome, NULL, placeholder = "Deja tu comentario...", height = 30, width = 270))
                                                      ),
                                                      div(class = "btn-group", style = "margin-left: 30px; margin-top: -0px",
                                                          actionButton("nada", NULL, 
                                                          icon = icon("paper-plane"), 
                                                          style = paste0("background-color: transparent; font-size: 100%;
                                                                                border-color: transparent; padding: 0px; color: ", main_color),
                                                          onclick = paste0('Shiny.setInputValue(\"', btNewComen, '\", this.id, {priority: \"event\"})'))
                                                      )
                                                    ),
                                                    
                                                    hr(style = "margin: 0px; border-top: 1px solid #aaaaaa;"),
                                                    
                                                    if(n_img > 1){
                                                      div(style = paste0("margin-top: -50px; margin-left: 88%;"),
                                                          
                                                          actionButton("nada", paste0("+", n_img - 1),
                                                                       style = paste0("margin-top: -40px; margin-left: ", ifelse(n_img > 10, "-6px", "-2px"), "; font-size: 140%;
                                                                       font-weight: bold; color: white;  background-color: ", main_color,
                                                                                      "; border-color: white; border-width: 2px; width: 40px; height: 40px; border-radius: 20px; 
                                                                       border-style: solid; padding: 4px;"))
                                                      )
                                                    },
                                                    div(align = "right", style = paste0("margin-top: ", ifelse(n_img > 1, "8px", "0px"), "; padding: 3px; padding-right: 10px"),
                                                        actionButton("nada", ifelse(n_comen == 0, "    ", paste0(n_comen, ifelse(n_comen == 1, " comentario", " comentarios"))),
                                                                     icon = icon(ifelse(n_comen > 0, "comment-o", "")),
                                                                     style = "color: #666666; font-weight: normal; border-color: transparent; 
                                                                                        background-color: transparent; padding: 0px; margin: 0px",
                                                                     onclick = paste0('Shiny.setInputValue(\"', btOpenNoticia, '\", this.id, {priority: \"event\"})'))
                                                    )
                                                )
                                              ),
                                              hr(style = "margin: 0px; border-top: 6px solid #d1d3cf;"),
              )
            }
          })
        }
        lapply(vars$from_1:vars$to_1, function(i){
          btOpenNoticia <- paste0("open_noticia_button", i) 
          open_scroll_1$obs_open_scroll[[i]] <<- observeEvent(input[[btOpenNoticia]], ignoreNULL = TRUE, ignoreInit = TRUE, {
            freezeReactiveValue(input, btOpenNoticia)
            open_comentarios$boxes <- list()
            open_comentarios$obs_del_comentario <- list()
            noticia <- vars$all_scroll_1[i,]
            vars$show_noticia <- noticia
            comentarios_on(1)
          })
          
          btNewComen <- paste0("new_comen_button", i)
          txtComenHome <- paste0("text_comen_home", i)
          open_scroll_1$obs_new_comen[[i]] <<- observeEvent(input[[btNewComen]], ignoreNULL = TRUE, ignoreInit = TRUE, {
            freezeReactiveValue(input, btNewComen)
            print("new coment ")
            print(i)
            print(input[[paste0("text_comen_home", i)]])
            if(input[[paste0("text_comen_home", i)]] != ""){
              noticia <- vars$all_scroll_1[i,]
              isolate({
                new_comentario <- data.frame(
                  id = new_id_table_mysql("id", paste0(co, "_comentarios"), "comentario_", 12),
                  user = vars$user$user,
                  noticia = noticia$id,
                  fecha = as.character(now("America/Asuncion")),
                  text = input[[paste0("text_comen_home", i)]],
                  activo = "si"
                )
                save_mysql(new_comentario, paste0(co, "_comentarios"), FALSE)
                n_comen <- list_table_var1_var2_mysql(paste0(co, "_comentarios"), "noticia", noticia$id, "activo", "si") %>% nrow() %>% as.character()
                update_var_table_mysql(n_comen, "n_comen", "id", noticia$id, paste0(co, "_noticias"))

                #updateTextAreaInput(session, "text_comentario", value = "")
                #back <- vars$list_comentarios
                #all <- list_table_var_mysql(paste0(co, "_comentarios"), "noticia", noticia$id)
                #new <- all[!all$id %in% back$id, ]
              })
              #vars$from_comen <- nrow(back) + 1
              #vars$to_comen <- nrow(all)
              #vars$list_comentarios <- all
            }
            
            open_comentarios$boxes <- list()
            open_comentarios$obs_del_comentario <- list()
            vars$show_noticia <- noticia
            comentarios_on(1)
            
          })
          
        })
      }
    }
    
    if(show_clien_on() == 1 | office_agen_on() == 1){
      if(nrow(vars$list_scroll_1) > 0){
        
        vincs <- vars$list_scroll_1 %>% filter(!tipo_clien %in% c("buscando", "busquedas"))
        if(nrow(vincs) > 0){
          inmos_sky <- list_table_var1_var2_mysql("myplace_inmuebles", "id", vincs$id_inmo, "company", co)
          del_inmo <- vincs[str_detect(vincs$id_inmo, "skyone") & !vincs$id_inmo %in% inmos_sky$id,]
          if(nrow(del_inmo) != 0){
            vars$list_scroll_1 <- vars$list_scroll_1 %>% filter(!id_inmo %in% del_inmo$id_inmo)
            update_var_table_mysql("no", "activo", "inmueble", del_inmo$id_inmo, "myplace_coincidencias")
            update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "inmueble", del_inmo$id_inmo, "myplace_coincidencias")
            del_var_table_mysql("id_inmo", del_inmo$id_inmo, paste0(co, "_estados"))
            del_var_table_mysql("id_inmo", del_inmo$id_inmo, paste0(co, "_llamadas"))
            del_var_table_mysql("id_inmo", del_inmo$id_inmo, paste0(co, "_alarmas"))
            del_var_table_mysql("id_inmo", del_inmo$id_inmo, paste0(co, "_seguidas"))
            del_var_table_mysql("id_inmo", del_inmo$id_inmo, paste0(co, "_transacciones"))
            del_var_table_mysql("id_inmo", del_inmo$id_inmo, "place_seguidas")
          }
        }
        
        for(i in vars$from_1:vars$to_1){
          vinc <- vars$all_scroll_1[i,]
          print("vinc general")
          print(vinc)
          if(vinc$tipo_clien %in% c("buscando", "busquedas")){
            tipo <- "busqueda"
            print(tipo)
            btOpenBusquedaVinc <- paste0("open_busqueda_vinc_button", i) 
            
            list_busquedas <- list_table_var1_var2_mysql("myplace_busquedas", "id", vinc$id_inmo, "activo", "si")
            if(nrow(list_busquedas) != 0){
              busqueda <- left_join(list_busquedas, vinc, by = c("id" = "id_inmo"))
              coinci <- list_table_var1_var2_var3_mysql("myplace_coincidencias", "user_busq", unique(list_busquedas$user), "busqueda", busqueda$id, "activo", "IN", "si")
              busqueda$fecha_last_coinci <- max(coinci$fecha)
              busqueda$time_diff <- difftime(now("America/Asuncion"), as_datetime(busqueda$fecha_last_coinci, tz = "America/Asuncion"), units = "days")
              busqueda$color <- case_when(busqueda$time_diff <= 1 ~ "green",
                                          busqueda$time_diff > 1 & busqueda$time_diff <= 2 ~ "orange",
                                          busqueda$time_diff > 2 | is.na(busqueda$time_diff) ~ "red")
              cliente <- list_table_var_mysql(paste0(co, "_clientes"), "id", busqueda$cliente)
              
              path <- paste0("www/temp/", vars$user$user, "temp_map", i, ".html")
              saveWidget(
                widget = leaflet() %>% addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}")%>%
                  addPolygons(data = busqueda, color = ~ifelse(estado == "revisado", "blue", color),
                              popup = ~popup_busqueda(busqueda, TRUE)), 
                file = path,
                selfcontained = FALSE,
                libdir = "files/"
              )
              
              open_scroll_1$boxes[[i]] <- div(style = "padding: 10px; display:inline-block", align = "left",
                                              div(
                                                div(style = paste0("border-style: solid; border-width: 1px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; width: 242px; height: 315px;
                                 margin: 0px; padding: 0px"),
                                                    div(tags$iframe(seamless="seamless", 
                                                                    src = paste0("temp/", vars$user$user, "temp_map", i, ".html"), 
                                                                    style = "border-radius: 8px 8px 0px 0px; width: 240px; height: 200px;
                                border: 0px; padding: 3px;")
                                                    ),
                                                    div(style = "padding: 10px; padding-top: 0px",
                                                        h4(busqueda$name, style='font-size: 120%; font-weight: normal; color: #888888; height: 30px; width: 220px')
                                                    ),
                                                    div(style = "padding: 10px; padding-top: 0px",
                                                        actionButton("nada", paste0(nrow(coinci), ifelse(nrow(coinci) == 1, "  coincidencia","  coincidencias")),
                                                                     style = paste0("background: transparent; border-color: transparent; padding: 0px;",
                                                                                    "font-size: 180%; font-weight: lighter; color: ", main_color)),
                                                    ),
                                                )
                                              ),
                                              div(style = "position: absolute; margin-top: -315px; margin-left: 0px",
                                                  actionButton(btOpenBusquedaVinc, NULL, style = "width: 242px; height: 315px; background: transparent;
                                 border-color: transparent")
                                              )
              )
            }
          }else{
            tipo <- "inmo"
            print(tipo)
            ext <- !str_detect(vinc$id_inmo, "skyone")
            print("vinc")
            print(vinc)
            list_inmuebles <- list_table_var_mysql("myplace_inmuebles", "id", vinc$id_inmo)
            print("list_inmuebles")
            print(list_inmuebles)
            
            inmo <- left_join(list_inmuebles, vinc, by = c("id" = "id_inmo"))
            print(inmo)
            if(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta"){
              inmo$precio_cierre <- round(inmo$precio_cierre/1000000)
              inmo$precio <- round(inmo$precio/1000000)
            }
            btOpenInmoVinc <- paste0("open_inmo_vinc_button", i)
            if(inmo$tipoPropiedad == "Proyecto"){
              tipologias <- list_table_var_mysql("myplace_tipologias", "id", inmo$id)
              if(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta"){
                tipologias$precio <- round(tipologias$precio/1000000)
              }
              precio_min <- format(min(tipologias$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              precio_max <- format(max(tipologias$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              dormitorios_min <- min(ifelse(is.na(as.integer(tipologias$dormitorios)), 1, as.integer(tipologias$dormitorios)))
              dormitorios_max <- max(ifelse(is.na(as.integer(tipologias$dormitorios)), 1, as.integer(tipologias$dormitorios)))
              banios_min <- min(as.integer(tipologias$banios))
              banios_max <- max(as.integer(tipologias$banios))
              m2_cons_min <- format(round(min(tipologias$m2_cons)), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              m2_cons_max <- format(round(max(tipologias$m2_cons)), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              garajes_min <- min(as.integer(tipologias$garajes))
              garajes_max <- max(as.integer(tipologias$garajes))
            }
            print(inmo)
            open_scroll_1$boxes[[i]] <- div(style = "padding: 10px; display:inline-block", align = "left",
                                            div(
                                              div(
                                                if(inmo$externa == "si"){
                                                  div(style = paste0("background-color: ", main_color, "; width: 200px; height: 40px; border-radius: 10px; color: white;
                    padding: 0px; padding-top: 5px; position: absolute; margin-top: 70px; margin-left: 20px"), align = "center", 
                                                      HTML(paste0("<p><span style='font-size: 150%; font-weight: normal'>EXTERNA</span></p>"))
                                                  )
                                                },
                                                if(inmo$borrador == "si"){
                                                  div(style = "background-color: red; width: 30px; height: 30px; border-radius: 15px; color: white;
                    padding: 0px; padding-top: 5px; position: absolute; margin-top: 30px; margin-left: 217px", align = "center", 
                                                      HTML(paste0("<p><span style='font-size: 120%; font-weight: normal'><i class='fa fa-eraser'></i></span></p>"))
                                                  )
                                                },
                                                if(inmo$publicado == "si"){
                                                  div(style = "background-color: black; width: 30px; height: 30px; border-radius: 15px; color: white;
                    padding: 0px; padding-top: 5px; position: absolute; margin-top: -5px; margin-left: 217px", align = "center", 
                                                      HTML(paste0("<p><span style='font-size: 120%; font-weight: normal'><i class='fa fa-television'></i></span></p>"))
                                                  )
                                                },
                                                if(inmo$precio_cierre != 0){
                                                  div(style = paste0("background-color: ", main_color, "; width: 200px; height: 40px; border-radius: 10px; color: white;
                    padding: 0px; padding-top: 5px; position: absolute; margin-top: 30px; margin-left: 20px"), align = "center", 
                                                      HTML(paste0("<p><span style='font-size: 150%; font-weight: normal'>",
                                                                  ifelse(inmo$venta_alquiler == "Venta", "VENDIDO", "ALQUILADO"), "</span></p>"))
                                                  )
                                                }
                                              ),
                                              div(align = "right", style = "position: absolute; margin-top: 295px; margin-left: 190px;",
                                                  HTML(paste0("<p><span style='font-size: 90%; font-weight: normal; padding-right: 10px; margin: 0px'>ID: ",
                                                              as.integer(str_flatten(str_extract_all(inmo$id, "\\d")[[1]])), "</span></p>"))),
                                              div(style = paste0("border-style: solid; border-width: 1px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: ", ifelse(ext, main_color, "white"), "; width: 242px; height: 315px;
                                 margin: 0px; padding: 0px"),
                                                  if(str_detect(inmo$id, co)){
                                                    div(style = "position: absolute; margin-top: 5px; margin-left: 5px",
                                                        actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:60px; height: 20px; margin: 0px;
                                                             background-image: url("logo_SkyOne_borde_blanco.png");
                                                             background-size: cover, 60px 20px;'))
                                                    )
                                                  },
                                                  div(align = "left", style = "position: absolute; margin-top: 295px; margin-left: 10px;",
                                                      HTML(paste0("<p><span style='font-size: 90%; font-weight: light; margin: 0px'>",
                                                                  inmo$tipo_clien, "</span></p>"))),
                                                  div(actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:240px; height: 180px; margin: 0px;
                                                             background-image: url("', inmo$img, '");
                                                             background-size: cover, 240px 180px;
                                                             border-radius: 8px 8px 0px 0px')),
                                                  ),
                                                  div(style = "width: 240px; height: 30px; margin: 6px", 
                                                      HTML(paste0("<p><span style='font-size: 140%; font-weight: normal; color: ", ifelse(ext, "white", "#444444"), "; height: 45px'>", 
                                                                  str_trunc(paste0(inmo$tipoPropiedad, " en ", ifelse(inmo$venta_alquiler == "Alquiler temporal", "Alq temp", inmo$venta_alquiler)), 28), "</span></p>"))),
                                                  div(style = "width: 240px; margin-left: 10px; margin-top: -10px", 
                                                      HTML(paste0("<p><span style='font-size: 90%; font-weight: normal; color: ", ifelse(ext, "white", "#444444"), "; height: 45px'>", 
                                                                  str_trunc(ifelse(inmo$distrito != "" & !is.na(inmo$distrito), paste0(inmo$distrito, ", ", inmo$ciudad), inmo$ciudad), 38), "</span></p>"))),
                                                  h4(paste0(inmo$moneda_contrato, " ", ifelse(inmo$tipoPropiedad == "Proyecto", 
                                                                                              ifelse(precio_min == precio_max, precio_min, paste0(precio_min, "-", precio_max)),
                                                                                              format(ifelse(inmo$precio_cierre != 0, inmo$precio_cierre, inmo$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)),
                                                            ifelse(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta", " millones", "")), 
                                                     style = paste0("margin: 0px; margin-left: 10px; margin-top: -5px; margin-bottom: 5px; font-weight: lighter; font-size: 180%; color: ", ifelse(ext, "white", lighten(main_color, 0.20)))),
                                                  if(inmo$tipoPropiedad %in% c("Casa", "Casa quinta", "Duplex", "Proyecto", "Departamento", "Edificio")){
                                                    HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(ext, "white", "#444444"), "'><i class='fa fa-bed'></i> ", 
                                                                ifelse(inmo$tipoPropiedad == "Proyecto", 
                                                                       ifelse(dormitorios_min == dormitorios_max, dormitorios_min, paste0(dormitorios_min, "-", dormitorios_max)),
                                                                       ifelse(inmo$dormitorios == "0", "Mono", inmo$dormitorios)), 
                                                                " <i class='fa fa-bath'></i> ", 
                                                                ifelse(inmo$tipoPropiedad == "Proyecto", 
                                                                       ifelse(banios_min == banios_max, banios_min, paste0(banios_min, "-", banios_max)),
                                                                       inmo$banios), 
                                                                " <i class='fa fa-ruler-combined'></i> ",
                                                                ifelse(inmo$tipoPropiedad == "Proyecto", 
                                                                       ifelse(m2_cons_min == m2_cons_max, m2_cons_min, paste0(m2_cons_min, "-", m2_cons_max)),
                                                                       inmo$m2_cons), "m2",
                                                                " <i class='fa fa-car-side'></i> ",
                                                                ifelse(inmo$tipoPropiedad == "Proyecto", 
                                                                       ifelse(garajes_min == garajes_max, garajes_min, paste0(garajes_min, "-", garajes_max)),
                                                                       inmo$garajes), 
                                                                "</span></p>"))
                                                  },
                                                  if(inmo$tipoPropiedad %in% c("Terreno")){
                                                    HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(ext, "white", "#444444"), "'>",
                                                                " <i class='fa fa-ruler-combined'></i> ", format(inmo$m2, big.mark = ".", decimal.mark = ",", scientific = FALSE), "m2</span></p>"))
                                                  },
                                                  if(inmo$tipoPropiedad %in% c("Propiedad rural")){
                                                    HTML(paste0("<p><span style='font-size: 95%; font-weight: normal; padding-left: 10px; color: ", ifelse(ext, "white", "#444444"), "'>",
                                                                " <i class='fa fa-ruler-combined'></i> ", format(inmo$m2/10000, big.mark = ".", decimal.mark = ",", scientific = FALSE), " hectareas</span></p>"))
                                                  },
                                                  if(inmo$tipoPropiedad %in% c("Deposito", "Tinglado", "Oficina")){
                                                    HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(ext, "white", "#444444"), "'>",
                                                                " <i class='fa fa-ruler-combined'></i> ", format(inmo$m2_cons, big.mark = ".", decimal.mark = ",", scientific = FALSE), "m2",
                                                                if(!is.na(inmo$banios)) paste0(" <i class='fa fa-bath'></i> ", inmo$banios),
                                                                if(!is.na(inmo$oficinas)) paste0(" <i class='fa fa-laptop-house'></i> ", inmo$oficinas),
                                                                if(!is.na(inmo$garajes)) paste0(" <i class='fa fa-car-side'></i> ", inmo$garajes),
                                                                "</span></p>"))
                                                  }
                                              )
                                            ),
                                            div(style = "position: absolute; margin-top: -315px; margin-left: 0px",
                                                actionButton(btOpenInmoVinc, NULL, style = "width: 242px; height: 315px; background: transparent;
                                 border-color: transparent")
                                            )
            )
          }
        }
        
        lapply(vars$from_1:vars$to_1, function(i){
          vinc <- vars$all_scroll_1[i,]
          print("vinc general")
          print(vinc)
          if(vinc$tipo_clien %in% c("buscando", "busquedas")){
            tipo <- "busqueda"
            print(tipo)
            btOpenBusquedaVinc <- paste0("open_busqueda_vinc_button", i) 
            open_scroll_1$obs_open_scroll[[i]] <<- observeEvent(input[[btOpenBusquedaVinc]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btOpenBusquedaVinc)
              vinc <- vars$all_scroll_1[i,]
              vars$show_busqueda <- list_table_var1_var2_mysql("myplace_busquedas", "id", vinc$id_inmo, "activo", "si")
              modal_busqueda_description()
            })
          }else{
            tipo <- "inmo"
            print(tipo)
            btOpenInmoVinc <- paste0("open_inmo_vinc_button", i)
            open_scroll_1$obs_open_scroll[[i]] <<- observeEvent(input[[btOpenInmoVinc]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btOpenInmoVinc)
              vinc <- vars$all_scroll_1[i,]
              
              list_inmuebles <- list_table_var_mysql("myplace_inmuebles", "id", vinc$id_inmo)
              
              inmo <- left_join(list_inmuebles, vinc, by = c("id" = "id_inmo"))
              vars$show_inmo <- inmo
              if(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta"){
                inmo$precio_cierre <- round(inmo$precio_cierre/1000000)
                inmo$precio <- round(inmo$precio/1000000)
              }
              clien <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", inmo$id) %>%
                select(id = id_clien, tipo_clien = tipo_cliente)
              clien$tipo_clien <- ifelse(clien$tipo_clien == "colocacion", "interesado", "vendedor")
              if(inmo$user != vars$user$user){
                clien_tercero <- data.frame(id = inmo$user, tipo_clien = "captador")
                clien <- rbind(clien_tercero, clien)
              }
              
              if(nrow(clien) != 0){
                vars$list_clientes_vinc <- clien
              }else{
                vars$list_clientes_vinc <- data.frame()
              }
              modal_inmo_description()
            })
          }
        })
      }
    }
    
    if(office_trans_on() == 1 | (estado_on() == 1 & cierres_on() == 1)){
      if(nrow(vars$list_scroll_1) != 0){
        for(i in vars$from_1:vars$to_1){
          trans <- vars$all_scroll_1[i,]
          btOpenTrans <- paste0("open_trans_1_button", i) 
          inmo <- list_table_var_mysql("myplace_inmuebles", "id", trans$id_inmo)
          
          open_scroll_1$boxes[[i]] <- div(style = "padding: 5px; display:inline-block",
                                          div(
                                            div(style = paste0("border-style: solid; border-width: 2px; border-color: #888888; 
                       border-radius: 10px; background-color: ", ifelse(inmo$externa == "si", main_color, "white"), "; width: 154px; height: 210px;
                                 margin: 0px; padding: 0px"),
                                                div(style = "margin-top: 80px; margin-left: 105px; position:absolute",
                                                    div(style = paste0("width: 45px; background-color: ", main_color, "; height: 20px; border-radius: 5px 0px 0px 5px; padding-left: 5px;"),
                                                        
                                                    ),
                                                    div(style = "margin-top: -22px; margin-left: 5px",
                                                        HTML(paste0("<p><span style='font-size: 76%; font-weight: normal; padding-right: 10px; margin: 0px; padding: 0px;
                             color: white;'>ID: ", as.integer(str_flatten(str_extract_all(inmo$id, "\\d")[[1]])), "</span></p>"))
                                                    )
                                                ),
                                                div(style = "width: 148px; height: 40px; position: absolute; margin-top: 115px; margin-left: 3px", 
                                                    HTML(paste0("<p><span style='margin-left: 10px; font-size: 110%; font-weight: lighter; color: ", ifelse(inmo$externa == "si", "white", "#666666"), ";'>", 
                                                                str_trunc(trans$user_name, 20), "</span></p>")),
                                                    HTML(paste0("<p><span style='margin-left: 10px; font-size: 100%; font-weight: bold; color: ", ifelse(inmo$externa == "si", "white", "#666666"), ";'>Comisión ", 
                                                                trans$tipo, "</span></p>")),
                                                    h4(paste0(trans$moneda, " ", format(trans$comision_a_cobrar, big.mark = ".", decimal.mark = ",", scientific = FALSE)), 
                                                       style = paste0("margin-left: 10px; font-weight: lighter; font-size: 125%;
                                             color: ", ifelse(inmo$externa == "si", "white", lighten(main_color, 0.20))))
                                                ),
                                                div(actionButton(btOpenTrans, NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:150px; height: 100px; margin: 0px;
                                                             background-image: url("', inmo$img, '");
                                                             background-size: cover, 150px 100px;
                                                             border-radius: 8px 8px 0px 0px')),
                                                )
                                            )
                                          )
          )
        }
        
        lapply(vars$from_1:vars$to_1, function(i){
          btOpenTrans <- paste0("open_trans_1_button", i) 
          open_scroll_1$obs_open_scroll[[i]] <<- observeEvent(input[[btOpenTrans]], ignoreNULL = TRUE, ignoreInit = TRUE, {
            freezeReactiveValue(input, btOpenTrans)
            vars$show_trans <- vars$all_scroll_1[i,]
            vars$trans_sel <- 1
            modal_trans_description()
          })
        })
        
      }
    }
  })
  
  output$boxes_with_scroll_ui_1 <- renderUI({
    do.call(div, open_scroll_1$boxes)
  })
  
  observeEvent(input$load_scroll_1, {
    isolate({
      print(vars$n_scroll_1)
      print(vars$loaded_scroll_1)
      print(vars$scroll_per_page_1)
      print(vars$all_scroll_1)
      if(vars$n_scroll_1 - vars$loaded_scroll_1 <= vars$scroll_per_page_1){
        vars$from_1 <- vars$loaded_scroll_1 + 1
        vars$to_1 <- vars$n_scroll_1
        vars$list_scroll_1 <- vars$all_scroll_1[vars$from_1:vars$to_1,]
        vars$loaded_scroll_1 <- vars$n_scroll_1
      }else{
        vars$from_1 <- vars$loaded_scroll_1 + 1
        vars$to_1 <- vars$loaded_scroll_1 + vars$scroll_per_page_1
        vars$list_scroll_1 <- vars$all_scroll_1[vars$from_1:vars$to_1,]
        vars$loaded_scroll_1 <- vars$scroll_per_page_1 + vars$loaded_scroll_1
      }
      print("vars$list_scroll_1")
      print(vars$list_scroll_1)
      print("from")
      print(vars$from_1)
      print("to")
      print(vars$to_1)
    })
  })
  
  output$bttn_prox_scroll_1 <- renderUI({
    if(vars$n_scroll_1 - vars$loaded_scroll_1 > 0){
      tags$div(id="bttn_modal", 
               actionBttn("load_scroll_1", "Cargar siguientes")
      )
    }
  })
  
  open_scroll_2 <- reactiveValues(boxes = list(), obs_open_scroll = list(), 
                                  obs_new_comentario = list())
  
  observeEvent(vars$list_scroll_2,{
    
    if(office_trans_on() == 1 | (estado_on() == 1 & cierres_on() == 1)){
      if(nrow(vars$list_scroll_2) != 0){
        for(i in vars$from_2:vars$to_2){
          trans <- vars$all_scroll_2[i,]
          btOpenTrans <- paste0("open_trans_2_button", i) 
          
          if(trans$tipo %in% c("colocación", "captación", "referido")){
            inmo <- list_table_var_mysql("myplace_inmuebles", "id", trans$id_inmo)
            
            open_scroll_2$boxes[[i]] <- div(style = "padding: 5px; display:inline-block",
                                            div(
                                              div(style = paste0("border-style: solid; border-width: 2px; border-color: #888888; 
                       border-radius: 10px; background-color: ", ifelse(inmo$externa == "si", main_color, "white"), "; width: 154px; height: 210px;
                                 margin: 0px; padding: 0px"),
                                                  div(style = "margin-top: 80px; margin-left: 105px; position:absolute",
                                                      div(style = paste0("width: 45px; background-color: ", main_color, "; height: 20px; border-radius: 5px 0px 0px 5px; padding-left: 5px;"),
                                                          
                                                      ),
                                                      div(style = "margin-top: -22px; margin-left: 5px",
                                                          HTML(paste0("<p><span style='font-size: 76%; font-weight: normal; padding-right: 10px; margin: 0px; padding: 0px;
                             color: white;'>ID: ", as.integer(str_flatten(str_extract_all(inmo$id, "\\d")[[1]])), "</span></p>"))
                                                      )
                                                  ),
                                                  div(style = "width: 148px; height: 40px; position: absolute; margin-top: 115px; margin-left: 3px", 
                                                      HTML(paste0("<p><span style='margin-left: 10px; font-size: 110%; font-weight: lighter; color: ", ifelse(inmo$externa == "si", "white", "#666666"), ";'>", 
                                                                  str_trunc(trans$user_name, 20), "</span></p>")),
                                                      HTML(paste0("<p><span style='margin-left: 10px; font-size: 100%; font-weight: bold; color: ", ifelse(inmo$externa == "si", "white", "#666666"), ";'>Comisión ", 
                                                                  trans$tipo, "</span></p>")),
                                                      h4(paste0(trans$moneda, " ", format(trans$comision_asesor, big.mark = ".", decimal.mark = ",", scientific = FALSE)), 
                                                         style = paste0("margin-left: 10px; font-weight: lighter; font-size: 125%;
                                             color: ", ifelse(inmo$externa == "si", "white", lighten(main_color, 0.20))))
                                                  ),
                                                  div(actionButton(btOpenTrans, NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:150px; height: 100px; margin: 0px;
                                                             background-image: url("', inmo$img, '");
                                                             background-size: cover, 150px 100px;
                                                             border-radius: 8px 8px 0px 0px')),
                                                  )
                                              )
                                            )
            )
          }else{
            imagen <- case_when(trans$tipo == "Pago a Place Analyzer" ~ "https://place-storage.nyc3.digitaloceanspaces.com/fotos-misc/place_analyzer_chico.jpg",
                                trans$tipo == "Pago comisión a Global" ~ "https://place-storage.nyc3.digitaloceanspaces.com/skyone/fotos-misc/skyone_chico.jpg")
            
            open_scroll_2$boxes[[i]] <- div(style = "padding: 5px; display:inline-block",
                                            div(
                                              div(style = paste0("border-style: solid; border-width: 2px; border-color: #888888; 
                       border-radius: 10px; background-color: white; width: 154px; height: 210px;
                                 margin: 0px; padding: 0px"),
                                                  div(style = "width: 148px; height: 40px; position: absolute; margin-top: 115px; margin-left: 3px", 
                                                      HTML(paste0("<p><span style='margin-left: 10px; font-size: 100%; font-weight: lighter; color: #666666;'>", trans$id_estado, "</span></p>")),
                                                      h4(paste0(trans$moneda, " ", format(trans$comision_asesor, big.mark = ".", decimal.mark = ",", scientific = FALSE)), 
                                                         style = paste0("margin-left: 10px; font-weight: lighter; font-size: 125%;
                                             color: ", lighten(main_color, 0.20)))
                                                      
                                                  ),
                                                  div(actionButton(btOpenTrans, NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:150px; height: 100px; margin: 0px;
                                                             background-image: url("', imagen, '");
                                                             background-size: cover, 150px 100px;
                                                             border-radius: 8px 8px 0px 0px')),
                                                  )
                                              )
                                            )
            )
          }
        }
        
        lapply(vars$from_2:vars$to_2, function(i){
          trans <- vars$all_scroll_2[i,]
          btOpenTrans <- paste0("open_trans_2_button", i) 
          open_scroll_2$obs_open_scroll[[i]] <<- observeEvent(input[[btOpenTrans]], ignoreNULL = TRUE, ignoreInit = TRUE, {
            freezeReactiveValue(input, btOpenTrans)
            vars$show_trans <- vars$all_scroll_2[i,]
            vars$trans_sel <- 2
            modal_trans_description()
          })
        })
        
      }
    }
  })
  
  output$boxes_with_scroll_ui_2 <- renderUI({
    do.call(div, open_scroll_2$boxes)
  })
  
  observeEvent(input$load_scroll_2, {
    isolate({
      print(vars$n_scroll_2)
      print(vars$loaded_scroll_2)
      print(vars$scroll_per_page_2)
      print(vars$all_scroll_2)
      if(vars$n_scroll_2 - vars$loaded_scroll_2 <= vars$scroll_per_page_2){
        vars$from_2 <- vars$loaded_scroll_2 + 1
        vars$to_2 <- vars$n_scroll_2
        vars$list_scroll_2 <- vars$all_scroll_2[vars$from_2:vars$to_2,]
        vars$loaded_scroll_2 <- vars$n_scroll_2
      }else{
        vars$from_2 <- vars$loaded_scroll_2 + 1
        vars$to_2 <- vars$loaded_scroll_2 + vars$scroll_per_page_2
        vars$list_scroll_2 <- vars$all_scroll_2[vars$from_2:vars$to_2,]
        vars$loaded_scroll_2 <- vars$scroll_per_page_2 + vars$loaded_scroll_2
      }
      print("vars$list_scroll_2")
      print(vars$list_scroll_2)
      print("from_2")
      print(vars$from_2)
      print("to_2")
      print(vars$to_2)
    })
  })
  
  output$bttn_prox_scroll_2 <- renderUI({
    if(vars$n_scroll_2 - vars$loaded_scroll_2 > 0){
      tags$div(id="bttn_modal", 
               actionBttn("load_scroll_2", "Cargar siguientes")
      )
    }
  })
  
  open_scroll_3 <- reactiveValues(boxes = list(), obs_open_scroll = list(), 
                                  obs_new_comentario = list())
  
  observeEvent(vars$list_scroll_3,{
    
    if(office_trans_on() == 1 | (estado_on() == 1 & cierres_on() == 1)){
      if(nrow(vars$list_scroll_3) != 0){
        for(i in vars$from_3:vars$to_3){
          trans <- vars$all_scroll_3[i,]
          btOpenTrans <- paste0("open_trans_3_button", i) 
          
          if(trans$tipo %in% c("colocación", "captación", "referido")){
            inmo <- list_table_var_mysql("myplace_inmuebles", "id", trans$id_inmo)
            
            open_scroll_3$boxes[[i]] <- div(style = "padding: 5px; display:inline-block",
                                            div(
                                              div(style = paste0("border-style: solid; border-width: 2px; border-color: #888888; 
                       border-radius: 10px; background-color: ", ifelse(inmo$externa == "si", main_color, "white"), "; width: 154px; height: 210px;
                                 margin: 0px; padding: 0px"),
                                                  div(style = "margin-top: 80px; margin-left: 105px; position:absolute",
                                                      div(style = paste0("width: 45px; background-color: ", main_color, "; height: 20px; border-radius: 5px 0px 0px 5px; padding-left: 5px;"),
                                                          
                                                      ),
                                                      div(style = "margin-top: -22px; margin-left: 5px",
                                                          HTML(paste0("<p><span style='font-size: 76%; font-weight: normal; padding-right: 10px; margin: 0px; padding: 0px;
                             color: white;'>ID: ", as.integer(str_flatten(str_extract_all(inmo$id, "\\d")[[1]])), "</span></p>"))
                                                      )
                                                  ),
                                                  div(style = "width: 148px; height: 40px; position: absolute; margin-top: 115px; margin-left: 3px", 
                                                      HTML(paste0("<p><span style='margin-left: 10px; font-size: 110%; font-weight: lighter; color: ", ifelse(inmo$externa == "si", "white", "#666666"), ";'>", 
                                                                  str_trunc(trans$user_name, 20), "</span></p>")),
                                                      HTML(paste0("<p><span style='margin-left: 10px; font-size: 100%; font-weight: bold; color: ", ifelse(inmo$externa == "si", "white", "#666666"), ";'>Comisión ", 
                                                                  trans$tipo, "</span></p>")),
                                                      h4(paste0(trans$moneda, " ", format(trans$comision_asesor, big.mark = ".", decimal.mark = ",", scientific = FALSE)), 
                                                         style = paste0("margin-left: 10px; font-weight: lighter; font-size: 125%;
                                             color: ", ifelse(inmo$externa == "si", "white", lighten(main_color, 0.20))))
                                                  ),
                                                  div(actionButton(btOpenTrans, NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:150px; height: 100px; margin: 0px;
                                                             background-image: url("', inmo$img, '");
                                                             background-size: cover, 150px 100px;
                                                             border-radius: 8px 8px 0px 0px')),
                                                  )
                                              )
                                            )
            )
          }else{
            imagen <- case_when(trans$tipo == "Pago a Place Analyzer" ~ "https://place-storage.nyc3.digitaloceanspaces.com/fotos-misc/place_analyzer_chico.jpg",
                                trans$tipo == "Pago comisión a Global" ~ "https://place-storage.nyc3.digitaloceanspaces.com/skyone/fotos-misc/skyone_chico.jpg")
            
            open_scroll_3$boxes[[i]] <- div(style = "padding: 5px; display:inline-block",
                                            div(
                                              div(style = paste0("border-style: solid; border-width: 2px; border-color: #888888; 
                       border-radius: 10px; background-color: white; width: 154px; height: 210px;
                                 margin: 0px; padding: 0px"),
                                                  div(style = "width: 148px; height: 40px; position: absolute; margin-top: 115px; margin-left: 3px", 
                                                      HTML(paste0("<p><span style='margin-left: 10px; font-size: 100%; font-weight: lighter; color: #666666;'>", trans$id_estado, "</span></p>")),
                                                      h4(paste0(trans$moneda, " ", format(trans$comision_asesor, big.mark = ".", decimal.mark = ",", scientific = FALSE)), 
                                                         style = paste0("margin-left: 10px; font-weight: lighter; font-size: 125%;
                                             color: ", lighten(main_color, 0.20)))
                                                      
                                                  ),
                                                  div(actionButton(btOpenTrans, NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:150px; height: 100px; margin: 0px;
                                                             background-image: url("', imagen, '");
                                                             background-size: cover, 150px 100px;
                                                             border-radius: 8px 8px 0px 0px')),
                                                  )
                                              )
                                            )
            )
          }
        }
        
        lapply(vars$from_3:vars$to_3, function(i){
          trans <- vars$all_scroll_3[i,]
          btOpenTrans <- paste0("open_trans_3_button", i) 
          open_scroll_3$obs_open_scroll[[i]] <<- observeEvent(input[[btOpenTrans]], ignoreNULL = TRUE, ignoreInit = TRUE, {
            freezeReactiveValue(input, btOpenTrans)
            vars$show_trans <- vars$all_scroll_3[i,]
            vars$trans_sel <- 3
            modal_trans_description()
          })
        })
        
      }
    }
  })
  
  output$boxes_with_scroll_ui_3 <- renderUI({
    do.call(div, open_scroll_3$boxes)
  })
  
  observeEvent(input$load_scroll_3, {
    isolate({
      print(vars$n_scroll_3)
      print(vars$loaded_scroll_3)
      print(vars$scroll_per_page_3)
      print(vars$all_scroll_3)
      if(vars$n_scroll_3 - vars$loaded_scroll_3 <= vars$scroll_per_page_3){
        vars$from_3 <- vars$loaded_scroll_3 + 1
        vars$to_3 <- vars$n_scroll_3
        vars$list_scroll_3 <- vars$all_scroll_3[vars$from_3:vars$to_3,]
        vars$loaded_scroll_3 <- vars$n_scroll_3
      }else{
        vars$from_3 <- vars$loaded_scroll_3 + 1
        vars$to_3 <- vars$loaded_scroll_3 + vars$scroll_per_page_3
        vars$list_scroll_3 <- vars$all_scroll_3[vars$from_3:vars$to_3,]
        vars$loaded_scroll_3 <- vars$scroll_per_page_3 + vars$loaded_scroll_3
      }
      print("vars$list_scroll_3")
      print(vars$list_scroll_3)
      print("from_3")
      print(vars$from_3)
      print("to_3")
      print(vars$to_3)
    })
  })
  
  output$bttn_prox_scroll_3 <- renderUI({
    if(vars$n_scroll_3 - vars$loaded_scroll_3 > 0){
      tags$div(id="bttn_modal", 
               actionBttn("load_scroll_3", "Cargar siguientes")
      )
    }
  })
  
  
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #home
  
    output$home_ui <- renderUI({
    if(home_on() == 1){
      
      div(
        fluidRow(
          column(width = 5,
            uiOutput("noticias_home_ui")
          ),
          column(width = 7,
            div(style = "width: 100%; max-width: 100%-450px",
                if(input$dimension[1] > 1150){
                  div(
                    div(uiOutput("estadisticas_home_ui"), align = "center"),
                    br(),
                    br(),
                    slickROutput("fotos_institucionales", width="600px"),
                    if(permiso("editar institucionales", NA, vars$permisos_acc, vars$permisos_men)){
                      
                      div(style = "position: absolute; margin-top: -380px; margin-left: 80px;",
                          actionButton("edit_fotos_institucionales", NULL, icon = icon("plus"), 
                                       style = paste0("backgound-color: white; border-color: ", main_color, "; color: ", main_color, 
                                                      "; border-width: 2px; width: 50px; height: 50px; border-radius: 25px; 
                                                               border-style: solid; font-size: 135%"))
                      )
                    }
                  )
                }
            )
          )
        )
      )
    }
  })
  
  output$noticias_home_ui <- renderUI({
    if(home_on() == 1){
      isolate({
        
        open_scroll_1$boxes = list()
        open_scroll_1$obs_open_scroll = list()
        open_scroll_1$obs_new_comentario = list()
        vars$n_scroll_1 <- 0
        vars$list_scroll_1 <- data.frame()
        
        vars$scroll_per_page_1 <- scroll_per_page
        vars$n_scroll_1 <- nrow_table_mysql(paste0(co, "_noticias"))
        if(vars$n_scroll_1 != 0){
          if(vars$n_scroll_1 > all_scroll_noticias){
            vars$all_scroll_1 <- list_n1_to_n2_mysql(paste0(co, "_noticias"), vars$n_scroll_1 - all_scroll_noticias, all_scroll_noticias)  %>% arrange(desc(fecha))
          }else{
            vars$all_scroll_1 <- load_mysql(paste0(co, "_noticias")) %>% arrange(desc(fecha))
          }
          if(vars$n_scroll_1 <= scroll_per_page){
            vars$from_1 <- 1
            vars$to_1 <- vars$n_scroll_1
            vars$list_scroll_1 <- vars$all_scroll_1
            vars$loaded_scroll_1 <- vars$n_scroll_1
          }else{
            vars$from_1 <- 1   
            vars$to_1 <- scroll_per_page
            vars$list_scroll_1 <- vars$all_scroll_1[vars$from_1:vars$to_1,]
            vars$loaded_scroll_1 <- scroll_per_page
          }
        }else{
          vars$loaded_scroll_1 <- 0
        }
      })
      
      div(style = "position: absolute; margin-top: -20px; margin-left: -20px; width: 100%; min-width: 400px",
          div(style = "overflow-y: scroll; height: 93vh; width: 100%", align = "left",
              div(style = "background-color: white;",
                  div(style = "position: absolute; margin-top: 10px; margin-left: 86%;",
                      actionButton("open_new_noticia", NULL, icon = icon("plus"), 
                                   style = paste0("backgound-color: white; border-color: ", main_color, "; color: ", main_color, 
                                                  "; border-width: 2px; width: 50px; height: 50px; border-radius: 25px; 
                                                               border-style: solid; font-size: 135%"))
                  ),
                  uiOutput("boxes_with_scroll_ui_1"), align = "left", 
                  div(uiOutput("bttn_prox_scroll_1"), align = "center")
              ),
          ),     
      )
    }
  })
  
  output$estadisticas_home_ui <- renderUI({
    if(vars$user$cargo %in% c("Broker Manager", "Broker Assistant")){
      agen <- list_table_var1_var2_mysql("myplace_usuarios", "company", "skyone", "agencia", vars$user$agencia)
    }else{
      agen <- vars$user
    }
    
    tot_inmos_sin_filtrar <- query_mysql(paste0("SELECT precio, moneda_contrato, tipo_contrato, ini_contrato,
                             precio_cierre, fecha_creacion, fecha_aprobacion, catastro FROM myplace_inmuebles WHERE 
                             user IN ", paste("(", paste(paste0("'", agen$user,"'"),collapse = ","), ")"), " AND activo = 'si' AND 
                             borrador = 'no' AND externa = 'no' AND company = 'skyone'"))
    tot_inmos <- tot_inmos_sin_filtrar %>% filter(precio_cierre == 0)
    cambio <- cambio_dolar$venta
    tot_inmos$precio <- ifelse(tot_inmos$moneda_contrato == "GS", round(tot_inmos$precio/cambio), tot_inmos$precio)
    busq <- list_table_var1_var2_var3_mysql("myplace_busquedas", "company", "skyone", "user", agen$user, "activo", "IN", "si")
    
    transa <- query_mysql(paste0("SELECT tipo FROM skyone_transacciones WHERE 
                                 user IN ", paste("(", paste(paste0("'", agen$user,"'"),collapse = ","), ")"), " AND 
                                 fecha BETWEEN '", paste0(year(now("America/Asuncion")), "-01-01"), "' AND '", as.character(now("America/Asuncion")), "' AND
                                 fase > '4' AND tipo IN ('colocación', 'captación') AND 
                                 comision_cobrada > 0"))

    cierres <- nrow(transa)
    colocaciones <- transa %>% filter(tipo == "colocación") %>% nrow()
    
    exclusividades <- tot_inmos_sin_filtrar %>% 
      mutate(nro_catas = ifelse(str_count(catastro, ",") > 0,
                                str_count(catastro, ",") + 1,
                                1)) %>%
      filter(tipo_contrato == "Exclusividad" &
               ini_contrato >= paste0(year(now("America/Asuncion")), "-01-01") &
               ini_contrato <= as.character(now("America/Asuncion")))
    exclusividades <- sum(exclusividades$nro_catas)
    
    captaciones <- tot_inmos_sin_filtrar %>% 
      mutate(nro_catas = ifelse(str_count(catastro, ",") > 0,
                                str_count(catastro, ",") + 1,
                                1),
             fecha = ifelse(tipo_contrato == "Exclusividad",
                            ini_contrato,
                            ifelse(is.na(fecha_aprobacion), fecha_creacion, fecha_aprobacion))) %>%
      filter(fecha >= paste0(year(now("America/Asuncion")), "-01-01") &
               fecha <= as.character(now("America/Asuncion")))
    captaciones <- sum(captaciones$nro_catas)
    
    div(
      div(class = "btn-group", style = "margin-left: 10px",
          #paste0("Propiedades: ", nrow(tot_inmos))
          div(style = paste0("background: white; width: 120px; height: 100px; border-radius: 20px;
                color: ", main_color, "; padding-top: 25px"), align = "center",
              h3("2025"),
              div(style = "margin-top: -5px", h5("Estadísticas"))
          ),
          div(style = "position: absolute; margin-top: -100px; margin-left: 40px",
              actionButton(inputId = "nada", label = NULL, icon = icon("chart-line"), 
                           style = paste0("background: transparent; border-color: transparent; border-radius: 5px; font-size: 250%;
                                                  padding: 0px; color: ", main_color))
              
          )
      ),
        div(class = "btn-group", style = "margin-left: 10px",
            #paste0("Propiedades: ", nrow(tot_inmos))
            div(style = paste0("background: white; width: 120px; height: 100px; border-radius: 20px;
                color: ", main_color, "; padding-top: 25px"), align = "center",
                h3(nrow(tot_inmos)),
                div(style = "margin-top: -5px", h5("Propiedades"))
            ),
            div(style = "position: absolute; margin-top: -100px; margin-left: 44px",
                actionButton(inputId = "nada", label = NULL, icon = icon("building"), 
                             style = paste0("background: transparent; border-color: transparent; border-radius: 5px; font-size: 250%;
                                                  padding: 0px; color: ", main_color))
              
            )
        ),
        div(class = "btn-group", style = "margin-left: 10px",
            #paste0("Propiedades: ", nrow(tot_inmos))
            div(style = paste0("background: white; width: 120px; height: 100px; border-radius: 20px;
                color: ", main_color, "; padding-top: 25px"), align = "center",
                h3(cierres),
                div(style = "margin-top: -5px", h5("Cierres"))
            ),
            div(style = "position: absolute; margin-top: -100px; margin-left: 40px",
                actionButton(inputId = "nada", label = NULL, icon = icon("handshake"), 
                             style = paste0("background: transparent; border-color: transparent; border-radius: 5px; font-size: 250%;
                                                  padding: 0px; color: ", main_color))
                
            )
        ),
        div(class = "btn-group", style = "margin-left: 10px",
            #paste0("Propiedades: ", nrow(tot_inmos))
            div(style = paste0("background: white; width: 120px; height: 100px; border-radius: 20px;
                color: ", main_color, "; padding-top: 25px"), align = "center",
                h3(captaciones),
                div(style = "margin-top: -5px", h5("Captaciones"))
            ),
            div(style = "position: absolute; margin-top: -100px; margin-left: 40px",
                actionButton(inputId = "nada", label = NULL, icon = icon("folder-plus"), 
                             style = paste0("background: transparent; border-color: transparent; border-radius: 5px; font-size: 250%;
                                                  padding: 0px; color: ", main_color))
                
            )
        ),
        div(class = "btn-group", style = "margin-left: 10px",
            #paste0("Propiedades: ", nrow(tot_inmos))
            div(style = paste0("background: white; width: 120px; height: 100px; border-radius: 20px;
                color: ", main_color, "; padding-top: 25px"), align = "center",
                h3(exclusividades),
                div(style = "margin-top: -5px", h5("Exclusividades"))
            ),
            div(style = "position: absolute; margin-top: -100px; margin-left: 40px",
                actionButton(inputId = "nada", label = NULL, icon = icon("star"), 
                             style = paste0("background: transparent; border-color: transparent; border-radius: 5px; font-size: 250%;
                                                  padding: 0px; color: ", main_color))
                
            )
        )
    )
  })
  
  observeEvent(input$open_new_noticia, {
    showModal(tags$div(id="modal_inmo_single", modalDialog(
      div(style = "width: 342px",
          fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white;"),
                    #h4(HTML(paste0("<p><span style='color: ", main_color, "'>Crear publicación</span></p>")), width = "100%"),
                    div(
                      div(class = "btn-group", actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 40px; height: 40px; margin: 0px; margin-left: 0px;
                                                             background-image: url("', vars$user$img, '");
                                                             background-size: cover, 40px 40px;
                                                             border-radius: 20px'))
                      ),
                      div(class = "btn-group", style = "margin-left: 10px",
                          h4(HTML(paste0("<p><span style='color: #888888; font-weight: bold'>", vars$user$name, "</span></p>"))))
                    ),
                    div(id = "text_transp", textAreaInput("noticia_text", NULL, placeholder = "¿Qué estás pensando?", 
                                                          value = input$noticia_text, height = 100, width = "100%")),
                    uiOutput("image_noticia"),
                    br(),
          ),
          div(id = "icon_info", style = "position: absolute; margin-top: 20px",
              actionButton(inputId = "nada", label = NULL, icon = icon("image"), 
                           onclick = 'Shiny.setInputValue(\"noticia_add_image\", this.id, {priority: \"event\"})',
                           style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 200%;
                                                  padding: 0px")
              
          )
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("finish_noticia", "Publicar"),
               actionBttn("close_new_noticia", "Cancelar"),
               align = "center"),
      title = "Nueva publicación",
      easyClose = FALSE,
      footer = NULL,
      size = "l",
      fade = TRUE
    )))
  })
  
  observeEvent(input$close_new_noticia, {
    vars$galeria_inmo_order <- c()
    vars$galeria_fotos_inmo <- c()
    vars$foto_inmo_file <- NA
    updateTextAreaInput(session, "noticia_text", value = "")
    removeModal()
  })
  
  output$fotos_institucionales <- renderSlickR({
    list <- list_spaces_do(prefix = paste0(co, "/fotos-institucionales/"))
    imgs <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", list$Key)[-1]
    slickR(obj = imgs, slideId = "slide_institucionales") + settings(dots = TRUE, autoplay = TRUE, autoplaySpeed = 2000)
  })
  
  observeEvent(input$edit_fotos_institucionales, {
    list <- list_spaces_do(prefix = paste0(co, "/fotos-institucionales/"))
    list <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", list$Key)[-1]
    vars$galeria_fotos_inmo <- list
    if(length(vars$galeria_fotos_inmo) > 0){
      rand <- str_pad(round(runif(1, min=1, max=9999999999)), 10, pad = "0")
      for(i in 1: length(vars$galeria_fotos_inmo)){
        serie <- paste0("", str_pad(i, 2, pad = "0"))
        im <- image_read(vars$galeria_fotos_inmo[i])
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo", serie, ".jpg")))
        put_object_do(paste0("/", co, "/temp/", vars$user$user, serie, "_", rand, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo", serie, ".jpg")))
        url <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/temp/", vars$user$user, serie, "_", rand, ".jpg")
        vars$galeria_fotos_inmo[i] <- url
      }
    }
    print(vars$galeria_fotos_inmo)
    
    showModal(modalDialog(
      #      multimediaUI("multi"),
      uiOutput("inmo_multimedios_ui"),
      h5("*Arrastra las fotos para ordenarlas."),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("edit_fotos_institucionales_ok", "OK"),
               align = "center"),
      title = paste0("Fotos publicadas"),
      easyClose = TRUE,
      footer = NULL,
      size = "l",
      fade = TRUE
    ))
    
  })
  
  observeEvent(input$edit_fotos_institucionales_ok, {
    
    if(length(vars$galeria_fotos_inmo) > 0){
      if(length(vars$galeria_inmo_order) == 0)
        vars$galeria_inmo_order <- 1:length(vars$galeria_fotos_inmo)
      print(isolate(vars$galeria_inmo_order))
      list <- list_spaces_do(prefix = paste0(co, "/fotos-institucionales/"))
      list <- list$Key[-1]
      if(length(list) > 0){
        for(i in 1:length(list)){
          delete_object_do(list[i])
        }
      }
      for(i in 1:length(vars$galeria_fotos_inmo)){
        rand <- str_pad(round(runif(1, min=1, max=999)), 3, pad = "0")
        name <- paste0("institucional_", str_pad(i, 12, pad = "0"), "_", rand)
        path <- vars$galeria_fotos_inmo[vars$galeria_inmo_order[i]]
        print(path)
        im <- image_read(path)
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        put_object_do(paste0("/", co, "/fotos-institucionales/", name, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
      }
      output$fotos_institucionales <- renderSlickR({
        list <- list_spaces_do(prefix = paste0(co, "/fotos-institucionales/"))
        imgs <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", list$Key)[-1]
        slickR(obj = imgs, slideId = "slide_institucionales") + settings(dots = TRUE, autoplay = TRUE, autoplaySpeed = 2000)
      })
      vars$galeria_inmo_order <- c()
      vars$galeria_fotos_inmo <- c()
      vars$foto_inmo_file <- NA
    }
    removeModal()
  })
  
  output$image_noticia <- renderUI({
    if(!is.na(vars$foto_inmo_file)){
      div(
        tags$img(src= vars$foto_inmo_file, width = "300px"),
        align = "center"
      )
    }else{
      div()
    }
  })
  
  observeEvent(input$noticia_add_image, {
    vars$galeria_inmo_order <- c()
    vars$galeria_fotos_inmo <- c()
    
    showModal(modalDialog(
      uiOutput("inmo_multimedios_ui"),
      h5("*Arrastra las fotos para ordenarlas. La primera será la portada"),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("noticia_add_image_ok", "OK"),
               align = "center"),
      title = paste0("Fotos publicadas"),
      easyClose = TRUE,
      footer = NULL,
      size = "l",
      fade = TRUE
    ))
  })
  
  observeEvent(input$noticia_add_image_ok, {
    print("noticia add image ok")
    print(vars$galeria_fotos_inmo)
    if(length(vars$galeria_fotos_inmo) > 0){
      if(length(vars$galeria_inmo_order) == 0)
        vars$galeria_inmo_order <- 1:length(vars$galeria_fotos_inmo)
      vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[vars$galeria_inmo_order]
      vars$foto_inmo_file <- dataURI(file = vars$galeria_fotos_inmo[1])
    }else{
      vars$galeria_inmo_order <- c()
      vars$galeria_fotos_inmo <- c()
      vars$foto_inmo_file <- NA
    }
    click("open_new_noticia")
  })
  
  observeEvent(input$finish_noticia, {
    if(length(vars$galeria_fotos_inmo) == 0){
      shinyalert(
        type = "error",
        title = "Debes subir al menos una foto"
      )
    }else{
      id <- new_id_table_mysql("id", paste0(co, "_noticias"), "noticia_", 12)
      rand <- str_pad(round(runif(1, min=1, max=999)), 3, pad = "0")
      img = ifelse(length(isolate(vars$galeria_fotos_inmo)) == 0, NA, 
                   paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/fotos-noticias/", id, "-01", "_", rand, "-small.jpg"))
      
      new_noticia <- data.frame(
        id = id,
        user = vars$user$user,
        fecha = as.character(now("America/Asuncion")),
        text = input$noticia_text,
        img = img,
        n_img = as.character(length(vars$galeria_fotos_inmo)),
        n_comen = "0",
        activo = "si"
      )
      save_mysql(new_noticia, paste0(co, "_noticias"), FALSE)
      
      if(length(vars$galeria_fotos_inmo) > 0){
        if(length(vars$galeria_inmo_order) == 0)
          vars$galeria_inmo_order <- 1:length(vars$galeria_fotos_inmo)
        vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[vars$galeria_inmo_order]
        for(i in 1:length(vars$galeria_fotos_inmo)){
          name <- paste0(id, "-", str_pad(i, 2, pad = "0"), "_", rand)
          im <- image_read(vars$galeria_fotos_inmo[i])
          image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
          put_object_do(paste0("/", co, "/fotos-noticias/", name, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
          info <- image_info(im)
          w <- info$width
          h <- info$height
          horiz <- w >= h
          im <- image_crop(im, paste0(ifelse(horiz, h, w), "x", 
                                      ifelse(horiz, h, w), "+", 
                                      ifelse(horiz, (w - h)/2, 0), "+",
                                      ifelse(horiz, 0, (h - w)/2)))
          im_small <- image_scale(im, "300x")
          image_write(im_small, file.path(dir, paste0(session$token, "temp_foto_inmo_small.jpg")))
          put_object_do(paste0("/", co, "/fotos-noticias/", name, "-small.jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo_small.jpg")))
        }
      }
      vars$galeria_inmo_order <- c()
      vars$galeria_fotos_inmo <- c()
      vars$foto_inmo_file <- NA
      updateTextAreaInput(session, "noticia_text", value = "")
      
      isolate({
        
        open_scroll_1$boxes = list()
        open_scroll_1$obs_open_scroll = list()
        open_scroll_1$obs_new_comentario = list()
        vars$n_scroll_1 <- 0
        vars$list_scroll_1 <- data.frame()
        
        vars$scroll_per_page_1 <- scroll_per_page
        vars$n_scroll_1 <- nrow_table_mysql(paste0(co, "_noticias"))
        if(vars$n_scroll_1 != 0){
          if(vars$n_scroll_1 > all_scroll_noticias){
            vars$all_scroll_1 <- list_n1_to_n2_mysql(paste0(co, "_noticias"), vars$n_scroll_1 - all_scroll_noticias, all_scroll_noticias)  %>% arrange(desc(fecha))
          }else{
            vars$all_scroll_1 <- load_mysql(paste0(co, "_noticias")) %>% arrange(desc(fecha))
          }
          if(vars$n_scroll_1 <= scroll_per_page){
            vars$from_1 <- 1
            vars$to_1 <- vars$n_scroll_1
            vars$list_scroll_1 <- vars$all_scroll_1
            vars$loaded_scroll_1 <- vars$n_scroll_1
          }else{
            vars$from_1 <- 1   
            vars$to_1 <- scroll_per_page
            vars$list_scroll_1 <- vars$all_scroll_1[vars$from_1:vars$to_1,]
            vars$loaded_scroll_1 <- scroll_per_page
          }
        }else{
          vars$loaded_scroll_1 <- 0
        }
      })
      
      removeModal()
    }
  })
  
  observeEvent(input$delete_noticia, {
    showModal(modalDialog(
      h4("¿Está seguro de eliminar esta noticia?"),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("delete_noticia_ok", "Eliminar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Eliminar noticia",
      easyClose = FALSE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$delete_noticia_ok, {
    #noticia <- list_table_var_mysql("skyone_noticias", "id", "noticia_000000000743")
    noticia <- vars$show_noticia
    comen <- list_table_var1_var2_mysql(paste0(co, "_comentarios"), "noticia", noticia$id, "activo", "si")
    list <- list_spaces_do(prefix = paste0(co, "/fotos-noticias/", noticia$id))
    if(nrow(list) > 0){
      list <- list$Key
      for(i in 1:length(list)){
        delete_object_do(list[i])
      }
    }
    
    update_var_table_mysql("no", "activo", "id", noticia$id, paste0(co, "_noticias"))
    if(nrow(comen) > 0){
      update_var_table_mysql("no", "activo", "id", comen$id, paste0(co, "_comentarios")) 
    }
    
    ind <- which(vars$all_scroll_1$id == noticia$id)
    open_scroll_1$boxes[[ind]] <- div()
    removeModal()
    comentarios_on(0)
  })
  
  comentarios_on <- reactiveVal(0)
  
  observe({
    print(vars$show_noticia)
    if(comentarios_on() == 1){
      print("Inicio abrir noticia")
      isolate({
        noticia <- vars$show_noticia
        agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", noticia$user)
        comen <- list_table_var_mysql(paste0(co, "_comentarios"), "noticia", noticia$id)
        vars$from_comen <- 1
        vars$to_comen <- nrow(comen)
        vars$list_comentarios <- comen
        print("comen 1")
        if(nrow(vars$list_comentarios) != 0){
          print("comen 2")
          for(i in isolate(vars$from_comen):isolate(vars$to_comen)){
            btDelComentario <- paste0("del_comentario_button", i) 
            comen <- vars$list_comentarios[i,]
            agente_comen <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", comen$user)
            diff <- round(difftime(as_datetime(now("America/Asuncion")), as_datetime(comen$fecha, tz = "America/Asuncion"), units = "mins")) %>% as.integer()
            if(diff < 60){
              diff <- paste0(diff, " minutos")
            }else{
              if(diff < 1440){
                diff <- paste0(round(diff/60), " horas")
              }else{
                diff <- paste0(round(diff/1140), " días")
              }
            }
            if(comen$activo == "si"){
              open_comentarios$boxes[[i]] <- div(style = "padding: 5px;", align = ifelse(comen$user == vars$user$user, "right", "left"),
                                                 if(comen$user == vars$user$user | permiso("eliminar comentarios", comen$user, vars$permisos_acc, vars$permisos_men)){
                                                   div(style = paste0("position: absolute; margin-top: 5px; margin-left: ",  ifelse(comen$user == vars$user$user, "307px", "247px")),
                                                       actionButton(inputId = btDelComentario, label = NULL, icon = icon("trash-alt"), 
                                                                    style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 100%;
                                                                     padding: 0px; color: #aaaaaa")
                                                   )
                                                 },
                                                 fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: #888888; width: 270px;
                       border-radius: 20px; background-color: ", ifelse(comen$user == vars$user$user, lighten(main_color, 0.90), "white"), "; padding: 0px; padding-left: 10px; padding-right: 10px;
                                       margin: 0px;"), align = "left",
                                                           div(
                                                             div(class = "btn-group", actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 30px; height: 30px; margin: 0px; margin-left: 0px;
                                                             background-image: url("', agente_comen$img, '");
                                                             background-size: cover, 30px 30px;
                                                             border-radius: 15px; margin-top: -15px'))
                                                             ),
                                                             div(class = "btn-group", style = "margin-left: 10px; margin-top: -8px",
                                                                 div(
                                                                   h4(HTML(paste0("<p><span style='color: #888888; font-weight: bold; font-size: 80%;'>", agente_comen$name, "</span></p>"))),
                                                                   h5(HTML(paste0("<p><span style='color: #666666; font-weight: lighter; font-size: 80%;'>", diff, "</span></p>")), style = "margin-top: -7px")
                                                                 )
                                                             )
                                                           ),
                                                           h5(comen$text, style = "width: 100%; word-break: break-word; margin-top: -8px"),    
                                                 )
              )
            }
          }
          
          lapply(isolate(vars$from_comen):isolate(vars$to_comen), function(i){
            btDelComentario <- paste0("del_comentario_button", i) 
            open_comentarios$obs_del_comentario[[i]] <<- observeEvent(input[[btDelComentario]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btDelComentario)
              comen <- vars$list_comentarios[i,]
              noticia <- vars$show_noticia
              comentarios_on(0)
              update_var_table_mysql("no", "activo", "id", comen$id, paste0(co, "_comentarios"))
              n_comen <- list_table_var1_var2_mysql(paste0(co, "_comentarios"), "noticia", noticia$id, "activo", "si") %>% nrow() %>% as.character()
              update_var_table_mysql(n_comen, "n_comen", "id", noticia$id, paste0(co, "_noticias"))
              ind <- which(vars$all_scroll_1$id == noticia$id)
              vars$all_scroll_1$n_comen[vars$all_scroll_1$id == noticia$id] <- n_comen
              vars$from_1 <- ind
              vars$to_1 <- ind
              vars$list_scroll_1$n_comen[vars$list_scroll_1$id == noticia$id] <- n_comen
              removeModal()
            })
          })  
          
        }else{
          open_comentarios$boxes <- div()
        }
        
        output$fotos_noticias <- renderSlickR({
          slickR(obj = vars$gal, objLinks = vars$gal_links, slideId = "slide_noticias") + 
            settings(dots = TRUE, autoplay = TRUE, autoplaySpeed = 2000)
        })
        
        diff_noti <- round(difftime(as_datetime(now("America/Asuncion")), as_datetime(noticia$fecha, tz = "America/Asuncion"), units = "mins")) %>% as.integer()
        if(diff_noti < 60){
          diff_noti <- paste0(diff_noti, " minutos")
        }else{
          if(diff_noti < 1440){
            diff_noti <- paste0(round(diff_noti/60), " horas")
          }else{
            diff_noti <- paste0(round(diff_noti/1140), " días")
          }
        }
        if(nrow(comen) > 0){
          diff <- round(difftime(as_datetime(now("America/Asuncion")), as_datetime(comen$fecha, tz = "America/Asuncion"), units = "mins")) %>% as.integer()
          if(diff < 60){
            diff <- paste0(diff, " minutos")
          }else{
            if(diff < 1440){
              diff <- paste0(round(diff/60), " horas")
            }else{
              diff <- paste0(round(diff/1140), " días")
            }
          }
        }
        
        list_all <- list_spaces_do(prefix = paste0(co, "/fotos-noticias/", noticia$id))[,1]
        list_all <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", list_all)
        print(list_all)
        if(length(list_all) == 0){
          vars$gal <- c()
          varrs$gal_links <- c()
        }else{
          vars$gal <- list_all[str_detect(list_all, "small")]
          vars$gal_links <- list_all[!str_detect(list_all, "small")]
        }
      })
      
      showModal(tags$div(id="modal_inmo_double", modalDialog(
        div(id = "form_noticia",
            fluidPage(
              fluidRow(
                column(6, style = "width: 340px; margin-bottom: 10px; margin-top: 0px;",
                       if(vars$user$cargo == "Global Master Office" | noticia$user == vars$user$user | permiso("eliminar noticias", noticia$user, vars$permisos_acc, vars$permisos_men)){
                         div(style = "position: absolute; margin-top: 10px; margin-left: 274px",
                             div(align = "right",
                                 actionButton("delete_noticia", NULL, icon = icon("trash-alt"), 
                                              style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 120%;
                                                                     padding: 0px; color: #aaaaaa")
                             )
                         )
                       },
                       fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: ", "#aaaaaa", "; 
                       border-radius: 10px; background-color: white; padding: 10px; margin: 0px; width: 300px;
                                                    margin-bottom: 10px"), align = "left",
                                 div(
                                   div(class = "btn-group", actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 40px; height: 40px; margin: 0px; margin-left: 0px;
                                                             background-image: url("', agente$img, '");
                                                             background-size: cover, 40px 40px;
                                                             border-radius: 20px'))
                                   ),
                                   div(class = "btn-group", style = "margin-left: 10px",
                                       div(
                                         h4(HTML(paste0("<p><span style='color: #888888; font-weight: bold'>", agente$name, "</span></p>"))),
                                         h5(HTML(paste0("<p><span style='color: #888888; font-weight: lighter'>", diff_noti, "</span></p>")), style = "margin-top: -5px")
                                       )
                                   )
                                 ),
                                 h5(noticia$text, style = "width: 100%; word-break: break-word;"),    
                       ),
                       if(length(vars$gal) > 0){
                         slickROutput("fotos_noticias", width = "300px")
                       }
                ),
                column(6, style = "width: 340px; padding: 0px;", 
                       uiOutput("box_comentarios_list_ui"),
                       div(style = "background-color: #eeeeee; border-color: #444444; border-width: 1px; border-style: solid;
                            border-radius: 20px; height: 80px; margin-bottom: 10px;",
                           div(class = "btn-group", actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 40px; height: 40px; margin: 10px; margin-top: -10px;
                                                             background-image: url("', vars$user$img, '");
                                                             background-size: cover, 40px 40px;
                                                             border-radius: 20px'))
                           ),
                           div(class = "btn-group", style = "width: 200px",
                               uiOutput("text_comentario_ui")
                           ),
                           div(class = "btn-group", style = "margin-top: -10px; margin-left: -5px",
                               actionButton("new_comentario", NULL, icon = icon("paper-plane"), style = paste0("background-color: transparent; font-size: 180%;
                                                                                border-color: transparent; padding: 0px; margin-left: 10px;
                                                                                color: ", main_color))
                           )
                       )
                )
              )
            )
        ),
        br(),
        tags$div(id="bttn_modal", 
                 actionBttn("close_noticia_ok", "OK"),
                 align = "center"),
        title = paste0("Ver publicación"),
        easyClose = FALSE,
        footer = NULL,
        size = "l",
        fade = TRUE
      )))
    }
  })
  
  observeEvent(input$close_noticia_ok, {
    noticia <- vars$show_noticia
    n_comen <- list_table_var1_var2_mysql(paste0(co, "_comentarios"), "noticia", noticia$id, "activo", "si") %>% nrow() %>% as.character()
    update_var_table_mysql(n_comen, "n_comen", "id", noticia$id, paste0(co, "_noticias"))
    ind <- which(vars$all_scroll_1$id == noticia$id)
    vars$all_scroll_1$n_comen[vars$all_scroll_1$id == noticia$id] <- n_comen
    vars$from_1 <- ind
    vars$to_1 <- ind
    vars$list_scroll_1$n_comen[vars$list_scroll_1$id == noticia$id] <- n_comen
    comentarios_on(0)
    vars$show_noticia <- NA
    removeModal()
  })
  
  observe({
    if(comentarios_on() == 1){
      output$box_comentarios_list_ui <- renderUI({
        do.call(div, open_comentarios$boxes)
      })
    }
  })
  
  output$text_comentario_ui <- renderUI({
    div(id = "text_transp", textAreaInput("text_comentario", NULL, placeholder = "Deja tu comentario...", height = 60,
                                          value = isolate(input$text_comentario)))
  })
  
  observeEvent(input$new_comentario, {
    if(input$text_comentario != ""){
      noticia <- vars$show_noticia
      isolate({
        new_comentario <- data.frame(
          id = new_id_table_mysql("id", paste0(co, "_comentarios"), "comentario_", 12),
          user = vars$user$user,
          noticia = noticia$id,
          fecha = as.character(now("America/Asuncion")),
          text = input$text_comentario,
          activo = "si"
        )
        save_mysql(new_comentario, paste0(co, "_comentarios"), FALSE)
        n_comen <- list_table_var1_var2_mysql(paste0(co, "_comentarios"), "noticia", noticia$id, "activo", "si") %>% nrow() %>% as.character()
        update_var_table_mysql(n_comen, "n_comen", "id", noticia$id, paste0(co, "_noticias"))
        if(noticia$user != vars$user$user){
          new_alarma <- data.frame(
            id = new_id_table_mysql("id", paste0(co, "_alarmas"), "alarma_", 12),
            fecha = as.character(as_date(now("America/Asuncion"))),
            time = as.character(now("America/Asuncion")),
            user = vars$user$user,
            destino = noticia$user,
            id_inmo = NA,
            id_clien = NA,
            id_estado = NA,
            id_busq = NA,
            id_noticia = noticia$id,
            id_calificacion = NA,
            tipo = "Nuevo comentario",
            visto = "no",
            img = noticia$img,
            comment = paste0("El asesor ", vars$user$name, " ha comentado tu publicación")
          )
          save_mysql(new_alarma, paste0(co, "_alarmas"), FALSE)
        }
        
        updateTextAreaInput(session, "text_comentario", value = "")
        back <- vars$list_comentarios
        all <- list_table_var_mysql(paste0(co, "_comentarios"), "noticia", noticia$id)
        new <- all[!all$id %in% back$id, ]
      })
      vars$from_comen <- nrow(back) + 1
      vars$to_comen <- nrow(all)
      vars$list_comentarios <- all
    }
  })
  
  open_comentarios <- reactiveValues(boxes = list(), obs_del_comentario = list())
  
  observeEvent(vars$list_comentarios, {
    if(nrow(vars$list_comentarios != 0)){
      for(i in isolate(vars$from_comen):isolate(vars$to_comen)){
        btDelComentario <- paste0("del_comentario_button", i) 
        comen <- vars$list_comentarios[i,]
        agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", comen$user)
        diff <- round(difftime(as_datetime(now("America/Asuncion")), as_datetime(comen$fecha, tz = "America/Asuncion"), units = "mins")) %>% as.integer()
        if(diff < 60){
          diff <- paste0(diff, " minutos")
        }else{
          if(diff < 1440){
            diff <- paste0(round(diff/60), " horas")
          }else{
            diff <- paste0(round(diff/1140), " días")
          }
        }
        if(comen$activo == "si"){
          open_comentarios$boxes[[i]] <- div(style = "padding: 5px;", align = ifelse(comen$user == vars$user$user, "right", "left"),
                                             if(comen$user == vars$user$user | permiso("eliminar comentarios", comen$user, vars$permisos_acc, vars$permisos_men)){
                                               div(style = paste0("position: absolute; margin-top: 5px; margin-left: ",  ifelse(comen$user == vars$user$user, "307px", "247px")),
                                                   actionButton(inputId = btDelComentario, label = NULL, icon = icon("trash-alt"), 
                                                                style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 100%;
                                                                     padding: 0px; color: #aaaaaa")
                                               )
                                             },
                                             fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: #888888; width: 270px;
                       border-radius: 20px; background-color: ", ifelse(comen$user == vars$user$user, lighten(main_color, 0.90), "white"), "; padding: 0px; padding-left: 10px; padding-right: 10px;
                                       margin: 0px;"), align = "left",
                                                       div(
                                                         div(class = "btn-group", actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 30px; height: 30px; margin: 0px; margin-left: 0px;
                                                             background-image: url("', agente$img, '");
                                                             background-size: cover, 30px 30px;
                                                             border-radius: 15px; margin-top: -15px'))
                                                         ),
                                                         div(class = "btn-group", style = "margin-left: 10px; margin-top: -8px",
                                                             div(
                                                               h4(HTML(paste0("<p><span style='color: #888888; font-weight: bold; font-size: 80%;'>", agente$name, "</span></p>"))),
                                                               h5(HTML(paste0("<p><span style='color: #666666; font-weight: lighter; font-size: 80%;'>", diff, "</span></p>")), style = "margin-top: -7px")
                                                             )
                                                         )
                                                       ),
                                                       h5(comen$text, style = "width: 100%; word-break: break-word; margin-top: -8px"),    
                                             )
          )
        }
      }
      
      lapply(isolate(vars$from_comen):isolate(vars$to_comen), function(i){
        btDelComentario <- paste0("del_comentario_button", i) 
        open_comentarios$obs_del_comentario[[i]] <<- observeEvent(input[[btDelComentario]], ignoreNULL = TRUE, ignoreInit = TRUE, {
          freezeReactiveValue(input, btDelComentario)
          comen <- vars$list_comentarios[i,]
          noticia <- vars$show_noticia
          comentarios_on(0)
          update_var_table_mysql("no", "activo", "id", comen$id, paste0(co, "_comentarios"))
          n_comen <- list_table_var1_var2_mysql(paste0(co, "_comentarios"), "noticia", noticia$id, "activo", "si") %>% nrow() %>% as.character()
          update_var_table_mysql(n_comen, "n_comen", "id", noticia$id, paste0(co, "_noticias"))
          ind <- which(vars$all_scroll_1$id == noticia$id)
          vars$all_scroll_1$n_comen[vars$all_scroll_1$id == noticia$id] <- n_comen
          vars$from_1 <- ind
          vars$to_1 <- ind
          vars$list_scroll_1$n_comen[vars$list_scroll_1$id == noticia$id] <- n_comen
          removeModal()
        })
      })  
      
    }else{
      open_comentarios$boxes <- div()
    }
    
    
  })
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #alarmas
  
  output$alarmas_bttn_ui <- renderUI({
    if(vars$start == FALSE){
      req(vars$new_bell)
      div(
        if(vars$new_bell > 0){
          div(style = "height: 14px; width: 14px; border-radius: 7px; background-color: red; color: white;
            position: absolute; margin-left: 22px; margin-top: 6px; padding: 0px", align = "center",
              h5(vars$new_bell, style = "margin-top: 1px; margin-left: -1px; font-size: 80%")
          )
        },
        actionButton("alarmas_on_off", NULL, icon = icon("bell"), style = "padding: 8px; background-color: transparent;
                                                                      border-color: transparent; color: white;
                                                                      font-size: 160%; margin-right: 20px")
      )
    }
  })
  
  observeEvent(input$alarmas_on_off, {
    if(alarmas_on() == 0){
      alarmas_all <- list_table_var1_var2_mysql(paste0(co, "_alarmas"), "destino", "all", "fecha", 
                                                c(as.character(as_date(now("America/Asuncion"))), 
                                                  as.character(as_date(now("America/Asuncion")) - days(1))))
      alarmas_comen <- list_table_var1_var2_var3_mysql(paste0(co, "_alarmas"), "destino", vars$user$user, "fecha", 
                                                       c(as.character(as_date(now("America/Asuncion"))), 
                                                         as.character(as_date(now("America/Asuncion")) - days(1))),
                                                       "tipo", "IN", "Nuevo comentario")
      if(nrow(alarmas_comen) > 0){
        alarmas_comen_group <- alarmas_comen %>% group_by(id_noticia, user) %>% summarize(id = first(id))
        alarmas_comen_group <- alarmas_comen_group %>% group_by(id_noticia) %>% summarize(n = n(), id = first(id))
        alarmas_comen_uno_id <- alarmas_comen_group %>% filter(n == 1) %>% .$id
        print("print uno")
        print(alarmas_comen_uno_id)
        alarmas_comen_uno <- alarmas_comen %>% filter(id %in% alarmas_comen_uno_id)
        
        alarmas_comen_mas_id <- alarmas_comen_group %>% filter(n > 1)
        print("print mas")
        print(alarmas_comen_mas_id)
        if(nrow(alarmas_comen_mas_id) > 0){
          alarmas_comen_mas_id <- alarmas_comen_mas_id[,2:3]
          alarmas_comen_mas <- left_join(alarmas_comen_mas_id,  alarmas_comen, "id") %>% 
            mutate(comment = comentario_mas_de(comment, n)) %>% select(-n)
        }else{
          alarmas_comen_mas <- data.frame()
        }
        alarmas_comen <- rbind(alarmas_comen_uno, alarmas_comen_mas)
      }
      alarmas_others <- list_table_var1_var2_var3_mysql(paste0(co, "_alarmas"), "destino", vars$user$user, "fecha", 
                                                        c(as.character(as_date(now("America/Asuncion"))), 
                                                          as.character(as_date(now("America/Asuncion")) - days(1))),
                                                        "tipo", "NOT IN", "Nuevo comentario")
      alarmas <- rbind(alarmas_all, alarmas_comen, alarmas_others) %>% arrange(desc(time)) %>% filter(user != vars$user$user) %>% head(20)
      vars$new_bell <- 0
      if(nrow(alarmas) > 0){
        vars$alarmas_list <- alarmas
        alarmas_on(1)
      }
    }else{
      alarmas_on(0)
    }
  })
  
  output$alarmas_ui <- renderUI({
    if(alarmas_on() == 1){
      div(style = paste0("position: fixed; margin-top: -17px; z-index: 100; background-color: ", main_color, "; border-radius: 10px;
          width: 300px; left: 100%; margin-left: -310px; color: white; padding: 10px;
                         box-shadow: rgba(0, 0, 0, 0.6) 10px 20px 30px 0px,
                         inset 5px 5px 5px rgba(255,255,255,.4), 
                         inset -5px -5px 5px rgba(0,0,0,.3)"),
          uiOutput("box_alarmas_ui")
      )
    }
  })
  
  obs_open_alarma <- list()
  observe({
    if(alarmas_on() == 1){
      if(nrow(vars$alarmas_list) != 0){
        output$box_alarmas_ui <- renderUI({
          boxes_alarmas <- as.list(1:nrow(vars$alarmas_list))
          boxes_alarmas <- lapply(boxes_alarmas, function(i){
            btOpenAlarma <- paste0("open_alarma_button", i) 
            alarma <- vars$alarmas_list[i,]
            if(alarma$tipo %in% c("Nueva propiedad", "Match de búsqueda inteligente", "Propiedad bajó de precio",
                                  "Propiedad editada")){
              tipo <- "inmo"
            }else{
              if(alarma$tipo %in% c("Pasado a proceso de cierre", "Dar de baja operacion", 
                                    "Nuevo interesado", "Nuevo seguimiento", "MyPlace, Nuevo interesado",
                                    "MyPlace, Nuevo seguimiento")){
                tipo <- "estado"
              }else{
                if(alarma$tipo %in% c("Nuevo comentario")){
                  tipo <- "noticia"
                }
              }
            }
            print(alarma)
            obs_open_alarma[[btOpenAlarma]] <<- observeEvent(input[[btOpenAlarma]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btOpenAlarma)
              alarma <- vars$alarmas_list[i,]
              co_alarma <- ifelse(str_detect(alarma$tipo, "MyPlace"), "place", co)
              co_inmo <- str_split(alarma$id_inmo, "_")[[1]][1]
              inmo <- list_table_var_mysql("myplace_inmuebles", "id", alarma$id_inmo)
              if(tipo == "inmo"){
                vars$show_inmo <- inmo
                vars$list_clientes_vinc <- data.frame()
                modal_inmo_description()
              }else{
                if(tipo == "estado"){
                  if(co_alarma == "place"){
                    estado <- list_table_var1_var2_var3_mysql(paste0(co, "_estados"), "user", inmo$user, "id_inmo", inmo$id, "id_clien", "IN", alarma$user)
                  }else{
                    estado <- list_table_var1_var2_var3_mysql(paste0(co, "_estados"), "user", inmo$user, "id_inmo", inmo$id, "id_clien", "IN", inmo$cliente)
                  }
                  vars$show_estado <- estado
                  modal_estado_description()
                }else{
                  if(tipo == "noticia"){
                    noticia <- list_table_var_mysql(paste0(co, "_noticias"), "id", alarma$id_noticia)
                    vars$show_noticia <- noticia
                    comentarios_on(1)
                  }
                }
              }
            })
            
            div(style = "padding: 0px; display:inline-block",
                div(
                  div(id = "back_hover", style = paste0("border-style: solid; border-width: 0px; border-color: transparent; 
                                width: 280px; height: 71px;
                                 margin: 0px; padding: 8px;"),
                      div(style = "width: 230px; height: 15px; position: absolute; margin-top: -5px; margin-left: 60px", 
                          HTML(paste0("<p><span style='font-size: 100%; font-weight: bold; color: #dddddd; height: 15px;
                                      line-height: 0.8'>", 
                                      alarma$tipo, "</span></p>"))
                      ),
                      div(style = "width: 220px; height: 40px; position: absolute; margin-top: 15px; margin-left: 60px", 
                          HTML(paste0("<p><span style='font-size: 80%; font-weight: normal; color: white; height: 40px'>", 
                                      alarma$comment, "</span></p>"))
                      ),
                      div(actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 55px; height: 55px; margin: 0px; margin-left: -8px;
                                                             background-image: url("', alarma$img, '");
                                                             background-size: cover, 55px 55px;
                                                             border-radius: 6px'),
                                       onclick = paste0('Shiny.setInputValue(\"', btOpenAlarma, '\", this.id, {priority: \"event\"})')),
                      )
                  )
                )
            )
          })
        })
      }else{
        output$box_alarmas_ui <- renderUI({
          div()
        })
      }
    }
  })
  
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #llamadas
  
  output$llamadas_bttn_ui <- renderUI({
    if(vars$start == FALSE){
      req(vars$new_cal)
      div(
        if(vars$new_cal > 0){
          div(style = "height: 14px; width: 14px; border-radius: 7px; background-color: red; color: white;
            position: absolute; margin-left: 22px; margin-top: 6px; padding: 0px", align = "center",
              h5(vars$new_cal, style = "margin-top: 1px; margin-left: -1px; font-size: 80%")
          )
        },
        actionButton("task_on_off", NULL, icon = icon("calendar"), style = "padding: 8px; background-color: transparent;
                                                                      border-color: transparent; color: white;
                                                                      font-size: 160%; margin-right: 20px")
      )
    }
  })
  
  observeEvent(input$task_on_off, {
    if(task_on() == 0){
      llamadas <- list_table_var1_var2_var3_mysql(paste0(co, "_llamadas"), "user", vars$user$user, "realizado", "no", "fecha_agendada", "NOT IN", "NA")
      if(nrow(llamadas) != 0){
        vars$calendar <- generate_calendar(llamadas)
        vars$new_cal <- llamadas %>% filter(fecha_agendada == as.character(as_date(now("America/Asuncion")))) %>% nrow()
        print(vars$new_cal)
      }else{
        vars$calendar <- data.frame()
        vars$new_cal <- 0
      }
      task_on(1)
    }else{
      task_on(0)
    }
  })
  
  output$task_ui <- renderUI({
    if(task_on() == 1){
      div(
        fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                  div(id="bttn_modal", style = "margin: 10px",
                      actionButton("view_calendar", "Ver detalle")
                  ),
                  calendarOutput("calendar_ui")
        ),
        br()
      )
    }
  })
  
  output$calendar_ui <- renderCalendar({
    calendar() %>% cal_schedules(vars$calendar) %>%
      cal_month_options(
        startDayOfWeek = 1,
        daynames = c("Dom", "Lun", "Mar", "Mie", "Jue", "Vie", "Sab")
      )
  })
  
  observeEvent(input$view_calendar, {
    if(!is.null(input$calendar_ui_click)){
      id_estado <- input$calendar_ui_click$calendarId
      session$sendCustomMessage(type = "resetValue", message = "calendar_ui_click")
      if(str_detect(id_estado, "estado")){
        vars$show_estado <- list_table_var_mysql(paste0(co, "_estados"), "id", id_estado)
        modal_estado_description()
      }else{
        vars$cliente <- list_table_var_mysql(paste0(co, "_clientes"), "id", id_estado)
        vars$foto_inmo_file <- NA
        vars$foto_cliente <- vars$cliente$img
        modal_clien_description()
      }
    }else{
      shinyalert(
        type = "error",
        title = "Primero haz click en una tarea del calendario"
      )
    }
    
  })
  
  
  
  ###################################################################################################################################  
  ###################################################################################################################################  
  #office_agen
  
  output$office_agen_ui <- renderUI({
    if(office_agen_on() == 1){
      fluidPage(
        div(style = "position: sticky; width: 100%; z-index: 5",
            uiOutput("office_agen_filtros_ui"),
            uiOutput("office_stat_ui")
        ),
        div(uiOutput("box_office_agen_list_ui"), align = "center")
      )
    }
  })   
  
  output$office_agen_filtros_ui <- renderUI({
    if(office_agen_on() == 1){
      
      if(vars$user$agencia == "Global Master Office"){
        franquicia_nam <- "Global Master Office"
      }else{
        if(vars$user$agencia %in% vars$franquicias$id){
          franquicia_nam <- agencia_name(vars$user$agencia, vars$agencias, vars$franquicias)
        }else{
          franquicia_id <- vars$agencias$master[vars$user$agencia == vars$agencias$id]
          franquicia_nam <- agencia_name(franquicia_id, vars$agencias, vars$franquicias)
        }
      }
      
      fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                tags$div(id = "inline",
                         if(vars$user$cargo %in% c("Global Master Office", "Global Office Manager", "Global Office Assistant", "Broker Office", "Broker Manager", 
                                                   "Country Office Manager", "Broker Assistant")){
                           div(class = "btn-group", style = "margin: 5px;", actionButton("crear_agente", "Nuevo usuario", icon = icon("plus")))
                         },
                         div(class = "btn-group", style = "margin: 5px; margin-top: 25px; width: 180px;", 
                             selectInput("office_agen_filt_fra", NULL, choices = c("Global Master Office", vars$franquicias$name),
                                         selected = franquicia_nam)
                         ),
                         div(class = "btn-group", style = "margin: 5px; margin-top: 25px; width: 180px;", 
                             uiOutput("office_agen_filt_sel_ui")
                         ),
                         div(class = "btn-group", style = "width: 200px; margin: 5px; margin-top: 0px", 
                             textInput("office_agen_filt_name", "Buscar por nombre", value = NULL)
                         )
                )
      )
    }
  })
  
  output$office_agen_filt_sel_ui <- renderUI({
    req(input$office_agen_filt_fra)
    if(input$office_agen_filt_fra != "Global Master Office"){
      id_franquicia <- vars$franquicias$id[vars$franquicias$name == input$office_agen_filt_fra]
      
      agencias <- vars$agencias$name[vars$agencias$master == id_franquicia]
      
      if(vars$user$agencia %in% c("Global Master Office", vars$franquicias$id)){
        agencia_nam <- "Todas"
      }else{
        agencia_nam <- agencia_name(vars$user$agencia, vars$agencias, vars$franquicias)
      }
      
      selectInput("office_agen_filt_ofi", NULL, choices = c("Todas", agencias),
                  selected = agencia_nam)
    }
  })
  
  output$office_stat_ui <- renderUI({
    req(vars$office_agen_all_pages)
    if(office_stat_on() == 1){
      agencia_nam <- agencia_name(vars$user$agencia, vars$agencias, vars$franquicias)
      
      if(vars$user$cargo %in% c("Global Master Office", "Global Office Assistant", "Global Office Manager") | input$office_agen_filt_ofi == agencia_nam){
        
        if(vars$user$cargo %in% c("Global Master Office", "Global Office Assistant", "Global Office Manager") && !is.null(input$office_agen_filt_ofi) && input$office_agen_filt_ofi == "Todas"){
          franq <- vars$franquicias$id[vars$franquicias$name == input$office_agen_filt_fra]
          ofis <- vars$agencias$id[vars$agencias$master == franq]
          office_agen_all_stat <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "agencia", ofis)
        }else{
          office_agen_all_stat <- vars$office_agen_all_pages
        }
        tot_inmos <- list_table_var1_var2_var3_mysql("myplace_inmuebles", "company", "skyone", "user", office_agen_all_stat$user, "activo", "IN", "si")
        tot_inmos <- tot_inmos %>% filter(borrador == "no" & precio_cierre == 0) %>% select(user, precio, moneda_contrato, venta_alquiler, tipoPropiedad)
        cambio <- cambio_dolar$venta
        tot_inmos$precio <- ifelse(tot_inmos$moneda_contrato == "GS", round(tot_inmos$precio/cambio), tot_inmos$precio)
        tot_inmos$geometry <- NULL
        inmos_ven <- tot_inmos %>% filter(venta_alquiler == "Venta" & tipoPropiedad != "Propiedad rural")
        inmos_alq <- tot_inmos %>% filter(venta_alquiler %in% c("Alquiler", "Alquiler temporal") & tipoPropiedad != "Propiedad rural")
        
        vars$user_inmos_act <- tot_inmos %>% group_by(user) %>% summarize(tot_inmos_act = n())
        vars$user_valor_inmos <- tot_inmos %>% group_by(user) %>% summarize(tot_volor_inmos = round(sum(precio)))
        vars$user_ticket_ven <- inmos_ven %>% group_by(user) %>% summarize(tot_ticket_ven = ifelse(n() != 0, round(sum(precio)/n()), 0))
        vars$user_ticket_alq <- inmos_alq %>% group_by(user) %>% summarize(tot_ticket_alq = ifelse(n() != 0, round(sum(precio)/n()), 0))
        
        nro_asesores <- vars$office_agen_all_pages %>% filter(cargo == "Asesor") %>%
          mutate(nro_integ = ifelse(is.na(comment), 1,
                                    ifelse(str_detect(str_to_lower(comment), "integ"), as.integer(str_extract(comment, "[0-9]+")), 1)))
        nro_asesores <- sum(nro_asesores$nro_integ)
        
        div(
          br(),
          fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                    tags$div(id = "inline",
                             dateRangeInput("date_range_office_stat", 
                                            "Elija el rango de fechas",
                                            start = as_date(now("America/Asuncion")) - days(day(as_date(now("America/Asuncion")))) + days(1),
                                            end = as_date(now("America/Asuncion")), 
                                            min = "2019-01-01", max = as_date(now("America/Asuncion")), separator = "hasta",
                                            language = "es"),
                             if(input$office_agen_filt_fra != "Global Master Office"){
                               div(
                                 downloadButton("generar_excel_estadisticas", "Generar planilla",
                                                class = "cl_bttn_modal", 
                                                icon = NULL),
                                 br()
                               )
                             },
                             if(vars$user$cargo %in% c("Global Master Office", "Global Office Assistant", "Global Office Manager")){
                               uiOutput("office_stat_details_ui")
                             },
                             
                             h3("Top Gross Commission"),
                             uiOutput("stat_gross_comm_ui"),
                             h3("Top captaciones"),
                             dataTableOutput("table_office_stat_cap_tot"),
                             h3("Top exclusividades"),
                             dataTableOutput("table_office_stat_cap_ex"),
                             h3("Top cierres"),
                             dataTableOutput("table_office_stat_cie"),
                             h3("Top lado captador"),
                             dataTableOutput("table_office_stat_cap_lado"),
                             h3("Top lado colocador"),
                             dataTableOutput("table_office_stat_col_lado"),
                             h3("Plantel de la oficina"),
                             h5(HTML(paste0("<b>Broker Office: </b>", paste0(vars$office_agen_all_pages$name[vars$office_agen_all_pages$cargo == "Broker Office"], collapse = ", ")))),
                             h5(HTML(paste0("<b>Broker Manager: </b>", paste0(vars$office_agen_all_pages$name[vars$office_agen_all_pages$cargo == "Broker Manager"], collapse = ", ")))),
                             h5(HTML(paste0("<b>Broker Assistant: </b>", paste0(vars$office_agen_all_pages$name[vars$office_agen_all_pages$cargo == "Broker Assistant"], collapse = ", ")))),
                             h5(HTML(paste0("<b>Número de asesores: </b>", nro_asesores))),
                             h5(HTML(paste0("<b>Propiedades activas: </b>", nrow(tot_inmos)))),
                             h5(HTML(paste0("<b>Valor total de propiedades: </b>USD ", format(round(sum(tot_inmos$precio)), big.mark = ".", decimal.mark = ",", scientific = FALSE)))),
                             h5(HTML(paste0("<b>Ticket promedio venta: </b>USD ", ifelse(nrow(inmos_ven) == 0, 0, 
                                                                                         format(round(sum(inmos_ven$precio)/nrow(inmos_ven)), big.mark = ".", decimal.mark = ",", scientific = FALSE))))),
                             h5(HTML(paste0("<b>Ticket promedio alquiler: </b>USD ", ifelse(nrow(inmos_alq) == 0, 0, 
                                                                                            format(round(sum(inmos_alq$precio)/nrow(inmos_alq)), big.mark = ".", decimal.mark = ",", scientific = FALSE)))))
                    )
          )
        )
      }
    }
  })
  
  output$stat_gross_comm_ui <- renderUI({
    req(vars$user_tot_prod)
    
    agentes <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$user_tot_prod$user) %>%
      select(name, user, agencia, img) %>% mutate(oficina = sapply(agencia, 
                                                                   FUN = function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                                     agencia_name(x, agencias, franquicias)
                                                                   }))
    user_tot_prod <- left_join(vars$user_tot_prod, agentes, by = "user")
    print("podio Top Gross Com")
    print(user_tot_prod)
    
    
    podio_topGrass <- create_podio_est("asesor", "topGross", "Top Gross Commission", vars$user$user, 
                                       user_tot_prod$name, user_tot_prod$img, 
                                       user_tot_prod$oficina, user_tot_prod$tot_gross_com, dir, session)
    
    print("link podio Top Gross")
    print(podio_topGrass)
    
    if(is.na(podio_topGrass)){
      dataTableOutput("table_office_stat_prod")
    }else{
      fluidRow(
        column(4,
               a(href = podio_topGrass, target = "_blank",
                 actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:300px; height: 240px; margin: 0px;
                                                             background-image: url("', podio_topGrass, '");
                                                             background-size: cover, 300px 240px;
                                                             border-radius: 10px')))
        ),
        column(8,
               dataTableOutput("table_office_stat_prod")
        )
      )
    }
  })
  
  
  
  output$generar_excel_estadisticas <- downloadHandler(
    filename <- function(){
      paste0("estadistica_", input$date_range_office_stat[1], "_", input$date_range_office_stat[2], ".csv")
    },
    content = function(file) {
      
      agentes <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$office_agen_stat$user) %>%
        select(name, user, agencia, comision) %>% mutate(oficina = sapply(agencia, 
                                                                          function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                                            agencia_name(x, agencias, franquicias)
                                                                          })) %>% 
        select(name, user, oficina, comision)
      
      print("data egentes")
      print(data)
      data <- data.frame(nombre = agentes$name, user = agentes$user, oficina = agentes$oficina, comision = agentes$comision)
      data <- left_join(data, vars$user_tot_prod %>% select(user, gross_commission = tot_gross_com), by = "user")
      data <- left_join(data, vars$user_tot_cie %>% select(user, cierres = tot_cie), by = "user")
      data <- left_join(data, vars$user_tot_cap_lado %>% select(user, lado_captador = tot_cap_lado), by = "user")
      data <- left_join(data, vars$user_tot_col_lado %>% select(user, lado_colocador = tot_col_lado), by = "user")
      data <- left_join(data, vars$user_tot_cap_tot %>% select(user, captaciones = tot_cap_tot), by = "user")
      data <- left_join(data, vars$user_tot_cap_ex %>% select(user, exclusividades = tot_cap_ex), by = "user")
      data <- left_join(data, vars$user_inmos_act %>% select(user, prop_activas = tot_inmos_act), by = "user")
      data <- left_join(data, vars$user_valor_inmos %>% select(user, valor_prop = tot_volor_inmos), by = "user")
      data <- left_join(data, vars$user_ticket_ven %>% select(user, ticket_prom_venta = tot_ticket_ven), by = "user")
      data <- left_join(data, vars$user_ticket_alq %>% select(user, ticket_prom_alquiler = tot_ticket_alq), by = "user")
      data[is.na(data)] <- 0
      data <- format(data, scientific = FALSE)
      print("Estadisticas oficina")
      print(data)
      write_excel_csv2(data, file)
    }
  )
  
  observeEvent(input$new_evento, {
    if(!is.null(vars$show_evento)){
      hora_ini <- str_split(vars$show_evento$hora_ini, ":")[[1]][1]
      min_ini <- str_split(vars$show_evento$hora_ini, ":")[[1]][2]
      hora_fin <- str_split(vars$show_evento$hora_fin, ":")[[1]][1]
      min_fin <- str_split(vars$show_evento$hora_fin, ":")[[1]][2]
    }else{
      hora_ini <- NULL
      min_ini <- NULL
      hora_fin <- NULL
      min_fin <- NULL
    }
    showModal(modalDialog(
      div(id = "inline",
          dateInput("even_fecha", "Fecha", language = "es", value = vars$show_evento$fecha_agendada),
          div(
            "Hora de inicio ",
            div(selectInput("even_hora_ini", NULL, choices = c("00", "01", "02", "03", "04", "05", "06",
                                                               "07", "08", "09", "10", "11", "12",
                                                               "13", "14", "15", "16", "17", "18",
                                                               "19", "20", "21", "22", "23"),
                            selected = hora_ini), style = "width: 60px",
                class = "btn-group"),
            div(selectInput("even_min_ini", NULL, choices = c("00", "30"), selected = min_ini), style = "width: 60px",
                class = "btn-group"),
          ),
          div(
            "Hora de término",
            div(selectInput("even_hora_fin", NULL, choices = c("00", "01", "02", "03", "04", "05", "06",
                                                               "07", "08", "09", "10", "11", "12",
                                                               "13", "14", "15", "16", "17", "18",
                                                               "19", "20", "21", "22", "23"),
                            selected = hora_fin), style = "width: 60px",
                class = "btn-group"),
            div(selectInput("even_min_fin", NULL, choices = c("00", "30"), selected = min_fin), style = "width: 60px",
                class = "btn-group"),
          ),
          textInput("even_titulo", "Encabezado", value = vars$show_evento$titulo),
          textAreaInput("even_comment", "Descripción", value = vars$show_evento$comment)
      ),
      div(id = "icon_info",
          actionButton("delete_evento", NULL, icon("trash-alt"), 
                       style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px"),
          div(class = "icon_label", h5("eliminar"))
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("new_evento_ok", "Agregar"),
               actionBttn("close_new_evento", "Cancelar"),
               align = "center"),
      title = "Agregar nuevo evento",
      easyClose = FALSE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$close_new_evento, {
    vars$show_evento <- NULL
    removeModal()
  })
  
  observeEvent(input$new_evento_ok, {
    new_evento <- data.frame(
      id = new_id_table_mysql("id", paste0(co, "_eventos"), "evento_", 12),
      fecha = as.character(now("America/Asuncion")),
      fecha_agendada = input$even_fecha,
      hora_ini = paste0(input$even_hora_ini, ":", input$even_min_ini, ":00"),
      hora_fin = paste0(input$even_hora_fin, ":", input$even_min_fin, ":00"),
      user = vars$user$user,
      titulo = input$even_titulo,
      comment = input$even_comment
    )
    if(!is.null(vars$show_evento)){
      new_evento$id <- vars$show_evento$id
      del_var_table_mysql("id", vars$show_evento$id, paste0(co, "_eventos"))
    }
    save_mysql(new_evento, paste0(co, "_eventos"), FALSE)
    vars$eventos <- generate_eventos()
    vars$new_eve <- list_table_var_mysql(paste0(co, "_eventos"), "fecha_agendada", as.character(as_date(now("America/Asuncion")))) %>% nrow()
    vars$show_evento <- NULL
    removeModal()
  })
  
  observeEvent(input$delete_evento, {
    del_var_table_mysql("id", vars$show_evento$id, paste0(co, "_eventos"))
    vars$eventos <- generate_eventos()
    vars$new_eve <- list_table_var_mysql(paste0(co, "_eventos"), "fecha_agendada", as.character(as_date(now("America/Asuncion")))) %>% nrow()
    vars$show_evento <- NULL
    removeModal()
  })
  
  output$eventos_bttn_ui <- renderUI({
    if(vars$start == FALSE){
      req(vars$new_eve)
      div(
        if(vars$new_eve > 0){
          div(style = "height: 14px; width: 14px; border-radius: 7px; background-color: red; color: white;
            position: absolute; margin-left: 22px; margin-top: 6px; padding: 0px", align = "center",
              h5(vars$new_eve, style = "margin-top: 1px; margin-left: -1px; font-size: 80%")
          )
        },
        actionButton("eventos_on_off", NULL, icon = icon("globe"), style = "padding: 8px; background-color: transparent;
                                                                      border-color: transparent; color: white;
                                                                      font-size: 160%; margin-right: 20px")
      )
    }
  })
  
  observeEvent(input$eventos_on_off, {
    if(eventos_on() == 0){
      vars$eventos <- generate_eventos()
      eventos_on(1)
    }else{
      eventos_on(0)
    }
  })
  
  output$box_eventos_ui <- renderUI({
    if(eventos_on() == 1){
      vars$show_evento <- NULL
      div(
        fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                  if(permiso("agregar eventos", NA, vars$permisos_acc, vars$permisos_men) | vars$user$cargo == "Global Master Office"){
                    tags$div(id="bttn_modal", style = "margin: 20px",
                             actionBttn("new_evento", "Nuevo evento")
                    )
                  },
                  calendarOutput("eventos_ui")
        ),
        br()
      )
    }
  })
  
  output$eventos_ui <- renderCalendar({
    calendar(view = "week", navigation = TRUE, navOpts = navigation_options(today_label = "Hoy", color = main_color)) %>% cal_schedules(vars$eventos)
  })
  
  observeEvent(input$eventos_ui_click, {
    id_evento <- input$eventos_ui_click$calendarId
    print(id_evento)
    evento <- list_table_var_mysql(paste0(co, "_eventos"), "id", id_evento)
    if(evento$user == vars$user$user){
      vars$show_evento <- evento
      print(vars$show_evento)
      click("new_evento")
    }
  })
  
  observeEvent(input$crear_agente,{
    isolate({
      cargos <- cargos_levels[cargos_levels < vars$user$cargo]
      agencias <- load_mysql(paste0(co, "_agencias_data"))
      franquicias <- load_mysql(paste0(co, "_franquicias_data"))
      all_agencias <- c(agencias$name, franquicias$name)
      agencia_user <- agencias[agencias$id == vars$user$agencia,]
      agencia_user <- agencia_user$name
      print("all_agencias")
      print(all_agencias)
      print(vars$user$cargo)
      #("Global Master Office", "Global Office Manager", "Global Office Asistant", "Country Master Office",
      #  "Country Office Manager", "Country Office Asistant", "Broker Office", "Broker Manager",
      #  "Broker Asistant", "Asesor")
      if(vars$user$cargo %in% c("Global Master Office", "Global Office Manager", "Global Office Assistant")){
        agencia_name <- all_agencias
      }else{
        if(vars$user$cargo %in% c("Broker Manager", "Broker Assistant")){
          agencia_name <- agencia_user
        }
      }
      
      vars$new_agente <- TRUE
      vars$new_agencia <- FALSE
      vars$new_franquicia <- FALSE
      if(vars$image_perfil_new == FALSE) 
        vars$foto_perfil <- NA
    })
    showModal(modalDialog(
      fluidRow(style = "padding:0px",
               column(6,
                      uiOutput("image_perfil"),
                      div(id = "inline",
                          fileInput(inputId = "upload_perfil",
                                    label = NULL,
                                    buttonLabel = "Subir foto",
                                    placeholder = "no hay fotos",
                                    accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
                          align = "center"),
                      div(id = "inline",
                          textInput("reg_face", "Facebook"),
                          textInput("reg_insta", "Instagram")
                      )
               ),
               column(6,
                      tags$div(id = "inline",
                               textInput("reg_name", "Nombre y Apellido"),
                               uiOutput("reg_teams_list_ui"),
                               textInput("reg_user", "Correo electrónico"),
                               dateInput("reg_birthday", "Fecha de nacimiento", language = "es", value = ""),
                               fluidRow(
                                 column(7, selectInput("phone_code", "País", choices = phone_codes$name), style = "padding-right: 0px"),
                                 column(5, textInput("reg_phone", "Teléfono"), style = "padding-left: 0px")
                               ),
                               selectInput("reg_agencia", "Oficina a la que pertenece", choices = agencia_name),
                               selectInput("reg_cargo", "Cargo", choices = cargos),
                               uiOutput("reg_comision_ui"),
                               textAreaInput("reg_comment", "Descripción")
                      )
               )
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionButton("crear_agente_ok", "Registrar"),
               actionButton("close_modal", "Cancelar"),
               align = "center"),
      title = "Registrar Usuario",
      easyClose = FALSE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  output$reg_teams_list_ui <- renderUI({
    req(input$reg_name)
    if(str_detect(str_to_lower(input$reg_name), "^team")){
      agentes <- query_mysql(paste0("SELECT name FROM myplace_usuarios WHERE company = '", co, "' AND (name LIKE 'Team%' OR
                                    name LIKE 'team%')")) %>% arrange(name)
      h5(paste0(agentes$name, collapse = ", "))
    }else{
      div()
    }
  })
  
  output$reg_comision_ui <- renderUI({
    req(input$reg_cargo)
    if(input$reg_cargo == "Asesor"){
      selectInput("reg_comision", "Comisiones", 
                  choices = c("Asesor Junior - 60%",
                              "Asesor Senior - 70%",
                              "Asesor Elite - 80%"))
    }
  })
  
  observeEvent(input$crear_agente_ok, {
    if("" %in% c(input$reg_user, input$reg_pass1, input$reg_pass2, input$reg_phone, input$reg_inmo)){
      shinyalert(
        type = "error",
        title = "Campos sin completar"
      )
    }else{
      if(is.na(vars$foto_perfil)){
        shinyalert(
          type = "error",
          title = "Debe agregar una foto de perfil al asesor"
        )
      }else{
        agente <- list_table_var_mysql("myplace_usuarios", "user", str_squish(isolate(input$reg_user)))
        if(nrow(agente) != 0 && agente$company == co){
          shinyalert(
            type = "error",
            title = "Correo electrónico ya registrado"
          )
        }else{
          if(str_detect(input$reg_user, "\\+") & !str_detect(input$reg_user, "gmayeregger")){
            shinyalert(
              type = "error",
              title = "El correo no puede contener el simbolo +"
            )
          }else{
            if(!(str_detect(input$reg_user, "@") & str_detect(input$reg_user, "\\."))){
              shinyalert(
                type = "error",
                title = "El correo electrónico ingresado no es válido"
              )
            }else{
              comision <- ifelse(!is.null(input$reg_comision) && input$reg_cargo == "Asesor", input$reg_comision, NA)
              
              agencias <- load_mysql(paste0(co, "_agencias_data"))
              franquicias <- load_mysql(paste0(co, "_franquicias_data"))
              if(input$reg_agencia %in% agencias$name){
                agencia_id <- agencias$id[agencias$name == input$reg_agencia]
              }else{
                agencia_id <- franquicias$id[franquicias$name == input$reg_agencia]
              }
              user <- str_squish(str_to_lower(isolate(input$reg_user)))
              serie <- round(runif(1, min=10, max=99))
              img <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/avatar-users/", user, "-", serie, "-small.jpg")
              put_object_do(paste0("/avatar-users/", user, "-", serie, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_perfil.jpg")))
              put_object_do(paste0("/avatar-users/", user, "-", serie, "-small.jpg"), file.path(dir, paste0(session$token, "temp_foto_perfil_small.jpg")))
              
              if(exist_var_table_mysql(user, "user", "myplace_usuarios")){
                del_var_table_mysql("user", user, "myplace_usuarios")
              }
              
              new_user <- data.frame(id = new_id_table_mysql("id", "myplace_usuarios", "user_", 12),
                                     date = as.character(now("America/Asuncion")),
                                     user = user,
                                     company = co,
                                     date_create = as.character(now("America/Asuncion")),
                                     name = str_squish(strtrim(isolate(input$reg_name), 30)), 
                                     pass = digest("skyone123"),
                                     phone = paste0(phone_codes$code[phone_codes$name == input$phone_code], str_remove_all(str_remove(input$reg_phone, "^0"), " ")),
                                     face = input$reg_face,
                                     insta = input$reg_insta,
                                     empresa = empresa,
                                     empresa_id = user,
                                     ruc = NA,
                                     razon = NA,
                                     documento = NA,
                                     mail_facturacion = user,
                                     img = img,
                                     birthday = ifelse(length(input$reg_birthday) == 0, "", as.character(input$reg_birthday)),
                                     agencia = agencia_id,
                                     admin = 0,
                                     cargo = isolate(input$reg_cargo),
                                     comision = comision,
                                     comment = input$reg_comment,
                                     link = NA,
                                     activo = "si"
              )
              print("new_user")
              print(new_user)
              save_mysql(new_user, "myplace_usuarios", FALSE)
              
              #Crear usuario en Place
              
              new_cuenta <- list_table_var_mysql("cuentas2", "cuenta", new_user$user)
              fecha <- as_date(now("America/Asuncion")) + months(1)
              venci <- paste0(paste(fecha <- c(str_split(fecha, "-")[[1]][1:2], "01"), collapse = "-"), " 00:00:00")
              if(nrow(new_cuenta) == 0){
                cuentas <- data.frame(id = new_id_table_mysql("id", "cuentas2", "cuenta_", 10),
                                      date = as.character(now("America/Asuncion")),
                                      date_create = as.character(now("America/Asuncion")),
                                      cuenta = new_user$user,
                                      lim_user = 10,
                                      lim_user_fotos = 100,
                                      lim_cuenta = 100,
                                      lim_cuenta_fotos = 100,
                                      saldo = 0,
                                      saldo_fotos = 0,
                                      tipo = "personal",
                                      myplace_activo = "si",
                                      myplace_date_create = as.character(now("America/Asuncion")),
                                      myplace_fecha_pago = as.character(now("America/Asuncion")),
                                      myplace_fecha_vencimiento = venci,
                                      myplace_fecha_acreditacion = NA,
                                      myplace_plan = "Plan MyPlace Basic",
                                      myplace_lim_users = 0,
                                      myplace_saldo_avaluos = 10,
                                      myplace_saldo_fotos = 50,
                                      myplace_anual = "no")
                save_mysql(cuentas, "cuentas2", FALSE)
              }else{
                update_var_table_mysql("si", "myplace_activo", "id", new_cuenta$id, "cuentas2")
                
                if(is.na(new_cuenta$myplace_date_create)){
                  update_var_table_mysql(as.character(now("America/Asuncion")), "myplace_date_create", "id", new_cuenta$id, "cuentas2")
                }
                update_var_table_mysql(as.character(now("America/Asuncion")), "myplace_fecha_pago", "id", new_cuenta$id, "cuentas2")
                update_var_table_mysql(venci, "myplace_fecha_vencimiento", "id", new_cuenta$id, "cuentas2")
                update_var_table_mysql("Plan MyPlace Basic", "myplace_plan", "id", new_cuenta$id, "cuentas2")
                update_var_table_mysql(10, "myplace_saldo_avaluos", "id", new_cuenta$id, "cuentas2")
                update_var_table_mysql(50, "myplace_saldo_fotos", "id", new_cuenta$id, "cuentas2")
                update_var_table_mysql("no", "myplace_anual", "id", new_cuenta$id, "cuentas2")
                update_var_table_mysql(0, "myplace_lim_users", "id", new_cuenta$id, "cuentas2")
                update_var_table_mysql(as.character(now("America/Asuncion")), "date", "cuenta", new_cuenta$id, "cuentas2")
              }
              
              cuen_users <- list_table_var_mysql("cuentas_user", "cuenta", new_user$user)
              if(nrow(cuen_users) != 0){
                new_cuen_id <- cuen_users$id[cuen_users$cuenta == cuen_users$user]
                update_var_table_mysql(1, "activo", "id", new_cuen_id, "cuentas_user")
              }else{
                cuentas_user <- data.frame(id = new_id_table_mysql("id", "cuentas_user", "cueuser_", 10),
                                           cuenta = new_user$user,
                                           user = new_user$user,
                                           activo = 1)
                save_mysql(cuentas_user, "cuentas_user", FALSE)
              }  
              
              vars$foto_perfil <- NA
              vars$new_agente <- FALSE
              vars$image_perfil_new <- FALSE
              
              create_folder_do(paste0("/", co, "/minube/", new_user$user, "/"))
              
              vars$office_agen_all <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "agencia", vars$user$agencia) %>% arrange(desc(cargo))
              vars$office_agen_all_pages <- vars$office_agen_all
              vars$permisos_men <- permisos_menores(vars$user)
              removeModal()
            }
          }
        }
      }
    }
  })
  
  refresh_office_agen <- reactiveVal(0)
  
  observe({
    refresh_office_agen()
    if(office_agen_on() == 1){
      req(input$office_agen_filt_fra, input$office_agen_filt_ofi)
      
      if(input$office_agen_filt_fra == "Global Master Office"){
        id_agencia <- "Global Master Office"
        users_stat <- list_table_var_mysql("myplace_usuarios", "company", co) %>% arrange(desc(cargo))
      }else{
        id_franquicia <- vars$franquicias$id[vars$franquicias$name == input$office_agen_filt_fra]
        if(input$office_agen_filt_ofi == "Todas"){
          id_agencia <- vars$agencias$id[vars$agencias$master == id_franquicia]
        }else{
          id_agencia <- vars$agencias$id[vars$agencias$name == input$office_agen_filt_ofi]
        }
        users_stat <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "agencia", c(id_franquicia, id_agencia))
        if(input$office_agen_filt_ofi == "Todas"){
          id_agencia <- id_franquicia
        }
      }
      
      open_office_agen$boxes<- list()
      open_office_agen$observers <- list()
      all_pages <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "agencia", id_agencia)
      vars$office_agen_all_pages <- all_pages
      
      if(vars$user$cargo != "Asesor"){
        vars$office_agen_stat <- users_stat %>% arrange(desc(cargo))
        office_stat_on(1)
      }else{
        vars$office_agen_stat <- data.frame()
        office_stat_on(0)
      }
      
      if(nrow(all_pages) > 0){
        if(input$office_agen_filt_name != ""){
          palabras <- str_split(input$office_agen_filt_name, " ")[[1]]
          palabras <- palabras[palabras != ""]
          print(palabras)
          busc <- c()
          for(i in 1:length(palabras)){
            busc <- c(busc, str_detect(str_to_lower(all_pages$name), str_to_lower(palabras[i])))
          }
          m <- matrix(busc, nrow(all_pages), length(palabras))*1
          print(m)
          ind <- which(apply(m, 1, prod) == 1)
          if(length(ind) != 0){
            open_office_agen$boxes<- list()
            open_office_agen$observers <- list()
            vars$office_agen_all_pages <- all_pages[ind,]
          }
        }else{
          vars$office_agen_all_pages <- all_pages
        }
      }else{
        vars$office_agen_all_pages <- all_pages
      }
    }
  })
  
  
  observe({
    if(office_stat_on() == 1){
      req(vars$office_agen_stat, input$date_range_office_stat)
      
      transa <- list_table_var_mysql(paste0(co, "_transacciones"), "user", vars$office_agen_stat$user)
      transa <- transa %>% filter(!user %in% c("gmayeregger@gmail.com", "daniel.ortiz@skyone.group") &
                                    fecha >= input$date_range_office_stat[1] & fecha <= input$date_range_office_stat[2])
      cambio <- cambio_dolar$venta
      transa <- transa %>% mutate(precio = ifelse(moneda == "GS", round(precio_cierre/cambio), precio_cierre))
      transa <- transa %>% mutate(comision_cobrada = ifelse(moneda == "GS", round(comision_cobrada/cambio), comision_cobrada))
      #regalias <- transa %>% mutate(regalias = ifelse(tipo == "Pago comisión a Global", round(0.10*comision_cobrada), 0))
      
      regalias <- transa %>% mutate(regalias = ifelse(fase > 4 & tipo %in% c("captación", "colocación"), round(comision_cobrada*0.10), 0))
      
      transa <- transa %>% mutate(gross_com = ifelse(fase > 4 & tipo %in% c("captación", "colocación"), comision_cobrada, 0))
      lore_alfre <- transa %>% filter(user == "dclorenayalfredo@gmail.com")
      print("lore_alfre")
      print(lore_alfre)
      vars$user_tot_prod <- transa %>% group_by(user) %>% summarize(tot_gross_com = sum(gross_com)) %>% arrange(desc(tot_gross_com))
      print(vars$user_tot_prod)
      
      vars$office_tot_prod <- transa %>% group_by(id_agencia) %>% summarize(tot_gross_com = sum(gross_com)) %>% arrange(desc(tot_gross_com))
      print(vars$office_tot_prod)
      
      vars$office_tot_rega <- regalias %>% group_by(id_agencia) %>% summarize(tot_regalias = sum(regalias)) %>% arrange(desc(tot_regalias))
      print(vars$office_tot_rega)
      
      vars$user_tot_col_lado <- transa %>% filter(tipo %in% c("colocación")) %>% group_by(user) %>% summarize(tot_col_lado = n()) %>% arrange(desc(tot_col_lado))
      print(vars$user_tot_col_lado)
      
      vars$office_tot_col_lado <- transa %>% filter(tipo %in% c("colocación")) %>% group_by(id_agencia) %>% summarize(tot_col_lado = n()) %>% arrange(desc(tot_col_lado))
      print(vars$office_tot_col_lado)
      
      vars$user_tot_cap_lado <- transa %>% filter(tipo %in% c("captación")) %>% group_by(user) %>% summarize(tot_cap_lado = n()) %>% arrange(desc(tot_cap_lado))
      print(vars$user_tot_cap_lado)
      
      vars$office_tot_cap_lado <- transa %>% filter(tipo %in% c("captación")) %>% group_by(id_agencia) %>% summarize(tot_cap_lado = n()) %>% arrange(desc(tot_cap_lado))
      print(vars$office_tot_cap_lado)
      
      vars$user_tot_cie <- transa %>% filter(tipo %in% c("colocación", "captación")) %>% group_by(user) %>% summarize(tot_cie = n()) %>% arrange(desc(tot_cie))
      print(vars$user_tot_cie)
      
      vars$office_tot_cie <- transa %>% filter(tipo %in% c("colocación", "captación")) %>% group_by(id_agencia) %>% summarize(tot_cie = n()) %>% arrange(desc(tot_cie))
      print(vars$office_tot_cie)
      
      #agentes <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "agencia", "agencia_0000000001")
      agentes <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$office_agen_stat$user)
      agentes2 <- agentes %>% 
        mutate(nro_integ = ifelse(is.na(comment), 1,
          ifelse(str_detect(str_to_lower(comment), "integ"), as.integer(str_extract(comment, "[0-9]+")), 1))) %>%
        filter(!user %in% c("gmayeregger@gmail.com", "daniel.ortiz@skyone.group") &
                                       date_create >= input$date_range_office_stat[1] & date_create <= input$date_range_office_stat[2])
      
      vars$office_tot_recl <- agentes2 %>% group_by(agencia) %>% summarize(tot_recl = sum(nro_integ)) %>% arrange(desc(tot_recl))
      print(vars$office_tot_recl)
      
      office_tot_agen <- agentes %>% 
        mutate(nro_integ = ifelse(is.na(comment), 1,
                                  ifelse(str_detect(str_to_lower(comment), "integ"), as.integer(str_extract(comment, "[0-9]+")), 1))) %>%
        group_by(agencia) %>% summarize(tot_agen = sum(nro_integ)) %>% arrange(desc(tot_agen))
      vars$office_tot_agen <- office_tot_agen[!is.na(office_tot_agen$tot_agen),]
      print("total asesores")
      print(vars$office_tot_agen)
      
      
      #Captacion total y exclusividades
      inmos <- list_table_var1_var2_mysql("myplace_inmuebles", "user", vars$office_agen_stat$user, "externa", "no")
      inmos$geometry <- NULL
      inmos_full <- inmos %>% filter(borrador == "no" & activo == "si")
      inmos_full <- inmos_full %>% mutate(fecha = ifelse(tipo_contrato == "Exclusividad",
                                                         ini_contrato,
                                                         ifelse(is.na(fecha_aprobacion), fecha_creacion, fecha_aprobacion)),
                                          nro_catas = ifelse(str_count(catastro, ",") > 0,
                                                             str_count(catastro, ",") + 1,
                                                             1)
                                          ) %>%
        filter(fecha >= input$date_range_office_stat[1] & fecha <= input$date_range_office_stat[2])
      vars$user_tot_cap_ex <- inmos_full %>% filter(tipo_contrato == "Exclusividad") %>%
        group_by(user) %>% summarize(tot_cap_ex = sum(nro_catas)) %>% arrange(desc(tot_cap_ex))
      vars$user_tot_cap_tot <- inmos_full %>% 
        group_by(user) %>% summarize(tot_cap_tot = sum(nro_catas)) %>% arrange(desc(tot_cap_tot))
      print(vars$user_tot_cap_ex)
      print(vars$user_tot_cap_tot)
      
      agen <- list_table_var_mysql("myplace_usuarios", "company", co) %>% select(user, agencia)
      cap_gen_ex <- left_join(vars$user_tot_cap_ex, agen, by = "user")
      vars$office_tot_cap_ex <- cap_gen_ex %>% group_by(agencia) %>% summarize(tot_cap_ex = sum(tot_cap_ex)) %>% arrange(desc(tot_cap_ex))
      print(vars$office_tot_cap_ex)
      cap_gen_tot <- left_join(vars$user_tot_cap_tot, agen, by = "user")
      vars$office_tot_cap_tot <- cap_gen_tot %>% group_by(agencia) %>% summarize(tot_cap_tot = sum(tot_cap_tot)) %>% arrange(desc(tot_cap_tot))
      print(vars$office_tot_cap_tot)
      
      #sk1
      sk1_regalias <- vars$office_tot_rega %>% select(agencia = id_agencia, regalias = tot_regalias)
      sk1_captaciones <- vars$office_tot_cap_ex %>% select(agencia, captaciones = tot_cap_ex)
      sk1_reclutamientos <- vars$office_tot_recl %>% select(agencia, reclutamientos = tot_recl)
      
      tot_sk1 <- left_join(sk1_regalias, sk1_captaciones, by = "agencia")
      tot_sk1 <- left_join(tot_sk1, sk1_reclutamientos, by = "agencia")
      
      print("sk1 antes")
      print(tot_sk1)
      #tot_sk1 <- data.frame(agencia = c("agencia_0000000007", "agencia_0000000001"))
      vars$office_tot_sk1 <- tot_sk1  %>% 
        mutate(oficina = sapply(agencia, 
                                FUN = function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                  agencia_name(x, agencias, franquicias)
                                }),
               broker_name = sapply(agencia, 
                                FUN = function(x, agencias = vars$agencias){  
                                  broker <- agencias$mail[agencias$id == x]
                                  broker <- list_table_var_mysql("myplace_usuarios", "user", broker)
                                  broker$name
                                }),
               broker_img = sapply(agencia, 
                                    FUN = function(x, agencias = vars$agencias){  
                                      broker <- agencias$mail[agencias$id == x]
                                      broker <- list_table_var_mysql("myplace_usuarios", "user", broker)
                                      broker$img
                                    }),
               sk1 = round(0.40*regalias/600 + 0.30*captaciones/18 + 0.30*reclutamientos/1.3, 2)) %>% 
        arrange(desc(sk1))
      print("sk1 despues")
      print(vars$office_tot_sk1)
      
    }
  })
  
  
  output$table_office_stat_prod <- renderDataTable({
    req(vars$user_tot_prod)

    agentes <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$user_tot_prod$user) %>%
      select(name, user, agencia) %>% mutate(oficina = lapply(agencia, 
                                                                   function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                                     agencia_name(x, agencias, franquicias)
                                                                   }))
    dat <- left_join(vars$user_tot_prod, agentes, by = "user") %>% mutate(total = paste0("USD ", tot_gross_com)) %>% 
      select(Asesor = name, Oficina = oficina, Comisión = total)
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_cap_tot <- renderDataTable({
    req(vars$user_tot_cap_tot)
    agentes <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$user_tot_cap_tot$user) %>%
      select(name, user, agencia) %>% mutate(oficina = lapply(agencia, 
                                                              function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                                agencia_name(x, agencias, franquicias)
                                                              }))
    dat <- left_join(vars$user_tot_cap_tot, agentes, by = "user") %>% mutate(total = as.character(tot_cap_tot)) %>% 
      select(Asesor = name, Oficina = oficina, Captaciones = total)
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_cap_ex <- renderDataTable({
    req(vars$user_tot_cap_ex)
    agentes <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$user_tot_cap_ex$user) %>%
      select(name, user, agencia) %>% mutate(oficina = lapply(agencia, 
                                                              function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                                agencia_name(x, agencias, franquicias)
                                                              }))
    dat <- left_join(vars$user_tot_cap_ex, agentes, by = "user") %>% mutate(total = as.character(tot_cap_ex)) %>% 
      select(Asesor = name, Oficina = oficina, Exclusividades = total)
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_cie <- renderDataTable({
    req(vars$user_tot_cie)
    agentes <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$user_tot_cie$user) %>%
      select(name, user, agencia) %>% mutate(oficina = lapply(agencia, 
                                                              function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                                agencia_name(x, agencias, franquicias)
                                                              }))
    dat <- left_join(vars$user_tot_cie, agentes, by = "user") %>% mutate(total = as.character(tot_cie)) %>% 
      select(Asesor = name, Oficina = oficina, Cierres = total)
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_cap_lado <- renderDataTable({
    req(vars$user_tot_cap_lado)
    agentes <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$user_tot_cap_lado$user) %>%
      select(name, user, agencia) %>% mutate(oficina = lapply(agencia, 
                                                              function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                                agencia_name(x, agencias, franquicias)
                                                              }))
    dat <- left_join(vars$user_tot_cap_lado, agentes, by = "user") %>% mutate(total = as.character(tot_cap_lado)) %>% 
      select(Asesor = name, Oficina = oficina, Lado_captador = total)
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_col_lado <- renderDataTable({
    req(vars$user_tot_col_lado)
    agentes <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$user_tot_col_lado$user) %>%
      select(name, user, agencia) %>% mutate(oficina = lapply(agencia, 
                                                              function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                                agencia_name(x, agencias, franquicias)
                                                              }))
    dat <- left_join(vars$user_tot_col_lado, agentes, by = "user") %>% mutate(total = as.character(tot_col_lado)) %>% 
      select(Asesor = name, Oficina = oficina, Lado_colocador = total)
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$office_stat_details_ui <- renderUI({
    req(vars$office_tot_prod, vars$office_tot_cap_ex, vars$office_tot_cap_tot,
        vars$office_tot_col_lado, vars$office_tot_cap_lado, vars$office_tot_cie, 
        vars$office_tot_recl, vars$office_tot_sk1)
    podio_sk1 <- create_podio_est("oficina", "sk1", "Top Oficinas", vars$user$user, 
                                  vars$office_tot_sk1$broker_name, vars$office_tot_sk1$broker_img, 
                                  vars$office_tot_sk1$oficina, vars$office_tot_sk1$sk1, dir, session)

    div(
      h3("SK1"),
      if(is.na(podio_sk1)){
        dataTableOutput("table_office_stat_sk1_gen")
      }else{
        fluidRow(
          column(4,
                 a(href = podio_sk1, target = "_blank",
                   actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:300px; height: 240px; margin: 0px;
                                                             background-image: url("', podio_sk1, '");
                                                             background-size: cover, 300px 240px;
                                                             border-radius: 10px')))
          ),
          column(8,
                 dataTableOutput("table_office_stat_sk1_gen")
          )
        )
      },
      h3(paste0("Total regalías: USD ", sum(vars$office_tot_rega$tot_regalias))),
      dataTableOutput("table_office_stat_rega_gen"),
      h3(paste0("Total Gross Commission: USD ", sum(vars$office_tot_prod$tot_gross_com))),
      dataTableOutput("table_office_stat_prod_gen"),
      h3(paste0("Total captaciones: ", sum(vars$office_tot_cap_tot$tot_cap_tot))),
      dataTableOutput("table_office_stat_cap_tot_gen"),
      h3(paste0("Total exclusividades: ", sum(vars$office_tot_cap_ex$tot_cap_ex))),
      dataTableOutput("table_office_stat_cap_ex_gen"),
      h3(paste0("Total cierres: ", sum(vars$office_tot_cie$tot_cie))),
      dataTableOutput("table_office_stat_cie_gen"),
      h3(paste0("Total lado captador: ", sum(vars$office_tot_cap_lado$tot_cap_lado))),
      dataTableOutput("table_office_stat_cap_lado_gen"),
      h3(paste0("Total lado colocador: ", sum(vars$office_tot_col_lado$tot_col_lado))),
      dataTableOutput("table_office_stat_col_lado_gen"),
      h3(paste0("Total reclutamientos: ", sum(vars$office_tot_recl$tot_recl))),
      dataTableOutput("table_office_stat_recl_gen"),
      h3(paste0("Usuarios en la actualidad: ", sum(vars$office_tot_agen$tot_agen))),
      dataTableOutput("table_office_stat_agen_gen")
    )
  })
  
  output$table_office_stat_sk1_gen <- renderDataTable({
    req(vars$office_tot_sk1)
    dat <- vars$office_tot_sk1  %>% 
      select(Oficina = oficina, Regalías = regalias, Captaciones = captaciones, Reclutamientos = reclutamientos, sk1)
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_rega_gen <- renderDataTable({
    req(vars$office_tot_rega)
    dat <- vars$office_tot_rega  %>% mutate(oficina = lapply(id_agencia, 
                                                             function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                               agencia_name(x, agencias, franquicias)
                                                             }),
                                            total = paste0("USD ", tot_regalias)) %>% 
      select(Oficina = oficina, Regalías = total)
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_prod_gen <- renderDataTable({
    req(vars$office_tot_prod)
    dat <- vars$office_tot_prod  %>% mutate(oficina = lapply(id_agencia, 
                                                             function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                               agencia_name(x, agencias, franquicias)
                                                             }),
                                            total = paste0("USD ", tot_gross_com)) %>% 
      select(Oficina = oficina, Comisión = total)
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_cap_tot_gen <- renderDataTable({
    req(vars$office_tot_cap_tot)
    
    dat <- vars$office_tot_cap_tot  %>% mutate(oficina = lapply(agencia, 
                                                                function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                                  agencia_name(x, agencias, franquicias)
                                                                }),
                                               total = as.character(tot_cap_tot)) %>% 
      select(Oficina = oficina, Captaciones = total)
    
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_cap_ex_gen <- renderDataTable({
    req(vars$office_tot_cap_ex)
    
    dat <- vars$office_tot_cap_ex  %>% mutate(oficina = lapply(agencia, 
                                                               function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                                 agencia_name(x, agencias, franquicias)
                                                               }),
                                              total = as.character(tot_cap_ex)) %>% 
      select(Oficina = oficina, Exclusividades = total)
    
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_cie_gen <- renderDataTable({
    req(vars$office_tot_cie)
    
    dat <- vars$office_tot_cie  %>% mutate(oficina = lapply(id_agencia, 
                                                            function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                              agencia_name(x, agencias, franquicias)
                                                            }),
                                           total = as.character(tot_cie)) %>% 
      select(Oficina = oficina, Cierres = total)
    
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_cap_lado_gen <- renderDataTable({
    req(vars$office_tot_cap_lado)
    
    dat <- vars$office_tot_cap_lado  %>% mutate(oficina = lapply(id_agencia, 
                                                                 function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                                   agencia_name(x, agencias, franquicias)
                                                                 }),
                                                total = as.character(tot_cap_lado)) %>% 
      select(Oficina = oficina, Lado_captador = total)
    
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_col_lado_gen <- renderDataTable({
    req(vars$office_tot_col_lado)
    
    dat <- vars$office_tot_col_lado  %>% mutate(oficina = lapply(id_agencia, 
                                                            function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                              agencia_name(x, agencias, franquicias)
                                                            }),
                                           total = as.character(tot_col_lado)) %>% 
      select(Oficina = oficina, Lado_colocador = total)
    
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_recl_gen <- renderDataTable({
    req(vars$office_tot_recl)
    
    dat <- vars$office_tot_recl  %>% mutate(oficina = lapply(agencia, 
                                                             function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                               agencia_name(x, agencias, franquicias)
                                                             }),
                                            total = as.character(tot_recl)) %>% 
      select(Oficina = oficina, Reclutamientos = total)
    
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  output$table_office_stat_agen_gen <- renderDataTable({
    req(vars$office_tot_agen)
    
    dat <- vars$office_tot_agen  %>% mutate(oficina = lapply(agencia, 
                                                             function(x, agencias = vars$agencias, franquicias = vars$franquicias){  
                                                               agencia_name(x, agencias, franquicias)
                                                             }),
                                            total = as.character(tot_agen)) %>% 
      select(Oficina = oficina, Asesores = total)
    
    datatable(dat, 
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 3, dom = 'tp'))
  })
  
  open_office_agen <- reactiveValues(boxes = list(), observers = list())
  
  observe({
    if(office_agen_on() == 1){
      if(nrow(vars$office_agen_all_pages) > 0){
        for(i in 1:nrow(vars$office_agen_all_pages)){
          
          agen <- vars$office_agen_all_pages[i,]
          
          open_office_agen$boxes[[i]] <- div(style = "padding: 10px; display:inline-block", align = "left",
                                             div(
                                               if(!is.na(agen$phone)){
                                                 text_wp <- paste0("https://wa.me/", agen$phone, "?text=", "")
                                                 div(style = "position: absolute; margin-left: 110px; margin-top: 70px",
                                                     if(agen$user != ""){
                                                       div(class = "btn-group",
                                                           a(href= paste0("mailto:", agen$user), target="_blank", 
                                                             actionButton("nada", "" , icon = icon("envelope"),
                                                                          style = paste0("font-size: 150%; padding: 0px; padding-left: 0px; background-color: transparent; border-color: transparent; color: ", 
                                                                                         ifelse(agen$cargo %in% c("Broker Manager", "Broker Office"), "white", "#888888"))))
                                                       )
                                                     },
                                                     if(!is.na(agen$phone)){
                                                       text_wp <- paste0("https://wa.me/", agen$phone, "?text=", "")
                                                       div(class = "btn-group",
                                                           a(href = text_wp, target="_blank", actionButton("nada", NULL , icon = icon("whatsapp"),
                                                                                                           style = paste0("font-size: 150%; padding: 0px; padding-left: 10px;
                                                                                                          background-color: transparent; border-color: transparent; color: ", 
                                                                                                                          ifelse(agen$cargo %in% c("Broker Manager", "Broker Office"), "white", "#888888"))))
                                                       )
                                                     },
                                                     if(!is.na(agen$face)){
                                                       div(class = "btn-group",
                                                           a(href = agen$face, target="_blank", actionButton("nada", NULL , icon = icon("facebook"),
                                                                                                             style = paste0("font-size: 150%; padding: 0px; padding-left: 10px;
                                                                                                          background-color: transparent; border-color: transparent; color: ", 
                                                                                                                            ifelse(agen$cargo %in% c("Broker Manager", "Broker Office"), "white", "#888888"))))
                                                       )
                                                     },
                                                     if(!is.na(agen$insta)){
                                                       div(class = "btn-group",
                                                           a(href = agen$insta, target="_blank", actionButton("nada", NULL , icon = icon("instagram"),
                                                                                                              style = paste0("font-size: 150%; padding: 0px; padding-left: 10px;
                                                                                                          background-color: transparent; border-color: transparent; color: ", 
                                                                                                                             ifelse(agen$cargo %in% c("Broker Manager", "Broker Office"), "white", "#888888"))))
                                                       )
                                                     }
                                                 )
                                               },
                                               div(style = paste0("border-style: solid; border-width: 1px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: ", ifelse(agen$cargo %in% c("Broker Manager", "Broker Office"), main_color, "white"), "; width: 242px; height: 102px;
                                 margin: 0px; padding: 0px"),
                                                   div(style = "width: 125px; height: 70px; position: absolute; margin-top 10px; margin-left: 110px", 
                                                       h4(agen$name, style = paste0("font-size: 140%; font-weight: normal; color: ", 
                                                                                    ifelse(agen$cargo %in% c("Broker Manager", "Broker Office"), "white", "#888888"), "; height: 50px")),
                                                       h4(agen$cargo, style = paste0("font-size: 90%; font-weight: lighter; color: ", 
                                                                                     ifelse(agen$cargo %in% c("Broker Manager", "Broker Office"), "white", "#555555"), "; height: 10px; margin-top: -15px")),
                                                   ),
                                                   div(actionButton(paste0("open_agen_button", i) , NULL, style = paste0('background-color: transparent;
                                                                                                                  border: 0px; width:100px; height: 100px; margin: 0px;
                                                                                                                  background-image: url("', agen$img, '");
                                                                                                                  background-size: cover, 100px 100px;
                                                                                                                  border-radius: 8px 0px 0px 8px')),
                                                   )
                                               )
                                             )
          )
        }
        
        open_office_agen$observers <- lapply(1:nrow(vars$office_agen_all_pages), function(i){
          observeEvent(input[[paste0("open_agen_button", i) ]], ignoreNULL = TRUE, ignoreInit = TRUE, {
            freezeReactiveValue(input, paste0("open_agen_button", i))
            vars$show_agente <- vars$office_agen_all_pages[i,]
            agen <- vars$show_agente
            print(agen)
            
            vars$cliente <- vars$data_per_page[i,]
            clien <- vars$cliente
            inmo_vinc <- list_table_var_mysql(paste0(co, "_estados"), "user", agen$user) %>%
              filter(tipo_cliente != "coordinadora") %>%
              select(id_inmo = id_inmo, tipo_clien = tipo_cliente) %>% arrange(tipo_clien)
            
            vars$list_inmuebles_vinc <- inmo_vinc
            
            modal_agen_description()
          })
        })
      }else{
        open_office_agen$boxes <- list()
      }
    }
  })
  
  output$box_office_agen_list_ui <- renderUI({
    do.call(fluidRow, open_office_agen$boxes)
  })
  
  output$formulario_agen_ui <- renderUI({
    agen <- vars$show_agente
    vars$foto_perfil <- NA
    vars$new_agente <- FALSE
    vars$new_agencia <- FALSE
    vars$new_franquicia <- FALSE
    vars$image_perfil_new <- FALSE
    vars$image_perfil_edit <- TRUE
    vars$foto_perfil <- agen$img
    
    agencia_nam <- agencia_name(agen$agencia, vars$agencias, vars$franquicias)
    
    params <- list(agente = agen, agencia_name = agencia_nam)
    #save(params, file = "params.rda")
    
    
    error <- tryCatch({
      tempReport <- file.path(dir, paste0(session$token, "agent_contact.Rmd"))
      tempHTML <- file.path(dir, paste0(session$token, "temp_agen_web.html"))
      file.copy("agent_contact.Rmd", tempReport, overwrite = TRUE)
      
      
      error_rmd <- tryCatch({
        rmarkdown::render(tempReport, 
                          output_file = tempHTML,
                          params = params,
                          envir = new.env(parent = globalenv()))
      },
      error = function(e){NA}
      )
      if(is.na(error_rmd)){
        print("Error al generar agent_contact.Rmd")
        qr <- NA
      }else{
        file_name <- paste0(co, "/agen-web/", agen$user, ".html")
        put_object_do(paste0("/", file_name), tempHTML)
        agen$link <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", file_name)
        
        tempQR <- file.path(dir, paste0(session$token, "qrplot.png"))
        png(tempQR)
        qrv <- qr_code(agen$link)
        plot(qrv)
        dev.off()
        qr <- dataURI(file = tempQR)
      }
    },
    error = function(e){NA}
    )
    
    if(is.na(error)){
      print("error al crear QR agente")
      dev.off()
      qr <- NA
    }
    
    

    
    div(
      fluidRow(style = "padding:0px",
               column(4,
                      uiOutput("image_perfil"),
                      if(permiso("editar usuarios", agen$user, vars$permisos_acc, vars$permisos_men) | 
                         vars$user$cargo == "Global Master Office" |
                         (vars$user$cargo == "Broker Manager" && !is.null(input$office_agen_filt_ofi) && vars$user$agencia == input$office_agen_filt_ofi) |
                         (vars$user$cargo == "Broker Manager" && vars$user$user == agen$user)){
                        div(id = "inline",
                            fileInput(inputId = "upload_perfil",
                                      label = NULL,
                                      buttonLabel = "Subir foto",
                                      placeholder = "no hay fotos",
                                      accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
                            align = "center")
                      },
                      if(vars$user$user == agen$user | 
                         permiso("editar usuarios", agen$user, vars$permisos_acc, vars$permisos_men) | 
                         vars$user$cargo == "Global Master Office" |
                         (vars$user$cargo == "Broker Manager" && !is.null(input$office_agen_filt_ofi) && vars$user$agencia == input$office_agen_filt_ofi) |
                         (vars$user$cargo == "Broker Manager" && vars$user$user == agen$user)){
                        div(id = "inline",
                            br(), br(),
                            actionButton("estadisticas_agen", "Estadísticas"),
                            br(), br(),
                            align = "center")
                      },
                      if(permiso("editar usuarios", agen$user, vars$permisos_acc, vars$permisos_men) | 
                         vars$user$cargo == "Global Master Office" |
                         (vars$user$cargo == "Broker Manager" && !is.null(input$office_agen_filt_ofi) && vars$user$agencia == input$office_agen_filt_ofi) |
                         (vars$user$cargo == "Broker Manager" && vars$user$user == agen$user)){
                        div(id = "inline",
                            actionButton("reset_pass", "Resetear contraseña"),
                            br(), br(),
                            actionButton("transferir_prop", "Transferir propiedades"),
                            br(), br(),
                            actionButton("delete_user", "Eliminar usuario"),
                            align = "center")
                      }
               ),
               column(8,
                      fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; margin: 0px;"),
                                if(!is.na(qr)){
                                  div(align = "center",
                                      tags$img(src= qr, width = "250px")
                                  )
                                },
                                br(),
                                if(permiso("editar usuarios", agen$user, vars$permisos_acc, vars$permisos_men) | 
                                   vars$user$cargo %in% c("Global Master Office", "Global Office Manager") |
                                   (vars$user$cargo == "Broker Manager" && !is.null(input$office_agen_filt_ofi) && vars$user$agencia == input$office_agen_filt_ofi)){
                                  div(
                                    actionButton("office_name_change", paste0("Nombre y Apellido: ", agen$name), icon = icon("edit"),
                                                 style = "background-color: transparent; border-width: 0px"), br(),
                                    actionButton("office_agencia_change", paste0("Oficina: ", agencia_nam), icon = icon("edit"),
                                                 style = "background-color: transparent; border-width: 0px"), br(),
                                    actionButton("office_cargo_change", paste0("Cargo: ", agen$cargo), icon = icon("edit"), 
                                                 style = "background-color: transparent; border-width: 0px"), br(),
                                    if(agen$cargo %in% c("Asesor")){
                                      div(
                                        actionButton("office_comision_change", paste0("Comisión: ", agen$comision), icon = icon("edit"),
                                                     style = "background-color: transparent; border-width: 0px"), br()
                                      )
                                    },
                                    actionButton("office_comment_change", "Descripción: ", icon = icon("edit"), 
                                                 style = "background-color: transparent; border-width: 0px;"), 
                                    HTML(paste0("<p><span style='width: 100%; word-break: break-word'>", 
                                                agen$comment, "</span></p>")),
                                    br(),
                                  )
                                }else{
                                  div(
                                    HTML(paste0(
                                      "<b>Nombre: </b>", agen$name,
                                      "<br><b>Oficina </b>", agencia_nam,
                                      "<br><b>Cargo: </b>", agen$cargo,
                                      ifelse(agen$cargo == "Asesor", paste0("<br><b>Comisión: </b>", agen$comision), ""),
                                      ifelse(agen$comment != "", paste0("<br>", "Descripción: ", agen$comment), "")
                                    )), style = "width: 100%; word-break: break-word;"
                                  )
                                },
                                actionButton("office_phone_change", paste0("Celular: ", agen$phone), icon = icon("edit"), 
                                             style = "background-color: transparent; border-width: 0px"), br(),
                                actionButton("office_face_change", paste0("Facebook: ", agen$face), icon = icon("edit"), 
                                             style = "background-color: transparent; border-width: 0px"), br(),
                                actionButton("office_insta_change", paste0("Instagram: ", agen$insta), icon = icon("edit"), 
                                             style = "background-color: transparent; border-width: 0px"), br(),
                                actionButton("office_birthday_change", paste0("Cumpleaños: ", agen$birthday), icon = icon("edit"), 
                                             style = "background-color: transparent; border-width: 0px"), br(),
                                HTML(paste0(
                                  "<br><b>Correo electrónico: </b>", agen$user,
                                  "<br><b>Razón Social: </b>", agen$razon,
                                  "<br><b>RUC: </b>", agen$ruc
                                )),
                                br(), br(),
                                if(agen$user != ""){
                                  div(class = "btn-group",
                                      a(href= paste0("mailto:", agen$user), target="_blank", 
                                        actionButton("nada", "" , icon = icon("envelope"),
                                                     style = "font-size: 150%; padding: 0px; padding-left: 0px; background-color: transparent; border-color: transparent"))
                                  )
                                },
                                if(!is.na(agen$phone)){
                                  text_wp <- paste0("https://wa.me/", agen$phone, "?text=", "")
                                  div(class = "btn-group",
                                      a(href = text_wp, target="_blank", actionButton("nada", NULL , icon = icon("whatsapp"),
                                                                                      style = "font-size: 150%; padding: 0px; padding-left: 10px;
                                                                                                          background-color: transparent; border-color: transparent"))
                                  )
                                },
                                if(!is.na(agen$face)){
                                  div(class = "btn-group",
                                      a(href = agen$face, target="_blank", actionButton("nada", NULL , icon = icon("facebook"),
                                                                                        style = "font-size: 150%; padding: 0px; padding-left: 10px;
                                                                                                          background-color: transparent; border-color: transparent"))
                                  )
                                },
                                if(!is.na(agen$insta)){
                                  div(class = "btn-group",
                                      a(href = agen$insta, target="_blank", actionButton("nada", NULL , icon = icon("instagram"),
                                                                                         style = "font-size: 150%; padding: 0px; padding-left: 10px;
                                                                                                          background-color: transparent; border-color: transparent"))
                                  )
                                }
                      )
               )
      ),
      if(nrow(vars$list_inmuebles_vinc) != 0 && vars$user$cargo != "Asesor"){
        agencia_broker_nam <- agencia_name(vars$user$agencia, vars$agencias, vars$franquicias)
        if(vars$user$cargo == "Global Master Office" | (!is.null(input$office_agen_filt_ofi) && input$office_agen_filt_ofi == agencia_broker_nam)){
          
          isolate({
            
            open_scroll_1$boxes = list()
            open_scroll_1$obs_open_scroll = list()
            open_scroll_1$obs_new_comentario = list()
            vars$n_scroll_1 <- 0
            vars$list_scroll_1 <- data.frame()
            
            vars$scroll_per_page_1 <- scroll_per_page
            vars$n_scroll_1 <- nrow(vars$list_inmuebles_vinc)
            if(vars$n_scroll_1 != 0){
              if(vars$n_scroll_1 > all_scroll){
                vars$all_scroll_1 <- vars$list_inmuebles_vinc[1:all_scroll,]
              }else{
                vars$all_scroll_1 <- vars$list_inmuebles_vinc
              }
              if(vars$n_scroll_1 <= scroll_per_page){
                vars$from_1 <- 1
                vars$to_1 <- vars$n_scroll_1
                vars$list_scroll_1 <- vars$all_scroll_1
                vars$loaded_scroll_1 <- vars$n_scroll_1
              }else{
                vars$from_1 <- 1   
                vars$to_1 <- scroll_per_page
                vars$list_scroll_1 <- vars$all_scroll_1[vars$from_1:vars$to_1,]
                vars$loaded_scroll_1 <- scroll_per_page
              }
            }else{
              vars$loaded_scroll_1 <- 0
            }
          })
          
          div(style = "background: #ffffff; border-style: solid; border-width: 1px; border-color: #aaaaaa; border-radius: 10px; padding: 20 px",
              div(uiOutput("boxes_with_scroll_ui_1"), align = "center"),
              br(),
              div(uiOutput("bttn_prox_scroll_1"), align = "center"),
              br()
          )
        }
      }
    )
  })
  
  observeEvent(input$close_agen_descripcion, {
    vars$image_perfil_edit <- FALSE
    removeModal()
  })
  
  observeEvent(input$estadisticas_agen, {
    
    agen <- vars$show_agente
    #tot_inmos <- list_table_var1_var2_var3_mysql("myplace_inmuebles", "company", "skyone", "user", "alejandruskifer21@gmail.com", "activo", "IN", "si")
    tot_inmos <- list_table_var1_var2_var3_mysql("myplace_inmuebles", "company", "skyone", "user", agen$user, "activo", "IN", "si")
    tot_inmos_sin_filtro <- tot_inmos %>% filter(borrador == "no" & externa == "no")
    tot_inmos <- tot_inmos_sin_filtro %>% filter(precio_cierre == 0) %>% select(user, precio, moneda_contrato, venta_alquiler, tipoPropiedad)
    cambio <- cambio_dolar$venta
    tot_inmos$precio <- ifelse(tot_inmos$moneda_contrato == "GS", round(tot_inmos$precio/cambio), tot_inmos$precio)
    inmos_ven <- tot_inmos %>% filter(venta_alquiler == "Venta" & tipoPropiedad != "Propiedad rural")
    inmos_alq <- tot_inmos %>% filter(venta_alquiler %in% c("Alquiler", "Alquiler temporal") & tipoPropiedad != "Propiedad rural")
    busq <- list_table_var1_var2_var3_mysql("myplace_busquedas", "company", "skyone", "user", agen$user, "activo", "IN", "si")
    
    transa <- list_table_var_mysql(paste0(co, "_transacciones"), "user", agen$user)
    #transa <- list_table_var_mysql(paste0(co, "_transacciones"), "user", "paola.borja@skyone.com.py")
    transa <- transa %>% filter(fase > 4 & tipo %in% c("captación", "colocación") & comision_cobrada != 0)
    lado_coloc <- transa %>% filter(tipo == "colocación")
    lado_capta <- transa %>% filter(tipo == "captación")
    venta_total <- transa[!duplicated(transa$id_inmo),]
    
    cierres_tot <- data.frame()
    gross_com_tot <- data.frame()
    
    if(nrow(transa) != 0){
      transa <- transa %>% mutate(n = ifelse(moneda == "GS", round(comision_cobrada/cambio), comision_cobrada))
      transa <- transa %>% select(fecha, n)
      vars$stat_agen_gross_com <- transa
      vars$stat_agen_cierres <- transa %>% group_by(fecha) %>% summarize(n = n())
      transa_full <- transa %>% mutate(fecha = as_date(paste0(format(fecha, "%Y-%m"), "-01")))
      
      cierres <- transa_full %>% group_by(fecha) %>% summarize(n = n())
      fechas <- seq.Date(min(cierres$fecha), as_date(now("America/Asuncion")), by = "month")
      blank <- data.frame(fecha = fechas, n = rep(0, length(fechas)))
      cierres_tot <- rbind(cierres, blank[!blank$fecha %in% cierres$fecha,]) %>% arrange(fecha)
      
      transa <- transa_full %>% group_by(fecha) %>% summarize(n = sum(n))
      fechas <- seq.Date(min(transa$fecha), as_date(now("America/Asuncion")), by = "month")
      blank <- data.frame(fecha = fechas, n = rep(0, length(fechas)))
      gross_com_tot <- rbind(transa, blank[!blank$fecha %in% transa$fecha,]) %>% arrange(fecha)
      
      plot_cierres <- ggplot(cierres_tot, aes(fecha, n)) + geom_col() +
        geom_smooth(se = FALSE) +
        labs(title = "", x="", y="cantidad") +
        theme(panel.background = element_rect(fill = "white"),
              plot.background = element_rect(fill = "white", colour = "white"),
              panel.grid = element_line(colour = "#e2e3e4")) 
      
      plot_gross <- ggplot(gross_com_tot, aes(fecha, n)) + geom_col() +
        geom_smooth(se = FALSE) +
        labs(title = "", x="", y="dólares") +
        theme(panel.background = element_rect(fill = "white"),
              plot.background = element_rect(fill = "white", colour = "white"),
              panel.grid = element_line(colour = "#e2e3e4")) 
    }
    
    if(nrow(venta_total) != 0){
      venta_total <- venta_total %>% mutate(n = ifelse(moneda == "GS", round(precio_cierre/cambio), precio_cierre))
      venta_total <- venta_total %>% select(fecha, n)
      vars$stat_agen_venta_total <- venta_total
      
      venta_total <- venta_total %>% mutate(fecha = as_date(paste0(format(as_date(fecha), "%Y-%m"), "-01")))
      venta_total <- venta_total %>% group_by(fecha) %>% summarize(n = round(sum(n)/1000, 2))
      fechas <- seq.Date(min(venta_total$fecha), as_date(now("America/Asuncion")), by = "month")
      blank <- data.frame(fecha = fechas, n = rep(0, length(fechas)))
      venta_total <- rbind(venta_total, blank[!blank$fecha %in% venta_total$fecha,]) %>% arrange(fecha)
      
      plot_venta_total <- ggplot(venta_total, aes(fecha, n)) + geom_col() +
        geom_smooth(se = FALSE) +
        labs(title = "", x="", y="miles de dólares") +
        theme(panel.background = element_rect(fill = "white"),
              plot.background = element_rect(fill = "white", colour = "white"),
              panel.grid = element_line(colour = "#e2e3e4")) 
    }else{
      venta_total <- data.frame()
    }
    
    if(nrow(lado_capta) != 0){
      lado_capta <- lado_capta %>% mutate(n = ifelse(moneda == "GS", round(comision_cobrada/cambio), comision_cobrada))
      lado_capta <- lado_capta %>% select(fecha, n)
      vars$stat_agen_lado_capta <- lado_capta %>% group_by(fecha) %>% summarize(n = n())
      lado_capta <- lado_capta %>% mutate(fecha = as_date(paste0(format(fecha, "%Y-%m"), "-01")))
      lado_capta <- lado_capta %>% group_by(fecha) %>% summarize(n = n())
      fechas <- seq.Date(min(lado_capta$fecha), as_date(now("America/Asuncion")), by = "month")
      blank <- data.frame(fecha = fechas, n = rep(0, length(fechas)))
      lado_capta_tot <- rbind(lado_capta, blank[!blank$fecha %in% lado_capta$fecha,]) %>% arrange(fecha)
      
      plot_lado_capta <- ggplot(lado_capta_tot, aes(fecha, n)) + geom_col() +
        geom_smooth(se = FALSE) +
        labs(title = "", x="", y="cantidad") +
        theme(panel.background = element_rect(fill = "white"),
              plot.background = element_rect(fill = "white", colour = "white"),
              panel.grid = element_line(colour = "#e2e3e4")) 
    }else{
      lado_capta_tot <- data.frame()
    }
    
    if(nrow(lado_coloc) != 0){
      lado_coloc <- lado_coloc %>% mutate(n = ifelse(moneda == "GS", round(comision_cobrada/cambio), comision_cobrada))
      lado_coloc <- lado_coloc %>% select(fecha, n)
      vars$stat_agen_lado_coloc <- lado_coloc %>% group_by(fecha) %>% summarize(n = n())
      lado_coloc <- lado_coloc %>% mutate(fecha = as_date(paste0(format(fecha, "%Y-%m"), "-01")))
      lado_coloc <- lado_coloc %>% group_by(fecha) %>% summarize(n = n())
      fechas <- seq.Date(min(lado_coloc$fecha), as_date(now("America/Asuncion")), by = "month")
      blank <- data.frame(fecha = fechas, n = rep(0, length(fechas)))
      lado_coloc_tot <- rbind(lado_coloc, blank[!blank$fecha %in% lado_coloc$fecha,]) %>% arrange(fecha)
      
      plot_lado_coloc <- ggplot(lado_coloc_tot, aes(fecha, n)) + geom_col() +
        geom_smooth(se = FALSE) +
        labs(title = "", x="", y="cantidad") +
        theme(panel.background = element_rect(fill = "white"),
              plot.background = element_rect(fill = "white", colour = "white"),
              panel.grid = element_line(colour = "#e2e3e4")) 
    }else{
      lado_coloc_tot <- data.frame()
    }
    
    inmos <- tot_inmos_sin_filtro %>% mutate(fecha = ifelse(tipo_contrato == "Exclusividad",
                                                            ini_contrato,
                                                            ifelse(is.na(fecha_aprobacion), fecha_creacion, fecha_aprobacion)))
    inmos$geometry <- NULL
    cap <- inmos %>% select(fecha)
    cap_ex <- inmos %>% filter(tipo_contrato == "Exclusividad") %>% select(fecha)
    
    if(nrow(cap) != 0){
      vars$stat_agen_cap <- cap %>% mutate(fecha = as_date(fecha)) %>% select(fecha) %>% group_by(fecha) %>% summarize(n = n())
      cap <- cap %>% mutate(fecha = as_date(paste0(format(as_date(fecha), "%Y-%m"), "-01")))
      cap <- cap %>% select(fecha) %>% group_by(fecha) %>% summarize(n = n())
      fechas <- seq.Date(min(cap$fecha), as_date(now("America/Asuncion")), by = "month")
      blank <- data.frame(fecha = fechas, n = rep(0, length(fechas)))
      cap_tot <- rbind(cap, blank[!blank$fecha %in% cap$fecha,]) %>% arrange(fecha)
      print("Captaciones totales")
      print(cap_tot)
      
      plot_cap <- ggplot(cap_tot, aes(fecha, n)) + geom_col() +
        geom_smooth(se = FALSE) +
        labs(title = "", x="", y="cantidad") +
        theme(panel.background = element_rect(fill = "white"),
              plot.background = element_rect(fill = "white", colour = "white"),
              panel.grid = element_line(colour = "#e2e3e4")) 
    }else{
      cap_tot <- data.frame()
    }
    
    if(nrow(cap_ex) != 0){
      vars$stat_agen_cap_ex <- cap_ex %>% mutate(fecha = as_date(fecha)) %>% select(fecha) %>% group_by(fecha) %>% summarize(n = n())
      cap_ex <- cap_ex %>% mutate(fecha = as_date(paste0(format(as_date(fecha), "%Y-%m"), "-01")))
      cap_ex <- cap_ex %>% select(fecha) %>% group_by(fecha) %>% summarize(n = n())
      fechas <- seq.Date(min(cap$fecha), as_date(now("America/Asuncion")), by = "month")
      blank <- data.frame(fecha = fechas, n = rep(0, length(fechas)))
      cap_ex_tot <- rbind(cap_ex, blank[!blank$fecha %in% cap$fecha,]) %>% arrange(fecha)
      print("Captaciones exclusividad")
      print(cap_ex_tot)
      
      plot_cap_ex <- ggplot(cap_ex_tot, aes(fecha, n)) + geom_col() +
        geom_smooth(se = FALSE) +
        labs(title = "", x="", y="cantidad") +
        theme(panel.background = element_rect(fill = "white"),
              plot.background = element_rect(fill = "white", colour = "white"),
              panel.grid = element_line(colour = "#e2e3e4")) 
    }else{
      cap_ex_tot <- data.frame()
    }
    
    showModal(modalDialog(
      h5(HTML(paste0("<b>Asesor: </b>", agen$name))),
      h5(HTML(paste0("<b>Propiedades activas: </b>", nrow(tot_inmos)))),
      h5(HTML(paste0("<b>Valor total de propiedades: </b>USD ", format(round(sum(tot_inmos$precio)), big.mark = ".", decimal.mark = ",", scientific = FALSE)))),
      h5(HTML(paste0("<b>Ticket promedio venta: </b>USD ", ifelse(nrow(inmos_ven) == 0, 0, 
                                                                  format(round(sum(inmos_ven$precio)/nrow(inmos_ven)), big.mark = ".", decimal.mark = ",", scientific = FALSE))))),
      h5(HTML(paste0("<b>Ticket promedio alquiler: </b>USD ", ifelse(nrow(inmos_alq) == 0, 0, 
                                                                     format(round(sum(inmos_alq$precio)/nrow(inmos_alq)), big.mark = ".", decimal.mark = ",", scientific = FALSE))))),
      h5(HTML(paste0("<b>Búsquedas activas: </b>", nrow(busq)))),
      br(),
      tags$div(id = "inline",
               dateRangeInput("date_range_agen_stat", 
                              "Elija el rango de fechas",
                              start = as_date(now("America/Asuncion")) - days(day(as_date(now("America/Asuncion")))) + days(1),
                              end = as_date(now("America/Asuncion")), 
                              min = "2019-01-01", max = as_date(now("America/Asuncion")), separator = "hasta",
                              language = "es")
      ),
      br(),
      uiOutput("stat_agen_gross_com_ui"),
      if(nrow(gross_com_tot) != 0){
        renderPlot(plot_gross)
      },
      br(),
      uiOutput("stat_agen_venta_total_ui"),
      if(nrow(venta_total) != 0){
        renderPlot(plot_venta_total)
      },
      br(),
      uiOutput("stat_agen_cierres_ui"),
      if(nrow(cierres_tot) != 0){
        renderPlot(plot_cierres)
      },
      br(),
      uiOutput("stat_agen_lado_capta_ui"),
      if(nrow(lado_capta_tot) != 0){
        renderPlot(plot_lado_capta)
      },
      br(),
      uiOutput("stat_agen_lado_coloc_ui"),
      if(nrow(lado_coloc_tot) != 0){
        renderPlot(plot_lado_coloc)
      },
      br(),
      uiOutput("stat_agen_cap_ui"),
      if(nrow(cap_tot) != 0){
        renderPlot(plot_cap)
      },
      br(),
      uiOutput("stat_agen_cap_ex_ui"),
      if(nrow(cap_ex_tot) != 0){
        renderPlot(plot_cap_ex)
      },
      
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("close_modal", "OK"),
               align = "center"),
      title = "Estadísticas",
      easyClose = TRUE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  output$stat_agen_gross_com_ui <- renderUI({
    req(vars$stat_agen_gross_com)
    dat <- vars$stat_agen_gross_com
    dat <- dat %>% filter(fecha >= input$date_range_agen_stat[1] & fecha <= input$date_range_agen_stat[2])
    h4(HTML(paste0("<b>Total Gross Commission:</b> USD ", format(round(sum(dat$n)), big.mark=".", decimal.mark = ",", scientific = FALSE))))
  })
  
  output$stat_agen_venta_total_ui <- renderUI({
    req(vars$stat_agen_venta_total)
    dat <- vars$stat_agen_venta_total
    dat <- dat %>% filter(fecha >= input$date_range_agen_stat[1] & fecha <= input$date_range_agen_stat[2])
    h4(HTML(paste0("<b>Volumen de ventas:</b> USD ", format(round(sum(dat$n)), big.mark=".", decimal.mark = ",", scientific = FALSE))))
  })
  
  output$stat_agen_cierres_ui <- renderUI({
    req(vars$stat_agen_cierres)
    dat <- vars$stat_agen_cierres
    dat <- dat %>% filter(fecha >= input$date_range_agen_stat[1] & fecha <= input$date_range_agen_stat[2])
    h4(HTML(paste0("<b>Total cierres:</b> ", format(round(sum(dat$n)), big.mark=".", decimal.mark = ",", scientific = FALSE))))
  })
  
  output$stat_agen_lado_capta_ui <- renderUI({
    req(vars$stat_agen_lado_capta)
    dat <- vars$stat_agen_lado_capta
    dat <- dat %>% filter(fecha >= input$date_range_agen_stat[1] & fecha <= input$date_range_agen_stat[2])
    h4(HTML(paste0("<b>Total lado captador:</b> ", format(round(sum(dat$n)), big.mark=".", decimal.mark = ",", scientific = FALSE))))
  })
  
  output$stat_agen_lado_coloc_ui <- renderUI({
    req(vars$stat_agen_lado_coloc)
    dat <- vars$stat_agen_lado_coloc
    dat <- dat %>% filter(fecha >= input$date_range_agen_stat[1] & fecha <= input$date_range_agen_stat[2])
    h4(HTML(paste0("<b>Total lado colocador:</b> ", format(round(sum(dat$n)), big.mark=".", decimal.mark = ",", scientific = FALSE))))
  })
  
  output$stat_agen_cap_ui <- renderUI({
    req(vars$stat_agen_cap)
    dat <- vars$stat_agen_cap
    dat <- dat %>% filter(fecha >= input$date_range_agen_stat[1] & fecha <= input$date_range_agen_stat[2])
    h4(HTML(paste0("<b>Total captaciones:</b> ", format(round(sum(dat$n)), big.mark=".", decimal.mark = ",", scientific = FALSE))))
  })
  
  output$stat_agen_cap_ex_ui <- renderUI({
    req(vars$stat_agen_cap_ex)
    dat <- vars$stat_agen_cap_ex
    dat <- dat %>% filter(fecha >= input$date_range_agen_stat[1] & fecha <= input$date_range_agen_stat[2])
    h4(HTML(paste0("<b>Total exclusividades:</b> ", format(round(sum(dat$n)), big.mark=".", decimal.mark = ",", scientific = FALSE))))
  })
  
  observeEvent(input$reset_pass, {
    showModal(modalDialog(
      h4("¿Está seguro que desea resetear la contraseña?"),
      tags$div(id="bttn_modal", 
               actionBttn("reset_pass_ok", "Resetear"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Resetear contraseña",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$reset_pass_ok, {
    agen <- vars$show_agente
    update_var_table_mysql(digest("skyone123"), "pass", "user", agen$user, "myplace_usuarios")
    update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", agen$user, "myplace_usuarios")
    modal_agen_description()
  })
  
  observeEvent(input$transferir_prop, {
    agentes <- list_table_var_mysql("myplace_usuarios", "company", co)
    inmos <- list_table_var1_var2_mysql("myplace_inmuebles", "company", co, "user", vars$show_agente$user)
    showModal(modalDialog(
      selectizeInput("transferir_inmos", "Elija las propiedades a transferir", choices = c(inmos$id), multiple = TRUE,
                     options = list(placeholder = 'Elige las propiedades')),
      selectInput("transferir_prop_agente", "Elija el usuario al cual transferir", choices = agentes$name),
      tags$div(id="bttn_modal", 
               actionBttn("transferir_prop_ok", "Transferir"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Transferir propiedades",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$transferir_prop_ok, {
    user <- vars$show_agente$user
    print(user)
    new_user <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "name", input$transferir_prop_agente)$user
    print(new_user)
    print(input$transferir_inmos)
    if(is.null(input$transferir_inmos)){
      shinyalert(
        type = "error",
        title = "Escoje las propiedades a transferir"
      )
    }else{
      
      inmos <- list_table_var_mysql("myplace_inmuebles", "id", input$transferir_inmos)
      if(nrow(inmos) != 0){
        for(i in 1:nrow(inmos)){
          print(paste0("Inmueble ", i))
          inmo <- inmos[i,]
          print(inmo)
          #Cambiar de user a la propiedad
          update_var_table_mysql(new_user, "user", "id", inmo$id, "myplace_inmuebles")
          update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", inmo$id, "myplace_inmuebles")
          #estados vinculados a la propiedad
          estados <- list_table_var1_var2_mysql(paste0(co, "_estados"), "id_inmo", inmo$id, "user", inmo$user)
          print("estados")
          print(estados)
          
          
          if(nrow(estados) == 0){
            cliente <- list_table_var_mysql(paste0(co, "_clientes"), "id", inmo$cliente)
            
            name_estado <- paste0(cliente$name, ifelse(inmo$venta_alquiler == "Venta", " vende", " alquila"),
                                  ifelse(inmo$tipoPropiedad %in% c("Casa", "Oficina", "Propiedad rural", "Casa quinta"), " una ", " un "), 
                                  str_to_lower(inmo$tipoPropiedad),
                                  " en ", inmo$ciudad)
            new_estado <- data.frame(
              id = new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12),
              fecha = as.character(now("America/Asuncion")),
              user = new_user,
              name = name_estado,
              id_inmo = inmo$id,
              id_clien = cliente$id,
              nivel_cliente = NA,
              estado_cliente = NA,
              accion = NA,
              fecha_prox_contacto = as.character(as_date(now("America/Asuncion"))),
              tipo_cliente = "captacion",
              presupuesto = NA,
              urgente = "no",
              importante = "no",
              fase = "1",
              comment = NA
            )
            save_mysql(new_estado, paste0(co, "_estados"), FALSE)
            estados <- new_estado
          }
          
          
          
          #listado de clientes vinculados a los estados que no sean asesores
          clientes <- unique(estados$id_clien[!str_detect(estados$id_clien, "@")])
          print("clientes")
          print(clientes)
          clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", clientes)
          
          #Duplicar clientes vinculados a los estados (propietario e interesados)
          #Y asignarlos al user viejo dejando los estados, inmos, llamadas, alarmas para el nuevo user
          for(j in 1:nrow(clien)){
            new_clien <- clien[j,]
            new_clien$id <- new_id_table_mysql("id", paste0(co, "_clientes"), "client_", 12)
            save_mysql(new_clien, paste0(co, "_clientes"), FALSE)
            print(paste0("generar cliente ", j))
          }
          #Cambiar de user a los clientes
          update_var_table_mysql(new_user, "user", "id", clientes, paste0(co, "_clientes"))
          #Cambiar de user a los estados
          update_var_table_mysql(new_user, "user", "id", estados$id, paste0(co, "_estados"))
          #listado de los registros de las propiedades
          registros <- list_table_var_mysql(paste0(co, "_llamadas"), "id_inmo", inmo$id)
          print("registros")
          print(registros)
          #Cambiar de user a los registros
          if(nrow(registros) != 0){
            update_var_table_mysql(new_user, "user", "id", registros$id, paste0(co, "_llamadas"))
          }
          #listado de las coincidencias
          coinci <- list_table_var1_var2_mysql("myplace_coincidencias", "inmueble", inmo$id, "activo", "si")
          print("coincidencias")
          print(coinci)
          if(nrow(coinci) != 0){
            #Cambiar de user a las coincidencias
            update_var_table_mysql(new_user, "user_inmo", "id", coinci$id, "myplace_coincidencias")
            update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", coinci$id, "myplace_coincidencias")
          }
        }
        vars$clientes_all <- list_table_var_mysql(paste0(co, "_clientes"), "user", vars$user$user)
      }
      removeModal()
    }
  })
  
  observeEvent(input$delete_user, {
    agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$show_agente$user)
    showModal(modalDialog(
      h4(paste0("¿Está seguro que desea eliminar al usuario ", agente$name, "?")),
      tags$div(id="bttn_modal", 
               actionBttn("delete_user_ok", "Eliminar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Eliminar usuario",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$delete_user_ok, {
    user <- vars$show_agente$user
    print(user)
    update_var_cond1_cond2_table_mysql("no", "activo", "user", user, "company", co, "myplace_inmuebles")
    update_var_cond1_cond2_table_mysql(as.character(now("America/Asuncion")), "fecha", "user", user, "company", co, "myplace_inmuebles")
    update_var_cond1_cond2_table_mysql("no", "activo", "user", user, "company", co, "myplace_tipologias")
    
    del_var_table_mysql("user", user, paste0(co, "_estados"))
    del_var_table_mysql("user", user, paste0(co, "_transacciones"))
    del_var_table_mysql("user", user, paste0(co, "_llamadas"))
    del_var_table_mysql("user", user, paste0(co, "_alarmas"))
    
    update_var_table_mysql("no", "activo", "user_inmo", user, "myplace_coincidencias")
    update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "user_inmo", user, "myplace_coincidencias")
    update_var_table_mysql("no", "activo", "user_busq", user, "myplace_coincidencias")
    update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "user_busq", user, "myplace_coincidencias")
    
    del_busqueda <- list_table_var1_var2_mysql("myplace_busquedas", "user", user, "company", co)
    update_var_table_mysql("no", "activo", "id", del_busqueda$id, "myplace_busquedas")
    update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", del_busqueda$id, "myplace_busquedas")

    del_var_table_mysql("user", user, paste0(co, "_fingerprint"))
    del_var_table_mysql("user", user, paste0(co, "_noticias"))
    del_var_table_mysql("user", user, paste0(co, "_comentarios"))
    del_var_table_mysql("user", user, paste0(co, "_seguidas"))
    
    update_var_table_mysql("NA", "myplace_plan", "cuenta", user, "cuentas2")
    update_var_table_mysql("NA", "myplace_fecha_pago", "cuenta", user, "cuentas2")
    update_var_table_mysql("NA", "myplace_fecha_vencimiento", "cuenta", user, "cuentas2")
    update_var_table_mysql("NA", "myplace_date_create", "cuenta", user, "cuentas2")
    update_var_table_mysql(0, "myplace_lim_users", "cuenta", user, "cuentas2")
    update_var_table_mysql(0, "myplace_saldo_avaluos", "cuenta", user, "cuentas2")
    update_var_table_mysql(as.character(now("America/Asuncion")), "date", "cuenta", user, "cuentas2")
    
    update_var_table_mysql("place", "company", "user", user, "myplace_usuarios")
    update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
    
    list <- list_spaces_do(prefix = paste0("avatar-users/", user))
    if(nrow(list) != 0){
      list <- list$Key
      for(i in 1:length(list)){
        delete_object_do(paste0("/", list[i]))
      }
    }
    refresh_office_agen(isolate(refresh_office_agen()) + 1)
    removeModal()
  })
  
  observeEvent(input$office_name_change, {
    showModal(modalDialog(
      textInput("office_new_name", "Nombre", value = vars$show_agente$name),
      tags$div(id="bttn_modal", 
               actionBttn("office_name_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de nombre",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$office_agencia_change, {
    all_agencias <- vars$agencias$name
    all_franquicias <- vars$franquicias$name 
    showModal(modalDialog(
      div(id = "inline", 
          selectInput("office_new_agencia", "Agencia a la que pertenece", choices = c(all_agencias, all_franquicias, "Global Master Office"))
      ),
      tags$div(id="bttn_modal", 
               actionBttn("office_agencia_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de agencia",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$office_cargo_change, {
    showModal(modalDialog(
      div(id = "inline", 
          selectInput("office_new_cargo", "Cargo", 
                      choices = c("Global Master Office", "Global Office Manager", "Global Office Assistant", "Country Master Office",
                                  "Country Office Manager", "Country Office Assistant", "Broker Office", "Broker Manager",
                                  "Broker Assistant", "Asesor"))
      ),
      uiOutput("office_comision_ui"),
      tags$div(id="bttn_modal", 
               actionBttn("office_cargo_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de cargo",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  output$office_comision_ui <- renderUI({
    req(input$office_new_cargo)
    if(input$office_new_cargo == "Asesor"){
      div(id = "inline", 
          selectInput("office_comision_new_cargo", "Comisiones", 
                      choices = c("Asesor Junior - 60%",
                                  "Asesor Senior - 70%",
                                  "Asesor Elite - 80%"))
      )
    }
  })
  
  observeEvent(input$office_comision_change, {
    showModal(modalDialog(
      div(id = "inline", 
          selectInput("office_new_comision", "Tipo de comisión", 
                      choices = c("Asesor Junior - 60%",
                                  "Asesor Senior - 70%",
                                  "Asesor Elite - 80%"))
      ),
      tags$div(id="bttn_modal", 
               actionBttn("office_comision_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de comisión",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$office_phone_change, {
    showModal(modalDialog(
      div(id = "inline", 
          fluidRow(
            column(7, selectInput("phone_code", "País", choices = phone_codes$name), style = "padding-right: 0px"),
            column(5, textInput("office_new_phone", "Teléfono"), style = "padding-left: 0px")
          )
      ),
      tags$div(id="bttn_modal", 
               actionBttn("office_phone_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de celular",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$office_face_change, {
    showModal(modalDialog(
      h5("Ejemplo: https://www.facebook.com/juanperez"),
      div(id = "inline", 
          textInput("office_new_face", "Facebook", value = vars$show_agente$face)
      ),
      tags$div(id="bttn_modal", 
               actionBttn("office_face_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambiar Facebook",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$office_insta_change, {
    showModal(modalDialog(
      h5("Ejemplo: https://www.instagram.com/juanperez"),
      div(id = "inline", 
          textInput("office_new_insta", "Instagram", value = vars$show_agente$inta)
      ),
      tags$div(id="bttn_modal", 
               actionBttn("office_insta_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambiar Instagram",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$office_birthday_change, {
    showModal(modalDialog(
      div(id = "inline", 
          dateInput("office_new_birthday", "Elije la fecha", language = "es", value = vars$show_agente$birthday)
      ),
      tags$div(id="bttn_modal", 
               actionBttn("office_birthday_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambiar Cumpleaños",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$office_comment_change, {
    showModal(modalDialog(
      div(id = "inline", 
          textAreaInput("office_new_comment", NULL)
      ),
      tags$div(id="bttn_modal", 
               actionBttn("office_comment_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de descripción",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$office_name_change_ok, {
    if(input$office_new_name == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      new_info <- input$office_new_name
      var <- "name"
      user <- vars$show_agente$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      vars$office_agen_all_pages$name[vars$office_agen_all_pages$user == user] <- new_info
      removeModal()
    }
  })
  
  observeEvent(input$office_agencia_change_ok, {
    if(input$office_new_agencia == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      if(input$office_new_agencia == "Global Master Office"){
        id_agencia <- "Global Master Office"
      }else{
        if(input$office_new_agencia %in% vars$agencias$name){
          id_agencia <- vars$agencias$id[vars$agencias$name == input$office_new_agencia]
        }else{
          if(input$office_new_agencia %in% vars$franquicias$name){
            id_agencia <- vars$franquicias$id[vars$franquicias$name == input$office_new_agencia]
          }
        }
      }
      new_info <- id_agencia
      var <- "agencia"
      user <- vars$show_agente$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      vars$office_agen_all_pages$agencia[vars$office_agen_all_pages$user == user] <- new_info
      removeModal()
    }
  })
  
  observeEvent(input$office_cargo_change_ok, {
    if(input$office_new_cargo == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      new_info <- input$office_new_cargo
      var <- "cargo"
      user <- vars$show_agente$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      vars$office_agen_all_pages$cargo[vars$office_agen_all_pages$user == user] <- new_info
      if(input$office_new_cargo != "Asesor"){
        new_info <- NA
        var <- "comision"
        user <- vars$show_agente$user
        update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
        update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
        vars$office_agen_all_pages$comision[vars$office_agen_all_pages$user == user] <- NA
      }else{
        new_info <- input$office_comision_new_cargo
        var <- "comision"
        user <- vars$show_agente$user
        update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
        update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
        vars$office_agen_all_pages$comision[vars$office_agen_all_pages$user == user] <- new_info
      }
      removeModal()
    }
  })
  
  observeEvent(input$office_comision_change_ok, {
    if(input$office_new_comision == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      new_info <- input$office_new_comision
      var <- "comision"
      user <- vars$show_agente$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      vars$office_agen_all_pages$comision[vars$office_agen_all_pages$user == user] <- new_info
      removeModal()
    }
  })
  
  observeEvent(input$office_phone_change_ok, {
    if(input$office_new_phone == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      new_info <- paste0(phone_codes$code[phone_codes$name == input$phone_code], str_remove_all(str_remove(input$office_new_phone, "^0"), " "))
      var <- "phone"
      user <- vars$show_agente$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      vars$office_agen_all_pages$phone[vars$office_agen_all_pages$user == user] <- new_info
      removeModal()
    }
  })
  
  observeEvent(input$office_face_change_ok, {
    new_info <- ifelse(input$office_new_face == "", NA, input$office_new_face)
    var <- "face"
    user <- vars$show_agente$user
    update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
    update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
    vars$office_agen_all_pages$face[vars$office_agen_all_pages$user == user] <- new_info
    removeModal()
  })
  
  observeEvent(input$office_insta_change_ok, {
    new_info <- ifelse(input$office_new_insta == "", NA, input$office_new_insta)
    var <- "insta"
    user <- vars$show_agente$user
    update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
    update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
    vars$office_agen_all_pages$insta[vars$office_agen_all_pages$user == user] <- new_info
    removeModal()
  })
  
  observeEvent(input$office_birthday_change_ok, {
    if(length(input$office_new_birthday) == 0){
      shinyalert(
        type = "error",
        title = "Ingrese su fecha de nacimiento"
      )
    }else{
      new_info <- as.character(input$office_new_birthday)
      var <- "birthday"
      user <- vars$show_agente$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      vars$office_agen_all_pages$birthday[vars$office_agen_all_pages$user == user] <- new_info
      removeModal()
    }
  })
  
  observeEvent(input$office_comment_change_ok, {
    if(input$office_new_comment == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      new_info <- input$office_new_comment
      var <- "comment"
      user <- vars$show_agente$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      vars$office_agen_all_pages$comment[vars$office_agen_all_pages$user == user] <- new_info
      removeModal()
    }
  })
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #office_trans
  
  output$box_office_trans_ui <- renderUI({
    if(office_trans_on() == 1){
      fluidPage(
        div(style = "position: sticky; width: 100%; z-index: 5",
            uiOutput("trans_filtros_ui")),
        br(),
        uiOutput("trans_boxes_ui")
      )
    }
  })  
  
  output$trans_boxes_ui <- renderUI({
    req(vars$trans_all_pages_1, vars$trans_all_pages_2, vars$trans_all_pages_3)
    if(office_trans_on() == 1){
      
      isolate({
        
        open_scroll_1$boxes = list()
        open_scroll_1$obs_open_scroll = list()
        open_scroll_1$obs_new_comentario = list()
        vars$n_scroll_1 <- 0
        vars$list_scroll_1 <- data.frame()
        
        vars$n_scroll_1 <- nrow(vars$trans_all_pages_1)
        print("vars$n_scroll_1")
        print(vars$n_scroll_1)
        if(vars$n_scroll_1 != 0){
          vars$scroll_per_page_1 <- scroll_per_page_trans
          vars$all_scroll_1 <- vars$trans_all_pages_1
          if(vars$n_scroll_1 <= scroll_per_page_trans){
            vars$from_1 <- 1
            vars$to_1 <- vars$n_scroll_1
            vars$list_scroll_1 <- vars$all_scroll_1
            vars$loaded_scroll_1 <- vars$n_scroll_1
          }else{
            vars$from_1 <- 1   
            vars$to_1 <- scroll_per_page_trans
            vars$list_scroll_1 <- vars$all_scroll_1[vars$from_1:vars$to_1,]
            vars$loaded_scroll_1 <- scroll_per_page_trans
          }
        }else{
          vars$loaded_scroll_1 <- 0
        }
        
        open_scroll_2$boxes = list()
        open_scroll_2$obs_open_scroll = list()
        open_scroll_2$obs_new_comentario = list()
        vars$n_scroll_2 <- 0
        vars$list_scroll_2 <- data.frame()
        
        vars$n_scroll_2 <- nrow(vars$trans_all_pages_2)
        print("vars$n_scroll_2")
        print(vars$n_scroll_2)
        if(vars$n_scroll_2 != 0){
          vars$scroll_per_page_2 <- scroll_per_page_trans
          open_scroll_2$boxes <- list()
          vars$all_scroll_2 <- vars$trans_all_pages_2
          if(vars$n_scroll_2 <= scroll_per_page_trans){
            vars$from_2 <- 1
            vars$to_2 <- vars$n_scroll_2
            vars$list_scroll_2 <- vars$all_scroll_2
            vars$loaded_scroll_2 <- vars$n_scroll_2
          }else{
            vars$from_2 <- 1   
            vars$to_2 <- scroll_per_page_trans
            vars$list_scroll_2 <- vars$all_scroll_2[vars$from_2:vars$to_2,]
            vars$loaded_scroll_2 <- scroll_per_page_trans
          }
        }else{
          vars$loaded_scroll_2 <- 0
        }
        
        open_scroll_3$boxes = list()
        open_scroll_3$obs_open_scroll = list()
        open_scroll_3$obs_new_comentario = list()
        vars$n_scroll_3 <- 0
        vars$list_scroll_3 <- data.frame()
        
        vars$n_scroll_3 <- nrow(vars$trans_all_pages_3)
        print("vars$n_scroll_3")
        print(vars$n_scroll_3)
        if(vars$n_scroll_3 != 0){
          vars$scroll_per_page_3 <- scroll_per_page_trans
          open_scroll_3$boxes <- list()
          vars$all_scroll_3 <- vars$trans_all_pages_3
          if(vars$n_scroll_3 <= scroll_per_page_trans){
            vars$from_3 <- 1
            vars$to_3 <- vars$n_scroll_3
            vars$list_scroll_3 <- vars$all_scroll_3
            vars$loaded_scroll_3 <- vars$n_scroll_3
          }else{
            vars$from_3 <- 1   
            vars$to_3 <- scroll_per_page_trans
            vars$list_scroll_3 <- vars$all_scroll_3[vars$from_3:vars$to_3,]
            vars$loaded_scroll_3 <- scroll_per_page_trans
          }
        }else{
          vars$loaded_scroll_3 <- 0
        }
        print("fichas en col 1")
        print(nrow(vars$list_scroll_1))
        print("fichas en col 2")
        print(nrow(vars$list_scroll_2))
        print("fichas en col 3")
        print(nrow(vars$list_scroll_3))
        
      })
      
      fluidRow(
        column(4,
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   fluidRow(
                     column(8, h4(HTML(paste0("<p><span style='color: ", main_color, "'>A cobrar</span></p>")), style = "margin-left: 10px")),
                     column(4, h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                                              nrow(vars$trans_all_pages_1), "</span></p>"))), align = "right")
                   ),
                   div(style = "overflow-y: scroll; height: 590px; position: absolute",
                       div(uiOutput("boxes_with_scroll_ui_1"), align = "center"),
                       br(),
                       div(uiOutput("bttn_prox_scroll_1"), align = "center"),
                       br()
                   )
               )
        ),
        column(4, 
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   fluidRow(
                     column(8, h4(HTML(paste0("<p><span style='color: ", main_color, "'>A pagar</span></p>")), style = "margin-left: 10px")),
                     column(4, h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                                              nrow(vars$trans_all_pages_2), "</span></p>"))), align = "right")
                   ),
                   div(style = "overflow-y: scroll; height: 590px; position: absolute",
                       div(uiOutput("boxes_with_scroll_ui_2"), align = "center"),
                       br(),
                       div(uiOutput("bttn_prox_scroll_2"), align = "center"),
                       br()
                   )
               )
        ),
        column(4, 
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   fluidRow(
                     column(8, h4(HTML(paste0("<p><span style='color: ", main_color, "'>Pagado (30 días)</span></p>")), style = "margin-left: 10px")),
                     column(4, h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                                              nrow(vars$trans_all_pages_3), "</span></p>"))), align = "right")
                   ),
                   div(style = "overflow-y: scroll; height: 590px; position: absolute",
                       div(uiOutput("boxes_with_scroll_ui_3"), align = "center"),
                       br(),
                       div(uiOutput("bttn_prox_scroll_3"), align = "center"),
                       br()
                   )
               )
        )
      )
    }
  })
  
  output$trans_filtros_ui <- renderUI({
    if(office_trans_on() == 1){
      req(vars$trans_paices)
      fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; margin-left: 0px"),
                div(id = "inline",
                    div(style = "width: 120px; margin: 5px; margin-top: 10px", class = "btn-group",
                        selectInput("office_trans_filt_pais", "País", choices = c("Todos", vars$trans_paices))),
                    div(style = "width: 180px; margin: 5px; margin-top: 10px", class = "btn-group",
                        uiOutput("office_trans_agencia_sel_ui")),
                    div(style = "width: 180px; margin: 5px; margin-top: 10px", class = "btn-group",
                        uiOutput("office_trans_agente_sel_ui")),
                    div(style = "width: 80px; margin: 5px; margin-top: -5px", class = "btn-group",
                        numericInput3("office_trans_filt_codigo", "Código", value = NULL))
                )
      )
    }
  })
  
  output$office_trans_agencia_sel_ui <- renderUI({
    req(input$office_trans_filt_pais)
    if(input$office_trans_filt_pais != "Todos"){
      isolate({
        selectInput("office_trans_filt_agencia", "Oficina", choices = c("Todos", unique(vars$office_trans_list$name_agencia[vars$office_trans_list$pais_agencia == input$office_trans_filt_pais])))
      })
    }else{
      isolate({
        selectInput("office_trans_filt_agencia", "Oficina", choices = c("Todos", unique(vars$office_trans_list$name_agencia)))
      })
    }
  })
  
  output$office_trans_agente_sel_ui <- renderUI({
    req(input$office_trans_filt_pais, input$office_trans_filt_agencia)
    
    if(input$office_trans_filt_pais != "Todos"){
      isolate({
        trans <- vars$office_trans_list[vars$office_trans_list$pais_agencia == input$office_trans_filt_pais,]
      })
    }else{
      trans <- isolate(vars$office_trans_list)
    }
    
    if(input$office_trans_filt_agencia != "Todos"){
      selectInput("office_trans_filt_agente", "Asesor", choices = c("Todos", unique(trans$user_name[trans$name_agencia == input$office_trans_filt_agencia])))
    }else{
      selectInput("office_trans_filt_agente", "Asesor", choices = c("Todos", unique(trans$user_name)))
    }
  })

  observe({
    req(vars$office_trans_list)
    print("nrow vars$office_trans_list")
    print(nrow(vars$office_trans_list))
    
    if(nrow(vars$office_trans_list) > 0){
      all_pages <- vars$office_trans_list %>% filter(tipo != "Pago comisión a Global")
    }else{
      all_pages <- data.frame()
    }

    
    if(!is.null(input$office_trans_filt_pais) && input$office_trans_filt_pais != "Todos"){
      all_pages <- all_pages %>% filter(pais_agencia == input$office_trans_filt_pais)
    }
    
    if(!is.null(input$office_trans_filt_agencia) && input$office_trans_filt_agencia != "Todos"){
      all_pages <- all_pages %>% filter(name_agencia == input$office_trans_filt_agencia)
      print(all_pages)
    }
    
    if(!is.null(input$office_trans_filt_agente) && input$office_trans_filt_agente != "Todos"){
      all_pages <- all_pages %>% filter(user_name == input$office_trans_filt_agente)
    }
    
    if(!is.null(input$office_trans_filt_codigo) && !is.na(input$office_trans_filt_codigo)){
      codigos <- lapply(all_pages$id_inmo, FUN = function(i){
        as.integer(str_flatten(str_extract_all(i, "\\d")[[1]]))
      }) %>% unlist()
      all_pages <- all_pages[codigos == input$office_trans_filt_codigo,]
    }
    
    if(nrow(all_pages) != 0){
      all_pages <- all_pages %>% arrange(desc(fecha))
      all_pages_1 <- all_pages %>% filter(fase == "4")  %>% filter(tipo %in% c("colocación", "captación", "referido"))
      all_pages_2 <- all_pages %>% filter(fase == "5" | (fase == "4" & comision_cobrada != 0))
      all_pages_3 <- all_pages %>% filter(fase == "6" & fecha >= as.character(now("America/Asuncion") - days(30)))
      isolate({
        vars$data_all_pages_1_back <- all_pages_1
        vars$data_all_pages_2_back <- all_pages_2
        vars$data_all_pages_3_back <- all_pages_3
      })
    }else{
      all_pages_1 <- data.frame()
      all_pages_2 <- data.frame()
      all_pages_3 <- data.frame()
    }
    
    isolate({
      if(nrow(all_pages_1) != 0){
        vars$trans_all_pages_1 <- all_pages_1
      }else{
        vars$trans_all_pages_1 <- data.frame()
      }
      if(nrow(all_pages_2) != 0){
        vars$trans_all_pages_2 <- all_pages_2
      }else{
        vars$trans_all_pages_2 <- data.frame()
      }
      if(nrow(all_pages_3) != 0){
        vars$trans_all_pages_3 <- all_pages_3
      }else{
        vars$trans_all_pages_3 <- data.frame()
      }
    })
  })
  
  output$formulario_trans_ui <- renderUI({
    req(vars$show_trans)
    trans <- vars$show_trans
    
    if(trans$tipo %in% c("colocación", "captación", "referido")){
      div(
        #sección de detalles de la operación
        uiOutput("trans_detalles_operacion_ui"),
        
        #sección de referidos que esta en la primera columna de cobros de oficina
        if(office_trans_on() == 1 && trans$fase == "4" & vars$trans_sel == 1){
          uiOutput("trans_detalles_referidos_ui")
        },
        
        #sección de boton de cobro de oficina en primera columna
        if(office_trans_on() == 1 & trans$fase == "4" & vars$trans_sel == 1){
          uiOutput("trans_detalles_boton_cobro_ui")
        },
        
        #sección de boton de pago en segunda columna
        if(office_trans_on() == 1 & ((trans$fase == "4" & vars$trans_sel == 2) | trans$fase == "5")){
          uiOutput("trans_detalles_boton_pago_ui")
        },
        
        #sección de pagados en tercera columna
        if(trans$fase == "6"){
          uiOutput("trans_detalles_pagados_ui")
        },
        
        br(),
        div(
          if(office_trans_on() == 1 & (trans$fase == "4" | trans$fase == "5")){
            tags$div(id="bttn_modal",
                     actionBttn("close_transferencia", "Cancelar")
            )
          }else{
            if(cierres_on() == 1 | trans$fase == "6"){
              tags$div(id="bttn_modal",
                       actionBttn("close_transferencia", "OK")
              )
            }
          },
          align = "center"),
      )
    }else{
      
      agencia <- agencia_name(trans$id_agencia, vars$agencias, vars$franquicias)
      
      div(
        div(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                            border-radius: 10px; background-color: white; padding: 10px; min-height: 175px; margin: 0px;
                                                            margin-bottom: 10px",
            if(office_trans_on() == 1){
              if(trans$tipo == "Pago a Place Analyzer"){
                if(trans$fase == "5"){
                  
                  fecha <- paste0(str_split(trans$id_estado, " - ")[[1]][2], "-01 00:00:00")
                  asesores <- list_table_var1_var2_var3_mysql("myplace_usuarios", "agencia", trans$id_agencia, "cargo", c("Asesor", "Broker Manager"), "company", "IN", co)
                  vars$asesores_list <- asesores %>% filter(date_create < fecha)
                  
                  div(
                    h4(paste0("Oficina ", agencia)),
                    div(h4(HTML(paste0("<p><span style='color: ", main_color, "'>", nrow(vars$asesores_list), " usuarios = GS ", 
                                       format(nrow(vars$asesores_list)*20000, big.mark = ".", decimal.mark = ",", scientific = FALSE), "</span></p>"))), align = "center"),
                    br(),
                    h4(HTML("<p><span style='color: #888888'>Listado de Asesores y Brokers a la fecha</span></p>")),
                    div(style = 'overflow-x: scroll',DT::dataTableOutput("table_asesores_place",width = "100%")) 
                  )
                }else{
                  if(trans$fase == "6"){
                    div(
                      h4(paste0("Oficina ", agencia)),
                      div(h4(HTML(paste0("<p><span style='color: ", main_color, "'>", trans$comision_asesor/20000, " usuarios = GS ", 
                                         format(trans$comision_asesor, big.mark = ".", decimal.mark = ",", scientific = FALSE), "</span></p>"))), align = "center")
                    )
                  }
                }
              }else{
                if(trans$tipo == "Pago comisión a Global"){
                  inmo <- list_table_var_mysql("myplace_inmuebles", "id", trans$id_inmo)
                  vars$show_inmo <- inmo
                  div(
                    h4(HTML("<p><span style='color: #888888'>Detalles del pago de comisión a Global</span></p>")),
                    fluidRow(
                      column(6,
                             fluidPage(
                               HTML(paste0(
                                 "<b>Tipo de Operación: </b>", trans$venta_alquiler, "<br>",
                                 "<b>Precio de cierre: </b>", trans$moneda, " ", format(trans$precio_cierre, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                                 "<b>Comisión ", format(trans$comision_cierre, big.mark = ".", decimal.mark = ",", scientific = FALSE), "%: </b>", trans$moneda, " ", format(trans$comision_a_cobrar, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>"
                                 #"<br>",
                                 #"<b>Global 10%: </b>", trans$moneda, " ", format(trans$comision_a_cobrar*0.10, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>"
                               ))
                             )
                      ),
                      column(6,
                             fluidPage(
                               column(4, style = "padding-left: 0px; min-width: 110px",
                                      div(actionButton("inmo_show", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:100px; height: 100px; margin: 0px;
                                                             background-image: url("', inmo$img, '");
                                                             background-size: cover, 100px 100px;
                                                             border-radius: 8px 8px 8px 8px')))
                               ),
                               column(8,
                                      div(
                                        h4(HTML(paste0("<p><span style='color: ", main_color, "'>", inmo$titulo, "</span></p>"))),
                                        div(
                                          HTML(paste0("<p><span style='font-size: 180%; font-weight: lighter; color: ", main_color, "'>", 
                                                      inmo$moneda_contrato, " ", format(inmo$precio, big.mark = ".", decimal.mark = ",", scientific = FALSE), "</span></p>"))
                                        )
                                      )
                               )
                             )
                      )
                    )
                  )
                }
              }
            }
        ),
        
        if(office_trans_on() == 1 & trans$fase == "5"){
          div(id = "inline",
              if(trans$tipo == "Pago a Place Analyzer"){
                fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                          h4("Datos para el pago a Place Analyzer"),
                          fluidRow(
                            column(6,
                                   h4("Trasferencia"),
                                   h5("Visión Banco"),
                                   h5("Nombre: Gustavo Mayeregger"),
                                   h5("Cuenta : 3291761"),
                                   h5("CI: 822983"),
                                   h5("Cel: 0991731345"),
                                   br(),
                                   textInput("fact_numero", "Número de factura"),
                                   textInput("fact_razon", "Razón social", value = "Place Analyzer EAS"),
                                   textInput("fact_ruc", "RUC", value = "80117081-8"),
                                   dateInput("fact_fecha", "Fecha", language = "es")
                            ),
                            column(6,
                                   textInput("fact_concepto", "Concepto", value = trans$id_estado),
                                   autonumericInput(inputId = "fact_monto", align = "left",
                                                    label = "Monto", 
                                                    value = trans$comision_asesor,
                                                    currencySymbol = ifelse(trans$moneda == "USD", "$ ", "Gs "), 
                                                    currencySymbolPlacement = "p",
                                                    decimalPlaces = ifelse(trans$moneda == "USD", 2, 0), digitGroupSeparator = ".", decimalCharacter = ",")
                            )
                          )
                )
              }else{
                if(trans$tipo == "Pago comisión a Global"){
                  fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                            h4("Datos de la factura de SkyOne Global"),
                            fluidRow(
                              column(6,
                                     textInput("fact_numero", "Número de factura"),
                                     textInput("fact_razon", "Razón social", value = global_razon),
                                     textInput("fact_ruc", "RUC", value = global_ruc),
                                     dateInput("fact_fecha", "Fecha", language = "es")
                              ),
                              column(6,
                                     textInput("fact_concepto", "Concepto", value = trans$id_estado),
                                     autonumericInput(inputId = "fact_monto", align = "left",
                                                      label = "Monto", 
                                                      value = trans$comision_asesor,
                                                      currencySymbol = ifelse(trans$moneda == "USD", "$ ", "Gs "), 
                                                      currencySymbolPlacement = "p",
                                                      decimalPlaces = ifelse(trans$moneda == "USD", 2, 0), digitGroupSeparator = ".", decimalCharacter = ",")
                              )
                            )
                  )
                }
              },
              fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                        h4("Datos de la operación"),
                        fluidRow(
                          column(6,
                                 selectInput("pago_medio", "Medio de pago", choices = c("Transferencia", "Efectivo", "Cheque"))
                          ),
                          column(6,
                                 textInput("pago_nro_comp", "Número de comprobante")
                          )
                        ),
                        uiOutput("image_transferencia"),
                        div(
                          fileInput(inputId = "upload_transferencia_pago",
                                    label = NULL,
                                    buttonLabel = "Escoje la foto",
                                    placeholder = "no hay foto",
                                    multiple = TRUE,
                                    accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
                          align = "center"),
              ),
          )
        },
        br(),
        div(
          if(office_trans_on() == 1 & trans$fase == "5"){
            boton <- case_when(trans$tipo == "Pago a Place Analyzer" ~ "pagar_place_ok",
                               trans$tipo == "Pago comisión a Global" ~ "pagar_global_ok")
            tags$div(id="bttn_modal",
                     actionBttn(boton, "Pagar"),
                     actionBttn("close_modal", "Cancelar")
            )
          }else{
            if(office_trans_on() == 1 & trans$fase == "6"){
              tags$div(id="bttn_modal",
                       actionBttn("close_modal", "OK")
              )
            }
          },
          align = "center"),
      )
    }
  })
  
  observeEvent(input$close_transferencia, {
    vars$foto_transferencia <- NULL
    vars$show_trans <- NULL
    removeModal()
  })
  
  output$trans_detalles_operacion_ui <- renderUI({
    req(vars$show_trans)
    trans <- vars$show_trans
    print(trans)
    comision <- round(trans$precio_cierre*trans$comision_cierre/100)
    
    vars$referidos <- list_table_var1_var2_mysql(paste0(co, "_referidos"), "id_inmo", trans$id_inmo, "tipo", vars$show_trans$tipo)
    referidos_externo <- vars$referidos %>% filter(externo == "si")
    monto_ref_externo <- ifelse(nrow(referidos_externo) == 0, 0, round(sum(referidos_externo$monto), 2))
    referidos_interno <- vars$referidos %>% filter(externo == "no")
    monto_ref_interno <- ifelse(nrow(referidos_interno) == 0, 0, round(sum(referidos_interno$monto), 2))
    monto_referidos <- monto_ref_externo + monto_ref_interno
    
    inmo <- list_table_var_mysql("myplace_inmuebles", "id", trans$id_inmo)
    vars$show_inmo <- inmo
    div(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                            border-radius: 10px; background-color: white; padding: 10px; min-height: 175px; margin: 0px;
                                                            margin-bottom: 10px",
        h4(HTML(paste0("<p><span style='color: #888888'>Detalles del ", ifelse(trans$fase == "4" & vars$trans_sel == 1, "cobro", "pago"), "</span></p>"))),
        fluidRow(
          column(6,
                 fluidPage(
                   if(trans$tipo == "referido"){
                     trans_referido <- list_table_var_mysql(paste0(co, "_transacciones"), "id", trans$id_estado)
                     
                     referido <- list_table_var1_var2_var3_mysql(paste0(co, "_referidos"), "id_inmo", trans_referido$id_inmo, "user", trans$user, "tipo", "IN", trans_referido$tipo)
                     print("referido")
                     print(referido)
                     HTML(paste0(
                       "<b>Tipo de Operación: </b>", trans_referido$venta_alquiler, "<br>",
                       "<b>Precio de cierre: </b>", trans_referido$moneda, " ", format(trans_referido$precio_cierre, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                       "<b>Comisión ", format(trans_referido$comision_cierre, big.mark = ".", decimal.mark = ",", scientific = FALSE), "%: </b>", trans$moneda, " ", format(comision, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                       "<br>",
                       if(inmo$venta_alquiler == "Venta"){
                         paste0("<b>", str_to_title(trans_referido$tipo), " 50%: </b>", trans_referido$moneda, " ", format(round(comision*0.50), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>")
                       }else{
                         paste0("<b>", str_to_title(trans_referido$tipo), ": ", format(trans_referido$comision_cierre, big.mark = ".", decimal.mark = ",", scientific = FALSE), "% </b>", trans_referido$moneda, " ", format(round(comision), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>")
                       },
                       "<br>",
                       "<b>Cobro por referido ", referido$comision, "%: </b>", referido$moneda, " ", format(referido$monto, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                       "<br>",
                       "<b>Global 10% referido: </b>", referido$moneda, " ", format(round(referido$monto*0.10, 2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                       "<b>Split Oficina 90% referido: </b>", referido$moneda, " ", format(round((referido$monto - round(referido$monto*0.10, 2)), 2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                       "<br>",
                       "<b>Comisión oficina referido ", 100 - trans$comision_user, "%: </b>", referido$moneda, " ", format(round(round((referido$monto - round(referido$monto*0.10, 2)), 2)*(100 - trans$comision_user)/100, 2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                       "<b>Comisión a pagar referido ", trans$comision_user, "%: </b>", referido$moneda, " ", format(round((referido$monto - 
                                                                                                                            round(referido$monto*0.10, 2) -
                                                                                                                            round(round((referido$monto - round(referido$monto*0.10, 2)), 2)*(100 - trans$comision_user)/100, 2)), 
                                                                                                                           2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>"
                     ))
                   }else{
                     if(inmo$venta_alquiler == "Venta"){
                       HTML(paste0(
                         "<b>Tipo de Operación: </b>", trans$venta_alquiler, "<br>",
                         "<b>Precio de cierre: </b>", trans$moneda, " ", format(trans$precio_cierre, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                         "<b>Comisión ", format(trans$comision_cierre, big.mark = ".", decimal.mark = ",", scientific = FALSE), "%: </b>", trans$moneda, " ", format(comision, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                         "<br>",
                         "<b>", str_to_title(trans$tipo), " 50%: </b>", trans$moneda, " ", format(round(comision*0.50), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                         if(!(trans$fase == "4" & vars$trans_sel == 1)){
                           paste0(
                             "<br>",                           
                             "<b>Referidos total: </b>", trans$moneda, " ", format(monto_referidos, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<b>Referidos SkyOne: </b>", trans$moneda, " ", format(monto_ref_interno, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<b>Referidos externos: </b>", trans$moneda, " ", format(monto_ref_externo, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<b>Split Referidos: </b>", trans$moneda, " ", format(comision*0.50 - monto_ref_interno, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<br>",
                             "<b>Global 10%: </b>", trans$moneda, " ", format(round((comision*0.50 - monto_ref_interno)*0.10, 2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<b>Split Oficina 90%: </b>", trans$moneda, " ", format(round((comision*0.50 - monto_ref_interno)*0.90, 2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<br>",
                             "<b>Comisión oficina ", 100 - trans$comision_user, "%: </b>", trans$moneda, " ", format(round((comision*0.50 - monto_ref_interno)*0.90*(100 - trans$comision_user)/100, 2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<b>Comisión asesor ", trans$comision_user, "%: </b>", trans$moneda, " ", format(round((comision*0.50 - monto_ref_interno)*0.90*trans$comision_user/100, 2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>"
                           )
                         }
                       ))
                     }else{
                       HTML(paste0(
                         "<b>Tipo de Operación: </b>", trans$venta_alquiler, "<br>",
                         "<b>Precio de cierre: </b>", trans$moneda, " ", format(trans$precio_cierre, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                         "<br>",
                         "<b>", str_to_title(trans$tipo), ": ", format(trans$comision_cierre, big.mark = ".", decimal.mark = ",", scientific = FALSE), "% </b>", trans$moneda, " ", format(round(comision), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                         if(!(trans$fase == "4" & vars$trans_sel == 1)){
                           
                           paste0(
                             "<br>",
                             "<b>Referidos total: </b>", trans$moneda, " ", format(monto_referidos, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<b>Referidos SkyOne: </b>", trans$moneda, " ", format(monto_ref_interno, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<b>Referidos externos: </b>", trans$moneda, " ", format(monto_ref_externo, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<b>Split Referidos: </b>", trans$moneda, " ", format(comision - monto_ref_interno, big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<br>",
                             "<b>Global 10%: </b>", trans$moneda, " ", format(round((comision - monto_ref_interno)*0.10, 2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<b>Split Oficina 90%: </b>", trans$moneda, " ", format(round((comision - monto_ref_interno)*0.90, 2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<br>",
                             "<b>Comisión oficina ", 100 - trans$comision_user, "%: </b>", trans$moneda, " ", format(round((comision - monto_ref_interno)*0.90*(100 - trans$comision_user)/100, 2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>",
                             "<b>Comisión asesor ", trans$comision_user, "%: </b>", trans$moneda, " ", format(round((comision - monto_ref_interno)*0.90*trans$comision_user/100, 2), big.mark = ".", decimal.mark = ",", scientific = FALSE), "<br>"
                           )
                         }
                       ))
                     }
                   }
                 )
          ),
          column(6,
                 fluidPage(
                   column(4, style = "padding-left: 0px; min-width: 110px",
                          div(actionButton("inmo_show", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:100px; height: 100px; margin: 0px;
                                                             background-image: url("', inmo$img, '");
                                                             background-size: cover, 100px 100px;
                                                             border-radius: 8px 8px 8px 8px')))
                   ),
                   column(8,
                          div(
                            h4(HTML(paste0("<p><span style='color: ", main_color, "'>", inmo$titulo, "</span></p>"))),
                            div(
                              HTML(paste0("<p><span style='font-size: 180%; font-weight: lighter; color: ", main_color, "'>", 
                                          inmo$moneda_contrato, " ", format(inmo$precio, big.mark = ".", decimal.mark = ",", scientific = FALSE), "</span></p>"))
                            )
                          )
                   )
                 )
          )
        )
    )
  })
  
  output$trans_detalles_referidos_ui <- renderUI({
    req(vars$show_trans)
    trans <- vars$show_trans
    vars$referidos <- list_table_var1_var2_mysql(paste0(co, "_referidos"), "id_inmo", trans$id_inmo, "tipo", vars$show_trans$tipo)
    ref_cap <- vars$referidos %>% filter(tipo == "captación")
    ref_col <- vars$referidos %>% filter(tipo == "colocación")
    div(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                            border-radius: 10px; background-color: white; padding: 10px; min-height: 175px; margin: 0px;
                                                            margin-bottom: 10px",
        h4(HTML(paste0("<p><span style='color: #888888'>Referidos lado ", ifelse(trans$tipo == "captación", "captadar", "colocador"), "</span></p>"))),
        if((trans$tipo == "captación" & nrow(ref_cap) != 0) |  (trans$tipo == "colocación" & nrow(ref_col) != 0)){
          div(style = 'overflow-x: scroll',DT::dataTableOutput("table_referidos",width = "100%"))
        },
        div(id = "inline", 
            div(class = "btn-group", style = "width: 140px",
                selectInput("office_trans_add_referido_sel", "Referido", choices = c("Asesor Skyone", "Externo")),
            ),
            div(class = "btn-group",
                uiOutput("office_trans_add_referido_ui"),
            ),
            div(class = "btn-group",
                tags$div(id="bttn_modal", actionBttn("office_trans_add_referido_ok", "Agregar"))
            )
        )
    )
  })
  
  output$trans_detalles_boton_cobro_ui <- renderUI({
    req(vars$show_trans)
    trans <- vars$show_trans
    agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", trans$user)
    cobros_anteriores <- list_table_var1_var2_mysql(paste0(co, "_pagos"), "id_pagado", trans$id, "ingreso", "si")
    if(nrow(cobros_anteriores) == 0){
      monto_cobrado <- 0
    }else{
      monto_cobrado <- sum(cobros_anteriores$fact_monto)
    }
    div(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                            border-radius: 10px; background-color: white; padding: 10px; min-height: 175px; margin: 0px;
                                                            margin-bottom: 10px",
        fluidPage(
          div(id = "inline", 
              actionButton("revertir_cierre", "Revertir cierre", icon = icon("trash-alt"), style = "background-color: #ffb3b3"),
              fluidRow(
                column(6,
                       h4(HTML(paste0("<b>Oficina: </b>", agencia_name(trans$id_agencia, vars$agencias, vars$franquicias)))),
                       h5(HTML(paste0("<b>Comisión a cobrar: </b>", format(trans$comision_a_cobrar, big.mark = ".", decimal.mark = ",", scientific = FALSE)))),
                       h5(HTML(paste0("<b>Monto ya cobrado: </b>", format(monto_cobrado, big.mark = ".", decimal.mark = ",", scientific = FALSE)))),
                       if(monto_cobrado != 0){
                         vars$trans_cobros_anteriores <- cobros_anteriores
                         div(style = 'overflow-x: scroll;', dataTableOutput("table_trans_cobros_anteriores"))
                       },
                       h5(HTML(paste0("<b>Saldo a cobrar: </b>", format(trans$comision_a_cobrar - monto_cobrado, big.mark = ".", decimal.mark = ",", scientific = FALSE))))
                ),
                column(6, align = "center",
                       if(vars$user$cargo == "Global Master Office"){
                         selectInput("cobro_agencia", "Oficina a cobrar", choices = vars$agencias$name)
                       },
                       tags$div(id="bttn_modal", slyle = "margin: 5px",
                                actionBttn("cobro_comision_trans", "Cobrar"))
                )
              )
          )
        )
    )
  })
  
  output$trans_detalles_boton_pago_ui <- renderUI({
    req(vars$show_trans)
    trans <- vars$show_trans
    agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", trans$user)
    pagos_anteriores <- list_table_var1_var2_mysql(paste0(co, "_pagos"), "id_pagado", trans$id, "ingreso", "no")
    if(nrow(pagos_anteriores) == 0){
      monto_pagado <- 0
    }else{
      monto_pagado <- sum(pagos_anteriores$fact_monto)
    }
    
    if(trans$tipo == "referido"){
      trans_referido <- list_table_var_mysql(paste0(co, "_transacciones"), "id", trans$id_estado)
      cobros_anteriores <- list_table_var1_var2_mysql(paste0(co, "_pagos"), "id_pagado", trans_referido$id, "ingreso", "si")
    }else{
      cobros_anteriores <- list_table_var1_var2_mysql(paste0(co, "_pagos"), "id_pagado", trans$id, "ingreso", "si")
    }
    
    if(nrow(cobros_anteriores) == 0){
      monto_cobrado <- 0
    }else{
      monto_cobrado <- sum(cobros_anteriores$fact_monto)
    }
    div(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                            border-radius: 10px; background-color: white; padding: 10px; min-height: 175px; margin: 0px;
                                                            margin-bottom: 10px",
        fluidPage(
          div(id = "inline", 
              actionButton("revertir_cobro", "Revertir cobro", icon = icon("trash-alt"), style = "background-color: #ffb3b3"),
              fluidRow(
                column(6,
                       h4(HTML(paste0("<b>Oficina: </b>", agencia_name(trans$id_agencia, vars$agencias, vars$franquicias)))),
                       h5(HTML(paste0("<b>Comisión a cobrar: </b>", format(trans$comision_a_cobrar, big.mark = ".", decimal.mark = ",", scientific = FALSE)))),
                       h5(HTML(paste0("<b>Monto ya cobrado: </b>", format(monto_cobrado, big.mark = ".", decimal.mark = ",", scientific = FALSE)))),
                       if(monto_cobrado != 0){
                         vars$trans_cobros_anteriores <- cobros_anteriores
                         div(style = 'overflow-x: scroll;', dataTableOutput("table_trans_cobros_anteriores"))
                       },
                       h5(HTML(paste0("<b>Saldo a cobrar: </b>", format(trans$comision_a_cobrar - monto_cobrado, big.mark = ".", decimal.mark = ",", scientific = FALSE)))),
                       br(),
                       h4(HTML(paste0("<b>Asesor: </b>", agente$name))),
                       h5(HTML(paste0("<b>Comisión del Asesor: </b>", format(trans$comision_asesor, big.mark = ".", decimal.mark = ",", scientific = FALSE)))),
                       h5(HTML(paste0("<b>Monto ya pagado: </b>", format(monto_pagado, big.mark = ".", decimal.mark = ",", scientific = FALSE)))),
                       if(monto_pagado != 0){
                         vars$trans_pagos_anteriores <- pagos_anteriores
                         div(style = 'overflow-x: scroll;', dataTableOutput("table_trans_pagos_anteriores"))
                       },
                       h5(HTML(paste0("<b>Saldo a pagar: </b>", format(trans$comision_asesor - monto_pagado, big.mark = ".", decimal.mark = ",", scientific = FALSE))))
                ),
                column(6, align = "center",
                       if(vars$user$cargo == "Global Master Office"){
                         selectInput("pago_agencia", "Oficina a pagar", choices = vars$agencias$name)
                       },
                       tags$div(id="bttn_modal", slyle = "margin: 5px",
                                actionBttn("pago_comision_trans", "Pagar"))
                )
              )
          )
        )
    )
  })
  
  output$trans_detalles_pagados_ui <- renderUI({
    req(vars$show_trans)
    trans <- vars$show_trans
    agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", trans$user)
    vars$table_pagos <- list_table_var_mysql(paste0(co, "_pagos"), "id_pagado", trans$id)
    div(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                            border-radius: 10px; background-color: white; padding: 10px; min-height: 175px; margin: 0px;
                                                            margin-bottom: 10px",
        actionButton("revertir_pago", "Revertir pago", icon = icon("trash-alt"), style = "background-color: #ffb3b3"),
        fluidPage(
          div(id = "inline", align = "center",
              h4(HTML(paste0("<b>Asesor: </b>", agente$name))),
              h3(paste0(ifelse(office_trans_on() == 1, "Pagado ", "Cobrado "), 
                        trans$moneda, " ", format(trans$comision_asesor, big.mark = ".", 
                                                  decimal.mark = ",", scientific = FALSE)))
              
          ),
          if(nrow(vars$table_pagos) != 0){
            div(style = 'overflow-x: scroll',DT::dataTableOutput("table_pagos",width = "100%"))
          }
        )
    )
  })
  
  output$table_trans_cobros_anteriores <- renderDataTable({
    req(vars$trans_cobros_anteriores)
    dat <- vars$trans_cobros_anteriores %>%
      mutate(fecha = str_split(fecha, " ")[[1]][1],
             monto = paste0(fact_moneda, " ", format(fact_monto, big.mark = ".", decimal.mark = ",", scientific = FALSE)),
             nro_factura = fact_numero,
             RUC = fact_ruc,
             razon_social = fact_razon) %>% 
      select(fecha, monto, nro_factura, RUC, razon_social)
    print(dat)
    DT::datatable(dat, rownames = FALSE, options = list(dom = 't'), selection = "none")
  })
  
  output$table_trans_pagos_anteriores <- renderDataTable({
    req(vars$trans_pagos_anteriores)
    dat <- vars$trans_pagos_anteriores %>%
      mutate(fecha = str_split(fecha, " ")[[1]][1],
             monto = paste0(fact_moneda, " ", format(fact_monto, big.mark = ".", decimal.mark = ",", scientific = FALSE)),
             nro_factura = fact_numero,
             RUC = fact_ruc,
             razon_social = fact_razon) %>% 
      select(fecha, monto, nro_factura, RUC, razon_social)
    print(dat)
    DT::datatable(dat, rownames = FALSE, options = list(dom = 't'), selection = "none")
  })
  
  observeEvent(input$revertir_cierre, {
    showModal(modalDialog(
      h4("¿Esta seguro de querer revertir el cierre?"),
      tags$div(id="bttn_modal", 
               actionBttn("revertir_cierre_ok", "Revertir"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Revertir cierre",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$revertir_cierre_ok, {
    trans <- vars$show_trans
    update_var_table_mysql("NA", "fecha_cierre", "id", trans$id_inmo, "myplace_inmuebles")
    update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", trans$id_inmo, "myplace_inmuebles")
    update_var_table_mysql(0, "precio_cierre", "id", trans$id_inmo, "myplace_inmuebles")
    
    print("ok_inmo")
    transacciones <- list_table_var_mysql(paste0(co, "_transacciones"), "id_inmo", trans$id_inmo)
    print(transacciones)
    
    estados <- list_table_var_mysql(paste0(co, "_estados"), "id_inmo", trans$id_inmo)
    for(i in 1:nrow(estados)){
      estado <- estados[i,]
      print(estado)
      if(estado$tipo_cliente == "captacion"){
        update_var_table_mysql("3", "fase", "id", estado$id, paste0(co, "_estados"))
      }
      if(estado$tipo_cliente == "colocacion"){
        update_var_table_mysql("2", "fase", "id", estado$id, paste0(co, "_estados"))
      }
    }
    
    del_var_table_mysql("id", transacciones$id, paste0(co, "_transacciones"))
    
    vars$office_trans_list <- vars$office_trans_list[!vars$office_trans_list$id %in% transacciones$id,]
    removeModal()
  })
  
  observeEvent(input$revertir_cobro, {
    showModal(modalDialog(
      h4("¿Esta seguro de querer revertir el cobro de esta transacción?"),
      tags$div(id="bttn_modal", 
               actionBttn("revertir_cobro_ok", "Revertir"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Revertir cobro",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$revertir_cobro_ok, {
    
    trans <- list_table_var_mysql(paste0(co, "_transacciones"), "id_inmo", vars$show_trans$id_inmo)
    
    trans_global <- trans[trans$tipo == "Pago comisión a Global",]
    if(nrow(trans_global) != 0){
      del_var_table_mysql("id", trans_global$id, paste0(co, "_transacciones"))
      vars$office_trans_list <- vars$office_trans_list[!vars$office_trans_list$id %in% trans_global$id,]
      trans <- trans[trans$tipo != "Pago comisión a Global",]
    }

    if(nrow(trans) != 0){
      
      referidos <- list_table_var1_var2_mysql(paste0(co, "_referidos"), "id_inmo", vars$show_trans$id_inmo, "tipo", vars$show_trans$tipo)
      
      if(nrow(referidos) != 0){
        print(paste0("Numero de referidos: ", nrow(referidos)))
        comision <- vars$show_trans$comision_a_cobrar
        global <- comision*0.10
        split_oficina <- comision*0.90
        comision_asesor <- split_oficina*vars$show_trans$comision_user/100
        
        update_var_table_mysql(comision_asesor, "comision_asesor", "id", vars$show_trans$id, paste0(co, "_transacciones"))
        vars$show_trans$comision_asesor <- comision_asesor
      }
        
      for(i in 1:nrow(trans)){
        del_var_table_mysql("id_pagado", trans$id[i], paste0(co, "_pagos"))
        
        if(trans$tipo[i] == "referido"){
          del_var_table_mysql("id", trans$id[i], paste0(co, "_transacciones"))
          vars$office_trans_list <- vars$office_trans_list %>% filter(id != trans$id[i])
        }else{
          update_var_table_mysql(0, "comision_cobrada", "id", trans$id[i], paste0(co, "_transacciones"))
          vars$office_trans_list$comision_cobrada[vars$office_trans_list$id == trans$id[i]] <- 0
          update_var_table_mysql("4", "fase", "id", trans$id[i], paste0(co, "_transacciones"))
          vars$office_trans_list$fase[vars$office_trans_list$id == trans$id[i]] <- "4"
        }
        
      }
    }
    removeModal()
  })
  
  observeEvent(input$revertir_pago, {
    showModal(modalDialog(
      h4("¿Esta seguro de querer revertir el pago de esta transacción?"),
      tags$div(id="bttn_modal", 
               actionBttn("revertir_pago_ok", "Revertir"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Revertir pago",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$revertir_pago_ok, {
    
    trans <- vars$show_trans
    del_var_table_mysql("id_pagado", trans$id, paste0(co, "_pagos"))
    update_var_table_mysql("5", "fase", "id", trans$id, paste0(co, "_transacciones"))
    vars$office_trans_list$fase[vars$office_trans_list$id == trans$id] <- "5"
    
    removeModal()
  })
  
  output$table_referidos <- renderDataTable({
    req(vars$show_trans, vars$referidos)
    trans <- vars$show_trans
    comision_ref <- trans$precio_cierre*trans$comision_cierre/100*0.50
    agentes <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$referidos$user)
    
    referidos <- vars$referidos %>% filter(tipo == trans$tipo)
    
    vars$referidos_pago <- referidos %>% 
      mutate(name = sapply(user, FUN = function(x){
        ifelse(x %in% agentes$user, agentes$name[agentes$user == x], x)}),
        razon = sapply(user, FUN = function(x){
          ifelse(x %in% agentes$user, agentes$razon[agentes$user == x], "")}),
        ruc = sapply(user, FUN = function(x){
          ifelse(x %in% agentes$user, agentes$ruc[agentes$user == x], "")}),
        moneda = trans$moneda,
        monto = round(monto,2),
        comision = round(comision, 2),
        eliminar = glue('<center><button id="custom_btn" onclick="Shiny.onInputChange(\'del_referido_but\', \'{id}\')"><i class="fa fa-trash"></i></button></center>'))
    
    referidos <- vars$referidos_pago %>% select(referido = name, ext = externo, operación = tipo, comision = comision, monto = monto, 
                                                X = eliminar)
    
    datatable(referidos, options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                                        pageLength = 5, dom = 'ftp'), rownames = FALSE, escape = FALSE,
              editable = TRUE, selection = "none")
  })
  
  output$table_pagos <- renderDataTable({
    req(vars$table_pagos)
    blank <- "https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/blank_inmo.jpg"
    pagos <- vars$table_pagos %>% mutate(comprobante = ifelse(is.na(img), 
                                                              paste0('<img src= "', blank, '" width="250"></img>'), 
                                                              paste0('<img src="', img, '" height="250"></img>')),
                                         fact_monto = format(fact_monto, big.mark = ".", decimal.mark = ",", scientific = FALSE)) %>%
      select(comprobante = comprobante, fecha = fact_fecha, monto = fact_monto)
    
    datatable(pagos, options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                                    pageLength = 5, dom = 'ftp'), rownames = FALSE, escape = FALSE,
              selection = "none")
  })
  
  observeEvent(input$del_referido_but, {
    del_id <- input$del_referido_but
    del_var_table_mysql("id", del_id, paste0(co, "_referidos"))
    vars$referidos <- vars$referidos[vars$referidos$id != del_id, ]
    
    if(nrow(vars$referidos) > 0){
      comision <- 20/nrow(vars$referidos)
      monto <- vars$show_trans$precio_cierre*vars$show_trans$comision_cierre/100*0.50*comision/100
      for(i in 1:nrow(vars$referidos)){
        update_var_table_mysql(comision, "comision", "id", vars$referidos$id[i], paste0(co, "_referidos"))
        vars$referidos$comision[vars$referidos$id == vars$referidos$id[i]] <- comision
        update_var_table_mysql(monto, "monto", "id", vars$referidos$id[i], paste0(co, "_referidos"))
        vars$referidos$monto[vars$referidos$id == vars$referidos$id[i]] <- monto
      }
    }
  })
  
  output$table_asesores_place <- renderDataTable({
    req(vars$asesores_list)
    asesores_list <- vars$asesores_list %>% select(nombre = name, usuario = user)
    
    datatable(asesores_list, options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                                            pageLength = 10, dom = 'ftp'), rownames = FALSE, escape = FALSE,
              editable = FALSE, selection = "none")
  })
  
  observe({
    if(!is.null(input$upload_transferencia_pago)){
      print(input$upload_transferencia_pago)
      im <- image_read(input$upload_transferencia_pago$datapath[1])
      im <- image_orient(im)
      im <- image_convert(im, format = "jpg")
      im <- image_scale(im, "600x")
      image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
      put_object_do(paste0("/", co, "/temp/", vars$user$user, "/", vars$pagar_id, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
      image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
      vars$url_temp_foto_transferencia <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/temp/", vars$user$user, "/", vars$pagar_id, ".jpg")
      print(vars$url_temp_foto_transferencia)
      vars$foto_transferencia <- dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
    }
  })
  
  output$image_transferencia <- renderUI({
    if(!is.null(vars$foto_transferencia)){
      div(
        tags$img(src= vars$foto_transferencia, width = "250px"),
        align = "center"
      )
    }else{
      div(
        tags$img(src= "blank_inmo.jpg", width = "250px"),
        align = "center"
      )
    }
  })
  
  observeEvent(input$close_pago_transferencia, {
    vars$show_trans <- NULL
    vars$foto_transferencia <- NULL
    removeModal()
#    modal_trans_description()
  })
  
  observeEvent(input$table_referidos_cell_edit, {
    info <- input$table_referidos_cell_edit
    print(info)
    i <- info$row
    j <- info$col
    v <- as.numeric(info$value)
    
    trans <- vars$show_trans
    comision_ref <- trans$precio_cierre*trans$comision_cierre/100*0.50
    
    if(j == 3){
        update_var_table_mysql(v, "comision", "id", vars$referidos$id[i], paste0(co, "_referidos"))
        vars$referidos$comision[i] <- v
        update_var_table_mysql(v/100*comision_ref, "monto", "id", vars$referidos$id[i], paste0(co, "_referidos"))
        vars$referidos$monto[i] <- v/100*comision_ref
    }else{
      if(j == 4){
        update_var_table_mysql(v, "monto", "id", vars$referidos$id[i], paste0(co, "_referidos"))
        vars$referidos$monto[i] <- v
        update_var_table_mysql(v/comision_ref*100, "comision", "id", vars$referidos$id[i], paste0(co, "_referidos"))
        vars$referidos$comision[i] <- v/comision_ref*100
      }
    }
  })
  
  output$office_trans_add_referido_ui <- renderUI({
    req(input$office_trans_add_referido_sel)
    if(input$office_trans_add_referido_sel == "Externo"){
      textInput("office_trans_add_referido_ext_name", "Nombre del referido")
    }else{
      agentes <- list_table_var_mysql("myplace_usuarios", "company", co)
      selectInput("office_trans_add_referido_skyone", "Escoja al Asesor SkyOne", choices = agentes$name)
    }
  })
  
  observeEvent(input$office_trans_add_referido_ok, {
    req(input$office_trans_add_referido_sel)
    if(input$office_trans_add_referido_sel == "Externo" && !is.null(input$office_trans_add_referido_ext_name) && input$office_trans_add_referido_ext_name == ""){
      shinyalert(
        type = "error",
        title = "Completa el nombre del referido externo"
      )
    }else{
      if(input$office_trans_add_referido_sel == "Externo"){
        name <- input$office_trans_add_referido_ext_name
        externo <- "si"
      }else{
        name <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "name", input$office_trans_add_referido_skyone) %>% .$user
        externo <- "no"
      }
      
      new_referido <- data.frame(
        id = new_id_table_mysql("id", paste0(co, "_referidos"), "referido_", 12),
        user = name,
        fecha = as.character(now("America/Asuncion")),
        tipo = vars$show_trans$tipo,
        id_inmo = vars$show_trans$id_inmo,
        externo = externo,
        comision = 20,
        moneda = vars$show_trans$moneda,
        monto = vars$show_trans$precio_cierre*vars$show_trans$comision_cierre/100*0.50*20/100,
        pagado = "no",
        img = NA
      )
      save_mysql(new_referido, paste0(co, "_referidos"), FALSE)
      vars$referidos <- rbind(vars$referidos, new_referido)
      
      refer_inmos <- list_table_var1_var2_mysql(paste0(co, "_referidos"), "id_inmo", new_referido$id_inmo, "tipo", new_referido$tipo)
      if(nrow(refer_inmos) > 1){
        comision <- 20/nrow(refer_inmos)
        monto <- vars$show_trans$precio_cierre*vars$show_trans$comision_cierre/100*0.50*comision/100
        for(i in 1:nrow(refer_inmos)){
          update_var_table_mysql(comision, "comision", "id", refer_inmos$id[i], paste0(co, "_referidos"))
          vars$referidos$comision[vars$referidos$id == refer_inmos$id[i]] <- comision
          update_var_table_mysql(monto, "monto", "id", refer_inmos$id[i], paste0(co, "_referidos"))
          vars$referidos$monto[vars$referidos$id == refer_inmos$id[i]] <- monto
        }
      }
    }
  })
  
  observeEvent(input$cobro_comision_trans, {
    req(vars$show_trans)
    trans <- vars$show_trans
    vars$foto_transferencia <- NULL
    agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", trans$user)
    id_agencia <- agente$agencia
    ruc <- ifelse(id_agencia == "Global Master Office", global_ruc, ifelse(id_agencia %in% vars$agencias$id, vars$agencias$ruc[vars$agencias$id == id_agencia], vars$franquicias$ruc[vars$franquicias$id == id_agencia]))
    razon <- ifelse(id_agencia == "Global Master Office", global_razon, ifelse(id_agencia %in% vars$agencias$id, vars$agencias$razon[vars$agencias$id == id_agencia], vars$franquicias$razon[vars$franquicias$id == id_agencia]))
    
    cobros_anteriores <- list_table_var1_var2_mysql(paste0(co, "_pagos"), "id_pagado", trans$id, "ingreso", "si")
    if(nrow(cobros_anteriores) == 0){
      monto_cobrado <- 0
    }else{
      monto_cobrado <- sum(cobros_anteriores$fact_monto)
    }
    
    showModal(modalDialog(
      div(id = "inline",
          fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                    h4("Datos de la factura entregada al Propietario"),
                    fluidRow(
                      column(6,
                             textInput("fact_numero", "Número de factura"),
                             textInput("fact_razon", "Razón social", value = razon),
                             textInput("fact_ruc", "RUC", value = ruc),
                             dateInput("fact_fecha", "Fecha", language = "es")
                      ),
                      column(6,
                             textInput("fact_concepto", "Concepto", value = "Cobro de comisión"),
                             radioButtons("fact_moneda", "Moneda", inline = TRUE, choices = c("USD", "GS"), selected = trans$moneda),
                             autonumericInput(inputId = "fact_monto", align = "left",
                                              label = "Monto", 
                                              value = trans$comision_a_cobrar - monto_cobrado, 
                                              currencySymbol = ifelse(trans$moneda == "USD", "$ ", "Gs "), 
                                              currencySymbolPlacement = "p",
                                              decimalPlaces = ifelse(trans$moneda == "USD", 2, 0), digitGroupSeparator = ".", decimalCharacter = ",")
                      )
                    )
          ),
          fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                    h4("Datos de la operación"),
                    fluidRow(
                      column(6,
                             selectInput("pago_medio", "Medio de pago", choices = c("Transferencia", "Efectivo", "Cheque"))
                      ),
                      column(6,
                             textInput("pago_nro_comp", "Número de comprobante")
                      )
                    ),
                    uiOutput("image_transferencia"),
                    div(
                      fileInput(inputId = "upload_transferencia_pago",
                                label = NULL,
                                buttonLabel = "Escoje la foto",
                                placeholder = "no hay foto",
                                multiple = TRUE,
                                accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
                      align = "center"),
          ),
      ),
      tags$div(id="bttn_modal", 
               actionBttn("cobro_comision_trans_ok", "Cobrar"),
               actionBttn("close_cobro_comision_trans", "Cancelar"),
               align = "center"),
      title = "Cobro de comisión",
      easyClose = FALSE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  observeEvent(input$close_cobro_comision_trans, {
    vars$foto_transferencia <- NULL
    vars$show_trans <- NULL
    removeModal()
  })
  
  observeEvent(input$cobro_comision_trans_ok, {
    req(vars$show_trans)
    if(is.null(vars$foto_transferencia) & input$pago_medio != "Efectivo"){
      shinyalert(
        type = "error",
        title = "Debes subir la foto del comprobante de la transferencia"
      )
    }else{
      trans <- vars$show_trans
      if(!is.null(input$cobro_agencia)){
        agencia <- vars$agencias$id[vars$agencias$name == input$cobro_agencia]
      }else{
        agencia <- trans$id_agencia
      }
      
      cobros_anteriores <- list_table_var1_var2_mysql(paste0(co, "_pagos"), "id_pagado", trans$id, "ingreso", "si")
      
      #si es primer cobro de la oficina
      if(nrow(cobros_anteriores) == 0){
        monto_cobrado <- 0
        
        #nuevo generar cierre home
        if(trans$user != "gmayeregger@gmail.com"){
          inmo <- list_table_var_mysql("myplace_inmuebles", "id", trans$id_inmo)
          agen <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", trans$user)
          agencia_nam <- agencia_name(agen$agencia, vars$agencias, vars$franquicias)
          operacion <- trans$tipo
          stop <- TRUE
          intento <- 1
          while(stop){
            if(intento <= 5){
              generated <- generate_noticia_cierre(agen, agencia_nam, inmo, operacion, dir, session)
              if(generated){
                stop <- FALSE
                print("Cierre Home OK")
              }else{
                intento <- intento + 1
                print("Cierre Home FALLO")
              }
            }else{
              stop <- FALSE
            }
          }
        }
        
        #generar nuevas fichas para referidos en columna 2
        referidos <- list_table_var1_var2_mysql(paste0(co, "_referidos"), "id_inmo", trans$id_inmo, "tipo", vars$show_trans$tipo)
        
        if(nrow(referidos) != 0){
          
          referidos_interno <- referidos %>% filter(externo == "no")
          monto_ref_interno <- ifelse(nrow(referidos_interno) == 0, 0, round(sum(referidos_interno$monto), 2))

          comision <- trans$comision_a_cobrar - monto_ref_interno
          global <- comision*0.10
          split_oficina <- comision*0.90
          comision_asesor <- split_oficina*trans$comision_user/100

          update_var_table_mysql(comision_asesor, "comision_asesor", "id", trans$id, paste0(co, "_transacciones"))
          trans$comision_asesor <- comision_asesor
          vars$show_trans$comision_asesor <- comision_asesor
          
          for(i in 1:nrow(referidos)){
            print(i)
            referido <- referidos[i,]
            print(referido)
            agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", referido$user)
            user_comi <- agente$comision %>% str_extract("[0-9][0-9]") %>% as.numeric()
            
            comision_referido <- referido$monto
            global <- round(comision_referido*0.10, 2)
            oficina <- round((comision_referido - global)*(100 - user_comi)/100, 2)
            comi_asesor <- round((comision_referido - global - oficina), 2)
            
            
            if(referido$externo == "no"){
              new_trans_ref <- data.frame(
                id = new_id_table_mysql("id", paste0(co, "_transacciones"), "transaccion_", 12),
                fecha = as.character(now("America/Asuncion")),
                user = referido$user,
                id_inmo = referido$id_inmo,
                id_estado = trans$id,
                tipo = "referido",
                fase = "5",
                venta_alquiler = trans$venta_alquiler,
                fecha_cierre = trans$fecha_cierre,
                precio_cierre = trans$precio_cierre,
                comision_cierre = trans$comision_cierre,
                comision_a_cobrar = trans$comision_a_cobrar,
                comision_cobrada = input$fact_monto,
                comision_user = user_comi,
                moneda = referido$moneda,
                comision_asesor = comi_asesor,
                id_agencia = agente$agencia
              )
              print(new_trans_ref)
              
              user <- agente %>% mutate(
                pais_agencia = sapply(agencia, FUN = function(x){
                  ifelse(x == "Global Master Office", "Paraguay", ifelse(x %in% vars$agencias$id, vars$agencias$pais[vars$agencias$id == x], vars$franquicias$pais[vars$franquicias$id == x]))}),
                name_agencia = sapply(agencia, FUN = function(x){
                  ifelse(x == "Global Master Office", "Global Master Office", ifelse(x %in% vars$agencias$id, vars$agencias$name[vars$agencias$id == x], vars$franquicias$name[vars$franquicias$id == x]))})
              )
              user <- user %>% select(user = user, user_name = name, pais_agencia = pais_agencia, name_agencia = name_agencia)
              new_trans_full <- left_join(new_trans_ref, user, by = "user")
              
              save_mysql(new_trans_ref, paste0(co, "_transacciones"), FALSE)
              vars$office_trans_list <- rbind(vars$office_trans_list, new_trans_full)
              
              
              
              if(agente$agencia == "Global Master Office"){
                broker <- "daniel.ortiz@skyone.group"
              }else{
                brokers <- list_table_var1_var2_mysql("myplace_usuarios", "company", "skyone", "cargo", "Broker Manager")
                brokers <- brokers[!brokers$user %in% c("ana.cazal@skyone.com.py"),]
                broker <- brokers$user[brokers$agencia == agente$agencia]
              }

              print("broker")
              print(broker)
              new_trans <- data.frame(
                id = new_id_table_mysql("id", paste0(co, "_transacciones"), "transaccion_", 12),
                fecha = as.character(now("America/Asuncion")),
                user = broker,
                id_inmo = trans$id_inmo,
                id_estado = paste0("Pago referido a Global del ID:", as.integer(str_flatten(str_extract_all(trans$id_inmo, "\\d")[[1]]))),
                tipo = "Pago comisión a Global",
                fase = "5",
                venta_alquiler = trans$venta_alquiler,
                fecha_cierre = trans$fecha_cierre,
                precio_cierre = trans$precio_cierre,
                comision_cierre = trans$comision_cierre,
                comision_a_cobrar = trans$comision_a_cobrar,
                comision_cobrada = input$fact_monto,
                comision_user = user_comi,
                moneda = trans$moneda,
                comision_asesor = global,
                id_agencia = agente$agencia
              )

              save_mysql(new_trans, paste0(co, "_transacciones"), FALSE)
              
              new_trans$user_name <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", broker) %>% .$name
              new_trans$name_agencia <- ifelse(agente$agencia == "Global Master Office", "Global Master Office", ifelse(agente$agencia %in% vars$agencias$id, vars$agencias$name[vars$agencias$id == agente$agencia], vars$franquicias$name[vars$franquicias$id == agente$agencia]))
              new_trans$pais_agencia <- ifelse(agente$agencia == "Global Master Office", "Paraguay", ifelse(agente$agencia %in% vars$agencias$id, vars$agencias$pais[vars$agencias$id == agente$agencia], vars$franquicias$pais[vars$franquicias$id == agente$agencia]))
              
              vars$office_trans_list <- rbind(vars$office_trans_list, new_trans)
  
            }
          }
        }

      }else{
        monto_cobrado <- sum(cobros_anteriores$fact_monto)
      }
      
      saldo <- trans$comision_a_cobrar - monto_cobrado
      new_saldo <- input$fact_monto - saldo
      if(new_saldo > -0.02*trans$comision_a_cobrar){
        cobro_total <- TRUE
      }else{
        cobro_total <- FALSE
      }
      
      cobro_id <- new_id_table_mysql("id", paste0(co, "_pagos"), "pago_", 12)
      if(input$pago_medio != "Efectivo"){
        im <- image_read(vars$url_temp_foto_transferencia)
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        put_object_do(paste0("/", co, "/fotos-comprobantes/comisiones/", cobro_id, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        im <- image_scale(im, "300x")
        url <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/fotos-comprobantes/comisiones/", cobro_id, ".jpg")
      }else{
        url <- "https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/blank_inmo.jpg"
      }
      
      new_cobro <- data.frame(
        id = cobro_id,
        fecha = as.character(now("America/Asuncion")),
        ingreso = "si",
        id_pagado = trans$id,
        tipo = ifelse(trans$tipo == "captación", "comisión captación", "comisión colocación"),
        user = vars$user$user,
        agencia = agencia,
        medio = input$pago_medio,
        nro_trans = input$pago_nro_comp,
        img = url,
        fact_user = trans$user,
        fact_fecha = input$fact_fecha,
        fact_concepto = input$fact_concepto,
        fact_numero = input$fact_numero,
        fact_razon = input$fact_razon,
        fact_ruc = input$fact_ruc,
        fact_moneda = input$fact_moneda,
        fact_monto = input$fact_monto,
        cambio = cambio_dolar$venta
      )
      print(new_cobro)
      save_mysql(new_cobro, paste0(co, "_pagos"), FALSE)
      
      cobro_final <- monto_cobrado + input$fact_monto
      
      update_var_table_mysql(cobro_final, "comision_cobrada", "id", trans$id, paste0(co, "_transacciones"))
      trans$comision_cobrada <- cobro_final
      
      if(cobro_total){
        update_var_table_mysql(input$fact_moneda, "moneda", "id", trans$id, paste0(co, "_transacciones"))
        update_var_table_mysql(cobro_final, "comision_a_cobrar", "id", trans$id, paste0(co, "_transacciones"))
        update_var_table_mysql(agencia, "id_agencia", "id", trans$id, paste0(co, "_transacciones"))
        update_var_table_mysql("5", "fase", "id", trans$id, paste0(co, "_transacciones"))
        update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", trans$id, paste0(co, "_transacciones"))
        update_var_table_mysql("5", "fase", "id", trans$id_estado, paste0(co, "_estados"))
        
        trans$fecha <- as.character(now("America/Asuncion"))
        trans$moneda <- input$fact_moneda
        trans$comision_a_cobrar <- cobro_final
        trans$id_agencia <- agencia
        trans$fase <- "5"
        
        #Generar un nuevo pago pendiente de comisión con Global
        if(agencia == "Global Master Office"){
          broker <- "daniel.ortiz@skyone.group"
        }else{
          brokers <- list_table_var1_var2_mysql("myplace_usuarios", "company", "skyone", "cargo", "Broker Manager")
          brokers <- brokers[!brokers$user %in% c("ana.cazal@skyone.com.py"),]
          broker <- brokers$user[brokers$agencia == agencia]
        }
        
        referidos_interno <- list_table_var1_var2_var3_mysql(paste0(co, "_referidos"), "id_inmo", trans$id_inmo, "tipo", vars$show_trans$tipo, "externo", "IN", "no")
        
        if(nrow(referidos_interno) != 0){
          monto_ref_interno <- round(sum(referidos_interno$monto), 2)
        }else{
          monto_ref_interno <- 0
        }
        
        new_trans <- data.frame(
          id = new_id_table_mysql("id", paste0(co, "_transacciones"), "transaccion_", 12),
          fecha = as.character(now("America/Asuncion")),
          user = broker,
          id_inmo = trans$id_inmo,
          id_estado = paste0("Pago ", trans$tipo, " a Global del ID:", as.integer(str_flatten(str_extract_all(trans$id_inmo, "\\d")[[1]]))),
          tipo = "Pago comisión a Global",
          fase = "5",
          venta_alquiler = trans$venta_alquiler,
          fecha_cierre = trans$fecha_cierre,
          precio_cierre = trans$precio_cierre,
          comision_cierre = trans$comision_cierre,
          comision_a_cobrar = trans$comision_a_cobrar,
          comision_cobrada = cobro_final,
          comision_user = trans$comision_user,
          moneda = trans$moneda,
          comision_asesor = round((trans$comision_a_cobrar - monto_ref_interno)*0.10, 2),
          id_agencia = trans$id_agencia
        )
        save_mysql(new_trans, paste0(co, "_transacciones"), FALSE)
        
        new_trans$user_name <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", broker) %>% .$name
        new_trans$name_agencia <- ifelse(agencia == "Global Master Office", "Global Master Office", ifelse(agencia %in% vars$agencias$id, vars$agencias$name[vars$agencias$id == agencia], vars$franquicias$name[vars$franquicias$id == agencia]))
        new_trans$pais_agencia <- ifelse(agencia == "Global Master Office", "Paraguay", ifelse(agencia %in% vars$agencias$id, vars$agencias$pais[vars$agencias$id == agencia], vars$franquicias$pais[vars$franquicias$id == agencia]))
        
        vars$office_trans_list <- rbind(vars$office_trans_list, new_trans)
        
      }
      
      vars$office_trans_list[vars$office_trans_list$id == trans$id, ] <- trans
      
      vars$show_trans <- NULL
      vars$foto_transferencia <- NULL
      removeModal()
    }
  })
  
  observeEvent(input$pago_comision_trans, {
    req(vars$show_trans)
    trans <- vars$show_trans
    vars$foto_transferencia <- NULL
    agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", trans$user)
    pagos_anteriores <- list_table_var1_var2_mysql(paste0(co, "_pagos"), "id_pagado", trans$id, "ingreso", "no")
    if(nrow(pagos_anteriores) == 0){
      monto_pagado <- 0
    }else{
      monto_pagado <- sum(pagos_anteriores$fact_monto)
    }
    referidos <- ifelse(nrow(vars$referidos) == 0, 0, round(vars$referidos$monto, 2))
    
    showModal(modalDialog(
      div(id = "inline",
          fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                    h4(paste0("Datos de la factura del Asesor ", agente$name)),
                    fluidRow(
                      column(6,
                             textInput("fact_numero", "Número de factura"),
                             textInput("fact_razon", "Razón social", value = agente$razon),
                             textInput("fact_ruc", "RUC", value = agente$ruc),
                             dateInput("fact_fecha", "Fecha", language = "es")
                      ),
                      column(6,
                             textInput("fact_concepto", "Concepto", value = "Pago de comisión"),
                             radioButtons("fact_moneda", "Moneda", inline = TRUE, choices = c("USD", "GS"), selected = trans$moneda),
                             autonumericInput(inputId = "fact_monto", align = "left",
                                              label = "Monto", 
                                              value = trans$comision_asesor - referidos - monto_pagado, 
                                              currencySymbol = ifelse(trans$moneda == "USD", "$ ", "Gs "), 
                                              currencySymbolPlacement = "p",
                                              decimalPlaces = ifelse(trans$moneda == "USD", 2, 0), digitGroupSeparator = ".", decimalCharacter = ",")
                      )
                    )
          ),
          fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                    h4("Datos de la operación"),
                    fluidRow(
                      column(6,
                             selectInput("pago_medio", "Medio de pago", choices = c("Transferencia", "Efectivo", "Cheque"))
                      ),
                      column(6,
                             textInput("pago_nro_comp", "Número de comprobante")
                      )
                    ),
                    uiOutput("image_transferencia"),
                    div(
                      fileInput(inputId = "upload_transferencia_pago",
                                label = NULL,
                                buttonLabel = "Escoje la foto",
                                placeholder = "no hay foto",
                                multiple = TRUE,
                                accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
                      align = "center"),
          ),
      ),
      tags$div(id="bttn_modal", 
               actionBttn("pago_comision_trans_ok", "Pagar"),
               actionBttn("close_pago_transferencia", "Cancelar"),
               align = "center"),
      title = "Pago de comisión",
      easyClose = FALSE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  observeEvent(input$pago_comision_trans_ok, {
    #trans <- list_table_var_mysql("skyone_transacciones", "id", "transaccion_000000003272")
    req(vars$show_trans)
    
    print("vars$show_trans")
    print(vars$show_trans)
    print("vars$referidos")
    print(vars$referidos)
    if(is.null(vars$foto_transferencia) & input$pago_medio != "Efectivo"){
      shinyalert(
        type = "error",
        title = "Debes subir la foto del comprobante de la transferencia"
      )
    }else{
      trans <- vars$show_trans
      if(!is.null(input$pago_agencia)){
        agencia <- vars$agencias$id[vars$agencias$name == input$pago_agencia]
      }else{
        agencia <- trans$id_agencia
      }
      
      pagos_anteriores <- list_table_var1_var2_mysql(paste0(co, "_pagos"), "id_pagado", trans$id, "ingreso", "no")
      
      if(nrow(pagos_anteriores) == 0){
        monto_pagado <- 0
      }else{
        monto_pagado <- sum(pagos_anteriores$fact_monto)
      }
      referidos <- ifelse(nrow(vars$referidos) == 0, 0, round(trans$precio_cierre*trans$comision_cierre/100*0.50*sum(vars$referidos$comision)/100))
      
      saldo <- trans$comision_asesor - monto_pagado - referidos
      new_saldo <- input$fact_monto - saldo
      if(new_saldo > -0.02*trans$comision_asesor){
        pago_total <- TRUE
      }else{
        pago_total <- FALSE
      }
      
      #modificado referido
      if(trans$tipo == "referido"){
        cobros_anteriores <- list_table_var1_var2_mysql(paste0(co, "_pagos"), "id_pagado", trans$id_estado, "ingreso", "si")
      }else{
        cobros_anteriores <- list_table_var1_var2_mysql(paste0(co, "_pagos"), "id_pagado", trans$id, "ingreso", "si")
      }
      
      if(nrow(cobros_anteriores) == 0){
        monto_cobrado <- 0
      }else{
        monto_cobrado <- sum(cobros_anteriores$fact_monto)
      }
      
      new_saldo_cobro <- input$fact_monto - (trans$comision_a_cobrar - monto_cobrado)
      if(new_saldo_cobro > -0.02*trans$comision_a_cobrar){
        cobro_total <- TRUE
      }else{
        cobro_total <- FALSE
      }
      
      if(cobro_total == FALSE & pago_total == TRUE){
        shinyalert(
          type = "error",
          title = "No puedes cancelar el pago a un asesor sin haber cancelado primero el cobro de la oficina"
        )
      }else{
        pago_id <- new_id_table_mysql("id", paste0(co, "_pagos"), "pago_", 12)
        if(input$pago_medio != "Efectivo"){
          im <- image_read(vars$url_temp_foto_transferencia)
          image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
          put_object_do(paste0("/", co, "/fotos-comprobantes/comisiones/", pago_id, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
          im <- image_scale(im, "300x")
          url <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/fotos-comprobantes/comisiones/", pago_id, ".jpg")
        }else{
          url <- "https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/blank_inmo.jpg"
        }
        
        new_pago <- data.frame(
          id = pago_id,
          fecha = as.character(now("America/Asuncion")),
          ingreso = "no",
          id_pagado = trans$id,
          tipo = ifelse(trans$tipo == "captación", "comisión captación", "comisión colocación"),
          user = vars$user$user,
          agencia = agencia,
          medio = input$pago_medio,
          nro_trans = input$pago_nro_comp,
          img = url,
          fact_user = trans$user,
          fact_fecha = input$fact_fecha,
          fact_concepto = input$fact_concepto,
          fact_numero = input$fact_numero,
          fact_razon = input$fact_razon,
          fact_ruc = input$fact_ruc,
          fact_moneda = input$fact_moneda,
          fact_monto = input$fact_monto,
          cambio = cambio_dolar$venta
        )
        print(new_pago)
        save_mysql(new_pago, paste0(co, "_pagos"), FALSE)
        
        if(pago_total){
          pago_final <- monto_pagado + input$fact_monto
          update_var_table_mysql(input$fact_moneda, "moneda", "id", trans$id, paste0(co, "_transacciones"))
          update_var_table_mysql(pago_final, "comision_asesor", "id", trans$id, paste0(co, "_transacciones"))
          update_var_table_mysql(agencia, "id_agencia", "id", trans$id, paste0(co, "_transacciones"))
          update_var_table_mysql("6", "fase", "id", trans$id, paste0(co, "_transacciones"))
          update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", trans$id, paste0(co, "_transacciones"))
          if(trans$tipo %in% c("captación", "colocación")){
            update_var_table_mysql("6", "fase", "id", trans$id_estado, paste0(co, "_estados"))
          }
          trans$fecha <- as.character(now("America/Asuncion"))
          trans$moneda <- input$fact_moneda
          trans$comision_asesor <- pago_final
          trans$id_agencia <- agencia
          trans$fase <- "6"
          
          vars$office_trans_list[vars$office_trans_list$id == trans$id, ] <- trans
        }
        
        vars$show_trans <- NULL
        removeModal()
      }
    }
  })
  
  observeEvent(input$pagar_global_ok, {
    req(vars$show_trans)
    if(is.null(vars$foto_transferencia) & input$pago_medio != "Efectivo"){
      shinyalert(
        type = "error",
        title = "Debes subir la foto del comprobante de la transferencia"
      )
    }else{
      trans <- vars$show_trans
      
      pago_id <- new_id_table_mysql("id", paste0(co, "_pagos"), "pago_", 12)
      if(input$pago_medio != "Efectivo"){
        im <- image_read(vars$url_temp_foto_transferencia)
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        put_object_do(paste0("/", co, "/fotos-comprobantes/comisiones/", pago_id, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        im <- image_scale(im, "300x")
        url <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/fotos-comprobantes/comisiones/", pago_id, ".jpg")
      }else{
        url <- "https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/blank_inmo.jpg"
      }
      
      new_pago <- data.frame(
        id = pago_id,
        fecha = as.character(now("America/Asuncion")),
        ingreso = "no",
        id_pagado = trans$id,
        tipo = trans$tipo,
        user = vars$user$user,
        agencia = trans$id_agencia,
        medio = input$pago_medio,
        nro_trans = input$pago_nro_comp,
        img = url,
        fact_user = "Global Master Office",
        fact_fecha = input$fact_fecha,
        fact_concepto = input$fact_concepto,
        fact_numero = input$fact_numero,
        fact_razon = input$fact_razon,
        fact_ruc = input$fact_ruc,
        fact_moneda = trans$moneda,
        fact_monto = input$fact_monto,
        cambio = cambio_dolar$venta
      )
      print(new_pago)
      save_mysql(new_pago, paste0(co, "_pagos"), FALSE)
      
      update_var_table_mysql(input$fact_monto, "comision_asesor", "id", trans$id, paste0(co, "_transacciones"))
      update_var_table_mysql("6", "fase", "id", trans$id, paste0(co, "_transacciones"))
      update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", trans$id, paste0(co, "_transacciones"))
      
      trans$fecha <- as.character(now("America/Asuncion"))
      trans$comision_asesor <- input$fact_monto
      trans$fase <- "6"
      
      vars$office_trans_list[vars$office_trans_list$id == trans$id, ] <- trans
      
      vars$show_trans <- NULL
      removeModal()
    }
  })
  
  observeEvent(input$pagar_place_ok, {
    req(vars$show_trans)
    if(is.null(vars$foto_transferencia) & input$pago_medio != "Efectivo"){
      shinyalert(
        type = "error",
        title = "Debes subir la foto del comprobante de la transferencia"
      )
    }else{
      trans <- vars$show_trans
      
      pago_id <- new_id_table_mysql("id", paste0(co, "_pagos"), "pago_", 12)
      if(input$pago_medio != "Efectivo"){
        im <- image_read(vars$url_temp_foto_transferencia)
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        put_object_do(paste0("/", co, "/fotos-comprobantes/comisiones/", pago_id, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        im <- image_scale(im, "300x")
        url <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/fotos-comprobantes/comisiones/", pago_id, ".jpg")
      }else{
        url <- "https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/blank_inmo.jpg"
      }
      
      new_pago <- data.frame(
        id = pago_id,
        fecha = as.character(now("America/Asuncion")),
        ingreso = "no",
        id_pagado = trans$id,
        tipo = trans$tipo,
        user = vars$user$user,
        agencia = trans$id_agencia,
        medio = input$pago_medio,
        nro_trans = input$pago_nro_comp,
        img = url,
        fact_user = "Global Master Office",
        fact_fecha = input$fact_fecha,
        fact_concepto = input$fact_concepto,
        fact_numero = input$fact_numero,
        fact_razon = input$fact_razon,
        fact_ruc = input$fact_ruc,
        fact_moneda = trans$moneda,
        fact_monto = input$fact_monto,
        cambio = cambio_dolar$venta
      )
      print(new_pago)
      save_mysql(new_pago, paste0(co, "_pagos"), FALSE)
      
      update_var_table_mysql(input$fact_monto, "comision_asesor", "id", trans$id, paste0(co, "_transacciones"))
      update_var_table_mysql("6", "fase", "id", trans$id, paste0(co, "_transacciones"))
      update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", trans$id, paste0(co, "_transacciones"))
      
      trans$fecha <- as.character(now("America/Asuncion"))
      trans$comision_asesor <- input$fact_monto
      trans$fase <- "6"
      
      vars$office_trans_list[vars$office_trans_list$id == trans$id, ] <- trans
      
      vars$show_trans <- NULL
      removeModal()
    }
  })
  
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #office_prop
  
  output$office_prop_filtros_ui <- renderUI({
    if(office_prop_on() == 1){
      req(vars$office_prop_list)
      
      fluidRow(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; margin-left: 0px"),
               column(10, tags$div(id = "inline",
                                   div(
                                     div(class = "btn-group",
                                         dateRangeInput("office_prop_filt_fecha_cr", 
                                                        "Fecha de creación",
                                                        start = as_date(min(vars$office_prop_list$fecha_creacion)),
                                                        end = as_date(now("America/Asuncion")), 
                                                        min = "2019-01-01", max = as_date(now("America/Asuncion")), separator = "hasta",
                                                        language = "es")
                                     ),
                                     div(class = "btn-group",
                                         dateRangeInput("office_prop_filt_fecha_ed", 
                                                        "Fecha de edición",
                                                        start = as_date(min(vars$office_prop_list$fecha_creacion)),
                                                        end = as_date(now("America/Asuncion")), 
                                                        min = "2019-01-01", max = as_date(now("America/Asuncion")), separator = "hasta",
                                                        language = "es") 
                                     ),
                                     div(class = "btn-group",
                                         dateRangeInput("office_prop_filt_fecha_ini_cont", 
                                                        "Fecha de inicio contrato (Exclusividades)",
                                                        start = as_date(min(vars$office_prop_list$fecha_creacion)),
                                                        end = as_date(now("America/Asuncion")), 
                                                        min = "2019-01-01", max = as_date(now("America/Asuncion")), separator = "hasta",
                                                        language = "es")
                                     ),
                                     div(style = "width: 110px; margin: 5px; margin-top: 10px", class = "btn-group",
                                         selectInput("office_prop_filt_borrador", "Publicación", choices = c("Borradores", "Publicadas", "Externas", "Cerradas", "Inactivas", "Vencidas"))),
                                     div(style = "width: 110px; margin: 5px; margin-top: 10px", class = "btn-group",
                                         selectInput("office_prop_filt_contrato", "Contrato", choices = c("Todos", "Exclusividad", "Autorizacion", "Acuerdo de proyecto", 
                                                                                                          "Presentacion de cliente", "Sin contrato"))),
                                     div(style = "width: 110px; margin: 5px; margin-top: 10px", class = "btn-group",
                                         selectInput("office_prop_filt_visible", "Portal", choices = c("Visibles", "No visibles"))),
                                     div(style = "width: 120px; margin: 5px; margin-top: 10px", class = "btn-group",
                                         selectInput("office_prop_filt_pais", "País", choices = c("Todos", unique(vars$office_prop_list$pais_agencia)))),
                                     div(style = "width: 180px; margin: 5px; margin-top: 10px", class = "btn-group",
                                         uiOutput("office_prop_agencia_sel_ui")),
                                     div(style = "width: 180px; margin: 5px; margin-top: 10px", class = "btn-group",
                                         uiOutput("office_prop_agente_sel_ui")),
                                   ),
                                   div(
                                     div(style = "width: 110px; margin: 5px", class = "btn-group",
                                         selectInput("office_prop_filt_trans", "Transacción", 
                                                     choices = c("Todos", "Venta", "Alquiler", "Alquiler temporal"))),
                                     div(style = "width: 110px; margin: 5px", class = "btn-group",
                                         selectInput("office_prop_filt_tipo", "Tipo propiedad",
                                                     choices = c("Todos", "Terreno", "Casa", "Duplex", "Departamento", "Proyecto", "Deposito", "Tinglado", "Oficina", "Salón comercial",
                                                                 "Propiedad rural", "Casa quinta", "Edificio", "Rural Externa"))),
                                     div(style = "width: 80px; margin: 5px; margin-top: -10px", class = "btn-group",
                                         numericInput3("office_prop_filt_codigo", "Código", value = NULL)),
                                     div(style = "width: 80px; margin: 5px; margin-left: 25px", class = "btn-group",
                                         textInput("office_prop_filt_palabra", "Buscar")),
                                     div(style = "margin: 20px; margin-top: 27px; margin-left: 10px", class = "btn-group",
                                         div(id="bttn_modal",
                                             actionButton("office_prop_palabra_ok", NULL, icon = icon("search"))
                                         )
                                     )
                                   )
               )
               ),
               column(2, uiOutput("contador_prop_office_ui"), align = "right")
      )
    }
  })
  
  output$office_prop_agencia_sel_ui <- renderUI({
    req(input$office_prop_filt_pais)
    if(input$office_prop_filt_pais != "Todos"){
      selectInput("office_prop_filt_agencia", "Oficina", choices = c("Todos", unique(vars$office_prop_list$name_agencia[vars$office_prop_list$pais_agencia == input$office_prop_filt_pais])))
    }else{
      selectInput("office_prop_filt_agencia", "Oficina", choices = c("Todos", unique(vars$office_prop_list$name_agencia)))
    }
  })
  
  output$office_prop_agente_sel_ui <- renderUI({
    req(input$office_prop_filt_pais, input$office_prop_filt_agencia)
    
    if(input$office_prop_filt_pais != "Todos"){
      inmos <- vars$office_prop_list[vars$office_prop_list$pais_agencia == input$office_prop_filt_pais,]
    }else{
      inmos <- vars$office_prop_list
    }
    
    if(input$office_prop_filt_agencia != "Todos"){
      selectInput("office_prop_filt_agente", "Asesor", choices = c("Todos", unique(inmos$name[inmos$name_agencia == input$office_prop_filt_agencia])))
    }else{
      selectInput("office_prop_filt_agente", "Asesor", choices = c("Todos", unique(inmos$name)))
    }
  })
  
  output$contador_prop_office_ui <- renderUI({
    h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                   nrow(vars$data_all_pages), "</span></p>")))
  })
  
  output$box_office_prop_ui <- renderUI({
    if(office_prop_on() == 1){
      fluidPage(
        div(style = "position: sticky; width: 100%; z-index: 5",
            uiOutput("office_prop_filtros_ui"),
            br(),
            div(uiOutput("box_inmo_list_ui"), align = "center"),
            uiOutput("page_ui"),
            uiOutput("cont_page_ui")
        )    
      )
    }
  })
  
  observe({
    req(vars$office_prop_list, input$office_prop_filt_borrador)
    input$office_prop_palabra_ok
    if(office_prop_on() == 1){
      if(nrow(vars$office_prop_list) == 0){
        all_pages <- data.frame()
      }else{
        id_bus <- "skyone_inmueble_0000010233"
        if(input$office_prop_filt_borrador == "Borradores"){
          all_pages <- vars$office_prop_list %>% filter(borrador == "si" & precio_cierre == 0 & activo == "si" & externa == "no")
          print(paste0("1 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
          
        }else{
          if(input$office_prop_filt_borrador == "Publicadas"){
            all_pages <- vars$office_prop_list %>% filter(borrador == "no" & externa == "no" & precio_cierre == 0 & activo == "si")
          }else{
            if(input$office_prop_filt_borrador == "Externas"){
              all_pages <- vars$office_prop_list %>% filter(externa == "si" & precio_cierre == 0 & activo == "si")
            }else{
              if(input$office_prop_filt_borrador == "Cerradas"){
                all_pages <- vars$office_prop_list %>% filter(precio_cierre != 0 & activo == "si")
              }else{
                if(input$office_prop_filt_borrador == "Inactivas"){
                  all_pages <- vars$office_prop_list %>% filter(activo == "no")
                }else{
                  if(input$office_prop_filt_borrador == "Vencidas"){
                    all_pages <- vars$office_prop_list %>% filter(borrador == "no" & externa == "no" & 
                                                                    precio_cierre == 0 & activo == "si" &
                                                                    tipo_contrato != "Sin contrato" &
                                                                    !is.na(ini_contrato) & 
                                                                    !is.na(fin_contrato))
                    all_pages <- all_pages %>% filter(ifelse(tipo_contrato == "Exclusividad",
                                                             fin_contrato,
                                                             as.character(as_date(ini_contrato) + months(6)))
                                                      < as.character(now("America/Asuncion")))
                  }
                }
              }
            }
          }
        }
        
        all_pages <- all_pages %>% filter(fecha_creacion >= input$office_prop_filt_fecha_cr[1] & fecha_creacion <= input$office_prop_filt_fecha_cr[2])
        print(paste0("2 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        
        all_pages <- all_pages %>% filter(fecha >= input$office_prop_filt_fecha_ed[1] & fecha <= input$office_prop_filt_fecha_ed[2])
        print(paste0("3 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        
        if(input$office_prop_filt_contrato == "Exclusividad"){
          all_pages <- all_pages %>% filter(ini_contrato >= input$office_prop_filt_fecha_ini_cont[1] & ini_contrato <= input$office_prop_filt_fecha_ini_cont[2])
          print(paste0("4 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        }
        
        if(!is.null(input$office_prop_filt_contrato) && input$office_prop_filt_contrato != "Todos"){
          all_pages <- all_pages %>% filter(tipo_contrato == input$office_prop_filt_contrato)
        }
        print(paste0("5 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        
        if(!is.null(input$office_prop_filt_visible) && input$office_prop_filt_visible == "Visibles"){
          all_pages <- all_pages %>% filter(publicado == "si")
        }else{
          all_pages <- all_pages %>% filter(publicado == "no")
        }
        print(paste0("6 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        
        if(!is.null(input$office_prop_filt_pais) && input$office_prop_filt_pais != "Todos"){
          all_pages <- all_pages %>% filter(pais_agencia == input$office_prop_filt_pais)
        }
        print(paste0("7 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        
        if(!is.null(input$office_prop_filt_agencia) && input$office_prop_filt_agencia != "Todos"){
          all_pages <- all_pages %>% filter(name_agencia == input$office_prop_filt_agencia)
        }
        print(paste0("8 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        
        if(!is.null(input$office_prop_filt_agente) && input$office_prop_filt_agente != "Todos"){
          all_pages <- all_pages %>% filter(name == input$office_prop_filt_agente)
        }
        print(paste0("9 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        
        if(input$office_prop_filt_trans != "Todos"){
          all_pages <- all_pages[all_pages$venta_alquiler == input$office_prop_filt_trans,]
        }
        print(paste0("10 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        
        if(input$office_prop_filt_tipo != "Todos"){
          all_pages <- all_pages[all_pages$tipoPropiedad == input$office_prop_filt_tipo,]
        }
        print(paste0("11 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        
        if(!is.na(isolate(input$office_prop_filt_codigo))){
          codigos <- lapply(all_pages$id, FUN = function(i){
            as.integer(str_flatten(str_extract_all(i, "\\d")[[1]]))
          }) %>% unlist()
          all_pages <- all_pages[codigos == isolate(input$office_prop_filt_codigo),]
        }
        print(paste0("12 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        
        if(isolate(input$office_prop_filt_palabra) != ""){
          all_pages <- all_pages %>% filter(str_detect(str_to_lower(titulo), str_to_lower(isolate(input$office_prop_filt_palabra))) |
                                              str_detect(str_to_lower(descripcion), str_to_lower(isolate(input$office_prop_filt_palabra))))
        }
        print(paste0("13 id ", id_bus, ": ", ifelse(id_bus %in% all_pages$id, "si", "no")))
        
      }
      
      if(nrow(all_pages) != 0){
        vars$page_selected <- 1
        vars$data_all_pages <- all_pages %>% arrange(desc(fecha))
        vars$data_per_page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, 1)$data
      }else{
        vars$page_selected <- 1
        vars$data_all_pages <- data.frame()
        vars$data_per_page <- data.frame()
      }
    }
  })
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #office_cont
  
  output$box_office_cont_ui <- renderUI({
    if(office_cont_on() == 1){
      fluidPage(
        div(style = "position: sticky; width: 100%; z-index: 5",
            uiOutput("office_cont_filtros_ui"),
            br(),
            fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                      if(office_cont_caja_on() == 1){
                        div(
                          div(id = "inline", style = "margin: 5px; margin-top: 10px", class = "btn-group",
                              actionButton("office_cont_caja_ingreso", "Ingreso")
                          ),
                          div(id = "inline", style = "margin: 5px; margin-top: 10px", class = "btn-group",
                              actionButton("office_cont_caja_egreso", "Egreso")
                          ),
                          div(style = 'overflow-x: scroll',DT::dataTableOutput("table_office_cont_caja",width = "100%"))
                        )
                      }else{
                        if(office_cont_cobro_on() == 1){
                          uiOutput("office_cont_cobro_ui")
                        }else{
                          if(office_cont_pago_on() == 1){
                            uiOutput("office_cont_pago_ui")
                          }
                        }
                      },
                      uiOutput("office_cont_totales_ui")
            )
        )    
      )
    }
  })
  
  output$office_cont_filtros_ui <- renderUI({
    if(office_cont_on() == 1){
      req(vars$office_cont_list_all)
      fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                tags$div(id = "inline",
                         div(style = "margin: 10px",
                             div(class = "btn-group",
                                 actionButton("office_cont_caja_on_off", "Caja",
                                              style = ifelse(office_cont_caja_on() == 1, 
                                                             paste0("border-radius: 10px; background-color: ", main_color, ";
                                                         font-size: 130%; color: white;
                                                         border: 2px solid ", main_color),
                                                             paste0("border-radius: 10px; background-color: white;
                                                         font-size: 130%; color: ", main_color, ";
                                                         border: 2px solid ", main_color)))
                             ),
                             div(class = "btn-group", style = "margin-left: 5px",
                                 actionButton("office_cont_cobro_on_off", "Cuentas por Cobrar",
                                              style = ifelse(office_cont_cobro_on() == 1, 
                                                             paste0("border-radius: 10px; background-color: ", main_color, ";
                                                         font-size: 130%; color: white;
                                                         border: 2px solid ", main_color),
                                                             paste0("border-radius: 10px; background-color: white;
                                                         font-size: 130%; color: ", main_color, ";
                                                         border: 2px solid ", main_color)))
                             ),
                             div(class = "btn-group", style = "margin-left: 5px",
                                 actionButton("office_cont_pago_on_off", "Cuentas por Pagar",
                                              style = ifelse(office_cont_pago_on() == 1, 
                                                             paste0("border-radius: 10px; background-color: ", main_color, ";
                                                         font-size: 130%; color: white;
                                                         border: 2px solid ", main_color),
                                                             paste0("border-radius: 10px; background-color: white;
                                                         font-size: 130%; color: ", main_color, ";
                                                         border: 2px solid ", main_color)))
                             )
                         ),
                         div(id = "inline", style = "margin: 5px; margin-top: 20px",
                             div(class = "btn-group", style = "width: 100px",
                                 selectInput("office_cont_filt_mes", NULL, choices = meses$name, 
                                             selected = meses$name[meses$number == month(now("America/Asuncion"))])
                             ),
                             div(class = "btn-group", style = "width: 100px",
                                 selectInput("office_cont_filt_anio", NULL, choices = unique(year(vars$office_cont_list_all$fecha)), 
                                             selected = year(now("America/Asuncion")))
                             )
                         )
                )
      )
    }
  })  
  
  observeEvent(input$office_cont_caja_on_off, {
    if(office_cont_caja_on() == 0){
      office_cont_caja_on(1)
      office_cont_cobro_on(0)
      office_cont_pago_on(0)
    }
  })
  
  observeEvent(input$office_cont_cobro_on_off, {
    if(office_cont_cobro_on() == 0){
      office_cont_caja_on(0)
      office_cont_cobro_on(1)
      office_cont_pago_on(0)
    }
  })
  
  observeEvent(input$office_cont_pago_on_off, {
    if(office_cont_pago_on() == 0){
      office_cont_caja_on(0)
      office_cont_cobro_on(0)
      office_cont_pago_on(1)
    }
  })
  
  observe({
    if(office_cont_on() == 1 & office_cont_caja_on() == 1){
      req(vars$office_cont_list_all, input$office_cont_filt_anio, input$office_cont_filt_mes)
      print(input$office_cont_filt_anio)
      print(input$office_cont_filt_mes)
      vars$office_cont_list <- vars$office_cont_list_all %>% 
        filter(year(fecha) == input$office_cont_filt_anio & 
                 month(fecha) == meses$number[meses$name == input$office_cont_filt_mes])
    }
  })
  
  output$table_office_cont_caja <- renderDataTable({
    req(vars$office_cont_list)
    
    data <- vars$office_cont_list %>% mutate(ingresos = ifelse(ingreso == "si", fact_monto, 0),
                                             egresos = ifelse(ingreso == "no", fact_monto, 0),
                                             cambio = ifelse(fact_moneda == "GS", as.character(cambio), "")) %>%
      select(fecha, cuenta = tipo, moneda = fact_moneda, cambio, ingresos, egresos)
    
    datatable(data, options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                                   dom = 'ft'), rownames = FALSE, escape = FALSE,
              editable = FALSE, selection = "none")
  })
  
  output$office_cont_totales_ui <- renderUI({
    req(vars$office_cont_list)
    data <- vars$office_cont_list
    data$fact_monto <- ifelse(data$fact_moneda == "GS", round(data$fact_monto/data$cambio, 2), round(data$fact_monto, 2))
    ingresos <- sum(data$fact_monto[data$ingreso == "si"])
    egresos <- sum(data$fact_monto[data$ingreso == "no"])
    div(
      br(),
      h3(HTML(paste0("<b>Total ingresos: </b>USD ", format(ingresos, big.mark = ".", decimal.mark = ",", scientific = FALSE)))),
      h3(HTML(paste0("<b>Total egresos: </b>USD ", format(egresos, big.mark = ".", decimal.mark = ",", scientific = FALSE)))),
      h3(HTML(paste0("<b>Total: </b>USD ", format(ingresos - egresos, big.mark = ".", decimal.mark = ",", scientific = FALSE))))
    )
  })
  
  observeEvent(input$office_cont_caja_egreso, {
      vars$foto_transferencia <- NULL
    
    showModal(modalDialog(
      div(id = "inline",
          fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                    h4("Datos de la factura"),
                    fluidRow(
                      column(6,
                             textInput("fact_numero", "Número de factura"),
                             textInput("fact_razon", "Razón social"),
                             textInput("fact_ruc", "RUC"),
                             dateInput("fact_fecha", "Fecha", language = "es")
                      ),
                      column(6,
                             selectInput("fact_tipo", "Motivo de pago", choices = c("Insumos de Oficina", "Salario", "Expensas", "Pagos varios")),
                             textInput("fact_concepto", "Concepto"),
                             radioButtons("fact_moneda", "Moneda", inline = TRUE, choices = c("USD", "GS")),
                             autonumericInput(inputId = "fact_monto", align = "left",
                                              label = "Monto", 
                                              value = 0, 
                                              currencySymbol = "$", 
                                              currencySymbolPlacement = "p",
                                              decimalPlaces = 2, digitGroupSeparator = ".", decimalCharacter = ",")
                      )
                    )
          ),
          fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                    h4("Datos de la operación"),
                    fluidRow(
                      column(6,
                             selectInput("pago_medio", "Medio de pago", choices = c("Transferencia", "Efectivo", "Cheque"))
                      ),
                      column(6,
                             textInput("pago_nro_comp", "Número de comprobante")
                      )
                    ),
                    uiOutput("image_transferencia"),
                    div(
                      fileInput(inputId = "upload_transferencia_pago",
                                label = NULL,
                                buttonLabel = "Escoje la foto",
                                placeholder = "no hay foto",
                                multiple = TRUE,
                                accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
                      align = "center"),
          ),
      ),
      tags$div(id="bttn_modal", 
               actionBttn("office_cont_caja_egreso_ok", "Pagar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Asentar egreso",
      easyClose = TRUE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  observeEvent(input$office_cont_caja_egreso_ok, {
    if(is.null(vars$foto_transferencia) & input$pago_medio != "Efectivo"){
      shinyalert(
        type = "error",
        title = "Debes subir la foto del comprobante de la transferencia"
      )
    }else{
      pago_id <- new_id_table_mysql("id", paste0(co, "_pagos"), "pago_", 12)
      if(input$pago_medio != "Efectivo"){
        im <- image_read(vars$url_temp_foto_transferencia)
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        put_object_do(paste0("/", co, "/fotos-comprobantes/comisiones/", pago_id, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        im <- image_scale(im, "300x")
        url <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/fotos-comprobantes/comisiones/", pago_id, ".jpg")
      }else{
        url <- "https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/blank_inmo.jpg"
      }
      
      new_pago <- data.frame(
        id = pago_id,
        fecha = as.character(now("America/Asuncion")),
        ingreso = "no",
        id_pagado = NA,
        tipo = input$fact_tipo,
        user = vars$user$user,
        agencia = vars$user$agencia,
        medio = input$pago_medio,
        nro_trans = input$pago_nro_comp,
        img = url,
        fact_user = NA,
        fact_fecha = input$fact_fecha,
        fact_concepto = input$fact_concepto,
        fact_numero = input$fact_numero,
        fact_razon = input$fact_razon,
        fact_ruc = input$fact_ruc,
        fact_moneda = input$fact_moneda,
        fact_monto = input$fact_monto,
        cambio = cambio_dolar$venta
      )
      print(new_pago)
      save_mysql(new_pago, paste0(co, "_pagos"), FALSE)
      
      vars$office_cont_list_all <- rbind(vars$office_cont_list_all, new_pago)
      
      removeModal()
    }
  })
  
  observeEvent(input$office_cont_caja_ingreso, {
    vars$foto_transferencia <- NULL
    
    id_agencia <- vars$user$agencia
    
    ruc <- ifelse(id_agencia == "Global Master Office", global_ruc, ifelse(id_agencia %in% vars$agencias$id, vars$agencias$ruc[vars$agencias$id == id_agencia], vars$franquicias$ruc[vars$franquicias$id == id_agencia]))
    razon <- ifelse(id_agencia == "Global Master Office", global_razon, ifelse(id_agencia %in% vars$agencias$id, vars$agencias$razon[vars$agencias$id == id_agencia], vars$franquicias$razon[vars$franquicias$id == id_agencia]))
    
    showModal(modalDialog(
      div(id = "inline",
          fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                    h4("Datos de la factura"),
                    fluidRow(
                      column(6,
                             textInput("fact_numero", "Número de factura"),
                             textInput("fact_razon", "Razón social"),
                             textInput("fact_ruc", "RUC"),
                             dateInput("fact_fecha", "Fecha", language = "es")
                      ),
                      column(6,
                             selectInput("fact_tipo", "Motivo de cobro", choices = c("Préstamo", "Aporte de socios")),
                             textInput("fact_concepto", "Concepto"),
                             radioButtons("fact_moneda", "Moneda", inline = TRUE, choices = c("USD", "GS")),
                             autonumericInput(inputId = "fact_monto", align = "left",
                                              label = "Monto", 
                                              value = 0, 
                                              currencySymbol = "$", 
                                              currencySymbolPlacement = "p",
                                              decimalPlaces = 2, digitGroupSeparator = ".", decimalCharacter = ",")
                      )
                    )
          ),
          fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                    h4("Datos de la operación"),
                    fluidRow(
                      column(6,
                             selectInput("pago_medio", "Medio de pago", choices = c("Transferencia", "Efectivo", "Cheque"))
                      ),
                      column(6,
                             textInput("pago_nro_comp", "Número de comprobante")
                      )
                    ),
                    uiOutput("image_transferencia"),
                    div(
                      fileInput(inputId = "upload_transferencia_pago",
                                label = NULL,
                                buttonLabel = "Escoje la foto",
                                placeholder = "no hay foto",
                                multiple = TRUE,
                                accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
                      align = "center"),
          ),
      ),
      tags$div(id="bttn_modal", 
               actionBttn("office_cont_caja_ingreso_ok", "Cobrar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Asentar ingreso",
      easyClose = TRUE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  observeEvent(input$office_cont_caja_ingreso_ok, {
    if(is.null(vars$foto_transferencia) & input$pago_medio != "Efectivo"){
      shinyalert(
        type = "error",
        title = "Debes subir la foto del comprobante de la transferencia"
      )
    }else{
      pago_id <- new_id_table_mysql("id", paste0(co, "_pagos"), "pago_", 12)
      if(input$pago_medio != "Efectivo"){
        im <- image_read(vars$url_temp_foto_transferencia)
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        put_object_do(paste0("/", co, "/fotos-comprobantes/comisiones/", pago_id, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        im <- image_scale(im, "300x")
        url <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/fotos-comprobantes/comisiones/", pago_id, ".jpg")
      }else{
        url <- "https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/blank_inmo.jpg"
      }
      
      new_pago <- data.frame(
        id = pago_id,
        fecha = as.character(now("America/Asuncion")),
        ingreso = "no",
        id_pagado = NA,
        tipo = input$fact_tipo,
        user = vars$user$user,
        agencia = vars$user$agencia,
        medio = input$pago_medio,
        nro_trans = input$pago_nro_comp,
        img = url,
        fact_user = NA,
        fact_fecha = input$fact_fecha,
        fact_concepto = input$fact_concepto,
        fact_numero = input$fact_numero,
        fact_razon = input$fact_razon,
        fact_ruc = input$fact_ruc,
        fact_moneda = input$fact_moneda,
        fact_monto = input$fact_monto,
        cambio = cambio_dolar$venta
      )
      print(new_pago)
      save_mysql(new_pago, paste0(co, "_pagos"), FALSE)
      
      vars$office_cont_list_all <- rbind(vars$office_cont_list_all, new_pago)
      
      removeModal()
    }
  })
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #estados
  
  refresh_estado <- reactiveVal(0)
  
  output$box_estado_ui <- renderUI({
    if(estado_on() == 1){
      fluidPage(
        div(style = "position: sticky; width: 100%; z-index: 5",
            uiOutput("estado_filtros_ui")),
        br(),
        uiOutput("estado_boxes_ui")
      )
    }
  })  
  
  output$estado_boxes_ui <- renderUI({
    if(captacion_on() == 1){
      uiOutput("estado_captacion_ui")
    }else{
      if(colocacion_on() == 1){
        uiOutput("estado_colocacion_ui")
      }else{
        if(cierres_on() == 1){
          uiOutput("estado_cierres_ui")
        }else{
          if(busquedas_on() == 1){
            uiOutput("estado_busquedas_ui")
          }else{
            if(coordinadora_on() == 1){
              uiOutput("estado_coordinadora_ui")
            }
          }
        }
      }
    }
  })
  
  output$estado_captacion_ui <- renderUI({
    if(estado_on() == 1){
      fluidRow(
        column(4,
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   fluidRow(
                     column(8, h4(HTML(paste0("<p><span style='color: ", main_color, "'>Proceso de captación</span></p>")), style = "margin-left: 10px")),
                     column(4, h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                                              nrow(vars$data_all_pages_1), "</span></p>"))), align = "right")
                   ),
                   div(uiOutput("box_estado_1_list_ui"), style = "overflow-y: scroll; height: 590px;
                     position: absolute")
               )
        ),
        column(4, 
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   fluidRow(
                     column(8, h4(HTML(paste0("<p><span style='color: ", main_color, "'>Seguimiento</span></p>")), style = "margin-left: 10px")),
                     column(4, h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                                              nrow(vars$data_all_pages_2), "</span></p>"))), align = "right")
                   ),
                   div(uiOutput("box_estado_2_list_ui"), style = "overflow-y: scroll; height: 590px;
                     position: absolute")
               )
        ),
        column(4, 
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   fluidRow(
                     column(8, h4(HTML(paste0("<p><span style='color: ", main_color, "'>Proceso de cierre</span></p>")), style = "margin-left: 10px")),
                     column(4, h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                                              nrow(vars$data_all_pages_3), "</span></p>"))), align = "right")
                   ),
                   div(uiOutput("box_estado_3_list_ui"), style = "overflow-y: scroll; height: 590px;
                     position: absolute")
               )
        )
      )
    }
  })
  
  output$estado_colocacion_ui <- renderUI({
    if(estado_on() == 1){
      fluidRow(
        column(6,
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   fluidRow(
                     column(8, h4(HTML(paste0("<p><span style='color: ", main_color, "'>Seguimiento</span></p>")), style = "margin-left: 10px")),
                     column(4, h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                                              nrow(vars$data_all_pages_1), "</span></p>"))), align = "right")
                   ),
                   div(uiOutput("box_estado_1_list_ui"), style = "overflow-y: scroll; height: 590px;
                     position: absolute")
               )
        ),
        column(6, 
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   fluidRow(
                     column(8, h4(HTML(paste0("<p><span style='color: ", main_color, "'>Proceso de cierre</span></p>")), style = "margin-left: 10px")),
                     column(4, h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                                              nrow(vars$data_all_pages_2), "</span></p>"))), align = "right")
                   ),
                   div(uiOutput("box_estado_2_list_ui"), style = "overflow-y: scroll; height: 590px;
                     position: absolute")
               )
        )
      )
    }
  })
  
  output$estado_cierres_ui <- renderUI({
    req(vars$trans_all_pages_2, vars$trans_all_pages_3)
    if(estado_on() == 1 & cierres_on() == 1){
      
      isolate({
        
        open_scroll_2$boxes = list()
        open_scroll_2$obs_open_scroll = list()
        open_scroll_2$obs_new_comentario = list()
        vars$n_scroll_2 <- 0
        vars$list_scroll_2 <- data.frame()
        
        vars$n_scroll_2 <- nrow(vars$trans_all_pages_2)
        print("vars$n_scroll_2")
        print(vars$n_scroll_2)
        if(vars$n_scroll_2 != 0){
          vars$scroll_per_page_2 <- scroll_per_page_trans
          vars$all_scroll_2 <- vars$trans_all_pages_2
          if(vars$n_scroll_2 <= scroll_per_page_trans){
            vars$from_2 <- 1
            vars$to_2 <- vars$n_scroll_2
            vars$list_scroll_2 <- vars$all_scroll_2
            vars$loaded_scroll_2 <- vars$n_scroll_2
          }else{
            vars$from_2 <- 1   
            vars$to_2 <- scroll_per_page_trans
            vars$list_scroll_2 <- vars$all_scroll_2[vars$from_2:vars$to_2,]
            vars$loaded_scroll_2 <- scroll_per_page_trans
          }
        }else{
          vars$loaded_scroll_2 <- 0
        }
        
        open_scroll_3$boxes = list()
        open_scroll_3$obs_open_scroll = list()
        open_scroll_3$obs_new_comentario = list()
        vars$n_scroll_3 <- 0
        vars$list_scroll_3 <- data.frame()
        
        vars$n_scroll_3 <- nrow(vars$trans_all_pages_3)
        print("vars$n_scroll_3")
        print(vars$n_scroll_3)
        if(vars$n_scroll_3 != 0){
          vars$scroll_per_page_3 <- scroll_per_page_trans
          vars$all_scroll_3 <- vars$trans_all_pages_3
          if(vars$n_scroll_3 <= scroll_per_page_trans){
            vars$from_3 <- 1
            vars$to_3 <- vars$n_scroll_3
            vars$list_scroll_3 <- vars$all_scroll_3
            vars$loaded_scroll_3 <- vars$n_scroll_3
          }else{
            vars$from_3 <- 1   
            vars$to_3 <- scroll_per_page_trans
            vars$list_scroll_3 <- vars$all_scroll_3[vars$from_3:vars$to_3,]
            vars$loaded_scroll_3 <- scroll_per_page_trans
          }
        }else{
          vars$loaded_scroll_3 <- 0
        }
        
      })
      
      fluidRow(
        column(6,
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   fluidRow(
                     column(8, h4(HTML(paste0("<p><span style='color: ", main_color, "'>No cobrado</span></p>")), style = "margin-left: 10px")),
                     column(4, h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                                              nrow(vars$trans_all_pages_2), "</span></p>"))), align = "right")
                   ),
                   div(style = "overflow-y: scroll; height: 590px; position: absolute",
                       div(uiOutput("boxes_with_scroll_ui_2"), align = "center"),
                       br(),
                       div(uiOutput("bttn_prox_scroll_2"), align = "center"),
                       br()
                   )
               )
        ),
        column(6, 
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   fluidRow(
                     column(8, h4(HTML(paste0("<p><span style='color: ", main_color, "'>Cobrado</span></p>")), style = "margin-left: 10px")),
                     column(4, h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                                              nrow(vars$trans_all_pages_3), "</span></p>"))), align = "right")
                   ),
                   div(style = "overflow-y: scroll; height: 590px; position: absolute",
                       div(uiOutput("boxes_with_scroll_ui_3"), align = "center"),
                       br(),
                       div(uiOutput("bttn_prox_scroll_3"), align = "center"),
                       br()
                   )
               )
        )
      )
    }
  })
  
  output$estado_busquedas_ui <- renderUI({
    if(estado_on() == 1){
      fluidRow(style = "padding: 15px; padding-top: 0px",
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   fluidRow(
                     column(8, h4(HTML(paste0("<p><span style='color: ", main_color, "'>En búsqueda</span></p>")), style = "margin-left: 10px")),
                     column(4, h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                                              nrow(vars$data_all_pages_1), "</span></p>"))), align = "right")
                   ),
                   div(uiOutput("box_estado_1_list_ui"), style = "overflow-y: scroll; height: 590px;
                     position: absolute")
               )
      )
    }
  })
  
  output$estado_coordinadora_ui <- renderUI({
    if(estado_on() == 1){
      fluidRow(style = "padding: 15px; padding-top: 0px",
               div(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 650px"),
                   div(uiOutput("box_estado_1_list_ui"), style = "overflow-y: scroll; height: 590px;
                     position: absolute")
               )
      )
    }
  })
  
  output$estado_filtros_ui <- renderUI({
    if(estado_on() == 1){
      fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                tags$div(id = "inline",
                         div(style = "margin: 10px",
                             div(class = "btn-group",
                                 actionButton("captacion_on_off", "Captación", icon = icon("sign"),
                                              style = ifelse(captacion_on() == 1, 
                                                             paste0("border-radius: 10px; background-color: ", main_color, ";
                                                         font-size: 130%; color: white;
                                                         border: 2px solid ", main_color),
                                                             paste0("border-radius: 10px; background-color: white;
                                                         font-size: 130%; color: ", main_color, ";
                                                         border: 2px solid ", main_color)))
                             ),
                             div(class = "btn-group", style = "margin-left: 5px",
                                 actionButton("colocacion_on_off", "Colocación", icon = icon("handshake"),
                                              style = ifelse(colocacion_on() == 1, 
                                                             paste0("border-radius: 10px; background-color: ", main_color, ";
                                                         font-size: 130%; color: white;
                                                         border: 2px solid ", main_color),
                                                             paste0("border-radius: 10px; background-color: white;
                                                         font-size: 130%; color: ", main_color, ";
                                                         border: 2px solid ", main_color)))
                             ),
                             div(class = "btn-group", style = "margin-left: 5px",
                                 actionButton("cierres_on_off", "Cierres", icon = icon("check"),
                                              style = ifelse(cierres_on() == 1, 
                                                             paste0("border-radius: 10px; background-color: ", main_color, ";
                                                         font-size: 130%; color: white;
                                                         border: 2px solid ", main_color),
                                                             paste0("border-radius: 10px; background-color: white;
                                                         font-size: 130%; color: ", main_color, ";
                                                         border: 2px solid ", main_color)))
                             ),
                             div(class = "btn-group", style = "margin-left: 5px",
                                 actionButton("busquedas_on_off", "Búsquedas", icon = icon("search"),
                                              style = ifelse(busquedas_on() == 1, 
                                                             paste0("border-radius: 10px; background-color: ", main_color, ";
                                                         font-size: 130%; color: white;
                                                         border: 2px solid ", main_color),
                                                             paste0("border-radius: 10px; background-color: white;
                                                         font-size: 130%; color: ", main_color, ";
                                                         border: 2px solid ", main_color)))
                             ),
                             if(vars$user$cargo %in% c("Country Office Assistant", "Global Master Office")){
                               div(class = "btn-group", style = "margin-left: 5px",
                                   actionButton("coordinadora_on_off", "Central", icon = icon("search"),
                                                style = ifelse(coordinadora_on() == 1, 
                                                               paste0("border-radius: 10px; background-color: ", main_color, ";
                                                         font-size: 130%; color: white;
                                                         border: 2px solid ", main_color),
                                                               paste0("border-radius: 10px; background-color: white;
                                                         font-size: 130%; color: ", main_color, ";
                                                         border: 2px solid ", main_color)))
                               )
                             },
                             if(busquedas_on() == 0 & coordinadora_on() == 0){
                               div(class = "btn-group", style = "width: 100px; margin: 0px; margin-left: 5px;", 
                                   textInput("estado_filt_name", "", value = NULL, placeholder = "buscar")
                               )
                             },
                             if(busquedas_on() == 0 & coordinadora_on() == 0){
                               div(class = "btn-group", style = "width: 100px; margin: 0px; margin-left: 5px;", 
                                   textInput("estado_filt_codigo", "", value = NULL, placeholder = "código")
                               )
                             },
                             if(coordinadora_on() == 1){
                               div(class = "btn-group", style = "width: 100px; margin: 0px; margin-left: 5px;", 
                                   actionButton("add_user_coordinadora", "Agregar")
                               )
                             },
                             if(coordinadora_on() == 1){
                               div(class = "btn-group", style = "width: 100px; margin: 0px; margin-left: 5px;", 
                                   actionButton("del_user_coordinadora", "Eliminar")
                               )
                             },
                         ),
                         if(cierres_on() == 0){
                           div(style = "margin: 10px",
                               uiOutput("ind_estado")
                           )
                         }
                )
      )
    }
  })  
  
  observeEvent(input$captacion_on_off, {
    if(captacion_on() == 0){
      captacion_on(1)
      colocacion_on(0)
      cierres_on(0)
      busquedas_on(0)
      coordinadora_on(0)
    }
  })
  
  observeEvent(input$colocacion_on_off, {
    if(colocacion_on() == 0){
      captacion_on(0)
      colocacion_on(1)
      cierres_on(0)
      busquedas_on(0)
      coordinadora_on(0)
    }
  })
  
  observeEvent(input$cierres_on_off, {
    if(cierres_on() == 0){
      office_trans_list <- list_table_var_mysql(paste0(co, "_transacciones"), "user", vars$user$user)
      if(nrow(office_trans_list) != 0){
        office_trans_list$user_name <- vars$user$name
        office_trans_list$pais_agencia <- ifelse(vars$user$agencia == "Global Master Office", "Paraguay", 
                                                 ifelse(vars$user$agencia %in% vars$agencias$id, 
                                                        vars$agencias$pais[vars$agencias$id == vars$user$agencia], 
                                                        vars$franquicias$pais[vars$franquicias$id == vars$user$agencia]))
        office_trans_list$name_agenia <- ifelse(vars$user$agencia == "Global Master Office", "Global Master Office", 
                                                ifelse(vars$user$agencia %in% vars$agencias$id, 
                                                       vars$agencias$name[vars$agencias$id == vars$user$agencia], 
                                                       vars$franquicias$name[vars$franquicias$id == vars$user$agencia]))
        all_pages <- office_trans_list
        all_pages_2 <- all_pages %>% filter(fase == "5" | fase == "4")
        all_pages_3 <- all_pages %>% filter(fase == "6" & fecha >= as.character(now("America/Asuncion") - months(1)))
      }else{
        all_pages_2 <- data.frame()
        all_pages_3 <- data.frame()
      }
      
      isolate({
        if(nrow(all_pages_2) != 0){
          vars$trans_all_pages_2 <- all_pages_2 %>% arrange(desc(fecha))
        }else{
          vars$trans_all_pages_2 <- data.frame()
        }
        if(nrow(all_pages_3) != 0){
          vars$trans_all_pages_3 <- all_pages_3 %>% arrange(desc(fecha))
        }else{
          vars$trans_all_pages_3 <- data.frame()
        }
      })
      
      captacion_on(0)
      colocacion_on(0)
      cierres_on(1)
      busquedas_on(0)
      coordinadora_on(0)
    }
  })
  
  observeEvent(input$busquedas_on_off, {
    if(busquedas_on() == 0){
      captacion_on(0)
      colocacion_on(0)
      cierres_on(0)
      busquedas_on(1)
      coordinadora_on(0)
    }
  })
  
  observeEvent(input$coordinadora_on_off, {
    if(coordinadora_on() == 0){
      captacion_on(0)
      colocacion_on(0)
      cierres_on(0)
      busquedas_on(0)
      coordinadora_on(1)
    }
  })
  
  observeEvent(input$add_user_coordinadora, {
    brokers <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "cargo", 
                                          c("Global Master Office", "Global Office Manager", "Global Office Assistant", "Country Master Office",
                                            "Country Office Manager", "Country Office Assistant", "Broker Office", "Broker Manager",
                                            "Broker Assistant"))
    showModal(modalDialog(
      div(id = "inline", 
          selectInput("add_user_coordinadora_sel", "Elegir Usuario", 
                      choices = brokers$name)
      ),
      tags$div(id="bttn_modal", 
               actionBttn("add_user_coordinadora_ok", "Agregar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Agregar seguimiento",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$add_user_coordinadora_ok, {
    brokers <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "cargo", 
                                          c("Global Master Office", "Global Office Manager", "Global Office Assistant", "Country Master Office",
                                            "Country Office Manager", "Country Office Assistant", "Broker Office", "Broker Manager",
                                            "Broker Assistant"))
    broker <- brokers[brokers$name == input$add_user_coordinadora_sel, ]
    
    new_estado <- data.frame(
      id = new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12),
      fecha = as.character(now("America/Asuncion")),
      user = vars$user$user,
      name = paste0("Seguimiento al Broker Manager ", broker$name),
      id_inmo = "coordinadora",
      id_clien = broker$user,
      nivel_cliente = NA,
      estado_cliente = NA,
      accion = NA,
      fecha_prox_contacto = as.character(as_date(now("America/Asuncion"))),
      tipo_cliente = "coordinadora",
      presupuesto = NA,
      urgente = "no",
      importante = "no",
      fase = "1",
      comment = NA
    )
    save_mysql(new_estado, paste0(co, "_estados"), FALSE)
    
    new_llamada <- data.frame(
      id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
      fecha = as.character(now("America/Asuncion")),
      fecha_agendada = NA,
      user = vars$user$user,
      id_inmo = "coordinadora",
      id_clien = broker$user,
      id_estado = new_estado$id,
      accion = "Nuevo seguimiento",
      realizado = NA,
      agendado = "no",
      time = NA,
      visto = "no",
      comment = paste0(vars$user$name, " ha comenzado a dar seguimiento a ", broker$name)
    )
    save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
    
    refresh_estado(isolate(refresh_estado()) + 1)
    removeModal()
  })
  
  observeEvent(input$del_user_coordinadora, {
    estado_users <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", "coordinadora")
    users <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", estado_users$id_clien)
    showModal(modalDialog(
      div(id = "inline", 
          selectInput("del_user_coordinadora_sel", "Elegir Usuario", 
                      choices = users$name)
      ),
      tags$div(id="bttn_modal", 
               actionBttn("del_user_coordinadora_ok", "Eliminar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Eliminar seguimiento",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$del_user_coordinadora_ok, {
    estado_users <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", "coordinadora")
    users <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", estado_users$id_clien)
    del_user <- users[users$name == input$del_user_coordinadora_sel, ]
    del_estado <- estado_users[estado_users$id_clien == del_user$user, ]
    del_var_table_mysql("id", del_estado$id, paste0(co, "_estados"))
    del_var_table_mysql("id_estado", del_estado$id, paste0(co, "_llamadas"))
    
    refresh_estado(isolate(refresh_estado()) + 1)
    removeModal()
  })
  
  observe({
    if(estado_on() == 1){
      
      if(!is.null(input$estado_filt_name) && input$estado_filt_name != ""){
        palabras <- str_split(input$estado_filt_name, " ")[[1]]
        palabras <- palabras[palabras != ""]
        print(palabras)
        busc <- c()
        for(i in 1:length(palabras)){
          busc_1 <- c(busc, str_detect(str_to_lower(vars$data_all_pages_1$name), str_to_lower(palabras[i])))
          busc_2 <- c(busc, str_detect(str_to_lower(vars$data_all_pages_2$name), str_to_lower(palabras[i])))
          if(captacion_on() == 1){
            busc_3 <- c(busc, str_detect(str_to_lower(vars$data_all_pages_3$name), str_to_lower(palabras[i])))
          }
        }
        m_1 <- matrix(busc_1, nrow(vars$data_all_pages_1), length(palabras))*1
        ind_1 <- which(apply(m_1, 1, prod) == 1)
        if(length(ind_1) != 0){
          vars$data_all_pages_1 <- vars$data_all_pages_1[ind_1,]
        }else{
          vars$data_all_pages_1 <- data.frame()
        }
        m_2 <- matrix(busc_2, nrow(vars$data_all_pages_2), length(palabras))*1
        print(m_2)
        ind_2 <- which(apply(m_2, 1, prod) == 1)
        print(ind_2)
        if(length(ind_2) != 0){
          vars$data_all_pages_2 <- vars$data_all_pages_2[ind_2,]
        }else{
          vars$data_all_pages_2 <- data.frame()
        }
        if(captacion_on() == 1){
          m_3 <- matrix(busc_3, nrow(vars$data_all_pages_3), length(palabras))*1
          ind_3 <- which(apply(m_3, 1, prod) == 1)
          if(length(ind_3) != 0){
            vars$data_all_pages_3 <- vars$data_all_pages_3[ind_3,]
          }else{
            vars$data_all_pages_3 <- data.frame()
          }
        }
      }else{
        print("blanco")
        vars$data_all_pages_1 <- vars$data_all_pages_1_back
        vars$data_all_pages_2 <- vars$data_all_pages_2_back
        if(captacion_on() == 1){
          vars$data_all_pages_3 <- vars$data_all_pages_3_back
        }
      }
    }
  })
  
  observe({
    ind_hoy_on()
    refresh_estado()
    if(estado_on() == 1 & cierres_on() == 0){
      if(coordinadora_on() == 1){
        all_pages <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", "coordinadora")
      }else{
        all_pages <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "fase", c("1", "2", "3"))
      }
      if(!is.null(input$estado_filt_codigo) && input$estado_filt_codigo != ""){
        codigos <- lapply(all_pages$id_inmo, FUN = function(i){
          as.integer(str_flatten(str_extract_all(i, "\\d")[[1]]))
        }) %>% unlist()
        all_pages <- all_pages[codigos == input$estado_filt_codigo,]
      }
      if(nrow(all_pages) != 0){
        llamadas_all <- list_table_var1_var2_mysql(paste0(co, "_llamadas"), "user", vars$user$user, "realizado", "no")
        all_pages <- all_pages %>% mutate(fecha_prox_contacto = unlist(lapply(id, FUN = function(i, llamadas_all){
          llamadas <- llamadas_all %>% filter(id_estado == i & !is.na(fecha_agendada))
          if(nrow(llamadas) != 0){
            prox_contacto <- min(llamadas$fecha_agendada)
          }else{
            prox_contacto <- NA
          }
          return(prox_contacto)
        }, llamadas_all = llamadas_all)))
        all_pages <- all_pages %>% mutate(days_diff = as.numeric(difftime(as_date(fecha_prox_contacto), as_date(now("America/Asuncion")), units = "days"))) %>% arrange(days_diff)
        all_pages_prio <- all_pages %>% filter(urgente == "si")
        all_pages_no_prio <- all_pages %>% filter(urgente == "no")
        all_pages <- rbind(all_pages_prio, all_pages_no_prio)
        
        ind_vencido <- all_pages %>% filter(!is.na(days_diff) & days_diff < 0)
        ind_hoy <- all_pages %>% filter(!is.na(days_diff) & days_diff == 0)
        ind_manana <- all_pages %>% filter(!is.na(days_diff) & days_diff == 1)
        ind_siguientes <- all_pages %>% filter(!is.na(days_diff) & days_diff > 1)
        ind_aldia <- all_pages %>% filter(is.na(days_diff))
        
        if(!is.null(input$estado_filt_codigo) && input$estado_filt_codigo == ""){
          if(ind_vencido_on() == 1){
            print("Vencidos")
            all_pages <- ind_vencido
          }else{
            if(ind_hoy_on() == 1){
              print("Hoy")
              all_pages <- ind_hoy
            }else{
              if(ind_manana_on() == 1){
                print("Mañana")
                all_pages <- ind_manana 
              }else{
                if(ind_siguientes_on() == 1){
                  print("Siguientes")
                  all_pages <- ind_siguientes
                }else{
                  if(ind_aldia_on() == 1){
                    print("Al dia")
                    all_pages <- ind_aldia
                  }
                }
              }
            }
          }
        }
        if(captacion_on() == 1){
          vars$ind_vencido <- ind_vencido[ind_vencido$tipo_cliente == "captacion",] %>% nrow()
          vars$ind_hoy <- ind_hoy[ind_hoy$tipo_cliente == "captacion",] %>% nrow()
          vars$ind_manana <- ind_manana[ind_manana$tipo_cliente == "captacion",] %>% nrow()
          vars$ind_siguientes <- ind_siguientes[ind_siguientes$tipo_cliente == "captacion",] %>% nrow()
          vars$ind_aldia <- ind_aldia[ind_aldia$tipo_cliente == "captacion",] %>% nrow()
          
          all_pages_1 <- all_pages %>% filter(tipo_cliente == "captacion" & fase == "1")
          all_pages_2 <- all_pages %>% filter(tipo_cliente == "captacion" & fase == "2")
          all_pages_3 <- all_pages %>% filter(tipo_cliente == "captacion" & fase == "3")
          
          vars$data_all_pages_1_back <- all_pages_1
          vars$data_all_pages_2_back <- all_pages_2
          vars$data_all_pages_3_back <- all_pages_3
          if(nrow(all_pages_1) != 0){
            vars$data_all_pages_1 <- all_pages_1
          }else{
            vars$data_all_pages_1 <- data.frame()
          }
          if(nrow(all_pages_2) != 0){
            vars$data_all_pages_2 <- all_pages_2
          }else{
            vars$data_all_pages_2 <- data.frame()
          }
          if(nrow(all_pages_3) != 0){
            vars$data_all_pages_3 <- all_pages_3
          }else{
            vars$data_all_pages_3 <- data.frame()
          }
        }else{
          if(colocacion_on() == 1){
            vars$ind_vencido <- ind_vencido[ind_vencido$tipo_cliente == "colocacion",] %>% nrow()
            vars$ind_hoy <- ind_hoy[ind_hoy$tipo_cliente == "colocacion",] %>% nrow()
            vars$ind_manana <- ind_manana[ind_manana$tipo_cliente == "colocacion",] %>% nrow()
            vars$ind_siguientes <- ind_siguientes[ind_siguientes$tipo_cliente == "colocacion",] %>% nrow()
            vars$ind_aldia <- ind_aldia[ind_aldia$tipo_cliente == "colocacion",] %>% nrow()
            
            all_pages_1 <- all_pages %>% filter(tipo_cliente == "colocacion" & fase == "1")
            all_pages_2 <- all_pages %>% filter(tipo_cliente == "colocacion" & fase == "2")
            
            vars$data_all_pages_1_back <- all_pages_1
            vars$data_all_pages_2_back <- all_pages_2
            if(nrow(all_pages_1) != 0){
              vars$data_all_pages_1 <- all_pages_1
            }else{
              vars$data_all_pages_1 <- data.frame()
            }
            if(nrow(all_pages_2) != 0){
              vars$data_all_pages_2 <- all_pages_2
            }else{
              vars$data_all_pages_2 <- data.frame()
            }
          }else{
            if(busquedas_on() == 1){
              vars$ind_vencido <- ind_vencido[ind_vencido$tipo_cliente == "busquedas",] %>% nrow()
              vars$ind_hoy <- ind_hoy[ind_hoy$tipo_cliente == "busquedas",] %>% nrow()
              vars$ind_manana <- ind_manana[ind_manana$tipo_cliente == "busquedas",] %>% nrow()
              vars$ind_siguientes <- ind_siguientes[ind_siguientes$tipo_cliente == "busquedas",] %>% nrow()
              vars$ind_aldia <- ind_aldia[ind_aldia$tipo_cliente == "busquedas",] %>% nrow()
              
              all_pages_1 <- all_pages %>% filter(tipo_cliente == "busquedas")
              
              vars$data_all_pages_1_back <- all_pages_1
              if(nrow(all_pages_1) != 0){
                vars$data_all_pages_1 <- all_pages_1
              }else{
                vars$data_all_pages_1 <- data.frame()
              }
            }else{
              if(coordinadora_on() == 1){
                vars$ind_vencido <- ind_vencido[ind_vencido$tipo_cliente == "coordinadora",] %>% nrow()
                vars$ind_hoy <- ind_hoy[ind_hoy$tipo_cliente == "coordinadora",] %>% nrow()
                vars$ind_manana <- ind_manana[ind_manana$tipo_cliente == "coordinadora",] %>% nrow()
                vars$ind_siguientes <- ind_siguientes[ind_siguientes$tipo_cliente == "coordinadora",] %>% nrow()
                vars$ind_aldia <- ind_aldia[ind_aldia$tipo_cliente == "coordinadora",] %>% nrow()
                
                all_pages_1 <- all_pages %>% filter(tipo_cliente == "coordinadora")
                
                vars$data_all_pages_1_back <- all_pages_1
                if(nrow(all_pages_1) != 0){
                  vars$data_all_pages_1 <- all_pages_1
                }else{
                  vars$data_all_pages_1 <- data.frame()
                }
              }
            }
          }
        }
      }else{
        all_pages_1 <- data.frame()
        all_pages_2 <- data.frame()
        all_pages_3 <- data.frame()
        vars$data_all_pages_1_back <- all_pages_1
        vars$data_all_pages_2_back <- all_pages_2
        vars$data_all_pages_3_back <- all_pages_3
        vars$ind_vencido <- 0
        vars$ind_hoy <- 0
        vars$ind_manana <- 0
        vars$ind_siguientes <- 0
        vars$ind_aldia <- 0
      }
      
    }
  })
  
  output$ind_estado <- renderUI({
    div(id = "inline",
        div(class = "btn-group",
            actionButton("ind_aldia_on_off", paste0("Pendientes: ", vars$ind_aldia),
                         style = ifelse(ind_aldia_on() == 1, "background: #666666; color: white", "background: white; color: black"))
        ),
        div(class = "btn-group",
            actionButton("ind_vencido_on_off", paste0("Vencidos: ", vars$ind_vencido),
                         style = ifelse(ind_vencido_on() == 1, "background: #666666; color: white", "background: white; color: black"))
        ),
        div(class = "btn-group",
            actionButton("ind_hoy_on_off", paste0("Hoy: ", vars$ind_hoy),
                         style = ifelse(ind_hoy_on() == 1, "background: #666666; color: white", "background: white; color: black"))
        ),
        div(class = "btn-group",
            actionButton("ind_manana_on_off", paste0("Mañana: ", vars$ind_manana),
                         style = ifelse(ind_manana_on() == 1, "background: #666666; color: white", "background: white; color: black"))
        ),
        div(class = "btn-group",
            actionButton("ind_siguientes_on_off", paste0("Siguientes: ", vars$ind_siguientes),
                         style = ifelse(ind_siguientes_on() == 1, "background: #666666; color: white", "background: white; color: black"))
        )
    )
  })
  
  ind_siguientes_on <- reactiveVal(0)
  ind_aldia_on <- reactiveVal(0)
  ind_manana_on <- reactiveVal(0)
  ind_hoy_on <- reactiveVal(0)
  ind_vencido_on <- reactiveVal(0)
  
  observeEvent(input$ind_vencido_on_off, {
    if(ind_vencido_on() == 0){
      ind_vencido_on(1)
      ind_aldia_on(0)
      ind_hoy_on(0)
      ind_manana_on(0)
      ind_siguientes_on(0)
    }
  })
  
  observeEvent(input$ind_aldia_on_off, {
    if(ind_aldia_on() == 0){
      ind_vencido_on(0)
      ind_aldia_on(1)
      ind_hoy_on(0)
      ind_manana_on(0)
      ind_siguientes_on(0)
    }
  })
  
  observeEvent(input$ind_hoy_on_off, {
    if(ind_hoy_on() == 0){
      ind_vencido_on(0)
      ind_aldia_on(0)
      ind_hoy_on(1)
      ind_manana_on(0)
      ind_siguientes_on(0)
    }
  })
  
  observeEvent(input$ind_manana_on_off, {
    if(ind_manana_on() == 0){
      ind_vencido_on(0)
      ind_aldia_on(0)
      ind_hoy_on(0)
      ind_manana_on(1)
      ind_siguientes_on(0)
    }
  })
  
  observeEvent(input$ind_siguientes_on_off, {
    if(ind_siguientes_on() == 0){
      ind_vencido_on(0)
      ind_aldia_on(0)
      ind_hoy_on(0)
      ind_manana_on(0)
      ind_siguientes_on(1)
    }
  })
  
  output$formulario_estado_ui <- renderUI({
    if(nrow(vars$show_estado) != 0){
      estado <- vars$show_estado
      print(estado)
      if(estado$tipo_cliente == "coordinadora"){
        vars$co <- co
      }else{
        vars$co <- str_split(estado$id_inmo, "_")[[1]][1]
      }
      if(str_detect(estado$id_clien, "@")){
        clien <- list_table_var_mysql("myplace_usuarios", "user", estado$id_clien)
        asesor_externo <- FALSE
      }else{
        clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", estado$id_clien)
        if(clien$tipo == "Cliente"){
          asesor_externo <- FALSE
        }else{
          asesor_externo <- TRUE
        }
      }
      
      fase <- case_when(estado$tipo_cliente == "captacion" & estado$fase == "1" ~ "cap_cap",
                        estado$tipo_cliente == "captacion" & estado$fase == "2" ~ "cap_seg",
                        estado$tipo_cliente == "captacion" & estado$fase == "3" ~ "cap_cie",
                        estado$tipo_cliente == "colocacion" & estado$fase == "1" ~ "col_seg",
                        estado$tipo_cliente == "colocacion" & estado$fase == "2" ~ "col_cie",
                        estado$tipo_cliente == "busquedas" ~ "busq",
                        estado$tipo_cliente == "coordinadora" ~ "coor")
      print(fase)
      vars$cliente <- clien
      llamadas <- list_table_var_mysql(paste0(co, "_llamadas"), "id_estado", estado$id)
      print("llamadas")
      print(llamadas)
      vars$llamadas_list <- llamadas
      div(
        div(HTML(paste0("<p><span style='font-size: 160%; font-weight: bold; color: #666666'>", 
                        str_to_upper(estado$name), "</span></p>")), align = "center"),
        if(estado$comment == "" | is.na(estado$comment)){
          div(
            div(id = "inline", class = "btn-group", textAreaInput("estado_comment", NULL, placeholder = "observaciones")),
            div(class = "btn-group",
                div(id = "inline", actionButton("guardar_estado_comment", "Guardar", 
                                                style = paste0("background-color: ", main_color, "; color: white")))
            )
          )
        }else{
          div(
            div(id = "inline", class = "btn-group", h4(estado$comment, style = "width: 100%; word-break: break-word;")),
            div(class = "btn-group",
                div(id = "inline", actionButton("editar_estado_comment", NULL, icon = icon("edit"),
                                                style = "font-size: 120%; background: transparent"))
            ),
            br(), br()
          )
        },
        fluidRow(
          column(6,
                 fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                            border-radius: 10px; background-color: white; padding: 10px; min-height: 175px; margin: 0px;
                                                            margin-bottom: 10px"),
                           column(4, style = "padding-left: 0px",
                                  div(actionButton(ifelse(str_detect(estado$id_clien, "@"), "nada", "clien_show"), NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:100px; height: 100px; margin: 0px;
                                                             background-image: url("', clien$img, '");
                                                             background-size: cover, 100px 100px;
                                                             border-radius: 50px 50px 50px 50px')))
                           ),
                           column(8,
                                  if(str_detect(estado$id_clien, "@")){
                                    h4(HTML(paste0("<p><span style='color: ", main_color, "'>Asesor: ", clien$name, "</span></p>")))
                                  }else{
                                    div(
                                      h4(HTML(paste0("<p><span style='color: ", main_color, "'>", ifelse(asesor_externo, "Asesor externo", "Cliente"), ": ", clien$name, "</span></p>"))),
                                      paste0("Canal de contacto: ", clien$canal), br(),
                                      paste0("Primer contacto: ", clien$comment), br()
                                    )
                                  },
                                  if(ifelse(str_detect(estado$id_clien, "@"), clien$user, clien$mail) != ""){
                                    div(class = "btn-group",
                                        a(href= paste0("mailto:", ifelse(str_detect(estado$id_clien, "@"), clien$user, clien$mail)), target="_blank", actionButton("nada", "" , icon = icon("envelope"),
                                                                                                                                                                   style = "font-size: 170%; padding: 0px; background-color: transparent; border-color: transparent"))
                                    )
                                  },
                                  if(!is.na(clien$phone)){
                                    text_wp <- paste0("https://wa.me/", clien$phone, "?text=", "")
                                    div(class = "btn-group",
                                        a(href= text_wp, target="_blank", actionButton("nada", NULL , icon = icon("whatsapp"),
                                                                                       style = "font-size: 170%; padding: 0px; padding-left: 10px; background-color: transparent; border-color: transparent"))
                                    )
                                  },
                                  if(!is.na(clien$phone)){
                                    div(class = "btn-group", h5(clien$phone))
                                  }
                           )
                 )
          ),
          column(6,
                 if(str_detect(estado$id_inmo, "inmueble")){
                   inmo <- list_table_var_mysql("myplace_inmuebles", "id", estado$id_inmo)
                   vars$show_inmo <- inmo
                   
                   if(inmo$tipoPropiedad == "Proyecto"){
                     tipologias <- list_table_var_mysql("myplace_tipologias", "id", inmo$id)
                     vars$tipologia_list_all <- tipologias %>% arrange(fecha)
                     if(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta"){
                       tipologias$precio <- round(tipologias$precio/1000000)
                     }
                     precio_min <- format(min(tipologias$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)
                     precio_max <- format(max(tipologias$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)
                   }
                   
                   fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                            border-radius: 10px; background-color: white; padding: 10px; min-height: 175px; margin: 0px;
                                                            margin-bottom: 10px"),
                             column(4, style = "padding-left: 0px",
                                    div(actionButton("inmo_show", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:100px; height: 100px; margin: 0px;
                                                             background-image: url("', inmo$img, '");
                                                             background-size: cover, 100px 100px;
                                                             border-radius: 8px 8px 8px 8px')))
                             ),
                             column(8,
                                    div(
                                      h4(HTML(paste0("<p><span style='color: ", main_color, "'>", inmo$titulo, "</span></p>"))),
                                      if(inmo$tipoPropiedad == "Proyecto"){
                                        if(precio_min == precio_max){
                                          div(style = "position: absolute; margin-left: 0px; margin-top: 30px",
                                              HTML(paste0("<p><span style='font-size: 180%; font-weight: lighter; color: ", main_color, "'>", 
                                                          inmo$moneda_contrato, " ", precio_min, 
                                                          ifelse(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta", " millones", ""), "</span></p>"))
                                          )
                                        }else{
                                          div(style = "position: absolute; margin-left: 0px; margin-top: 30px",
                                              HTML(paste0("<p><span style='font-size: 180%; font-weight: lighter; color: ", main_color, "'>", 
                                                          inmo$moneda_contrato, " ", precio_min, " - ", precio_max, 
                                                          ifelse(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta", " millones", ""), "</span></p>"))
                                          )
                                        }
                                      }else{
                                        div(style = "position: absolute; margin-left: 0px; margin-top: 30px",
                                            HTML(paste0("<p><span style='font-size: 180%; font-weight: lighter; color: ", main_color, "'>", 
                                                        inmo$moneda_contrato, " ", format(inmo$precio, big.mark = ".", decimal.mark = ",", scientific = FALSE), 
                                                        ifelse(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta", " millones", ""), "</span></p>"))
                                        )
                                      }
                                    )
                             )
                   )
                 }else{
                   if(!str_detect(estado$id_inmo, "coordinadora")){
                     busqueda <- list_table_var1_var2_var3_mysql("myplace_busquedas", "id", estado$id_inmo, "company", co, "activo", "IN", "si")
                     
                     path <- paste0("www/temp/", vars$user$user, "temp_map.html")
                     saveWidget(
                       widget = leaflet() %>% addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}")%>%
                         addPolygons(data = busqueda, color = "blue",
                                     popup = ~popup_busqueda(busqueda, TRUE)), 
                       file = path,
                       selfcontained = FALSE,
                       libdir = "files/"
                     )
                     
                     fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                            border-radius: 10px; background-color: white; padding: 10px; min-height: 175px; margin: 0px;
                                                            margin-bottom: 10px"),
                               column(7, style = "padding-left: 0px",
                                      div(tags$iframe(seamless="seamless", 
                                                      src = paste0("temp/", vars$user$user, "temp_map.html"), 
                                                      style = "border-radius: 8px 8px 8px 8px; width: 100%; height: 140px;
                                border: 0px; padding: 3px;")
                                      ),
                               ),
                               column(5,
                                      h4(HTML(paste0("<p><span style='color: ", main_color, "'>", busqueda$name, "</span></p>")))
                               )
                     )
                   }
                 }
          )
        ),
        fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                   border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                                                   margin-bottom: 10px"),
                  if(fase == "cap_cap"){
                    div(
                      h4(HTML(paste0("<p><span style='color: #888888'>Estado: Captación - Proceso de captación</span></p>")), style = "margin-left: 10px"),
                      fluidRow(id = "inline", align = "center",
                               column(3, selectInput("estado_sel_task", "Escojer acción", choices = acciones$accion)),
                               column(3, dateInput("estado_date_task", "Agendar recordatorio", language = "es", value = "")),
                               column(3, textAreaInput("estado_text_task", "Más detalles")),
                               column(3, align = "left", style = "margin-top: 25px;",
                                      actionButton("estado_new_task_ok", "Guardar", 
                                                   style = paste0("background-color: ", main_color, ";
                                                                        color: white")),
                                      materialSwitch("repetir_task_check", "Repetir acción", status = "info"),
                                      uiOutput("repetir_task_ui")
                               )
                      )
                    )
                  }else{
                    if(fase == "cap_seg"){
                      div(
                        h4(HTML(paste0("<p><span style='color: #888888'>Estado: Captación - Seguimiento</span></p>")), style = "margin-left: 10px"),
                        fluidRow(id = "inline", align = "center",
                                 column(3, selectInput("estado_sel_task", "Escojer acción", choices = acciones$accion)),
                                 column(3, dateInput("estado_date_task", "Agendar recordatorio", language = "es", value = "")),
                                 column(3, textAreaInput("estado_text_task", "Más detalles")),
                                 column(3, align = "left", style = "margin-top: 25px;",
                                        actionButton("estado_new_task_ok", "Guardar", 
                                                     style = paste0("background-color: ", main_color, ";
                                                                        color: white")),
                                        materialSwitch("repetir_task_check", "Repetir acción", status = "info"),
                                        uiOutput("repetir_task_ui")
                                 )
                        )
                      )
                    }else{
                      if(fase == "cap_cie"){
                        div(
                          h4(HTML(paste0("<p><span style='color: #888888'>Estado: Captación - Proceso de cierre</span></p>")), style = "margin-left: 10px"),
                          fluidRow(id = "inline", align = "center",
                                   column(3, selectInput("estado_sel_task", "Escojer acción", choices = acciones$accion)),
                                   column(3, dateInput("estado_date_task", "Agendar recordatorio", language = "es", value = "")),
                                   column(3, textAreaInput("estado_text_task", "Más detalles")),
                                   column(3, align = "left", style = "margin-top: 25px;",
                                          actionButton("estado_new_task_ok", "Guardar", 
                                                       style = paste0("background-color: ", main_color, ";
                                                                        color: white")),
                                          materialSwitch("repetir_task_check", "Repetir acción", status = "info"),
                                          uiOutput("repetir_task_ui")
                                   )
                          ),
                          br(),
                          hr(),
                          tags$div(id="bttn_modal", align = "center",
                                   actionBttn("cierre_exitoso", "Cierre exitoso")
                          )
                        )
                      }else{
                        if(fase == "col_seg"){
                          div(
                            h4(HTML(paste0("<p><span style='color: #888888'>Estado: Colocación - Seguimiento</span></p>")), style = "margin-left: 10px"),
                            div(
                              fluidRow(id = "inline", align = "center",
                                       column(3, selectInput("estado_sel_task", "Escojer acción", choices = acciones$accion)),
                                       column(3, dateInput("estado_date_task", "Agendar recordatorio", language = "es", value = "")),
                                       column(3, textAreaInput("estado_text_task", "Más detalles")),
                                       column(3, align = "left", style = "margin-top: 25px;",
                                              actionButton("estado_new_task_ok", "Guardar", 
                                                           style = paste0("background-color: ", main_color, ";
                                                                        color: white")),
                                              materialSwitch("repetir_task_check", "Repetir acción", status = "info"),
                                              uiOutput("repetir_task_ui")
                                       )
                              ),
                              br(),
                              hr(),
                              tags$div(id="bttn_modal", align = "center",
                                       actionBttn("estado_cierre_posible", "Pasar a proceso de cierre")
                              )
                            )
                          )
                        }else{
                          if(fase == "col_cie"){
                            div(
                              h4(HTML(paste0("<p><span style='color: #888888'>Estado: Colocación - Proceso de cierre</span></p>")), style = "margin-left: 10px"),
                              fluidRow(id = "inline", align = "center",
                                       column(3, selectInput("estado_sel_task", "Escojer acción", choices = acciones$accion)),
                                       column(3, dateInput("estado_date_task", "Agendar recordatorio", language = "es", value = "")),
                                       column(3, textAreaInput("estado_text_task", "Más detalles")),
                                       column(3, align = "left", style = "margin-top: 25px;",
                                              actionButton("estado_new_task_ok", "Guardar", 
                                                           style = paste0("background-color: ", main_color, ";
                                                                        color: white")),
                                              materialSwitch("repetir_task_check", "Repetir acción", status = "info"),
                                              uiOutput("repetir_task_ui")
                                       )
                              ),
                              br(),
                              hr(),
                              tags$div(id="bttn_modal", align = "center",
                                       actionBttn("cierre_exitoso", "Cierre exitoso")
                              )
                            )
                          }else{
                            if(fase == "busq"){
                              div(
                                h4(HTML(paste0("<p><span style='color: #888888'>Estado: Búsquedas</span></p>")), style = "margin-left: 10px"),
                                fluidRow(id = "inline", align = "center",
                                         column(3, selectInput("estado_sel_task", "Escojer acción", choices = acciones$accion)),
                                         column(3, dateInput("estado_date_task", "Agendar recordatorio", language = "es", value = "")),
                                         column(3, textAreaInput("estado_text_task", "Más detalles")),
                                         column(3, align = "left", style = "margin-top: 25px;",
                                                actionButton("estado_new_task_ok", "Guardar", 
                                                             style = paste0("background-color: ", main_color, ";
                                                                        color: white")),
                                                materialSwitch("repetir_task_check", "Repetir acción", status = "info"),
                                                uiOutput("repetir_task_ui")
                                         )
                                ),
                                br(),
                                hr(),
                                tags$div(id="bttn_modal", align = "center",
                                         actionBttn("estado_busqueda_culminada", "Búsqueda encontrada")
                                )
                              )
                            }else{
                              if(fase == "coor"){
                                div(
                                  h4(HTML(paste0("<p><span style='color: #888888'>Estado: Seguimiento Coordinadora</span></p>")), style = "margin-left: 10px"),
                                  fluidRow(id = "inline", align = "center",
                                           column(3, selectInput("estado_sel_task", "Escojer acción", choices = acciones$accion)),
                                           column(3, dateInput("estado_date_task", "Agendar recordatorio", language = "es", value = "")),
                                           column(3, textAreaInput("estado_text_task", "Más detalles")),
                                           column(3, align = "left", style = "margin-top: 25px;",
                                                  actionButton("estado_new_task_ok", "Guardar", 
                                                               style = paste0("background-color: ", main_color, ";
                                                                        color: white")),
                                                  materialSwitch("repetir_task_check", "Repetir acción", status = "info"),
                                                  uiOutput("repetir_task_ui")
                                           )
                                  ),
                                  br(),
                                )
                              }
                            }
                          }
                        }
                      }
                    }
                  }
        ),
        if(fase %in% c("col_cie", "col_seg")){
          div(style = "position: absolute; margin-top: -55px; margin-left: 10px", id = "inline",
              actionButton("dar_baja", "Dar de baja", icon = icon("trash-alt"), style = "background-color: #ffb3b3")
          )
        },
        fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; margin: 0px;",
                  h4(HTML(paste0("<p><span style='color: ", main_color, "'>Registro de actividades</span></p>")), style = "margin-left: 10px"),
                  div(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                  border-radius: 10px; background-color: white; padding: 0px; margin: 0px; width: 100%",
                      div(id = "inline", style = "margin-left: 20px",
                          div(class = "btn-group", textAreaInput("estado_last_call_obs", "Nuevo registro")),
                          div(class = "btn-group", actionButton("estado_last_call_ok", "Guardar", 
                                                                style = paste0("background-color: ", main_color, ";
                                                                        color: white")))
                      ),
                      dataTableOutput("table_llamadas")
                  )
        ),
        if(estado$urgente == "no"){
          div(id = "icon_info", style = "position: absolute; margin-top: 17px; margin-left: 30px",
              actionButton(inputId = "modal", label = NULL, icon = icon("star"), 
                           onclick = 'Shiny.setInputValue(\"estado_prioridad\", this.id, {priority: \"event\"})',
                           style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                                                  padding: 0px"),
              div(class = "icon_label", h5("prioridad"))
          )
        }else{
          div(id = "icon_info", style = "position: absolute; margin-top: 17px; margin-left: 30px",
              actionButton(inputId = "modal", label = NULL, icon = icon("star-o"), 
                           onclick = 'Shiny.setInputValue(\"estado_prioridad\", this.id, {priority: \"event\"})',
                           style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                                                  padding: 0px"),
              div(class = "icon_label", h5("sin prioridad"))
          )
        }
      )
    }else{
      div()
    }
  })
  
  observeEvent(input$close_estado, {
    vars$show_estado <- data.frame()
    removeModal()
  })
  
  output$repetir_task_ui <- renderUI({
    req(input$repetir_task_check)
    if(input$repetir_task_check == TRUE){
      div(
        dateInput("fin_repetir_task", "Repetir hasta", language = "es", value = ""),
        selectInput("periodo_repetir_task", NULL, choices = c("Mensualmente", "Quincenalmente", "Semanalmente"))
      )
    }
  })
  
  observeEvent(input$guardar_estado_comment, {
    update_var_table_mysql(input$estado_comment, "comment", "id", vars$show_estado$id, paste0(co, "_estados"))
    vars$show_estado$comment == input$estado_comment
    refresh_estado(isolate(refresh_estado()) + 1)
    removeModal()
  })
  
  observeEvent(input$editar_estado_comment, {
    showModal(modalDialog(
      textAreaInput("estado_comment_edit", NULL, value = vars$show_estado$comment),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("editar_estado_comment_ok", "Guardar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Editar observaciones",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$editar_estado_comment_ok, {
    update_var_table_mysql(input$estado_comment_edit, "comment", "id", vars$show_estado$id, paste0(co, "_estados"))
    vars$show_estado$comment == input$estado_comment_edit
    refresh_estado(isolate(refresh_estado()) + 1)
    removeModal()
  })
  
  observeEvent(input$estado_prioridad, {
    if(vars$show_estado$urgente == "no"){
      update_var_table_mysql("si", "urgente", "id", vars$show_estado$id, paste0(co, "_estados"))
    }else{
      update_var_table_mysql("no", "urgente", "id", vars$show_estado$id, paste0(co, "_estados"))
    }
    refresh_estado(isolate(refresh_estado()) + 1)
  })
  
  observeEvent(input$cierre_exitoso, {
    inmo <- list_table_var_mysql("myplace_inmuebles", "id", vars$show_estado$id_inmo)
    
    if(inmo$borrador == "si" & inmo$externa == "no"){
      showModal(modalDialog(
        h4("No se puede pasar a cierre una propiedad en borradores. Haz que tu broker publique la propiedad para luego pasarla a cierre."),
        br(),
        tags$div(id="bttn_modal", 
                 actionBttn("close_modal", "OK"),
                 align = "center"),
        title = "Iniciar proceso de cierre",
        easyClose = TRUE,
        footer = NULL,
        size = "m",
        fade = TRUE
      ))
    }else{
      vars$cierre_tipologia <- data.frame()
      showModal(modalDialog(
        div(id = "inline",
            if(inmo$tipoPropiedad == "Proyecto"){
              vars$cierre_tipologia <- list_table_var_mysql("myplace_tipologias", "id", inmo$id)
              vars$cierre_tipologia$selector <- paste0(vars$cierre_tipologia$titulo, " - ", vars$cierre_tipologia$moneda_contrato, 
                                                       vars$cierre_tipologia$precio, " - ", vars$cierre_tipologia$m2_cons, "m2")
              fluidRow(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; margin: 10px;",
                       selectInput("cierre_tipologia_sel", "Elija la tipología del Proyecto a cerrar",
                                   choices = vars$cierre_tipologia$selector),
                       numericInput("piso_cierre_tipologia", "¿En que piso se encuentra el departamento?", NULL, min = 1)
              )
            },
            fluidRow(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; margin: 10px;",
                     column(6,
                            radioButtons("cierre_moneda", "Moneda", inline = TRUE, choices = c("USD", "GS"), selected = inmo$moneda_contrato),
                            uiOutput("precio_cierre_ui")
                     ),
                     column(6,
                            dateInput("cierre_fecha", "Fecha de cierre"),
                            autonumericInput(inputId = "cierre_comision", align = "left",
                                             label = "Comisión pactada", 
                                             value = as.numeric(inmo$comision), currencySymbol = "%", currencySymbolPlacement = "s",
                                             decimalPlaces = 2, digitGroupSeparator = ".", decimalCharacter = ",")
                     )
                     
            ),
            #          br(),
            #          fluidRow(style = "padding: 0px; margin: 10px;",
            #            column(6, style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
            #                       border-radius: 10px; background-color: white;", align = "center",
            #                   h3("Referidos Captación"),
            #                   uiOutput("list_referidos_cap"),
            #                   br(),
            #                   actionButton("add_referido_cap", "Agregar"),
            #                   br(), br()
            #            ),
            #            column(6, style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
            #                       border-radius: 10px; background-color: white;", align = "center",
            #                   h3("Referidos Colocación"),
            #                   uiOutput("list_referidos_col"),
            #                   br(),
            #                   actionButton("add_referido_cap", "Agregar"),
            #                   br(), br()
            #            )
            #          )
            
        ),
        br(),
        tags$div(id="bttn_modal", 
                 actionBttn("cierre_exitoso_ok", "Pasar a cierre"),
                 actionBttn("close_modal", "Cancelar"),
                 align = "center"),
        title = "Iniciar proceso de cierre",
        easyClose = TRUE,
        footer = NULL,
        size = "m",
        fade = TRUE
      ))
    }
  })
  
  output$precio_cierre_ui <- renderUI({
    req(vars$cierre_tipologia)
    inmo <- list_table_var_mysql("myplace_inmuebles", "id", vars$show_estado$id_inmo)
    autonumericInput(inputId = "cierre_precio", align = "left",
                     label = "Precio de cierre", 
                     value = ifelse(nrow(vars$cierre_tipologia) != 0, vars$cierre_tipologia$precio[vars$cierre_tipologia$selector == input$cierre_tipologia_sel], inmo$precio), 
                     currencySymbol = ifelse(inmo$moneda_contrato == "USD", "$ ", "Gs "), currencySymbolPlacement = "p",
                     decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")
    
  })
  
  observeEvent(input$cierre_exitoso_ok, {
    inmo <- list_table_var_mysql("myplace_inmuebles", "id", vars$show_estado$id_inmo)
    estado <- vars$show_estado
    
    isolate({
      if(inmo$tipoPropiedad == "Proyecto"){
        galeria <- num_fotos_inmo(inmo$img, FALSE)
        print("galeria")
        print(galeria)
        id <- new_id_myplace_mysql("myplace_inmuebles", co, "inmueble", 10)
        rand <- str_pad(round(runif(1, min=1, max=999)), 3, pad = "0")
        img = ifelse(length(galeria) == 0, NA, 
                     paste0("https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/", id, "-01", "_", rand, "-small.jpg"))
        
        tipo <- vars$cierre_tipologia[vars$cierre_tipologia$selector == input$cierre_tipologia_sel, ]
        tipo$selector <- NULL
        print("tipo")
        print(tipo)
        inmo$tipoPropiedad <- "Departamento"
        inmo$fecha <- as.character(now("America/Asuncion"))
        inmo$precio <- tipo$precio
        inmo$m2_cons <- tipo$m2_cons
        inmo$dormitorios <- tipo$dormitorios
        inmo$banios <- tipo$banios
        inmo$garajes <- tipo$garajes
        inmo$bauleras <- tipo$bauleras
        inmo$balcon <- tipo$balcon
        inmo$parrilla <- tipo$parrilla
        inmo$area_servicio <- tipo$area_servicio
        inmo$pisos <- ifelse(is.na(input$piso_cierre_tipologia), 0, input$piso_cierre_tipologia)
        inmo$titulo <- paste0("Departamento: ", str_trunc(tipo$titulo, 240))
        inmo$id <- id
        inmo$img <- img
        inmo$tipo_contrato <- "Sin contrato"
        print("inmo")
        print(inmo)
        save_mysql(inmo, "myplace_inmuebles", FALSE)
        
        print("Inicia guardado de imagenes del departamento")
        if(length(galeria) > 0){
          for(i in 1: length(galeria)){
            im <- image_read(galeria[i])
            image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
            name <- paste0(id, "-", str_pad(i, 2, pad = "0"), "_", rand)
            put_object_do(paste0("/fotos-inmo/", name, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
            im <- image_scale(im, "300x")
            image_write(im, file.path(dir, "temp_foto_inmo.jpg"))
            put_object_do(paste0("/fotos-inmo/", name, "-small.jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
            print(paste0("Cargo ", i, " foto"))  
          }
        }

        print("estado colocacion")
        del_var_table_mysql("id", estado$id, paste0(co, "_estados"))
        estado$id <- new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12)
        estado$fecha <- as.character(now("America/Asuncion"))
        estado$id_inmo <- id
        estado$days_diff <- NULL
        estado$name <- str_replace(estado$name, "proyecto", "departamento")
        print(estado)
        save_mysql(estado, paste0(co, "_estados"), FALSE)
        
        print("estado captacion")
        estados_all <- list_table_var_mysql(paste0(co, "_estados"), "id_inmo", tipo$id)
        estado_cap <- estados_all %>% filter(id_clien == inmo$cliente & user == inmo$user)
        estado_cap$id <- new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12)
        estado_cap$fecha <- as.character(now("America/Asuncion"))
        estado_cap$name <- str_replace(estado_cap$name, "proyecto", "departamento")
        estado_cap$id_inmo <- id
        save_mysql(estado_cap, paste0(co, "_estados"), FALSE)
      }
      
      if(str_detect(estado$id_clien, "@")){
        clien <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", estado$id_clien)
        asesor_externo <- FALSE
      }else{
        clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", estado$id_clien)
        if(clien$tipo == "Cliente"){
          asesor_externo <- FALSE
        }else{
          asesor_externo <- TRUE
        }
      }
      
      update_var_table_mysql(input$cierre_precio, "precio_cierre", "id", inmo$id, "myplace_inmuebles")
      update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", inmo$id, "myplace_inmuebles")
      update_var_table_mysql(input$cierre_fecha, "fecha_cierre", "id", inmo$id, "myplace_inmuebles")
      update_var_table_mysql(input$cierre_comision, "comision", "id", inmo$id, "myplace_inmuebles")
      
      estados_all <- list_table_var_mysql(paste0(co, "_estados"), "id_inmo", inmo$id)
      print("estados all")
      print(estados_all)
      id_captacion <- estados_all %>% filter(id_clien == inmo$cliente & user == inmo$user & tipo_cliente == "captacion") %>% .$id
      print("id captacion")
      print(id_captacion)
      
      for(i in 1:nrow(estados_all)){
        update_var_table_mysql("4", "fase", "id", estados_all$id[i], paste0(co, "_estados"))
      }
      #    estados_delete <- estados_all$id[!estados_all$id %in% c(estado$id, id_captacion)]
      #    print("estados delete")
      #    print(estados_delete)
      #    if(length(estados_delete) != 0){
      #      del_var_table_mysql("id", estados_delete, paste0(co, "_estados"))
      #    }
      #    update_var_table_mysql("4", "fase", "id", id_captacion, paste0(co, "_estados"))
      #    update_var_table_mysql("4", "fase", "id", estado$id, paste0(co, "_estados"))
      print("estados en fase 4")
      
      llamadas <- list_table_var_mysql(paste0(co, "_llamadas"), "id_estado", estados_all$id)
      print(llamadas)
      if(nrow(llamadas) != 0){
        llamadas <- llamadas[llamadas$realizado == "no",]
        print(llamadas)
        if(nrow(llamadas) != 0){
          update_var_table_mysql("si", "realizado", "id", llamadas$id, paste0(co, "_llamadas"))
        }
      }
      print("tareas realizadas")
      
      user_captacion <- inmo$user
      if(user_captacion == vars$user$user){
        user_inmo <- vars$user
      }else{
        user_inmo <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", user_captacion)
      }

      agencia_captacion <- user_inmo$agencia
      user_captacion_comi <- user_inmo$comision
      print(user_captacion_comi)
      if(!is.null(user_captacion_comi) && is.na(user_captacion_comi)){
        user_captacion_comi <- 0.80
      }else{
        user_captacion_comi <- user_captacion_comi %>% str_extract("[0-9][0-9]")
        user_captacion_comi <- as.numeric(user_captacion_comi)/100
      }
      print("comision captacion")
      print(user_captacion_comi)
      
      user_colocacion <- ifelse(str_detect(estado$id_clien, "@"), estado$id_clien, vars$user$user)
      print("user_colocacion")
      print(user_colocacion)
    
      if(user_colocacion == vars$user$user){
        user_col <- vars$user
      }else{
        user_col <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", user_colocacion)
      }
      agencia_colocacion <- user_col$agencia
      user_colocacion_comi <- user_col$comision
      
      print(user_colocacion_comi)
      if(is.na(user_colocacion_comi)){
        user_colocacion_comi <- 0.80
      }else{
        user_colocacion_comi <- user_colocacion_comi %>% str_extract("[0-9][0-9]")
        user_colocacion_comi <- as.numeric(user_colocacion_comi)/100 
      }
      print("comision colocacion")
      print(user_colocacion_comi)
      
      print("precio cierre")
      print(input$cierre_precio)
      print("comision cierre")
      print(input$cierre_comision)
      
      comision <- round(as.numeric(input$cierre_precio)*as.numeric(input$cierre_comision)/100)
      print("comision total")
      print(comision)
      
      if(inmo$venta_alquiler == "Venta"){
        split_captacion <- comision*0.50
        split_colocacion <- comision*0.50
        global <- split_captacion*0.10
        split_oficina <- split_captacion*0.90
        comision_captacion <- split_oficina*user_captacion_comi
        comision_colocacion <- split_oficina*user_colocacion_comi
      }else{
        split_captacion <- comision
        split_colocacion <- comision
        global <- comision*0.10
        split_oficina <- comision*0.90
        comision_captacion <- split_oficina*user_captacion_comi
        comision_colocacion <- split_oficina*user_colocacion_comi
      }
      print("split captacion")
      print(split_captacion)
      
      print("comisiones calculadas")
      
      if(inmo$externa == "no"){
        print(paste0("user_captacion: ", user_captacion))
        print(paste0("id_captacion: ", id_captacion))
        print(paste0("cierre_precio: ", input$cierre_precio))
        print(paste0("cierre_fecha: ", input$cierre_fecha))
        print(paste0("cierre_comision: ", input$cierre_comision))
        print(paste0("cierre_moneda: ", input$cierre_moneda))
        print(paste0("agencia_captacion : ", agencia_captacion))
        new_trans_cap <- data.frame(
          id = new_id_table_mysql("id", paste0(co, "_transacciones"), "transaccion_", 12),
          fecha = as.character(now("America/Asuncion")),
          user = user_captacion,
          id_inmo = inmo$id,
          id_estado = id_captacion,
          tipo = "captación",
          fase = "4",
          venta_alquiler = inmo$venta_alquiler,
          fecha_cierre = input$cierre_fecha,
          precio_cierre = input$cierre_precio,
          comision_cierre = input$cierre_comision,
          comision_a_cobrar = split_captacion,
          comision_cobrada = 0,
          comision_user = user_captacion_comi*100,
          moneda = input$cierre_moneda,
          comision_asesor = round(comision_captacion),
          id_agencia = agencia_captacion
        )
        print(new_trans_cap)
        save_mysql(new_trans_cap, paste0(co, "_transacciones"), FALSE)
        print("transaccion de captacion ok")
        
        #        agen <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", inmo$user)
        #        agencia_nam <- agencia_name(agen$agencia, vars$agencias, vars$franquicias)
        #        if(agen$user != "gmayeregger@gmail.com"){
        #          stop <- TRUE
        #          intento <- 1
        #          while(stop){
        #            if(intento <= 3){
        #              generated <- generate_noticia_cierre(agen, agencia_nam, inmo, dir, session)
        #              if(generated){
        #                stop <- FALSE
        #              }else{
        #                intento <- intento + 1
        #              }
        #            }else{
        #              stop <- FALSE
        #            }
        #          }
        #        }
      }else{
        user_captacion <- "externa"
      }
      print("asesor externo")
      print(asesor_externo)
      if(!asesor_externo){
        print("empieza colocacion")
        new_trans_col <- data.frame(
          id = new_id_table_mysql("id", paste0(co, "_transacciones"), "transaccion_", 12),
          fecha = as.character(now("America/Asuncion")),
          user = user_colocacion,
          id_inmo = inmo$id,
          id_estado = estado$id,
          tipo = "colocación",
          fase = "4",
          venta_alquiler = inmo$venta_alquiler,
          fecha_cierre = input$cierre_fecha,
          precio_cierre = input$cierre_precio,
          comision_cierre = input$cierre_comision,
          comision_a_cobrar = split_colocacion,
          comision_cobrada = 0,
          comision_user = user_colocacion_comi*100,
          moneda = input$cierre_moneda,
          comision_asesor = round(comision_colocacion),
          id_agencia = agencia_colocacion #cambio reciente id agencia colocacion
        )
        print(new_trans_col)
        save_mysql(new_trans_col, paste0(co, "_transacciones"), FALSE)
        print("transaccion de colocacion ok")
        
        #generar cierre home
        #        if(user_captacion != user_colocacion){
        #          agen <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", user_colocacion)
        #          agencia_nam <- agencia_name(agen$agencia, vars$agencias, vars$franquicias)
        #          if(agen$user != "gmayeregger@gmail.com"){
        #            stop <- TRUE
        #            intento <- 1
        #            while(stop){
        #              if(intento <= 3){
        #                generated <- generate_noticia_cierre(agen, agencia_nam, inmo, dir, session)
        #                if(generated){
        #                  stop <- FALSE
        #                }else{
        #                  intento <- intento + 1
        #                }
        #              }else{
        #                stop <- FALSE
        #              }
        #            }
        #          }
        #        }
      }
    })
    
    office_trans_list <- list_table_var_mysql(paste0(co, "_transacciones"), "user", vars$user$user)
    if(nrow(office_trans_list) != 0){
      office_trans_list$user_name <- vars$user$name
      office_trans_list$pais_agencia <- ifelse(vars$user$agencia == "Global Master Office", "Paraguay", 
                                               ifelse(vars$user$agencia %in% vars$agencias$id, 
                                                      vars$agencias$pais[vars$agencias$id == vars$user$agencia], 
                                                      vars$franquicias$pais[vars$franquicias$id == vars$user$agencia]))
      office_trans_list$name_agenia <- ifelse(vars$user$agencia == "Global Master Office", "Global Master Office", 
                                              ifelse(vars$user$agencia %in% vars$agencias$id, 
                                                     vars$agencias$name[vars$agencias$id == vars$user$agencia], 
                                                     vars$franquicias$name[vars$franquicias$id == vars$user$agencia]))
      all_pages <- office_trans_list
      all_pages_2 <- all_pages %>% filter(fase == "5" | fase == "4")
      all_pages_3 <- all_pages %>% filter(fase == "6" & fecha >= as.character(now("America/Asuncion") - months(1)))
    }else{
      all_pages_2 <- data.frame()
      all_pages_3 <- data.frame()
    }
    
    isolate({
      if(nrow(all_pages_2) != 0){
        vars$trans_all_pages_2 <- all_pages_2
      }else{
        vars$trans_all_pages_2 <- data.frame()
      }
      if(nrow(all_pages_3) != 0){
        vars$trans_all_pages_3 <- all_pages_3
      }else{
        vars$trans_all_pages_3 <- data.frame()
      }
    })
    
    colocacion_on(0)
    captacion_on(0)
    cierres_on(1)
    busquedas_on(0)
    coordinadora_on(0)
    removeModal()
    
  })
  
  obs_open_estado_1 <- list()
  observe({
    if(estado_on() == 1 & cierres_on() == 0){
      req(vars$data_all_pages_1)
      if(nrow(vars$data_all_pages_1) != 0){
        print("vars$data_all_pages_1")
        print(vars$data_all_pages_1)
        if(busquedas_on() == 0){
          
          output$box_estado_1_list_ui <- renderUI({
            boxes_estado_1 <- as.list(1:nrow(vars$data_all_pages_1))
            boxes_estado_1 <- lapply(boxes_estado_1, function(i){
              btOpenEstado <- paste0("open_estado_1_button", i) 
              estado <- vars$data_all_pages_1[i,]
              if(estado$id_inmo == "coordinadora"){
                print("coordinadora")
                broker <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", estado$id_clien)
                inmo <- data.frame(id = "coordinadora", img = broker$img)
              }else{
                inmo <- list_table_var_mysql("myplace_inmuebles", "id", estado$id_inmo)
              }
              print("estado")
              print(estado)
              if(str_detect(estado$id_clien, "@")){
                clien <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", estado$id_clien)
              }else{
                clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", estado$id_clien)
              }
              print(clien$name)
              
              color_estado <- case_when(estado$days_diff < 0 ~ "red",
                                        estado$days_diff >= 0 ~ "#666666")
              if(estado$urgente == "si")
                color_estado <- "yellow"
              obs_open_estado_1[[btOpenEstado]] <<- observeEvent(input[[btOpenEstado]], ignoreNULL = TRUE, ignoreInit = TRUE, {
                freezeReactiveValue(input, btOpenEstado)
                estado <- vars$data_all_pages_1[i,]
                vars$show_estado <- estado
                modal_estado_description()
              })
              div(style = "padding: 5px; display:inline-block",
                  div(
                    div(style = paste0("border-style: solid; border-width: 2px; border-color: ", color_estado, "; 
                       border-radius: 10px; background-color: ", ifelse(inmo$externa == "si", main_color, "white"), "; width: 154px; height: 186px;
                                 margin: 0px; padding: 0px"),
                        if(str_detect(inmo$id, co)){
                          div(style = "position: absolute; margin-top: 5px; margin-left: 5px",
                              actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 60px; height: 20px; margin: 0px;
                                                             background-image: url("logo_SkyOne_borde_blanco.png");
                                                             background-size: cover, 60px 20px;'))
                          )
                        },
                        div(style = "width: 148px; height: 40px; position: absolute; margin-top: 105px; margin-left: 3px", 
                            HTML(paste0("<p><span style='font-size: 85%; font-weight: normal; color: ", ifelse(inmo$externa == "si", "white", "#888888"), "; height: 40px'>", 
                                        estado$name, "</span></p>"))
                        ),
                        div(style = "position: absolute; margin-top: 47px; margin-left: 90px;",
                            actionButton("nada" , NULL, style = paste0('background-color: transparent;
                                                                                                                  border: 0px; width:60px; height: 60px; margin: 0px;',
                                                                       ifelse(is.na(clien$img), paste0('background-image: url("blank_avatar.png");
                                                                                                                  background-size: cover, 60px 60px;'),
                                                                              paste0('background-image: url("', ifelse(estado$id_inmo == "coordinadora", vars$user$img, clien$img), '");
                                                                                                                  background-size: cover, 60px 60px;')),
                                                                       'border-radius: 30px 30px 30px 30px'))
                        ),
                        div(actionButton(btOpenEstado, NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:150px; height: 100px; margin: 0px;
                                                             background-image: url("', inmo$img, '");
                                                             background-size: cover, 150px 100px;
                                                             border-radius: 8px 8px 0px 0px')),
                        )
                    )
                  )
              )
            })
          })
          
        }else{ #busqueda
          
          output$box_estado_1_list_ui <- renderUI({
            boxes_estado_1 <- as.list(1:nrow(vars$data_all_pages_1))
            boxes_estado_1 <- lapply(boxes_estado_1, function(i){
              btOpenEstado <- paste0("open_estado_1_button", i) 
              estado <- vars$data_all_pages_1[i,]
              
              if(str_detect(estado$id_clien, "@")){
                clien <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", estado$id_clien)
              }else{
                clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", estado$id_clien)
              }
              print(clien$name)
              
              if(estado$urgente == "si"){
                color_estado <- "yellow"
              }else{
                color_estado <- "#666666"
              }
              obs_open_estado_1[[btOpenEstado]] <<- observeEvent(input[[btOpenEstado]], ignoreNULL = TRUE, ignoreInit = TRUE, {
                freezeReactiveValue(input, btOpenEstado)
                estado <- vars$data_all_pages_1[i,]
                vars$show_estado <- estado
                print("abrir estado")
                modal_estado_description()
              })
              div(style = "padding: 5px; display:inline-block",
                  div(
                    div(style = paste0("border-style: solid; border-width: 2px; border-color: ", color_estado, "; 
                       border-radius: 10px; background-color: white; width: 154px; height: 225px;
                                 margin: 0px; padding: 0px"),
                        div(style = "width: 148px; height: 40px; position: absolute; margin-top: 155px; margin-left: 3px", 
                            HTML(paste0("<p><span style='font-size: 90%; font-weight: normal; color: #666666; height: 40px'>", 
                                        estado$name, "</span></p>"))
                        ),
                        div(actionButton(btOpenEstado, NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:150px; height: 150px; margin: 0px;
                                                             background-image: url("', clien$img, '");
                                                             background-size: cover, 150px 150px;
                                                             border-radius: 8px 8px 0px 0px')),
                        )
                    )
                  )
              )
            })
          })
        }
      }else{
        output$box_estado_1_list_ui <- renderUI({
          div()
        })
      }
    }
  })
  
  obs_open_estado_2 <- list()
  observe({
    if(estado_on() == 1 & cierres_on() == 0){
      req(vars$data_all_pages_2)
      if(nrow(vars$data_all_pages_2) != 0){
        output$box_estado_2_list_ui <- renderUI({
          boxes_estado_2 <- as.list(1:nrow(vars$data_all_pages_2))
          boxes_estado_2 <- lapply(boxes_estado_2, function(i){
            btOpenEstado <- paste0("open_estado_2_button", i) 
            estado <- vars$data_all_pages_2[i,]
            print("estado")
            print(estado)
            inmo <- list_table_var_mysql("myplace_inmuebles", "id", estado$id_inmo)
            print("inmo")
            print(inmo)
            if(nrow(inmo) != 0){
              if(str_detect(estado$id_clien, "@")){
                clien <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", estado$id_clien)
              }else{
                clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", estado$id_clien)
              }
              
              color_estado <- case_when(estado$days_diff < 0 ~ "red",
                                        estado$days_diff >= 0 ~ "#666666")
              if(estado$urgente == "si")
                color_estado <- "yellow"
              obs_open_estado_2[[btOpenEstado]] <<- observeEvent(input[[btOpenEstado]], ignoreNULL = TRUE, ignoreInit = TRUE, {
                freezeReactiveValue(input, btOpenEstado)
                estado <- vars$data_all_pages_2[i,]
                vars$show_estado <- estado
                modal_estado_description()
              })
              
              div(style = "padding: 5px; display:inline-block",
                  div(
                    div(style = paste0("border-style: solid; border-width: 2px; border-color: ", color_estado, "; 
                       border-radius: 10px; background-color: ", ifelse(inmo$externa == "si", main_color, "white"), "; width: 154px; height: 186px;
                                 margin: 0px; padding: 0px"),
                        if(str_detect(inmo$id, co)){
                          div(style = "position: absolute; margin-top: 5px; margin-left: 5px",
                              actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 60px; height: 20px; margin: 0px;
                                                             background-image: url("logo_SkyOne_borde_blanco.png");
                                                             background-size: cover, 60px 20px;'))
                          )
                        },
                        div(style = "width: 148px; height: 40px; position: absolute; margin-top: 105px; margin-left: 3px", 
                            HTML(paste0("<p><span style='font-size: 85%; font-weight: normal; color: ", ifelse(inmo$externa == "si", "white", "#888888"), "; height: 40px'>", 
                                        estado$name, "</span></p>"))
                        ),
                        div(style = "position: absolute; margin-top: 47px; margin-left: 90px;",
                            actionButton("nada" , NULL, style = paste0('background-color: transparent;
                                                                                                                  border: 0px; width:60px; height: 60px; margin: 0px;',
                                                                       ifelse(is.na(clien$img), paste0('background-image: url("blank_avatar.png");
                                                                                                                  background-size: cover, 60px 60px;'),
                                                                              paste0('background-image: url("', clien$img, '");
                                                                                                                  background-size: cover, 60px 60px;')),
                                                                       'border-radius: 30px 30px 30px 30px'))
                        ),
                        div(actionButton(btOpenEstado, NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:150px; height: 100px; margin: 0px;
                                                             background-image: url("', inmo$img, '");
                                                             background-size: cover, 150px 100px;
                                                             border-radius: 8px 8px 0px 0px')),
                        )
                    )
                  )
              )
            }
          })
        })
      }else{
        output$box_estado_2_list_ui <- renderUI({
          div()
        })
      }
    }
  })
  
  obs_open_estado_3 <- list()
  observe({
    if(estado_on() == 1 & cierres_on() == 0){
      req(vars$data_all_pages_3)
      if(nrow(vars$data_all_pages_3) != 0){
        output$box_estado_3_list_ui <- renderUI({
          boxes_estado_3 <- as.list(1:nrow(vars$data_all_pages_3))
          boxes_estado_3 <- lapply(boxes_estado_3, function(i){
            btOpenEstado <- paste0("open_estado_3_button", i) 
            estado <- vars$data_all_pages_3[i,]
            inmo <- list_table_var_mysql("myplace_inmuebles", "id", estado$id_inmo)
            if(nrow(inmo) != 0){
              if(str_detect(estado$id_clien, "@")){
                clien <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", estado$id_clien)
              }else{
                clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", estado$id_clien)
              }
              print(clien$name)
              
              color_estado <- case_when(estado$days_diff < 0 ~ "red",
                                        estado$days_diff >= 0 ~ "#666666")
              if(estado$urgente == "si")
                color_estado <- "yellow"
              obs_open_estado_3[[btOpenEstado]] <<- observeEvent(input[[btOpenEstado]], ignoreNULL = TRUE, ignoreInit = TRUE, {
                freezeReactiveValue(input, btOpenEstado)
                estado <- vars$data_all_pages_3[i,]
                vars$show_estado <- estado
                modal_estado_description()
              })
              div(style = "padding: 5px; display:inline-block",
                  div(
                    div(style = paste0("border-style: solid; border-width: 2px; border-color: ", color_estado, "; 
                       border-radius: 10px; background-color: ", ifelse(inmo$externa == "si", main_color, "white"), "; width: 154px; height: 186px;
                                 margin: 0px; padding: 0px"),
                        if(str_detect(inmo$id, co)){
                          div(style = "position: absolute; margin-top: 5px; margin-left: 5px",
                              actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 60px; height: 20px; margin: 0px;
                                                             background-image: url("logo_SkyOne_borde_blanco.png");
                                                             background-size: cover, 60px 20px;'))
                          )
                        },
                        div(style = "width: 148px; height: 40px; position: absolute; margin-top: 105px; margin-left: 3px", 
                            HTML(paste0("<p><span style='font-size: 85%; font-weight: normal; color: ", ifelse(inmo$externa == "si", "white", "#888888"), "; height: 40px'>", 
                                        estado$name, "</span></p>"))
                        ),
                        div(style = "position: absolute; margin-top: 47px; margin-left: 90px;",
                            actionButton("nada" , NULL, style = paste0('background-color: transparent;
                                                                                                                  border: 0px; width:60px; height: 60px; margin: 0px;',
                                                                       ifelse(is.na(clien$img), paste0('background-image: url("blank_avatar.png");
                                                                                                                  background-size: cover, 60px 60px;'),
                                                                              paste0('background-image: url("', clien$img, '");
                                                                                                                  background-size: cover, 60px 60px;')),
                                                                       'border-radius: 30px 30px 30px 30px'))
                        ),
                        div(actionButton(btOpenEstado, NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:150px; height: 100px; margin: 0px;
                                                             background-image: url("', inmo$img, '");
                                                             background-size: cover, 150px 100px;
                                                             border-radius: 8px 8px 0px 0px')),
                        )
                    )
                  )
              )
            }
          })
        })
      }else{
        output$box_estado_3_list_ui <- renderUI({
          div()
        })
      }
    }
  })
  
  output$table_llamadas <- renderDataTable({
    llamadas <- vars$llamadas_list %>% mutate(fecha_dia = as_date(fecha), fecha_full = ifelse(is.na(fecha_agendada), as.character(fecha), paste0(fecha_agendada, " 12:00:00"))) %>% arrange(desc(fecha_full))
    datatable(llamadas %>% select(Fecha = fecha_dia, Agenda = fecha_agendada, Accion = accion, Detalles = comment, OK = realizado),
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 5, dom = 'ftp'), rownames = FALSE, selection = "single") %>% 
      formatStyle('OK',
                  backgroundColor = styleEqual(c("no", "si"), 
                                               c('#ff9696', '#9dff96')))
  })
  
  observeEvent(input$table_llamadas_rows_selected, {
    llamadas <- vars$llamadas_list %>% mutate(fecha_dia = as_date(fecha), fecha_full = ifelse(is.na(fecha_agendada), as.character(fecha), paste0(fecha_agendada, " 12:00:00"))) %>% arrange(desc(fecha_full))
    llam <- llamadas[input$table_llamadas_rows_selected,]
    print(llam)
    if(!is.na(llam$fecha_agendada)){
      if(llam$realizado == "si"){
        update_var_table_mysql("no", "realizado", "id", llam$id, paste0(co, "_llamadas"))
        vars$llamadas_list$realizado[vars$llamadas_list$id == llam$id] <- "no"
        print("tarea pasa a no")
      }else{
        update_var_table_mysql("si", "realizado", "id", llam$id, paste0(co, "_llamadas"))
        vars$llamadas_list$realizado[vars$llamadas_list$id == llam$id] <- "si"
        print("tarea pasa a si")
      }
      llamadas <- list_table_var1_var2_var3_mysql(paste0(co, "_llamadas"), "user", vars$user$user, "realizado", "no", "fecha_agendada", "NOT IN", "NA")
      if(nrow(llamadas) != 0){
        vars$new_cal <- llamadas %>% filter(fecha_agendada == as.character(as_date(now("America/Asuncion")))) %>% nrow()
        if(task_on() == 1){
          print("generate calendar")
          vars$calendar <- generate_calendar(llamadas)
        }
      }else{
        vars$new_cal <- 0
        vars$calendar <- data.frame()
      }
      
      if(estado_on() == 1){
        refresh_estado(isolate(refresh_estado()) + 1)
      }
    }
    print("opa marcar tarea si")
  })
  
  observeEvent(input$estado_new_task_ok, {
    if(length(input$estado_date_task) == 0){
      shinyalert(
        type = "error",
        title = "Debe escojer una fecha para la agenda"
      )
    }else{
      if(input$repetir_task_check == TRUE && !is.null(input$fin_repetir_task) && length(input$fin_repetir_task) == 0){
        shinyalert(
          type = "error",
          title = "Escoge una fecha límite para repetir la acción"
        )
      }else{
        new_llamada <- data.frame(
          id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
          fecha = as.character(now("America/Asuncion")),
          fecha_agendada = as.character(as_date(input$estado_date_task)),
          user = vars$user$user,
          id_inmo = ifelse(isolate(clientes_on()) == 1, NA, vars$show_estado$id_inmo),
          id_clien = ifelse(isolate(clientes_on()) == 1, vars$cliente$id, vars$show_estado$id_clien),
          id_estado = ifelse(isolate(clientes_on()) == 1, NA, vars$show_estado$id),
          accion = input$estado_sel_task,
          realizado = "no",
          agendado = "no",
          time = NA,
          visto = "no",
          comment = input$estado_text_task
        )
        save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
        
        if(input$repetir_task_check == TRUE){
          print("Repetir tarea")
          fin <- input$fin_repetir_task
          ini <- input$estado_date_task
          cada <- case_when(input$periodo_repetir_task == "Mensualmente" ~ 30,
                            input$periodo_repetir_task == "Quincenalmente" ~ 15,
                            input$periodo_repetir_task == "Semanalmente" ~ 7)
          last <- ini
          while(last <= fin){
            last <- as_date(last) + days(cada)
            
            new_llamada <- data.frame(
              id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
              fecha = as.character(now("America/Asuncion")),
              fecha_agendada = as.character(as_date(last)),
              user = vars$user$user,
              id_inmo = ifelse(isolate(clientes_on()) == 1, NA, vars$show_estado$id_inmo),
              id_clien = ifelse(isolate(clientes_on()) == 1, vars$cliente$id, vars$show_estado$id_clien),
              id_estado = ifelse(isolate(clientes_on()) == 1, NA, vars$show_estado$id),
              accion = input$estado_sel_task,
              realizado = "no",
              agendado = "no",
              time = NA,
              visto = "no",
              comment = input$estado_text_task
            )
            save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
          }
        }
        
        if(isolate(clientes_on()) == 1){
          vars$llamadas_list <- list_table_var_mysql(paste0(co, "_llamadas"), "id_clien", vars$cliente$id)
        }else{
          vars$llamadas_list <- list_table_var_mysql(paste0(co, "_llamadas"), "id_estado", vars$show_estado$id)
          refresh_estado(isolate(refresh_estado()) + 1)
        }
        llamadas <- list_table_var1_var2_var3_mysql(paste0(co, "_llamadas"), "user", vars$user$user, "realizado", "no", "fecha_agendada", "NOT IN", "NA")
        vars$new_cal <- llamadas %>% filter(fecha_agendada == as.character(as_date(now("America/Asuncion")))) %>% nrow()
        if(task_on() == 1){
          vars$calendar <- generate_calendar(llamadas)
        }
      }
    }
  })
  
  observeEvent(input$estado_last_call_ok, {
    req(input$estado_last_call_obs)
    print("inicia registro")
    print(input$estado_last_call_obs)
    print(vars$show_estado)
    new_llamada <- data.frame(
      id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
      fecha = as.character(now("America/Asuncion")),
      fecha_agendada = NA,
      user = vars$user$user,
      id_inmo = ifelse(isolate(clientes_on()) == 1, NA, vars$show_estado$id_inmo),
      id_clien = ifelse(isolate(clientes_on()) == 1, vars$cliente$id, vars$show_estado$id_clien),
      id_estado = ifelse(isolate(clientes_on()) == 1, NA, vars$show_estado$id),
      accion = "Registro",
      realizado = NA,
      agendado = "no",
      time = NA,
      visto = "si",
      comment = input$estado_last_call_obs
    )
    print(new_llamada)
    save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
    if(isolate(clientes_on()) == 1){
      vars$llamadas_list <- list_table_var_mysql(paste0(co, "_llamadas"), "id_clien", vars$cliente$id)
    }else{
      vars$llamadas_list <- list_table_var1_var2_var3_mysql(paste0(co, "_llamadas"), "user", vars$user$user, "id_inmo", 
                                                            vars$show_estado$id_inmo, "id_clien", "IN", vars$show_estado$id_clien)
    }
    updateTextAreaInput(session, "estado_last_call_obs", value = NULL)
  })
  
  observeEvent(input$estado_cierre_posible, {
    estado_colo_propio <- vars$show_estado
    inmo <- list_table_var_mysql("myplace_inmuebles", "id", estado_colo_propio$id_inmo)
    
    update_var_table_mysql("2", "fase", "id", estado_colo_propio$id, paste0(co, "_estados"))
    if(str_detect(estado_colo_propio$id_clien, "@")){
      clien <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", estado_colo_propio$id_clien)
      clien$tipo <- "Asesor SkyOne"
    }else{
      clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", estado_colo_propio$id_clien)
    }
    
    print("aqui 1")
    print(clien)
    new_llamada <- data.frame(
      id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
      fecha = as.character(now("America/Asuncion")),
      fecha_agendada = NA,
      user = vars$user$user,
      id_inmo = inmo$id,
      id_clien = estado_colo_propio$id_clien,
      id_estado = estado_colo_propio$id,
      accion = "Pasado a proceso de cierre",
      realizado = NA,
      agendado = "no",
      time = NA,
      visto = "no",
      comment = paste0("El ", clien$tipo, " ", clien$name, " esta dispuesto a adquirir la propiedad")
    )
    save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
    
    print("aqui 2")
    if(inmo$user != vars$user$user){
      estado_colo_tercero <- list_table_var1_var2_var3_mysql(paste0(co, "_estados"), "user", inmo$user, "id_inmo", inmo$id, "id_clien", "IN", vars$user$user)
      print(estado_colo_tercero)
      update_var_table_mysql("2", "fase", "id", estado_colo_tercero$id, paste0(co, "_estados"))
      
      print("aqui 3")
      new_llamada <- data.frame(
        id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
        fecha = as.character(now("America/Asuncion")),
        fecha_agendada = NA,
        user = inmo$user,
        id_inmo = inmo$id,
        id_clien = vars$user$user,
        id_estado = estado_colo_tercero$id,
        accion = "Pasado a proceso de cierre",
        realizado = NA,
        agendado = "no",
        time = NA,
        visto = "no",
        comment = paste0("El asesor SkyOne ", vars$user$name, " esta dispuesto a adquirir la propiedad")
      )
      print(new_llamada)
      save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
      
      print("aqui 4")
      new_alarma <- data.frame(
        id = new_id_table_mysql("id", paste0(co, "_alarmas"), "alarma_", 12),
        fecha = as.character(as_date(now("America/Asuncion"))),
        time = as.character(now("America/Asuncion")),
        user = vars$user$user,
        destino = inmo$user,
        id_inmo = inmo$id,
        id_clien = NA,
        id_estado = NA,
        id_busq = NA,
        id_noticia = NA,
        id_calificacion = NA,
        tipo = "Pasado a proceso de cierre",
        visto = "no",
        img = vars$show_inmo$img,
        comment = paste0("El asesor SkyOne ", vars$user$name, " está dispuesto a adquirir la propiedad")
      )
      save_mysql(new_alarma, paste0(co, "_alarmas"), FALSE)
    }
    
    estado_capta <- list_table_var1_var2_var3_mysql(paste0(co, "_estados"), "user", inmo$user, "id_inmo", inmo$id, "id_clien", "IN", inmo$cliente)
    print(estado_capta)
    update_var_table_mysql("3", "fase", "id", estado_capta$id, paste0(co, "_estados"))
    
    #    print("aqui 5")
    #    new_llamada <- data.frame(
    #      id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
    #      fecha = as.character(now("America/Asuncion")),
    #      fecha_agendada = NA,
    #      user = inmo$user,
    #      id_inmo = inmo$id,
    #      id_clien = inmo$cliente,
    #      id_estado = estado_capta$id,
    #      accion = "Pasado a proceso de cierre",
    #      realizado = NA,
    #      agendado = "no",
    #      time = NA,
    #      visto = "no",
    #      comment = ifelse(inmo$user == vars$user$user, 
    #                       paste0(ifelse(clien$tipo == "Cliente", "El cliente ", "El asesor externo "), clien$name,  " esta dispuesto a adquirir la propiedad"), 
    #                       paste0("Al asesor ", vars$user$name,  " esta dispuesto a adquirir la propiedad"))
    #    )
    #    print(new_llamada)
    #    save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
    
    refresh_estado(isolate(refresh_estado()) + 1)
    removeModal()
  })
  
  observeEvent(input$dar_baja, {
    showModal(modalDialog(
      h4("¿Está seguro de querer dar de baja esta operación?"),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("dar_baja_ok", "Dar de baja"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Seguimiento a propiedad",
      easyClose = FALSE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$dar_baja_ok, {
    estado <- vars$show_estado
    print(estado$id)
    inmo <- list_table_var_mysql("myplace_inmuebles", "id", estado$id_inmo)
    print(inmo$id)
    if(str_detect(estado$id_clien, "@")){
      clien <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", estado$id_clien)
      clien$tipo <- "Asesor SkyOne"
    }else{
      clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", estado$id_clien)
    }
    print(clien$name)
    del_var_table_mysql("id_estado", estado$id, paste0(co, "_llamadas"))
    
    estado_capta <- list_table_var1_var2_var3_mysql(paste0(co, "_estados"), "user", inmo$user, "id_inmo", inmo$id, "id_clien", "IN", inmo$cliente)
    print(estado_capta$id)
    new_llamada <- data.frame(
      id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
      fecha = as.character(now("America/Asuncion")),
      fecha_agendada = NA,
      user = inmo$user,
      id_inmo = inmo$id,
      id_clien = inmo$cliente,
      id_estado = estado_capta$id,
      accion = "Dar de baja operacion",
      realizado = NA,
      agendado = "no",
      time = NA,
      visto = "no",
      comment = paste0("La operacion con el ", clien$tipo , " ", clien$name, " ha sido dada de baja")
    )
    save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
    
    del_var_table_mysql("id", estado$id, paste0(co, "_estados"))
    
    estados_all <- list_table_var1_var2_var3_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", inmo$id, "tipo_cliente", "IN", "colocacion")$fase
    print(estados_all)
    if(length(estados_all) == 0){
      update_var_table_mysql(ifelse(inmo$tipo_contrato == "Sin contrato", "1", "2"), "fase", "id", estado_capta$id, paste0(co, "_estados"))
    }else{
      if(!"3" %in% estados_all){
        update_var_table_mysql(ifelse(inmo$tipo_contrato == "Sin contrato", "1", "2"), "fase", "id", estado_capta$id, paste0(co, "_estados"))
      }
    }
    
    if(inmo$user != vars$user$user){
      estado_tercero <- list_table_var1_var2_var3_mysql(paste0(co, "_estados"), "user", inmo$user, "id_inmo", inmo$id, "id_clien", "IN", vars$user$user)
      del_var_table_mysql("id", estado_tercero$id, paste0(co, "_estados"))
      del_var_table_mysql("id_estado", estado_tercero$id, paste0(co, "_llamadas"))
      print(estado_tercero$id)
      new_alarma <- data.frame(
        id = new_id_table_mysql("id", paste0(co, "_alarmas"), "alarma_", 12),
        fecha = as.character(as_date(now("America/Asuncion"))),
        time = as.character(now("America/Asuncion")),
        user = vars$user$user,
        destino = inmo$user,
        id_inmo = inmo$id,
        id_clien = NA,
        id_estado = NA,
        id_noticia = NA,
        id_calificacion = NA,
        id_busq = NA,
        tipo = "Dar de baja operacion",
        visto = "no",
        img = inmo$img,
        comment = paste0("El asesor ", vars$user$name, " ha dado de baja una operacion")
      )
      save_mysql(new_alarma, paste0(co, "_alarmas"), FALSE)
    }
    refresh_estado(isolate(refresh_estado()) + 1)
    removeModal()
  })
  
  observeEvent(input$inmo_history, {
    llamadas <- list_table_var1_var2_var3_mysql(paste0(co, "_llamadas"), "user", vars$user$user, "id_inmo", vars$show_inmo$id, "id_clien", "IN", vars$show_inmo$cliente)
    vars$llamadas_list <- llamadas
    print(llamadas)
    estado <- list_table_var1_var2_var3_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", vars$show_inmo$id, "id_clien", "IN", vars$show_inmo$cliente)
    vars$show_estado <- estado
    print(estado)
    showModal(modalDialog(
      fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; margin: 0px;"),
                h4(HTML(paste0("<p><span style='color: ", main_color, "'>Registro de actividades</span></p>")), style = "margin-left: 10px"),
                div(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                  border-radius: 10px; background-color: white; padding: 0px; margin: 0px; width: 100%",
                    div(id = "inline", style = "margin-left: 20px",
                        div(class = "btn-group", textAreaInput("estado_last_call_obs", "Nuevo registro")),
                        div(class = "btn-group", actionButton("estado_last_call_ok", "Guardar", 
                                                              style = paste0("background-color: ", main_color, ";
                                                                        color: white")))
                    ),
                    dataTableOutput("table_llamadas")
                )
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("close_modal", "OK"),
               align = "center"),
      title = "Historial de registros",
      easyClose = TRUE,
      footer = NULL,
      size = "l",
      fade = TRUE
    ))
  })
  
  
  ###################################################################################################################################  
  ###################################################################################################################################  
  # Crear Propiedades
  
  output$show_inmo_ui <- renderUI({
    if(nrow(vars$show_inmo) != 0){
      inmo <- vars$show_inmo
      vars$co <- str_split(inmo$id, "_")[[1]][1]
      print(inmo)
      print("Precio")
      if(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta"){
        inmo$precio_cierre <- round(inmo$precio_cierre/1000000)
        inmo$precio <- round(inmo$precio/1000000)
      }
      print(format(inmo$precio, big.mark = ".", decimal.mark = ",", scientific = FALSE))
      clien <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", inmo$id) %>%
        select(id = id_clien, tipo_clien = tipo_cliente)
      clien$tipo_clien <- ifelse(clien$tipo_clien == "colocacion", "interesado", "vendedor")
      if(inmo$user != vars$user$user){
        clien_tercero <- data.frame(id = inmo$user, tipo_clien = "captador")
        clien <- rbind(clien_tercero, clien)
      }
      if(nrow(clien) != 0){
        vars$list_clientes_vinc <- clien
      }else{
        vars$list_clientes_vinc <- data.frame()
      }
      vars$gal <- NA
      vars$index <- 0
      
      vars$gal <- num_fotos_inmo(vars$show_inmo$img, TRUE)
      
      vars$main_foto_gal <- vars$gal[1]
      vars$gal_now <- 1
      
      agente <- list_table_var_mysql("myplace_usuarios", "user", inmo$user)
      print("agente")
      print(agente)
      if(vars$co == "place"){
        agencia_nam <- agente$empresa
      }else{
        agencia_nam <- agencia_name(agente$agencia, vars$agencias, vars$franquicias)
      }
      
      ubi <- data.frame(lat = inmo$lat, lon = inmo$lon)
      
      vars$map_show_inmo <- FALSE
      size <- 100/100000
      lat_min <- ubi$lat - size
      lat_max <- ubi$lat + size
      lon_min <- ubi$lon - size
      lon_max <- ubi$lon + size
      fotos_360 <- filter_box_table_mysql(lat_min, lat_max, lon_min, lon_max, "fotos_street360")
      
      output$map_show_inmo <- renderLeaflet({
        map <- leaflet(height = "100%") %>% addSearchOSM() %>% 
          setView(inmo$lon, inmo$lat, zoom = 18) %>%
          addMarkers(lng = inmo$lon, lat = inmo$lat, icon = skyone_marker) %>%
          addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
          addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
          addLayersControl(baseGroups = c("mapa", "satélite"),
                           options = layersControlOptions(collapsed=FALSE), position = "bottomleft")
        if(nrow(fotos_360) != 0){
          map <- map %>% addMarkers(data = fotos_360, icon = pin_360, 
                                    popup = ~paste0('<iframe width="200" height="200" allowfullscreen style="border-style:none;" src="https://cdn.pannellum.org/2.5/pannellum.htm#panorama=', img, '&autoLoad=true&autoRotate=2"></iframe>'))
        }
        map
      })
      
      if(inmo$tipoPropiedad == "Proyecto"){
        tipologias <- list_table_var_mysql("myplace_tipologias", "id", inmo$id)
        vars$tipologia_list_all <- tipologias %>% arrange(fecha)
        if(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta"){
          tipologias$precio <- round(tipologias$precio/1000000)
        }
        precio_min <- format(min(tipologias$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)
        precio_max <- format(max(tipologias$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)
        dormitorios_min <- min(ifelse(is.na(as.integer(tipologias$dormitorios)), 1, as.integer(tipologias$dormitorios)))
        dormitorios_max <- max(ifelse(is.na(as.integer(tipologias$dormitorios)), 1, as.integer(tipologias$dormitorios)))
        banios_min <- min(as.integer(tipologias$banios))
        banios_max <- max(as.integer(tipologias$banios))
        m2_cons_min <- format(round(min(tipologias$m2_cons)), big.mark = ".", decimal.mark = ",", scientific = FALSE)
        m2_cons_max <- format(round(max(tipologias$m2_cons)), big.mark = ".", decimal.mark = ",", scientific = FALSE)
        garajes_min <- min(as.integer(tipologias$garajes))
        garajes_max <- max(as.integer(tipologias$garajes))
        bauleras_min <- min(as.integer(tipologias$bauleras))
        bauleras_max <- max(as.integer(tipologias$bauleras))
      }
      
      new_vista_myplace <- data.frame(
        id = new_id_table_mysql("id", "vistas_myplace", "vista_", 14),
        company = co,
        fecha = as.character(now("America/Asuncion")),
        user = vars$user$user,
        id_inmo = inmo$id
      )
      save_mysql(new_vista_myplace, "vistas_myplace", FALSE)
      
      vistas <- list_table_var_mysql("vistas_myplace", "id_inmo", inmo$id) %>%
        group_by(user) %>% summarize(n = n()) %>% nrow()
      
      contactos <- list_table_var_mysql("contactos_myplace", "id_inmo", inmo$id) %>%
        group_by(user) %>% summarize(n = n()) %>% nrow()
      
      follow <- list_table_var1_var2_mysql(paste0(co, "_seguidas"), "user", vars$user$user, "id_inmo", inmo$id) %>% nrow()
      print("follow")
      print(follow)
      show_inmo_on(1)
      
      div(
        if(office_prop_on() == 1){
          div(
            h5(paste0("Fecha de creación: ", as_date(inmo$fecha_creacion))),
            h5(paste0("Última edición: ", as_date(inmo$fecha))),
            br()
          )
        },
        div(HTML(paste0("<p><span style='font-size: 180%; font-weight: bold; color: #666666'>", 
                        str_to_upper(inmo$titulo), "</span></p>")), align = "center"),
        div(align = "center",
            div(class = "btn-group", style = "margin-bottom: 10px; margin-top: 7px",
                div(align = "center", uiOutput("galeria_fotos_ui"))
            ),
            div(style = "width: 342px", class = "btn-group",
                div(
                  fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; min-height: 200px; margin: 0px;
                                                    margin-bottom: 10px",
                            
                            div(style = "padding: 0px",
                                div(
                                  div(style = "padding: 0px; position: absolute; margin-top: 0px; margin-left: 0px",
                                      HTML(paste0("<p><span style='font-size: 120%; font-weight: normal; color: #888888'>", 
                                                  inmo$tipoPropiedad, " en ", inmo$venta_alquiler, "</span></p>")),
                                  ),
                                  div(style = "padding: 0px; position: absolute; margin-top: 0px; margin-left: 260px",
                                      HTML(paste0("<p><span style='font-size: 120%; font-weight: bold; color: #888888'>", 
                                                  "ID: ", as.integer(str_flatten(str_extract_all(inmo$id, "\\d")[[1]])))),
                                  )
                                ),
                                if(inmo$tipoPropiedad == "Proyecto"){
                                  if(precio_min == precio_max){
                                    div(style = "position: absolute; margin-left: 0px; margin-top: 30px",
                                        HTML(paste0("<p><span style='font-size: 190%; font-weight: lighter; color: ", main_color, "'>", 
                                                    inmo$moneda_contrato, " ", precio_min, 
                                                    ifelse(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta", " millones", ""), "</span></p>"))
                                    )
                                  }else{
                                    div(style = "position: absolute; margin-left: 0px; margin-top: 30px",
                                        HTML(paste0("<p><span style='font-size: 190%; font-weight: lighter; color: ", main_color, "'>", 
                                                    inmo$moneda_contrato, " ", precio_min, " - ", precio_max, 
                                                    ifelse(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta", " millones", ""), "</span></p>"))
                                    )
                                  }
                                }else{
                                  div(style = "position: absolute; margin-left: 0px; margin-top: 30px",
                                      HTML(paste0("<p><span style='font-size: 190%; font-weight: lighter; color: ", main_color, "'>", 
                                                  inmo$moneda_contrato, " ", format(inmo$precio, big.mark = ".", decimal.mark = ",", scientific = FALSE), 
                                                  ifelse(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta", " millones", ""), "</span></p>"))
                                  )
                                },
                                div(style = "position: absolute; margin-left: 0px; margin-top: 75px",
                                    if(inmo$m2 != 0){
                                      if(inmo$tipoPropiedad != "Propiedad rural"){
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-ruler-combined'></i> ", 
                                                        format(inmo$m2, big.mark = ".", decimal.mark = ",", scientific = FALSE), "m2 Terreno", "</span></p>")))
                                      }else{
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-ruler-combined'></i> ", 
                                                        format(inmo$m2/10000, big.mark = ".", decimal.mark = ",", scientific = FALSE), " hectareas", "</span></p>")))
                                      }
                                    },
                                    if(inmo$m2_cons != 0){
                                      div(class = "btn-group",
                                          HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-home'></i> ", 
                                                      inmo$m2_cons, "m2 Edificados", "</span></p>")))
                                    }else{
                                      if(inmo$tipoPropiedad == "Proyecto"){
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-home'></i> ", 
                                                        ifelse(m2_cons_min == m2_cons_max, m2_cons_min, paste0(m2_cons_min, "-", m2_cons_max)),
                                                        "m2 Edif.", "</span></p>")))
                                      }
                                    },
                                    if(inmo$frente != 0)
                                      div(class = "btn-group",
                                          HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-ruler-horizontal'></i> ", 
                                                      inmo$frente, "m Frente", "</span></p>"))),
                                    if(inmo$fondo != 0)
                                      div(class = "btn-group",
                                          HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-ruler-vertical'></i> ", 
                                                      inmo$fondo, "m Fondo", "</span></p>"))),
                                    if(!is.na(inmo$dormitorios)){
                                      div(class = "btn-group",
                                          HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-bed'></i> ", 
                                                      inmo$dormitorios, " Dormitorios", "</span></p>")))
                                    }else{
                                      if(inmo$tipoPropiedad == "Proyecto"){
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-bed'></i> ", 
                                                        ifelse(dormitorios_min == dormitorios_max, dormitorios_min, paste0(dormitorios_min, "-", dormitorios_max)), 
                                                        " Dormitorios", "</span></p>")))
                                      }
                                    },
                                    if(!is.na(inmo$banios)){
                                      div(class = "btn-group",
                                          HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-bath'></i> ", 
                                                      inmo$banios, " Baños", "</span></p>")))
                                    }else{
                                      if(inmo$tipoPropiedad == "Proyecto"){
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-bath'></i> ", 
                                                        ifelse(banios_min == banios_max, banios_min, paste0(banios_min, "-", banios_max)), 
                                                        " Baños", "</span></p>")))
                                      }
                                    },
                                    if(!is.na(inmo$garajes)){
                                      div(class = "btn-group",
                                          HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-car-side'></i> ", 
                                                      inmo$garajes, " Cocheras", "</span></p>")))
                                    }else{
                                      if(inmo$tipoPropiedad == "Proyecto"){
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-car-side'></i> ", 
                                                        ifelse(garajes_min == garajes_max, garajes_min, paste0(garajes_min, "-", garajes_max)), 
                                                        " Cocheras", "</span></p>")))
                                      }
                                    },
                                    if(!is.na(inmo$bauleras)){
                                      div(class = "btn-group",
                                          HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-suitcase'></i> ", 
                                                      inmo$bauleras, " Bauleras", "</span></p>")))
                                    }else{
                                      if(inmo$tipoPropiedad == "Proyecto"){
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-suitcase'></i> ", 
                                                        ifelse(bauleras_min == bauleras_max, bauleras_min, paste0(bauleras_min, "-", bauleras_max)), 
                                                        " Bauleras", "</span></p>")))
                                      }
                                    },
                                    if(!is.na(inmo$banios_compartidos)){
                                      div(class = "btn-group",
                                          HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-toilet'></i> ", 
                                                      inmo$banios_compartidos, " Baños compartidos", "</span></p>")))
                                    },
                                    if(!is.na(inmo$oficinas)){
                                      div(class = "btn-group",
                                          HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-laptop-house'></i> ", 
                                                      inmo$oficinas, " Oficinas", "</span></p>")))
                                    },
                                    if(!is.na(inmo$area_servicio)){
                                      if(inmo$area_servicio == "si")
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-broom'></i> ", 
                                                        " Area de servicio", "</span></p>")))
                                    },
                                    if(!is.na(inmo$cocina_equipada)){
                                      if(inmo$cocina_equipada == "si")
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-utensils'></i> ", 
                                                        " Cocina equipada", "</span></p>")))
                                    },
                                    if(!is.na(inmo$cocina_propia)){
                                      if(inmo$cocina_propia == "si")
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-utensils'></i> ", 
                                                        " Kitchenette", "</span></p>")))
                                    },
                                    if(!is.na(inmo$quincho)){
                                      if(inmo$quincho == "si")
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-drumstick-bite'></i> ", 
                                                        " Quincho", "</span></p>")))
                                    },
                                    if(!is.na(inmo$deposito)){
                                      if(inmo$deposito == "si")
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-warehouse'></i> ", 
                                                        " Depósito", "</span></p>")))
                                    },
                                    if(!is.na(inmo$piscina)){
                                      if(inmo$piscina == "si")
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-swimming-pool'></i> ", 
                                                        " Piscina", "</span></p>")))
                                    },
                                    if(!is.na(inmo$gimnasio)){
                                      if(inmo$gimnasio == "si")
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-dumbbell'></i> ", 
                                                        " Gimnasio", "</span></p>")))
                                    },
                                    if(!is.na(inmo$generador)){
                                      if(inmo$generador == "si")
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-bolt'></i> ", 
                                                        " Generador", "</span></p>")))
                                    },
                                    if(!is.na(inmo$trifacico)){
                                      if(inmo$trifacico == "si")
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-plug'></i> ", 
                                                        " Trifacico", "</span></p>")))
                                    },
                                    if(!is.na(inmo$pet_friendly)){
                                      if(inmo$pet_friendly == "si")
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-dog'></i> ", 
                                                        " Pet friendly", "</span></p>")))
                                    },
                                    if(!is.na(inmo$ascensor)){
                                      ascensor <- str_extract_all(inmo$ascensor, "\\d+")[[1]] %>% as.integer()
                                      if(ascensor > 0)
                                        div(class = "btn-group",
                                            HTML(paste0("<p><span style='padding-right: 7px; font-size: 90%; font-weight: normal; color: black'><i class='fa fa-dashboard'></i> ", 
                                                        " Ascensor", "</span></p>")))
                                    }
                                )
                            )
                  ),
                  fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 125px;
                                       margin: 0px; padding-left: 10px",
                            div(align = "left",
                                div(class = "btn-group", style = "width: 200px",
                                    HTML("<p><span style='font-size: 100%; font-weight: normal; color: #888888'>Asesor inmobiliario</span></p>"),
                                    h4(agente$name),
                                    h5(agencia_nam, style = "padding-bottom: 0px; margin-bottom: 4px"),
                                    if(!is.na(agente$face)){
                                      div(class = "btn-group",
                                          a(href = agente$face, target="_blank", actionButton("contacto_face", NULL , icon = icon("facebook"),
                                                                                              style = "font-size: 150%; padding: 0px; padding-left: 0px; background-color: transparent; border-color: transparent"))
                                      )
                                    },
                                    if(!is.na(agente$insta)){
                                      div(class = "btn-group",
                                          a(href = agente$insta, target="_blank", actionButton("contacto_insta", NULL , icon = icon("instagram"),
                                                                                               style = "font-size: 150%; padding: 0px; padding-left: 20px; background-color: transparent; border-color: transparent"))
                                      )
                                    },
                                    if(agente$user != ""){
                                      div(class = "btn-group",
                                          a(href= paste0("mailto:", agente$user), target="_blank", 
                                            actionButton("contacto_mail", "" , icon = icon("envelope"),
                                                         style = "font-size: 150%; padding: 0px; padding-left: 20px; background-color: transparent; border-color: transparent"))
                                      )
                                    },
                                    if(!is.na(agente$phone)){
                                      text_wp <- paste0("https://wa.me/", agente$phone, "?text=", "")
                                      div(class = "btn-group",
                                          a(href= text_wp, target="_blank", actionButton("contacto_wha", NULL , icon = icon("whatsapp"),
                                                                                         style = "font-size: 150%; padding: 0px; padding-left: 20px;
                                                                                                          background-color: transparent; border-color: transparent"))
                                      )
                                    },
                                    #if(!is.na(agente$phone)){
                                    #  div(class = "btn-group",
                                    #      h5(agente$phone, style = "padding-left: 10px")
                                    #  )
                                    #}
                                ),
                                div(class = "btn-group", style = "position: absolute; margin-left: 10px; margin-top: 0px",
                                    div(actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:110px; height: 110px; margin: 0px;
                                                             background-image: url("', agente$img, '");
                                                             background-size: cover, 110px 110px;
                                                             border-radius: 8px 8px 8px 8px')),
                                    )
                                )
                            )
                  )
                )
            )
        ),
        if(!is.na(inmo$video)){
          video <- inmo$video
          print(video)
          if(str_detect(video, "youtu.be")){
            video <- str_replace(video, fixed("youtu.be/"), fixed("youtube.com/embed/"))
          }else{
            if(str_detect(video, fixed("youtube.com/watch?v="))){
              video <- str_replace(video, fixed("youtube.com/watch?v="), fixed("youtube.com/embed/"))
            }else{
              if(str_detect(video, fixed("youtube.com/shorts/"))){
                video <- video
              }
            }
          }
          print(video)
          if(str_detect(video, fixed("?"))){
            video <- str_split(video, fixed("?"))[[1]][1]
          }
          print(video)
          
          video <- str_split(video, "/")[[1]]
          video <- video[length(video)]
          print(video)
          
          fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; min-width: 342px; 
                       border-radius: 10px; background-color: white; padding: 10px; margin: 0px; margin-top: 10px",
                    div(embed_youtube(video), align = "center")
          )
        },
        if(inmo$tipoPropiedad == "Proyecto"){
          fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; margin: 0px; margin-top: 10px",
                    HTML("<p><span style='font-size: 120%; font-weight: normal; color: #888888'>Tipologías</span></p>"),
                    div(uiOutput("tipologias_box_ui"), align = "center")
          )
        },
        div(
          div(align = "center",
              div(class = "btn-group", style = "width: 342px", align = "left",
                  fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; height: 250px; margin: 0px;
                                                    margin-top: 10px",
                            HTML("<p><span style='font-size: 120%; font-weight: normal; color: #888888'>Descripción</span></p>"),
                            div(style = "overflow-y: scroll; height: 200px",
                                HTML(paste0("<p><span style='font-size: 100%; font-weight: normal; color: black; white-space: pre-wrap;'>", inmo$descripcion, "</span></p>"))
                            )
                  )
              ),
              div(class = "btn-group", style = "width: 342px",
                  fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 3px; margin: 0px;
                                                    margin-top: 10px",
                            leafletOutput("map_show_inmo", height = 242)
                  )
              )
          ),
          if(inmo_input_on() == 1 & vars$co == "skyone"){ #estado_on() == 0
            fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; min-height: 190px; margin: 0px;
                                                    margin-top: 10px",
                      fluidRow(style = "padding: 0px",
                               column(6, HTML(paste0("<p><span style='font-size: 120%; font-weight: normal; color: #888888'>Vinculados</span></p>"))),
                               column(6, id = "inline", actionButton("vincular_clien_inmo", "Vincular interesado", icon = icon("link")), align = "right")
                      ),
                      div(uiOutput("box_clien_vinc_list_ui"), align = "center")
            )
          }
        ),
        if(office_prop_on() == 1 & inmo$externa == "no" & inmo$precio_cierre == 0){
          if(inmo$borrador == "si"){
            output$map_new_inmo <- renderLeaflet({
              map <- leaflet() %>% addSearchOSM() %>% 
                setView(inmo$lon, inmo$lat, zoom = 16) %>%
                addMarkers(inmo$lon, inmo$lat, icon = skyone_marker, layerId = "pin") %>%
                addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
                addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
                addLayersControl(baseGroups = c("mapa", "satélite"),
                                 options = layersControlOptions(collapsed=FALSE), position = "bottomleft")
              ubi <- c(inmo$lon, inmo$lat)
              size <- 300/100000
              lat_min <- ubi[2] - size
              lat_max <- ubi[2] + size
              lon_min <- ubi[1] - size
              lon_max <- ubi[1] + size
              inmos <- filter_box_table_mysql(lat_min, lat_max, lon_min, lon_max, "myplace_inmuebles")
              print(paste0(nrow(inmos), " propiedades cercanas bruto"))
              inmos <- inmos %>% filter(tipoPropiedad == inmo$tipoPropiedad & borrador == "no" & activo == "si" & precio_cierre == 0 &
                                          externa == "no" & id != inmo$id)
              print(paste0(nrow(inmos), " propiedades cercanas filtrado"))
              if(nrow(inmos) != 0){
                map <- map %>% addMarkers(data = inmos, icon = ~icon_inmo(tipoPropiedad), layerId = ~id,
                                          popup = ~paste0("<b>", titulo, "</b>",
                                                          ifelse(!is.na(m2) & m2 != 0, paste0("<br><b>Area terreno = </b>", round(m2), " m2"), ""),
                                                          ifelse(!is.na(m2_cons) & m2_cons != 0,
                                                                 paste0("<br><b>Area construida = </b>", round(m2_cons), " m2"), ""),
                                                          ifelse(!is.na(dormitorios), paste0("<br><b>Dormitorios = </b>", dormitorios), ""),
                                                          ifelse(!is.na(banios), paste0("<br><b>Baños = </b>", banios), ""),
                                                          "<br><b>Precio = </b>", moneda_contrato, " ", format(precio, big.mark=".", decimal.mark = ","),
                                                          "<br><b>Usuario = </b>", user,
                                                          "<br><b>Propiedad ", ifelse(company == "skyone", "SkyOne", "Externa"), "</b>",
                                                          "<br><img src = ", img, ' style=width:150px;height:100px;</img>'))
              }
              map
            })
          }
          
          vars$galeria_fotos_cont <- c()
          list <- list_spaces_do(prefix = paste0(co, "/fotos-contratos/", inmo$id))
          if(nrow(list) != 0){
            list <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", list$Key)
            vars$galeria_fotos_cont <- list
          }
          
          div(
            if(inmo$borrador == "si"){
              fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; min-height: 190px; margin: 0px;
                                                    margin-top: 10px",
                        leafletOutput("map_new_inmo")
              )
            },
            fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; min-height: 100px; margin: 0px;
                                                    margin-top: 10px",
                      if(inmo$tipo_contrato == "Sin contrato"){
                        h4("Sin contrato")
                      }else{
                        div(
                          h4(paste0("Tipo de contrato: ", inmo$tipo_contrato)),
                          h4(paste0("Inicio de contrato: ", inmo$ini_contrato)),
                          h4(paste0("Fin de contrato: ", inmo$fin_contrato)),
                          h4(paste0("Comisión: ", inmo$comision, "%")),
                          div(uiOutput("box_contrato_list_ui"), align = "center"),
                          if(inmo$borrador == "si"){
                            div(
                              br(),
                              textAreaInput("new_descripcion_inmo", "Descripción", value = inmo$descripcion,
                                            width = "100%", height = "250px"),
                              br(),
                              textAreaInput("new_comment_inmo", "Observaciones", value = inmo$comment,
                                            width = "100%", height = "100px"),
                              br(),
                              br(),
                              tags$div(id="bttn_modal", 
                                       actionBttn("publicar_inmo_ok", "Publicar"),
                                       align = "center")
                            )
                          }
                        )
                      }
            )
          )
        },
        
        if(inmo_input_on() == 1 & inmo$externa == "no" & inmo$precio_cierre == 0 & inmo$user == vars$user$user){
          
          vars$galeria_fotos_cont <- c()
          list <- list_spaces_do(prefix = paste0(co, "/fotos-contratos/", inmo$id))
          if(nrow(list) != 0){
            list <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", list$Key)
            vars$galeria_fotos_cont <- list
          }
          fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; min-height: 100px; margin: 0px;
                                                    margin-top: 10px",
                    if(inmo$tipo_contrato == "Sin contrato"){
                      h4("Sin contrato")
                    }else{
                      div(
                        h4(paste0("Tipo de contrato: ", inmo$tipo_contrato)),
                        h4(paste0("Inicio de contrato: ", inmo$ini_contrato)),
                        h4(paste0("Fin de contrato: ", inmo$fin_contrato)),
                        h4(paste0("Comisión: ", inmo$comision, "%")),
                        div(uiOutput("box_contrato_list_ui"), align = "center")
                      )
                    }
          )
        },
        
        div(style = "position: absolute; margin-top: 17px; margin-left: -50px; width: 100%", align = "right",
            HTML(paste0("<span style='font-size: 140%; font-weight: bold; color: #444444;'>",
                        "<i class='fa fa-phone'></i> ", contactos, 
                        "&nbsp;&nbsp;&nbsp;<i class='fa fa-eye'></i> ", vistas, "</span>"))
        ),
        if(myplace_on() == 0){
          if(inmo$activo == "si"){
            if(inmo$precio_cierre == 0){
              if(inmo$user == vars$user$user){
                div(
                  if(inmo$borrador == "si" | vars$user$cargo %in% c("Global Master Office", "Broker Office", "Broker Manager", "Country Office Manager")){
                    div(id = "icon_info", style = "position: absolute; margin-top: 17px; margin-left: 25px",
                        actionButton(inputId = "modal", label = NULL, icon = icon("edit"), 
                                     onclick = 'Shiny.setInputValue(\"inmo_edit_full\", this.id, {priority: \"event\"})',
                                     style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px"),
                        div(class = "icon_label", h5("editar"))
                    )
                  },
                  if(inmo$borrador == "si" | vars$user$cargo %in% c("Global Master Office", "Global Office Manager", "Global Office Assistant", "Broker Office", "Broker Manager", "Country Office Manager")){
                    div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 60px",
                        actionButton(inputId = "modal", label = NULL, icon = icon("times"), 
                                     onclick = 'Shiny.setInputValue(\"inmo_baja\", this.id, {priority: \"event\"})',
                                     style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px"),
                        div(class = "icon_label", h5("dar de baja"))
                    )
                  },
                  div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 95px",
                      downloadButton(outputId = "download_foto_inmo", label = NULL, icon = icon("images"), 
                                     style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                                      padding: 0px"),
                      div(class = "icon_label", h5("descargar fotos"))
                  ),
                  div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 130px",
                      actionButton("inmo_history", NULL, icon = icon("history"), 
                                   style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                                      padding: 0px"),
                      div(class = "icon_label", h5("historial"))
                  ),
                  if(inmo$publicado == "si"){
                    div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 165px",
                        actionButton("inmo_reporte_download", NULL, icon = icon("download"), 
                                     style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                                      padding: 0px"),
                        div(class = "icon_label", h5("descargar"))
                    )
                  },
                  if(inmo_input_on() == 1){
                    div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 200px",
                        actionButton("duplicar_inmo", NULL, icon = icon("clone"), 
                                     style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                                      padding: 0px"),
                        div(class = "icon_label", h5("duplicar"))
                    )
                  }
                )
              }else{
                div(
                  if(follow == 0){
                    div(id = "icon_info", style = "position: absolute; margin-top: 17px; margin-left: 30px",
                        actionButton(inputId = "modal", label = NULL, icon = icon("link"), 
                                     onclick = 'Shiny.setInputValue(\"seguir_inmo\", this.id, {priority: \"event\"})',
                                     style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px"),
                        div(class = "icon_label", h5("seguimiento"))
                    )
                  }else{
                    div(id = "icon_info", style = "position: absolute; margin-top: 17px; margin-left: 30px",
                        actionButton(inputId = "modal", label = NULL, icon = icon("unlink"), 
                                     onclick = 'Shiny.setInputValue(\"dejar_seguir_inmo\", this.id, {priority: \"event\"})',
                                     style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px"),
                        div(class = "icon_label", h5("dejar de seguir"))
                    )
                  },
                  div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 65px",
                      downloadButton(outputId = "download_foto_inmo", label = NULL, icon = icon("images"), 
                                     style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                                      padding: 0px"),
                      div(class = "icon_label", h5("descargar fotos"))
                  ),
                  if(inmo$publicado == "si"){
                    div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 100px",
                        actionButton("inmo_reporte_download", NULL, icon = icon("download"), 
                                     style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                                      padding: 0px"),
                        div(class = "icon_label", h5("descargar"))
                    )
                  },
                  if(permiso("editar propiedades", inmo$user, vars$permisos_acc, vars$permisos_men) | vars$user$cargo %in% c("Global Master Office", "Global Office Manager", "Global Office Assistant", "Broker Office", "Broker Manager", "Country Office Manager")){
                    if(prop_todas_on() == 0){
                      div(
                        div(id = "icon_info", style = "position: absolute; margin-top: 17px; margin-left: 135px",
                            actionButton(inputId = "modal", label = NULL, icon = icon("edit"), 
                                         onclick = 'Shiny.setInputValue(\"inmo_edit_full\", this.id, {priority: \"event\"})',
                                         style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px"),
                            div(class = "icon_label", h5("editar"))
                        ),
                        div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 170px",
                            actionButton(inputId = "modal", label = NULL, icon = icon("times"), 
                                         onclick = 'Shiny.setInputValue(\"inmo_baja\", this.id, {priority: \"event\"})',
                                         style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px"),
                            div(class = "icon_label", h5("dar de baja"))
                        )
                      )
                    }
                  }
                )
              }
            }else{
              div(
                if(inmo$user == vars$user$user & inmo_input_on() == 1){
                  div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 30px",
                      actionButton("duplicar_inmo", NULL, icon = icon("clone"), 
                                   style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                                      padding: 0px"),
                      div(class = "icon_label", h5("duplicar"))
                  )
                },
                if(vars$user$cargo %in% c("Global Master Office", "Global Office Manager", "Global Office Assistant")){
                  div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 65px",
                      actionButton(inputId = "modal", label = NULL, icon = icon("times"), 
                                   onclick = 'Shiny.setInputValue(\"inmo_baja\", this.id, {priority: \"event\"})',
                                   style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px"),
                      div(class = "icon_label", h5("dar de baja"))
                  )
                }
              )
            }
          }else{
            if(vars$user$user == inmo$user | vars$user$cargo %in% c("Global Master Office", "Global Office Manager", "Global Office Assistant")){
              div(
                div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 30px",
                    actionButton("activar_inmo", NULL, icon = icon("check"), 
                                 style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                                      padding: 0px"),
                    div(class = "icon_label", h5("activar"))
                ),
                div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 65px",
                    actionButton(inputId = "modal", label = NULL, icon = icon("trash-alt"), 
                                 onclick = 'Shiny.setInputValue(\"inmo_delete\", this.id, {priority: \"event\"})',
                                 style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px"),
                    div(class = "icon_label", h5("eliminar"))
                )
              )
            }
          }
        }
      )
    }else{
      div()
    }
  })
  
  observeEvent(input$close_show_inmo, {
    show_inmo_on(0)
    vars$show_estado <- data.frame()
    vars$show_inmo <- data.frame()
    removeModal()
  })
  
  
  observeEvent(input$publicar_inmo_ok, {
    inmo <- vars$show_inmo
    error <- tryCatch({
      estado_existente <- list_table_var1_var2_mysql(paste0(co, "_estados"), "id_inmo", inmo$id, "tipo_cliente", "captacion")
      
      if(nrow(estado_existente) == 0){
        agente <- list_table_var_mysql("myplace_usuarios", "user", inmo$user)
        cliente <- list_table_var_mysql(paste0(co, "_clientes"), "id", inmo$cliente)
        name_estado <- paste0(cliente$name, ifelse(inmo$venta_alquiler == "Venta", " vende", " alquila"),
                              ifelse(inmo$tipoPropiedad %in% c("Casa", "Oficina", "Propiedad rural", "Casa quinta"), " una ", " un "), str_to_lower(inmo$tipoPropiedad),
                              " en ", inmo$ciudad)
        id_captacion <- new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12)
        new_estado <- data.frame(
          id = id_captacion,
          fecha = as.character(now("America/Asuncion")),
          user = inmo$user,
          name = name_estado,
          id_inmo = inmo$id,
          id_clien = cliente$id,
          nivel_cliente = NA,
          estado_cliente = NA,
          accion = NA,
          fecha_prox_contacto = as.character(as_date(now("America/Asuncion"))),
          tipo_cliente = "captacion",
          presupuesto = NA,
          urgente = "no",
          importante = "no",
          fase = ifelse(inmo$tipo_contrato == "Sin contrato", "1", "2"),
          comment = NA
        )
        save_mysql(new_estado, paste0(co, "_estados"), FALSE)
        print("Nuevo estado creado")
        
        new_llamada <- data.frame(
          id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
          fecha = as.character(now("America/Asuncion")),
          fecha_agendada = NA,
          user = inmo$user,
          id_inmo = inmo$id,
          id_clien = cliente$id,
          id_estado = id_captacion,
          accion = "Nueva captación",
          realizado = NA,
          agendado = "no",
          time = NA,
          visto = "no",
          comment = ifelse(inmo$tipo_contrato == "Sin contrato", "Nueva propiedad en proceso de captacion", "Nueva propiedad captada")
        )
        save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
        
      }
      
      agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", inmo$user)
      
      new_alarma <- data.frame(
        id = new_id_table_mysql("id", paste0(co, "_alarmas"), "alarma_", 12),
        fecha = as.character(as_date(now("America/Asuncion"))),
        time = as.character(now("America/Asuncion")),
        user = inmo$user,
        destino = "all",
        id_inmo = inmo$id,
        id_clien = NA,
        id_estado = NA,
        id_busq = NA,
        id_noticia = NA,
        id_calificacion = NA,
        tipo = "Nueva propiedad",
        visto = "no",
        img = inmo$img,
        comment = paste0("El asesor ", agente$name, " ha subido ", ifelse(inmo$venta_alquiler == "Venta", "una ", "un "), 
                         str_to_lower(inmo$venta_alquiler), " de ",  str_to_lower(inmo$tipoPropiedad))
      )
      save_mysql(new_alarma, paste0(co, "_alarmas"), FALSE)
      
      new_alarma$id <- new_id_table_mysql("id", "place_alarmas", "alarma_", 12)
      save_mysql(new_alarma, "place_alarmas", FALSE)
      
      update_var_table_mysql("no", "borrador", "id", inmo$id, "myplace_inmuebles")
      update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", inmo$id, "myplace_inmuebles")
      update_var_table_mysql("si", "publicado", "id", inmo$id, "myplace_inmuebles")
      update_var_table_mysql(input$new_descripcion_inmo, "descripcion", "id", inmo$id, "myplace_inmuebles")
      update_var_table_mysql(input$new_comment_inmo, "comment", "id", inmo$id, "myplace_inmuebles")
      update_var_table_mysql(as.character(now("America/Asuncion")), "fecha_aprobacion", "id", inmo$id, "myplace_inmuebles")
      
      vars$office_prop_list$borrador[vars$office_prop_list$id == inmo$id] <- "no"
      vars$office_prop_list$publicado[vars$office_prop_list$id == inmo$id] <- "si"
      vars$office_prop_list$descripcion[vars$office_prop_list$id == inmo$id] <- input$new_descripcion_inmo
      vars$office_prop_list$fecha_aprobacion[vars$office_prop_list$id == inmo$id] <- as.character(now("America/Asuncion"))
      
      coincidencias(inmo, dir, session)
      
      "listo"},
      error = function(e){NA}
    )
    
    show_inmo_on(0)
    vars$show_estado <- data.frame()
    vars$show_inmo <- data.frame()
    removeModal()
    
  })
  
  
  #  obs_open_contrato <- list()
  
  observe({
    if(office_prop_on() == 1 | inmo_input_on() == 1){
      if(length(vars$galeria_fotos_cont) > 0){
        output$box_contrato_list_ui <- renderUI({
          boxes_contratos <- as.list(1:length(vars$galeria_fotos_cont))
          boxes_contratos <- lapply(boxes_contratos, function(i){
            #            btOpenContrato <- paste0("open_contrato_button", i)
            contrato <- vars$galeria_fotos_cont[i]
            
            #            obs_open_contrato[[btOpenContrato]] <<- observeEvent(input[[btOpenContrato]], ignoreNULL = TRUE, ignoreInit = TRUE, {
            #              freezeReactiveValue(input, btOpenContrato)
            #              contrato <- vars$galeria_fotos_cont[i]
            
            
            #            })
            
            div(style = "padding: 10px; display:inline-block", align = "left",
                a(href = contrato, target = "_blank",
                  actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:180px; height: 255px; margin: 0px;
                                                             background-image: url("', contrato, '");
                                                             background-size: cover, 180px 255px;
                                                             border-radius: 8px')))
            )
          })
        })
      }else{
        output$box_contrato_list_ui <- renderUI({
          div()
        })
      }
    }else{
      output$box_contrato_list_ui <- renderUI({
        div()
      })
    }
  })
  
  
  
  
  observeEvent(input$activar_inmo, {
    update_var_table_mysql("si", "activo", "id", vars$show_inmo$id, "myplace_inmuebles")
    update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", vars$show_inmo$id, "myplace_inmuebles")
    update_var_table_mysql("si", "activo", "id", vars$show_inmo$id, "myplace_tipologias")
    update_var_table_mysql("si", "borrador", "id", vars$show_inmo$id, "myplace_inmuebles")
    
    cliente <- list_table_var_mysql(paste0(co, "_clientes"), "id", vars$show_inmo$cliente)
    
    name_estado <- paste0(cliente$name, ifelse(vars$show_inmo$venta_alquiler == "Venta", " vende", " alquila"),
                          ifelse(vars$show_inmo$tipoPropiedad %in% c("Casa", "Oficina", "Propiedad rural", "Casa quinta"), " una ", " un "), 
                          str_to_lower(vars$show_inmo$tipoPropiedad),
                          " en ", vars$show_inmo$ciudad)
    new_estado <- data.frame(
      id = new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12),
      fecha = as.character(now("America/Asuncion")),
      user = vars$show_inmo$user,
      name = name_estado,
      id_inmo = vars$show_inmo$id,
      id_clien = cliente$id,
      nivel_cliente = NA,
      estado_cliente = NA,
      accion = NA,
      fecha_prox_contacto = as.character(as_date(now("America/Asuncion"))),
      tipo_cliente = "captacion",
      presupuesto = NA,
      urgente = "no",
      importante = "no",
      fase = "1",
      comment = NA
    )
    save_mysql(new_estado, paste0(co, "_estados"), FALSE)
    
    vars$inmo_propio_list <- list_table_var1_var2_mysql("myplace_inmuebles", "user", vars$user$user, "company", co)
    refresh_inmo_input(isolate(refresh_inmo_input()) + 1)
    removeModal()
  })
  
  observeEvent(input$contacto_face, {
    new_contacto <- data.frame(
      id = new_id_table_mysql("id", "contactos_myplace", "contacto_", 14),
      company = co,
      fecha = as.character(now("America/Asuncion")),
      user = vars$user$user,
      id_inmo = vars$show_inmo$id,
      tipo = "Facebook",
      fuente = ifelse(myplace_on() == 1, "MyPlace", "CRM")
    )
    save_mysql(new_contacto, "contactos_myplace", FALSE)
  })
  
  observeEvent(input$contacto_insta, {
    new_contacto <- data.frame(
      id = new_id_table_mysql("id", "contactos_myplace", "contacto_", 14),
      company = co,
      fecha = as.character(now("America/Asuncion")),
      user = vars$user$user,
      id_inmo = vars$show_inmo$id,
      tipo = "Instagram",
      fuente = ifelse(myplace_on() == 1, "MyPlace", "CRM")
    )
    save_mysql(new_contacto, "contactos_myplace", FALSE)
  })
  
  observeEvent(input$contacto_mail, {
    new_contacto <- data.frame(
      id = new_id_table_mysql("id", "contactos_myplace", "contacto_", 14),
      company = co,
      fecha = as.character(now("America/Asuncion")),
      user = vars$user$user,
      id_inmo = vars$show_inmo$id,
      tipo = "Mail",
      fuente = ifelse(myplace_on() == 1, "MyPlace", "CRM")
    )
    save_mysql(new_contacto, "contactos_myplace", FALSE)
  })
  
  observeEvent(input$contacto_wha, {
    new_contacto <- data.frame(
      id = new_id_table_mysql("id", "contactos_myplace", "contacto_", 14),
      company = co,
      fecha = as.character(now("America/Asuncion")),
      user = vars$user$user,
      id_inmo = vars$show_inmo$id,
      tipo = "Whatsapp",
      fuente = ifelse(myplace_on() == 1, "MyPlace", "CRM")
    )
    save_mysql(new_contacto, "contactos_myplace", FALSE)
  })
  
  observeEvent(input$duplicar_inmo, {
    showModal(modalDialog(
      h3("¿Estas seguro que deseas duplicar la propiedad?"),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("duplicar_inmo_ok", "Duplicar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Duplicar Propiedad",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$duplicar_inmo_ok, {
    new <- vars$show_inmo
    cliente <- list_table_var_mysql(paste0(co, "_clientes"), "id", new$cliente)
    id <- new_id_myplace_mysql("myplace_inmuebles", co, "inmueble", 10)
    rand <- str_pad(round(runif(1, min=1, max=999)), 3, pad = "0")
    
    galeria <- num_fotos_inmo(new$img, FALSE)
    img = ifelse(length(galeria) == 0, NA, 
                 paste0("https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/", id, "-01", "_", rand, "-small.jpg"))
    
    new$id <- id
    new$fecha <- as.character(now("America/Asuncion"))
    new$fecha_creacion <- as.character(now("America/Asuncion"))
    new$img <- img
    new$precio_cierre <- 0
    new$fecha_cierre <- NA
    new$tipo_contrato <- "Sin contrato"
    new$borrador <- "si"
    save_mysql(new, "myplace_inmuebles", FALSE)
    
    for(i in 1:length(galeria)){
      foto_error <- tryCatch({
        name <- paste0(id, "-", str_pad(i, 2, pad = "0"), "_", rand)
        im <- image_read(galeria[i])
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        put_object_do(paste0("/fotos-inmo/", name, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        im <- image_scale(im, "300x")
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        put_object_do(paste0("/fotos-inmo/", name, "-small.jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
        "listo"},
        error = function(e){NA}
      )
    }
    
    name_estado <- paste0("Propiedad duplicada del cliente ", cliente$name, ": ", str_to_lower(new$tipoPropiedad),
                          " en ", new$ciudad)
    new_estado <- data.frame(
      id = new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12),
      fecha = as.character(now("America/Asuncion")),
      user = new$user,
      name = name_estado,
      id_inmo = new$id,
      id_clien = cliente$id,
      nivel_cliente = NA,
      estado_cliente = NA,
      accion = NA,
      fecha_prox_contacto = as.character(as_date(now("America/Asuncion"))),
      tipo_cliente = "captacion",
      presupuesto = NA,
      urgente = "no",
      importante = "no",
      fase = "1",
      comment = NA
    )
    save_mysql(new_estado, paste0(co, "_estados"), FALSE)
    print("Nuevo estado creado")
    
    vars$inmo_propio_list <- list_table_var1_var2_mysql("myplace_inmuebles", "user", vars$user$user, "company", co)
    refresh_inmo_input(isolate(refresh_inmo_input()) + 1)
    
    removeModal()
  })
  
  observeEvent(input$inmo_reporte_download, {
    showModal(modalDialog(
      selectInput("sel_tipo_reporte_download", NULL, choices = c("Con información del Asesor", "Sin información del Asesor")),
      br(), 
      tags$div(id="bttn_modal", 
               actionBttn("inmo_reporte_download_ok", "Descargar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Descargar detalles de la propiedad",
      easyClose = FALSE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$inmo_reporte_download_ok, {
    
    inmo <- vars$show_inmo
    if(input$sel_tipo_reporte_download == "Con información del Asesor"){
      file_name <- paste0(co, "/inmo-web/", inmo$id, ".html")
      info <- TRUE
    }else{
      file_name <- paste0(co, "/inmo-web/", inmo$id, "-blank.html")
      info <-FALSE
    }
    file <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", file_name)
    link <- list_spaces_do(prefix = file_name)
    print("En digitalocean")
    print(link)
    
    vars$file_clip <- file
    
    if(inmo$tipoPropiedad == "Proyecto"){
      tipologias <- list_table_var_mysql("myplace_tipologias", "id", inmo$id)
    }else{
      tipologias <- NA
    }
    
    params <- list(inmo = inmo, agente = vars$user, tipologias = tipologias, info = info)
    #save(params, file = "params.rda")
    
    tempReport <- file.path(dir, paste0(session$token, "report_inmo_html.Rmd"))
    tempHTML <- file.path(dir, paste0(session$token, "temp_inmo_web.html"))
    file.copy("report_inmo_html.Rmd", tempReport, overwrite = TRUE)
    
    rmarkdown::render(tempReport, 
                      output_file = tempHTML,
                      params = params,
                      envir = new.env(parent = globalenv()))
    
    put_object_do(paste0("/", file_name), tempHTML)
    
    if(input$sel_tipo_reporte_download == "Con información del Asesor"){
      update_var_table_mysql(file, "link", "id", inmo$id, "myplace_inmuebles")
    }
    
    error <- tryCatch({
      tempQR <- file.path(dir, paste0(session$token, "qrplot.png"))
      png(tempQR)
      qrv <- qr_code(file)
      plot(qrv)
      dev.off()
      qr <- dataURI(file = tempQR)
    },
    error = function(e){NA}
    )
    
    if(is.na(error)){
      print("error al crear QR inmueble")
      dev.off()
      qr <- NA
    }
    
    showModal(modalDialog(
      fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; min-height: 125px;
                                       margin: 0px;",
                if(!is.na(qr)){
                  div(align = "center",
                      tags$img(src= qr, width = "250px")
                  )
                },
                a(href = file, target="_blank", file),
                uiOutput("rclip_ui"),
                br(),
                br(),
                div(
                  HTML(paste0('<div class="fb-share-button" 
                  data-href="', file, '" data-layout="button" data-size="large">
                  <a target="_blank" href="https://www.facebook.com/sharer/sharer.php?
                  u=https%3A%2F%2Fplace-storage.nyc3.digitaloceanspaces.com%2Fskyone%2Finmo-web%2F', inmo$id, '.html
                  &amp;src=sdkpreparse" class="fb-xfbml-parse-ignore"><span style="background-color: #3B5998;
                  color: white; border-radius: 20px; width: 130px; height: 40px; font-size: 120%; padding: 5px;">
                  <i class="fa fa-facebook"></i> Compartir</span></a>
                  </div>')),
                  align = "center"),
                br()
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("close_modal", "OK"),
               align = "center"),
      title = "Link de la propiedad",
      easyClose = TRUE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  output$rclip_ui <- renderUI({
    rclipButton(
      inputId = "clipbtn",
      label = "Copiar link",
      clipText = vars$file_clip, 
      icon = icon("clipboard"),
      modal = TRUE
    )
  })
  
  observeEvent(input$inmo_edit_full, {
    removeModal()
    print("menu selected")
    print(input$menu)
    vars$menu_selected <- input$menu
    updateTabItems(session, "menu", "prop_crear")
    show_inmo_on(0)
    edit_inmo_on(1)
  })
  
  output$download_foto_inmo <- downloadHandler(
    filename <- function(){
      paste0(vars$show_inmo$id, ".zip")
    },
    content = function(file) {
      fotos <- num_fotos_inmo(vars$show_inmo$img, FALSE)
      names <- c()
      for(i in 1:length(fotos)){
        name <- paste0("www/temp/", str_remove(fotos[i], "https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/"))
        names <- c(names, name)
        print(name)
        im <- image_read(fotos[i])
        image_write(im, name)
      }
      zip::zip(file, names, mode = "cherry-pick")
    },
    contentType = "application/zip"
  )
  
  output$new_inmo_ui <- renderUI({
    if(new_inmo_on() == 1 | edit_inmo_on() == 1){
      #      list <- list_spaces_do(prefix = paste0(co, "/temp/", vars$user$user))
      #      if(nrow(list) != 0){
      #        list <- list$Key
      #        for(i in 1:length(list)){
      #          delete_object_do(paste0("/", list[i]))
      #        }
      #      }
      
      e <- ifelse(edit_inmo_on() == 1, TRUE, FALSE)
      
      #delete_object(paste0("/", co, "/temp/", vars$user$user))
      isolate({
        
        vars$cliente_vinc <- NULL
        vars$galeria_inmo_order <- c()
        vars$galeria_fotos_inmo <- c()
        vars$galeria_cont_order <- c()
        vars$galeria_fotos_cont <- c()
        vars$galeria_fotos_cont_back <- c()
        vars$ind_galeria_fotos_cont <- 0
        
        if(edit_inmo_on() == 1){ #edittipo
          edit <- vars$show_inmo
          clientes <- list_table_var_mysql(paste0(co, "_clientes"), "user", edit$user)
          vars$cliente_vinc <- list_table_var_mysql(paste0(co, "_clientes"), "id", vars$show_inmo$cliente)
          print("cliente vinculado")
          print(vars$cliente_vinc$name)
          updateSelectInput(session, "inmo_tipoPropiedad", selected = edit$tipoPropiedad)
          galeria <- num_fotos_inmo(edit$img, FALSE)
          
          print("galeria")
          print(galeria)
          
          if(length(galeria) != 0){
            vars$galeria_fotos_inmo <- galeria
            rand <- str_pad(round(runif(1, min=1, max=9999999999)), 10, pad = "0")
            for(i in 1: length(vars$galeria_fotos_inmo)){
              serie <- paste0("", str_pad(i, 2, pad = "0"))
              im <- image_read(vars$galeria_fotos_inmo[i])
              file <- file.path(dir, paste0(session$token, "temp_foto_inmo", serie, ".jpg"))
              image_write(im, file)
              vars$galeria_fotos_inmo[i] <- file
            }
          }
          
          if(edit$tipo_contrato != "Sin contrato"){
            list <- list_spaces_do(prefix = paste0(co, "/fotos-contratos/", edit$id))
            if(nrow(list) != 0){
              list <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", list$Key)
              print("list con contrato")
              list <- list[str_detect(list, co)]
              vars$galeria_fotos_cont <- list
              vars$galeria_fotos_cont_back <- list
              print(vars$galeria_fotos_cont)
              rand <- str_pad(round(runif(1, min=1, max=9999999999)), 10, pad = "0")
              for(i in 1: length(vars$galeria_fotos_cont)){
                serie <- paste0("", str_pad(i, 2, pad = "0"))
                im <- image_read(vars$galeria_fotos_cont[i])
                file <- file.path(dir, paste0(session$token, "temp_foto_cont", serie, ".jpg"))
                image_write(im, file)
                vars$galeria_fotos_cont[i] <- file
              }
            }
            vars$ind_galeria_fotos_cont <- length(vars$galeria_fotos_cont)
          }
          
#          if(is.na(edit$referente)){
#            updateSelectInput(session, "inmo_referente_sel", selected = "Ninguno")
#          }else{
#            if(str_detect(edit$referente, "@")){
#              updateSelectInput(session, "inmo_referente_sel", selected = "Asesor SkyOne")
#            }else{
#              updateSelectInput(session, "inmo_referente_sel", selected = "Asesor Externo")
#            }
#          }
          
          place <- data.frame(lat = edit$lat, lon = edit$lon)
          point <- place %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
          vars$view <- point
          vars$place <- place
          updateSelectInput(session, "inmo_externa", selected = ifelse(edit$externa == "si", "Propiedad externa", "Propiedad SkyOne"))
          updateSelectInput(session, "inmo_tipoPropiedad", selected = edit$tipoPropiedad)
          updateTextInput(session, "inmo_pais", value = edit$pais)
          updateTextInput(session, "inmo_departamento", value = edit$departamento)
          updateTextInput(session, "inmo_ciudad", value = edit$ciudad)
          updateTextInput(session, "inmo_distrito", value = edit$distrito)
          updateTextInput(session, "inmo_calle", value = edit$calle)
          updateTextInput(session, "inmo_nro_casa", value = edit$nro_casa)
          updateTextInput(session, "inmo_catastro", value = edit$catastro)
          updateTextAreaInput(session, "inmo_comment", value = edit$comment)
          updateTextAreaInput(session, "inmo_referencia", value = edit$referencia)
          updateTextAreaInput(session, "inmo_titulo", value = edit$titulo)
          updateTextAreaInput(session, "inmo_descripcion", value = edit$descripcion)
          updateTextInput(session, "inmo_video", value = ifelse(is.na(edit$video), "", edit$video))
          updateNumericInput(session, "inmo_comision", value = as.numeric(edit$comision))
          updateAutonumericInput(session, "inmo_precio", value = edit$precio)
          updateRadioButtons(session, "inmo_moneda_contrato", selected = edit$moneda_contrato)
          updateDateInput(session, "inmo_ini_contrato", value = ifelse(edit$ini_contrato == "", "", as_date(edit$ini_contrato)))
          updateDateInput(session, "inmo_fin_contrato", value = ifelse(edit$fin_contrato == "", "", as_date(edit$fin_contrato)))
          updateSelectInput(session, "inmo_borrador", selected = ifelse(edit$borrador == "si", "Borrador", "Publicado"))
          updateSelectInput(session, "inmo_publicado", selected = edit$publicado)
          print("edit$publicado")
          print(edit$publicado)
          updateSelectInput(session, "inmo_venta_alquiler", selected = edit$venta_alquiler)
          updateSelectInput(session, "inmo_tipo_contrato", selected = edit$tipo_contrato)
          updateSelectInput(session, "inmo_estado_juridico", selected = edit$estado_juridico)
          if(edit$m2 != 0) updateNumericInput(session, "inmo_m2", value = ifelse(edit$tipoPropiedad == "Propiedad rural", edit$m2/10000, edit$m2))
          if(edit$m2_cons != 0) updateNumericInput(session, "inmo_m2_cons", value = edit$m2_cons)
          updateNumericInput(session, "inmo_anio", value = ifelse(edit$anio == 0, 0, year(now("America/Asuncion")) - edit$anio))
          if(edit$frente != 0) updateNumericInput(session, "inmo_frente", value = edit$frente)
          if(edit$fondo != 0) updateNumericInput(session, "inmo_fondo", value = edit$fondo)
          if(edit$pisos != 0) updateNumericInput(session, "inmo_pisos", value = edit$pisos)
          if(!is.na(edit$dormitorios)) updateSelectInput(session, "inmo_dormitorios", selected = edit$dormitorios)
          if(!is.na(edit$banios)) updateSelectInput(session, "inmo_banios", selected = edit$banios)
          if(!is.na(edit$garajes)) updateSelectInput(session, "inmo_garajes", selected = edit$garajes)
          if(!is.na(edit$oficinas)) updateSelectInput(session, "inmo_oficinas", selected = edit$oficinas)
          if(!is.na(edit$ascensor)) updateSelectInput(session, "inmo_ascensor", selected = edit$ascensor)
          if(!is.na(edit$bauleras)) updateSelectInput(session, "inmo_bauleras", selected = edit$bauleras)
          if(!is.na(edit$banios_compartidos)) updateSelectInput(session, "inmo_banios_compartidos", selected = edit$banios_compartidos)
          if(!is.na(edit$tipo_cocina)) updateSelectInput(session, "inmo_tipo_cocina", selected = edit$tipo_cocina)
          if(!is.na(edit$estado)) updateSelectInput(session, "inmo_estado", selected = edit$estado)
          if(!is.na(edit$esquina)) updateMaterialSwitch(session, "inmo_esquina", value = ifelse(edit$esquina == "si", TRUE, FALSE)) 
          if(!is.na(edit$condominio)) updateMaterialSwitch(session, "inmo_condominio", value = ifelse(edit$condominio == "si", TRUE, FALSE)) 
          if(!is.na(edit$generador)) updateMaterialSwitch(session, "inmo_generador", value = ifelse(edit$generador == "si", TRUE, FALSE)) 
          if(!is.na(edit$trifacico)) updateMaterialSwitch(session, "inmo_trifacico", value = ifelse(edit$trifacico == "si", TRUE, FALSE)) 
          if(!is.na(edit$piscina)) updateMaterialSwitch(session, "inmo_piscina", value = ifelse(edit$piscina == "si", TRUE, FALSE)) 
          if(!is.na(edit$gimnasio)) updateMaterialSwitch(session, "inmo_gimnasio", value = ifelse(edit$gimnasio == "si", TRUE, FALSE)) 
          if(!is.na(edit$area_servicio)) updateMaterialSwitch(session, "inmo_area_servicio", value = ifelse(edit$area_servicio == "si", TRUE, FALSE)) 
          if(!is.na(edit$deposito)) updateMaterialSwitch(session, "inmo_deposito", value = ifelse(edit$deposito == "si", TRUE, FALSE)) 
          if(!is.na(edit$cocina_equipada)) updateMaterialSwitch(session, "inmo_cocina_equipada", value = ifelse(edit$cocina_equipada == "si", TRUE, FALSE)) 
          if(!is.na(edit$quincho)) updateMaterialSwitch(session, "inmo_quincho", value = ifelse(edit$quincho == "si", TRUE, FALSE)) 
          if(!is.na(edit$balcon)) updateMaterialSwitch(session, "inmo_balcon", value = ifelse(edit$balcon == "si", TRUE, FALSE)) 
          if(!is.na(edit$parrilla)) updateMaterialSwitch(session, "inmo_parrilla", value = ifelse(edit$parrilla == "si", TRUE, FALSE)) 
          if(!is.na(edit$pet_friendly)) updateMaterialSwitch(session, "inmo_pet_friendly", value = ifelse(edit$pet_friendly == "si", TRUE, FALSE)) 
          if(!is.na(edit$cocina_propia)) updateMaterialSwitch(session, "inmo_cocina_propia", value = ifelse(edit$cocina_propia == "si", TRUE, FALSE))
          
          if(edit$tipoPropiedad == "Proyecto"){
            vars$tipologia_list_all <- list_table_var_mysql("myplace_tipologias", "id", edit$id) %>% arrange(fecha)
            if(nrow(vars$tipologia_list_all) != 0){
              rand <- str_pad(round(runif(1, min=1, max=9999999999)), 10, pad = "0")
              for(j in 1:nrow(vars$tipologia_list_all)){
                im_error <- tryCatch({
                  im <- image_read(vars$tipologia_list_all$img[j])
                  "listo"},
                  error = function(e){NA}
                )
                if(is.na(im_error)){
                  print("error leyendo foto tipologia")
                  im <- image_read("blank_inmo.jpg")
                  #image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
                  #put_object_do(str_remove(vars$tipologia_list_all$img[j], "https://place-storage.nyc3.digitaloceanspaces.com"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
                }
                image_write(im, file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
                put_object_do(paste0("/", co, "/temp/tipologias/", vars$user$user, j, "_", rand, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
                vars$tipologia_list_all$img[j] <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/temp/tipologias/", vars$user$user, j, "_", rand, ".jpg")
              }
            }else{
              vars$tipologia_list_all <- data.frame()
            }
          }else{
            vars$tipologia_list_all <- data.frame()
          }
          print("Fotos antes de editar")
          print(vars$galeria_fotos_inmo)
          print(vars$galeria_fotos_cont)
        }else{
          clientes <- list_table_var_mysql(paste0(co, "_clientes"), "user", vars$user$user)
        }
        print("ini contrato")
        print(isolate(input$inmo_ini_contrato))
      })
      div(
        fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                  h4(HTML(paste0("<p><span style='color: ", main_color, "'>Datos Generales</span></p>")), width = "100%"),
                  
                  tags$div(id = "inline", style = "padding-bottom: 10px",
                           uiOutput("new_inmo_ext_sel_ui"),
                           div(
                             div(class = "btn-group",
                                 actionButton("nada", "Vincular propietario", icon = icon("link"),
                                              onclick = 'Shiny.setInputValue(\"vincular_clien_inmo\", this.id, {priority: \"event\"})',)),
                             div(class = "btn-group", style = "padding-left: 20px", 
                                 uiOutput("cliente_name_ui_inmo")
                             ),
#                             div(class = "btn-group", style = "margin-left: 20px",
#                                 selectInput("inmo_referente_sel", "Referido", choices = c("Ninguno", "Asesor SkyOne", "Asesor Externo"))),
#                             div(class = "btn-group", uiOutput("inmo_referente_ui")),
                             div(class = "btn-group", style = "margin-left: 20px",
                                 textAreaInput("inmo_comment", "Observaciones"))
                           )
                  )
        ),  
        br(),
        fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                  h4(HTML(paste0("<p><span style='color: ", main_color, "'>Tipo de propiedad</span></p>")), width = "100%"),
                  if(edit_inmo_on() == 1){
                    selectInput("inmo_tipoPropiedad", NULL, 
                                choices = c("Terreno", "Casa", "Duplex", "Departamento", "Proyecto", "Deposito", "Tinglado", "Oficina", "Salón comercial",
                                            "Propiedad rural", "Casa quinta", "Edificio")) %>% disabled()
                  }else{
                    selectInput("inmo_tipoPropiedad", NULL, 
                                choices = c("Terreno", "Casa", "Duplex", "Departamento", "Proyecto", "Deposito", "Tinglado", "Oficina", "Salón comercial",
                                            "Propiedad rural", "Casa quinta", "Edificio"))
                  }
        ),
        br(),
        uiOutput("inmo_multimedios_ui"),
        br(),     
        fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                  h4(HTML(paste0("<p><span style='color: ", main_color, "'>Ubicación de la propiedad</span></p>")), width = "100%"),
                  fluidRow(style = "padding:0px",
                           column(6, 
                                  div(id = "inline", actionButton("ubi_lat_lon", "Ubicar coordenadas")),
                                  leafletOutput("map_new_inmo", height = 380)),
                           column(6, 
                                  tags$div(id = "inline", 
                                           fluidRow(
                                             column(6,
                                                    textInput("inmo_pais", "País") %>% disabled(),
                                                    textInput("inmo_departamento", "Departamento") %>% disabled(),
                                                    textInput("inmo_ciudad", "Ciudad") %>% disabled(),
                                                    textInput("inmo_distrito", "Distrito") %>% disabled(),
                                             ),
                                             column(6,
                                                    textInput("inmo_calle", "Calle") %>% disabled(),
                                                    textInput("inmo_nro_casa", "Nro de casa"),
                                                    textInput("inmo_catastro", "Cta catastral")
                                             )
                                           ),
                                           textAreaInput("inmo_referencia", "Referencias")
                                  )
                           )
                  )
        ),        
        br(), 
        fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                  h4(HTML(paste0("<p><span style='color: ", main_color, "'>Detalles de la operación</span></p>")), width = "100%"),
                  tags$div(id = "inline",
                           column(4,
                                  selectInput("inmo_venta_alquiler", "Operación", choices = c("Venta", "Alquiler", "Alquiler temporal")),
                                  uiOutput("contrato_sel_ui")
                           ),
                           column(4, 
                                  uiOutput("comision_ui")
                           ),
                           column(4, 
                                  radioButtons("inmo_moneda_contrato", "Moneda", inline = TRUE, choices = c("USD", "GS")),
                                  uiOutput("new_inmo_precio_ui")
                           )
                  )
        ), 
        br(),
        uiOutput("contrato_multimedios_ui"),
        uiOutput("tipo_prop_ui"),
        uiOutput("tipologias_ui"),
        uiOutput("encabezado_ui")
      )
    }
  })
  
  output$new_inmo_ext_sel_ui <- renderUI({
    selectInput("inmo_externa", NULL, choices = c("Propiedad SkyOne", "Propiedad externa"))
  })
  
  output$contrato_sel_ui <- renderUI({
    if(edit_inmo_on() == 1){
      externa <- vars$show_inmo$externa
    }else{
      if(is.null(input$inmo_externa)){
        externa <- "no"
      }else{
        externa <- ifelse(input$inmo_externa == "Propiedad SkyOne", "no", "si")
      }
    }
    if(externa == "no"){
      selectInput("inmo_tipo_contrato", "Contrato", 
                  choices = c("Sin contrato", "Exclusividad", "Autorizacion", "Acuerdo de proyecto", 
                              "Presentacion de cliente"))
    }
  })
  
  output$encabezado_ui <- renderUI({
    if(edit_inmo_on() == 1){
      externa <- vars$show_inmo$externa
    }else{
      if(is.null(input$inmo_externa)){
        externa <- "no"
      }else{
        externa <- ifelse(input$inmo_externa == "Propiedad SkyOne", "no", "si")
      }
    }
    div(
      br(),
      fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                h4(HTML(paste0("<p><span style='color: ", main_color, "'>Publicar la propiedad</span></p>")), width = "100%"),
                if(externa == "no"){
                  tags$div(id = "inline",
                           column(4, 
                                  div(
                                    selectInput("inmo_publicado", "Visible en el Portal", choices = c("si", "no")),
                                    textAreaInput("inmo_titulo", "Encabezado") 
                                  )
                           ),
                           column(8, 
                                  textAreaInput("inmo_descripcion", "Descripción", height = "150px"),
                           )
                  )
                },
                uiOutput("finish_inmo_btn_ui"),
                br()
      )
    )
  })
  
  observeEvent(input$finish_inmo_cancel, {
    if(is.na(vars$menu_selected)){
      updateTabItems(session, "menu", "prop_mios")
    }else{
      updateTabItems(session, "menu", vars$menu_selected)
      vars$menu_selected <- NA
    }
  })
  
  output$inmo_referente_ui <- renderUI({
    req(input$inmo_referente_sel)
    print("inmo_referente_sel")
    print(input$inmo_referente_sel)
    if(input$inmo_referente_sel == "Ninguno"){
      div()
    }else{
      if(input$inmo_referente_sel == "Asesor SkyOne"){
        agentes <- list_table_var_mysql("myplace_usuarios", "company", co)
        if(edit_inmo_on() == 1 && !is.na(vars$show_inmo$referente)){
          if(str_detect(vars$show_inmo$referente, "@")){
            agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$show_inmo$referente)
            agente <- agente$name
          }else{
            agente = NULL
          }
          selectInput("inmo_referente_asesor_sel", "Elegir Asesor", choices = agentes$name, selected = agente)
        }else{
          selectInput("inmo_referente_asesor_sel", "Elegir Asesor", choices = agentes$name)
        }
      }else{
        if(input$inmo_referente_sel == "Asesor Externo"){
          if(edit_inmo_on() == 1 & !is.na(vars$show_inmo$referente)){
            if(!str_detect(vars$show_inmo$referente, "@")){
              textInput("inmo_referente", "Nombre del Asesor Externo", value = vars$show_inmo$referente)
            }else{
              textInput("inmo_referente", "Nombre del Asesor Externo", value = NULL)
            }
          }else{
            textInput("inmo_referente", "Nombre del Asesor Externo", value = NULL)
          }
        }
      }
    }
  })
  
  output$new_inmo_precio_ui <- renderUI({
    req(sel_prop(), input$inmo_moneda_contrato)
    if(sel_prop() != "Proyecto"){
      autonumericInput(inputId = "inmo_precio", align = "left",
                       label = "Precio", 
                       value = ifelse(edit_inmo_on() == 1, vars$show_inmo$precio, 0), currencySymbol = ifelse(input$inmo_moneda_contrato == "USD", "$ ", "Gs "), currencySymbolPlacement = "p",
                       decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")
    }
  })
  
  output$finish_inmo_btn_ui <- renderUI({
    if(edit_inmo_on() == 1){
      externa <- vars$show_inmo$externa
    }else{
      externa <- ifelse(input$inmo_externa == "Propiedad SkyOne", "no", "si")
    }
    print("externa boton almacenar")
    print(externa)
    div(
      if(!is.null(vars$galeria_fotos_inmo) && length(vars$galeria_fotos_inmo) == 0){
        foto <- 0
        div(align = "center", h5("Agrega al menos una foto de la propiedad", style = "color: red"))
      }else{
        foto <- 1
        div()
      },
      if(!is.null(input$inmo_tipo_contrato) && input$inmo_tipo_contrato != "Sin contrato"){
        if(length(vars$galeria_fotos_cont) == 0){
          foto_cont <- 0
          div(align = "center", h5("Agrega foto del contrato", style = "color: red"))
        }else{
          foto_cont <- 1
          div()
        }
      }else{
        foto_cont <- 1
        div()
      },
      if(!is.null(input$inmo_tipo_contrato) && input$inmo_tipo_contrato != "Sin contrato"){
        if(length(input$inmo_ini_contrato) == 0 | length(input$inmo_fin_contrato) == 0){
          fecha_cont <- 0
          div(align = "center", h5("Debes agregar las fechas del contrato", style = "color: red"))
        }else{
          fecha_cont <- 1
          div()
        }
      }else{
        fecha_cont <- 1
        div()
      },
      if(input$inmo_pais == ""){
        mapa <- 0
        div(align = "center", h5("Ubica en el mapa el inmueble", style = "color: red"))
      }else{
        mapa <- 1
        div()
      },
      if(!is.null(input$inmo_descripcion) && str_length(input$inmo_descripcion) > 7000){
        len <- str_length(input$inmo_descripcion)
        desc <- 0
        div(align = "center", h5(paste0("Longitud: ", len, " - La descripción debe contener hasta 7000 caracteres"), style = "color: red"))
      }else{
        desc <- 1
        div()
      },
      if(sel_prop() == "Proyecto"){
        if(nrow(vars$tipologia_list_all) == 0){
          tipo <- 0
          div(align = "center", h5(paste0("Debes crear Tipologias al ", sel_prop()), style = "color: red"))
        }else{
          tipo <- 1
          div()
        }
      }else{
        tipo <- 1
        div()
      },
      if(is.null(vars$cliente_vinc)){
        cliente <- 0
        div(align = "center", h5(ifelse(externa == "no", "Debes vincular un cliente a la propiedad", "Debes vincular al asesor externo a la propiedad"), style = "color: red"))
      }else{
        cliente <- 1
        div()
      },
      if(!is.null(input$inmo_precio) && ((is.na(input$inmo_precio) | input$inmo_precio == 0) & input$inmo_tipoPropiedad != "Proyecto")){
        precio <- 0
        div(align = "center", h5("Precio sin completar", style = "color: red"))
      }else{
        precio <- 1
        div()
      },
      if(!is.null(input$inmo_m2) && ((is.na(input$inmo_m2) | input$inmo_m2 == 0) & input$inmo_tipoPropiedad %in% c("Terreno", "Casa", "Duplex", "Deposito", "Tinglado", "Edificio", "Casa quinta", "Propiedad rural"))){
        m2 <- 0
        div(align = "center", h5("Superficie del terreno sin completar", style = "color: red"))
      }else{
        m2 <- 1
        div()
      },
      if(!is.null(input$inmo_m2_cons) && ((is.na(input$inmo_m2_cons) | input$inmo_m2_cons == 0) & input$inmo_tipoPropiedad %in% c("Casa", "Duplex", "Departamento", "Deposito", "Tinglado", "Edificio", "Casa quinta", "Oficina", "Salón comercial"))){
        m2_cons <- 0
        div(align = "center", h5("Superficie edificada sin completar", style = "color: red"))
      }else{
        m2_cons <- 1
        div()
      },
      if(externa == "no" && !is.null(input$inmo_titulo) && input$inmo_titulo == ""){
        titulo <- 0
        div(align = "center", h5("Encabezado sin completar", style = "color: red"))
      }else{
        titulo <- 1
        div()
      },
      if(externa == "no" && !is.null(input$inmo_descripcion) && input$inmo_descripcion == ""){
        descrip <- 0
        div(align = "center", h5("Descripción sin completar", style = "color: red"))
      }else{
        descrip <- 1
        div()
      },
      if(mapa + foto + tipo + cliente + precio + desc + foto_cont + fecha_cont + m2 + m2_cons + titulo + descrip == 12){
        tags$div(id = "bttn_modal",
                 actionBttn("finish_inmo", ifelse(isolate(edit_inmo_on()) == 1, "Almacenar cambios", "Almacenar nuevo")),
                 actionBttn("finish_inmo_cancel", "Cancelar"),
                 align = "center")
      }else{
        tags$div(id = "bttn_modal",
                 actionBttn("finish_inmo_cancel", "Cancelar"),
                 align = "center")
      }
    )
  })
  
  output$contrato_ui <- renderUI({
    if(new_inmo_on() == 1 | edit_inmo_on() == 1){
      if(edit_inmo_on() == 1){
        user <- vars$show_inmo$user
      }else{
        user <- vars$user$user
      }
      if(!is.null(input$inmo_tipo_contrato) && input$inmo_tipo_contrato != "Sin contrato"){
        div(
          dateInput("inmo_ini_contrato", "Inicio contrato (año-mes-día)", language = "es", value = ifelse(edit_inmo_on() == 1, vars$show_inmo$ini_contrato, "")),
          dateInput("inmo_fin_contrato", "Final contrato (año-mes-día)", language = "es", value = ifelse(edit_inmo_on() == 1, vars$show_inmo$fin_contrato, "")),
          if(permiso("editar propiedades", user, vars$permisos_acc, vars$permisos_men) | vars$user$cargo %in% c("Global Master Office", "Broker Office", "Broker Manager", "Country Office Manager")){
            selectInput("inmo_borrador", "Publicación", choices = c("Borrador", "Publicado"), selected = ifelse(edit_inmo_on() == 1, ifelse(vars$show_inmo$borrador == "si", "Borrador", "Publicado"), "Borrador"))
          }
        )
      }
    }
  })
  
  output$comision_ui <- renderUI({
    req(input$inmo_externa, input$inmo_venta_alquiler)
    div(
      if(input$inmo_venta_alquiler == "Venta"){
        autonumericInput(inputId = "inmo_comision", align = "left",
                         label = "Comisión",
                         value = ifelse(edit_inmo_on() == 1, as.numeric(vars$show_inmo$comision), 5.5), currencySymbol = "%", currencySymbolPlacement = "s",
                         decimalPlaces = 1, digitGroupSeparator = ",", decimalCharacter = ".")
      }else{
        autonumericInput(inputId = "inmo_comision", align = "left",
                         label = "Comisión",
                         value = ifelse(edit_inmo_on() == 1, as.numeric(vars$show_inmo$comision), 50), currencySymbol = "%", currencySymbolPlacement = "s",
                         decimalPlaces = 0, digitGroupSeparator = ",", decimalCharacter = ".")
      },
      if(input$inmo_externa == "Propiedad SkyOne"){
        selectInput("inmo_estado_juridico", "Estado jurídico", choices = c("Libre de gravamen", "En sucesión", "Acuerdo de proyecto", "Otro"))
        
      }
    )
  })
  
  sel_prop <- reactive({
    if(edit_inmo_on() == 1){
      sel <- vars$show_inmo$tipoPropiedad
    }else{
      sel <- input$inmo_tipoPropiedad
    }
    return(sel)
  })
  
  observeEvent(input$selected,{
    order <- input$selected
    series <- extract_serie_galeria(isolate(vars$galeria_fotos_inmo)) %>% as.character
    order <- order[order %in% series] %>% as.integer()
    print("order")
    print(order)
    vars$galeria_inmo_order <- order
  })
  
  output$inmo_multimedios_ui <- renderUI({
    if(new_inmo_on() == 1 | edit_inmo_on() == 1 | home_on() == 1){
      fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                if(home_on() != 1)
                  h4(HTML(paste0("<p><span style='color: ", main_color, "'>Multimedios</span></p>")), width = "100%"),
                tags$div(id = "inline",
                         fluidRow(
                           column(3, 
                                  fileInput(inputId = "upload_inmo",
                                            label = NULL,
                                            buttonLabel = "Subir foto",
                                            placeholder = "no hay fotos",
                                            multiple = TRUE,
                                            accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
                           ),  
                           column(9, 
                                  tagList(
                                    tags$div(
                                      id = "example03", 
                                      div(id = 1, `data-rank-id` = "1", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo01"))){ #paste0(vars$user$user,"01")
                                            div(tags$div(id = "gal_del", actionButton("gal_del1", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo01.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 2, `data-rank-id` = "2", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo02"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del2", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo02.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 3, `data-rank-id` = "3", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo03"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del3", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo03.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 4, `data-rank-id` = "4", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo04"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del4", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo04.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 5, `data-rank-id` = "5", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo05"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del5", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo05.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 6, `data-rank-id` = "6", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo06"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del6", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo06.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 7, `data-rank-id` = "7", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo07"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del7", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo07.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 8, `data-rank-id` = "8", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo08"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del8", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo08.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 9, `data-rank-id` = "9", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo09"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del9", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo09.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 10, `data-rank-id` = "10", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo10"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del10", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo10.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 11, `data-rank-id` = "11", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo11"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del11", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo11.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 12, `data-rank-id` = "12", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo12"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del12", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo12.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 13, `data-rank-id` = "13", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo13"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del13", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo13.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 14, `data-rank-id` = "14", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo14"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del14", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo14.jpg"))), '" width=200>')))
                                          },
                                      ),
                                      div(id = 15, `data-rank-id` = "15", class = "btn-group", style = "margin: 5px",
                                          if(sum(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo15"))){
                                            div(tags$div(id = "gal_del", actionButton("gal_del15", NULL, icon = icon("trash-alt"))),
                                                HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo15.jpg"))), '" width=200>')))
                                          }
                                      )
                                    ),
                                    sortable_js(css_id = "example03",    
                                                options = sortable_options(
                                                  onSort = sortable_js_capture_input(input_id = "selected")
                                                ))
                                  )
                           )
                         ),
                         textInput("inmo_video", "Link de YouTube (opcional)")
                )
      )
    }
  })
  
  observeEvent(input$gal_del1, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo01"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]
  })
  
  observeEvent(input$gal_del2, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo02"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]
  })
  
  observeEvent(input$gal_del3, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo03"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]
  })
  
  observeEvent(input$gal_del4, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo04"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]
  })
  
  observeEvent(input$gal_del5, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo05"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]  
  })
  
  observeEvent(input$gal_del6, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo06"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]
  })
  
  observeEvent(input$gal_del7, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo07"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]
  })
  
  observeEvent(input$gal_del8, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo08"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]
  })
  
  observeEvent(input$gal_del9, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo09"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]  
  })
  
  observeEvent(input$gal_del10, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo10"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]  
  })
  
  observeEvent(input$gal_del11, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo11"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind] 
  })
  
  observeEvent(input$gal_del12, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo12"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]  
  })
  
  observeEvent(input$gal_del13, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo13"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]  
  })
  
  observeEvent(input$gal_del14, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo14"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]
  })
  
  observeEvent(input$gal_del15, {
    ind <- which(str_detect(vars$galeria_fotos_inmo, "temp_foto_inmo15"))
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-ind]
  })
  
  
  observeEvent(input$upload_cont, {
    vars$upload_cont <- input$upload_cont
  })
  
  observe({
    if(!is.null(vars$upload_cont)){
      rand <- str_pad(round(runif(1, min=1, max=9999999999)), 10, pad = "0")
      if(sum(str_detect(vars$upload_cont$datapath, "pdf$")) == 1){
        shinyalert(
          type = "error",
          title = "El contrato no puede ser un PDF, elija una foto y vuelva a intentarlo"
        )
      }else{
        for(i in 1:nrow(vars$upload_cont)){
          serie_foto <- length(isolate(vars$galeria_fotos_cont)) + 1
          if(serie_foto == 6){
            shinyalert(
              type = "error",
              title = "Ya ha alcanzado el maximo de 5 fotos"
            )
          }else{
            im_error <- tryCatch({
              
              im <- image_read(vars$upload_cont$datapath[i])
              im <- image_orient(im)
              im <- image_convert(im, format = "jpg")
              im <- image_scale(im, "1000x")
              image_write(im, file.path(dir, paste0(session$token, "temp_foto_cont.jpg")))
              vars$foto_cont_file <- dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cont.jpg")))
              serie <- paste0("", str_pad(serie_foto, 2, pad = "0"))
              file <- file.path(dir, paste0(session$token, "temp_foto_cont", serie, ".jpg"))
              image_write(im, file)
              vars$galeria_fotos_cont <- c(isolate(vars$galeria_fotos_cont), file)
              
              vars$ind_galeria_fotos_cont <- length(isolate(vars$galeria_fotos_cont))
              
              "listo"},
              error = function(e){NA}
            )
          }
        }
      }
    }
  })
  
  observeEvent(input$selected_cont,{
    order <- input$selected_cont
    order <- order[1:length(vars$galeria_fotos_cont)] %>% as.integer()
    vars$galeria_cont_order <- order
    print(isolate(vars$galeria_cont_order))
    print(isolate(vars$galeria_fotos_cont))
  })
  
  output$contrato_multimedios_ui <- renderUI({
    if(new_inmo_on() == 1 | edit_inmo_on() == 1){
      if(!is.null(input$inmo_tipo_contrato) && input$inmo_tipo_contrato != "Sin contrato"){
        div(
          fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                    h4(HTML(paste0("<p><span style='color: ", main_color, "'>Documentos</span></p>")), width = "100%"),
                    tags$div(id = "inline",
                             fluidRow(
                               column(3, 
                                      fileInput(inputId = "upload_cont",
                                                label = NULL,
                                                buttonLabel = "Subir foto",
                                                placeholder = "no hay fotos",
                                                multiple = TRUE,
                                                accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
                                      uiOutput("contrato_ui")
                               ),  
                               column(9, 
                                      tagList(
                                        tags$div(
                                          id = "example04", 
                                          div(id = 1, `data-rank-id` = "1", class = "btn-group", style = "margin: 5px",
                                              if(sum(str_detect(vars$galeria_fotos_cont, "temp_foto_cont01.jpg"))){
                                                div(tags$div(id = "gal_del", actionButton("gal_cont_del1", NULL, icon = icon("trash-alt"))),
                                                    actionButton("gal_cont_open1", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 160px; height: 213px;
                                                             background-image: url("', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cont01.jpg"))), '");
                                                             background-size: cover, 160px 213px;
                                                             border-radius: 10px')))
                                              },
                                          ),
                                          div(id = 2, `data-rank-id` = "2", class = "btn-group", style = "margin: 5px",
                                              if(sum(str_detect(vars$galeria_fotos_cont, "temp_foto_cont02.jpg"))){
                                                div(tags$div(id = "gal_del", actionButton("gal_cont_del2", NULL, icon = icon("trash-alt"))),
                                                    actionButton("gal_cont_open2", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 160px; height: 213px;
                                                             background-image: url("', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cont02.jpg"))), '");
                                                             background-size: cover, 160px 213px;
                                                             border-radius: 10px')))
                                              },
                                          ),
                                          div(id = 3, `data-rank-id` = "3", class = "btn-group", style = "margin: 5px",
                                              if(sum(str_detect(vars$galeria_fotos_cont, "temp_foto_cont03.jpg"))){
                                                div(tags$div(id = "gal_del", actionButton("gal_cont_del3", NULL, icon = icon("trash-alt"))),
                                                    actionButton("gal_cont_open3", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 160px; height: 213px;
                                                             background-image: url("', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cont03.jpg"))), '");
                                                             background-size: cover, 160px 213px;
                                                             border-radius: 10px')))
                                              },
                                          ),
                                          div(id = 4, `data-rank-id` = "4", class = "btn-group", style = "margin: 5px",
                                              if(sum(str_detect(vars$galeria_fotos_cont, "temp_foto_cont04.jpg"))){
                                                div(tags$div(id = "gal_del", actionButton("gal_cont_del4", NULL, icon = icon("trash-alt"))),
                                                    actionButton("gal_cont_open4", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 160px; height: 213px;
                                                             background-image: url("', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cont04.jpg"))), '");
                                                             background-size: cover, 160px 213px;
                                                             border-radius: 10px')))
                                              },
                                          ),
                                          div(id = 5, `data-rank-id` = "5", class = "btn-group", style = "margin: 5px",
                                              if(sum(str_detect(vars$galeria_fotos_cont, "temp_foto_cont05.jpg"))){
                                                div(tags$div(id = "gal_del", actionButton("gal_cont_del5", NULL, icon = icon("trash-alt"))),
                                                    actionButton("gal_cont_open5", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 160px; height: 213px;
                                                             background-image: url("', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cont05.jpg"))), '");
                                                             background-size: cover, 160px 213px;
                                                             border-radius: 10px')))
                                              },
                                          ),
                                        ),
                                        sortable_js(css_id = "example04",    
                                                    options = sortable_options(
                                                      onSort = sortable_js_capture_input(input_id = "selected_cont")
                                                    ))
                                      )
                               )
                             )
                    )
          ),
          br()
        )
      }
    }
  })
  
  observeEvent(input$gal_cont_del1, {
    ind <- which(str_detect(vars$galeria_fotos_cont, "temp_foto_cont01.jpg"))
    vars$galeria_fotos_cont <- vars$galeria_fotos_cont[-ind]
  })
  
  observeEvent(input$gal_cont_del2, {
    ind <- which(str_detect(vars$galeria_fotos_cont, "temp_foto_cont02.jpg"))
    vars$galeria_fotos_cont <- vars$galeria_fotos_cont[-ind]
  })
  
  observeEvent(input$gal_cont_del3, {
    ind <- which(str_detect(vars$galeria_fotos_cont, "temp_foto_cont03.jpg"))
    vars$galeria_fotos_cont <- vars$galeria_fotos_cont[-ind]
  })
  
  observeEvent(input$gal_cont_del4, {
    ind <- which(str_detect(vars$galeria_fotos_cont, "temp_foto_cont04.jpg"))
    vars$galeria_fotos_cont <- vars$galeria_fotos_cont[-ind]
  })
  
  observeEvent(input$gal_cont_del5, {
    ind <- which(str_detect(vars$galeria_fotos_cont, "temp_foto_cont05.jpg"))
    vars$galeria_fotos_cont <- vars$galeria_fotos_cont[-ind]  
  })
  
  observeEvent(input$gal_cont_open1, {
    showModal(modalDialog(
      div(
        HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cont01.jpg"))), '"', 
                    ifelse(input$dimension[1] < 768, ' width=320', ' width=640'), '>')),
        align = "center"),
      br(), 
      tags$div(id="bttn_modal", 
               actionBttn("close_tipologia", "OK"),
               align = "center"),
      title = "Ver contrato",
      easyClose = TRUE,
      footer = NULL,
      size = "l",
      fade = TRUE
    ))
  })
  
  observeEvent(input$gal_cont_open2, {
    showModal(modalDialog(
      div(
        HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cont02.jpg"))), '"', 
                    ifelse(input$dimension[1] < 768, ' width=320', ' width=640'), '>')),
        align = "center"),
      br(), 
      tags$div(id="bttn_modal", 
               actionBttn("close_tipologia", "OK"),
               align = "center"),
      title = "Ver contrato",
      easyClose = TRUE,
      footer = NULL,
      size = "l",
      fade = TRUE
    ))
  })
  
  observeEvent(input$gal_cont_open3, {
    showModal(modalDialog(
      div(
        HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cont03.jpg"))), '"', 
                    ifelse(input$dimension[1] < 768, ' width=320', ' width=640'), '>')),
        align = "center"),
      br(), 
      tags$div(id="bttn_modal", 
               actionBttn("close_tipologia", "OK"),
               align = "center"),
      title = "Ver contrato",
      easyClose = TRUE,
      footer = NULL,
      size = "l",
      fade = TRUE
    ))
  })
  
  observeEvent(input$gal_cont_open4, {
    showModal(modalDialog(
      div(
        HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cont04.jpg"))), '"', 
                    ifelse(input$dimension[1] < 768, ' width=320', ' width=640'), '>')),
        align = "center"),
      br(), 
      tags$div(id="bttn_modal", 
               actionBttn("close_tipologia", "OK"),
               align = "center"),
      title = "Ver contrato",
      easyClose = TRUE,
      footer = NULL,
      size = "l",
      fade = TRUE
    ))
  })
  
  observeEvent(input$gal_cont_open5, {
    showModal(modalDialog(
      div(
        HTML(paste0('<img src="', dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cont05.jpg"))), '"', 
                    ifelse(input$dimension[1] < 768, ' width=320', ' width=640'), '>')),
        align = "center"),
      br(), 
      tags$div(id="bttn_modal", 
               actionBttn("close_tipologia", "OK"),
               align = "center"),
      title = "Ver contrato",
      easyClose = TRUE,
      footer = NULL,
      size = "l",
      fade = TRUE
    ))
  })
  
  output$tipo_prop_ui <- renderUI({
    fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
              h4(HTML(paste0("<p><span style='color: ", main_color, "'>", sel_prop(), "</span></p>")), width = "100%"),
              if(sel_prop() %in% c("Casa", "Duplex", "Casa quinta")){
                tags$div(id = "inline",
                         column(4, 
                                numericInput("inmo_m2", "m2 terreno", NULL, min = 0),
                                numericInput("inmo_m2_cons", "m2 construido", NULL, min = 0),
                                numericInput("inmo_anio", "Antiguedad", NULL, min = 0),
                                selectInput("inmo_estado", "Estado general", choices = c("Excelente", "Bueno", "Regular", "Malo"))
                         ),
                         column(4, 
                                selectInput("inmo_dormitorios", "Dormitorios", choices = c("1", "2", "3", "4", "5+")),
                                selectInput("inmo_banios", "Baños", choices = c("1", "2", "3", "4", "5+")),
                                selectInput("inmo_garajes", "Cocheras", choices = c("0", "1", "2", "3", "4", "5+")),
                                selectInput("inmo_tipo_cocina", "Cocina", choices = c("Integrada", "Independiente"))
                         ),
                         column(4, 
                                div(column(4, style = "padding: 0px; width: 110px", "Esquina"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_esquina", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Condominio"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_condominio", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Cocina equipada"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_cocina_equipada", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Quincho"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_quincho", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Area servicio"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_area_servicio", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Piscina"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_piscina", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Gimnasio"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_gimnasio", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Depósito"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_deposito", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Generador"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_generador", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                         )
                )
              },
              if(sel_prop() %in% c("Terreno")){
                tags$div(id = "inline",
                         column(4, 
                                numericInput("inmo_m2", "m2 terreno", NULL, min = 0)
                         ),
                         column(4, 
                                numericInput("inmo_frente", "Frente", NULL, min = 0),
                                numericInput("inmo_fondo", "Fondo", NULL, min = 0)
                         ),
                         column(4, 
                                div(column(4, style = "padding: 0px; width: 110px", "Esquina"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_esquina", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Condominio"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_condominio", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80)))
                         )
                )
              },
              if(sel_prop() %in% c("Propiedad rural")){
                tags$div(id = "inline",
                         numericInput("inmo_m2", "hectareas terreno", NULL, min = 0)
                )
              },
              if(sel_prop() %in% c("Departamento")){
                tags$div(id = "inline",
                         column(4, 
                                numericInput("inmo_pisos", "Ubicado en piso", NULL, min = 0),
                                numericInput("inmo_m2_cons", "m2 construido", NULL, min = 0),
                                numericInput("inmo_anio", "Antiguedad", NULL, min = 0),
                                selectInput("inmo_estado", "Estado general", choices = c("Excelente", "Bueno", "Regular", "Malo")),
                         ),
                         column(4,
                                selectInput("inmo_dormitorios", "Dormitorios", choices = c("Monoambiente" = "0", "1", "2", "3", "4", "5+")),
                                selectInput("inmo_banios", "Baños", choices = c("1", "2", "3", "4", "5+")),
                                selectInput("inmo_garajes", "Cocheras", choices = c("0", "1", "2", "3", "4", "5+")),
                                selectInput("inmo_bauleras", "Bauleras", choices = c("0", "1", "2", "3", "4", "5+")),
                                selectInput("inmo_ascensor", "Ascensor", choices = c("0", "1", "2", "3", "4", "5+"))
                         ),
                         column(4, 
                                div(column(4, style = "padding: 0px; width: 110px", "Esquina"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_esquina", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Condominio"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_condominio", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Balcón"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_balcon", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Area servicio"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_area_servicio", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Piscina"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_piscina", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Parrilla propia"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_parrilla", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Gimnasio"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_gimnasio", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Generador"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_generador", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Pet friendly"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_pet_friendly", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                         )
                )
              },
              if(sel_prop() %in% c("Edificio", "Proyecto")){
                tags$div(id = "inline",
                         fluidRow(
                           column(4, 
                                  if(sel_prop() == "Edificio") numericInput("inmo_m2", "m2 terreno", NULL, min = 0),
                                  if(sel_prop()  == "Edificio") numericInput("inmo_m2_cons", "m2 edificado", NULL, min = 0),
                                  numericInput("inmo_pisos", "Total de pisos", NULL, min = 0),
                                  selectInput("inmo_ascensor", "Ascensor", choices = c("0", "1", "2", "3", "4", "5+"))
                           ),
                           column(4,
                                  if(sel_prop() == "Edificio") numericInput("inmo_anio", "Antiguedad", NULL, min = 0),
                                  if(sel_prop() == "Edificio") selectInput("inmo_estado", "Estado general", choices = c("Excelente", "Bueno", "Regular", "Malo")),
                                  div(column(4, style = "padding: 0px; width: 110px", "Esquina"),
                                      column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_esquina", NULL,
                                                                                       value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                  div(column(4, style = "padding: 0px; width: 110px", "Condominio"),
                                      column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_condominio", NULL,
                                                                                       value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                  div(column(4, style = "padding: 0px; width: 110px", "Piscina"),
                                      column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_piscina", NULL,
                                                                                       value = FALSE,  status = "info", inline = FALSE, width = 80))),
                           ),
                           column(4, 
                                  div(column(4, style = "padding: 0px; width: 110px", "Gimnasio"),
                                      column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_gimnasio", NULL,
                                                                                       value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                  div(column(4, style = "padding: 0px; width: 110px", "Generador"),
                                      column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_generador", NULL,
                                                                                       value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                  if(sel_prop() == "Proyecto") 
                                    div(column(4, style = "padding: 0px; width: 110px", "Pet friendly"),
                                        column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_pet_friendly", NULL,
                                                                                         value = FALSE,  status = "info", inline = FALSE, width = 80))),
                           )
                         )
                )
              },
              if(sel_prop() %in% c("Oficina", "Salón comercial")){
                tags$div(id = "inline",
                         column(4, 
                                numericInput("inmo_m2_cons", "Superficie", NULL, min = 0),
                                selectInput("inmo_oficinas", "Oficinas", choices = c("0", "1", "2", "3", "4", "5+")),
                         ),
                         column(4, 
                                selectInput("inmo_banios", "Baños propios", choices = c("0", "1", "2", "3", "4", "5+")),
                                selectInput("inmo_banios_compartidos", "Baños compartidos", choices = c("0", "1", "2", "3", "4", "5+")),
                                selectInput("inmo_garajes", "Cocheras", choices = c("0", "1", "2", "3", "4", "5+")),
                         ),
                         column(4, 
                                div(column(4, style = "padding: 0px; width: 110px", "Esquina"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_esquina", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Kitchenette"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_cocina_propia", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Generador"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_generador", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                         )
                )
              },
              if(sel_prop() %in% c("Tinglado", "Deposito")){
                tags$div(id = "inline",
                         column(4, 
                                numericInput("inmo_m2", "m2 terreno", NULL, min = 0),
                                numericInput("inmo_m2_cons", "m2 edificado", NULL, min = 0),
                                selectInput("inmo_oficinas", "Oficinas", choices = c("0", "1", "2", "3", "4", "5+")),
                         ),
                         column(4, 
                                selectInput("inmo_banios", "Baños", choices = c("0", "1", "2", "3", "4", "5+")),
                                selectInput("inmo_garajes", "Cocheras", choices = c("0", "1", "2", "3", "4", "5+")),
                         ),
                         column(4, 
                                div(column(4, style = "padding: 0px; width: 110px", "Esquina"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_esquina", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Trifácico"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_trifacico", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                                div(column(4, style = "padding: 0px; width: 110px", "Generador"),
                                    column(8, style = "padding: 0px", materialSwitch(inputId = "inmo_generador", NULL,
                                                                                     value = FALSE,  status = "info", inline = FALSE, width = 80))),
                         )
                )
              }
    )
  })
  
  ###################################################################################################################################  
  ###################################################################################################################################  
  #Tipologias
  
  output$tipologias_ui <- renderUI({
    req(input$inmo_tipoPropiedad)
    if(input$inmo_tipoPropiedad == "Proyecto"){
      if(edit_inmo_on() == 0) vars$tipologia_list_all <- data.frame()
      div(
        br(),
        fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding-bottom: 20px"),
                  h4(HTML(paste0("<p><span style='color: ", main_color, "'>Tipologías del proyecto</span></p>")), width = "100%"),
                  tags$div(id = "inline",
                           column(2, 
                                  actionButton("tipologias_new", "Agregar Tipología", icon = icon("plus"))
                           ),
                           column(10,
                                  uiOutput("tipologias_box_ui")
                           )
                  )
        )
      )
    }
  })
  
  observeEvent(input$tipologias_new, {
    tipologia_on(1)
    vars$foto_cliente <- NULL
    vars$upload_cliente <- NULL
    vars$edit_tipo <- data.frame()
    if(nrow(vars$place) == 0){
      shinyalert(
        type = "error",
        title = "Ubica primero en el mapa el proyecto"
      )
    }else{
      print("nueva tipologia")
      showModal(modalDialog(
        tags$div(id = "inline",
                 textAreaInput("inmo_titulo_tipo", "Título"),
                 fluidRow(
                   column(6, 
                          uiOutput("file_input_cliente"),
                   ),
                   column(6,
                          if(sel_prop()  == "Proyecto") 
                            autonumericInput("inmo_precio_tipo", "Precio", value = 0,
                                             currencySymbol = ifelse(input$inmo_moneda_contrato == "USD", "$ ", "Gs "), currencySymbolPlacement = "p", align = "left",
                                             decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ","),
                          autonumericInput("inmo_m2_cons_tipo", "m2 construido", value = 0,
                                           currencySymbol = " ₘ₂", currencySymbolPlacement = "s", align = "left",
                                           decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ","),
                          selectInput("inmo_dormitorios_tipo", "Dormitorios", choices = c("Monoambiente" = "0", "1", "2", "3", "4", "5+")),
                          selectInput("inmo_banios_tipo", "Baños", choices = c("1", "2", "3", "4", "5+")),
                          selectInput("inmo_garajes_tipo", "Cocheras", choices = c("0", "1", "2", "3", "4", "5+")),
                          selectInput("inmo_bauleras_tipo", "Bauleras", choices = c("0", "1", "2", "3", "4", "5+")),
                   )
                 ),
                 div(
                   materialSwitch(inputId = "inmo_balcon_tipo", "Balcón", value = FALSE,  status = "info", inline = TRUE),
                   materialSwitch(inputId = "inmo_area_servicio_tipo", "Area de servicio", value = FALSE,  status = "info", inline = TRUE),
                   materialSwitch(inputId = "inmo_parrilla_tipo", "Parrilla propia", value = FALSE,  status = "info", inline = TRUE),
                 )
        ),
        br(), 
        tags$div(id="bttn_modal", 
                 uiOutput("finish_tipo_btn_ui"),
                 br(),
                 br(),
                 actionBttn("close_tipologia", "Cancelar"),
                 align = "center"),
        title = "Crear tipología",
        easyClose = FALSE,
        footer = NULL,
        size = "m",
        fade = TRUE
      ))
    }
  })
  
  observeEvent(input$close_tipologia,{
    tipologia_on(0)
    removeModal()
  })
  
  output$finish_tipo_btn_ui <- renderUI({
    div(
      if(is.null(vars$foto_cliente)){
        foto <- 0
        div(align = "center", h5("Agrega una foto", style = "color: red"))
      }else{
        foto <- 1
        div()
      },
      if(str_length(input$inmo_titulo_tipo) > 60){
        len <- str_length(input$inmo_titulo_tipo)
        desc <- 0
        div(align = "center", h5(paste0("Longitud: ", len, " - El título debe contener hasta 60 caracteres"), style = "color: red"))
      }else{
        desc <- 1
        div()
      },
      if(!is.null(input$inmo_precio_tipo) && (is.na(input$inmo_precio_tipo) | input$inmo_precio_tipo == 0)){
        precio <- 0
        div(align = "center", h5("Precio sin completar", style = "color: red"))
      }else{
        precio <- 1
        div()
      },
      if(!is.null(input$inmo_m2_cons_tipo) && (is.na(input$inmo_m2_cons_tipo) | input$inmo_m2_cons_tipo == 0)){
        m2_cons <- 0
        div(align = "center", h5("Superficie edificada sin completar", style = "color: red"))
      }else{
        m2_cons <- 1
        div()
      },
      if(input$inmo_titulo_tipo == ""){
        titulo <- 0
        div(align = "center", h5("Título sin completar", style = "color: red"))
      }else{
        titulo <- 1
        div()
      },
      if(foto + precio + desc + m2_cons + titulo == 5){
        tags$div(id = "bttn_modal",
                 actionBttn("tipologias_new_ok", "Crear"),
                 align = "center")
      }
    )
  })
  
  observeEvent(input$tipologias_new_ok, {
    new_inmo <- data.frame(
      id = "provisorio",
      company = co,
      fecha = as.character(now("America/Asuncion")),
      fecha_creacion = as.character(now("America/Asuncion")),
      fecha_aprobacion = as.character(now("America/Asuncion")),
      cliente = NA,
      referente = NA,
      pais = NA,
      departamento = NA,
      ciudad = NA,
      distrito = NA,
      calle = NA,
      nro_casa = NA,
      catastro = NA,
      referencia = NA,
      venta_alquiler = input$inmo_venta_alquiler,
      tipo_contrato = NA,
      tipoPropiedad = "Tipologia",
      user = vars$user$user,
      comision = NA,
      estado_juridico = NA,
      moneda_contrato = input$inmo_moneda_contrato,
      precio = ifelse(sel_prop()  == "Proyecto", input$inmo_precio_tipo, 0),
      ini_contrato = NA,
      fin_contrato = NA,
      img = NA,
      video = NA,
      link = NA,
      titulo = input$inmo_titulo_tipo,
      descripcion = NA,
      publicado = "si",
      destacado = "no",
      borrador = "si",
      m2 = 0,
      m2_cons = ifelse(!is.null(input$inmo_m2_cons_tipo) && !is.na(input$inmo_m2_cons_tipo), input$inmo_m2_cons_tipo, 0),
      dormitorios = ifelse(!is.null(input$inmo_dormitorios_tipo), input$inmo_dormitorios_tipo, NA),
      banios = ifelse(!is.null(input$inmo_banios_tipo), input$inmo_banios_tipo, NA),
      garajes = ifelse(!is.null(input$inmo_garajes_tipo), input$inmo_garajes_tipo, NA),
      tipo_cocina = NA,
      cocina_equipada = NA,
      quincho = NA,
      area_servicio = ifelse(!is.null(input$inmo_area_servicio_tipo), ifelse(input$inmo_area_servicio_tipo, "si", "no"), NA),
      piscina = NA,
      deposito = NA,
      generador = NA,
      frente = 0,
      fondo = 0,
      pisos = 0,
      bauleras = ifelse(!is.null(input$inmo_bauleras_tipo), input$inmo_bauleras_tipo, NA),
      ascensor = NA,
      balcon = ifelse(!is.null(input$inmo_balcon_tipo), ifelse(input$inmo_balcon_tipo, "si", "no"), NA),
      parrilla = ifelse(!is.null(input$inmo_parrilla_tipo), ifelse(input$inmo_parrilla_tipo, "si", "no"), NA),
      gimnasio = NA,
      pet_friendly = NA,
      condominio = NA,
      anio = 0,
      fecha_cierre = NA,
      precio_cierre = 0,
      precio_m2 = 0,
      tipoDato = "Oferta",
      estado = NA,
      esquina = NA,
      banios_compartidos = NA,
      oficinas = NA,
      cocina_propia = NA,
      trifacico = NA,
      id_tipo = NA,
      comment = NA,
      externa = "no",
      activo = "si",
      lat = isolate(vars$place$lat),
      lon = isolate(vars$place$lon)
    )
    print("new tipologia")
    print(new_inmo)
    new_inmo <- new_inmo %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
    new_inmo$lat <- isolate(vars$place$lat)
    new_inmo$lon <- isolate(vars$place$lon)
    rand <- str_pad(round(runif(1, min=1, max=9999999999)), 10, pad = "0")
    new_inmo$img <-  paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/temp/tipologias/", vars$user$user, rand, ".jpg")
    print(new_inmo$img)
    put_object_do(paste0("/", co, "/temp/tipologias/", vars$user$user, rand, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
    print("foto tipologia cargada")
    if(edit_inmo_on() == 1){
      if(nrow(vars$edit_tipo) == 0){
        print("no editando tipo")
        new_inmo$id_tipo <- NA
        vars$tipologia_list_all <- rbind(vars$tipologia_list_all, new_inmo)
      }else{
        print("editando tipo")
        print(vars$edit_tipo_n)
        print(vars$edit_tipo)
        print(new_inmo)
        ind <- vars$edit_tipo_n
        new_inmo$id_tipo <- vars$edit_tipo$id_tipo
        vars$tipologia_list_all <- vars$tipologia_list_all[-ind,]
        vars$tipologia_list_all <- rbind(vars$tipologia_list_all, new_inmo)
        print(vars$tipologia_list_all)
      }
    }else{
      vars$tipologia_list_all <- rbind(vars$tipologia_list_all, new_inmo)
    }
    vars$upload_cliente <- NULL
    vars$foto_cliente <- NULL
    tipologia_on(0)
    removeModal()
  })
  
  obs_edit_tipo <- list()
  
  output$tipologias_box_ui <- renderUI({
    tipo_list_all <- vars$tipologia_list_all
    if(nrow(tipo_list_all) != 0){
      boxes <- as.list(1:nrow(tipo_list_all))
      boxes <- lapply(boxes, function(i){
        btName <- paste0("tipo_edit", i)
        obs_edit_tipo[[btName]] <<- observeEvent(input[[btName]], ignoreNULL = TRUE, ignoreInit = TRUE, {
          freezeReactiveValue(input, btName)
          edit_tipo <- vars$tipologia_list_all[i,]
          vars$upload_cliente <- NULL
          vars$foto_cliente <- NULL
          vars$edit_tipo <- edit_tipo
          vars$edit_tipo_n <- i
          print("edit tipo")
          print(edit_tipo)
          tipologia_on(1)
          
          updateTextAreaInput(session, "inmo_titulo_tipo", value = edit_tipo$titulo)
          if(edit_tipo$m2_cons != 0) updateAutonumericInput(session, "inmo_m2_cons_tipo", value = edit_tipo$m2_cons)
          if(edit_tipo$precio != 0) updateAutonumericInput(session, "inmo_precio_tipo", value = edit_tipo$precio)
          if(!is.na(edit_tipo$dormitorios)) updateSelectInput(session, "inmo_dormitorios_tipo", selected = edit_tipo$dormitorios)
          if(!is.na(edit_tipo$banios)) updateSelectInput(session, "inmo_banios_tipo", selected = edit_tipo$banios)
          if(!is.na(edit_tipo$garajes)) updateSelectInput(session, "inmo_garajes_tipo", selected = edit_tipo$garajes)
          if(!is.na(edit_tipo$bauleras)) updateSelectInput(session, "inmo_bauleras_tipo", selected = edit_tipo$bauleras)
          if(!is.na(edit_tipo$area_servicio)) updateMaterialSwitch(session, "inmo_area_servicio_tipo", value = ifelse(edit_tipo$area_servicio == "si", TRUE, FALSE)) 
          if(!is.na(edit_tipo$balcon)) updateMaterialSwitch(session, "inmo_balcon_tipo", value = ifelse(edit_tipo$balcon == "si", TRUE, FALSE)) 
          if(!is.na(edit_tipo$parrilla)) updateMaterialSwitch(session, "inmo_parrilla_tipo", value = ifelse(edit_tipo$parrilla == "si", TRUE, FALSE)) 
          
          showModal(modalDialog(
            tags$div(id = "inline",
                     textAreaInput("inmo_titulo_tipo", "Título"),
                     fluidRow(
                       column(6, 
                              uiOutput("file_input_cliente"),
                       ),
                       column(6,
                              if(sel_prop()  == "Proyecto") 
                                autonumericInput("inmo_precio_tipo", "Precio", value = 0,
                                                 currencySymbol = "$", currencySymbolPlacement = "p", align = "left",
                                                 decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ","),
                              autonumericInput("inmo_m2_cons_tipo", "m2 construido", value = 0,
                                               currencySymbol = " ₘ₂", currencySymbolPlacement = "s", align = "left",
                                               decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ","),
                              selectInput("inmo_dormitorios_tipo", "Dormitorios", choices = c("Monoambiente" = "0", "1", "2", "3", "4", "5+")),
                              selectInput("inmo_banios_tipo", "Baños", choices = c("1", "2", "3", "4", "5+")),
                              selectInput("inmo_garajes_tipo", "Cocheras", choices = c("0", "1", "2", "3", "4", "5+")),
                              selectInput("inmo_bauleras_tipo", "Bauleras", choices = c("0", "1", "2", "3", "4", "5+")),
                       )
                     ),
                     div(
                       materialSwitch(inputId = "inmo_balcon_tipo", "Balcón", value = FALSE,  status = "info", inline = TRUE),
                       materialSwitch(inputId = "inmo_area_servicio_tipo", "Area de servicio", value = FALSE,  status = "info", inline = TRUE),
                       materialSwitch(inputId = "inmo_parrilla_tipo", "Parrilla propia", value = FALSE,  status = "info", inline = TRUE),
                     )
            ),
            div(id = "icon_info",  style = "position: absolute; margin-top: 17px; margin-left: 30px",
                actionButton(inputId = "modal", label = NULL, icon = icon("trash-alt"), 
                             onclick = 'Shiny.setInputValue(\"tipo_delete\", this.id, {priority: \"event\"})',
                             style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px"),
                div(class = "icon_label", h5("eliminar"))
            ),
            br(), 
            tags$div(id="bttn_modal", 
                     actionBttn("tipologias_new_ok", "Guardar"),
                     actionBttn("close_tipologia", "Cancelar"),
                     align = "center"),
            title = "Editar tipología",
            easyClose = FALSE,
            footer = NULL,
            size = "m",
            fade = TRUE
          ))
        })
        
        tipo <- tipo_list_all[i,]
        print(tipo)
        if(tipo$moneda_contrato == "GS" & tipo$venta_alquiler == "Venta"){
          tipo$precio <- round(tipo$precio/1000000)
        }
        
        div(id = i, `data-rank-id` = as.character(i), style = "display:inline-block", 
            div(style = "position: absolute; margin-top: 171px; margin-left: 20px; width: 195px; line-height: 1.2;",
                HTML(paste0("<p><span style='font-size: 130%; font-weight: normal; color: #777777; height: 45px;'>", 
                            tipo$titulo, "</span></p>"))
            ),
            if(tipo$precio != 0){
              div(style = "position: absolute; margin-top: 211px; margin-left: 20px",
                  h4(paste0(tipo$moneda_contrato, " ", format(tipo$precio, big.mark = ".", decimal.mark = ",", scientific = FALSE),
                            ifelse(tipo$moneda_contrato == "GS" & tipo$venta_alquiler == "Venta", " millones", "")), 
                     style = paste0("font-weight: lighter; font-size: 200%;color: ", lighten(main_color, 0.20)))
              )
            }else{
              div(style = "position: absolute; margin-top: 226px; margin-left: 20px",
                  h4(" ", style = paste0("font-weight: lighter; font-size: 170%;color: ", lighten(main_color, 0.20)))
              )
            },
            div(style = "position: absolute; margin-top: 266px; margin-left: 20px",
                HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; color: #777777'>
                              <i class='fa fa-bed'></i> ", ifelse(tipo$dormitorios == "0", "M", tipo$dormitorios),
                            "  <i class='fa fa-bath'></i> ", tipo$banios,    
                            "  <i class='fa fa-ruler-combined'></i> ", tipo$m2_cons, "m2",
                            "  <i class='fa fa-car-side'></i> ", tipo$garajes,   
                            "  <i class='fa fa-suitcase'></i> ", tipo$bauleras,
                            "</span></p>"))
            ),
            div(style = "position: absolute; margin-top: 286px; margin-left: 20px",
                HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; color: #777777'>",
                            if(tipo$balcon == "si") "Balcón   ",
                            if(tipo$parrilla == "si") "Parrilla   ",
                            if(tipo$area_servicio == "si") "Area servicio   ",
                            "</span></p>")) 
            ),
            div(style = paste0("border-style: solid; border-width: 1px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; width: 210px; height: 306px;
                                 margin: 10px; padding: 0px"),
                div(actionButton(ifelse(new_inmo_on() == 1 | edit_inmo_on() == 1, btName, "nada"), NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:208px; height: 156px; margin: 0px;
                                                             background-image: url("', tipo$img, '");
                                                             background-size: cover, 208px 156px;
                                                             border-radius: 8px 8px 0px 0px')),
                )
            )
        )
      })
      tagList(
        tags$div(
          id = "example05",
          boxes,
          sortable_js(css_id = "example05",    
                      options = sortable_options(
                        onSort = sortable_js_capture_input(input_id = "selected_tipo")
                      ))
        )
      )
    }else{
      div()
    }
  })
  
  observeEvent(input$selected_tipo,{
    order <- input$selected_tipo
    order <- order[1:nrow(vars$tipologia_list_all)] %>% as.integer()
    vars$galeria_tipo_order <- order
    print(isolate(vars$galeria_tipo_order))
  })
  
  observeEvent(input$tipo_delete, {
    showModal(modalDialog(
      h4("¿Está seguro que desea eliminar la tipología?"),
      tags$div(id="bttn_modal", 
               actionBttn("tipo_delete_ok", "Eliminar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Eliminar tipología",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$tipo_delete_ok, {
    tipo <- vars$edit_tipo
    ind <- vars$edit_tipo_n
    vars$tipologia_list_all <- vars$tipologia_list_all[-ind,]
    if(!is.na(tipo$img)){
      delete_object_do(str_remove(tipo$img, "https://place-storage.nyc3.digitaloceanspaces.com"))
    }
    removeModal()
  })
  
  observeEvent(input$map_new_inmo_zoom,{
    if(vars$start == FALSE){
      vars$last_zoom_new_inmo <- input$map_new_inmo_zoom
    }
  })
  
  observe({
    if(new_inmo_on() == 1 | edit_inmo_on() == 1){
      output$map_new_inmo <- renderLeaflet({
        map <- leaflet() %>% addSearchOSM() %>% 
          setView(st_coordinates(vars$view)[1], st_coordinates(vars$view)[2], zoom = isolate(vars$last_zoom_new_inmo)) %>%
          addMarkers(data = vars$view, icon = skyone_marker, layerId = "pin") %>%
          addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
          addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
          addLayersControl(baseGroups = c("mapa", "satélite"),
                           options = layersControlOptions(collapsed=FALSE), position = "bottomleft")
        ubi <- st_coordinates(vars$view) %>% unlist()
        size <- 300/100000
        lat_min <- ubi[2] - size
        lat_max <- ubi[2] + size
        lon_min <- ubi[1] - size
        lon_max <- ubi[1] + size
        inmos <- filter_box_table_mysql(lat_min, lat_max, lon_min, lon_max, "myplace_inmuebles")
        inmos <- inmos %>% filter(tipoPropiedad == input$inmo_tipoPropiedad & borrador == "no" & activo == "si" & precio_cierre == 0)
        if(nrow(inmos) != 0){
          if(edit_inmo_on() == 1 && !is.null(vars$show_inmo$id)){
            inmos <- inmos[inmos$id != vars$show_inmo$id,]
          }
          if(nrow(inmos) != 0){
            map <- map %>% addMarkers(data = inmos, icon = ~icon_inmo(tipoPropiedad), layerId = ~id,
                                      popup = ~paste0("<b>", titulo, "</b>",
                                                      ifelse(!is.na(m2) & m2 != 0, paste0("<br><b>Area terreno = </b>", round(m2), " m2"), ""),
                                                      ifelse(!is.na(m2_cons) & m2_cons != 0,
                                                             paste0("<br><b>Area construida = </b>", round(m2_cons), " m2"), ""),
                                                      ifelse(!is.na(dormitorios), paste0("<br><b>Dormitorios = </b>", dormitorios), ""),
                                                      ifelse(!is.na(banios), paste0("<br><b>Baños = </b>", banios), ""),
                                                      "<br><b>Precio = </b>", moneda_contrato, " ", format(precio, big.mark=".", decimal.mark = ","),
                                                      "<br><b>Usuario = </b>", user,
                                                      "<br><b>Propiedad ", ifelse(company == "skyone", "SkyOne", "Externa"), "</b>",
                                                      "<br><img src = ", img, ' style=width:150px;height:100px;</img>'))
          }
        }
        map
      })
    }
  })
  
  observeEvent(input$map_new_inmo_click,{
    print("nuevo marker")
    place <- data.frame(lat = input$map_new_inmo_click$lat, lon = input$map_new_inmo_click$lng)
    point <- place %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
    way <- reverse_geocode(point)
    updateTextInput(session, "inmo_pais", value = way$country)
    updateTextInput(session, "inmo_departamento", value = way$county)
    updateTextInput(session, "inmo_ciudad", value = way$city)
    updateTextInput(session, "inmo_distrito", value = way$district)
    updateTextInput(session, "inmo_calle", value = way$street)
    updateTextInput(session, "inmo_nro_casa", value = way$house_number)
    vars$new_inmo_point <- TRUE
    vars$view <- point
    vars$place <- place
    
  })
  
  #  observeEvent(input$map_new_inmo_marker_click, {
  #    click <- input$map_new_inmo_marker_click
  #    if(click$id != "pin"){
  #      vars$click <- query_mysql(paste0("SELECT * FROM myplace_inmuebles WHERE id = '", click$id, "';"))
  #      vars$show_inmo <- vars$click
  #      modal_inmo_description()
  #    }
  #  })
  
  output$formulario_clien_edit <- renderUI({
    print("inicia formulario")
    print(vars$cliente)
    edit_clien_on(1)
    vars$llamadas_list <- list_table_var_mysql(paste0(co, "_llamadas"), "id_clien", vars$cliente$id)
    div(
      fluidRow(
        column(6,
               div(
                 uiOutput("file_input_cliente"),
                 div(id = "inline", actionButton("avatar_choose", "Elegir avatar"), align = "center", 
                     style = "padding:0px; margin: 0px", class = "btn-group"),
                 div(class = "btn-group", actionButton("nada", NULL, style = 'background-color: transparent;
                                                 border: 0px; width:40px; height: 40px; 
                                                 background-image: url("https://place-storage.nyc3.digitaloceanspaces.com/avatar-users/cartoon/avatar28.png");
                                                 background-size: cover, 40px 40px;',
                                                       onclick = 'Shiny.setInputValue(\"avatar_choose\", this.id, {priority: \"event\"})',)
                 ),
                 div(class = "btn-group", actionButton("nada", NULL, style = 'background-color: transparent;
                                                 border: 0px; width:40px; height: 40px; 
                                                 background-image: url("https://place-storage.nyc3.digitaloceanspaces.com/avatar-users/cartoon/avatar12.png");
                                                 background-size: cover, 40px 40px;',
                                                       onclick = 'Shiny.setInputValue(\"avatar_choose\", this.id, {priority: \"event\"})',)
                 ), align = "center"
               ),
               br(),
        ),
        br(),
        column(6,
               fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; margin-bottom: 10px"),
                         h4(HTML(paste0("<p><span style='color: ", main_color, "'>Editar datos del cliente</span></p>")), width = "100%"),
                         actionButton("cliente_tipo_change", paste0("Cliente o Asesor: ", vars$cliente$tipo), icon = icon("edit"), 
                                      style = "background-color: transparent; border-width: 0px"), br(),
                         actionButton("cliente_name_change", paste0("Nombre: ", vars$cliente$name), icon = icon("edit"), 
                                      style = "background-color: transparent; border-width: 0px"), br(),
                         actionButton("cliente_phone_change", paste0("Telefono: ", vars$cliente$phone), icon = icon("edit"),
                                      style = "background-color: transparent; border-width: 0px"), br(),
                         actionButton("cliente_mail_change", paste0("Email: ", vars$cliente$mail), icon = icon("edit"), 
                                      style = "background-color: transparent; border-width: 0px"), br(),
                         actionButton("cliente_birthday_change", paste0("Fecha de nacimiento: ", vars$cliente$birthday), icon = icon("edit"),
                                      style = "background-color: transparent; border-width: 0px"), br(),
                         actionButton("cliente_addr_change", paste0("Dirección: ", vars$cliente$addr), icon = icon("edit"), 
                                      style = "background-color: transparent; border-width: 0px"), br(),
                         actionButton("cliente_company_change", paste0("Compañía: ", vars$cliente$company), icon = icon("edit"),
                                      style = "background-color: transparent; border-width: 0px"), br(),
                         actionButton("cliente_razon_change", paste0("Razón social: ", vars$cliente$razon), icon = icon("edit"),
                                      style = "background-color: transparent; border-width: 0px"), br(),
                         actionButton("cliente_ruc_change", paste0("RUC: ", vars$cliente$ruc), icon = icon("edit"),
                                      style = "background-color: transparent; border-width: 0px"), br(),
                         actionButton("cliente_canal_change", paste0("Canal de contacto: ", vars$cliente$canal), icon = icon("edit"),
                                      style = "background-color: transparent; border-width: 0px"), br(),
                         div(class = "btn-group", actionButton("cliente_obs_change", "Primer contacto: ", icon = icon("edit"),
                                                               style = "background-color: transparent; border-width: 0px")),
                         div(class = "btn-group", vars$cliente$comment, style = "width: 100%; word-break: break-word; margin-left: 30px"),
                         br(), br(),
                         fluidPage(
                           if(!is.na(vars$cliente$phone)){
                             text_wp <- paste0("https://wa.me/", vars$cliente$phone, "?text=", "")
                             div(class = "btn-group",
                                 a(href= text_wp, target="_blank", 
                                   actionButton("nada", NULL , icon = icon("whatsapp"), style = "font-size: 200%; padding: 0px; background-color: transparent; border-color: transparent"))
                             )
                           },
                           if(vars$cliente$mail != ""){
                             div(class = "btn-group", style = "vertical-align: bottom",
                                 a(href= paste0("mailto:", vars$cliente$mail), target="_blank", 
                                   actionButton("nada", "" , icon = icon("envelope"), style = "font-size: 200%; padding: 0px; padding-left: 10px; background-color: transparent; border-color: transparent"))
                             )
                           }
                         )
               )
        )
      ),
      fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                   border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                                                   margin-bottom: 10px",
                h4(HTML(paste0("<p><span style='color: ", main_color, "'>Tareas del calendario</span></p>")), style = "margin-left: 10px"),
                fluidRow(id = "inline", align = "center",
                         column(3, selectInput("estado_sel_task", "Acción", choices = acciones$accion)),
                         column(3, dateInput("estado_date_task", "Fecha", language = "es", value = "")),
                         column(3, textAreaInput("estado_text_task", "Más detalles")),
                         column(3, align = "center", style = "margin-top: 25px;",
                                div(id = "bttn_modal",
                                    actionButton("estado_new_task_ok", "Guardar")
                                ),
                                materialSwitch("repetir_task_check", "Repetir acción", status = "info"),
                                uiOutput("repetir_task_ui")
                         )
                )
      ),
      fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                            border-radius: 10px; background-color: white; padding: 10px; margin: 0px;
                            margin-bottom: 10px",
                h4(HTML(paste0("<p><span style='color: ", main_color, "'>Registro de actividades</span></p>")), style = "margin-left: 10px"),
                br(),
                div(id = "inline", style = "margin-left: 20px",
                    div(class = "btn-group", textAreaInput("estado_last_call_obs", "Nuevo registro")),
                    div(class = "btn-group", id = "bttn_modal",
                        actionButton("estado_last_call_ok", "Guardar"))
                ),
                dataTableOutput("table_llamadas")
      ),
      
      if(isolate(clientes_on()) == 1 && !is.null(vars$list_inmuebles_vinc) && nrow(vars$list_inmuebles_vinc) != 0){
        
        isolate({
          
          open_scroll_1$boxes = list()
          open_scroll_1$obs_open_scroll = list()
          open_scroll_1$obs_new_comentario = list()
          vars$n_scroll_1 <- 0
          vars$list_scroll_1 <- data.frame()
          
          vars$scroll_per_page_1 <- scroll_per_page
          vars$n_scroll_1 <- nrow(vars$list_inmuebles_vinc)
          if(vars$n_scroll_1 != 0){
            if(vars$n_scroll_1 > all_scroll){
              vars$all_scroll_1 <- vars$list_inmuebles_vinc[1:all_scroll,]
            }else{
              vars$all_scroll_1 <- vars$list_inmuebles_vinc
            }
            if(vars$n_scroll_1 <= scroll_per_page){
              vars$from_1 <- 1
              vars$to_1 <- vars$n_scroll_1
              vars$list_scroll_1 <- vars$all_scroll_1
              vars$loaded_scroll_1 <- vars$n_scroll_1
            }else{
              vars$from_1 <- 1   
              vars$to_1 <- scroll_per_page
              vars$list_scroll_1 <- vars$all_scroll_1[vars$from_1:vars$to_1,]
              vars$loaded_scroll_1 <- scroll_per_page
            }
          }else{
            vars$loaded_scroll_1 <- 0
          }
        })
        
        div(style = "background: #ffffff; border-style: solid; border-width: 1px; border-color: #aaaaaa; border-radius: 10px; padding: 20 px",
            div(uiOutput("boxes_with_scroll_ui_1"), align = "center"),
            br(),
            div(uiOutput("bttn_prox_scroll_1"), align = "center"),
            br()
        )
      },
      tags$div(id="bttn_modal", 
               br(),
               actionBttn("close_form_clien", "OK"),
               align = "center"),
    )
  })
  
  observeEvent(input$close_form_clien, {
    isolate({
      if(vars$change_cliente == TRUE){
        vars$clientes_all[vars$clientes_all$id == vars$cliente$id,] <- vars$cliente
      }
    })
    vars$change_cliente <- FALSE
    edit_clien_on(0)
    removeModal()
  })
  
  observeEvent(input$close_formulario_edit, {
    edit_clien_on(1)
    modal_clien_description()
  })
  
  output$formulario_clien_new <- renderUI({
    div(
      tags$div(id = "inline",
               fluidRow(
                 column(6, 
                        div(
                          uiOutput("file_input_cliente"),
                          div(id = "inline", actionButton("avatar_choose", "Elegir avatar"), align = "center", 
                              style = "padding:0px; margin: 0px", class = "btn-group"),
                          div(class = "btn-group", actionButton("nada", NULL, style = 'background-color: transparent;
                                                 border: 0px; width:40px; height: 40px; 
                                                 background-image: url("https://place-storage.nyc3.digitaloceanspaces.com/avatar-users/cartoon/avatar28.png");
                                                 background-size: cover, 40px 40px;',
                                                                onclick = 'Shiny.setInputValue(\"avatar_choose\", this.id, {priority: \"event\"})',)
                          ),
                          div(class = "btn-group", actionButton("nada", NULL, style = 'background-color: transparent;
                                                 border: 0px; width:40px; height: 40px; 
                                                 background-image: url("https://place-storage.nyc3.digitaloceanspaces.com/avatar-users/cartoon/avatar12.png");
                                                 background-size: cover, 40px 40px;',
                                                                onclick = 'Shiny.setInputValue(\"avatar_choose\", this.id, {priority: \"event\"})',)
                          ), align = "center"
                        ),
                 ),
                 column(6,
                        selectInput("cliente_tipo", NULL, choices = c("Cliente", "Asesor Externo")),
                        textInput("cliente_name", "Nombre y Apellido"),
                        textInput("cliente_mail", "Correo electrónico"),
                        fluidRow(
                          column(7, selectInput("phone_code", "País", choices = phone_codes$name), style = "padding-right: 0px"),
                          column(5, textInput("cliente_phone", "Teléfono"), style = "padding-left: 0px")
                        ),
                        dateInput("cliente_birthday", "Fecha de nacimiento", language = "es", value = ""),
                        selectInput("cliente_canal", "Canal de contacto", choices = c("Cartel", "Facebook", "Whatsapp", "Colega", "LinkedIn", "Instagram", "Clasipar", "Infocasas", "Portal", "Otro"))
                 )
               ),
               fluidRow(column(12, textAreaInput("cliente_obs", "Primer contacto", width = "100%"))),
               fluidRow(column(6, textInput("cliente_addr", "Dirección")),
                        column(6, textInput("cliente_company", "Compañía"))),
               fluidRow(column(6, textInput("cliente_razon", "Razon social")), 
                        column(6, textInput("cliente_ruc", "RUC"))),
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("cliente_new_ok", "Guardar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center")
    )
  })
  
  observeEvent(input$clientes_new, {
    vars$foto_inmo_file <- NA
    vars$sel_avatar <- NA
    vars$foto_cliente <- NULL
    modal_clien_new()
  })
  
  observeEvent(input$avatar_choose, {
    vars$phone_back <- input$cliente_phone
    vars$code_back <- input$phone_code
    showModal(modalDialog(
      uiOutput("box_avatar_ui"),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("close_avatar", "Cancelar"),
               align = "center"),
      title = "Escoja su avatar",
      easyClose = FALSE,
      footer = NULL,
      size = "l",
      fade = TRUE
    ))
  })
  
  observeEvent(input$close_avatar, {
    updateTextInput(session, "cliente_phone", value = vars$phone_back)
    updateSelectInput(session, "phone_code", selected = vars$code_back)
    print(edit_clien_on())
    if(edit_clien_on() == 1){
      edit_clien_on(1)
      modal_clien_description()
    }else{
      updateSelectInput(session, "cliente_tipo", selected = input$cliente_tipo)
      updateTextInput(session, "cliente_name", value = input$cliente_name)
      updateTextInput(session, "cliente_mail", value = input$cliente_mail)
      updateSelectInput(session, "phone_code", selected = input$phone_code)
      updateTextInput(session, "cliente_phone", value = input$cliente_phone)
      updateDateInput(session, "cliente_birthday", value = ifelse(length(input$cliente_birthday) == 0, "", input$cliente_birthday))
      updateSelectInput(session, "cliente_canal", selected = input$cliente_canal)
      updateTextAreaInput(session, "cliente_obs", value = input$cliente_obs)
      updateTextInput(session, "cliente_addr", value = input$cliente_addr)
      updateTextInput(session, "cliente_company", value = input$cliente_company)
      updateTextInput(session, "cliente_razon", value = input$cliente_razon)
      updateTextInput(session, "cliente_ruc", value = input$cliente_ruc)
      modal_clien_new()
    }
  })
  
  obs_gal_avatar <- list()
  
  output$box_avatar_ui <- renderUI({
    #https://place-storage.nyc3.digitaloceanspaces.com/avatar-users/cartoon/avatar01.png
    list <- list_spaces_do(prefix = paste0("avatar-users/cartoon/avatar"), delimiter = "-")
    all_avatars <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", list$Key)
    
    boxes_avatar <- as.list(1:length(all_avatars))
    boxes_avatar <- lapply(boxes_avatar, function(i){
      btOpenAva <- paste0("open_ava_button", i) 
      avatar <- all_avatars[i]
      obs_gal_avatar[[btOpenAva]] <<- observeEvent(input[[btOpenAva]], ignoreNULL = TRUE, ignoreInit = TRUE, {
        freezeReactiveValue(input, btOpenAva)
        vars$foto_cliente <- dataURI(file = all_avatars[i])
        vars$sel_avatar <- all_avatars[i]
        updateTextInput(session, "cliente_phone", value = vars$phone_back)
        updateSelectInput(session, "phone_code", selected = vars$code_back)
        if(edit_clien_on() == 1){
          update_var_table_mysql(all_avatars[i], "img", "id", vars$cliente$id, paste0(co, "_clientes"))
          vars$clientes_all_pages <- list_table_var_mysql(paste0(co, "_clientes"), "user", vars$user$user)
          removeModal()
        }else{      
          updateSelectInput(session, "cliente_tipo", selected = input$cliente_tipo)
          updateTextInput(session, "cliente_name", value = input$cliente_name)
          updateTextInput(session, "cliente_mail", value = input$cliente_mail)
          updateSelectInput(session, "phone_code", selected = input$phone_code)
          updateTextInput(session, "cliente_phone", value = input$cliente_phone)
          updateDateInput(session, "cliente_birthday", value = ifelse(length(input$cliente_birthday) == 0, "", input$cliente_birthday))
          updateSelectInput(session, "cliente_canal", selected = input$cliente_canal)
          updateTextAreaInput(session, "cliente_obs", value = input$cliente_obs)
          updateTextInput(session, "cliente_addr", value = input$cliente_addr)
          updateTextInput(session, "cliente_company", value = input$cliente_company)
          updateTextInput(session, "cliente_razon", value = input$cliente_razon)
          updateTextInput(session, "cliente_ruc", value = input$cliente_ruc)
          modal_clien_new()
        }
      })
      
      div(style = "padding: 10px; display:inline-block",
          actionButton(btOpenAva, NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width: 120px; height: 120px; 
                                                             background-image: url("', avatar, '");
                                                             background-size: cover, 120px 120px;'))
      )
    })
  })
  
  observeEvent(input$vincular_clien_inmo, {
    vars$cliente_vinc <- NULL
    vars$clientes_all <- list_table_var_mysql(paste0(co, "_clientes"), "user", vars$user$user)
    output$list_clientes_inmo <- renderDataTable({
      create_tablas(vars$clientes_all, vars = c("img", "name", "phone"), corte_fecha = "month", 
                    rem_geometry = FALSE, color = main_color)
    })
    showModal(modalDialog(
      div(style = "background: #ffffff; border-style: solid; border-width: 2px; border-color: white; border-radius: 10px; padding: 20 px",
          div(id = "inline", actionButton("clientes_new", "Nuevo cliente", icon = icon("plus"))),
          dataTableOutput("list_clientes_inmo")
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Selecciona a un cliente de la lista",
      easyClose = FALSE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  observeEvent(input$list_clientes_inmo_rows_selected, {
    vars$cliente_vinc  <- vars$clientes_all[input$list_clientes_inmo_rows_selected,]
    id_clien <- vars$cliente_vinc$id
    print(vars$cliente_vinc$name)
    if(isolate(new_busqueda_on() == 1 | new_inmo_on() == 1)){
      removeModal()
    }else{
      id_inmo <- vars$show_inmo$id
      id_inmo_clien <- vars$show_inmo$cliente
      if(id_inmo_clien == id_clien){
        shinyalert(
          type = "error",
          title = "No puedes elegir al propietario como interesado de su propiedad"
        )
      }else{
        name <- paste0(ifelse(vars$cliente_vinc$tipo == "Cliente", "A tu cliente ", "Al asesor externo "), vars$cliente_vinc$name, " le interesa ", ifelse(vars$show_inmo$venta_alquiler == "Venta", "comprar", "alquilar"),
                       ifelse(vars$show_inmo$tipoPropiedad %in% c("Casa", "Oficina", "Casa quinta", "Propiedad rural"), " una ", " un "), str_to_lower(vars$show_inmo$tipoPropiedad),
                       " en ", vars$show_inmo$ciudad)
        new_estado <- data.frame(
          id = new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12),
          fecha = as.character(now("America/Asuncion")),
          user = vars$user$user,
          name = name,
          id_inmo = vars$show_inmo$id,
          id_clien = vars$cliente_vinc$id,
          nivel_cliente = NA,
          estado_cliente = NA,
          accion = NA,
          fecha_prox_contacto = as.character(as_date(now("America/Asuncion"))),
          tipo_cliente = "colocacion",
          presupuesto = NA,
          urgente = "no",
          importante = "no",
          fase = "1",
          comment = NA
        )
        save_mysql(new_estado, paste0(co, "_estados"), FALSE)
        
        
        new_llamada <- data.frame(
          id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
          fecha = as.character(now("America/Asuncion")),
          fecha_agendada = NA,
          user = vars$user$user,
          id_inmo = vars$show_inmo$id,
          id_clien = id_clien,
          id_estado = new_estado$id,
          accion = "Nuevo interesado",
          realizado = NA,
          agendado = "no",
          time = NA,
          visto = "no",
          comment = ifelse(vars$show_inmo$user == vars$user$user, 
                           paste0(ifelse(vars$cliente_vinc$tipo == "Cliente", "A tu cliente ", "Al asesor externo "), vars$cliente_vinc$name,  " le interesa tu propiedad"), 
                           paste0("A tu cliente ", vars$cliente_vinc$name,  " le interesa la propiedad de otro asesor "))
        )
        save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
        
        estado_capta <- list_table_var1_var2_var3_mysql(paste0(co, "_estados"), "user", vars$show_inmo$user, "id_inmo", vars$show_inmo$id, "id_clien", "IN", vars$show_inmo$cliente)
        new_llamada <- data.frame(
          id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
          fecha = as.character(now("America/Asuncion")),
          fecha_agendada = NA,
          user = vars$show_inmo$user,
          id_inmo = vars$show_inmo$id,
          id_clien = vars$show_inmo$cliente,
          id_estado = estado_capta$id,
          accion = "Nuevo interesado",
          realizado = NA,
          agendado = "no",
          time = NA,
          visto = "no",
          comment = ifelse(vars$show_inmo$user == vars$user$user, 
                           paste0(ifelse(vars$cliente_vinc$tipo == "Cliente", "A tu cliente ", "Al asesor externo "), vars$cliente_vinc$name,  " le interesa tu propiedad"), 
                           paste0("El asesor ", vars$user$name, " ha dado seguimiento a tu propiedad"))
        )
        save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
        
        if(vars$show_inmo$user != vars$user$user){
          
          name <- paste0("El asesor ", vars$user$name, " tiene un interesado en ", ifelse(vars$show_inmo$venta_alquiler == "Venta", "comprar", "alquilar"),
                         ifelse(vars$show_inmo$tipoPropiedad %in% c("Casa", "Oficina", "Casa quinta", "Propiedad rural"), " una ", " un "), str_to_lower(vars$show_inmo$tipoPropiedad),
                         " en ", vars$show_inmo$ciudad)
          
          new_estado <- data.frame(
            id = new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12),
            fecha = as.character(now("America/Asuncion")),
            user = vars$show_inmo$user,
            name = name,
            id_inmo = vars$show_inmo$id,
            id_clien = vars$user$user,
            nivel_cliente = NA,
            estado_cliente = NA,
            accion = NA,
            fecha_prox_contacto = as.character(as_date(now("America/Asuncion"))),
            tipo_cliente = "colocacion",
            presupuesto = NA,
            urgente = "no",
            importante = "no",
            fase = "1",
            comment = NA
          )
          save_mysql(new_estado, paste0(co, "_estados"), FALSE)
          
          new_llamada <- data.frame(
            id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
            fecha = as.character(now("America/Asuncion")),
            fecha_agendada = NA,
            user = vars$show_inmo$user,
            id_inmo = vars$show_inmo$id,
            id_clien = vars$user$user,
            id_estado = new_estado$id,
            accion = "Nuevo interesado",
            realizado = NA,
            agendado = "no",
            time = NA,
            visto = "no",
            comment = paste0("El asesor ", vars$user$name, " se ha interesado en tu propiedad")
          )
          save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
          
          new_alarma <- data.frame(
            id = new_id_table_mysql("id", paste0(co, "_alarmas"), "alarma_", 12),
            fecha = as.character(as_date(now("America/Asuncion"))),
            time = as.character(now("America/Asuncion")),
            user = vars$user$user,
            destino = vars$show_inmo$user,
            id_inmo = vars$show_inmo$id,
            id_clien = NA,
            id_estado = NA,
            id_busq = NA,
            id_noticia = NA,
            id_calificacion = NA,
            tipo = "Nuevo interesado",
            visto = "no",
            img = vars$show_inmo$img,
            comment = paste0("El asesor ", vars$user$name, " se ha interesado en tu propiedad")
          )
          save_mysql(new_alarma, paste0(co, "_alarmas"), FALSE)
          
          
          destino <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", vars$show_inmo$user)
          
          link_coinci <- tryCatch({
            file_name <- paste0(co, "/inmo-web/", vars$show_inmo$id, ".html")
            file <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", file_name)
            link <- list_spaces_do(prefix = file_name)
            vars$show_inmo$link <- file
            print("En digitalocean")
            print(link)
            
            if(nrow(link) == 0){
              
              if(vars$show_inmo$tipoPropiedad == "Proyecto"){
                tipologias <- list_table_var_mysql("myplace_tipologias", "id", vars$show_inmo$id)
              }else{
                tipologias <- NA
              }
              
              params <- list(inmo = vars$show_inmo, agente = destino, tipologias = tipologias, info = TRUE)
              #save(params, file = "params.rda")
              
              tempReport <- file.path(dir, paste0(session$token, "report_inmo_html.Rmd"))
              tempHTML <- file.path(dir, paste0(session$token, "temp_inmo_web.html"))
              file.copy("report_inmo_html.Rmd", tempReport, overwrite = TRUE)
              
              rmarkdown::render(tempReport, 
                                output_file = tempHTML,
                                params = params,
                                envir = new.env(parent = globalenv()))
              
              put_object_do(paste0("/", file_name), tempHTML)
              
              update_var_table_mysql(file, "link", "id", vars$show_inmo$id, "myplace_inmuebles")
            }
            "listo"},
            error = function(e){NA}
          )
          print("link coinci error")
          print(link_coinci)
          
          
          POST(url = "https://graph.facebook.com/v13.0/100461746150331/messages",
               add_headers(.headers = c("Content-Type"="application/json", "Authorization"="Bearer EAAL4VE6rm3IBACclVKbpaA9WL24AwDE9fZB7UEZAfd9Qx0w0hzdGLXZCk1wYBT9Ru5ln9KAqNG5d3RF5ATEHgHsa1Q0xCBgBev9rFSP82IvyW0ZCRnm4npKP0Vo3E7j2ClHcwNbjCZAZAanIlFZAEWVy7EzE9C2no6zF7COZBMLNO9M2S2LGwCUw71ZAN7pTal8BSOjXcDLdiDgZDZD")),
               encode = 'raw',
               body = paste0('{
                                              "messaging_product": "whatsapp",
                                              "recipient_type": "individual",
                                              "to": "', str_remove(destino$phone, "\\+"), '",
                                              "type": "template",
                                              "template": {
                                                "name": "nuevo_interesado",
                                                "language": {
                                                  "code": "en_US"
                                                },
                                                "components": [
                                                  {
                                                    "type" : "header",
                                                    "parameters": [
                                                      {
                                                        "type": "image",
                                                        "image": {
                                                          "link": "', vars$show_inmo$img, '"
                                                        }
                                                      }
                                                    ]
                                                  },
                                                  {
                                                    "type" : "body",
                                                    "parameters": [
                                                      {
                                                          "type": "text",
                                                          "text": "', vars$user$name, '"
                                                      },
                                                      {
                                                          "type": "text",
                                                          "text": "', vars$user$phone, '"
                                                      },
                                                      {
                                                          "type": "text",
                                                          "text": "', vars$show_inmo$link, '"
                                                      }
                                                    ] 
                                                  }
                                                ]
                                              }
                                            }')
          )
        }
        
        if(show_inmo_on() == 1){
          clien <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", id_inmo) %>%
            select(id = id_clien, tipo_clien = tipo_cliente)
          clien$tipo_clien <- ifelse(clien$tipo_clien == "colocacion", "interesado", "vendedor")
          if(vars$show_inmo$user != vars$user$user){
            clien_tercero <- data.frame(id = vars$show_inmo$user, tipo_clien = "captador")
            clien <- rbind(clien_tercero, clien)
          }
          if(nrow(clien) != 0){
            vars$list_clientes_vinc <- clien
          }else{
            vars$list_clientes_vinc <- data.frame()
          }
          modal_inmo_description()
        }else{
          removeModal()
        }
      }
    }
  })
  
  observeEvent(input$seguir_inmo, {
    inmo <- vars$show_inmo
    
    new_seguida <- data.frame(
      id = new_id_table_mysql("id", paste0(co, "_seguidas"), "seguida_", 12),
      user = vars$user$user,
      fecha = as.character(now("America/Asuncion")),
      id_inmo = vars$show_inmo$id
    )
    save_mysql(new_seguida, paste0(co, "_seguidas"), FALSE)
    removeModal()
  })
  
  observeEvent(input$dejar_seguir_inmo, {
    showModal(modalDialog(
      h4("¿Está seguro de querer dejar de seguir esta propiedad?"),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("dejar_seguir_inmo_ok", "Dejar de seguir"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Seguimiento a propiedad",
      easyClose = FALSE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$dejar_seguir_inmo_ok, {
    inmo <- vars$show_inmo
    del_var1_var2_table_mysql("user", vars$user$user, "id_inmo", inmo$id, paste0(co, "_seguidas"))
    if(inmo_input_on() == 1){
      updateSelectInput(session, "inmo_filt_prop_seg", selected = "Activas")
    }
    removeModal()
  })
  
  output$image_cliente <- renderUI({
    if(edit_inmo_on() == 1){
      print("vars$edit_tipo")
      print(isolate(vars$edit_tipo))
      if(nrow(vars$edit_tipo) == 0){
        if(is.null(vars$upload_cliente)){
          im <- image_read("blank_inmo.jpg")
          image_write(im, file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
          vars$foto_cliente <- dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
        }
      }else{
        if(is.null(vars$upload_cliente)){
          im <- image_read(vars$edit_tipo$img)
          image_write(im, file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
          vars$foto_cliente <- dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
        }
      }
      div(
        tags$img(src= vars$foto_cliente, width = "200px"),
        align = "center"
      )
    }else{
      if(is.null(vars$edit_tipo) || nrow(vars$edit_tipo) == 0){
        if(is.null(vars$foto_cliente)){
          div(
            tags$img(src= ifelse(capacitacion_on() == 1 | tipologia_on() == 1, 
                                 "blank_inmo.jpg", "blank_avatar.png"), width = "200px"),
            align = "center"
          )
        }else{
          div(
            tags$img(src= vars$foto_cliente, width = "200px"),
            align = "center"
          )
        }
      }else{
        im <- image_read(vars$edit_tipo$img)
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
        vars$foto_cliente <- dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
        div(
          tags$img(src= vars$foto_cliente, width = "200px"),
          align = "center"
        )
      }
    }
  })
  
  observeEvent(input$cliente_new_ok, {
    if(is.null(isolate(vars$foto_cliente))){
      shinyalert(
        type = "error",
        title = "Debes agregar una foto o un avatar al cliente"
      )
    }else{
      if(input$cliente_phone == ""){
        shinyalert(
          type = "error",
          title = "Debes agregar un celular de contacto"
        )
      }else{
        id <- new_id_table_mysql("id", paste0(co, "_clientes"), "client_", 12)
        new_cliente <- data.frame(
          id = id,
          fecha = as.character(now("America/Asuncion")),
          user = vars$user$user,
          name = input$cliente_name,
          phone = paste0(phone_codes$code[phone_codes$name == input$phone_code], str_remove_all(str_remove(input$cliente_phone, "^0"), " ")),
          mail = input$cliente_mail,
          addr = input$cliente_addr,
          company = input$cliente_company,
          razon = input$cliente_razon,
          ruc = input$cliente_ruc,
          birthday = ifelse(length(input$cliente_birthday) == 0, "", as.character(input$cliente_birthday)),
          img = NA,
          canal = input$cliente_canal,
          comment = input$cliente_obs,
          activo = "si",
          tipo = input$cliente_tipo
        )
        if(!is.null(isolate(vars$foto_cliente))){
          if(!is.na(vars$sel_avatar)){
            new_cliente$img <- vars$sel_avatar
          }else{
            if(!is.null(vars$upload_cliente)){
              
              mask <- image_read("www/mask_cliente.png")
              im <- image_read(file.path(dir, paste0(session$token, "temp_foto_cliente_small.jpg")))
              im <- image_convert(im, format = "png")
              im_round <- image_composite(im, mask, operator='copyopacity')
              image_write(im_round, file.path(dir, paste0(session$token, "temp_foto_cliente_small.png")))
              rand <- str_pad(round(runif(1, min=1, max=999)), 3, pad = "0")
              put_object_do(paste0("/", co, "/fotos-client/", id, "_", rand, "-small.png"), file.path(dir, paste0(session$token, "temp_foto_cliente_small.png")))
              new_cliente$img <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/fotos-client/", id, "_", rand, "-small.png")
            }
            vars$foto_cliente <- NULL
          }
        }
        save_mysql(new_cliente, paste0(co, "_clientes"), FALSE)
        vars$clientes_all <- rbind(vars$clientes_all, new_cliente)
        vars$clientes_all_pages <- vars$clientes_all
        vars$cliente_vinc <- new_cliente
        if(isolate(clientes_on()) == 1){
          vars$data_all_pages <- vars$clientes_all_pages
          vars$page_selected <- 1
          vars$data_per_page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, 1)$data
        }
        if(show_inmo_on() == 1){
          output$list_clientes_inmo <- renderDataTable({
            create_tablas(vars$clientes_all, vars = c("img", "name", "phone"), corte_fecha = "month", 
                          rem_geometry = FALSE, color = main_color)
          })
          showModal(modalDialog(
            div(style = "background: #ffffff; border-style: solid; border-width: 2px; border-color: white; border-radius: 10px; padding: 20 px",
                div(id = "inline", actionButton("clientes_new", "Nuevo cliente", icon = icon("plus"))),
                dataTableOutput("list_clientes_inmo")
            ),
            br(),
            tags$div(id="bttn_modal", 
                     actionBttn("close_modal", "OK"),
                     align = "center"),
            title = "Vincular cliente a inmueble",
            easyClose = FALSE,
            footer = NULL,
            size = "m",
            fade = TRUE
          ))
        }else{
          removeModal()
        }
      }
    }
  })
  
  output$cliente_name_ui_busqueda <- renderUI({
    req(vars$cliente_vinc)
    if(!is.null(vars$cliente_vinc)){
      h4(vars$cliente_vinc$name)
    }else{
      div()
    }
  })
  
  output$cliente_name_ui_inmo <- renderUI({
    req(vars$cliente_vinc)
    if(!is.null(vars$cliente_vinc)){
      h4(vars$cliente_vinc$name)
    }else{
      div()
    }
  })
  
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #clientes
  
  output$box_clien_ui <- renderUI({
    if(clientes_on() == 1){
      fluidPage(
        div(style = "position: sticky; width: 100%; z-index: 5",
            uiOutput("clien_filtros_ui")
        ),
        div(uiOutput("box_clien_list_ui"), align = "center"),
        uiOutput("page_ui"),
        uiOutput("cont_page_ui")
      )
    }else{
      div()
    }
  })   
  
  output$clien_filtros_ui <- renderUI({
    if(clientes_on() == 1){
      fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                br(),
                #h4(HTML(paste0("<p><span style='color: ", main_color, "'>Filtros</span></p>")), width = "100%"),
                tags$div(id = "inline",
                         div(class = "btn-group", style = "margin: 5px; margin-top:10px", actionButton("clientes_new", "Nuevo cliente", icon = icon("plus"))
                         ),
                         div(class = "btn-group", style = "width: 200px; margin: 5px; margin-top: 5px", 
                             selectInput("clien_filt_tipo", "Clientes o Asesores", NULL, choices = c("Todos", "Clientes", "Asesores externos"))
                         ),
                         div(class = "btn-group", style = "width: 200px; margin: 5px; margin-top: 0px", 
                             selectInput("clien_filt_int", "Interés", choices = c("Todos", "Propietarios", "Interesados", "Buscando"))
                         ),
                         div(class = "btn-group", style = "width: 200px; margin: 5px; margin-top: 0px", 
                             selectInput("clien_filt_oper", "Operación", choices = c("Todos", "Venta", "Alquiler"))
                         ),
                         div(class = "btn-group", style = "width: 200px; margin: 5px; margin-top: 0px", 
                             selectInput("clien_filt_prop", "Tipo propiedad", choices = c("Todos", "Casa", "Duplex", "Terreno", "Departamento",
                                                                                          "Casa quinta", "Salón comercial", "Edificio",
                                                                                          "Oficina", "Deposito", "Tinglado"))
                         ),
                         div(class = "btn-group", style = "width: 200px; margin: 5px; margin-top: 0px", 
                             textInput("clien_filt_name", "", value = NULL, placeholder = "buscar")
                         )
                )
      )
    }
  })
  
  observe({
    if(clientes_on() == 1){
      req(input$clien_filt_tipo)
      vars$clientes_all_pages <- data.frame()
      
      all_pages <- vars$clientes_all
      
      estados <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_clien", vars$clientes_all$id)
      est_col <- estados[estados$tipo_cliente %in% c("colocacion"), ]
      est_cap <- estados[estados$tipo_cliente %in% c("captacion"), ]
      est_bus <- estados[estados$tipo_cliente %in% c("busquedas"), ]
      inmo_bus_col <- list_table_var_mysql("myplace_inmuebles", "id", est_col$id_inmo) %>% 
        select(id, venta_alquiler, tipoPropiedad, cliente)
      inmo_bus_col$geometry <- NULL
      if(nrow(inmo_bus_col) != 0)
        inmo_bus_col$tipo <- "Interesados"
      inmo_bus_cap <- list_table_var_mysql("myplace_inmuebles", "id", est_cap$id_inmo) %>% 
        select(id, venta_alquiler, tipoPropiedad, cliente)
      inmo_bus_cap$geometry <- NULL
      if(nrow(inmo_bus_cap) != 0)
        inmo_bus_cap$tipo <- "Propietarios"
      inmo_bus_bus <- list_table_var1_var2_mysql("myplace_busquedas", "id", est_bus$id_inmo, "activo", "si") %>% 
        select(id, venta_alquiler, tipoPropiedad, cliente)
      inmo_bus_bus$geometry <- NULL
      if(nrow(inmo_bus_bus) != 0)
        inmo_bus_bus$tipo <- "Buscando"
      inmo_bus <- rbind(inmo_bus_col, inmo_bus_cap, inmo_bus_bus) %>% drop_na()
      
      
      if(input$clien_filt_tipo != "Todos"){
        if(input$clien_filt_tipo == "Clientes"){
          all_pages <- all_pages %>% filter(tipo == "Cliente")
        }else{
          all_pages <- all_pages %>% filter(tipo != "Cliente")
        }
      }
      if(input$clien_filt_int != "Todos"){
        sel <- inmo_bus$cliente[inmo_bus$tipo == input$clien_filt_int] %>% unique()
        all_pages <- all_pages[all_pages$id %in% sel,]
      }
      if(input$clien_filt_oper != "Todos"){
        sel <- inmo_bus$cliente[inmo_bus$venta_alquiler == input$clien_filt_oper] %>% unique()
        all_pages <- all_pages[all_pages$id %in% sel,]
      }
      if(input$clien_filt_prop != "Todos"){
        sel <- inmo_bus$cliente[inmo_bus$tipoPropiedad == input$clien_filt_prop] %>% unique()
        all_pages <- all_pages[all_pages$id %in% sel,]
      }
      
      if(!is.null(input$clien_filt_name)){
        isolate({
          if(input$clien_filt_name != ""){
            palabras <- str_split(input$clien_filt_name, " ")[[1]]
            palabras <- palabras[palabras != ""]
            print(palabras)
            busc <- c()
            for(i in 1:length(palabras)){
              busc <- c(busc, str_detect(str_to_lower(all_pages$name), str_to_lower(palabras[i])))
            }
            m <- matrix(busc, nrow(all_pages), length(palabras))*1
            print(m)
            ind <- which(apply(m, 1, prod) == 1)
            if(length(ind) != 0){
              print(ind)
              all_pages <- all_pages[ind,]
            }
          }              
        })
      }
      print("all_pages")
      print(nrow(all_pages))
      open_clien$boxes<- list()
      open_clien$observers <- list()
      vars$clientes_all_pages <- all_pages
      vars$data_all_pages <- vars$clientes_all_pages
      vars$page_selected <- 1
      vars$data_per_page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, 1)$data
    }
  })
  
  open_clien = reactiveValues(boxes = list(), observers = list())
  
  observe({
    if(clientes_on() == 1){
      req(vars$data_per_page)
      print("vars$data_per_page clien")
      #if(nrow(vars$data_per_page) != 0 && str_detect(vars$data_per_page$id[1], "client")){
      if(nrow(vars$data_per_page) != 0){
        for(i in 1:nrow(vars$data_per_page)){
          
          clien <- vars$data_per_page[i,]
          print("clientes")
          print(i)
          print(clien)
          if(nrow(clien) != 0){
            open_clien$boxes[[i]] <- div(style = "padding: 10px; display:inline-block", align = "left",
                                         div(
                                           div(style = paste0("border-style: solid; border-width: 1px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: ", ifelse(clien$tipo == "Cliente", "white", main_color), "; width: 242px; height: 102px;
                                 margin: 0px; padding: 0px"),
                                               div(style = "width: 125px; height: 50px; position: absolute; margin-top 10px; margin-left: 110px", 
                                                   h4(clien$name, style = paste0("font-size: 140%; font-weight: normal; color: ", ifelse(clien$tipo == "Cliente", "#888888", "white"), "; height: 50px")),
                                                   if(clien$mail != ""){
                                                     div(class = "btn-group", style = "vertical-align: bottom",
                                                         a(href= paste0("mailto:", clien$mail), target="_blank", 
                                                           actionButton("nada", "" , icon = icon("envelope"), style = paste0("font-size: 140%; padding: 0px; background-color: transparent; border-color: transparent; color: ",
                                                                                                                             ifelse(clien$tipo == "Cliente", "black", "white"))))
                                                     )
                                                   },
                                                   if(!is.na(clien$phone)){
                                                     text_wp <- paste0("https://wa.me/", clien$phone, "?text=", "")
                                                     div(class = "btn-group",
                                                         a(href= text_wp, target="_blank", 
                                                           actionButton("nada", NULL , icon = icon("whatsapp"), style = paste0("font-size: 140%; padding: 0px; padding-left: 5px; background-color: transparent; border-color: transparent; color: ",
                                                                                                                               ifelse(clien$tipo == "Cliente", "black", "white"))))
                                                     )
                                                   },
                                                   if(!is.null(clien$tipo_clien)){ 
                                                     div(class = "btn-group",
                                                         h4(clien$tipo_clien, style = paste0("font-size: 90%; font-weight: light; color: ", ifelse(clien$tipo == "Cliente", "#555555", "white"), "; height: 10px; padding-left: 5px"))
                                                     )
                                                   }
                                               ),
                                               div(actionButton(paste0("open_clien_button", i) , NULL, style = paste0('background-color: transparent;
                                                                                                                  border: 0px; width:100px; height: 100px; margin: 0px;',
                                                                                                                      ifelse(is.na(clien$img), paste0('background-image: url("blank_avatar.png");
                                                                                                                  background-size: cover, 80px 80px;'),
                                                                                                                             paste0('background-image: url("', clien$img, '");
                                                                                                                  background-size: cover, 100px 100px;')),
                                                                                                                      'border-radius: 8px 0px 0px 8px')),
                                               )
                                           )
                                         )
            )
          }
        }
        if(nrow(vars$data_per_page) < vars$n_per_page){
          for(j in (nrow(vars$data_per_page) + 1):vars$n_per_page){
            open_clien$boxes[[j]] <- div()
          }
        }
        
        open_clien$observers <- lapply(1:nrow(vars$data_per_page), function(i){
          observeEvent(input[[paste0("open_clien_button", i) ]], ignoreNULL = TRUE, ignoreInit = TRUE, {
            freezeReactiveValue(input, paste0("open_clien_button", i))
            vars$cliente <- vars$data_per_page[i,]
            clien <- vars$cliente
            if(nrow(clien) != 0){
              inmo_vinc <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_clien", clien$id) %>%
                select(id_inmo = id_inmo, tipo_clien = tipo_cliente)
              inmo_vinc$tipo_clien <- ifelse(str_detect(inmo_vinc$id_inmo, "busqueda"), inmo_vinc$tipo_clien, ifelse(inmo_vinc$tipo_clien == "colocacion", "interesado", "vendedor"))
              
              vars$list_inmuebles_vinc <- inmo_vinc %>% arrange(tipo_clien)
              
              vars$foto_inmo_file <- NA
              vars$foto_cliente <- vars$cliente$img
              show_clien_on(1)
              edit_clien_on(1)
              modal_clien_description()
            }
          })
        })
      }else{
        open_clien$boxes <- div()
      }
    }
  })
  
  output$box_clien_list_ui <- renderUI({
    if(clientes_on() == 1){
      do.call(fluidRow, open_clien$boxes)
    }
  })
  
  obs_open_clien_vinc <- list()
  
  observe({
    if(show_inmo_on() == 1){
      if(nrow(vars$list_clientes_vinc) > 0){
        print("vars$list_clientes_vinc")
        print(vars$list_clientes_vinc)
        output$box_clien_vinc_list_ui <- renderUI({
          boxes_clien_vinc <- as.list(1:nrow(vars$list_clientes_vinc))
          boxes_clien_vinc <- lapply(boxes_clien_vinc, function(i){
            btOpenClienVinc <- paste0("open_clien_button", i)
            clien_simple <- vars$list_clientes_vinc[i,]
            print("clien_simple")
            print(clien_simple)
            if(str_detect(clien_simple$id, "@")){
              clien <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", clien_simple$id)
              clien <- clien %>% select(id = user, name = name, phone = phone, mail = user, img = img)
              tipo <- "agente"
            }else{
              clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", clien_simple$id)
              tipo <- "cliente"
            }
            clien <- left_join(clien, clien_simple, by = c("id" = "id"))
            
            obs_open_clien_vinc[[btOpenClienVinc]] <<- observeEvent(input[[btOpenClienVinc]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btOpenClienVinc)
              clien_simple <- vars$list_clientes_vinc[i,]
              if(!str_detect(clien_simple$id, "@")){
                clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", clien_simple$id)
                clien <- left_join(clien, clien_simple, by = c("id" = "id"))
                vars$cliente <- clien
                print("cliente vinculado")
                print(clien$name)
                
                inmo_vinc <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_clien", clien$id) %>%
                  select(id_inmo = id_inmo, tipo_clien = tipo_cliente)
                inmo_vinc$tipo_clien <- ifelse(str_detect(inmo_vinc$id_inmo, "busqueda"), inmo_vinc$tipo_clien, ifelse(inmo_vinc$tipo_clien == "colocacion", "interesado", "vendedor"))
                
                vars$list_inmuebles_vinc <- inmo_vinc %>% arrange(tipo_clien)
                
                vars$show_estado <- list_table_var1_var2_var3_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_clien", clien$id, "id_inmo", "IN", vars$show_inmo$id)
                
                vars$foto_inmo_file <- NA
                vars$foto_cliente <- vars$cliente$img
                show_inmo_on(0)
                show_clien_on(1)
                edit_clien_on(1)
                modal_clien_description()
              }
            })
            
            div(style = "padding: 10px; display:inline-block", align = "left",
                div(
                  div(style = paste0("border-style: solid; border-width: 1px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: ", ifelse(clien$tipo_clien == "vendedor", main_color, ifelse(tipo == "agente", "#dadada", "white")), "; width: 242px; height: 102px;
                                 margin: 0px; padding: 0px; color: ", ifelse(clien$tipo_clien == "vendedor", "white", ifelse(tipo == "agente", "#444444", "#777777"))),
                      div(style = "width: 125px; height: 50px; position: absolute; margin-top 10px; margin-left: 110px", 
                          h4(clien$name, style = 'font-size: 140%; font-weight: normal;  height: 50px'),
                          if(clien$mail != ""){
                            div(class = "btn-group", style = "vertical-align: bottom",
                                a(href= paste0("mailto:", clien$mail), target="_blank", 
                                  actionButton("nada", "" , icon = icon("envelope"), style = paste0("font-size: 140%; padding: 0px; background-color: transparent; 
                                border-color: transparent; color: ", ifelse(clien$tipo_clien == "vendedor", "white", ifelse(tipo == "agente", "#444444", "#777777")))))
                            )
                          },
                          if(!is.na(clien$phone)){
                            text_wp <- paste0("https://wa.me/", clien$phone, "?text=", "")
                            div(class = "btn-group",
                                a(href= text_wp, target="_blank", 
                                  actionButton("nada", NULL , icon = icon("whatsapp"), style = paste0("font-size: 140%; padding: 0px; padding-left: 5px; background-color: transparent; 
                                               border-color: transparent; color: ", ifelse(clien$tipo_clien == "vendedor", "white", ifelse(tipo == "agente", "#444444", "#777777")))))
                            )
                          },
                          if(!is.null(clien$tipo_clien)){ 
                            div(class = "btn-group",
                                h4(clien$tipo_clien, style = 'font-size: 90%; font-weight: light; height: 10px; padding-left: 5px')
                            )
                          }
                      ),
                      div(actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                                                                                  border: 0px; width:100px; height: 100px; margin: 0px;',
                                                                    ifelse(is.na(clien$img), paste0('background-image: url("blank_avatar.png");
                                                                                                                  background-size: cover, 80px 80px;'),
                                                                           paste0('background-image: url("', clien$img, '");
                                                                                                                  background-size: cover, 100px 100px;')),
                                                                    'border-radius: 8px 0px 0px 8px'),
                                       onclick = paste0('Shiny.setInputValue(\"', btOpenClienVinc, '\", this.id, {priority: \"event\"})')),
                      )
                  )
                )
            )
          })
        })
      }else{
        output$box_clien_vinc_list_ui <- renderUI({
          div()
        })
      }
    }else{
      output$box_clien_vinc_list_ui <- renderUI({
        div()
      })
    }
  })
  
  
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #mis propiedades
  
  output$inmo_filtros_ui <- renderUI({
    if(inmo_input_on() == 1){
      fluidRow(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; margin-left: 0px; margin-right: 0px"),
               #h4(HTML(paste0("<p><span style='color: ", main_color, "'>Filtros</span></p>")), width = "100%"),
               column(10, tags$div(id = "inline", class = "btn-group",
                                   div(style = "width: 110px; margin: 5px", class = "btn-group",
                                       selectInput("inmo_filt_trans", "Transacción", 
                                                   choices = c("Todos", "Venta", "Alquiler", "Alquiler temporal"))),
                                   div(style = "width: 110px; margin: 5px", class = "btn-group",
                                       selectInput("inmo_filt_tipo", "Tipo propiedad",
                                                   choices = c("Todos", "Terreno", "Casa", "Duplex", "Departamento", "Proyecto", "Deposito", "Tinglado", "Oficina", "Salón comercial",
                                                               "Propiedad rural", "Casa quinta", "Edificio"))),
                                   div(style = "width: 110px; margin: 5px", class = "btn-group",
                                       selectInput("inmo_filt_prop_seg", "Estado",
                                                   choices = c("Activas", "Seguidas", "Externas", "Cierres", "Inactivas", "Vencidas"))),
                                   div(style = "width: 80px; margin: 5px", class = "btn-group",
                                       numericInput3("inmo_filt_codigo", "Código", value = NULL))
               )
               ),
               column(2, uiOutput("contador_prop_mias_ui"), align = "right")
      )
    }
  })
  
  output$new_inmo_link_ui <- renderUI({
    if(inmo_input_on() == 1 & vars$user$user == "chaseinmuebles@gmail.com"){
      print("Delfi Chase se conecto")
      div(
        br(),
        fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; margin-left: 0px;
                                 padding: 10px"),
                  div(id = "inline",
                      div(class = "btn-group",
                          actionButton("nada", "Vincular propietario", icon = icon("link"),
                                       onclick = 'Shiny.setInputValue(\"vincular_clien_chase\", this.id, {priority: \"event\"})',)),
                      div(class = "btn-group", style = "padding-left: 20px", uiOutput("cliente_name_ui_chase")),
                  ),
                  br(),
                  uiOutput("new_inmo_link_campo_ui")
        )
      )
    }else{
      div()
    }
  })
  
  output$cliente_name_ui_chase <- renderUI({
    req(vars$cliente_vinc_chase)
    if(!is.na(vars$cliente_vinc_chase)){
      h4(vars$cliente_vinc_chase$name)
    }else{
      div()
    }
  })
  
  observeEvent(input$vincular_clien_chase, {
    vars$cliente_vinc_chase <- NA
    vars$clientes_all <- list_table_var_mysql(paste0(co, "_clientes"), "user", vars$user$user)
    output$list_clientes_chase <- renderDataTable({
      create_tablas(vars$clientes_all, vars = c("img", "name", "phone"), corte_fecha = "month", 
                    rem_geometry = FALSE, color = main_color)
    })
    showModal(modalDialog(
      div(style = "background: #ffffff; border-style: solid; border-width: 2px; border-color: white; border-radius: 10px; padding: 20 px",
          div(id = "inline", actionButton("clientes_new", "Nuevo cliente", icon = icon("plus"))),
          dataTableOutput("list_clientes_chase")
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Selecciona a un cliente de la lista",
      easyClose = FALSE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  observeEvent(input$list_clientes_chase_rows_selected, {
    vars$cliente_vinc_chase  <- vars$clientes_all[input$list_clientes_chase_rows_selected,]
    print(vars$cliente_vinc_chase$name)
    removeModal()
  })
  
  output$new_inmo_link_campo_ui <- renderUI({
    req(vars$cliente_vinc_chase)
    if(!is.na(vars$cliente_vinc_chase)){
      div(
        div(class = "btn-group",
            div(id = "inline", textInput("new_inmo_link", "Copia aquí el link de tu propiedad"))
        ),
        div(class = "btn-group", id = "bttn_modal",
            actionButton("new_inmo_link_ok", "Cargar")
        )
      )
    }
  })
  
  observeEvent(input$new_inmo_link_ok, {
    print("empieza link ok")
    print(input$new_inmo_link)
    inmo <- xintel_delfi_to_place(input$new_inmo_link)
    if(inmo$error){
      shinyalert(
        type = "error",
        title = "Ha ocurrido un error en la carga con esta propiedad."
      )
    }else{
      galeria <- inmo$fotos
      if(length(galeria) > 15){
        galeria <- galeria[1:15]
      }
      
      cliente <- isolate(vars$cliente_vinc_chase)
      
      new_inmo <- inmo$inmo
      new_inmo$cliente <- cliente$id
      new_inmo$user <- vars$user$user
      lat <- new_inmo$lat
      lon <- new_inmo$lon
      
      id <- new_id_myplace_mysql("myplace_inmuebles", co, "inmueble", 10)
      
      rand <- str_pad(round(runif(1, min=1, max=999)), 3, pad = "0")
      img = ifelse(length(galeria) == 0, NA,
                   paste0("https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/", id, "-01", "_", rand, "-small.jpg"))
      file <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/inmo-web/", id, "_", rand, ".html")
      file_name <- paste0(co, "/inmo-web/", id, "_", rand, ".html")
      
      new_inmo$id <- id
      new_inmo$img <- img
      new_inmo <- new_inmo %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
      new_inmo$lat <- lat
      new_inmo$lon <- lon
      
      print("inicio galeria")
      print(galeria)
      
      if(length(galeria) != 0){
        for(i in 1:length(galeria)){
          serie <- str_pad(i, 2, pad = "0")
          name <- paste0(id, "-", serie, "_", rand)
          
          im <- image_read(galeria[i])
          im <- image_orient(im)
          im <- image_convert(im, format = "jpg")
          info <- image_info(im)
          w <- info$width
          h <- info$height
          horiz <- w/h >= 4/3
          im <- image_crop(im, paste0(ifelse(horiz, h*4/3, w), "x", 
                                      ifelse(horiz, h, w*3/4), "+", 
                                      ifelse(horiz, (w - h*4/3)/2, 0), "+",
                                      ifelse(horiz, 0, (h - w*3/4)/2)))
          im <- image_scale(im, "600x")
          image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
          put_object_do(paste0("/fotos-inmo/", name, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
          im <- image_scale(im, "300x")
          image_write(im, file.path(dir, "temp_foto_inmo.jpg"))
          put_object_do(paste0("/fotos-inmo/", name, "-small.jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
          print(paste0("Cargo ", i, " foto"))  
        }
      }
      
      name_estado <- paste0(cliente$name, ifelse(new_inmo$venta_alquiler == "Venta", " vende", " alquila"),
                            ifelse(new_inmo$tipoPropiedad %in% c("Casa", "Oficina", "Propiedad rural", "Casa quinta"), " una ", " un "), str_to_lower(new_inmo$tipoPropiedad),
                            " en ", new_inmo$ciudad)
      id_captacion <- new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12)
      new_estado <- data.frame(
        id = id_captacion,
        fecha = as.character(now("America/Asuncion")),
        user = new_inmo$user,
        name = name_estado,
        id_inmo = new_inmo$id,
        id_clien = cliente$id,
        nivel_cliente = NA,
        estado_cliente = NA,
        accion = NA,
        fecha_prox_contacto = as.character(as_date(now("America/Asuncion"))),
        tipo_cliente = "captacion",
        presupuesto = NA,
        urgente = "no",
        importante = "no",
        fase = ifelse(new_inmo$tipo_contrato == "Sin contrato", "1", "2"),
        comment = NA
      )
      save_mysql(new_estado, paste0(co, "_estados"), FALSE)
      
      save_mysql(new_inmo, "myplace_inmuebles", FALSE)
      
      vars$cliente_vinc_chase <- NA
      vars$inmo_propio_list <- list_table_var1_var2_mysql("myplace_inmuebles", "user", vars$user$user, "company", co)
      refresh_inmo_input(isolate(refresh_inmo_input()) + 1)
    }
  })
  
  output$contador_prop_mias_ui <- renderUI({
    req(vars$data_all_pages)
    if(inmo_input_on() == 1){
      h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                     nrow(vars$data_all_pages), "</span></p>")))
    }
  })
  
  obs_open_inmo <- list()
  
  output$box_inmo_ui <- renderUI({
    if(inmo_input_on() == 1){
      fluidRow(
        column(6,
               div(style = "position: sticky; width: 100%; z-index: 5",
                   uiOutput("inmo_filtros_ui"),
                   uiOutput("new_inmo_link_ui"),
                   br(),
                   uiOutput("box_inmo_map_ui")
               )    
        ),
        column(6,
               div(uiOutput("box_inmo_list_ui"), align = "center"),
               uiOutput("page_ui"),
               uiOutput("cont_page_ui")
        )
      )
    }else{
      div()
    }
  })  
  
  output$box_inmo_map_ui <- renderUI({
    if(inmo_input_on() == 1){
      isolate({
      })
      fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 2px"),
                leafletOutput("map_agenda_inmo", height = "75vh")
      )
    }
  })
  
  observe({
    if(inmo_input_on() == 1 | office_prop_on() == 1 | prop_todas_on() == 1){
      req(vars$data_per_page)
      print("vars$data_per_page inmos")
      if(nrow(vars$data_per_page) > 0){
        output$box_inmo_list_ui <- renderUI({
          boxes <- as.list(1:nrow(vars$data_per_page))
          boxes <- lapply(boxes, function(i){
            inmo <- vars$data_per_page[i,]
            if(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta"){
              inmo$precio_cierre <- round(inmo$precio_cierre/1000000)
              inmo$precio <- round(inmo$precio/1000000)
            }
            btOpenInmo <- paste0("open_inmo_button", i) 
            if(inmo$tipoPropiedad == "Proyecto"){
              tipologias <- list_table_var_mysql("myplace_tipologias", "id", inmo$id)
              if(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta"){
                tipologias$precio <- round(tipologias$precio/1000000)
              }
              precio_min <- format(min(tipologias$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              precio_max <- format(max(tipologias$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              dormitorios_min <- min(ifelse(is.na(as.integer(tipologias$dormitorios)), 1, as.integer(tipologias$dormitorios)))
              dormitorios_max <- max(ifelse(is.na(as.integer(tipologias$dormitorios)), 1, as.integer(tipologias$dormitorios)))
              banios_min <- min(as.integer(tipologias$banios))
              banios_max <- max(as.integer(tipologias$banios))
              m2_cons_min <- format(round(min(tipologias$m2_cons)), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              m2_cons_max <- format(round(max(tipologias$m2_cons)), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              garajes_min <- min(as.integer(tipologias$garajes))
              garajes_max <- max(as.integer(tipologias$garajes))
            }

            btOpenInmo <- paste0("open_inmo_button", i) 
            obs_open_inmo[[btOpenInmo]] <<- observeEvent(input[[btOpenInmo]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btOpenInmo)
              vars$show_inmo <- list_table_var_mysql("myplace_inmuebles", "id", vars$data_per_page$id[i])
              #vars$show_inmo <- vars$data_per_page[i,]
              inmo <- vars$show_inmo
              clien <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", inmo$id) %>%
                select(id = id_clien, tipo_clien = tipo_cliente)
              clien$tipo_clien <- ifelse(clien$tipo_clien == "colocacion", "interesado", "vendedor")
              if(inmo$user != vars$user$user){
                clien_tercero <- data.frame(id = inmo$user, tipo_clien = "captador")
                clien <- rbind(clien_tercero, clien)
              }
              if(nrow(clien) != 0){
                vars$list_clientes_vinc <- clien
              }else{
                vars$list_clientes_vinc <- data.frame()
              }
              modal_inmo_description()
            })
            
            div(style = "padding: 10px; display:inline-block", align = "left",
                div(
                  div(
                    if(inmo$externa == "si"){
                      div(style = paste0("background-color: ", main_color, "; width: 200px; height: 40px; border-radius: 10px; color: white;
                    padding: 0px; padding-top: 5px; position: absolute; margin-top: 70px; margin-left: 20px"), align = "center", 
                          HTML(paste0("<p><span style='font-size: 150%; font-weight: normal'>EXTERNA</span></p>"))
                      )
                    },
                    if(inmo$borrador == "si"){
                      div(style = "background-color: red; width: 30px; height: 30px; border-radius: 15px; color: white;
                    padding: 0px; padding-top: 5px; position: absolute; margin-top: 30px; margin-left: 217px", align = "center", 
                          HTML(paste0("<p><span style='font-size: 120%; font-weight: normal'><i class='fa fa-eraser'></i></span></p>"))
                      )
                    },
                    if(inmo$publicado == "si"){
                      div(style = "background-color: black; width: 30px; height: 30px; border-radius: 15px; color: white;
                    padding: 0px; padding-top: 5px; position: absolute; margin-top: -5px; margin-left: 217px", align = "center", 
                          HTML(paste0("<p><span style='font-size: 120%; font-weight: normal'><i class='fa fa-television'></i></span></p>"))
                      )
                    },
                    if(inmo$precio_cierre != 0){
                      div(style = paste0("background-color: ", main_color, "; width: 200px; height: 40px; border-radius: 10px; color: white;
                    padding: 0px; padding-top: 5px; position: absolute; margin-top: 30px; margin-left: 20px"), align = "center", 
                          HTML(paste0("<p><span style='font-size: 150%; font-weight: normal'>",
                                      ifelse(inmo$venta_alquiler == "Venta", "VENDIDO", "ALQUILADO"), "</span></p>"))
                      )
                    }
                  ),
                  
                  if(str_detect(inmo$id, co)){
                    div(style = "position: absolute; margin-top: 5px; margin-left: 5px",
                        actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:60px; height: 20px; margin: 0px;
                                                             background-image: url("logo_SkyOne_borde_blanco.png");
                                                             background-size: cover, 60px 20px;'))
                    )
                  },
                  div(align = "right", style = "position: absolute; margin-top: 295px; margin-left: 190px;",
                      HTML(paste0("<p><span style='font-size: 90%; font-weight: normal; padding-right: 10px; margin: 0px'>ID: ",
                                  as.integer(str_flatten(str_extract_all(inmo$id, "\\d")[[1]])), "</span></p>"))),
                  div(style = paste0("border-style: solid; border-width: 1px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; width: 242px; height: 315px;
                                 margin: 0px; padding: 0px"),
                      div(actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:240px; height: 180px; margin: 0px;
                                                             background-image: url("', inmo$img, '");
                                                             background-size: cover, 240px 180px;
                                                             border-radius: 8px 8px 0px 0px')),
                      ),
                      div(style = "width: 240px; height: 30px; margin: 6px", 
                          HTML(paste0("<p><span style='font-size: 140%; font-weight: normal; color: ", ifelse(inmo$user == vars$user$user, "#777777", "#444444"), "; height: 45px'>", 
                                      str_trunc(paste0(inmo$tipoPropiedad, " en ", ifelse(inmo$venta_alquiler == "Alquiler temporal", "Alq temp", inmo$venta_alquiler)), 28), "</span></p>"))),
                      div(style = "width: 240px; margin-left: 10px; margin-top: -10px", 
                          HTML(paste0("<p><span style='font-size: 90%; font-weight: normal; color: ", ifelse(inmo$user == vars$user$user, "#777777", "#444444"), "; height: 45px'>", 
                                      str_trunc(ifelse(inmo$distrito != "" & !is.na(inmo$distrito), paste0(inmo$distrito, ", ", inmo$ciudad), inmo$ciudad), 38), "</span></p>"))),
                      h4(paste0(inmo$moneda_contrato, " ", ifelse(inmo$tipoPropiedad == "Proyecto", 
                                                                  ifelse(precio_min == precio_max, precio_min, paste0(precio_min, "-", precio_max)),
                                                                  format(ifelse(inmo$precio_cierre != 0, inmo$precio_cierre, inmo$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)),
                                ifelse(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta", " millones", "")), 
                         style = paste0("margin: 0px; margin-left: 10px; margin-top: -5px; margin-bottom: 5px; font-weight: lighter; font-size: 180%; color: ", lighten(main_color, 0.20))),
                      if(inmo$tipoPropiedad %in% c("Casa", "Casa quinta", "Duplex", "Proyecto", "Departamento", "Edificio")){
                        HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(inmo$user == vars$user$user, "#777777", "#444444"), "'><i class='fa fa-bed'></i> ", 
                                    ifelse(inmo$tipoPropiedad == "Proyecto", 
                                           ifelse(dormitorios_min == dormitorios_max, dormitorios_min, paste0(dormitorios_min, "-", dormitorios_max)),
                                           ifelse(inmo$dormitorios == "0", "Mono", inmo$dormitorios)), 
                                    " <i class='fa fa-bath'></i> ", 
                                    ifelse(inmo$tipoPropiedad == "Proyecto", 
                                           ifelse(banios_min == banios_max, banios_min, paste0(banios_min, "-", banios_max)),
                                           inmo$banios), 
                                    " <i class='fa fa-ruler-combined'></i> ",
                                    ifelse(inmo$tipoPropiedad == "Proyecto", 
                                           ifelse(m2_cons_min == m2_cons_max, m2_cons_min, paste0(m2_cons_min, "-", m2_cons_max)),
                                           inmo$m2_cons), "m2",
                                    " <i class='fa fa-car-side'></i> ",
                                    ifelse(inmo$tipoPropiedad == "Proyecto", 
                                           ifelse(garajes_min == garajes_max, garajes_min, paste0(garajes_min, "-", garajes_max)),
                                           inmo$garajes), 
                                    "</span></p>"))
                      },
                      if(inmo$tipoPropiedad %in% c("Terreno")){
                        HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(inmo$user == vars$user$user, "#777777", "#444444"), "'>",
                                    " <i class='fa fa-ruler-combined'></i> ", inmo$m2, "m2</span></p>"))
                      },
                      if(inmo$tipoPropiedad %in% c("Propiedad rural")){
                        HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(inmo$user == vars$user$user, "#777777", "#444444"), "'>",
                                    " <i class='fa fa-ruler-combined'></i> ", inmo$m2/10000, " hectareas</span></p>"))
                      },
                      if(inmo$tipoPropiedad %in% c("Deposito", "Tinglado", "Oficina", "Salón comercial")){
                        HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(inmo$user == vars$user$user, "#777777", "#444444"), "'>",
                                    " <i class='fa fa-ruler-combined'></i> ", inmo$m2_cons, "m2",
                                    if(!is.na(inmo$banios)) paste0(" <i class='fa fa-bath'></i> ", inmo$banios),
                                    if(!is.na(inmo$oficinas)) paste0(" <i class='fa fa-laptop-house'></i> ", inmo$oficinas),
                                    if(!is.na(inmo$garajes)) paste0(" <i class='fa fa-car-side'></i> ", inmo$garajes),
                                    "</span></p>"))
                      }
                  )
                ),
                div(style = "position: absolute; margin-top: -315px; margin-left: 0px",
                    actionButton(btOpenInmo, NULL, style = "width: 242px; height: 315px; background: transparent;
                                 border-color: transparent")
                )
            )
          })
        })
      }else{
        output$box_inmo_list_ui <- renderUI({
          div()
        })
      }
    }else{
      output$box_inmo_list_ui <- renderUI({
        div()
      })
    }
  })
  
  observeEvent(input$close_inmo_ok, {
    show_inmo_on(0)
    removeModal()
  })
  
  refresh_inmo_input <- reactiveVal(0)
  
  observe({
    refresh_inmo_input()
    if(inmo_input_on() == 1){
      req(vars$inmo_propio_list, input$inmo_filt_prop_seg)
      if(input$inmo_filt_prop_seg == "Activas"){
        all_pages <- vars$inmo_propio_list %>% filter(externa == "no" & precio_cierre == 0 & activo == "si")
      }else{
        if(input$inmo_filt_prop_seg == "Seguidas"){
          list_inmos <- list_table_var_mysql(paste0(co, "_seguidas"), "user", vars$user$user)$id_inmo
          list_inmos <- unique(list_inmos)
          all_pages <- list_table_var_mysql("myplace_inmuebles", "id", list_inmos)
        }else{
          if(input$inmo_filt_prop_seg == "Externas"){
            all_pages <- vars$inmo_propio_list %>% filter(externa == "si")
          }else{
            if(input$inmo_filt_prop_seg == "Cierres"){
              all_pages <- vars$inmo_propio_list %>% filter(precio_cierre != 0)
            }else{
              if(input$inmo_filt_prop_seg == "Inactivas"){
                all_pages <- vars$inmo_propio_list %>% filter(activo == "no")
              }else{
                if(input$inmo_filt_prop_seg == "Vencidas"){
                  all_pages <- vars$inmo_propio_list %>% filter(borrador == "no" & externa == "no" & 
                                                                  precio_cierre == 0 & activo == "si" &
                                                                  tipo_contrato != "Sin contrato" &
                                                                  !is.na(ini_contrato) & 
                                                                  !is.na(fin_contrato))
                  all_pages <- all_pages %>% filter(ifelse(tipo_contrato == "Exclusividad",
                                                           fin_contrato,
                                                           as.character(as_date(ini_contrato) + months(6)))
                                                    < as.character(now("America/Asuncion")))
                }
              }
            }
          }
        }
      }
      
      if(!is.na(input$inmo_filt_codigo) && !is.na(input$inmo_filt_codigo)){
        codigos <- lapply(all_pages$id, FUN = function(i){
          as.integer(str_flatten(str_extract_all(i, "\\d")[[1]]))
        }) %>% unlist()
        all_pages <- all_pages[codigos == input$inmo_filt_codigo,]
      }else{
        if(input$inmo_filt_trans != "Todos"){
          all_pages <- all_pages[all_pages$venta_alquiler == input$inmo_filt_trans,]
        }
        if(input$inmo_filt_tipo != "Todos"){
          all_pages <- all_pages[all_pages$tipoPropiedad == input$inmo_filt_tipo,]
        }
      }
      
      if(nrow(all_pages) != 0){
        vars$page_selected <- 1
        vars$data_all_pages <- all_pages %>% arrange(desc(fecha))
        vars$inmo_propio <- all_pages
        vars$data_per_page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, 1)$data
      }else{
        vars$page_selected <- 1
        vars$inmo_propio <- data.frame()
        vars$data_all_pages <- data.frame()
        vars$data_per_page <- data.frame()
      }
    }
  })
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #mis busquedas
  
  output$busqueda_filtros_ui <- renderUI({
    if(busqueda_on() == 1){
      fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                br(),
                #h4(HTML(paste0("<p><span style='color: ", main_color, "'>Filtros</span></p>")), width = "100%"),
                tags$div(id = "inline",
                         div(class = "btn-group", style = "width: 200px; margin: 5px", selectInput("busqueda_filt_fecha", "Ordenar por", 
                                                                                                   choices = c("Ultimas coincidencias", "Fecha de creación"))
                         ),
                         div(class = "btn-group", style = "width: 200px; margin: 5px", selectInput("busqueda_filt_estado", "Estado de búsquedas",
                                                                                                   choices = c("Todos", "Revisados", "No revisados"))
                         ),
                         div(class = "btn-group", style = "width: 200px; margin: 5px; margin-top: 0px", 
                             textInput("busqueda_filt_name", "", value = NULL)
                         )
                )
      )
    }else{
      div()
    }
  })  
  
  observe({
    if(busqueda_on() == 1){
      req(vars$data_per_page_back, input$busqueda_filt_fecha, input$busqueda_filt_estado)
      if(nrow(vars$data_per_page_back) != 0){
        if(input$busqueda_filt_estado == "Todos"){
          bus <- vars$data_per_page_back
          vars$page_selected <- 1
          if(input$busqueda_filt_fecha == "Fecha de creación"){
            bus <- bus %>% arrange(desc(fecha))
            vars$data_all_pages <- bus
            vars$data_per_page <- generate_pages(bus, vars$n_per_page, vars$max_pages, 1)$data
          }else{
            bus <- bus %>% arrange(desc(fecha_last_coinci))
            vars$data_all_pages <- bus
            vars$data_per_page <- generate_pages(bus, vars$n_per_page, vars$max_pages, 1)$data
          }
        }else{
          if(input$busqueda_filt_estado == "Revisados"){
            bus <- vars$data_per_page_back %>% filter(estado == "revisado")
            vars$page_selected <- 1
            if(input$busqueda_filt_fecha == "Fecha de creación"){
              bus <- bus %>% arrange(desc(fecha))
              vars$data_all_pages <- bus
              vars$data_per_page <- generate_pages(bus, vars$n_per_page, vars$max_pages, 1)$data
            }else{
              bus <- bus %>% arrange(desc(fecha_last_coinci))
              vars$data_all_pages <- bus
              vars$data_per_page <- generate_pages(bus, vars$n_per_page, vars$max_pages, 1)$data
            }
          }else{
            if(input$busqueda_filt_estado == "No revisados"){
              bus <- vars$data_per_page_back %>% filter(estado == "no revisado")
              vars$page_selected <- 1
              if(input$busqueda_filt_fecha == "Fecha de creación"){
                bus <- bus %>% arrange(desc(fecha))
                vars$data_all_pages <- bus
                vars$data_per_page <- generate_pages(bus, vars$n_per_page, vars$max_pages, 1)$data
              }else{
                bus <- bus %>% arrange(desc(fecha_last_coinci))
                vars$data_all_pages <- bus
                vars$data_per_page <- generate_pages(bus, vars$n_per_page, vars$max_pages, 1)$data
              }
            }
          }
        }
      }
    }
  })
  
  observeEvent(input$busqueda_filt_fecha, {
    if(busqueda_on() == 1){
      if(nrow(vars$data_per_page_back) != 0){
        if(input$busqueda_filt_fecha == "Fecha de creación"){
          vars$page_selected <- 1
          bus <- vars$data_per_page_back %>% arrange(desc(fecha))
          vars$data_all_pages <- bus
          vars$data_per_page <- generate_pages(bus, vars$n_per_page, vars$max_pages, 1)$data
        }else{
          vars$page_selected <- 1
          bus <- vars$data_per_page_back %>% arrange(desc(fecha_last_coinci))
          vars$data_all_pages <- bus
          vars$data_per_page <- generate_pages(bus, vars$n_per_page, vars$max_pages, 1)$data
        }
      }
    }
  })
  
  observe({
    if(busqueda_on() == 1){
      if(nrow(vars$data_per_page_back) != 0){
        if(!is.null(input$busqueda_filt_name)){
          isolate({
            if(input$busqueda_filt_name != ""){
              palabras <- str_split(input$busqueda_filt_name, " ")[[1]]
              palabras <- palabras[palabras != ""]
              print(palabras)
              busc <- c()
              for(i in 1:length(palabras)){
                busc <- c(busc, str_detect(str_to_lower(vars$data_per_page_back$name), str_to_lower(palabras[i])))
              }
              m <- matrix(busc, nrow(vars$data_per_page_back), length(palabras))*1
              print(m)
              ind <- which(apply(m, 1, prod) == 1)
              if(length(ind) != 0){
                print(ind)
                bus <- vars$data_per_page_back[ind,]
              }
            }else{
              bus <- vars$data_per_page_back
            }
            vars$page_selected <- 1
            if(input$busqueda_filt_fecha == "Fecha de creación"){
              bus <- bus %>% arrange(desc(fecha))
              vars$data_all_pages <- bus
              vars$data_per_page <- generate_pages(bus, vars$n_per_page, vars$max_pages, 1)$data
            }else{
              bus <- bus %>% arrange(desc(fecha_last_coinci))
              vars$data_all_pages <- bus
              vars$data_per_page <- generate_pages(bus, vars$n_per_page, vars$max_pages, 1)$data
            }
          })
        }
      }
    }
  })
  
  output$box_busqueda_ui <- renderUI({
    if(busqueda_on() == 1){
      fluidPage(
        div(style = "width: 100%; z-index: 5",
            uiOutput("busqueda_filtros_ui")),
        div(uiOutput("box_busqueda_list_ui"), align = "center"),
        uiOutput("page_ui"),
        uiOutput("cont_page_ui")
      )
    }else{
      div()
    }
  })  
  
  obs_open_busqueda <- list()
  obs_del_busqueda <- list()
  observe({
    if(busqueda_on() == 1){
      if(nrow(vars$data_per_page) != 0){
        output$box_busqueda_list_ui <- renderUI({
          print(isolate(vars$data_per_page))
          boxes_busqueda <- as.list(1:nrow(vars$data_per_page))
          boxes_busqueda <- lapply(boxes_busqueda, function(i){
            btOpenBusqueda <- paste0("open_busqueda_button", i) 
            btDelBusqueda <- paste0("del_busqueda_button", i) 
            isolate({
              busqueda <- vars$data_per_page[i,]
              print("busqueda")
              print(busqueda)
              cliente <- list_table_var_mysql(paste0(co, "_clientes"), "id", busqueda$cliente)
              coinci <- list_table_var1_var2_var3_mysql("myplace_coincidencias", "user_busq", vars$user$user, "busqueda", busqueda$id, "activo", "IN", "si")
              coinci <- coinci[!duplicated(coinci$inmueble),]
              print("coinci")
              print(coinci)
            })
            obs_del_busqueda[[btDelBusqueda]] <<- observeEvent(input[[btDelBusqueda]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btDelBusqueda)
              isolate({
                vars$del_busqueda <- vars$data_per_page[i,]
                showModal(modalDialog(
                  h4("¿Está seguro que desea eliminar la búsqueda?"),
                  br(),
                  tags$div(id="bttn_modal", 
                           actionBttn("busqueda_delete_ok", "Eliminar"),
                           actionBttn("close_modal", "Cancelar"),
                           align = "center"),
                  title = "Eliminar búsqueda",
                  easyClose = TRUE,
                  footer = NULL,
                  size = "s",
                  fade = TRUE
                ))
              })
            })
            obs_open_busqueda[[btOpenBusqueda]] <<- observeEvent(input[[btOpenBusqueda]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              vars$show_busqueda <- vars$data_per_page[i,]
              modal_busqueda_description()
            })
            path <- paste0("www/temp/", vars$user$user, "temp_map", i, ".html")
            saveWidget(
              widget = leaflet() %>% addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}")%>%
                addPolygons(data = busqueda, color = ~ifelse(estado == "revisado", "blue", color),
                            popup = ~popup_busqueda(busqueda, TRUE)),
              file = path,
              selfcontained = FALSE,
              libdir = "files/"
            )
            
            div(style = "padding: 10px; display:inline-block", align = "left",
                div(
                  div(style = paste0("border-style: solid; border-width: 1px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; width: 242px; height: 315px;
                                 margin: 0px; padding: 0px"),
                      div(style = "position: absolute; margin-left: 10px; margin-top: 200px; padding: 0px;",
                          h4(busqueda$name, style='font-size: 120%; font-weight: normal; color: #888888; height: 45px; width: 220px')
                      ),
                      div(
                        actionButton(btDelBusqueda, NULL, icon = icon("trash-alt"),
                                     style = "border-radius: 5px; background-color: red; border: 0px;
                                            width: 20px; height: 20px; margin-left: 0px;  z-index: 3;
                                            position: absolute; color: white; padding: 0px;
                                            margin-top: -5px; margin-left: 225px;")
                      ),
                      div(style = "position: absolute; margin-left: 10px; margin-top: 270px;",
                          actionButton("nada", paste0(nrow(coinci), ifelse(nrow(coinci) == 1, "  coincidencia","  coincidencias")),
                                       style = paste0("background: transparent; border-color: transparent; padding: 0px;",
                                                      "font-size: 180%; font-weight: lighter; color: ", main_color)),
                      ),
                      tags$iframe(seamless="seamless", 
                                  src = paste0("temp/", vars$user$user, "temp_map", i, ".html"), 
                                  style = "border-radius: 8px 8px 0px 0px; width: 240px; height: 200px;
                                border: 0px; padding: 3px"),
                  )
                ),
                div(style = "position: absolute; margin-top: -315px; margin-left: 0px",
                    actionButton(btOpenBusqueda, NULL, style = "width: 242px; height: 315px; background: transparent;
                                 border-color: transparent")
                )
            )
          })
        })
      }else{
        output$box_busqueda_list_ui <- renderUI({
          div()
        })
      }
    }else{
      output$box_busqueda_list_ui <- renderUI({
        div()
      })
    }
  })
  
  output$formulario_busqueda_edit <- renderUI({
    if(nrow(vars$show_busqueda) != 0){
      busqueda <- vars$show_busqueda
      coinci <- list_table_var1_var2_var3_mysql("myplace_coincidencias", "user_busq", vars$user$user, "busqueda", busqueda$id, "activo", "IN", "si")
      coinci <- coinci[!duplicated(coinci$inmueble),]
      coinci_sky <- coinci$inmueble[str_detect(coinci$inmueble, "skyone")]
      coinci_ext <- coinci$inmueble[!str_detect(coinci$inmueble, "skyone")]
      inmos_sky <- list_table_var_mysql("myplace_inmuebles", "id", coinci_sky)
      inmos_ext <- list_table_var_mysql("myplace_inmuebles", "id", coinci_ext)
      coinci_sky <- coinci_sky[coinci_sky %in% inmos_sky$id]
      coinci_ext <- coinci_ext[coinci_ext %in% inmos_ext$id]
      
      if(nrow(inmos_sky) == 0 & nrow(inmos_ext) == 0){
        inmos <- data.frame()
      }else{
        if(nrow(inmos_sky) != 0  & nrow(inmos_ext) == 0){
          inmos <- inmos_sky
        }else{
          if(nrow(inmos_sky) == 0 & nrow(inmos_ext) != 0){
            inmos <- inmos_ext
          }else{
            if(nrow(inmos_sky) != 0 & nrow(inmos_ext) != 0){
              st_crs(inmos_sky) <- crs
              st_crs(inmos_ext) <- crs
              inmos <- rbind(inmos_sky, inmos_ext)
            }
          }
        }
      }
      
      clien <- list_table_var_mysql(paste0(co, "_clientes"), "id", busqueda$cliente)
      
      output$map_show_busqueda <- renderLeaflet({
        map <- leaflet() %>% addTiles() %>% addPolygons(data = busqueda)
        if(nrow(coinci) != 0){
          map <- map %>% addMarkers(data = inmos, icon = ~icon_inmo(tipoPropiedad))
        }
        map
      })
      
      div(
        div(HTML(paste0("<p><span style='font-size: 160%; font-weight: bold; color: #666666'>", 
                        str_to_upper(busqueda$name), "</span></p>")), align = "center"),
        
        
        fluidRow(
          column(6,
                 fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                                                            border-radius: 10px; background-color: white; padding: 10px; height: 500px; margin: 0px;
                                                            margin-top: 10px"),
                           fluidRow(
                             column(4,
                                    div(actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:100px; height: 100px; margin: 0px;
                                                             background-image: url("', clien$img, '");
                                                             background-size: cover, 100px 100px;
                                                             border-radius: 50px 50px 50px 50px')))
                             ),
                             column(8,
                                    HTML(paste0("<p><span style='font-size: 120%; font-weight: normal; color: #888888'>", ifelse(clien$tipo != "Cliente", "Asesor externo", "Cliente"), "</span></p>")),
                                    h4(HTML(paste0("<p><span style='color: ", main_color, "'>", clien$name, "</span></p>"))),
                                    if(clien$mail != ""){
                                      div(class = "btn-group",
                                          a(href= paste0("mailto:", clien$mail), target="_blank", actionButton("nada", "" , icon = icon("envelope"), style = "font-size: 170%; padding: 0px; background-color: transparent; border-color: transparent"))
                                      )
                                    },
                                    if(!is.na(clien$phone)){
                                      text_wp <- paste0("https://wa.me/", clien$phone, "?text=", "")
                                      div(class = "btn-group",
                                          a(href= text_wp, target="_blank", actionButton("nada", NULL , icon = icon("whatsapp"),
                                                                                         style = "font-size: 170%; padding: 0px; padding-left: 10px; background-color: transparent; border-color: transparent"))
                                      )
                                    }
                             )
                           ),
                           br(),
                           div(id = "inline",
                               fluidRow(
                                 column(6,
                                        radioButtons("change_tipo_moneda", "Moneda", inline = TRUE, choices = c("USD", "GS"), selected = busqueda$moneda),
                                 ),
                                 column(6,
                                        div(id = "bttn_modal",
                                            actionButton("guardar_changes_busqueda_ok", "Guardar cambios")
                                        )
                                 )
                               ),
                               fluidRow(
                                 column(6,
                                        autonumericInput(inputId = "change_busqueda_precio_min", align = "left",
                                                         label = "Precio mínimo",
                                                         value = busqueda$precio_min, currencySymbol = NULL, currencySymbolPlacement = "p",
                                                         decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")
                                 ),
                                 column(6, 
                                        autonumericInput(inputId = "change_busqueda_precio_max", align = "left",
                                                         label = "Precio máximo", 
                                                         value = busqueda$precio_max, currencySymbol = NULL, currencySymbolPlacement = "p",
                                                         decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")
                                 ),
                               ),
                               if(!busqueda$tipoPropiedad %in% c("Departamento", "Oficina", "Proyecto", "Edificio", "Salón comercial")){
                                 fluidRow(
                                   column(6, 
                                          autonumericInput(inputId = "change_busqueda_m2_min", align = "left",
                                                           label = ifelse(busqueda$tipoPropiedad == "Propiedad rural", "Hectareas mínimas", "Area terreno mínima"), 
                                                           value = busqueda$m2_min, currencySymbol = ifelse(busqueda$tipoPropiedad == "Propiedad rural", " has", " ₘ₂"), currencySymbolPlacement = "s",
                                                           decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")
                                   ),  
                                   column(6, 
                                          autonumericInput(inputId = "change_busqueda_m2_max", align = "left",
                                                           label = ifelse(busqueda$tipoPropiedad == "Propiedad rural", "Hectareas máximas", "Area terreno máxima"), 
                                                           value = busqueda$m2_max, currencySymbol = ifelse(busqueda$tipoPropiedad == "Propiedad rural", " has", " ₘ₂"), currencySymbolPlacement = "s",
                                                           decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")
                                   ),
                                 )
                               },
                               if(!busqueda$tipoPropiedad %in% c("Terreno", "Proyecto", "Propiedad rural")){
                                 fluidRow(
                                   column(6, 
                                          autonumericInput(inputId = "change_busqueda_m2_cons_min", align = "left",
                                                           label = "Area edificada mínima", 
                                                           value = busqueda$m2_cons_min, currencySymbol = " ₘ₂", currencySymbolPlacement = "s",
                                                           decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")
                                   ),  
                                   column(6, 
                                          autonumericInput(inputId = "change_busqueda_m2_cons_max", align = "left",
                                                           label = "Area edificada máxima", 
                                                           value = busqueda$m2_cons_max, currencySymbol = " ₘ₂", currencySymbolPlacement = "s",
                                                           decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")
                                   ),  
                                 )
                               },
                               if(!busqueda$tipoPropiedad %in% c("Terreno", "Oficina", "Deposito", "Tinglado", "Proyecto", "Edificio", "Propiedad rural", "Salón comercial")){
                                 fluidRow(column(6,
                                                 selectInput("change_busqueda_dormitorios_min", "Número de dormitorios", choices = c("", "Monoambiente" = "0", "1", "2", "3", "4", "5+"),
                                                             selected = ifelse(is.na(busqueda$dormitorios_min), "", busqueda$dormitorios_min))
                                 ))
                               },
                               #                                 if(!busqueda$tipoPropiedad %in% c("Terreno", "Proyecto", "Edificio", "Tinglado", "Deposito", "Propiedad rural", "Salón comercial", "Oficina")){
                               #                                   fluidRow(column(6,
                               #                                                   selectInput("change_busqueda_banios_min", "Mínimo de baños", choices = c("", "1", "2", "3", "4", "5+"),
                               #                                                               selected = ifelse(is.na(busqueda$banios_min), "", busqueda$banios_min))
                               #                                   ))
                               #                                 },
                               #                                 if(busqueda$tipoPropiedad %in% c("Departamento", "Proyecto", "Edificio")){
                               #                                   fluidRow(column(6, 
                               #                                                   numericInput("change_busqueda_pisos_min", ifelse(busqueda$tipoPropiedad == "Departamento", "Piso mínimo de ubicación", "Mínima cantidad de Pisos"), 
                               #                                                                value = busqueda$pisos_min)
                               #                                   ))
                               #                                 },
                               #                                 if(busqueda$tipoPropiedad %in% c("Departamento", "Oficina", "Deposito", "Tinglado", "Salón comercial", "Casa", "Duplex")){
                               #                                   fluidRow(column(6, 
                               #                                                   selectInput("change_busqueda_garajes_min", "Cantidad mínima de cocheras", choices = c("", "1", "2", "3", "4", "5+"),
                               #                                                               selected = ifelse(is.na(busqueda$garajes_min), "", busqueda$garajes_min))
                               #                                   ))
                               #                                 },
                               #                                 if(busqueda$tipoPropiedad %in% c("Oficina", "Deposito", "Tinglado", "Salón comercial")){
                               #                                   fluidRow(column(6, 
                               #                                                   selectInput("change_busqueda_oficinas_min", "Cantidad mínima de oficinas", choices = c("", "1", "2", "3", "4", "5+"),
                               #                                                               selected = ifelse(is.na(busqueda$oficinas_min), "", busqueda$oficinas_min))
                               #                                   ))
                               #                                 },
                               #                                 if(!busqueda$tipoPropiedad %in% c("Terreno", "Proyecto", "Oficina", "Propiedad rural", "Salón comercial")){
                               #                                   fluidRow(column(6,
                               #                                                   autonumericInput(inputId = "change_busqueda_anio_max", align = "left",
                               #                                                                    label = "Antiguedad máxima del inmueble", 
                               #                                                                    value = busqueda$anio_max, currencySymbol = " años", currencySymbolPlacement = "s",
                               #                                                                    decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")
                               #                                   ))
                               #                                 }
                           )
                           
                           
                 )
                 
          ),
          column(6,
                 fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                             border-radius: 10px; background-color: white; padding: 3px; margin: 0px;
                             margin-top: 10px; height: 500px",
                           leafletOutput("map_show_busqueda", height = 492)
                 )
          )
        ),
        
        if(nrow(coinci) > 0){
          busqueda$estado <- "revisado"
          update_var_table_mysql("revisado", "estado", "id", busqueda$id, "myplace_busquedas")
          update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", busqueda$id, "myplace_busquedas")
          vars$data_per_page[vars$data_per_page$id == busqueda$id,] <- busqueda
          print(coinci$inmueble)
          vinc_inmo <- data.frame(id_inmo = inmos$id)
          vinc_inmo$tipo_clien <- "búsqueda"
          vinc_inmo$obs_clien <- NA
          vars$list_inmuebles_vinc <- vinc_inmo
          print(vinc_inmo)
          show_clien_on(1)
          
          isolate({
            
            open_scroll_1$boxes = list()
            open_scroll_1$obs_open_scroll = list()
            open_scroll_1$obs_new_comentario = list()
            vars$n_scroll_1 <- 0
            vars$list_scroll_1 <- data.frame()
            
            vars$scroll_per_page_1 <- scroll_per_page
            vars$n_scroll_1 <- nrow(vars$list_inmuebles_vinc)
            if(vars$n_scroll_1 != 0){
              if(vars$n_scroll_1 > all_scroll){
                vars$all_scroll_1 <- vars$list_inmuebles_vinc[1:all_scroll,]
              }else{
                vars$all_scroll_1 <- vars$list_inmuebles_vinc
              }
              if(vars$n_scroll_1 <= scroll_per_page){
                vars$from_1 <- 1
                vars$to_1 <- vars$n_scroll_1
                vars$list_scroll_1 <- vars$all_scroll_1
                vars$loaded_scroll_1 <- vars$n_scroll_1
              }else{
                vars$from_1 <- 1   
                vars$to_1 <- scroll_per_page
                vars$list_scroll_1 <- vars$all_scroll_1[vars$from_1:vars$to_1,]
                vars$loaded_scroll_1 <- scroll_per_page
              }
            }else{
              vars$loaded_scroll_1 <- 0
            }
          })
          
          div(style = "background: #ffffff; border-style: solid; border-width: 1px; border-color: #aaaaaa; border-radius: 10px; padding: 20 px",
              div(uiOutput("boxes_with_scroll_ui_1"), align = "center"),
              br(),
              div(uiOutput("bttn_prox_scroll_1"), align = "center"),
              br()
          )
          
        }
      )
    }else{
      div()
    }
  })
  
  observeEvent(input$close_busqueda, {
    vars$show_busqueda <- data.frame()
    removeModal()
  })
  
  observeEvent(input$guardar_changes_busqueda_ok, {
    busqueda <- vars$show_busqueda
    cambio <- FALSE
    
    if(!is.null(input$change_busqueda_precio_min) && !is.null(input$change_busqueda_precio_max)){
      if(input$change_busqueda_precio_min != 0 & input$change_busqueda_precio_max != 0){
        update_var_table_mysql(input$change_busqueda_precio_min, "precio_min", "id", busqueda$id, "myplace_busquedas")
        update_var_table_mysql(input$change_busqueda_precio_max, "precio_max", "id", busqueda$id, "myplace_busquedas")
        update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", busqueda$id, "myplace_busquedas")
        update_var_table_mysql(input$change_tipo_moneda, "moneda", "id", busqueda$id, "myplace_busquedas")
        busqueda$moneda <- input$change_tipo_moneda
        busqueda$precio_min <- input$change_busqueda_precio_min
        busqueda$precio_max <- input$change_busqueda_precio_max
        cambio <- TRUE
      }else{
        if(input$change_busqueda_precio_min == 0 & input$change_busqueda_precio_max != 0){
          shinyalert(
            type = "error",
            title = "Precio mínimo sin completar"
          )
        }else{
          if(input$change_busqueda_precio_min != 0 & input$change_busqueda_precio_max == 0){
            shinyalert(
              type = "error",
              title = "Precio máximo sin completar"
            )
          }
        }
      }
    }  
    
    if(!is.null(input$change_busqueda_m2_min) && !is.null(input$change_busqueda_m2_max)){
      if(input$change_busqueda_m2_min != 0 & input$change_busqueda_m2_max != 0){
        if(busqueda$tipoPropiedad == "Propiedad rural"){
          m2_min <- input$change_busqueda_m2_min*10000
          m2_max <- input$change_busqueda_m2_max*10000
        }else{
          m2_min <- input$change_busqueda_m2_min
          m2_max <- input$change_busqueda_m2_max
        }
        update_var_table_mysql(m2_min, "m2_min", "id", busqueda$id, "myplace_busquedas")
        update_var_table_mysql(m2_max, "m2_max", "id", busqueda$id, "myplace_busquedas")
        update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", busqueda$id, "myplace_busquedas")
        busqueda$m2_min <- m2_min
        busqueda$m2_max <- m2_max
        cambio <- TRUE
      }else{
        if(input$change_busqueda_m2_min == 0 & input$change_busqueda_m2_max != 0){
          shinyalert(
            type = "error",
            title = "Area del terreno mínima sin completar"
          )
        }else{
          if(input$change_busqueda_m2_min != 0 & input$change_busqueda_m2_max == 0){
            shinyalert(
              type = "error",
              title = "Area del terreno máxima sin completar"
            )
          }
        }
      }
    }
    
    if(!is.null(input$change_busqueda_m2_cons_min) && !is.null(input$change_busqueda_cons_m2_max)){
      if(input$change_busqueda_m2_cons_min != 0 & input$change_busqueda_m2_cons_max != 0){
        update_var_table_mysql(input$change_busqueda_m2_cons_min, "m2_cons_min", "id", busqueda$id, "myplace_busquedas")
        update_var_table_mysql(input$change_busqueda_m2_cons_max, "m2_cons_max", "id", busqueda$id, "myplace_busquedas")
        update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", busqueda$id, "myplace_busquedas")
        busqueda$m2_cons_min <- input$change_busqueda_m2_cons_min
        busqueda$m2_cons_max <- input$change_busqueda_m2_cons_max
        cambio <- TRUE
      }else{
        if(input$change_busqueda_m2_cons_min == 0 & input$change_busqueda_m2_cons_max != 0){
          shinyalert(
            type = "error",
            title = "Area edificada mínima sin completar"
          )
        }else{
          if(input$change_busqueda_m2_cons_min != 0 & input$change_busqueda_m2_cons_max == 0){
            shinyalert(
              type = "error",
              title = "Area edificada máxima sin completar"
            )
          }
        }
      }
    }
    
    if(!is.null(input$change_busqueda_dormitorios_min)){
      if(input$change_busqueda_dormitorios_min != ""){
        update_var_table_mysql(input$change_busqueda_dormitorios_min, "dormitorios_min", "id", busqueda$id, "myplace_busquedas")
        update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", busqueda$id, "myplace_busquedas")
        busqueda$dormitorios_min <- input$change_busqueda_dormitorios_min
        cambio <- TRUE
      }
    }
    
    if(cambio){
      coincidencias(busqueda, dir, session)
    }
    vars$data_per_page_back[vars$data_per_page_back$id == busqueda$id, ] <- busqueda
    vars$data_all_pages <- vars$data_per_page_back
    vars$page_selected <- 1
    vars$data_per_page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, 1)$data
  })
  
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #busquedas
  
  observeEvent(input$ubi_lat_lon, {
    showModal(modalDialog(
      textInput("lat_lon_text", HTML("<p><span style='font-weight: normal'>Copiar coordenadas de Google Maps<br>Ej: (-25.3032778, -57.5992415)</span></p>")),
      tags$div(id="bttn_modal", 
               actionBttn("text_coords_ok", "Ubicar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Ubicación por coordenadas",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$text_coords_ok, {
    if(input$lat_lon_text == ""){
      shinyalert(
        type = "error",
        title = "Debes copiar las coordenadas de Google Maps"
      )
    }else{
      removeModal()
      #te <- "(-25.3032778, -57.5992415)"
      text <- str_remove(input$lat_lon_text, "\\(")
      text <- str_remove(text, "\\)")
      text <- str_split(text, ",")[[1]]
      text_coords <- data.frame(lat = as.numeric(text[1]), lon = as.numeric(text[2]))
      point <- text_coords %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
      way <- reverse_geocode(point)
      updateTextInput(session, "inmo_pais", value = way$country)
      updateTextInput(session, "inmo_departamento", value = way$county)
      updateTextInput(session, "inmo_ciudad", value = way$city)
      updateTextInput(session, "inmo_distrito", value = way$district)
      updateTextInput(session, "inmo_calle", value = way$street)
      updateTextInput(session, "inmo_nro_casa", value = way$house_number)
      vars$view <- point
      vars$place <- text_coords
    }
  })
  
  observeEvent(input$cliente_tipo_change, {
    showModal(modalDialog(
      selectInput("new_cliente_tipo", NULL, choices = c("Cliente", "Asesor externo"), selected = vars$cliente$tipo),
      tags$div(id="bttn_modal", 
               actionBttn("cliente_tipo_change_ok", "Cambiar"),
               actionBttn("close_formulario_edit", "Cancelar"),
               align = "center"),
      title = "Cambio de tipo de cliente",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cliente_name_change, {
    showModal(modalDialog(
      textInput("new_cliente_name", "Nueno nombre", value = vars$cliente$name),
      tags$div(id="bttn_modal", 
               actionBttn("cliente_name_change_ok", "Cambiar"),
               actionBttn("close_formulario_edit", "Cancelar"),
               align = "center"),
      title = "Cambio de nombre",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cliente_phone_change, {
    showModal(modalDialog(
      fluidRow(
        column(7, selectInput("phone_code", "País", choices = phone_codes$name), style = "padding-right: 0px"),
        column(5, textInput("cliente_phone", "Teléfono"), style = "padding-left: 0px")
      ),
      tags$div(id="bttn_modal", 
               actionBttn("cliente_phone_change_ok", "Cambiar"),
               actionBttn("close_formulario_edit", "Cancelar"),
               align = "center"),
      title = "Cambio de teléfono",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cliente_mail_change, {
    showModal(modalDialog(
      textInput("new_cliente_mail", "Nueno correo electrónico", value = vars$cliente$mail),
      tags$div(id="bttn_modal", 
               actionBttn("cliente_mail_change_ok", "Cambiar"),
               actionBttn("close_formulario_edit", "Cancelar"),
               align = "center"),
      title = "Cambio de correo electrónico",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cliente_birthday_change, {
    showModal(modalDialog(
      dateInput("new_cliente_birthday", "Fecha de nacimiento", value = vars$cliente$birthday, language = "es"),
      tags$div(id="bttn_modal", 
               actionBttn("cliente_birthday_change_ok", "Cambiar"),
               actionBttn("close_formulario_edit", "Cancelar"),
               align = "center"),
      title = "Cambio de fecha de nacimiento",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cliente_addr_change, {
    showModal(modalDialog(
      textInput("new_cliente_addr", "Nuena dirección", value = vars$cliente$addr),
      tags$div(id="bttn_modal", 
               actionBttn("cliente_addr_change_ok", "Cambiar"),
               actionBttn("close_formulario_edit", "Cancelar"),
               align = "center"),
      title = "Cambio de dirección",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cliente_company_change, {
    showModal(modalDialog(
      textInput("new_cliente_company", "Nuena compañía", value = vars$cliente$company),
      tags$div(id="bttn_modal", 
               actionBttn("cliente_company_change_ok", "Cambiar"),
               actionBttn("close_formulario_edit", "Cancelar"),
               align = "center"),
      title = "Cambio de compañía",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cliente_razon_change, {
    showModal(modalDialog(
      textInput("new_cliente_razon", "Nuena razón social", value = vars$cliente$razon),
      tags$div(id="bttn_modal", 
               actionBttn("cliente_razon_change_ok", "Cambiar"),
               actionBttn("close_formulario_edit", "Cancelar"),
               align = "center"),
      title = "Cambio de razón social",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cliente_ruc_change, {
    showModal(modalDialog(
      textInput("new_cliente_ruc", "Nuevo RUC", value = vars$cliente$ruc),
      tags$div(id="bttn_modal", 
               actionBttn("cliente_ruc_change_ok", "Cambiar"),
               actionBttn("close_formulario_edit", "Cancelar"),
               align = "center"),
      title = "Cambio de RUC",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cliente_canal_change, {
    showModal(modalDialog(
      selectInput("new_cliente_canal", "Canal de contacto", choices = c("Cartel", "Facebook", "Whatsapp", "Colega", "LinkedIn", "Instagram", "Clasipar", "Infocasas", "Portal", "Otro"), selected = vars$cliente$canal),
      tags$div(id="bttn_modal", 
               actionBttn("cliente_canal_change_ok", "Cambiar"),
               actionBttn("close_formulario_edit", "Cancelar"),
               align = "center"),
      title = "Cambio de canal de contacto",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cliente_obs_change, {
    showModal(modalDialog(
      textInput("new_cliente_obs", "Primer contacto", value = vars$cliente$comment),
      div(
        actionBttn("cliente_obs_change_ok", "Cambiar"),
        actionBttn("close_formulario_edit", "Cancelar"),
        align = "center"),
      title = "Cambio de primer contacto",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cliente_tipo_change_ok, {
    isolate({
      vars$change_cliente <- TRUE
      new_info <- input$new_cliente_tipo
      vars$cliente$canal <- new_info
      var <- "tipo"
      id <- vars$cliente$id
      update_var_table_mysql(new_info, var, "id", id, paste0(co, "_clientes"))
      edit_clien_on(1)
      if(isolate(clientes_on()) == 1)
        vars$clientes_all_pages$tipo[vars$clientes_all_pages$id == vars$cliente$id] <- new_info
      modal_clien_description()
    })
  })
  
  observeEvent(input$cliente_name_change_ok, {
    isolate({
      vars$change_cliente <- TRUE
      new_info <- input$new_cliente_name
      vars$cliente$name <- new_info
      var <- "name"
      id <- vars$cliente$id
      update_var_table_mysql(new_info, var, "id", id, paste0(co, "_clientes"))
      edit_clien_on(1)
      if(isolate(clientes_on()) == 1)
        vars$clientes_all_pages$name[vars$clientes_all_pages$id == vars$cliente$id] <- new_info
      modal_clien_description()
    })
  })
  
  observeEvent(input$cliente_mail_change_ok, {
    isolate({
      vars$change_cliente <- TRUE
      new_info <- input$new_cliente_mail
      vars$cliente$mail <- new_info
      var <- "mail"
      id <- vars$cliente$id
      update_var_table_mysql(new_info, var, "id", id, paste0(co, "_clientes"))
      edit_clien_on(1)
      if(isolate(clientes_on()) == 1)
        vars$clientes_all_pages$mail[vars$clientes_all_pages$id == vars$cliente$id] <- new_info
      modal_clien_description()
    })
  })
  
  observeEvent(input$cliente_phone_change_ok, {
    isolate({
      vars$change_cliente <- TRUE
      new_info <- paste0(phone_codes$code[phone_codes$name == input$phone_code], str_remove_all(str_remove(input$cliente_phone, "^0"), " "))
      vars$cliente$phone <- new_info
      var <- "phone"
      id <- vars$cliente$id
      update_var_table_mysql(new_info, var, "id", id, paste0(co, "_clientes"))
      edit_clien_on(1)
      if(isolate(clientes_on()) == 1)
        vars$clientes_all_pages$phone[vars$clientes_all_pages$id == vars$cliente$id] <- new_info
      modal_clien_description()
    })
  })
  
  observeEvent(input$cliente_birthday_change_ok, {
    isolate({
      vars$change_cliente <- TRUE
      new_info <- as.character(input$new_cliente_birthday)
      vars$cliente$birthday <- new_info
      var <- "birthday"
      id <- vars$cliente$id
      update_var_table_mysql(new_info, var, "id", id, paste0(co, "_clientes"))
      edit_clien_on(1)
      if(isolate(clientes_on()) == 1)
        vars$clientes_all_pages$birthday[vars$clientes_all_pages$id == vars$cliente$id] <- new_info
      modal_clien_description()
    })
  })
  
  observeEvent(input$cliente_addr_change_ok, {
    isolate({
      vars$change_cliente <- TRUE
      new_info <- input$new_cliente_addr
      vars$cliente$addr <- new_info
      var <- "addr"
      id <- vars$cliente$id
      update_var_table_mysql(new_info, var, "id", id, paste0(co, "_clientes"))
      edit_clien_on(1)
      if(isolate(clientes_on()) == 1)
        vars$clientes_all_pages$addr[vars$clientes_all_pages$id == vars$cliente$id] <- new_info
      modal_clien_description()
    })
  })
  
  observeEvent(input$cliente_company_change_ok, {
    isolate({
      vars$change_cliente <- TRUE
      new_info <- input$new_cliente_company
      vars$cliente$company <- new_info
      var <- "company"
      id <- vars$cliente$id
      update_var_table_mysql(new_info, var, "id", id, paste0(co, "_clientes"))
      edit_clien_on(1)
      if(isolate(clientes_on()) == 1)
        vars$clientes_all_pages$company[vars$clientes_all_pages$id == vars$cliente$id] <- new_info
      modal_clien_description()
    })
  })
  
  observeEvent(input$cliente_razon_change_ok, {
    isolate({
      vars$change_cliente <- TRUE
      new_info <- input$new_cliente_razon
      vars$cliente$razon <- new_info
      var <- "razon"
      id <- vars$cliente$id
      update_var_table_mysql(new_info, var, "id", id, paste0(co, "_clientes"))
      edit_clien_on(1)
      if(isolate(clientes_on()) == 1)
        vars$clientes_all_pages$razan[vars$clientes_all_pages$id == vars$cliente$id] <- new_info
      modal_clien_description()
    })
  })
  
  observeEvent(input$cliente_ruc_change_ok, {
    isolate({
      vars$change_cliente <- TRUE
      new_info <- input$new_cliente_ruc
      vars$cliente$ruc <- new_info
      var <- "ruc"
      id <- vars$cliente$id
      update_var_table_mysql(new_info, var, "id", id, paste0(co, "_clientes"))
      edit_clien_on(1)
      if(isolate(clientes_on()) == 1)
        vars$clientes_all_pages$ruc[vars$clientes_all_pages$id == vars$cliente$id] <- new_info
      modal_clien_description()
    })
  })
  
  observeEvent(input$cliente_canal_change_ok, {
    isolate({
      vars$change_cliente <- TRUE
      new_info <- input$new_cliente_canal
      vars$cliente$canal <- new_info
      var <- "canal"
      id <- vars$cliente$id
      update_var_table_mysql(new_info, var, "id", id, paste0(co, "_clientes"))
      edit_clien_on(1)
      if(isolate(clientes_on()) == 1)
        vars$clientes_all_pages$canal[vars$clientes_all_pages$id == vars$cliente$id] <- new_info
      modal_clien_description()
    })
  })
  
  observeEvent(input$cliente_obs_change_ok, {
    isolate({
      vars$change_cliente <- TRUE
      new_info <- input$new_cliente_obs
      vars$cliente$comment <- new_info
      var <- "comment"
      id <- vars$cliente$id
      update_var_table_mysql(new_info, var, "id", id, paste0(co, "_clientes"))
      edit_clien_on(1)
      if(isolate(clientes_on()) == 1)
        vars$clientes_all_pages$comment[vars$clientes_all_pages$id == vars$cliente$id] <- new_info
      modal_clien_description()
    })
  })
  
  observe({
    if(vars$start == TRUE){
      show_login_menu()
    }
  })
  
  observeEvent(input$geolocation, {
    req(input$geolocation)
    if(input$geolocation == TRUE){
      vars$view <- data.frame(lat = input$lat, lng = input$lng) %>%
        st_as_sf(coords = c("lng", "lat"), crs = crs)
    }
  })
  
  
  observeEvent(input$pass_forget, {
    new_pass <- stri_rand_strings(n = 1, length = 8, pattern = "[A-Za-z0-9]")
    if(is.na(vars$user)){
      user <- strtrim(str_squish(str_to_lower(isolate(input$login_user))), 63)
    }else{
      user <- vars$user$user
    }
    if(user == ""){
      shinyalert(
        type = "error",
        title = "Debes ingresar el correo electrónico"
      )
    }else{
      agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", user)
      if(nrow(agente) == 0){
        shinyalert(
          type = "error",
          title = "No existe el correo electrónico ingresado"
        )
      }else{
        shinyalert(
          type = "info",
          confirmButtonText = "Enviar",
          showCancelButton = TRUE,
          cancelButtonText = "Cancelar",
          title = "Se te enviará al correo y al whatsapp una contraseña provisoria. La puedes cambiar luego dentro de tu perfil.",
          callbackR = function(x){
            if(x != FALSE){
              
              
              POST(url = "https://graph.facebook.com/v13.0/100461746150331/messages",
                   add_headers(.headers = c("Content-Type"="application/json", "Authorization"="Bearer EAAL4VE6rm3IBACclVKbpaA9WL24AwDE9fZB7UEZAfd9Qx0w0hzdGLXZCk1wYBT9Ru5ln9KAqNG5d3RF5ATEHgHsa1Q0xCBgBev9rFSP82IvyW0ZCRnm4npKP0Vo3E7j2ClHcwNbjCZAZAanIlFZAEWVy7EzE9C2no6zF7COZBMLNO9M2S2LGwCUw71ZAN7pTal8BSOjXcDLdiDgZDZD")),
                   encode = 'raw',
                   body = paste0('{
                                              "messaging_product": "whatsapp",
                                              "recipient_type": "individual",
                                              "to": "', str_remove(agente$phone, "\\+"), '",
                                              "type": "template",
                                              "template": {
                                                "name": "recuperar_contrasena",
                                                "language": {
                                                  "code": "en_US"
                                                },
                                                "components": [
                                                  {
                                                    "type" : "body",
                                                    "parameters": [
                                                      {
                                                          "type": "text",
                                                          "text": "', agente$name, '"
                                                      },
                                                      {
                                                          "type": "text",
                                                          "text": "', new_pass, '"
                                                      }
                                                    ] 
                                                  }
                                                ]
                                              }
                                            }')
              )
              
              
              email <- compose_email(
                body = md(c(
                  paste0("Hola ", agente$name, "<br><br>"),
                  "A continuación te otorgamos una nueva contraseña generada aleatoriamente y recordamos que una vez ingresada a la plataforma la misma puede ser cambiada dentro del panel del perfil del usuario.<br><br>",
                  paste("<<<<<", new_pass, "     >>>>>", collapse = "     ")
                ))
              )
              
              email %>%
                smtp_send(
                  from = "skyone.realestatelatam@gmail.com",
                  to = agente$user,
                  subject = "Nueva contraseña Place Analyzer",
                  credentials = creds_envvar(user = "skyone.realestatelatam@gmail.com",
                                             pass_envvar = "MAIL_PASS",
                                             provider = "gmail",
                                             use_ssl = TRUE)
                )
              
              new_info <- digest(new_pass)
              var <- "pass"
              update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
              update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
              
              if(!is.na(vars$user)){
                vars$user$pass <- digest(new_pass)
              }
            }
          }
        )
      }
    }
  })
  
  observeEvent(input$ingresar, {
    agente <- list_table_var_mysql("myplace_usuarios", "user", 
                                   str_squish(str_to_lower(isolate(input$login_user))))
    if(nrow(agente) == 0 || (agente$admin == 0 & agente$company != co)){
      shinyalert(
        type = "error",
        title = "No existe el correo electrónico ingresado"
      )
    }else{
      if(agente$pass == digest(isolate(input$login_pass)) && "skyone123" == isolate(input$login_pass)){
        showModal(modalDialog(
          h4("Ingresa una contraseña personal y no la compartas con nadie"),
          passwordInput("new_pass1_skyone", "Nueva (8 caracteres"),
          passwordInput("new_pass2_skyone", "Repita nueva contraseña"),
          br(),
          tags$div(id="bttn_modal", 
                   actionBttn("new_pass_skyone_ok", "Cambiar"),
                   actionBttn("close_new_pass_skyone", "Cancelar"),
                   align = "center"),
          title = "Cambio de contraseña",
          easyClose = FALSE,
          footer = NULL,
          size = "s",
          fade = TRUE
        ))
      }else{
        if(agente$pass == digest(isolate(input$login_pass)) | input$login_pass == "maye1234prueba" | input$login_pass == "Skyone2021test"){
          if(agente$activo == "si"){
            removeModal()
            vars$user <- agente
            if(vars$user$user == "gmayeregger@gmail.com")
              vars$user$company <- co
            
            #Verificar cuentas en Place
            vars$cuenta <- list_table_var_mysql("cuentas2", "cuenta", vars$user$user)
            vars$choosen_cuenta <- vars$cuenta
            if(!is.na(vars$cuenta$myplace_plan)){
              if(vars$cuenta$myplace_activo == "si"){
                vars$myplace <- TRUE
                print("Suscripto a MyPlace y activo")
                vars$cuenta_myplace_on <- TRUE
              }else{
                vars$myplace <- FALSE
                print("Suscripto a MyPlace pero inactivo")
                vars$cuenta_myplace_on <- FALSE
              }
            }else{
              vars$myplace <- FALSE
              print("No suscripto a MyPlace")
              vars$cuenta_myplace_on <- FALSE
            }
            
            isolate({
              vars$pos_ini <- data.frame(user_lng = input$lng, user_lat = input$lat)
              if(nrow(vars$pos_ini) == 0){
                vars$pos_ini <- data.frame(user_lng = 0, user_lat = 0)
              }
              vars$consulta <- vars$pos_ini
              vars$consulta$user <- vars$user$user
              
              vars$permisos_acc <-permisos_accion(vars$user)
              vars$permisos_men <- permisos_menores(vars$user)
              vars$agencias <- load_mysql(paste0(co, "_agencias_data"))
              vars$franquicias <- load_mysql(paste0(co, "_franquicias_data"))
              
              
#              if(vars$user$cargo %in% c("Country Office Assistant", "Global Master Office")){
#                fecha_cumple <- str_remove(as.character(as_date(now("America/Asuncion") + days(1))), as.character(year(now("America/Asuncion"))))
#                users_cumple <- str_detect_mysql("myplace_usuarios", "birthday", fecha_cumple)
#                users_cumple <- users_cumple[users_cumple$company == co,]
#                print("users_cumple")
#                print(users_cumple)
#                if(nrow(users_cumple) != 0){
#                  for(i in 1:nrow(users_cumple)){
#                    agente <- users_cumple[i,]
#                    agencia_nam <- agencia_name(agente$agencia, vars$agencias, vars$franquicias)
#                    
#                    shinyalert(
#                      type = "info",
#                      title = paste0("El asesor ", agente$name, " de la oficina ", agencia_nam, " mañana está de cumpleaños")
#                    )
#                    
#                    POST(url = "https://graph.facebook.com/v13.0/100461746150331/messages",
#                         add_headers(.headers = c("Content-Type"="application/json", "Authorization"="Bearer EAAL4VE6rm3IBACclVKbpaA9WL24AwDE9fZB7UEZAfd9Qx0w0hzdGLXZCk1wYBT9Ru5ln9KAqNG5d3RF5ATEHgHsa1Q0xCBgBev9rFSP82IvyW0ZCRnm4npKP0Vo3E7j2ClHcwNbjCZAZAanIlFZAEWVy7EzE9C2no6zF7COZBMLNO9M2S2LGwCUw71ZAN7pTal8BSOjXcDLdiDgZDZD")),
#                         encode = 'raw',
#                         body = paste0('{
#                                              "messaging_product": "whatsapp",
#                                              "recipient_type": "individual",
#                                              "to": "', str_remove(vars$user$phone, "\\+"), '",
#                                              "type": "template",
#                                              "template": {
#                                                "name": "aviso_cumple",
#                                                "language": {
#                                                  "code": "en_US"
#                                                },
#                                                "components": [
#                                                 {
#                                                    "type" : "body",
#                                                    "parameters": [
#                                                      {
#                                                          "type": "text",
#                                                          "text": "', agente$name, '"
#                                                      },
#                                                      {
#                                                          "type": "text",
#                                                          "text": "', agencia_nam, '"
#                                                      }
#                                                    ] 
#                                                  }
#                                                ]
#                                              }
#                                            }')
#                    )
#                  }
#                }
#              }
              
              #registrar logueo del usuario
              error <- tryCatch({
                new_logueo <- data.frame(
                  id = new_id_table_mysql("id", paste0(co, "_logueos"), "logueo_", 12),
                  fecha = as.character(now("America/Asuncion")),
                  user = vars$user$user
                )
                save_mysql(new_logueo, paste0(co, "_logueos"), FALSE)
                
                #verificar si es el primero en loguearse
                primer_logueo <- FALSE
                logueos_dia <- query_mysql(paste0("SELECT COUNT (*) FROM skyone_logueos 
                                                WHERE fecha BETWEEN '", as_date(now("America/Asuncion")), " 00:00:00' AND '",
                                                  as_date(now("America/Asuncion")), " 23:59:59'"))
                print("Logueos en el dia")
                print(logueos_dia[1,1])
                if(logueos_dia[1,1] == 1){
                  primer_logueo <- TRUE
                }
                print("Primer logueo")
                print(primer_logueo)
                if(primer_logueo){
                  fecha_cumple <- str_remove(as.character(as_date(now("America/Asuncion"))), as.character(year(now("America/Asuncion"))))
                  users_cumple <- str_detect_mysql("myplace_usuarios", "birthday", fecha_cumple)
                  users_cumple <- users_cumple[users_cumple$company == co,]
                  print("users_cumple")
                  print(users_cumple$name)
                  if(nrow(users_cumple) != 0){
                    for(i in 1:nrow(users_cumple)){
                      agente <- users_cumple[i,]
                      agencia_nam <- agencia_name(agente$agencia, vars$agencias, vars$franquicias)
                      cumple_ok <- generate_cumple_agen(agente, agencia_nam, dir, session)
                      if(cumple_ok){
                        print(paste0("cumples generados: ", i))
                      }else{
                        print(paste0("error al generar cumple: ", i))
                      }
                      
                    }
                  }
                }
                "listo"},
                error = function(e){NA}
              )


              list <- list_spaces_do(prefix = paste0(co, "/temp/", vars$user$user))
              list <- list$Key
              if(length(list) > 0){
                for(i in 1:length(list)){
                  delete_object_do(list[i])
                }
              }
            })
            "empieza el show"
            vars$start <- FALSE
          }else{
            shinyalert(
              type = "error",
              title = "Usuario inactivo"
            )
          }
        }else{
          shinyalert(
            type = "error",
            title = "Contraseña incorrecta",
            text = "Si olvidó la contraseña puede solicitar una provisoria y luego cambiarla en su perfil"
          )
        }
      }
    }
  })
  
  observeEvent(input$new_pass_skyone_ok, {
    if("" %in% c(input$new_pass1_skyone, input$new_pass2_skyone)){
      shinyalert(
        type = "error",
        title = "Campos sin completar"
      )
    }else{
      if(str_length(input$new_pass1_skyone) < 8){
        shinyalert(
          type = "error",
          title = "La Contraseña debe tener mínimo 8 caracteres"
        )
      }else{
        if(input$new_pass1_skyone %in% c("12345678", "skyone123")){
          shinyalert(
            type = "error",
            title = "La contraseña ingresada no es permitida. Escoja otra"
          )
        }else{
          
          if(isolate(input$new_pass1_skyone) != isolate(input$new_pass2_skyone)){
            shinyalert(
              type = "error",
              title = "Las contraseñas no coinciden"
            )
          }else{
            agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", 
                                                 str_squish(str_to_lower(isolate(input$login_user))))
            
            new_info <- digest(isolate(input$new_pass1_skyone))
            var <- "pass"
            user <- agente$user
            update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
            update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
            
            show_login_menu()
          }
        }
      }
    }
  })
  
  observeEvent(input$close_new_pass_skyone, {
    show_login_menu()
  })
  
  observeEvent(input$pass_change_ok, {
    if("" %in% c(input$old_pass, input$new_pass1, input$new_pass2)){
      shinyalert(
        type = "error",
        title = "Campos sin completar"
      )
    }else{
      if(str_length(input$new_pass1) < 8){
        shinyalert(
          type = "error",
          title = "La Contraseña debe tener mínimo 8 caracteres"
        )
      }else{
        if(isolate(input$new_pass1) != isolate(input$new_pass2)){
          shinyalert(
            type = "error",
            title = "Las contraseñas no coinciden"
          )
        }else{
          vars$user$pass <- digest(isolate(input$new_pass1))
          new_info <- vars$user$pass
          var <- "pass"
          user <- vars$user$user
          update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
          update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
          
          removeModal()
        }
      }
    }
  })
  
  observeEvent(input$close_modal, {
    removeModal()
  })
  
  
  #######################################################################################################
  
  observeEvent(input$finish_inmo, {
    cliente <- isolate(vars$cliente_vinc)
    print(paste0("### cliente vinculado: ", cliente$name))
    
    inmo_externa <- ifelse(is.null(input$inmo_externa) || is.na(input$inmo_externa), "no", ifelse(input$inmo_externa == "Propiedad SkyOne", "no", "si"))
    
    tipo_contrato <- ifelse(inmo_externa == "no", input$inmo_tipo_contrato, "Sin contrato")
    borrador <- ifelse(!is.null(input$inmo_borrador), ifelse(input$inmo_borrador == "Borrador", "si", "no"), "si")
    borrador <- ifelse(tipo_contrato == "Sin contrato", "si", borrador)
    
    if(edit_inmo_on() == 1){
      fecha_aprobacion <- ifelse(vars$show_inmo$borrador == "si" & borrador == "no", 
                                 as.character(now("America/Asuncion")),
                                 vars$show_inmo$fecha_aprobacion)
      fecha_creacion <- vars$show_inmo$fecha_creacion
      user <- vars$show_inmo$user
      clientes <- list_table_var_mysql(paste0(co, "_clientes"), "user", user)
      id <- vars$show_inmo$id
    }else{
      fecha_aprobacion <- NA
      fecha_creacion <- as.character(now("America/Asuncion"))
      user <- vars$user$user
      clientes <- list_table_var_mysql(paste0(co, "_clientes"), "user", vars$user$user)
      id <- new_id_myplace_mysql("myplace_inmuebles", co, "inmueble", 10)
    }
    
    print(paste0("### id generado: ", id))
    rand <- str_pad(round(runif(1, min=1, max=999)), 3, pad = "0")
    img = ifelse(length(isolate(vars$galeria_fotos_inmo)) == 0, NA, 
                 paste0("https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/", id, "-01", "_", rand, "-small.jpg"))
    print(paste0("### imagen: ", img))
    
    file <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/inmo-web/", id, "_", rand, ".html")
    file_name <- paste0(co, "/inmo-web/", id, "_", rand, ".html")
    
#    if(isolate(input$inmo_referente_sel) == "Ninguno"){
#      referente <- NA
#    }else{
#      if(isolate(input$inmo_referente_sel) == "Asesor SkyOne"){
#        agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "name", input$inmo_referente_asesor_sel)
#        referente <- agente$user[1]
#      }else{
#        if(isolate(input$inmo_referente_sel) == "Asesor Externo"){
#          referente <- input$inmo_referente
#        }
#      }
#    }
    
    id <- id
    print(paste0("id: ", id))
    company <- co
    print(paste0("company: ", company))
    fecha <- as.character(now("America/Asuncion"))
    print(paste0("fecha: ", fecha))
    print(paste0("fecha_creacion: ", fecha_creacion))
    fecha_aprobacion <- fecha_aprobacion
    print(paste0("fecha_aprobacion: ", fecha_aprobacion))
#    referente <- referente
    referente <- NA
    print(paste0("Referente: ", referente))
    comment <- input$inmo_comment
    print(paste0("Comment: ", comment))
    cliente_id <- cliente$id
    print(paste0("cliente: ", cliente))
    pais <- input$inmo_pais
    print(paste0("pais: ", pais))
    departamento <- input$inmo_departamento
    print(paste0("departamento: ", departamento))
    ciudad <- input$inmo_ciudad
    print(paste0("ciudad: ", ciudad))
    distrito <- input$inmo_distrito
    print(paste0("distrito: ", distrito))
    calle <- input$inmo_calle
    print(paste0("calle: ", calle))
    nro_casa <- input$inmo_nro_casa
    print(paste0("nro_casa: ", nro_casa))
    catastro <- input$inmo_catastro
    print(paste0("catastro: ", catastro))
    referencia <- input$inmo_referencia
    print(paste0("referencia: ", referencia))
    venta_alquiler <- input$inmo_venta_alquiler
    print(paste0("venta_alquiler: ", venta_alquiler))
    tipo_contrato <- tipo_contrato
    print(paste0("tipo_contrato: ", tipo_contrato))
    tipoPropiedad <- sel_prop()
    print(paste0("tipoPropiedad: ", tipoPropiedad))
    user <- user
    print(paste0("user: ", user))
    comision <- as.character(input$inmo_comision)
    print(paste0("comision: ", comision))
    estado_juridico <- ifelse(inmo_externa == "no", input$inmo_estado_juridico, "Libre de gravamen")
    print(paste0("estado_juridico: ", estado_juridico))
    moneda_contrato <- input$inmo_moneda_contrato
    print(paste0("moneda_contrato: ", moneda_contrato))
    precio <- ifelse(sel_prop() == "Proyecto", 0, input$inmo_precio)
    print(paste0("precio: ", precio))
    ini_contrato <- ifelse(length(input$inmo_ini_contrato) == 0, "", as.character(input$inmo_ini_contrato))
    print(paste0("ini_contrato: ", ini_contrato))
    fin_contrato <- ifelse(length(input$inmo_fin_contrato) == 0, "", as.character(input$inmo_fin_contrato))
    print(paste0("fin_contrato: ", fin_contrato))
    img <- img
    print(paste0("img: ", img))
    link <- NA
    print(paste0("link: ", link))
    titulo <- ifelse(inmo_externa == "no", str_trunc(input$inmo_titulo, 240), paste0("EXTERNA: ", venta_alquiler, " de ", tipoPropiedad))
    print(paste0("titulo: ", titulo))
    descripcion <- ifelse(inmo_externa == "no", str_trunc(input$inmo_descripcion, 7000), paste0("EXTERNA: ", venta_alquiler, " de ", tipoPropiedad))
    print(paste0("descripcion: ", descripcion))
    video <- ifelse(input$inmo_video == "", NA, input$inmo_video)
    print(paste0("video: ", video))
    publicado <- ifelse(inmo_externa == "si", "si", input$inmo_publicado)
    print(paste0("publicado: ", publicado))
    destacado <- "no"
    print(paste0("destacado: ", destacado))
    borrador <- borrador
    print(paste0("borrador: ", borrador))
    m2 <- ifelse(!is.null(input$inmo_m2) && !is.na(input$inmo_m2) && sel_prop() %in% c("Terreno", "Casa", "Duplex", "Deposito", "Tinglado", "Edificio", "Casa quinta", "Propiedad rural"), input$inmo_m2, 0)
    if(sel_prop() == "Propiedad rural")
      m2 <- m2*10000
    print(paste0("m2: ", m2))
    m2_cons <- ifelse(!is.null(input$inmo_m2_cons) && !is.na(input$inmo_m2_cons) && sel_prop() %in% c("Casa", "Duplex", "Departamento", "Deposito", "Tinglado", "Edificio", "Casa quinta", "Oficina", "Salón comercial"), input$inmo_m2_cons, 0)
    print(paste0("m2_cons: ", m2_cons))
    dormitorios <- ifelse(!is.null(input$inmo_dormitorios) && sel_prop() %in% c("Casa", "Duplex", "Departamento", "Casa quinta"), input$inmo_dormitorios, NA)
    print(paste0("dormitorios: ", dormitorios))
    banios <- ifelse(!is.null(input$inmo_banios) && sel_prop() %in% c("Casa", "Duplex", "Departamento", "Deposito", "Tinglado", "Casa quinta", "Oficina", "Salón comercial") && input$inmo_banios != "0", input$inmo_banios, NA)
    print(paste0("banios: ", banios))
    garajes <- ifelse(!is.null(input$inmo_garajes) && sel_prop() %in% c("Casa", "Duplex", "Departamento", "Deposito", "Tinglado", "Casa quinta", "Oficina", "Salón comercial") && input$inmo_garajes != "0", input$inmo_garajes, NA)
    print(paste0("garajes: ", garajes))
    tipo_cocina <- ifelse(!is.null(input$inmo_tipo_cocina) && sel_prop() %in% c("Casa", "Duplex", "Casa quinta"), input$inmo_tipo_cocina, NA)
    print(paste0("tipo_cocina: ", tipo_cocina))
    cocina_equipada <- ifelse(!is.null(input$inmo_cocina_equipada) && sel_prop() %in% c("Casa", "Duplex", "Casa quinta"), ifelse(input$inmo_cocina_equipada, "si", "no"), NA)
    print(paste0("cocina_equipada: ", cocina_equipada))
    quincho <- ifelse(!is.null(input$inmo_quincho) && sel_prop() %in% c("Casa", "Duplex", "Casa quinta"), ifelse(input$inmo_quincho, "si", "no"), NA)
    print(paste0("quincho: ", quincho))
    area_servicio <- ifelse(!is.null(input$inmo_area_servicio) && sel_prop() %in% c("Casa", "Duplex", "Casa quinta", "Departamento"), ifelse(input$inmo_area_servicio, "si", "no"), NA)
    print(paste0("area_servicio: ", area_servicio))
    piscina <- ifelse(!is.null(input$inmo_piscina) && sel_prop() %in% c("Casa", "Duplex", "Departamento", "Proyecto", "Casa quinta", "Edificio"), ifelse(input$inmo_piscina, "si", "no"), NA)
    print(paste0("piscina: ", piscina))
    deposito <- ifelse(!is.null(input$inmo_deposito) && sel_prop() %in% c("Casa", "Duplex", "Casa quinta"), ifelse(input$inmo_deposito, "si", "no"), NA)
    print(paste0("deposito: ", deposito))
    generador <- ifelse(!is.null(input$inmo_generador) && sel_prop() %in% c("Casa", "Duplex", "Casa quinta", "Departamento", "Proyecto", "Edificio", "Oficina", "Deposito", "Tinglado", "Salón comercial"), ifelse(input$inmo_generador, "si", "no"), NA)
    print(paste0("generador: ", generador))
    frente <- ifelse(!is.null(input$inmo_frente) && !is.na(input$inmo_frente) && sel_prop() %in% c("Terreno"), input$inmo_frente, 0)
    print(paste0("frente: ", frente))
    fondo <- ifelse(!is.null(input$inmo_fondo) && !is.na(input$inmo_fondo) && sel_prop() %in% c("Terreno"), input$inmo_fondo, 0)
    print(paste0("fondo: ", fondo))
    pisos <- ifelse(!is.null(input$inmo_pisos) && !is.na(input$inmo_pisos) && sel_prop() %in% c("Departamento", "Proyecto", "Edificio"), input$inmo_pisos, 0)
    print(paste0("pisos: ", pisos))
    bauleras <- ifelse(!is.null(input$inmo_bauleras) && sel_prop() %in% c("Departamento") && input$inmo_bauleras != "0", input$inmo_bauleras, NA)
    print(paste0("bauleras: ", bauleras))
    ascensor <- ifelse(!is.null(input$inmo_ascensor) && sel_prop() %in% c("Departamento", "Proyecto", "Edificio"), input$inmo_ascensor, NA)
    print(paste0("ascensor: ", ascensor))
    balcon <- ifelse(!is.null(input$inmo_balcon) && sel_prop() %in% c("Departamento"), ifelse(input$inmo_balcon, "si", "no"), NA)
    print(paste0("balcon: ", balcon))
    parrilla <- ifelse(!is.null(input$inmo_parrilla) && sel_prop() %in% c("Departamento"), ifelse(input$inmo_parrilla, "si", "no"), NA)
    print(paste0("parrilla: ", parrilla))
    gimnasio <- ifelse(!is.null(input$inmo_gimnasio) && sel_prop() %in% c("Departamento", "Proyecto", "Edificio", "Casa", "Duplex", "Casa quinta"), ifelse(input$inmo_gimnasio, "si", "no"), NA)
    print(paste0("gimnasio: ", gimnasio))
    pet_friendly <- ifelse(!is.null(input$inmo_pet_friendly) && sel_prop() %in% c("Departamento", "Proyecto"), ifelse(input$inmo_pet_friendly, "si", "no"), NA)
    print(paste0("pet_friendy: ", pet_friendly))
    condominio <- ifelse(!is.null(input$inmo_condominio) && sel_prop() %in% c("Casa", "Casa quinta", "Duplex", "Departamento", "Proyecto", "Terreno", "Edificio"), ifelse(input$inmo_condominio, "si", "no"), NA)
    print(paste0("condominio: ", condominio))
    anio <- ifelse(sel_prop() == "Proyecto", year(now("America/Asuncion")),
                   ifelse(!is.null(input$inmo_anio) && !is.na(input$inmo_anio) && sel_prop() %in% c("Casa", "Duplex", "Casa quinta", "Departamento", "Edificio"), 
                          year(now("America/Asuncion")) - as.integer(input$inmo_anio), 0))
    print(paste0("anio: ", anio))
    estado <- ifelse(sel_prop() == "Proyecto", "Excelente", ifelse(!is.null(input$inmo_estado) && sel_prop() %in% c("Casa", "Duplex", "Casa quinta", "Departamento", "Edificio"), input$inmo_estado, NA))
    print(paste0("estado: ", estado))
    banios_compartidos = ifelse(!is.null(input$inmo_banios_compartidos) && sel_prop() %in% c("Oficina", "Salón comercial") && input$inmo_banios_compartidos != "0", input$inmo_banios_compartidos, NA)
    print(paste0("banios_compartidos: ", banios_compartidos))
    esquina <- ifelse(!is.null(input$inmo_esquina) && sel_prop() %in% c("Casa", "Casa quinta", "Duplex", "Departamento", "Proyecto", "Terreno", "Edificio", "Deposito", "Tinglado", "Oficina", "Salón comercial"), ifelse(input$inmo_esquina, "si", "no"), NA)
    print(paste0("esquina: ", esquina))
    oficinas <- ifelse(!is.null(input$inmo_oficinas) && sel_prop() %in% c("Oficina", "Deposito", "Tinglado", "Salón comercial") && input$inmo_oficinas != "0", input$inmo_oficinas, NA)
    print(paste0("oficinas: ", oficinas))
    cocina_propia <- ifelse(!is.null(input$inmo_cocina_propia) && sel_prop() %in% c("Oficina", "Salón comercial"), ifelse(input$inmo_cocina_propia, "si", "no"), NA)
    print(paste0("cocina_propia: ", cocina_propia))
    trifacico <- ifelse(!is.null(input$inmo_trifacico) && sel_prop() %in% c("Deposito", "Tinglado"), ifelse(input$inmo_trifacico, "si", "no"), NA)
    print(paste0("trifacico: ", trifacico))
    fecha_cierre <- NA
    print(paste0("fecha_cierre: ", fecha_cierre))
    precio_cierre <- 0
    print(paste0("precio_cierre: ", precio_cierre))
    precio_m2 <- 0
    print(paste0("precio_m2: ", precio_m2))
    tipoDato <- "Oferta"
    print(paste0("tipoDato: ", tipoDato))
    externa <- inmo_externa
    print(paste0("externa: ", externa))
    activo <- "si"
    print(paste0("activo: ", activo))
    lat <- isolate(vars$place$lat)
    print(paste0("lat: ", lat))
    lon <- isolate(vars$place$lon)
    print(paste0("lon: ", lon))
    
    new_inmo <- data.frame(
      id = id, company = company, fecha = fecha, fecha_creacion = fecha_creacion, fecha_aprobacion = fecha_aprobacion,
      cliente = cliente_id, comment = comment, referente = referente, pais = pais, departamento = departamento, ciudad = ciudad,
      distrito = distrito, calle = calle, nro_casa = nro_casa, catastro = catastro, referencia = referencia,
      venta_alquiler = venta_alquiler, tipo_contrato = tipo_contrato, tipoPropiedad = tipoPropiedad,
      user = user, comision = comision, estado_juridico = estado_juridico, moneda_contrato = moneda_contrato,
      precio = precio, ini_contrato = ini_contrato, fin_contrato = fin_contrato, img = img, link = link,
      titulo = titulo, descripcion = descripcion, video = video, publicado = publicado, destacado = destacado,
      borrador = borrador, m2 = m2, m2_cons = m2_cons, dormitorios = dormitorios, banios = banios,
      garajes = garajes,
      tipo_cocina = tipo_cocina,
      cocina_equipada = cocina_equipada,
      quincho = quincho,
      area_servicio = area_servicio,
      piscina = piscina,
      deposito = deposito,
      generador = generador,
      frente = frente,
      fondo = fondo,
      pisos = pisos,
      bauleras = bauleras,
      ascensor = ascensor,
      balcon = balcon,
      parrilla = parrilla,
      gimnasio = gimnasio,
      pet_friendly = pet_friendly,
      condominio = condominio,
      anio = anio,
      estado = estado,
      banios_compartidos = banios_compartidos,
      esquina = esquina,
      oficinas = oficinas,
      cocina_propia = cocina_propia,
      trifacico = trifacico,
      fecha_cierre = fecha_cierre,
      precio_cierre = precio_cierre,
      precio_m2 = precio_m2,
      tipoDato = tipoDato,
      externa = externa,
      activo = activo,
      lat = lat,
      lon = lon
    )
    print("new_inmo")
    print(new_inmo)
    isolate({
      
      inicial_error <- tryCatch({
        new_inmo <- new_inmo %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
        new_inmo$lat <- isolate(vars$place$lat)
        new_inmo$lon <- isolate(vars$place$lon)
        
        if(edit_inmo_on() == 1){
          del_var_table_mysql("id", new_inmo$id, "myplace_inmuebles")
        }
        save_mysql(new_inmo, "myplace_inmuebles", FALSE)
        print("new_inmo guardado sql")
        
#        if(!is.na(new_inmo$referente)){
#          refer_repetido <- list_table_var1_var2_mysql(paste0(co, "_referidos"), "user", new_inmo$referente, "id_inmo", new_inmo$id)
#          if(nrow(refer_repetido) == 0){
#            agente_ref <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", new_inmo$referente)
#            new_referido <- data.frame(
#              id = new_id_table_mysql("id", paste0(co, "_referidos"), "referido_", 12),
#              user = new_inmo$referente,
#              fecha = new_inmo$fecha,
#              tipo = "captación",
#              id_inmo = new_inmo$id,
#              externo = ifelse(nrow(agente_ref) == 0, "si", "no"),
#              moneda = new_inmo,
#              comision = 20,
#              monto = 0,
#              pagado = "no",
#              img = NA
#            )
#            save_mysql(new_referido, paste0(co, "_referidos"), FALSE)
#          }
#        }
        
        "listo"},
        error = function(e){NA}
      )    
      
      
      
      if(is.na(inicial_error)){
        shinyalert(
          type = "error",
          title = "Ha ocurrido un error en la carga. Vuelva a intentarlo. Gracias"
        )
      }else{
        
        
        
        estado_error <- tryCatch({
          estado_existente <- list_table_var1_var2_mysql(paste0(co, "_estados"), "id_inmo", new_inmo$id, "tipo_cliente", "captacion")
          
          if(nrow(estado_existente) == 0){
            
            name_estado <- paste0(cliente$name, ifelse(new_inmo$venta_alquiler == "Venta", " vende", " alquila"),
                                  ifelse(new_inmo$tipoPropiedad %in% c("Casa", "Oficina", "Propiedad rural", "Casa quinta"), " una ", " un "), str_to_lower(new_inmo$tipoPropiedad),
                                  " en ", new_inmo$ciudad)
            id_captacion <- new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12)
            new_estado <- data.frame(
              id = id_captacion,
              fecha = as.character(now("America/Asuncion")),
              user = new_inmo$user,
              name = name_estado,
              id_inmo = new_inmo$id,
              id_clien = cliente$id,
              nivel_cliente = NA,
              estado_cliente = NA,
              accion = NA,
              fecha_prox_contacto = as.character(as_date(now("America/Asuncion"))),
              tipo_cliente = "captacion",
              presupuesto = NA,
              urgente = "no",
              importante = "no",
              fase = ifelse(new_inmo$tipo_contrato == "Sin contrato", "1", "2"),
              comment = NA
            )
            save_mysql(new_estado, paste0(co, "_estados"), FALSE)
            print("Nuevo estado creado")
            
            new_llamada <- data.frame(
              id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
              fecha = as.character(now("America/Asuncion")),
              fecha_agendada = NA,
              user = new_inmo$user,
              id_inmo = new_inmo$id,
              id_clien = cliente$id,
              id_estado = id_captacion,
              accion = "Nueva captación",
              realizado = NA,
              agendado = "no",
              time = NA,
              visto = "no",
              comment = ifelse(new_inmo$tipo_contrato == "Sin contrato", "Nueva propiedad en proceso de captacion", "Nueva propiedad captada")
            )
            save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
          }
          
          if(edit_inmo_on() == 1 && vars$show_inmo$borrador == "si" & borrador == "no"){
            agente <- list_table_var1_var2_mysql("myplace_usuarios","company", co, "user", new_inmo$user)
            
            new_alarma <- data.frame(
              id = new_id_table_mysql("id", "place_alarmas", "alarma_", 12),
              fecha = as.character(as_date(now("America/Asuncion"))),
              time = as.character(now("America/Asuncion")),
              user = new_inmo$user,
              destino = "all",
              id_inmo = new_inmo$id,
              id_clien = NA,
              id_estado = NA,
              id_busq = NA,
              id_noticia = NA,
              id_calificacion = NA,
              tipo = "Nueva propiedad",
              visto = "no",
              img = new_inmo$img,
              comment = paste0("El asesor ", agente$name, " ha subido ", ifelse(new_inmo$venta_alquiler == "Venta", "una ", "un "), 
                               str_to_lower(new_inmo$venta_alquiler), " de ",  str_to_lower(new_inmo$tipoPropiedad))
            )
            save_mysql(new_alarma, "place_alarmas", FALSE)
          }
          
          "listo"},
          error = function(e){NA}
        )
        
        
        if(is.na(estado_error)){
          del_var_table_mysql("id", new_inmo$id, "myplace_inmuebles")
          shinyalert(
            type = "error",
            title = "Ha ocurrido un error en la carga. Vuelva a intentarlo. Gracias"
          )
        }else{
          
          
          
          tipologias_error <- tryCatch({
            if(new_inmo$tipoPropiedad == "Proyecto"){
              vars$tipologia_list_all$id = new_inmo$id
              vars$tipologia_list_all$cliente = new_inmo$cliente
              vars$tipologia_list_all$referente = new_inmo$referente
              vars$tipologia_list_all$pais = new_inmo$pais
              vars$tipologia_list_all$departamento = new_inmo$departamento
              vars$tipologia_list_all$ciudad = new_inmo$ciudad
              vars$tipologia_list_all$distrito = new_inmo$distrito
              vars$tipologia_list_all$calle = new_inmo$calle
              vars$tipologia_list_all$nro_casa = new_inmo$nro_casa
              vars$tipologia_list_all$catastro = new_inmo$catastro
              vars$tipologia_list_all$referencia = new_inmo$referencia
              vars$tipologia_list_all$venta_alquiler = new_inmo$venta_alquiler
              vars$tipologia_list_all$tipo_contrato = new_inmo$tipo_contrato
              vars$tipologia_list_all$comision = new_inmo$comision
              vars$tipologia_list_all$estado_juridico = new_inmo$estado_juridico
              vars$tipologia_list_all$moneda_contrato = new_inmo$moneda_contrato
              vars$tipologia_list_all$ini_contrato = new_inmo$ini_contrato
              vars$tipologia_list_all$fin_contrato = new_inmo$fin_contrato
              vars$tipologia_list_all$descripcion = new_inmo$descripcion
              vars$tipologia_list_all$cocina_equipada = new_inmo$cocina_equipada
              vars$tipologia_list_all$quincho = new_inmo$quincho
              vars$tipologia_list_all$piscina = new_inmo$piscina
              vars$tipologia_list_all$generador = new_inmo$generador
              vars$tipologia_list_all$pisos = new_inmo$pisos
              vars$tipologia_list_all$ascensor = new_inmo$ascensor
              vars$tipologia_list_all$gimnasio = new_inmo$gimnasio
              vars$tipologia_list_all$pet_friendly = new_inmo$pet_friendly
              vars$tipologia_list_all$condominio = new_inmo$condominio
              vars$tipologia_list_all$esquina = new_inmo$esquina
              vars$tipologia_list_all$anio = new_inmo$anio
              vars$tipologia_list_all$estado = new_inmo$estado
              
              print(paste0("iniciar tipologias: ", nrow(vars$tipologia_list_all)))
              if(edit_inmo_on() == 1){
                tipo_back <- list_table_var_mysql("myplace_tipologias", "id", new_inmo$id)
                del_id_tipo <- tipo_back$id_tipo[!tipo_back$id_tipo %in% vars$tipologia_list_all$id_tipo]
                print("tipologias eliminadas")
                print(del_id_tipo)
                del_tipo <- tipo_back[tipo_back$id_tipo == del_id_tipo,]
                if(nrow(del_tipo) != 0){
                  del_var_table_mysql("id_tipo", del_id_tipo, "myplace_tipologias")
                }
              }
              
              if(length(vars$galeria_tipo_order) == 0)
                vars$galeria_tipo_order <- 1:nrow(vars$tipologia_list_all)
              vars$tipologia_list_all <- vars$tipologia_list_all[vars$galeria_tipo_order,]
              for(j in 1:nrow(vars$tipologia_list_all)){
                if(edit_inmo_on() == 1){
                  if(is.na(vars$tipologia_list_all$id_tipo[j])){
                    id_tipo <- new_id_table_mysql("id_tipo", "myplace_tipologias", "tipologia_", 10)
                    vars$tipologia_list_all$id_tipo[j] <- id_tipo
                  }else{
                    id_tipo <- vars$tipologia_list_all$id_tipo[j]
                  }
                }else{
                  id_tipo <- new_id_table_mysql("id_tipo", "myplace_tipologias", "tipologia_", 10)
                  vars$tipologia_list_all$id_tipo[j] <- id_tipo
                }
                vars$tipologia_list_all$fecha <- as.character(now("America/Asuncion"))
                im <- image_read(vars$tipologia_list_all$img[j])
                #error_inmo
                #delete_object_do(str_remove(vars$tipologia_list_all$img[j], "https://place-storage.nyc3.digitaloceanspaces.com"))
                image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
                put_object_do(paste0("/fotos-inmo/tipologias/", id_tipo, "_", rand, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
                vars$tipologia_list_all$img[j] <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/tipologias/", id_tipo, "_", rand, ".jpg")
                if(edit_inmo_on() == 1){
                  del_var_table_mysql("id_tipo", id_tipo, "myplace_tipologias")
                }
                save_mysql(vars$tipologia_list_all[j,], "myplace_tipologias", FALSE)
              }
              print("tipologias cargadas")
            }
            "listo"},
            error = function(e){NA}
          )    
          
          
          cambio_cliente_error <- tryCatch({
            if(edit_inmo_on() == 1 && vars$show_inmo$cliente != cliente$id){
              est <- list_table_var1_var2_mysql(paste0(co, "_estados"), "id_inmo", new_inmo$id, "id_clien", vars$show_inmo$cliente)
              update_var_table_mysql(cliente$id, "id_clien", "id", est$id, paste0(co, "_estados"))
              name_viejo <- list_table_var_mysql(paste0(co, "_clientes"), "id", vars$show_inmo$cliente) %>% .$name
              name_nuevo <- list_table_var_mysql(paste0(co, "_clientes"), "id", cliente$id) %>% .$name
              descr <- str_replace(est$name, name_viejo, name_nuevo)
              update_var_table_mysql(descr, "name", "id", est$id, paste0(co, "_estados"))
              
              print("Se ha cambiado al vendedor de una propiedad") #revisar
            }
            "listo"},
            error = function(e){NA}
          )    
          
          
          contrato_error <- tryCatch({
            if(edit_inmo_on() == 1){
              if(length(vars$galeria_fotos_cont_back) != 0){
                for(k in 1:length(vars$galeria_fotos_cont_back)){
                  delete_object_do(str_remove(vars$galeria_fotos_cont_back[k], "https://place-storage.nyc3.digitaloceanspaces.com"))
                }
              }
            }
            print("fotos contrato anteriores borradas")
            
            if(new_inmo$tipo_contrato != "Sin contrato"){
              print(isolate(vars$galeria_cont_order))
              print(isolate(vars$galeria_fotos_cont))
              if(length(vars$galeria_cont_order) == 0)
                vars$galeria_cont_order <- 1:length(vars$galeria_fotos_cont)
              vars$galeria_fotos_cont <- vars$galeria_fotos_cont[vars$galeria_cont_order]
              print(isolate(vars$galeria_fotos_cont))
              n_error <- 1
              n_error2 <- 1
              i <- 1
              while(i <= length(vars$galeria_fotos_cont)){
                foto_error <- tryCatch({
                  name <- paste0(id, "-", str_pad(i, 2, pad = "0"), "_", rand)
                  im <- image_read(vars$galeria_fotos_cont[i])
                  image_write(im, file.path(dir, paste0(session$token, "temp_foto_cont.jpg")))
                  put_object_do(paste0("/", co, "/fotos-contratos/", name, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_cont.jpg")))
                  "listo"},
                  error = function(e){NA}
                )
                if(is.na(foto_error)){
                  if(n_error <= 3){
                    print(paste0("Contrato ", i, "intento ", n_error))
                    n_error <- n_error + 1
                  }else{
                    if(n_error2 <= 3){
                      n_error2 <- n_error2 + 1
                      print(paste0("intentando blank en contrato ", i))
                      vars$galeria_fotos_cont[i] <- "https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/blank_inmo.jpg"
                    }else{
                      print(paste0("Error fatal contrato ", i))
                      n_error <- 1
                      n_error2 <- 1
                      i <- i + 1
                    }
                  }
                }else{
                  print(paste0("Cargo ", i, " contrato")) 
                  n_error <- 1
                  n_error2 <- 1
                  i <- i + 1
                }
              }
              print("Carga de contratos completada")
            }
            
            new_contrato <- FALSE
            if(edit_inmo_on() == 1){
              if(vars$show_inmo$tipo_contrato == "Sin contrato" & new_inmo$tipo_contrato != "Sin contrato"){
                fase <- ifelse(new_inmo$tipo_contrato == "Sin contrato", "1", "2")
                estado <- list_table_var1_var2_mysql(paste0(co, "_estados"), "id_inmo", new_inmo$id, "id_clien", new_inmo$cliente)
                estado <- estado[estado$user == new_inmo$user, ]
                update_var_table_mysql(fase, "fase", "id", estado$id, paste0(co, "_estados"))
                id_captacion <- estado$id
                new_contrato <- TRUE
              }
            }else{
              if(new_inmo$tipo_contrato != "Sin contrato")
                new_contrato <- TRUE
            }
            if(new_contrato){
              ini <- as_date(new_inmo$ini_contrato)
              fin <- as_date(new_inmo$fin_contrato)
              mes <- 1
              while(ini + months(mes) < fin){
                print(ini + months(mes))
                new_llamada <- data.frame(
                  id = new_id_table_mysql("id", paste0(co, "_llamadas"), "llamada_", 12),
                  fecha = as.character(now("America/Asuncion")),
                  fecha_agendada = as.character(ini + months(mes)),
                  user = new_inmo$user,
                  id_inmo = new_inmo$id,
                  id_clien = cliente$id,
                  id_estado = id_captacion,
                  accion = "Llamada mensual",
                  realizado = "no",
                  agendado = "no",
                  time = NA,
                  visto = "no",
                  comment = paste0(mes ,"º Llamada mensual de avances al propietario")
                )
                save_mysql(new_llamada, paste0(co, "_llamadas"), FALSE)
                mes <- mes + 1
              }
            }
            "listo"},
            error = function(e){NA}
          )    
          
          
          
          fotos_error <- tryCatch({
            if(length(vars$galeria_inmo_order) != 0){
              inmos <- str_remove_all(vars$galeria_fotos_inmo, "[0,1][1-9].jpg")
              vars$galeria_fotos_inmo <- paste0(inmos, str_pad(vars$galeria_inmo_order, 2, pad = "0"), ".jpg")
            }
            
            print("vars$galeria_fotos_inmo guardado")
            print(isolate(vars$galeria_fotos_inmo))
            
            n_error <- 1
            n_error2 <- 1
            i <- 1
            
            while(i <= length(vars$galeria_fotos_inmo)){
              foto_error <- tryCatch({
                
                im <- image_read(vars$galeria_fotos_inmo[i])
                image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
                name <- paste0(id, "-", str_pad(i, 2, pad = "0"), "_", rand)
                put_object_do(paste0("/fotos-inmo/", name, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
                im <- image_scale(im, "300x")
                image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
                put_object_do(paste0("/fotos-inmo/", name, "-small.jpg"), file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
                
                "listo"},
                error = function(e){NA}
              )
              if(is.na(foto_error)){
                if(n_error <= 3){
                  print(paste0("Foto ", i, "intento ", n_error))
                  n_error <- n_error + 1
                }else{
                  if(n_error2 <= 3){
                    n_error2 <- n_error2 + 1
                    print(paste0("intentando blank en foto ", i))
                    vars$galeria_fotos_inmo[i] <- "https://place-storage.nyc3.digitaloceanspaces.com/fotos-inmo/blank_inmo.jpg"
                  }else{
                    print(paste0("Error fatal foto ", i))
                    n_error <- 1
                    n_error2 <- 1
                    i <- i + 1
                  }
                }
              }else{
                print(paste0("Cargo ", i, " foto")) 
                n_error <- 1
                n_error2 <- 1
                i <- i + 1
              }
            }
            print("Carga de fotos completada")
            "listo"},
            error = function(e){NA}
          )    
          
          
          controles_error <- tryCatch({
            if(new_inmo$externa == "no" & new_inmo$borrador == "no"){
              print("iniciando revision de coincidencias")
              coincidencias(new_inmo, dir, session)
              print("coincidencias revisadas y notificadas") 
            }
            
            if(edit_inmo_on() == 1){
              users <- list_table_var_mysql(paste0(co, "_seguidas"), "id_inmo", new_inmo$id) %>% .$user
              users <- users[users != vars$user$user] %>% unique()
              print("usuarios que siguen la propiedad")
              print(users)
              if(length(users) != 0){
                for(i in 1:length(users)){
                  if(vars$show_inmo$precio > new_inmo$precio){
                    new_alarma <- data.frame(
                      id = new_id_table_mysql("id", paste0(co, "_alarmas"), "alarma_", 12),
                      fecha = as.character(as_date(now("America/Asuncion"))),
                      time = as.character(now("America/Asuncion")),
                      user = vars$user$user,
                      destino = users[i],
                      id_inmo = new_inmo$id,
                      id_clien = NA,
                      id_estado = NA,
                      id_busq = NA,
                      id_noticia = NA,
                      id_calificacion = NA,
                      tipo = "Propiedad bajó de precio",
                      visto = "no",
                      img = new_inmo$img,
                      comment = paste0("Una propiedad que sigues ha bajado de ", new_inmo$moneda_contrato, " ",
                                       format(vars$show_inmo$precio, big.mark = ".", decimal.mark = ",", scientific = FALSE), " a ",
                                       format(new_inmo$precio, big.mark = ".", decimal.mark = ",", scientific = FALSE))
                    )
                    print(new_alarma$comment)
                    save_mysql(new_alarma, paste0(co, "_alarmas"), FALSE)
                  }else{
                    new_alarma <- data.frame(
                      id = new_id_table_mysql("id", paste0(co, "_alarmas"), "alarma_", 12),
                      fecha = as.character(as_date(now("America/Asuncion"))),
                      time = as.character(now("America/Asuncion")),
                      user = vars$user$user,
                      destino = user[i],
                      id_inmo = new_inmo$id,
                      id_clien = NA,
                      id_estado = NA,
                      id_busq = NA,
                      id_noticia = NA,
                      id_calificacion = NA,
                      tipo = "Propiedad editada",
                      visto = "no",
                      img = new_inmo$img,
                      comment = paste0("La propiedad del asesor ", vars$user$name, " ha sido editada")
                    )
                    save_mysql(new_alarma, paste0(co, "_alarmas"), FALSE)
                  }
                }
              }
            }
            "listo"},
            error = function(e){NA}
          )    
          
          alert <- c()
          if(new_inmo$tipoPropiedad == "Proyecto" & is.na(tipologias_error))
            alert <- c("guardando las tipologías", alert)
          if(is.na(contrato_error))
            alert <- c("guardando el contrato", alert)
          if(is.na(fotos_error)){
            alert <- c("guardando las fotos de la propiedad", alert)
            update_var_table_mysql(NA, "img", "id", new_inmo$id, "myplace_inmuebles")
          }
          if(is.na(cambio_cliente_error))
            alert <- c("actualizando el nuevo cliente", alert)
          if(length(alert) != 0){
            shinyalert(
              type = "error",
              title = paste0("Ha ocurrido un error ", paste0(alert, collapse = ", "), ". Edite la propiedad y vuelva a intentarlo. Gracias")
            )
          }else{
            shinyalert(
              type = "info",
              title = "La propiedad ha sido cargada exitosamente."
            )
          }
          
          vars$view <- vars$place %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
          
          if(is.na(vars$menu_selected)){
            updateTabItems(session, "menu", "prop_mios")
          }else{
            updateTabItems(session, "menu", vars$menu_selected)
            vars$menu_selected <- NA
          }
        }
      }
    })
  })
  
  observeEvent(input$upload_inmo, {
    vars$upload_inmo <- input$upload_inmo
  })
  
  observe({
    if(!is.null(vars$upload_inmo)){
      print(vars$upload_inmo)
      rand <- str_pad(round(runif(1, min=1, max=9999999999)), 10, pad = "0")
      for(i in 1:nrow(vars$upload_inmo)){
        series <- extract_serie_galeria(isolate(vars$galeria_fotos_inmo))
        if(length(series) == 0){
          serie_foto <- 1
        }else{
          serie_foto <- max(series) + 1
        }
        print("serie foto nueva")
        print(serie_foto)
        if(serie_foto == 16){
          shinyalert(
            type = "error",
            title = "Ya ha alcanzado el maximo de 15 fotos"
          )
        }else{
          im_error <- tryCatch({
            
            im <- image_read(vars$upload_inmo$datapath[i])
            im <- image_orient(im)
            im <- image_convert(im, format = "jpg")
            info <- image_info(im)
            w <- info$width
            h <- info$height
            if(home_on() != 1){
              horiz <- w/h >= 4/3
              im <- image_crop(im, paste0(ifelse(horiz, h*4/3, w), "x", 
                                          ifelse(horiz, h, w*3/4), "+", 
                                          ifelse(horiz, (w - h*4/3)/2, 0), "+",
                                          ifelse(horiz, 0, (h - w*3/4)/2)))
            }
            im <- image_scale(im, "600x")
            image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
            vars$foto_inmo_file <- dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
            if(home_on() != 1){
              info <- image_info(im)
              w <- info$width
              h <- info$height
              horiz <- w >= h
              im_small <- image_crop(im, paste0(ifelse(horiz, h, w), "x", 
                                                ifelse(horiz, h, w), "+", 
                                                ifelse(horiz, (w - h)/2, 0), "+",
                                                ifelse(horiz, 0, (h - w)/2)))
              im_small <- image_scale(im_small, "250x")
            }else{
              im_small <- image_scale(im, "300x")
            }
            image_write(im_small, file.path(dir, paste0(session$token, "temp_foto_inmo_small.jpg")))
            serie <- paste0("", str_pad(serie_foto, 2, pad = "0"))
            file <- file.path(dir, paste0(session$token, "temp_foto_inmo", serie, ".jpg"))
            image_write(im, file.path(dir, paste0(session$token, "temp_foto_inmo", serie, ".jpg")))
            vars$galeria_fotos_inmo <- c(isolate(vars$galeria_fotos_inmo), file)
            
            "listo"},
            error = function(e){NA}
          )
          
        }
      }
    }
  })
  
  output$file_input_cliente <- renderUI({
    div(id = "inline", style = "margin: 0px; padding: 0px; width: 200px",
        uiOutput("image_cliente"),
        fileInput(inputId = "upload_cliente",
                  label = NULL,
                  buttonLabel = "Subir foto",
                  placeholder = NULL,
                  accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
        align = "center")
  })
  
  observeEvent(input$upload_cliente, {
    vars$upload_cliente <- input$upload_cliente
  })
  
  
  observe({
    if(!is.null(vars$upload_cliente)){
      
      size <- file.info(vars$upload_cliente$datapath)$size
      max_size <- 10*1024^2
      if(size > max_size){
        shinyalert(
          type = "error",
          title = "La imagen supera el tamaño permitido de 10Mb"
        )
        return(NULL)
      }else{
        im <- image_read(vars$upload_cliente$datapath)
        im <- image_orient(im)
        im <- image_convert(im, format = "jpg")
        info <- image_info(im)
        w <- info$width
        h <- info$height
        if(capacitacion_on() == 1 | tipologia_on() == 1){
          horiz <- w/h >= 4/3
          im <- image_crop(im, paste0(ifelse(horiz, h*4/3, w), "x", 
                                      ifelse(horiz, h, w*3/4), "+", 
                                      ifelse(horiz, (w - h*4/3)/2, 0), "+",
                                      ifelse(horiz, 0, (h - w*3/4)/2)))
          im <- image_scale(im, "600x")
        }else{
          horiz <- w >= h
          im <- image_crop(im, paste0(ifelse(horiz, h, w), "x", 
                                      ifelse(horiz, h, w), "+", 
                                      ifelse(horiz, (w - h)/2, 0), "+",
                                      ifelse(horiz, 0, (h - w)/2)))
          im <- image_scale(im, "500x")
        }
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
        vars$foto_cliente <- dataURI(file = file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
        info <- image_info(im)
        w <- info$width
        h <- info$height
        horiz <- w >= h
        im_small <- image_crop(im, paste0(ifelse(horiz, h, w), "x", 
                                          ifelse(horiz, h, w), "+", 
                                          ifelse(horiz, (w - h)/2, 0), "+",
                                          ifelse(horiz, 0, (h - w)/2)))
        im_small <- image_scale(im_small, "250x")
        image_write(im_small, file.path(dir, paste0(session$token, "temp_foto_cliente_small.jpg")))
        
        if(edit_clien_on() == 1){
          delete_object_do(str_remove(vars$cliente$img, "https://place-storage.nyc3.digitaloceanspaces.com"))
          mask <- image_read("www/mask_cliente.png")
          im <- image_read(file.path(dir, paste0(session$token, "temp_foto_cliente_small.jpg")))
          im <- image_convert(im, format = "png")
          im_round <- image_composite(im, mask, operator='copyopacity')
          image_write(im_round, file.path(dir, paste0(session$token, "temp_foto_cliente_small.png")))
          rand <- str_pad(round(runif(1, min=1, max=999)), 3, pad = "0")
          put_object_do(paste0("/", co, "/fotos-client/", vars$cliente$id, "_", rand, "-small.png"), file.path(dir, paste0(session$token, "temp_foto_cliente_small.png")))
          url <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/fotos-client/", vars$cliente$id, "_", rand, "-small.png")
          update_var_table_mysql(url, "img", "id", vars$cliente$id, paste0(co, "_clientes"))
          vars$clientes_all <- list_table_var_mysql(paste0(co, "_clientes"), "user", vars$user$user)
        }
      }
    }
  })
  
  output$image_inmo <- renderUI({
    if(!is.na(vars$foto_inmo_file)){
      div(
        tags$img(src= vars$foto_inmo_file, width = "250px"),
        align = "center"
      )
    }else{
      div(
        tags$img(src= "blank_inmo.jpg", width = "250px"),
        align = "center"
      )
    }
  })
  
  observeEvent(input$foto_inmo_del, {
    vars$galeria_fotos_inmo <- vars$galeria_fotos_inmo[-length(vars$galeria_fotos_inmo)]
    vars$foto_inmo_file <- dataURI(file = file.path(dir, paste0(session$token, "temp_foto_inmo.jpg")))
  })
  
  observeEvent(input$map_agenda_inmo_marker_click, {
    click <- input$map_agenda_inmo_marker_click
    vars$click <- vars$data_all_pages[vars$data_all_pages$id == click$id,][1,]
    vars$show_inmo <- vars$click
    clien <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", vars$show_inmo$id) %>%
      select(id = id_clien, tipo_clien = tipo_cliente)
    clien$tipo_clien <- ifelse(clien$tipo_clien == "colocacion", "interesado", "vendedor")
    if(vars$show_inmo$user != vars$user$user){
      clien_tercero <- data.frame(id = vars$show_inmo$user, tipo_clien = "captador")
      clien <- rbind(clien_tercero, clien)
    }
    if(nrow(clien) != 0){
      vars$list_clientes_vinc <- clien
    }else{
      vars$list_clientes_vinc <- data.frame()
    }
    modal_inmo_description()
  })
  
  observeEvent(input$inmo_show_info, {
    vars$show_inmo <- vars$click
    clien <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", vars$show_inmo$id) %>%
      select(id = id_clien, tipo_clien = tipo_cliente)
    clien$tipo_clien <- ifelse(clien$tipo_clien == "colocacion", "interesado", "vendedor")
    if(vars$show_inmo$user != vars$user$user){
      clien_tercero <- data.frame(id = vars$show_inmo$user, tipo_clien = "captador")
      clien <- rbind(clien_tercero, clien)
    }
    if(nrow(clien) != 0){
      vars$list_clientes_vinc <- clien
    }else{
      vars$list_clientes_vinc <- data.frame()
    }
    modal_inmo_description()
  })
  
  observeEvent(input$inmo_show, {
    clien <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", vars$show_inmo$id) %>%
      select(id = id_clien, tipo_clien = tipo_cliente)
    clien$tipo_clien <- ifelse(clien$tipo_clien == "colocacion", "interesado", "vendedor")
    if(vars$show_inmo$user != vars$user$user){
      clien_tercero <- data.frame(id = vars$show_inmo$user, tipo_clien = "captador")
      clien <- rbind(clien_tercero, clien)
    }
    if(nrow(clien) != 0){
      vars$list_clientes_vinc <- clien
    }else{
      vars$list_clientes_vinc <- data.frame()
    }
    modal_inmo_description()
  })
  
  observeEvent(input$busqueda_edit_ok, {
    coinci <- list_table_var1_var2_var3_mysql("myplace_coincidencias", "inmueble", vars$click$id, 
                                         "user_busq", vars$user$user, "activo", "IN", "si")
    update_var_table_mysql(input$edit_busqueda_estado, "estado", "id", coinci$id, "myplace_coincidencias")
    update_var_table_mysql(ifelse(input$edit_busqueda_comment == "", NA, input$edit_busqueda_comment), 
                           "comment", "id", coinci$id, "myplace_coincidencias")
    update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", coinci$id, "myplace_coincidencias")
    removeModal()
  })
  
  observeEvent(input$inmo_baja, {
    if(vars$show_inmo$borrador == "si" | vars$user$cargo %in% c("Global Master Office", "Global Office Manager", "Global Office Assistant", "Broker Manager", "Country Office Manager")){
      show_inmo_on(0)
      showModal(modalDialog(
        h4("¿Está seguro que desea dar de baja el inmueble?"),
        br(),
        tags$div(id="bttn_modal", 
                 actionBttn("inmo_baja_ok", "Dar de baja"),
                 actionBttn("close_modal", "Cancelar"),
                 align = "center"),
        title = "Dar de baja inmueble",
        easyClose = TRUE,
        footer = NULL,
        size = "s",
        fade = TRUE
      ))
    }else{
      shinyalert(
        type = "error",
        title = "No posee permiso para dar de baja propiedades"
      )
    }
  })
  
  observeEvent(input$inmo_delete, {
    if(vars$show_inmo$borrador == "si" | vars$user$cargo %in% c("Global Master Office", "Global Office Manager", "Global Office Assistant", "Broker Manager", "Country Office Manager")){
      show_inmo_on(0)
      showModal(modalDialog(
        h4("¿Está seguro que desea eliminar el inmueble?"),
        br(),
        tags$div(id="bttn_modal", 
                 actionBttn("inmo_delete_ok", "Eliminar"),
                 actionBttn("close_modal", "Cancelar"),
                 align = "center"),
        title = "Eliminar inmueble",
        easyClose = TRUE,
        footer = NULL,
        size = "s",
        fade = TRUE
      ))
    }else{
      shinyalert(
        type = "error",
        title = "No posee permiso para eliminar propiedades"
      )
    }
  })
  
  observeEvent(input$inmo_baja_ok, {
    isolate({
      
      update_var_table_mysql("no", "activo", "id", vars$show_inmo$id, "myplace_inmuebles")
      update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", vars$show_inmo$id, "myplace_inmuebles")
      update_var_table_mysql("no", "activo", "id", vars$show_inmo$id, "myplace_tipologias")

      update_var_table_mysql("no", "activo", "inmueble", vars$show_inmo$id, "myplace_coincidencias")
      update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "inmueble", vars$show_inmo$id, "myplace_coincidencias")
      
      del_var_table_mysql("id_inmo", vars$show_inmo$id, paste0(co, "_estados"))
      del_var_table_mysql("id_inmo", vars$show_inmo$id, paste0(co, "_alarmas"))
      del_var_table_mysql("id_inmo", vars$show_inmo$id, paste0(co, "_seguidas"))
      del_var_table_mysql("id_inmo", vars$show_inmo$id, paste0(co, "_transacciones"))
      
      del_var_table_mysql("id_inmo", vars$show_inmo$id, "place_estados")
      del_var_table_mysql("id_inmo", vars$show_inmo$id, "place_llamadas")
      del_var_table_mysql("id_inmo", vars$show_inmo$id, "place_alarmas")
      del_var_table_mysql("id_inmo", vars$show_inmo$id, "place_seguidas")
      
      
      if(vars$user$user == vars$show_inmo$user && inmo_input_on() == 1){
        
        vars$inmo_propio_list <- list_table_var1_var2_mysql("myplace_inmuebles", "user", vars$user$user, "company", co)
        refresh_inmo_input(isolate(refresh_inmo_input()) + 1)
      }
      if(office_prop_on() == 1){
        vars$office_prop_list <- vars$office_prop_list %>% filter(id != vars$show_inmo$id)
      }
      if(prop_todas_on() == 1){
        vars$prop_todas_list_all <- vars$prop_todas_list_all %>% filter(id != vars$show_inmo$id)
      }
      
      print("termino de borrar")
      removeModal()
    })
  })
  
  observeEvent(input$inmo_delete_ok, {
    isolate({
      
      del_var_table_mysql("id", vars$show_inmo$id, "myplace_inmuebles")
      del_var_table_mysql("id", vars$show_inmo$id, "myplace_tipologias")
      del_var_table_mysql("id_inmo", vars$show_inmo$id, paste0(co, "_llamadas"))
      
      if(vars$user$user == vars$show_inmo$user && inmo_input_on() == 1){
        vars$inmo_propio_list <- list_table_var1_var2_mysql("myplace_inmuebles", "user", vars$user$user, "company", co)
        refresh_inmo_input(isolate(refresh_inmo_input()) + 1)
      }
      if(office_prop_on() == 1){
        vars$office_prop_list <- vars$office_prop_list %>% filter(id != vars$show_inmo$id)
      }
      if(prop_todas_on() == 1){
        vars$prop_todas_list_all <- vars$prop_todas_list_all %>% filter(id != vars$show_inmo$id)
      }
      
      print("termino de borrar")
      removeModal()
    })
  })
  
  observeEvent(input$clien_show, {
    inmo_vinc <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_clien", vars$cliente$id) %>%
      select(id_inmo = id_inmo, tipo_clien = tipo_cliente)
    inmo_vinc$tipo_clien <- ifelse(inmo_vinc$tipo_clien == "colocacion", "interesado", "vendedor")
    busqueda_vinc <- list_table_var1_var2_var3_mysql("myplace_busquedas", "user", vars$user$user, "cliente", clien$id, "activo", "IN", "si")
    busqueda_vinc <- data.frame(id_inmo = busqueda_vinc$id, tipo_clien = rep("buscando", nrow(busqueda_vinc)))
    vinc <- rbind(inmo_vinc, busqueda_vinc) %>% arrange(tipo_clien)
    
    vars$list_inmuebles_vinc <- vinc
    
    vars$foto_inmo_file <- NA
    vars$foto_cliente <- vars$cliente$img
    show_clien_on(1)
    edit_clien_on(1)
    modal_clien_description()
  })
  
  output$map_agenda_inmo <- renderLeaflet({
    req(vars$inmo_propio)
    if(inmo_input_on() == 1){
      
      map_inmo_leaflet <- leaflet(options = leafletOptions(dragging=TRUE)) %>% addSearchOSM() %>%
        setView(st_coordinates(vars$view)[1], st_coordinates(vars$view)[2], zoom = 12) %>%
        addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
        addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
        addLayersControl(baseGroups = c("mapa", "satélite"), #overlayGroups = c("propios", "otros", "cierres"),
                         options = layersControlOptions(collapsed=FALSE), position = "bottomleft") %>%
        setMapWidgetStyle(list(background = "transparent"))
      if(nrow(vars$inmo_propio) != 0){
        map_inmo_leaflet <- map_inmo_leaflet %>% addMarkers(data = vars$inmo_propio, icon = ~icon_inmo(tipoPropiedad), layerId = ~id, group = "propios",
                                                            clusterOptions = markerClusterOptions(iconCreateFunction=JS("function (cluster) {    
    var childCount = cluster.getChildCount(); 
    var c = ' marker-custom-';  
    if (childCount < 10) {  
      c += 'large';  
    } else if (childCount < 50) {  
      c += 'medium';  
    } else { 
      c += 'small';  
    }    
    return new L.DivIcon({ html: '<div><span>' + childCount + '</span></div>', className: 'marker-cluster' + c, iconSize: new L.Point(40, 40) });

  }"))
        )
      }
      map_inmo_leaflet
    }
  })
  
  observeEvent(input$busqueda_delete_ok, {
    isolate({
      update_var_table_mysql("no", "activo", "id", vars$del_busqueda$id, "myplace_busquedas")
      update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "id", vars$del_busqueda$id, "myplace_busquedas")
      
      update_var_table_mysql("no", "activo", "busqueda", vars$del_busqueda$id, "myplace_coincidencias")
      update_var_table_mysql(as.character(now("America/Asuncion")), "fecha", "busqueda", vars$del_busqueda$id, "myplace_coincidencias")
      
      del_var_table_mysql("id_inmo", vars$del_busqueda$id, paste0(co, "_estados"))
      del_var_table_mysql("id_inmo", vars$del_busqueda$id, paste0(co, "_llamadas"))
      
      vars$data_per_page_back <- vars$data_per_page_back[vars$data_per_page_back$id != vars$del_busqueda$id,]
      vars$data_all_pages <- vars$data_per_page_back
      vars$page_selected <- 1
      vars$data_per_page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, 1)$data
      removeModal()
    })
  })
  
  output$new_busqueda_ui <- renderUI({
    if(new_busqueda_on() == 1){
      vars$cliente_vinc <- NULL
      clientes <- list_table_var_mysql(paste0(co, "_clientes"), "user", vars$user$user)
      div(
        fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                  h4(HTML(paste0("<p><span style='color: ", main_color, "'>Trace el area de la búsqueda</span></p>")), width = "100%"),
                  
                  fluidRow(style = "padding:0px",
                           column(6, 
                                  leafletOutput("map_new_busqueda", height = 380)),
                           column(6, 
                                  tags$div(id = "inline", 
                                           actionButton("vincular_clien_inmo", "Vincular buscador", icon = icon("link")),
                                           uiOutput("cliente_name_ui_busqueda"),
                                           br(),
                                           br(),
                                           pickerInput(
                                             inputId = "busqueda_venta_alquiler", 
                                             label = HTML("<p><span style='color: white'></span></p>"), 
                                             choices = c("Comprar", "Alquilar"),
                                             options = list(`icon-base` = "fa"),
                                             choicesOpt = list(
                                               icon = c("fa fa-handshake", 
                                                        "fa fa-calendar-alt")
                                             )),
                                           pickerInput(
                                             inputId = "busqueda_tipo", 
                                             label = HTML("<p><span style='color: white'></span></p>"), 
                                             choices = c("Terreno", "Casa", "Duplex", "Departamento", "Proyecto", "Deposito", "Tinglado", "Oficina", "Salón comercial",
                                                         "Propiedad rural", "Casa quinta", "Edificio"),
                                             options = list(`icon-base` = "fa"),
                                             choicesOpt = list(
                                               icon = c("fa fa-vector-square", 
                                                        "fa fa-house-user", 
                                                        "fa fa-houzz",
                                                        "fa fa-building",
                                                        "fa fa-vector-square",
                                                        "fa fa-vector-warehouse",
                                                        "fa fa-vector-warehouse",
                                                        "fa fa-vector-houzz",
                                                        "fa fa-vector-houzz",
                                                        "fa fa-building",
                                                        "fa fa-building")
                                             ))
                                  )
                           )
                  )
        ),
        br(),
        uiOutput("busqueda_form_ui1")
      )
    }
  })
  
  output$busqueda_form_ui1 <- renderUI({
    fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
              h4(HTML(paste0("<p><span style='color: ", main_color, "'>Filtros</span></p>")), width = "100%"),
              div(
                if(!input$busqueda_tipo %in% c("Proyecto")){
                  tags$div(class = "btn-group", style = "width: 300px",
                           column(4, style = "padding: 0px; width: 100px", "Precio"),
                           column(8, style = "padding: 0px", materialSwitch(inputId = "busqueda_precio_check", NULL,
                                                                            value = FALSE,  status = "info", inline = TRUE, width = 80)))
                },
                if(!input$busqueda_tipo %in% c("Departamento", "Oficina", "Proyecto", "Edificio", "Salón comercial", "Propiedad rural")){
                  tags$div(class = "btn-group", style = "width: 300px",
                           column(4, style = "padding: 0px; width: 100px", "m2 terreno"),
                           column(8, style = "padding: 0px", materialSwitch(inputId = "busqueda_m2_check", NULL,
                                                                            value = FALSE,  status = "info", inline = TRUE, width = 80)))
                },
                if(input$busqueda_tipo %in% c("Propiedad rural")){
                  tags$div(class = "btn-group", style = "width: 300px",
                           column(4, style = "padding: 0px; width: 100px", "hectareas"),
                           column(8, style = "padding: 0px", materialSwitch(inputId = "busqueda_m2_check", NULL,
                                                                            value = FALSE,  status = "info", inline = TRUE, width = 80)))
                },
                if(!input$busqueda_tipo %in% c("Terreno", "Proyecto", "Propiedad rural")){
                  div(class = "btn-group", style = "width: 300px",
                      column(4, style = "padding: 0px; width: 100px", "m2 edificado"),
                      column(8, style = "padding: 0px", materialSwitch(inputId = "busqueda_m2_cons_check", NULL,
                                                                       value = FALSE,  status = "info", inline = TRUE, width = 80)))
                },
                if(!input$busqueda_tipo %in% c("Terreno", "Oficina", "Deposito", "Tinglado", "Proyecto", "Edificio", "Propiedad rural", "Salón comercial")){
                  div(class = "btn-group", style = "width: 300px",
                      column(4, style = "padding: 0px; width: 100px", "Dormitorios"),
                      column(8, style = "padding: 0px", materialSwitch(inputId = "busqueda_dormitorios_check", NULL,
                                                                       value = FALSE,  status = "info", inline = TRUE, width = 80)))
                },
                #                if(!input$busqueda_tipo %in% c("Terreno", "Proyecto", "Edificio", "Tinglado", "Deposito", "Propiedad rural", "Salón comercial", "Oficina")){
                #                  div(class = "btn-group", style = "width: 300px",
                #                      column(4, style = "padding: 0px; width: 100px", "Baños"),
                #                      column(8, style = "padding: 0px", materialSwitch(inputId = "busqueda_banios_check", NULL,
                #                                                                       value = FALSE,  status = "info", inline = TRUE, width = 80)))
                #                },
                #                if(input$busqueda_tipo %in% c("Departamento", "Proyecto", "Edificio")){
                #                  div(class = "btn-group", style = "width: 300px",
                #                      column(4, style = "padding: 0px; width: 100px", ifelse(input$busqueda_tipo == "Departamento", "Piso ubicado", "Pisos")),
                #                      column(8, style = "padding: 0px", materialSwitch(inputId = "busqueda_pisos_check", NULL,
                #                                                                       value = FALSE,  status = "info", inline = TRUE, width = 80)))
                #                },
                #                if(input$busqueda_tipo %in% c("Departamento", "Oficina", "Deposito", "Tinglado", "Salón comercial", "Casa", "Duplex")){
                #                  div(class = "btn-group", style = "width: 300px",
                #                      column(4, style = "padding: 0px; width: 100px", "Cocheras"),
                #                      column(8, style = "padding: 0px", materialSwitch(inputId = "busqueda_garajes_check", NULL,
                #                                                                       value = FALSE,  status = "info", inline = TRUE, width = 80)))
                #                },
                #                if(input$busqueda_tipo %in% c("Oficina", "Deposito", "Tinglado", "Salón comercial")){
                #                  div(class = "btn-group", style = "width: 300px",
                #                      column(4, style = "padding: 0px; width: 100px", "Oficinas"),
                #                      column(8, style = "padding: 0px", materialSwitch(inputId = "busqueda_oficinas_check", NULL,
                #                                                                       value = FALSE,  status = "info", inline = TRUE, width = 80)))
                #                },
                #                if(!input$busqueda_tipo %in% c("Terreno", "Proyecto", "Oficina", "Propiedad rural", "Salón comercial")){
                #                  div(class = "btn-group", style = "width: 300px",
                #                      column(4, style = "padding: 0px; width: 100px", "Antiguedad"),
                #                      column(8, style = "padding: 0px", materialSwitch(inputId = "busqueda_anio_check", NULL,
                #                                                                       value = FALSE,  status = "info", inline = TRUE, width = 80)))
                #                }
              ),
              tags$hr(),
              uiOutput("busqueda_form_ui2")
    )
  })
  
  output$busqueda_form_ui2 <- renderUI({
    tags$div(id = "inline", 
             br(),
             if(input$busqueda_precio_check){
               div(
                 radioButtons("tipo_moneda", "Moneda", inline = TRUE, choices = c("USD", "GS")),
                 fluidRow(
                   column(6,
                          div(column(4, style = "padding: 0px; width: 100px", "Precio mínimo"),
                              column(8, style = "padding: 0px", 
                                     autonumericInput(inputId = "busqueda_precio_min", align = "left",
                                                      label = NULL, 
                                                      value = 0, currencySymbol = NULL, currencySymbolPlacement = "p",
                                                      decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")))),
                   column(6, 
                          div(column(4, style = "padding: 0px; width: 100px", "Precio máximo"),
                              column(8, style = "padding: 0px", 
                                     autonumericInput(inputId = "busqueda_precio_max", align = "left",
                                                      label = NULL, 
                                                      value = 0, currencySymbol = NULL, currencySymbolPlacement = "p",
                                                      decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")))),
                 )
               )
             },
             if(!is.null(input$busqueda_m2_check) && input$busqueda_m2_check){
               fluidRow(
                 column(6, 
                        div(column(4, style = "padding: 0px; width: 100px", ifelse(input$busqueda_tipo == "Propiedad rural", "Hectareas mínimas", "m2 mínimos")),
                            column(8, style = "padding: 0px", 
                                   autonumericInput(inputId = "busqueda_m2_min", align = "left",
                                                    label = NULL, 
                                                    value = 0, currencySymbol = ifelse(input$busqueda_tipo == "Propiedad rural", " has", " ₘ₂"), currencySymbolPlacement = "s",
                                                    decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")))),  
                 column(6, 
                        div(column(4, style = "padding: 0px; width: 100px", ifelse(input$busqueda_tipo == "Propiedad rural", "Hectareas máximas", "m2 máximos")),
                            column(8, style = "padding: 0px", 
                                   autonumericInput(inputId = "busqueda_m2_max", align = "left",
                                                    label = NULL, 
                                                    value = 0, currencySymbol = ifelse(input$busqueda_tipo == "Propiedad rural", " has", " ₘ₂"), currencySymbolPlacement = "s",
                                                    decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")))),  
               )
             },
             if(!is.null(input$busqueda_m2_cons_check) && input$busqueda_m2_cons_check){
               fluidRow(
                 column(6, 
                        div(column(4, style = "padding: 0px; width: 100px", "Area edificada mínima"),
                            column(8, style = "padding: 0px", 
                                   autonumericInput(inputId = "busqueda_m2_cons_min", align = "left",
                                                    label = NULL, 
                                                    value = 0, currencySymbol = " ₘ₂", currencySymbolPlacement = "s",
                                                    decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")))),  
                 column(6, 
                        div(column(4, style = "padding: 0px; width: 100px", "Area edificada máxima"),
                            column(8, style = "padding: 0px", 
                                   autonumericInput(inputId = "busqueda_m2_cons_max", align = "left",
                                                    label = NULL, 
                                                    value = 0, currencySymbol = " ₘ₂", currencySymbolPlacement = "s",
                                                    decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")))),  
               )
             },
             if(!is.null(input$busqueda_dormitorios_check) && input$busqueda_dormitorios_check){
               fluidRow(
                 column(6, 
                        div(column(4, style = "padding: 0px; width: 100px", "Número de dormitorios"),
                            column(8, style = "padding: 0px", 
                                   selectInput("busqueda_dormitorios_min", NULL, choices = c("Monoambiente" = "0", "1", "2", "3", "4", "5+")))))
               )
             },
             #             if(!is.null(input$busqueda_banios_check) && input$busqueda_banios_check){
             #                 fluidRow(
             #                   column(6,
             #                          div(column(4, style = "padding: 0px; width: 100px", "Mínimo de baños"),
             #                              column(8, style = "padding: 0px", 
             #                                     selectInput("busqueda_banios_min", NULL, choices = c("1", "2", "3", "4", "5+")))))
             #                 )
             #             },
             #             if(!is.null(input$busqueda_pisos_check) && input$busqueda_pisos_check){
             #                 fluidRow(
             #                   column(6, 
             #                          div(column(4, style = "padding: 0px; width: 100px", 
             #                                     ifelse(input$busqueda_tipo == "Departamento", "Piso mínimo de ubicación", "Mínima cantidad de Pisos")),
             #                              column(8, style = "padding: 0px", 
             #                                     numericInput("busqueda_pisos_min", NULL, value = NULL))))
             #                 )
             #             },
             #             if(!is.null(input$busqueda_garajes_check) && input$busqueda_garajes_check){
             #                 fluidRow(
             #                   column(6, 
             #                          div(column(4, style = "padding: 0px; width: 100px", "Cantidad mínima de cocheras"),
             #                              column(8, style = "padding: 0px", 
             #                                     selectInput("busqueda_garajes_min", NULL, choices = c("1", "2", "3", "4", "5+"))))) 
             #                 )
             #             },
             #             if(!is.null(input$busqueda_oficinas_check) && input$busqueda_oficinas_check){
             #                 fluidRow(
             #                   column(6, 
             #                          div(column(4, style = "padding: 0px; width: 100px", "Cantidad mínima de oficinas"),
             #                              column(8, style = "padding: 0px", 
             #                                     selectInput("busqueda_oficinas_min", NULL, choices = c("1", "2", "3", "4", "5+"))))) 
             #                 )
             #             },
             #             if(!is.null(input$busqueda_anio_check) && input$busqueda_anio_check){
             #                 fluidRow(
             #                   column(6,
             #                          div(column(4, style = "padding: 0px; width: 100px", "Antiguedad máxima del inmueble"),
             #                              column(8, style = "padding: 0px", 
             #                                     autonumericInput(inputId = "busqueda_anio_max", align = "left",
             #                                                      label = NULL, 
             #                                                      value = 0, currencySymbol = " años", currencySymbolPlacement = "s",
             #                                                      decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ","))))
             #                 )
             #             },
             br(),
             uiOutput("busqueda_ok_ui")
    )
  })
  
  output$busqueda_ok_ui <- renderUI({
    print("boton busqueda")
    print("vars$cliente_vinc")
    print(vars$cliente_vinc)
    print("vars$area_busqueda")
    print(vars$area_busqueda)
    
    print(input$busqueda_precio_check)
    div(
      if(is.null(vars$cliente_vinc)){
        cliente <- 0
        div(align = "center", h5("Debes vincular el cliente comprador", style = "color: red"))
      }else{
        cliente <- 1
        div()
      },
      if(nrow(vars$area_busqueda) == 0){
        print("Ingreso a area pero sin exito")
        area <- 0
        div(align = "center", h5("Traza el area a buscar sobre el mapa", style = "color: red"))
      }else{
        print("Ingreso a area pero con exito")
        area <- 1
        div()
      },
      if(!is.null(input$busqueda_precio_check) && input$busqueda_precio_check){
        precio_min <- ifelse(is.null(input$busqueda_precio_min) || input$busqueda_precio_min == 0, 0, 1)
        precio_max <- ifelse(is.null(input$busqueda_precio_max) || input$busqueda_precio_max == 0, 0, 1)
        precio <- precio_min*precio_max
        if(precio == 0){
          div(align = "center", h5("Fija un precio máximo y mínimo", style = "color: red"))
        }else{
          div()
        }
      }else{
        precio <- 1
        div()
      },
      if(!is.null(input$busqueda_m2_check) && input$busqueda_m2_check){
        m2_min <- ifelse(is.null(input$busqueda_m2_min) || input$busqueda_m2_min == 0, 0, 1)
        m2_max <- ifelse(is.null(input$busqueda_m2_max) || input$busqueda_m2_max == 0, 0, 1)
        m2 <- m2_min*m2_max
        if(m2 ==0){
          div(align = "center", h5("Fija la superficie mínima y máxima del terreno", style = "color: red"))
        }else{
          div()
        }
      }else{
        m2 <- 1
        div()
      },
      if(!is.null(input$busqueda_m2_cons_check) && input$busqueda_m2_cons_check){
        m2_cons_min <- ifelse(is.null(input$busqueda_m2_cons_min) || input$busqueda_m2_cons_min == 0, 0, 1)
        m2_cons_max <- ifelse(is.null(input$busqueda_m2_cons_max) || input$busqueda_m2_cons_max == 0, 0, 1)
        m2_cons <- m2_cons_min*m2_cons_max
        if(m2_cons ==0){
          div(align = "center", h5("Fija la superficie mínima y máxima edificada", style = "color: red"))
        }else{
          div()
        }
      }else{
        m2_cons <- 1
        div()
      },
      if(!is.null(input$busqueda_dormitorios_check) && input$busqueda_dormitorios_check && is.na(input$busqueda_dormitorios_min)){
        dormitorios <- 0
        div(align = "center", h5("Proporciona la cantidad de dormitorios", style = "color: red"))
      }else{
        dormitorios <- 1
        div()
      },
      if(!is.null(input$busqueda_banios_check) && input$busqueda_banios_check && is.na(input$busqueda_banios_min)){
        banios <- 0
        div(align = "center", h5("Proporciona cantidad mínima de baños", style = "color: red"))
      }else{
        banios <- 1
        div()
      },
      if(!is.null(input$busqueda_pisos_check) && input$busqueda_pisos_check && is.na(input$busqueda_pisos_min)){
        pisos <- 0
        div(align = "center", h5("Fija en que piso como mínimo lo necesitas", style = "color: red"))
      }else{
        pisos <- 1
        div()
      },
      if(!is.null(input$busqueda_garajes_check) && input$busqueda_garajes_check && is.na(input$busqueda_garajes_min)){
        garajes <- 0
        div(align = "center", h5("Proporciona cantidad mínima de cocheras", style = "color: red"))
      }else{
        garajes <- 1
        div()
      },
      if(!is.null(input$busqueda_oficinas_check) && input$busqueda_oficinas_check && is.na(input$busqueda_oficinas_min)){
        oficinas <- 0
        div(align = "center", h5("Proporciona cantidad mínima de oficinas", style = "color: red"))
      }else{
        oficinas <- 1
        div()
      },
      if(!is.null(input$busqueda_anio_check) && input$busqueda_anio_check && input$busqueda_anio_max == 0){
        anio <- 0
        div(align = "center", h5("Debes fijar una antiguedad máxima", style = "color: red"))
      }else{
        anio <- 1
        div()
      },
      if(cliente + area + precio + m2 + m2_cons + dormitorios + banios + pisos + garajes + anio + oficinas == 11){
        print("cumple los requisitos!!!")
        div(
          actionButton("finish_busqueda", "Guardar búsqueda", style = paste0("background-color: ", main_color, "; color: white; 
                                   font-size: 130%; border-radius: 20px")),
          br(), br(),
          align = "center")
      }
    )
  })
  
  output$map_new_busqueda <- renderLeaflet({
    leaflet() %>% addSearchOSM() %>%
      setView(st_coordinates(vars$view)[1], st_coordinates(vars$view)[2], zoom = 12) %>%
      addMarkers(data = vars$view, icon = skyone_marker) %>%
      addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
      addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
      addLayersControl(baseGroups = c("mapa", "satélite"),
                       options = layersControlOptions(collapsed=FALSE), position = "bottomleft") %>%
      addDrawToolbar(polylineOptions = FALSE, circleOptions = FALSE, rectangleOptions = FALSE,
                     circleMarkerOptions = FALSE, markerOptions = FALSE, polygonOptions = TRUE,
                     editOptions = editToolbarOptions(selectedPathOptions = selectedPathOptions())) 
  })
  
  observeEvent(input$finish_busqueda, {
    busqueda <- vars$area_busqueda
    busqueda$area <- NULL
    print("busqueda")
    print(busqueda)
    point <- st_centroid(busqueda)
    way <- reverse_geocode(point)
    pais <- way$country
    departamento <- way$county
    ciudad <- way$city
    distrito <- way$district
    name <- paste0(vars$cliente_vinc$name, " busca ", str_to_lower(input$busqueda_venta_alquiler),
                   ifelse(input$busqueda_tipo %in% c("Casa", "Oficina", "Propiedad rural", "Casa quinta"), " una ", " un "), str_to_lower(input$busqueda_tipo),
                   " en ", ciudad)
    
    name <- name
    fecha <- as.character(now("America/Asuncion"))
    print(fecha)
    cliente <- vars$cliente_vinc$id
    print(cliente)
    user <- vars$user$user
    print(user)
    tipoPropiedad <- input$busqueda_tipo
    print(tipoPropiedad)
    venta_alquiler <- ifelse(input$busqueda_venta_alquiler == "Comprar", "Venta", "Alquiler")
    print(venta_alquiler)
    moneda <- ifelse(!is.null(input$tipo_moneda), input$tipo_moneda, "USD")
    print(moneda)
    precio_min <- ifelse(!is.null(input$busqueda_precio_check) && input$busqueda_precio_check, input$busqueda_precio_min, 0)
    print(precio_min)
    precio_max <- ifelse(!is.null(input$busqueda_precio_check) && input$busqueda_precio_check, input$busqueda_precio_max, 0)
    print(precio_max)
    m2_min <- ifelse(!is.null(input$busqueda_m2_check) && input$busqueda_m2_check, input$busqueda_m2_min, 0)
    print(m2_min)
    m2_max <- ifelse(!is.null(input$busqueda_m2_check) && input$busqueda_m2_check, input$busqueda_m2_max, 0)
    print(m2_max)
    m2_cons_min <- ifelse(!is.null(input$busqueda_m2_cons_check) && input$busqueda_m2_cons_check, input$busqueda_m2_cons_min, 0)
    print(m2_cons_min)
    m2_cons_max <- ifelse(!is.null(input$busqueda_m2_cons_check) && input$busqueda_m2_cons_check, input$busqueda_m2_cons_max, 0)
    print(m2_cons_max)
    dormitorios_min <- ifelse(!is.null(input$busqueda_dormitorios_check) && input$busqueda_dormitorios_check, input$busqueda_dormitorios_min, NA)
    print(dormitorios_min)
    banios_min <- ifelse(!is.null(input$busqueda_banios_check) && input$busqueda_banios_check, input$busqueda_banios_min, NA)
    print(banios_min)
    pisos_min <- ifelse(!is.null(input$busqueda_pisos_check) && input$busqueda_pisos_check, input$busqueda_pisos_min, 0)
    print(pisos_min)
    garajes_min <- ifelse(!is.null(input$busqueda_garajes_check) && input$busqueda_garajes_check, input$busqueda_garajes_min, NA)
    print(garajes_min)
    oficinas_min <- ifelse(!is.null(input$busqueda_oficinas_check) && input$busqueda_oficinas_check, input$busqueda_oficinas_min, NA)
    print(oficinas_min)
    anio_max <- ifelse(!is.null(input$busqueda_anio_check) && input$busqueda_anio_check, input$busqueda_anio_max, 0)
    print(anio_max)
    
    new_busqueda <- data.frame(
      company = co,
      name = name,
      fecha = fecha,
      cliente = cliente,
      user = user,
      tipoPropiedad = tipoPropiedad,
      venta_alquiler = venta_alquiler,
      moneda = moneda,
      precio_min = precio_min,
      precio_max = precio_max,
      m2_min = m2_min,
      m2_max = m2_max,
      m2_cons_min = m2_cons_min,
      m2_cons_max = m2_cons_max,
      dormitorios_min = dormitorios_min,
      banios_min = banios_min,
      pisos_min = pisos_min,   
      garajes_min = garajes_min,  
      oficinas_min = oficinas_min, 
      anio_max = anio_max,
      activo = "si"
    )
    if(input$busqueda_tipo == "Propiedad rural"){
      m2_min <- m2_min*10000
      m2_max <- m2_max*10000
    }
    new_busqueda <- cbind(busqueda, new_busqueda)
    box <- st_bbox(new_busqueda)
    new_busqueda$lat_min <- box[2]
    new_busqueda$lat_max <- box[4]
    new_busqueda$lon_min <- box[1]
    new_busqueda$lon_max <- box[3]
    new_busqueda$estado <- "no revisado"
    new_busqueda$id <- new_id_myplace_mysql("myplace_busquedas", co, "busqueda", 12)
    save_mysql(new_busqueda, "myplace_busquedas", FALSE)
    
    new_estado <- data.frame(
      id = new_id_table_mysql("id", paste0(co, "_estados"), "estado_", 12),
      fecha = as.character(now("America/Asuncion")),
      user = vars$user$user,
      name = name,
      id_inmo = new_busqueda$id,
      id_clien = new_busqueda$cliente,
      nivel_cliente = NA,
      estado_cliente = NA,
      accion = NA,
      fecha_prox_contacto = as.character(as_date(now("America/Asuncion"))),
      tipo_cliente = "busquedas",
      presupuesto = NA,
      urgente = "no",
      importante = "no",
      fase = "1",
      comment = NA
    )
    save_mysql(new_estado, paste0(co, "_estados"), FALSE)
    
    print("iniciar coinci")
    coincidencias(new_busqueda, dir, session)
    print("fin coinci")
    vars$view <- st_centroid(new_busqueda)
    
    new_busqueda_on(0)
    updateTabItems(session, "menu", "prop_bus")
  })
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #Mi nube
  
  output$mi_nube_ui <- renderUI({
    if(mi_nube_on() == 1){
      fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
                h4(HTML(paste0("<p><span style='color: ", main_color, "'>", ifelse(minube_compartidos_on() == 0, "Mi nube", "Documentos de la oficina"), "</span></p>")), width = "100%"),
                tags$div(id = "inline", style = "padding: 10px; display:inline-block",
                         column(3, actionButton("minube_compartidos_on_off", ifelse(minube_compartidos_on() == 0, "Doc oficina", "Mi nube"), 
                                                icon = icon(ifelse(minube_compartidos_on() == 0, "share-square", "cloud")),
                                                style = paste0("font-size: 130%;"))),
                         if(isolate(minube_compartidos_on() == 0 | (minube_compartidos_on() == 1 & permiso("documentos oficina", NA, vars$permisos_acc, vars$permisos_men)))){
                           column(3, actionButton("minube_new_folder", "Nueva carpeta", icon = icon("folder-plus"),
                                                  style = "font-size: 130%"))
                         },
                         if(isolate(minube_compartidos_on() == 0 | (minube_compartidos_on() == 1 & permiso("documentos oficina", NA, vars$permisos_acc, vars$permisos_men)))){
                           column(6, fileInput("upload_file", NULL,
                                               buttonLabel = "Subir archivo",
                                               placeholder = "nada aun seleccionado",
                                               multiple = FALSE,
                                               accept = NULL))
                         }
                ),
                br(),
                uiOutput("path_buttons_ui"),
                
                br(),
                uiOutput("minube_files_ui")
      )        
    }
  })
  
  minube_compartidos_on <- reactiveVal(0)
  
  observeEvent(input$minube_compartidos_on_off, {
    if(minube_compartidos_on() == 0){
      agencia_nam <- agencia_name(vars$user$agencia, vars$agencias, vars$franquicias)
      print(agencia_nam)
      root <- paste0(co, "/minube/", str_replace_all(agencia_nam, " ", "_"), "/")
      print(root)
      list_all <- list_spaces_do(root)
      print("list_all")
      print(list_all)
      if(nrow(list_all) > 0)
        list_all$Order <- list_all$Order - 2
      vars$minube_list_all <- list_all
      minube_compartidos_on(1)
    }else{
      root <- paste0(co, "/minube/", vars$user$user, "/")
      list_all <- list_spaces_do(root)
      print("list_all")
      print(list_all)
      if(nrow(list_all) > 0)
        list_all$Order <- list_all$Order - 2
      vars$minube_list_all <- list_all
      minube_compartidos_on(0)
    }
    
  })
  
  output$path_ui <- renderUI({
    fluidRow(
      column(1, actionButton("minube_prev_folder", NULL, icon = icon("angle-double-left"),
                             style = "margin: 10px")),
    )
  })
  
  output$minube_files_ui <- renderUI({
    tags$div(id = "minube",
             uiOutput("folder_buttons_ui"),
             tags$hr(),
             uiOutput("file_buttons_ui")
    )
  })
  
  obs_path <- list()
  obs_folder <- list()
  obs_folder_del <- list() 
  obs_file_del <- list()
  obs_file_share <- list()
  
  output$path_buttons_ui <- renderUI({
    print("vars$minube_list_all")
    print(vars$minube_list_all)
    nivel <- min(vars$minube_list_all$Order)
    print("nivel")
    print(nivel)
    path <- vars$minube_list_all$Key[vars$minube_list_all$Order == nivel & vars$minube_list_all$Type == "dir"]
    path <- str_split(path, "/")[[1]]
    path <- path[-c(1, 2, length(path))]
    buttons_path <- as.list(1:length(path))
    buttons_path <- lapply(buttons_path, function(i){
      btPath <- paste0("path_button", i)
      obs_path[[btPath]] <<- observeEvent(input[[btPath]], ignoreNULL = TRUE, ignoreInit = TRUE, {
        freezeReactiveValue(input, btPath)
        nivel <- min(vars$minube_list_all$Order)
        path <- vars$minube_list_all$Key[vars$minube_list_all$Order == nivel & vars$minube_list_all$Type == "dir"]
        path <- str_split(path, "/")[[1]]
        path <- path[-c(1, 2, length(path))]
        
        new_path <- paste0(co, "/minube/", paste0(path[1:i], collapse = "/"), "/")
        list_all <- list_spaces_do(new_path)
        list_all$Order <- list_all$Order - 2
        vars$minube_list_all <- list_all 
      })
      div(style = "padding: 10px; display:inline-block",
          actionButton(btPath, path[i], icon = icon("angle-double-right"), style = "border: 0px;")
      )
    })
  })
  
  observeEvent(vars$minube_list_all, {
    if(nrow(vars$minube_list_all) > 1){
      print("vars$minube_list_all")
      print(isolate(vars$minube_list_all))
      nivel <- min(vars$minube_list_all$Order)
      vars$list_folder <- vars$minube_list_all[vars$minube_list_all$Type == "dir" & vars$minube_list_all$Order == nivel + 1,]
      if(nrow(vars$list_folder) == 0) vars$list_folder <- NA
      vars$list_file <- vars$minube_list_all[vars$minube_list_all$Type == "file" & vars$minube_list_all$Order == nivel,]
      if(nrow(vars$list_file) == 0) vars$list_file <- NA
      if(!is.na(vars$list_folder)){
        output$folder_buttons_ui <- renderUI({
          buttons_folder <- as.list(1:nrow(vars$list_folder))
          buttons_folder <- lapply(buttons_folder, function(i){
            btOpenFolder <- paste0("folder_button", i)
            btDelFolder <- paste0("folder_del", i)
            obs_folder[[btOpenFolder]] <<- observeEvent(input[[btOpenFolder]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btOpenFolder)
              isolate({
                path <- vars$list_folder$Key[i]
                list_all <- list_spaces_do(path)
                list_all$Order <- list_all$Order - 2
                vars$minube_list_all <- list_all 
                print("open folder")
                print(list_all)
              })
            })
            obs_folder_del[[btDelFolder]] <<- observeEvent(input[[btDelFolder]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btDelFolder)
              vars$minube_file <- vars$list_folder$Key[i]
              name <- str_split(vars$list_folder$Key[i], "/")[[1]]
              filename <- name[length(name) - 1]
              showModal(modalDialog(
                h4(paste0("¿Esta seguro que desea eliminar la carpeta ", filename, " con todos sus contenidos?")),
                br(),
                tags$div(id="bttn_modal", 
                         actionBttn("minube_delete_ok", "Eliminar"),
                         actionBttn("close_modal", "Cancelar"),
                         align = "center"),
                title = paste0("Eliminar carpeta"),
                easyClose = TRUE,
                footer = NULL,
                size = "s",
                fade = TRUE
              ))
            })
            div(style = "padding: 10px; display:inline-block",
                tags$div(class = "btn-group",
                         if(isolate(minube_compartidos_on() == 0 | (minube_compartidos_on() == 1 & permiso("documentos oficina", NA, vars$permisos_acc, vars$permisos_men)))){
                           tags$div(id = "minube_del", 
                                    actionButton(btDelFolder, NULL, icon = icon("trash-alt"))
                           )
                         },
                         actionButton(btOpenFolder, HTML(adapt_button_text(vars$list_folder$Key[i], 45)),
                                      icon = icon("folder"), style = "background-color: #f3e7af;")
                )
            )
          })
        })
      }else{
        output$folder_buttons_ui <- renderUI({
          div()
        })
      }
      if(!is.na(vars$list_file)){
        output$file_buttons_ui <- renderUI({
          buttons_file <- as.list(1:nrow(vars$list_file))
          buttons_file <- lapply(buttons_file, function(i){
            btName <- paste0("file_button", i)
            btDel <- paste0("file_Del", i)
            btShare <- paste0("file_share", i)
            output[[btName]] <<- downloadHandler(
              filename <- function(){
                name <- str_split(vars$list_file$Key[i], "/")[[1]]
                name[length(name)]
              },
              content = function(file) {
                print(vars$list_file$Key[i])
                con <- file(glue(file),"wb") #Open a connection
                writeBin(get_object_do(vars$list_file$Key[i]), con) #Write using the connection
                close(con)
              }
            )
            obs_file_del[[btDel]] <<- observeEvent(input[[btDel]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btDel)
              isolate({
                vars$minube_file <- vars$list_file$Key[i]
                name <- str_split(vars$list_file$Key[i], "/")[[1]]
                filename <- name[length(name)]
                showModal(modalDialog(
                  h4(paste0("¿Esta seguro que desea eliminar el archivo ", filename, "?")),
                  br(),
                  tags$div(id="bttn_modal", 
                           actionBttn("minube_delete_ok", "Eliminar"),
                           actionBttn("close_modal", "Cancelar"),
                           align = "center"),
                  title = paste0("Eliminar archivo"),
                  easyClose = TRUE,
                  footer = NULL,
                  size = "s",
                  fade = TRUE
                ))
              })
            })
            obs_file_share[[btShare]] <<- observeEvent(input[[btShare]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btShere)
              agen_names <- list_table_var_mysql("myplace_usuarios", "company", co)$user
              vars$minube_file <- vars$list_file$Key[i]
              showModal(modalDialog(
                selectInput("sel_share_agente", "Elija el asesor", choices = agen_names),
                br(),
                tags$div(id="bttn_modal", 
                         actionBttn("minube_file_share_ok", "Compartir"),
                         actionBttn("close_modal", "Cancelar"),
                         align = "center"),
                title = "Compartir archivo",
                easyClose = TRUE,
                footer = NULL,
                size = "s",
                fade = TRUE
              ))
            })
            div(style = "padding: 10px; display:inline-block",
                tags$div(class = "btn-group",
                         if(isolate(minube_compartidos_on() == 0 | (minube_compartidos_on() == 1 & permiso("documentos oficina", NA, vars$permisos_acc, vars$permisos_men)))){
                           tags$div(id = "minube_del", 
                                    actionButton(btDel, NULL, icon = icon("trash-alt"))
                           )
                         },
                         tags$div(id = "minube_share", 
                                  actionButton(btShare, NULL, icon = icon("share"))
                         ),
                         downloadButton(btName, HTML(adapt_button_text(vars$list_file$Key[i], 65)),
                                        class = "minube_down", icon = NULL)
                )
            )
          })
        })
      }else{
        output$file_buttons_ui <- renderUI({
          div()
        })
      }
    }else{
      output$folder_buttons_ui <- renderUI({
        div()
      })
      output$file_buttons_ui <- renderUI({
        div()
      })
    }
  })
  
  observeEvent(input$minube_file_share_ok, {
    new_path_folder <- paste0(co, "/minube/", input$sel_share_agente, "/Archivos_Recibidos/")
    create_folder_do(new_path_folder)
    
    path <- str_split(vars$minube_file, "/")[[1]]
    name <- path[length(path)]
    tempFile <- file.path(dir, paste0(session$token, name))
    con <- file(glue(tempFile),"wb") 
    writeBin(get_object_do(vars$minube_file), con)
    close(con)
    put_object_do(paste0(co, "/minube/", input$sel_share_agente, "/Archivos_Recibidos/", name), tempFile)
    removeModal()
  })
  
  observeEvent(input$minube_new_folder, {
    showModal(modalDialog(
      textInput("new_folder", NULL),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("minube_new_folder_ok", "Crear"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Nueva carpeta",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$minube_new_folder_ok, {
    nivel <- min(vars$minube_list_all$Order)
    path <- vars$minube_list_all$Key[vars$minube_list_all$Order == nivel & vars$minube_list_all$Type == "dir"]
    
    new_path_folder <- paste0(path, str_replace_all(input$new_folder, " ", "_"), "/")
    create_folder_do(new_path_folder)
    list_all <- list_spaces_do(path)
    list_all$Order <- list_all$Order - 2
    vars$minube_list_all <- list_all 
    removeModal()
  })
  
  observeEvent(input$minube_delete_ok, {
    print(vars$minube_file)
    print(vars$minube_list_all)
    delete_object_do(vars$minube_file)
    nivel <- min(vars$minube_list_all$Order)
    path <- vars$minube_list_all$Key[vars$minube_list_all$Order == nivel & vars$minube_list_all$Type == "dir"]
    list_all <- list_spaces_do(path)
    list_all$Order <- list_all$Order - 2
    vars$minube_list_all <- list_all 
    removeModal()
  })
  
  observeEvent(input$upload_file, {
    nivel <- min(vars$minube_list_all$Order)
    path <- vars$minube_list_all$Key[vars$minube_list_all$Order == nivel & vars$minube_list_all$Type == "dir"]
    
    file <- input$upload_file
    new_path <- paste0(path, file$name)
    put_object_do(new_path, file$datapath)
    list_all <- list_spaces_do(path)
    list_all$Order <- list_all$Order - 2
    vars$minube_list_all <- list_all 
  })
  
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #myplace
  
  output$myplace_ui <- renderUI({
    if(myplace_on() == 1){
      fluidPage(
        uiOutput("myplace_filtros_ui"),
        br(),
        fluidPage(style = paste0("background: white; border-style: solid; border-width: 2px; border-color: ", main_color, ";
            border-radius: 10px; padding: 10px; box-shadow: 0px 10px 10px #aaaaaa"),
                  leafletOutput("map_myplace", height = "50vh")
        ),
        br(),
        div(uiOutput("box_myplace_list_ui"), align = "center"),
        uiOutput("myplace_page_ui"),
        uiOutput("cont_myplace_page_ui")
      )
    }
  })  
  
  output$myplace_filtros_ui <- renderUI({
    if(myplace_on() == 1){
      fluidPage(style = paste0("background: white; border-style: solid; border-width: 2px; border-color: ", main_color, ";
            border-radius: 10px; padding: 10px; box-shadow: 0px 10px 10px #aaaaaa; padding-bottom: 0px"),
                h4("En MyPlace serás parte de una exclusiva comunidad de asesores en la cual podrás subir tus propiedades para compartir con los demás miembros, interactuar con ellos, dar seguimiento a sus propiedades, agendar tareas y mucho más.", 
                   style = "color: #666666"),
                hr(style = paste0("border-top: 2px solid", vars$themes$box_ej, "; margin-bottom: 0px; margin-top: 0px")),
                fluidRow(style = "padding: 0px",
                         column(10, 
                                tags$div(id = "inline", class = "btn-group",
                                         div(style = "width: 110px; margin: 5px", class = "btn-group",
                                             selectInput("myplace_filt_trans", "Transacción", 
                                                         choices = c("Todos", "Venta", "Alquiler", "Alquiler temporal"))),
                                         div(style = "width: 110px; margin: 5px", class = "btn-group",
                                             selectInput("myplace_filt_tipo", "Tipo propiedad",
                                                         choices = c("Todos", "Terreno", "Casa", "Duplex", "Departamento", "Proyecto", "Deposito", "Tinglado", "Oficina", "Salón comercial",
                                                                     "Propiedad rural", "Casa quinta", "Edificio"))),
                                         div(style = "width: 110px; margin: 5px; margin-top: 10px", class = "btn-group",
                                             selectInput("myplace_filt_borrador", "", choices = c("Publicados", "Cerrados"))),
                                         
                                         #                                 div(style = "width: 80px; margin: 5px", class = "btn-group",
                                         #                                     numericInput3("myplace_filt_codigo", "Código", value = NULL)),
                                         
                                         #                                 div(style = "width: 90px; margin: 5px", class = "btn-group",
                                         #                                     selectInput("myplace_filt_moneda", "Moneda", choices = c("Dólares", "Guaraníes"))),
                                         #                                 div(style = "width: 90px; margin: 5px", class = "btn-group",
                                         #                                     numericInput3("myplace_filt_precio_min", "Precio mínimo", value = NULL)),
                                         #                                 div(style = "width: 90px; margin: 5px", class = "btn-group",
                                         #                                     numericInput3("myplace_filt_precio_max", "Precio máximo", value = NULL)),
                                )
                         ),
                         column(2, uiOutput("contador_myplace_ui"), align = "right")
                         
                )
      )
    }
  })
  
  output$contador_myplace_ui <- renderUI({
    h3(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                   nrow(vars$list_myplace), "</span></p>")))
  })
  
  observe({
    if(myplace_on() == 1){
      req(input$myplace_filt_borrador, input$myplace_filt_trans, input$myplace_filt_tipo)
      
      all_pages <- vars$list_myplace_all
      all_pages <- all_pages[!(str_detect(all_pages$user, "gmayeregger") | str_detect(all_pages$user, "kristellkrause") | str_detect(all_pages$user, "hernanvp")),]
      print("ingresa filtros")
      if(input$myplace_filt_borrador == "Cerrados"){
        all_pages <- all_pages[all_pages$precio_cierre != 0,]
      }else{
        all_pages <- all_pages[all_pages$precio_cierre == 0 & all_pages$externa == "no",]
      }
      if(input$myplace_filt_trans != "Todos"){
        all_pages <- all_pages[all_pages$venta_alquiler == input$myplace_filt_trans,]
      }
      if(input$myplace_filt_tipo != "Todos"){
        all_pages <- all_pages[all_pages$tipoPropiedad == input$myplace_filt_tipo,]
      }
      if(nrow(all_pages) != 0){
        vars$list_myplace <- all_pages %>% arrange(desc(fecha))
        vars$page_selected <- 1
        vars$list_myplace_page <- generate_pages(vars$list_myplace, vars$n_per_page, vars$max_pages, 1)$data
      }else{
        vars$list_myplace <- data.frame()
        vars$list_myplace_page <- data.frame()
        vars$page_selected <- 1
      }
    }
  })
  
  output$map_myplace <- renderLeaflet({
    if(myplace_on() == 1){
      req(vars$view, vars$list_myplace)
      map_myplace_leaflet <- leaflet(options = leafletOptions(dragging=TRUE)) %>% addSearchOSM() %>%
        setView(st_coordinates(vars$view)[1], st_coordinates(vars$view)[2], zoom = 12) %>%
        addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
        addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
        #      addTiles("https://mt1.google.com/vt?lyrs=h@159000000,traffic|seconds_into_week:-1&style=3&x={x}&y={y}&z={z}", group = "tráfico") %>% 
        addLayersControl(baseGroups = c("mapa", "satélite"), #overlayGroups = c("propios", "otros", "cierres"),
                         options = layersControlOptions(collapsed=FALSE), position = "bottomleft") %>%
        setMapWidgetStyle(list(background = "transparent"))
      if(nrow(vars$list_myplace) != 0){
        map_myplace_leaflet <- map_myplace_leaflet %>% addMarkers(data = vars$list_myplace, icon = ~icon_inmo(tipoPropiedad), layerId = ~id, group = "propios",
                                                                  clusterOptions = markerClusterOptions(iconCreateFunction=JS("function (cluster) {    
    var childCount = cluster.getChildCount(); 
    var c = ' marker-custom-';  
    if (childCount < 10) {  
      c += 'large';  
    } else if (childCount < 50) {  
      c += 'medium';  
    } else { 
      c += 'small';  
    }    
    return new L.DivIcon({ html: '<div><span>' + childCount + '</span></div>', className: 'marker-cluster' + c, iconSize: new L.Point(40, 40) });

  }")))
      }
      map_myplace_leaflet
    }
  })
  
  observeEvent(input$map_myplace_marker_click, {
    click <- input$map_myplace_marker_click
    vars$click <- query_mysql(paste0("SELECT * FROM myplace_inmuebles WHERE id = '", click$id, "';"))
    vars$show_inmo <- vars$click
    print("myplace click")
    print(vars$show_inmo)
    modal_inmo_description()
  })
  
  obs_open_myplace <- list()
  
  observe({
    if(myplace_on() == 1){
      req(vars$list_myplace_page)
      if(nrow(vars$list_myplace_page) > 0){
        isolate({
          list_myplace_page <- query_mysql(paste0("SELECT * FROM myplace_inmuebles WHERE id IN ", 
                                                  paste("(", paste(paste0("'", vars$list_myplace_page$id,"'"),collapse = ","), ")"), 
                                                  " ORDER BY fecha DESC;"))
          vars$list_myplace_page_full <- list_myplace_page
        })
        output$box_myplace_list_ui <- renderUI({
          boxes_myplace <- as.list(1:nrow(list_myplace_page))
          boxes_myplace <- lapply(boxes_myplace, function(i){
            print(paste0("listo inmo ", i))
            inmo <- list_myplace_page[i,]
            
            ext <- !str_detect(inmo$id, "skyone")
            
            if(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta"){
              inmo$precio_cierre <- round(inmo$precio_cierre/1000000)
              inmo$precio <- round(inmo$precio/1000000)
            }
            btOpenMyplace <- paste0("open_myplace_button", i) 
            if(inmo$tipoPropiedad %in% c("Proyecto")){
              tipologias <- list_table_var_mysql("myplace_tipologias", "id", inmo$id)
              if(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta"){
                tipologias$precio <- round(tipologias$precio/1000000)
              }
              precio_min <- format(min(tipologias$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              precio_max <- format(max(tipologias$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              dormitorios_min <- min(ifelse(is.na(as.integer(tipologias$dormitorios)), 1, as.integer(tipologias$dormitorios)))
              dormitorios_max <- max(ifelse(is.na(as.integer(tipologias$dormitorios)), 1, as.integer(tipologias$dormitorios)))
              banios_min <- min(as.integer(tipologias$banios))
              banios_max <- max(as.integer(tipologias$banios))
              m2_cons_min <- format(round(min(tipologias$m2_cons)), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              m2_cons_max <- format(round(max(tipologias$m2_cons)), big.mark = ".", decimal.mark = ",", scientific = FALSE)
              garajes_min <- min(as.integer(tipologias$garajes))
              garajes_max <- max(as.integer(tipologias$garajes))
            }
            
            obs_open_myplace[[btOpenMyplace]] <<- observeEvent(input[[btOpenMyplace]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btOpenMyplace)
              vars$show_inmo <- vars$list_myplace_page_full[i,]
              modal_inmo_description()
            })
            
            vistas <- list_table_var_mysql("vistas_myplace", "id_inmo", inmo$id) %>%
              group_by(user) %>% summarize(n = n()) %>% nrow()
            
            id_card <- paste0(ifelse(str_detect(inmo$id, "skyone"), "S", "P"), 
                              as.integer(str_flatten(str_extract_all(inmo$id, "\\d")[[1]])))
            
            contactos <- list_table_var_mysql("contactos_myplace", "id_inmo", inmo$id) %>%
              group_by(user) %>% summarize(n = n()) %>% nrow()
            
            div(style = "padding: 10px; display:inline-block", align = "left",
                div(
                  if(!ext){
                    div(style = "position: absolute; margin-top: 5px; margin-left: 5px",
                        actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:60px; height: 20px; margin: 0px;
                                                             background-image: url("logo_SkyOne_borde_blanco.png");
                                                             background-size: cover, 60px 20px;'))
                    )
                  },
                  div(style = paste0("border-style: solid; border-width: 1px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: ", ifelse(ext, main_color, "white"), "; width: 242px; height: 315px;
                                 margin: 0px; padding: 0px"),
                      div(actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:240px; height: 180px; margin: 0px;
                                                             background-image: 
                                                             linear-gradient(to bottom, rgba(245, 246, 252, 0) 75%, rgba(0, 0, 0, 0.6) 90%, rgba(0, 0, 0, 0.7)),
                                                             url("', inmo$img, '");
                                                             background-size: cover, 240px 180px;
                                                             border-radius: 8px 8px 0px 0px')),
                      ),
                      div(style = "position: absolute; margin-top: -25px; margin-left: 10px;",
                          HTML(paste0("<span style='font-size: 110%; font-weight: bold; color: white;'>",
                                      "<i class='fa fa-id-card'></i>", id_card, 
                                      "&emsp;&emsp;<i class='fa fa-phone'></i> ", contactos, 
                                      "&emsp;&emsp;<i class='fa fa-eye'></i> ", vistas,
                                      "</span>"))
                      ),
                      div(style = "width: 240px; height: 30px; margin: 6px", 
                          HTML(paste0("<p><span style='font-size: 140%; font-weight: normal; color: ", ifelse(ext, "white", "#444444"), "; height: 45px'>", 
                                      str_trunc(paste0(inmo$tipoPropiedad, " en ", ifelse(inmo$venta_alquiler == "Alquiler temporal", "Alq temp", inmo$venta_alquiler)), 28), "</span></p>"))),
                      div(style = "width: 240px; margin-left: 10px; margin-top: -10px", 
                          HTML(paste0("<p><span style='font-size: 90%; font-weight: normal; color: ", ifelse(ext, "white", "#444444"), "; height: 45px'>", 
                                      str_trunc(ifelse(inmo$distrito != "" & !is.na(inmo$distrito), paste0(inmo$distrito, ", ", inmo$ciudad), inmo$ciudad), 38), "</span></p>"))),
                      h4(paste0(inmo$moneda_contrato, " ", ifelse(inmo$tipoPropiedad == "Proyecto", 
                                                                  ifelse(precio_min == precio_max, precio_min, paste0(precio_min, "-", precio_max)),
                                                                  format(ifelse(inmo$precio_cierre != 0, inmo$precio_cierre, inmo$precio), big.mark = ".", decimal.mark = ",", scientific = FALSE)),
                                ifelse(inmo$moneda_contrato == "GS" & inmo$venta_alquiler == "Venta", " millones", "")), 
                         style = paste0("margin: 0px; margin-left: 10px; margin-top: 5px; margin-bottom: 5px; font-weight: lighter; font-size: 180%; color: ", ifelse(ext, "white", lighten(main_color, 0.20)))),
                      
                      div(style = "position: absolute; margin-top: 10px; margin-left: 0px;",
                          if(inmo$tipoPropiedad %in% c("Casa", "Casa quinta", "Duplex", "Proyecto", "Departamento")){
                            HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(ext, "white", "#444444"), "'><i class='fa fa-bed'></i> ", 
                                        ifelse(inmo$tipoPropiedad %in% c("Proyecto"), 
                                               ifelse(dormitorios_min == dormitorios_max, dormitorios_min, paste0(dormitorios_min, "-", dormitorios_max)),
                                               ifelse(inmo$dormitorios == "0", "Mono", inmo$dormitorios)), 
                                        " <i class='fa fa-bath'></i> ", 
                                        ifelse(inmo$tipoPropiedad %in% c("Proyecto"), 
                                               ifelse(banios_min == banios_max, banios_min, paste0(banios_min, "-", banios_max)),
                                               inmo$banios), 
                                        " <i class='fa fa-ruler-combined'></i> ",
                                        ifelse(inmo$tipoPropiedad %in% c("Proyecto"), 
                                               ifelse(m2_cons_min == m2_cons_max, m2_cons_min, paste0(m2_cons_min, "-", m2_cons_max)),
                                               inmo$m2_cons), "m2",
                                        ifelse(is.na(inmo$garajes), "", " <i class='fa fa-car-side'></i> "),
                                        ifelse(is.na(inmo$garajes), "", ifelse(inmo$tipoPropiedad %in% c("Proyecto"), 
                                                                               ifelse(garajes_min == garajes_max, garajes_min, paste0(garajes_min, "-", garajes_max)),
                                                                               inmo$garajes)), 
                                        "</span></p>"))
                          },
                          if(inmo$tipoPropiedad %in% c("Edificio")){
                            HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(ext, "white", "#444444"), "'>",
                                        " <i class='fa fa-ruler-combined'></i> ", inmo$m2_cons, "m2</span></p>"))
                          },
                          if(inmo$tipoPropiedad %in% c("Terreno")){
                            HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(ext, "white", "#444444"), "'>",
                                        " <i class='fa fa-ruler-combined'></i> ", inmo$m2, "m2</span></p>"))
                          },
                          if(inmo$tipoPropiedad %in% c("Propiedad rural")){
                            HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(ext, "white", "#444444"), "'>",
                                        " <i class='fa fa-ruler-combined'></i> ", inmo$m2/10000, " hectareas</span></p>"))
                          },
                          if(inmo$tipoPropiedad %in% c("Deposito", "Tinglado", "Oficina", "Salón comercial")){
                            HTML(paste0("<p><span style='font-size: 110%; font-weight: normal; padding-left: 10px; color: ", ifelse(ext, "white", "#444444"), "'>",
                                        " <i class='fa fa-ruler-combined'></i> ", inmo$m2_cons, "m2",
                                        if(!is.na(inmo$banios)) paste0(" <i class='fa fa-bath'></i> ", inmo$banios),
                                        if(!is.na(inmo$oficinas)) paste0(" <i class='fa fa-laptop-house'></i> ", inmo$oficinas),
                                        if(!is.na(inmo$garajes)) paste0(" <i class='fa fa-car-side'></i> ", inmo$garajes),
                                        "</span></p>"))
                          }
                      )
                  )
                ),
                div(style = "position: absolute; margin-top: -315px; margin-left: 0px",
                    actionButton(btOpenMyplace, NULL, style = "width: 242px; height: 315px; background: transparent;
                                 border-color: transparent")
                )
            )
          })
        })
      }else{
        output$box_myplace_list_ui <- renderUI({
          div()
        })
      }
    }else{
      output$box_myplace_list_ui <- renderUI({
        div()
      })
    }
  })
  
  obs_myplace_page <- list()
  
  observe({
    if(myplace_on() == 1){
      req(vars$list_myplace)
      if(nrow(vars$list_myplace) != 0){
        page <- generate_pages(vars$list_myplace, vars$n_per_page, vars$max_pages, vars$page_selected)
        print("hasta aqui 1")
        output$myplace_page_ui <- renderUI({
          pages <- as.list(page$min:page$max)
          pages <- lapply(pages, function(i){
            btOpenPageMyplace <- paste0("myplace_page", i)
            obs_myplace_page[[btOpenPageMyplace]] <<- observeEvent(input[[btOpenPageMyplace]], ignoreNULL = TRUE, ignoreInit = TRUE, {
              freezeReactiveValue(input, btOpenPageMyplace)
              isolate({
                vars$page_selected <- i
                if(i == page$n_pages){
                  vars$list_myplace_page <- vars$list_myplace[(vars$n_per_page*i-vars$n_per_page + 1):(vars$n_per_page*(i - 1) + page$last_page),]
                }else{
                  vars$list_myplace_page <- vars$list_myplace[(vars$n_per_page*i-vars$n_per_page + 1):(vars$n_per_page*i),]
                }
              })
              print(paste0("listo page ", i))
            })
            div(style = "padding: 5px; display:inline-block",
                if(i == page$min & page$min != page$max){
                  tags$div(class = "btn-group",
                           actionButton("go_first_myplace_page", "", icon = icon("angle-double-left"),
                                        style = paste0("background-color: white; color: ", main_color, "; border: 1px;  border-radius: 5px;
                                                border-color: ", main_color, "; margin-right: 10px")),
                           actionButton(btOpenPageMyplace, as.character(i), 
                                        style = ifelse(i == vars$page_selected, 
                                                       paste0("background-color: ", main_color, "; color: white; border: 1px; border-radius: 5px;
                                                border-color: ", main_color),
                                                       paste0("background-color: white; color: ", main_color, "; border: 1px;  border-radius: 5px;
                                                border-color: ", main_color)))
                  )
                },
                if(i == page$max & page$min != page$max){
                  tags$div(class = "btn-group",
                           actionButton(btOpenPageMyplace, as.character(i), 
                                        style = ifelse(i == vars$page_selected, 
                                                       paste0("background-color: ", main_color, "; color: white; border: 1px; border-radius: 5px;
                                                border-color: ", main_color),
                                                       paste0("background-color: white; color: ", main_color, "; border: 1px;  border-radius: 5px;
                                                border-color: ", main_color))),
                           actionButton("go_last_myplace_page", "", icon = icon("angle-double-right"),
                                        style = paste0("background-color: white; color: ", main_color, "; border: 1px;  border-radius: 5px;
                                                border-color: ", main_color, "; margin-left: 10px"))
                  )
                },
                if((i != page$min & i != page$max) | page$min == page$max){
                  actionButton(btOpenPageMyplace, as.character(i), 
                               style = ifelse(i == vars$page_selected, 
                                              paste0("background-color: ", main_color, "; color: white; border: 1px; border-radius: 5px;
                                                border-color: ", main_color),
                                              paste0("background-color: white; color: ", main_color, "; border: 1px;  border-radius: 5px;
                                                border-color: ", main_color)))
                }
            )
          })
        })
      }else{
        output$myplace_page_ui <- renderUI({
          div()
        })
      }
    }
  })
  
  output$cont_myplace_page_ui <- renderUI({
    req(vars$list_myplace)
    if(nrow(vars$list_myplace) != 0){
      vars$list_myplace_page <- vars$list_myplace_page[!is.na(vars$list_myplace_page$id),]
      paste0("  Mostrando ", (vars$page_selected - 1)*vars$n_per_page + 1, "-", 
             (vars$page_selected - 1)*vars$n_per_page + nrow(vars$list_myplace_page), " de ",
             nrow(vars$list_myplace))
    }
  })
  
  observeEvent(input$go_first_myplace_page, {
    isolate({
      if(nrow(vars$list_myplace) != 0){
        vars$list_myplace_page <- generate_pages(vars$list_myplace, vars$n_per_page, vars$max_pages, 1)$data
      }else{
        vars$list_myplace_page <- data.frame()
      }
      vars$page_selected <- 1
    })
  })
  
  observeEvent(input$go_last_myplace_page, {
    isolate({
      if(nrow(vars$list_myplace) != 0){
        page <- generate_pages(vars$list_myplace, vars$n_per_page, vars$max_pages, 1)
        vars$page_selected <- page$n_pages
        vars$list_myplace_page <- vars$list_myplace[(vars$n_per_page*page$n_pages-vars$n_per_page + 1):(vars$n_per_page*(page$n_pages - 1) + page$last_page),]
      }else{
        vars$list_myplace_page <- data.frame()
        vars$page_selected <- 1
      }
    })
  })
  
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #place analyzer
  
  output$place_ui <- renderUI({
    if(place_on() == 1){
      div(
        div(id = "box_ubi",
            box(title = NULL, width = 12, 
                leafletOutput("map_comercios", height = 350),
                div(style = "margin-bottom: -16px",
                    actionButton("ubi_lat_lon2", HTML("<p><span style='color: #888888; font-size: 100%'>Ingresar ubicación por latitud y longitud</span></p>"), 
                                 style = "background-color: transparent; border-color: transparent")
                )
            )
        ),
        uiOutput("formulario_prop_ui"),
        br(),
        uiOutput("historial_consultas_ui")
      )
    }
  })
  
  output$historial_consultas_ui <- renderUI({
    div(id = "box_ubi",
        box(title = NULL, width = 12,
            h3("Historial de consultas", style = "font-size: 200%; color: #888888; font-weight: bold; font-family: 'Inter'; margin-top: 0px"),
            leafletOutput("map_hist_cons", height = 350),
        )
    )
  })
  
  output$map_hist_cons <- renderLeaflet({
    cons1 <- list_table_var_mysql("history_consultas_inmo_full", "user", vars$user$user)
    cons2 <- list_table_var_mysql("history_consultas_inmo_full", "user", vars$user$user)
    cons <- rbind(cons1, cons2)
    
    
    map <- leaflet(options = leafletOptions(dragging=TRUE)) %>% addSearchOSM() %>%
      setView(st_coordinates(vars$view)[1], st_coordinates(vars$view)[2], zoom = 13) %>%
      #addMarkers(site()[2], site()[1], icon = pin_circle) %>%
      addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
      addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
      #      addTiles("https://mt1.google.com/vt?lyrs=h@159000000,traffic|seconds_into_week:-1&style=3&x={x}&y={y}&z={z}", group = "tráfico") %>% 
      addLayersControl(baseGroups = c("mapa", "satélite"),
                       options = layersControlOptions(collapsed=FALSE), position = "bottomleft") %>%
      setMapWidgetStyle(list(background = "transparent"))
    if(nrow(cons) != 0){
      cons <- st_as_sf(cons, coords = c("lng", "lat"), crs = crs)
      map <- map %>% addMarkers(data = cons, icon = ~icon_inmo(tipo),
                                popup = ~paste0(ifelse(is.na(file), "", 
                                                       paste0("<a href = ", file, " target = '_blank'> Abrir reporte </a><br>")),
                                                "<br><b>Fecha y hora: </b>", date))
    }
    map
  })
  
  output$formulario_prop_ui <- renderUI({
    div(id = "box_ubi",
        box(title = NULL, width = 12,
            div(id = "inline",
                fluidRow(
                  column(6,
                         h3("Datos de la propiedad", style = "font-size: 200%; color: #888888; font-weight: bold; font-family: 'Inter'; margin-top: 0px"),
                         hr(style = paste0("border-top: 2px solid ", vars$themes$box_ej)),
                         fluidRow(
                           column(width = 6, 
                                  selectInput("tipo", "Tipo de propiedad", c("Terreno", "Casa", "Duplex", "Departamento"))
                           ),
                           column(width = 6, 
                                  uiOutput("m2_terreno_ui")
                           )
                         ),
                         div(uiOutput("form_ui1"), align = "center"),
                         br(),
                         div(uiOutput("ok_ui"), align = "center"),
                         br(),
                         br()
                  ),
                  column(6,
                         h3("Datos de mercado", style = "font-size: 200%; color: #888888; font-weight: bold; font-family: 'Inter'; margin-top: 0px"),
                         hr(style = paste0("border-top: 2px solid ", vars$themes$box_ej)),
                         fluidRow(
                           column(6, style = "color: #444444; font-weight: normal",
                                  "Los datos de mercado brindan información adicional del rubro y categoría elegidos por el usuario.", 
                                  br(),
                                  "Ejemplo: si está buscando una propiedad como para un restaurante entonces podría elegir el rubro alimenticio y la categoria restaurante y en el reporte tendrá la actividad del rubro y la ubicación de los restaurantes",  
                           ),
                           column(6, style = "min-width: 260px",
                                  div(HTML('<img src="https://place-storage.nyc3.digitaloceanspaces.com/place-files/ejemplo_rubro.png">'), align = "center", width = 260),
                           )
                         ),
                         br(),
                         div(style = "color: #666666; font-weight: normal", materialSwitch("mercado_on", "Activar", status = "info"), align = "center"),
                         uiOutput("mercado_select"),
                  )
                )
            )
        )
    )
  })
  
  output$m2_terreno_ui <- renderUI({
    req(input$tipo)
    if(input$tipo != "Departamento"){
      autonumericInput(inputId = "m2_terreno", align = "left", "Superficie del terreno",
                       value = 0, currencySymbol = " ₘ₂", currencySymbolPlacement = "s",
                       decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")
    }else{
      selectInput("age", "Antiguedad",
                  c("En pozo" = "En pozo",
                    "Nuevo (0 - 10 años)" = "Nuevo"))
    }
  })
  
  observeEvent(input$ubi_lat_lon2, {
    showModal(modalDialog(
      textInput("lat_lon_text2", HTML("<p><span style='font-weight: normal'>Copiar coordenadas de Google Maps<br>Ej: (-25.3032778, -57.5992415)</span></p>")),
      tags$div(id="bttn_modal", 
               actionBttn("text_coords2_ok", "Ubicar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Ubicación por coordenadas",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$text_coords2_ok, {
    if(input$lat_lon_text2 == ""){
      shinyalert(
        type = "error",
        title = "Debes copiar las coordenadas de Google Maps"
      )
    }else{
      removeModal()
      #te <- "(-25.3032778, -57.5992415)"
      text <- str_remove(input$lat_lon_text2, "\\(")
      text <- str_remove(text, "\\)")
      text <- str_split(text, ",")[[1]]
      vars$lat <- as.numeric(text[1])
      vars$lng <- as.numeric(text[2])
      vars$view_no_gps <- data.frame(lat = vars$lat, lng = vars$lng) %>% 
        st_as_sf(coords = c("lng", "lat"), crs = crs)
      vars$text_coords <- TRUE
      leafletProxy("map_comercios") %>% clearMarkers() %>% clearShapes() %>%
        flyTo(vars$lng, vars$lat, zoom = isolate(vars$last_zoom)) %>%
        addMarkers(vars$lng, vars$lat, icon = rosarioIcon)
    }
  })
  
  observeEvent(input$m2_inmueble, {
    req(input$m2_inmueble)
    vars$m2_casa <- input$m2_inmueble
  })
  
  observeEvent(input$map_comercios_zoom,{
    if(vars$start == FALSE){
      vars$last_zoom <- input$map_comercios_zoom
    }
  })
  
  output$map_comercios <- renderLeaflet({
    if(vars$start == TRUE){
      leaflet(options = leafletOptions(dragging=TRUE)) %>% addSearchOSM() %>%
        addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
        addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
        #      addTiles("https://mt1.google.com/vt?lyrs=h@159000000,traffic|seconds_into_week:-1&style=3&x={x}&y={y}&z={z}", group = "tráfico") %>% 
        addLayersControl(baseGroups = c("mapa", "satélite"),
                         options = layersControlOptions(collapsed=FALSE), position = "bottomleft") %>%
        addDrawToolbar(polylineOptions = FALSE, circleOptions = FALSE, rectangleOptions = FALSE,
                       circleMarkerOptions = FALSE, markerOptions = TRUE, polygonOptions = FALSE,
                       editOptions = editToolbarOptions(selectedPathOptions = selectedPathOptions())) %>%
        setMapWidgetStyle(list(background = "transparent"))
    }else{
      leaflet(options = leafletOptions(dragging=TRUE)) %>% addSearchOSM() %>%
        setView(st_coordinates(vars$view)[1], st_coordinates(vars$view)[2], zoom = 16) %>%
        #addMarkers(site()[2], site()[1], icon = pin_circle) %>%
        addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
        addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
        #      addTiles("https://mt1.google.com/vt?lyrs=h@159000000,traffic|seconds_into_week:-1&style=3&x={x}&y={y}&z={z}", group = "tráfico") %>% 
        addLayersControl(baseGroups = c("mapa", "satélite"),
                         options = layersControlOptions(collapsed=FALSE), position = "bottomleft") %>%
        addDrawToolbar(polylineOptions = FALSE, circleOptions = FALSE, rectangleOptions = FALSE,
                       circleMarkerOptions = FALSE, markerOptions = TRUE, polygonOptions = FALSE,
                       editOptions = editToolbarOptions(selectedPathOptions = selectedPathOptions())) %>%
        setMapWidgetStyle(list(background = "transparent")) %>%
        addLegend(position = "bottomright", colors = "transparent", labels = HTML("<span style='color: #888888'><b>luego en el sitio</b></span>"),
                  title = HTML("<p><span style='color: #888888'>Haz click sobre <img src='pin_mapa.png' width='30'> y</span></p>"))
    }
  })
  
  observeEvent(input$map_comercios_draw_new_feature, {
    print("input$map_comercios_draw_new_feature")
    print(input$map_comercios_draw_new_feature)
    ubi <- leaflet_draw(input$map_comercios_draw_new_feature)
    print("ubi")
    print(ubi)
    vars$place <- ubi$df
    print("nuevo punto")
    vars$map_coords <- TRUE
    leafletProxy("map_comercios") %>% clearMarkers() %>%
      addMarkers(data = ubi$sf, icon = rosarioIcon)
  })
  
  output$form_ui1 <- renderUI({
    req(input$tipo)
    if(input$tipo != "Terreno")
      uiOutput("form_ui2")
  })
  
  output$form_ui2 <- renderUI({
    if(input$tipo == "Casa"){
      vars$lujo <- TRUE
      div(id = "inline", align = "left",
          fluidRow(width = 12,
                   column(width = 6, selectInput("lujo", "¿La casa es de lujo?", c("Si", "No"), selected = "No")),
                   column(width = 6, 
                          autonumericInput(inputId = "m2_inmueble", align = "left",
                                           label = "Superficie construida",
                                           value = 0, currencySymbol = " ₘ₂", currencySymbolPlacement = "s",
                                           decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ","))
          ),
          uiOutput("form_ui3")
      )
    }else{
      div(id = "inline", align = "left",
          fluidRow(
            column(6,
                   autonumericInput(inputId = "m2_inmueble", align = "left",
                                    label = "Superficie construida",
                                    value = 0, currencySymbol = " ₘ₂", currencySymbolPlacement = "s",
                                    decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",")
            ),
            column(6,
                   if(input$tipo == "Departamento"){
                     selectInput("dormitorios", "Dormitorios", choices = c("Monoambiente" = "0", "1", "2", "3", "4"))
                   }
            )
          ),
          uiOutput("form_ui4")
      )
    }
  })
  
  output$form_ui3 <- renderUI({
    if(input$lujo == "Si"){
      vars$lujo <- TRUE
      div()
    }else{
      if(input$lujo == "No"){
        vars$lujo <- FALSE
        uiOutput("form_ui4")
      }
    }
  })
  
  output$form_ui4 <- renderUI({
    req(input$tipo)
    fluidPage(id = "inline", align = "left",
              if(input$tipo == "Departamento"){
                div(
                  fluidRow(
                    column(6,
                           selectInput("banios", "Baños", choices = c("1", "2", "3", "4"))
                           
                    ),
                    column(6,
                           selectInput("garajes", "Cocheras", choices = c("0", "1", "2", "3", "4"))
                    )
                  ),
                  fluidPage(width = 12,
                            materialSwitch(inputId = "piscina", "Piscina", value = FALSE,  status = "info", inline = TRUE, width = 80),
                            materialSwitch(inputId = "gimnasio", "Gimnasio", value = FALSE,  status = "info", inline = TRUE, width = 80),
                            materialSwitch(inputId = "area_servicio", "Area de servicio", value = FALSE,  status = "info", inline = TRUE, width = 80),
                            materialSwitch(inputId = "balcon", "Balcón", value = FALSE,  status = "info", inline = TRUE, width = 80)
                  )
                )
              },
              fluidRow(width = 12,
                       column(width = 6,
                              if(input$tipo != "Departamento"){
                                selectInput("age", "Antiguedad",
                                            c("Nuevo (0 - 4 años)" = "Nuevo", 
                                              "Semi nuevo (5 - 8 años)" = "Semi nuevo",
                                              "Medio (9 - 15 años)" = "Medio",
                                              "Antiguo (más de 15 años)" = "Antiguo"))
                              }
                       ),
                       column(width = 6,
                              if(input$tipo != "Departamento"){
                                selectInput("condition", "Estado general", 
                                            c("Excelente", "Bueno", "Regular", "Malo"))
                              }
                       )
              )
    )
  })
  
  output$ok_ui <- renderUI({
    if(!is.null(input$m2_terreno) && input$tipo != "Departamento" && !is.na(input$m2_terreno) && input$m2_terreno > 20){
      if(input$tipo == "Terreno"){
        fluidPage(
          actionButton("finish", "Enviar consulta", icon = icon("check"),
                       style = paste0("background: ", main_color, ";font-size: 150%;
                                  border-radius: 20px; color: white; border-width: 0px")),
        )
      }else{
        if(!is.na(vars$m2_casa) && !is.na(vars$m2_casa) && vars$m2_casa > 10){
          fluidPage(
            actionButton("finish", "Enviar consulta", icon = icon("check"),
                         style = paste0("background: ", main_color, ";font-size: 150%;
                                  border-radius: 20px; color: white; border-width: 0px")),
          )
        }
      }
    }else{
      if(input$tipo == "Departamento" && !is.na(vars$m2_casa) && !is.na(vars$m2_casa) && vars$m2_casa > 10){
        fluidPage(
          actionButton("finish", "Enviar consulta", icon = icon("check"),
                       style = paste0("background: ", main_color, ";font-size: 150%;
                                  border-radius: 20px; color: white; border-width: 0px")),
        )
      }
    }
  })
  
  output$mercado_select <- renderUI({
    req(input$mercado_on)
    if(input$mercado_on){
      div(
        fluidRow(width = 12,
                 column(width = 6,
                        selectInput("rubro", 
                                    HTML("<p><span style='color: white'>Elija el rubro a analizar</span></p>"),
                                    c("Comercial", "Alimenticio", "Automotor", "Salud",
                                      "Educación", "Estética", "Entidades financieras",
                                      "Inmobiliario", "Hogar", "Esparcimiento", "Religión",
                                      "Tecnología", "Turismo", "Deportes", "Agroganadero",
                                      "Construcción", "Vestimenta"))
                 ),
                 column(width = 6,
                        uiOutput("categoria_ui"),
                 )
        )
      )
    }
  })
  
  observeEvent(input$rubro, {
    vars$categorias <- select_tipo_by_rubro_mysql(input$rubro)
  })
  
  output$categoria_ui <- renderUI({
    fluidPage(width = 12,
              selectInput("categoria", 
                          HTML("<p><span style='color: white'>Elija la categoría</span></p>"), 
                          vars$categorias),
    )
  })
  
  observeEvent(input$finish, {
    isolate({
      
      if(vars$map_coords == FALSE & vars$text_coords == FALSE){
        shinyalert(
          type = "error",
          title = "Coloca un marcador en el mapa o ingresa Latitud y Longitud"
        )
      }else{
        if(isolate(vars$text_coords) == TRUE){
          vars$place <- data.frame(lon = vars$lng, lat = vars$lat)
        }
        print("ini paraguay")
        mapa_py_df <- load_mysql("mapa_py") %>% select(lon, lat)
        mapa_uy_df <- load_mysql("mapa_uy") %>% select(lon, lat)
        mapa_es_centro_df <- load_mysql("mapa_es_centro") %>% select(lon, lat)
        mapa_pe_lima_df <- load_mysql("mapa_pe_lima") %>% select(lon, lat)
        mapa_bo_santacruz_df <- load_mysql("mapa_bo_santacruz") %>% select(lon, lat)
        mapa_py <- zona_maker(mapa_py_df, 1)
        print("mapa_py")
        print(mapa_py)
        mapa_uy <- zona_maker(mapa_uy_df, 1)
        mapa_es_centro <- zona_maker(mapa_es_centro_df, 1)
        mapa_pe_lima <- zona_maker(mapa_pe_lima_df, 1)
        mapa_bo_santacruz <- zona_maker(mapa_bo_santacruz_df, 1)
        mapas <- rbind(mapa_uy, mapa_py, mapa_es_centro, mapa_pe_lima, mapa_bo_santacruz)
        print("mapas")
        print(mapas)
        point_sf <- vars$place %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
        print("point_sf")
        print(point_sf)
        inter_py <- st_intersection(mapa_py, point_sf)
        vars$consul_py <- ifelse(nrow(inter_py) == 1, TRUE, FALSE)
        point_py <- st_intersection(mapas, point_sf)
        
        print("antes paraguay")
        print(point_py)
        if(nrow(point_py) == 0){
          shinyalert(
            type = "error",
            title = "La ubicación escogida debe estar en Paraguay, Uruguay, España (Madrid), Peru (Lima) o Bolivia (Santa cruz)"
          )
        }else{
          m2_terreno <- str_replace(isolate(input$m2_terreno), ",", "\\.") %>% as.integer()
          print("antes sup terreno")
          print(m2_terreno)
          if(m2_terreno > 15000){
            shinyalert(
              type = "error",
              title = "El terreno debe ser urbano (15.000m2 como máximo)"
            )
          }else{
            
            if(vars$consul_py){
              verif <- verificar_pagados(vars$cuenta$cuenta, vars$choosen_cuenta$cuenta)
              print("verificado")
              print(verif)
              vars$cuenta <- verif$user
              vars$choosen_cuenta <- verif$choosen
              
              vars$choosen_cuenta <- list_table_var_mysql("cuentas2", "cuenta", isolate(vars$choosen_cuenta$cuenta))
              
              #vars$avisos <- generate_avisos(vars$choosen_cuenta)
              
              saldo <- ifelse(vars$cuenta_myplace_on, vars$choosen_cuenta$myplace_saldo_avaluos, vars$choosen_cuenta$saldo)
              
              if(saldo < 0) saldo <- 0
              print("saldo")
              print(saldo)
              if(!is.na(vars$choosen_cuenta$myplace_plan) && vars$cuenta_myplace_on){
                if(vars$choosen_cuenta$myplace_activo == "no"){
                  modal_invitar_suscripcion("Si quieres realizar avalúos")
                  seguir <- FALSE
                }else{
                  if(saldo == 0){
                    showModal(modalDialog(
                      h4("Posees una cuenta activa de MyPlace pero tu saldo de avalúos es insuficiente."),
                      h4("Puedes realizar una recarga de 5 avalúos por 49.000 Gs."),
                      br(),
                      tags$div(id="bttn_modal", 
                               actionBttn("buy_recarga_myplace5", "Recargar"),
                               actionBttn("close_modal", "Cancelar"),
                               align = "center"),
                      title = "Recarga MyPlace",
                      easyClose = FALSE,
                      footer = NULL,
                      size = "s",
                      fade = TRUE
                    ))
                    seguir <- FALSE
                  }else{
                    seguir <- TRUE
                  }
                }
              }else{
                seguir <- TRUE
              }
            }else{
              seguir <- TRUE
            }
            
            if(seguir){
              
              print("paso todo")
              print("mercado_on")
              print(input$mercado_on)
              vars$consulta$rubro <- ifelse(input$mercado_on, input$categoria, NA)
              vars$consulta$tipo <- input$tipo
              vars$consulta$m2_terreno <- 0
              vars$consulta$m2_inmueble <- 0
              vars$consulta$lujo <- NA
              vars$consulta$dormitorios <- 0
              vars$consulta$banios <- 0
              vars$consulta$garajes <- 0
              vars$consulta$piscina <- 0
              vars$consulta$balcon <- 0
              vars$consulta$area_servicio <- 0
              vars$consulta$gimnasio <- 0
              vars$consulta$antiguedad <- NA
              vars$consulta$condicion <- NA
              vars$consulta$pais <- NA
              vars$consulta$ciudad <- NA
              vars$consulta$barrio <- NA
              vars$consulta$calle <- NA
              if(vars$map_coords == TRUE){
                vars$consulta$lng <- vars$place$lon
                vars$consulta$lat <- vars$place$lat
              }else{
                vars$consulta$lng <- vars$lng
                vars$consulta$lat <- vars$lat
              }
              print("antes del modal")
              print(vars$consulta)
              showModal(modalDialog(
                fluidPage(
                  div(paste("Tipo de propiedad:", input$tipo)),
                  if(input$tipo == "Terreno"){
                    vars$consulta$m2_terreno <- m2_terreno
                    fluidPage(
                      div(paste("Area del terreno:", m2_terreno, "m2"))
                    )
                  },
                  if(input$tipo == "Casa" & vars$lujo == TRUE){
                    vars$consulta$m2_terreno <- m2_terreno
                    vars$consulta$lujo <- "Si"
                    vars$consulta$m2_inmueble <- str_replace(input$m2_inmueble, ",", "\\.") %>% as.integer()
                    fluidPage(
                      div(paste("Area del terreno:", m2_terreno, "m2")),
                      div(paste("Casa de lujo:", ifelse(vars$lujo == TRUE, "Si", "No"))),
                      div(paste("Area construida:", vars$consulta$m2_inmueble, "m2"))
                    )
                  },
                  if(input$tipo == "Casa" & vars$lujo == FALSE){
                    vars$consulta$m2_terreno <- m2_terreno
                    vars$consulta$lujo <- "No"
                    vars$consulta$m2_inmueble <- str_replace(input$m2_inmueble, ",", "\\.") %>% as.integer()
                    vars$consulta$antiguedad <- input$age
                    vars$consulta$condicion <- input$condition
                    fluidPage(
                      div(paste("Area del terreno:", m2_terreno, "m2")),
                      div(paste("Casa de lujo:", ifelse(vars$lujo == TRUE, "Si", "No"))),
                      div(paste("Area construida:", vars$consulta$m2_inmueble, "m2")),
                      div(paste("Antiguedad:", input$age)),
                      div(paste("Estado general:", input$condition))
                    )
                  },
                  if(input$tipo == "Duplex"){
                    vars$consulta$m2_terreno <- m2_terreno
                    vars$consulta$m2_inmueble <- str_replace(input$m2_inmueble, ",", "\\.")
                    vars$consulta$antiguedad <- input$age
                    vars$consulta$condicion <- input$condition
                    fluidPage(
                      div(paste("Area del terreno:", m2_terreno, "m2")),
                      div(paste("Area construida:", vars$consulta$m2_inmueble, "m2")),
                      div(paste("Antiguedad:", input$age)),
                      div(paste("Estado general:", input$condition))
                    )
                  },
                  if(input$tipo == "Departamento"){
                    vars$consulta$m2_inmueble <- str_replace(input$m2_inmueble, ",", "\\.")
                    vars$consulta$dormitorios <- as.numeric(input$dormitorios)
                    vars$consulta$banios <- as.numeric(input$banios)
                    vars$consulta$garajes <- as.numeric(input$garajes)
                    vars$consulta$piscina <- ifelse(input$piscina == TRUE, 1, 0)
                    vars$consulta$balcon <- ifelse(input$balcon == TRUE, 1, 0)
                    vars$consulta$area_servicio <- ifelse(input$area_servicio == TRUE, 1, 0)
                    vars$consulta$gimnasio <- ifelse(input$gimnasio == TRUE, 1, 0)
                    vars$consulta$antiguedad <- input$age
                    vars$consulta$condicion <- "Excelente"
                    fluidPage(
                      div(paste("Area construida:", vars$consulta$m2_inmueble, "m2")),
                      div(paste("Dormitorios:", ifelse(input$dormitorios == "0", "Monoambiente", input$dormitorios))),
                      div(paste("Baños:", input$banios)),
                      div(paste("Cocheras:", input$garajes)),
                      div(paste("Balcón:", ifelse(input$balcon == TRUE, "si", "no"))),
                      div(paste("Area de servicio:", ifelse(input$area_servicio == TRUE, "si", "no"))),
                      div(paste("Piscina:", ifelse(input$piscina == TRUE, "si", "no"))),
                      div(paste("Gimnasio:", ifelse(input$gimnasio == TRUE, "si", "no"))),
                      div(paste("Antiguedad:", input$age))
                    )
                  },
                ), br(),
                if(input$mercado_on){
                  paste0("Datos de mercado: ", input$rubro, "  -  ", input$categoria)
                }, 
                br(), 
                "CUENTA: ", vars$choosen_cuenta$cuenta, br(),
                if(vars$consul_py){
                  div("SALDO: ", saldo, " consultas", br()) 
                }else{
                  div("Las consultas fuera de Paraguay son gratuitas", br()) 
                },
                br(),
                div(id = "bttn_modal",
                    actionButton("confirm", "Confirmar"), 
                    actionButton("close_modal", "Cancelar"), 
                    align = "center"),
                title = "Confirme los datos del formulario",
                easyClose = TRUE,
                footer = NULL,
                size = "s",
                fade = TRUE
              ))
            }
          }
        }
      }
    })
  })
  
  observeEvent(input$confirm, {
    vars$choosen_cuenta <- list_table_var_mysql("cuentas2", "cuenta", isolate(vars$choosen_cuenta$cuenta))
    
    saldo <- ifelse(vars$cuenta_myplace_on, vars$choosen_cuenta$myplace_saldo_avaluos, vars$choosen_cuenta$saldo)
    
    if(saldo < 0) saldo <- 0
    
    if(saldo == 0 & vars$consul_py == TRUE){
      print("saldo insuficiente")
      shinyalert(
        type = "error",
        title = "Saldo insuficiente. En Planes puedes adquirir más saldo de avalúos o suscribirte a uno de los planes MyPlace que te acreditarán 10 avalúos por mes."
      )
      removeModal()      
    }else{  
      print("tiene saldo")
      
      point_sf <- data.frame(lat = vars$consulta$lat, lon = vars$consulta$lng) %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
      geo <- reverse_geocode(point_sf)
      vars$consulta$pais <- geo$country
      vars$consulta$ciudad <- geo$city
      vars$consulta$barrio <- geo$district
      vars$consulta$calle <- geo$street
      
      vars$consulta$date <- as.character(trunc(now("America/Asuncion")))
      vars$consulta$cuenta <- vars$choosen_cuenta$cuenta
      
      print("consulta")
      print(vars$consulta)
      save_mysql(vars$consulta, "consultas_inmo", FALSE)
      
      if(vars$consul_py){
        
        if(vars$cuenta_myplace_on){
          update_var_table_mysql(vars$choosen_cuenta$myplace_saldo_avaluos -1, 
                                 "myplace_saldo_avaluos", "cuenta", vars$choosen_cuenta$cuenta, "cuentas2")
          update_var_table_mysql(as.character(now("America/Asuncion")), "date", "cuenta", vars$choosen_cuenta$cuenta, "cuentas2")
          vars$choosen_cuenta$myplace_saldo_avaluos <- vars$choosen_cuenta$myplace_saldo_avaluos - 1
        }else{
          update_var_table_mysql(vars$choosen_cuenta$saldo -1, 
                                 "saldo", "cuenta", vars$choosen_cuenta$cuenta, "cuentas2")
          update_var_table_mysql(as.character(now("America/Asuncion")), "date", "cuenta", vars$choosen_cuenta$cuenta, "cuentas2")
          vars$choosen_cuenta$saldo <- vars$choosen_cuenta$saldo - 1
        }
      }
      showModal(modalDialog(
        h3("Su consulta será respondida en breve, puede aguardarla aquí, en el whatsapp o en el correo electrónico"),
        div(id = "bttn_modal",
            actionButton("confirm_ok", "OK"),
            align = "center"),
        title = "",
        easyClose = FALSE,
        footer = NULL,
        size = "s",
        fade = TRUE
      ))
    }
  })
  
  observeEvent(input$confirm_ok, {
    vars$report_new <- TRUE
    removeModal()
  })
  
  searching_new_report <- function(time){
    stop <- 0
    while(stop == 0 ){
      Sys.sleep(10)
      table <- "consultas_inmo_full"
      conn <- DBI::dbConnect(RMySQL::MySQL(), dbname = "defaultdb", 
                             host = "placeanalyzerdb-do-user-9117395-0.b.db.ondigitalocean.com", 
                             port = 25060, 
                             user = "doadmin", 
                             password = "k03msju7c86b4pmy")
      
      query <- sprintf("SELECT * FROM %s", table)
      data <- DBI::dbGetQuery(conn, query)
      DBI::dbDisconnect(conn)
      con_full <- data
      if(time %in% con_full$date){
        stop <- 1
      }
    }
  }
  
  long_run <- eventReactive(input$confirm_ok, {
    time <- vars$consulta$date
    x <- callr::r_bg(
      func = searching_new_report,
      args = list(time),
      supervise = TRUE
    )
    return(x)
  })
  
  check <- reactiveVal(FALSE)
  
  check <- reactive({
    invalidateLater(millis = 3000, session = session)
    if (long_run()$is_alive()) {
      x <- FALSE
    } else {
      x <- TRUE
    }
    return(x)
  })
  
  observeEvent(check(), {
    if(vars$report_new == TRUE){
      print("waiting...")
      if(check() == TRUE){
        vars$report_new <- FALSE
        con <- load_mysql("consultas_inmo_full")
        time <- paste0(str_split(vars$consulta$date, " ")[[1]][1:2], collapse = " ")
        file <- con$file[con$date == time]
        showModal(modalDialog(
          h3("Tu reporte ya se encuentra disponible"),
          br(), br(),
          div(id = "bttn_modal",
              a(href= file, target="_blank", actionButton("close_modal", "Abrir reporte", icon = icon("newspaper"))),  align = "center"),
          title = "",
          easyClose = TRUE,
          footer = NULL,
          size = "s",
          fade = TRUE
        ))
      }
    }
  })
  
  output$notificacion_generando_ui <- renderUI({
    req(vars$report_new)
    if(vars$report_new == TRUE){
      div(
        absolutePanel(
          top = ifelse(input$dimension[1] < 768, 130, 80), left = "auto", right = 240, bottom = "auto",
          width = 30, height = 30,
          div(style = paste0("background: white; border-radius: 15px; z-index: 1000000; width: 130px;
              height: 50px; border-style: solid; border-width: 1px; border-color: ", main_color, ";"),
              div(class = "btn-group", img(src = "procesing.gif", width = "40px")),
              div(class = "btn-group", h5("Generando Reporte"), style = "width: 80px;")
          )
        )
      )
    }
  })
  
  output$notificacion_saldo_ui <- renderUI({
    if(place_on() == 1){
      
      verif <- verificar_pagados(vars$cuenta$cuenta, vars$choosen_cuenta$cuenta)
      print("verificado")
      print(verif)
      vars$cuenta <- verif$user
      vars$choosen_cuenta <- verif$choosen
      vars$choosen_cuenta <- list_table_var_mysql("cuentas2", "cuenta", isolate(vars$choosen_cuenta$cuenta))
      saldo <- ifelse(vars$cuenta_myplace_on, vars$choosen_cuenta$myplace_saldo_avaluos + vars$choosen_cuenta$saldo, vars$choosen_cuenta$saldo)
      
      div(
        absolutePanel(
          top = ifelse(input$dimension[1] < 768, 130, 80), left = "auto", right = 80, bottom = "auto",
          width = 30, height = 30,
          div(style = paste0("background: white; border-radius: 20px; z-index: 1001; width: 60px;
                           height: 60px; border-style: solid; border-width: 1px; border-color: ", main_color, ";"),
              div(saldo, 
                  style = paste0("color: ", main_color, "; font-weight: bold; font-size: 200%;")),
              div(h5("Saldo"), style = "margin-top: -10px"),
              align = "center"  
          )
        )
      )
    }
  })
  
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #place view
  
  output$place_view_ui <- renderUI({
    if(place_view_on() == 1){
      fluidPage(
        div(style = paste0("background: white; border-style: solid; border-width: 2px; border-color: ", main_color, ";
            border-radius: 10px; padding: 10px; box-shadow: 0px 10px 10px #aaaaaa"),
            h4("Con Place View podrá recorrer las calles, visitar el sitio de su interés, estudiar la zona y todo gracias a las miles de fotos 360 que otorgan una experiencia única similar a la de estar en el sitio visitado.", style = "color: #666666")
        ),
        br(),
        fluidPage(style = paste0("background: white; border-style: solid; border-width: 2px; border-color: ", main_color, ";
            border-radius: 10px; padding: 10px; box-shadow: 0px 10px 10px #aaaaaa"),
                  leafletOutput("map_place_view", height = "75vh")
        )
      )
    }
  })  
  
  observe({
    req(input$map_place_view_zoom, input$map_place_view_center)
    print(input$map_place_view_center)
    vars$last_zoom_view <- input$map_place_view_zoom
    print(vars$last_zoom_view)
    
    ubi <- data.frame(lat = input$map_place_view_center$lat, lon = input$map_place_view_center$lng)
    print(ubi)
    vars$place <- ubi
    
    vars$view <- ubi %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
    
    if(input$map_place_view_zoom == 18){
      print("nuevo punto")
      vars$map_coords <- TRUE
      size <- 300/100000
      lat_min <- ubi$lat - size
      lat_max <- ubi$lat + size
      lon_min <- ubi$lon - size
      lon_max <- ubi$lon + size
      fotos360 <- filter_box_table_mysql(lat_min, lat_max, lon_min, lon_max, "fotos_street360")
      vars$fotos_no_vistas <- fotos360[!fotos360$id %in% vars$fotos_vistas$id,]
    }else{
      vars$fotos_no_vistas <- data.frame()
    }
  })
  
  output$map_place_view <- renderLeaflet({
    if(place_view_on() == 1){
      refresh_pin_fotos()
      #download.file("https://place-storage.nyc3.digitaloceanspaces.com/fotos-street360/limite_fotos.rda", "temp_limit.rda")
      load(url("https://place-storage.nyc3.digitaloceanspaces.com/fotos-street360/limite_fotos.rda"))
      
      map <- leaflet(options = leafletOptions(dragging=TRUE)) %>% addSearchOSM() %>%
        setView(st_coordinates(isolate(vars$view))[1], st_coordinates(isolate(vars$view))[2], zoom = isolate(vars$last_zoom_view)) %>%
        #addMarkers(st_coordinates(isolate(vars$view))[1], st_coordinates(isolate(vars$view))[2], icon = pin_circle) %>%
        addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
        addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
        #      addTiles("https://mt1.google.com/vt?lyrs=h@159000000,traffic|seconds_into_week:-1&style=3&x={x}&y={y}&z={z}", group = "tráfico") %>% 
        addPolylines(data = limite_fotos) %>%
        addLayersControl(baseGroups = c("mapa", "satélite"), overlayGroups = c("vistas", "no vistas"),
                         options = layersControlOptions(collapsed=FALSE), position = "bottomleft") %>%
        setMapWidgetStyle(list(background = "transparent")) %>%
        addLegend(colors = c("transparent", "transparent"),
                  labels = c(HTML('<img src="photo_visto.png" width="25"> Vistos'),
                             HTML('<img src="photo.png" width="25"> No Vistos')),
                  title = NULL)
      
      if(nrow(vars$fotos_vistas) != 0){
        map <- map %>% addMarkers(data = vars$fotos_vistas, icon = pin_360_visto, layerId = ~id, group = "vistas")
      }
      
      if(nrow(vars$fotos_no_vistas) != 0){
        map <- map %>% addMarkers(data = vars$fotos_no_vistas, icon = pin_360, layerId = ~id, group = "no vistas")
      }
      map
      
    }
  })
  
  refresh_pin_fotos <- reactiveVal(0)
  
  observeEvent(input$map_place_view_marker_click, {
    click <- input$map_place_view_marker_click
    vars$show_foto <- list_table_var_mysql("fotos_street360", "id", click$id)
    modal_foto_description()
  })
  
  observeEvent(input$close_foto_modal, {
    refresh_pin_fotos(isolate(refresh_pin_fotos()) + 1)
    
    foto_360 <- vars$show_foto
    if(!foto_360$id %in% vars$fotos_vistas$id){
      new_foto360_db <- data.frame(
        id = new_id_table_mysql("id", "fotos_street360_db", "foto_db_", 14),
        user = vars$user$user,
        foto_id = foto_360$id,
        fecha = as.character(now("America/Asuncion")),
        lat = foto_360$lat,
        lng = foto_360$lng
      )
      save_mysql(new_foto360_db, "fotos_street360_db", FALSE)
      
      vars$fotos_vistas <- rbind(vars$fotos_vistas, foto_360)
      vars$fotos_no_vistas <- vars$fotos_no_vistas[vars$fotos_no_vistas$id != foto_360$id,]
    }
    vars$show_foto <- NA
    removeModal()
  })
  
  observeEvent(input$map_place_view_center, {
    df <- input$map_place_view_center %>% unlist() %>% unname()
    place <- data.frame(lat=df[2], lng=df[1])
    vars$view <- place %>% st_as_sf(coords = c("lng", "lat"), crs = crs)
  })
  
  output$formulario_foto_ui <- renderUI({
    req(vars$show_foto)
    foto <- vars$show_foto
    div(align = "center",
        HTML(paste0('<iframe width="100%" height="400" allowfullscreen style="border-style:solid;border-color:#666666;border-radius:20px;" 
                        src="https://cdn.pannellum.org/2.5/pannellum.htm#panorama=', foto$img, '&autoLoad=true&autoRotate=2"></iframe>'))
    )
  })
  
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #Capacitaciones
  
  output$capacitacion_ui <- renderUI({
    if(capacitacion_on() == 1){
      fluidPage(
        if(permiso("editar capacitaciones", NA, vars$permisos_acc, vars$permisos_men)){
          tags$div(id = "inline", 
                   actionButton("capa_new", "Nueva capacitación", icon = icon("plus"),
                                style = "margin: 10px"), align = "right")
        },
        br(),
        div(
          uiOutput("capa_filtros_ui"),
          hr(),
          uiOutput("capa_box_ui")
        )
      )   
    }
  })
  
  
  output$capa_filtros_ui <- renderUI({
    div()
  }) 
  
  obs_folder_on_off <- list()
  
  observeEvent(vars$capa_folders, {
    req(vars$capa_folders, vars$capa_selected)
    print("inicia render filtros capacitaciones")
      output$capa_filtros_ui <- renderUI({
        boxes <- as.list(1:length(vars$capa_folders))
        boxes <- lapply(boxes, function(i){
          btName <- paste0("capa_folder", i)
          
          obs_folder_on_off[[btName]] <<- observeEvent(input[[btName]], ignoreNULL = TRUE, ignoreInit = TRUE, {
            freezeReactiveValue(input, btName)
            vars$capa_selected <- vars$capa_folders[i]
          })
          
          div(style = "padding: 10px; display:inline-block",
              actionButton(btName, vars$capa_folders[i],
                           style = ifelse(vars$capa_folders[i] == vars$capa_selected, 
                                          paste0("border-radius: 10px; background-color: ", main_color, ";
                                                         font-size: 130%; color: white;
                                                         border: 2px solid ", main_color),
                                          paste0("border-radius: 10px; background-color: white;
                                                         font-size: 130%; color: ", main_color, ";
                                                         border: 2px solid ", main_color)))
          )
        })
      })
  })
  
  observe({
    req(vars$capa_list_all, vars$capa_selected)
    if(vars$capa_selected != "Todos"){
      vars$capa_page_all <- vars$capa_list_all %>% filter(tipo == vars$capa_selected)
    }else{
      vars$capa_page_all <- vars$capa_list_all
    }
  })
  
  observeEvent(input$capa_new, {
    vars$foto_cliente <- NULL
    vars$edit_tipo <- data.frame()
    showModal(modalDialog(
      tags$div(id = "inline",
               uiOutput("file_input_cliente"),
               br(),
               textInput("capa_tipo", HTML("<p><span style='font-weight: 400'>Clasificación</span></p>")),
               textInput("capa_link", HTML("<p><span style='font-weight: 400'>Link de YouTube</span></p>")),
               textAreaInput("capa_titulo",
                             HTML("<p><span style='font-weight: 400'>Encabezado</span></p>"),
                             width = "100%"),
               textAreaInput("capa_descripcion",
                             HTML("<p><span style='font-weight: 400'>Descripción</span></p>"),
                             width = "100%")
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("capa_new_ok", "Guardar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Nueva capacitación",
      easyClose = FALSE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$capa_new_ok, {
    id <- new_id_table_mysql("id", paste0(co, "_capacitaciones"), "capacit_", 10)
    new_capa <- data.frame(
      id = id,
      fecha = as.character(now("America/Asuncion")),
      user = vars$user$user,
      tipo = ifelse(input$capa_tipo == "", NA, input$capa_tipo),
      link = input$capa_link,
      img = NA,
      descripcion = str_trunc(input$capa_descripcion, 100),
      titulo = str_trunc(input$capa_titulo, 40)
    )
    
    if(!is.null(isolate(vars$foto_cliente))){
      if(!is.null(vars$upload_cliente)){
        rand <- str_pad(round(runif(1, min=1, max=999)), 3, pad = "0")
        put_object_do(paste0("/", co, "/fotos-capacitaciones/", id, "_", rand, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
        new_capa$img <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/fotos-capacitaciones/", id, "_", rand, ".jpg")
      }
      vars$foto_cliente <- NULL
    }
    save_mysql(new_capa, paste0(co, "_capacitaciones"), FALSE)
    vars$capa_list_all <- rbind(isolate(vars$capa_list_all), new_capa)
    vars$capa_folders <- c("Todos", unique(vars$capa_list_all$tipo[!is.na(vars$capa_list_all$tipo)]))
    removeModal()
  })
  
  output$capa_box_ui <- renderUI({
    div()
  }) 
  
  obs_capa_show <- list()
  
  observeEvent(vars$capa_page_all, {
    req(vars$capa_page_all)
    print("inicia render capacitaciones")
    capa_list_all <- vars$capa_page_all
    if(nrow(capa_list_all) != 0){
      output$capa_box_ui <- renderUI({
        boxes <- as.list(1:nrow(capa_list_all))
        boxes <- lapply(boxes, function(i){
          btName <- paste0("capa_show", i)
          obs_capa_show[[btName]] <<- observeEvent(input[[btName]], ignoreNULL = TRUE, ignoreInit = TRUE, {
            freezeReactiveValue(input, btName)
            vars$capa_show <- capa_list_all[i,]
            link <- str_split(capa_list_all$link[i], "/")[[1]]
            link <- paste0("/", link[length(link)])
            print(link)
            showModal(modalDialog(
              div(embed_youtube(link, width = 560, height = 420, ratio = "4by3"), align = "center"),
              if(permiso("editar capacitaciones", NA, vars$permisos_acc, vars$permisos_men)){
                div(style = "position: absolute; margin-top: 0px; margin-left:10px",
                    actionButton(inputId = "modal", label = NULL, icon = icon("edit"), 
                                 onclick = 'Shiny.setInputValue(\"capa_edit\", this.id, {priority: \"event\"})',
                                 style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px"),
                    actionButton(inputId = "modal", label = NULL, icon = icon("trash-alt"), 
                                 onclick = 'Shiny.setInputValue(\"capa_delete\", this.id, {priority: \"event\"})',
                                 style = "background: transparent; border-color: transparent; border-radius: 5px; font-size: 140%;
                         padding: 0px; padding-left: 20px")
                )
              },
              tags$div(id="bttn_modal", 
                       actionBttn("close_modal", "OK"),
                       align = "center"),
              title = capa_list_all$titulo[i],
              easyClose = TRUE,
              footer = NULL,
              size = "m",
              fade = TRUE
            ))
          })
          vars$link_capacitacion <- capa_list_all$link[i]
          vars$titulo_capacitacion <- capa_list_all$titulo[i]
          div(style = "padding: 10px; display:inline-block",
              div(style = paste0("border-style: solid; border-width: 1px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; width: 242px; height: 310px;
                                 padding: 0px;"),
                  div(      
                    div(style = "height: 50px; position: absolute; margin-top: 190px; margin-left:10px; width: 220px", 
                        HTML(paste0("<p><span style='font-size: 140%; font-weight: normal; color: #888888'>", 
                                    capa_list_all$titulo[i], "</span></p>"))),
                    div(style = "height: 50px; position: absolute; margin-top: 240px; margin-left:10px; width: 220px", 
                        h5(capa_list_all$descripcion[i])),
                    actionButton(btName, NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:240px; height: 180px; 
                                                             border-radius: 8px 8px 0px 0px;
                                                             background-image: url("', capa_list_all$img[i], '");
                                                             background-size: cover, 240px 180px;')),
                  )
              )
          )
        })
      })
    }
  })
  
  observeEvent(input$capa_edit, {
    capa <- vars$capa_show
    vars$foto_cliente <- capa$img
    showModal(modalDialog(
      tags$div(id = "inline",
               uiOutput("file_input_cliente"),
               br(),
               textInput("capa_tipo", HTML("<p><span style='font-weight: 400'>Clasificación</span></p>"), value = ifelse(is.na(capa$tipo), "", capa$tipo)),
               textInput("capa_link", HTML("<p><span style='font-weight: 400'>Link de YouTube</span></p>"), value = capa$link),
               textAreaInput("capa_titulo", value = capa$titulo,
                             HTML("<p><span style='font-weight: 400'>Encabezado</span></p>"),
                             width = "100%"),
               textAreaInput("capa_descripcion", value = capa$descripcion,
                             HTML("<p><span style='font-weight: 400'>Descripción</span></p>"),
                             width = "100%")
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("capa_edit_ok", "Guardar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Editar capacitación",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$capa_edit_ok, {
    new_capa <- data.frame(
      id = vars$capa_show$id,
      fecha = as.character(now("America/Asuncion")),
      user = vars$user$user,
      tipo = ifelse(input$capa_tipo == "", NA, input$capa_tipo),
      link = input$capa_link,
      img = vars$capa_show$img,
      descripcion = str_trunc(input$capa_descripcion, 100),
      titulo = str_trunc(input$capa_titulo, 40)
    )
    if(!is.null(isolate(vars$foto_cliente))){
      if(!is.null(vars$upload_cliente)){
        rand <- str_pad(round(runif(1, min=1, max=999)), 3, pad = "0")
        if(!is.na(vars$capa_show$img)){
          delete_object_do(str_remove(vars$capa_show$img, "https://place-storage.nyc3.digitaloceanspaces.com"))
        }
        put_object_do(paste0("/", co, "/fotos-capacitaciones/", vars$capa_show$id, "_", rand, ".jpg"), file.path(dir, paste0(session$token, "temp_foto_cliente.jpg")))
        new_capa$img <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, "/fotos-capacitaciones/", vars$capa_show$id, "_", rand, ".jpg")
      }
      vars$foto_cliente <- NULL
      vars$edit_tipo <- data.frame()
    }
    del_var_table_mysql("id", vars$capa_show$id, paste0(co, "_capacitaciones"))
    save_mysql(new_capa, paste0(co, "_capacitaciones"), FALSE)
    
    vars$capa_list_all <- load_mysql(paste0(co, "_capacitaciones"))
    vars$capa_folders <- c("Todos", unique(vars$capa_list_all$tipo[!is.na(vars$capa_list_all$tipo)]))
    removeModal()
  })
  
  observeEvent(input$capa_delete, {
    showModal(modalDialog(
      h4("¿Está seguro que desea eliminar la capacitación?"),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("capa_delete_ok", "Eliminar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Eliminar capacitación",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$capa_delete_ok, {
    delete_object_do(str_remove(vars$capa_show$img, "https://place-storage.nyc3.digitaloceanspaces.com"))
    del_var_table_mysql("id", vars$capa_show$id, paste0(co, "_capacitaciones"))
    vars$capa_list_all <- load_mysql(paste0(co, "_capacitaciones"))
    vars$capa_folders <- c("Todos", unique(vars$capa_list_all$tipo[!is.na(vars$capa_list_all$tipo)]))
    removeModal()
  })
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #Perfil de usuario
  
  output$perfil_bttn_ui <- renderUI({
    if(vars$start == FALSE){
      if(is.na(vars$user$img)){
        avatar <- "blank_avatar.png"
      }else{
        avatar <- vars$user$img
      }
      div(style = "padding: 5px; padding-right: 20px; height: 40px",
          actionButton("perfil_open", NULL, style = paste0('background-color: transparent;
                                                             border-radius: 20px;
                                                             border: 0px; width:40px; height: 40px;
                                                             background-image: url("', avatar, '");
                                                             background-size: cover, 40px 40px;')))
    }
  })
  
  observeEvent(input$perfil_open, {
    vars$foto_perfil <- NA
    vars$new_agente <- FALSE
    vars$new_agencia <- FALSE
    vars$new_franquicia <- FALSE
    vars$image_perfil_new <- FALSE
    vars$foto_perfil <- vars$user$img
    agencia_nam <- agencia_name(vars$user$agencia, vars$agencias, vars$franquicias)
    showModal(modalDialog(
      fluidRow(style = "padding:0px",
               column(4,
                      uiOutput("image_perfil")#,
                      #                      div(id = "inline",
                      #                          fileInput(inputId = "upload_perfil",
                      #                                    label = NULL,
                      #                                    buttonLabel = "Subir foto",
                      #                                    placeholder = "no hay fotos",
                      #                                    accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
                      #                          align = "center")
               ),
               column(8,
                      actionButton("cargo_changeXXX", paste0("Cargo: ", vars$user$cargo), icon = icon("edit"), 
                                   style = "background-color: transparent; border-width: 0px"), br(),
                      actionButton("name_change", paste0("Nombre: ", vars$user$name), icon = icon("edit"), 
                                   style = "background-color: transparent; border-width: 0px"), br(),
                      actionButton("phone_change", paste0("Telefono: ", vars$user$phone), icon = icon("edit"),
                                   style = "background-color: transparent; border-width: 0px"), br(),
                      actionButton("birthday_change", paste0("Fecha de nacimiento: ", vars$user$birthday), icon = icon("edit"),
                                   style = "background-color: transparent; border-width: 0px"), br(),
                      actionButton("agencia_changeXXX", paste0("Agencia: ", agencia_nam), icon = icon("edit"),
                                   style = "background-color: transparent; border-width: 0px"), br(),
                      if(vars$user$cargo == "Asesor"){
                        div(
                          actionButton("comision_changeXXX", paste0("Comisión: ", vars$user$comision), icon = icon("edit"),
                                       style = "background-color: transparent; border-width: 0px"), br()
                        )
                      },
                      actionButton("pass_change", "Contraseña: ********", icon = icon("edit"),
                                   style = "background-color: transparent; border-width: 0px"), br(),
                      actionButton("razon_change", paste0("Razón social: ", ifelse(is.na(vars$user$razon), "", vars$user$razon)), icon = icon("edit"),
                                   style = "background-color: transparent; border-width: 0px"), br(),
                      actionButton("ruc_change", paste0("RUC: ", ifelse(is.na(vars$user$ruc), "", vars$user$ruc)), icon = icon("edit"),
                                   style = "background-color: transparent; border-width: 0px"), br(),
               ),
      ),
      br(),
      uiOutput("configuracion_ui"),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("close_modal", "OK"),
               align = "center"),
      title = "Perfil de usuario",
      easyClose = TRUE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  output$image_perfil <- renderUI({
    if(!is.na(vars$foto_perfil)){
      div(
        tags$img(src= vars$foto_perfil, width = "180px"),
        align = "center"
      )
    }else{
      div(
        tags$img(src= "blank_avatar.png", width = "180px"),
        align = "center"
      )
    }
  })
  
  observe({
    if(!is.null(input$upload_perfil)){
      size <- file.info(input$upload_perfil$datapath)$size
      max_size <- 10*1024^2
      if(size > max_size){
        shinyalert(
          type = "error",
          title = "La imagen supera el tamaño permitido de 10Mb"
        )
        return(NULL)
      }else{
        if(!(str_detect(input$upload_perfil$datapath, fixed(".jpg")) | 
           str_detect(input$upload_perfil$datapath, fixed(".jpeg")) |
           str_detect(input$upload_perfil$datapath, fixed(".png")))){
          shinyalert(
            type = "error",
            title = "La imagen debe ser .jpg, .jpeg o .png"
          )
          print(input$upload_perfil$datapath)
          print("La imagen de asesor no es jpg o png")
          return(NULL)
        }else{
        im <- image_read(input$upload_perfil$datapath)
        im <- image_orient(im)
        im <- image_convert(im, format = "jpg")
        info <- image_info(im)
        w <- info$width
        h <- info$height
        horiz <- w >= h
        im <- image_crop(im, paste0(ifelse(horiz, h, w), "x", 
                                    ifelse(horiz, h, w), "+", 
                                    ifelse(horiz, (w - h)/2, 0), "+",
                                    ifelse(horiz, 0, (h - w)/2)))
        im <- image_scale(im, "500x")
        image_write(im, file.path(dir, paste0(session$token, "temp_foto_perfil.jpg")))
        vars$foto_perfil <- dataURI(file = file.path(dir, paste0(session$token, "temp_foto_perfil.jpg")))
        info <- image_info(im)
        w <- info$width
        h <- info$height
        horiz <- w >= h
        im_small <- image_crop(im, paste0(ifelse(horiz, h, w), "x", 
                                          ifelse(horiz, h, w), "+", 
                                          ifelse(horiz, (w - h)/2, 0), "+",
                                          ifelse(horiz, 0, (h - w)/2)))
        im_small <- image_scale(im_small, "250x")
        image_write(im_small, file.path(dir, paste0(session$token, "temp_foto_perfil_small.jpg")))
        isolate({
          if(vars$image_perfil_edit == TRUE){
            user <- vars$show_agente
          }else{
            user <- vars$user
          }
          if(vars$new_agente == FALSE & vars$new_agencia == FALSE & vars$new_franquicia == FALSE){
            print("cambio foto")
            if(!is.na(vars$user$img)){
              name <- str_remove(user$img, "https://place-storage.nyc3.digitaloceanspaces.com")
              delete_object_do(name)
              delete_object_do(str_remove(name, "-small"))
            }
            serie <- round(runif(1, min=10, max=99))
            put_object_do(paste0("/avatar-users/", user$user, "-", serie,  ".jpg"), file.path(dir, paste0(session$token, "temp_foto_perfil.jpg")))
            put_object_do(paste0("/avatar-users/", user$user, "-", serie, "-small.jpg"), file.path(dir, paste0(session$token, "temp_foto_perfil_small.jpg")))
            url <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/avatar-users/", user$user, "-", serie, "-small.jpg")
            update_var_table_mysql(url, "img", "user", user$user, "myplace_usuarios")
            update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user$user, "myplace_usuarios")
            if(vars$image_perfil_edit == TRUE){
              vars$office_agen_all_pages$img[vars$office_agen_all_pages$user == user$user] <- url
            }else{
              vars$user$img <- url
            }
            
          }
        })
      }
    }
    }
  })
  
  output$configuracion_ui <- renderUI({
    fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white"),
              h4(HTML(paste0("<p><span style='color: ", main_color, "'>Configuraciones</span></p>")), width = "100%"),
              div(id = "inline", actionButton("olvidar_dispositivo", "Cerrar sesión"), align = "right"),
              br(),
              br(),
              tags$div(id = "inline",
                       if(vars$user$cargo == "Global Master Office"){
                         actionButton("crear_franquicia", "Crear Country Master office")
                       },
                       if(vars$user$cargo %in% c("Country Office Manager", "Global Master Office", "Global Office Manager")){
                         div(
                           actionButton("crear_agencia", "Crear Broker Office")
                         )
                       }
              ),
              br(),
              tags$div(id = "inline",
                       actionButton("ver_organigrama", "Ver organigrama")
              ),
              if(vars$user$cargo == "Global Master Office"){
                tags$div(id = "inline",
                         actionButton("adm_permisos", "Administrar permisos")
                )
              },
              br()
    )
  })
  
  observeEvent(input$adm_permisos, {
    showModal(modalDialog(
      uiOutput("table_permisos_ui"),
      br(),
      tags$div(id="bttn_modal", 
               actionButton(inputId = "modal", label = "OK",
                            onclick = 'Shiny.setInputValue(\"perfil_open\", this.id, {priority: \"event\"})'),
               align = "center"),
      title = "Administrar permisos",
      easyClose = FALSE,
      footer = NULL,
      size = "l",
      fade = TRUE
    ))
  })
  
  output$table_permisos_ui <- renderUI({
    fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 0px; margin: 0px;
                                                    margin-top: 10px",
              div(style = 'overflow-x: scroll',DT::dataTableOutput("table_permisos",width = "100%"))
    )
  })
  
  output$table_permisos <- renderDataTable({
    permisos <- load_mysql(paste0(co, "_permisos")) %>% select(-c(id, tipo_accion))
    vars$permisos <- permisos
    datatable(vars$permisos, editable = 'cell',
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 10, dom = 'ftp'), selection = "single")
  })
  
  observeEvent(input$table_permisos_cell_edit, {
    if(input$table_permisos_cell_edit$value %in% c("si", "no")){
      permisos <- load_mysql(paste0(co, "_permisos"))
      permisos[input$table_permisos_cell_edit$row,input$table_permisos_cell_edit$col + 2] <- input$table_permisos_cell_edit$value
      vars$permisos <- permisos
      save_mysql(permisos, paste0(co, "_permisos"), TRUE)
    }else{
      shinyalert(
        type = "error",
        title = "Debes introducir si o no"
      )
    }
    
  })
  
  observeEvent(input$ver_organigrama, {
    showModal(modalDialog(
      fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 3px; margin: 0px;
                                                    margin-top: 10px",
                leafletOutput("map_organigrama")
      ),
      uiOutput("table_organigrama_ui"),
      br(),
      tags$div(id="bttn_modal", 
               actionButton(inputId = "modal", label = "OK",
                            onclick = 'Shiny.setInputValue(\"perfil_open\", this.id, {priority: \"event\"})'),
               align = "center"),
      title = "Mapa de Oficinas",
      easyClose = FALSE,
      footer = NULL,
      size = "l",
      fade = TRUE
    ))
  })
  
  output$table_organigrama_ui <- renderUI({
    req(vars$show_organigrama)
    if(nrow(vars$show_organigrama) > 0){
      fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 0px; margin: 0px;
                                                    margin-top: 10px",
                dataTableOutput("table_organigrama")
      )
    }else{
      div()
    }
  })
  
  observeEvent(input$map_organigrama_marker_click, {
    click <- input$map_organigrama_marker_click
    print(click$id)
    agentes_all <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "agencia", click$id)
    vars$show_organigrama <- agentes_all %>% mutate(img = paste0('<img src="', img, '" height="52"></img>')) %>% 
      select(img, name, cargo)
    print(vars$show_organigrama)
  })
  
  output$table_organigrama <- renderDataTable({
    
    datatable(vars$show_organigrama,
              options = list(initComplete = JS(paste0("
                                                      function(settings, json) {
                                                      $(this.api().table().header()).css({
                                                      'background-color': '", main_color, "',
                                                      'color': '#fff'});}")),
                             pageLength = 10, dom = 'ftp'), rownames = FALSE, selection = "single", escape = FALSE)
  })
  
  observeEvent(input$olvidar_dispositivo, {
    #    fp <- list_table_var1_var2_mysql(paste0(co, "_fingerprint"), "ip", ip(), "fingerprint", fp())
    #    fp <- fp[fp$user == vars$user$user]
    del_var1_var2_table_mysql("ip", ip(), "fingerprint", fp(),  paste0(co, "_fingerprint"))
    js$resetCRM()
  })
  
  output$map_organigrama <- renderLeaflet({
    agencias_all <- load_mysql(paste0(co, "_agencias_data")) %>% select(id, lat, lon, name) %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
    franquicias_all <- load_mysql(paste0(co, "_franquicias_data")) %>% select(id, lat, lon, name) %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
    oficinas <- rbind(agencias_all, franquicias_all)
    
    leaflet(options = leafletOptions(dragging=TRUE)) %>% addSearchOSM() %>%
      setView(st_coordinates(vars$view)[1], st_coordinates(vars$view)[2], zoom = 12) %>%
      addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
      addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
      #      addTiles("https://mt1.google.com/vt?lyrs=h@159000000,traffic|seconds_into_week:-1&style=3&x={x}&y={y}&z={z}", group = "tráfico") %>% 
      addLayersControl(baseGroups = c("mapa", "satélite"), #overlayGroups = c("propios", "otros", "cierres"),
                       options = layersControlOptions(collapsed=FALSE), position = "bottomleft") %>%
      addMarkers(data = oficinas, icon = skyone_marker, layerId = ~id, label = ~name, labelOptions = labelOptions(permanent=FALSE))
  })
  
  observeEvent(input$crear_agencia, {
    vars$new_agente <- FALSE
    vars$new_agencia <- TRUE
    vars$new_franquicia <- FALSE
    vars$foto_perfil <- NA
    master <- load_mysql(paste0(co, "_franquicias_data"))
    master <- master$name
    if(vars$image_perfil_new == FALSE) vars$foto_perfil <- NA
    showModal(modalDialog(
      fluidRow(style = "padding:0px",
               column(6,
                      uiOutput("image_perfil"),
                      div(id = "inline",
                          fileInput(inputId = "upload_perfil",
                                    label = NULL,
                                    buttonLabel = "Subir foto",
                                    placeholder = "no hay fotos",
                                    accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")
                                    ),
                          align = "center")
               ),
               column(6,
                      leafletOutput("map_new_agencia", height = 300)
               )
      ),
      fluidRow(style = "padding:0px",
               column(6,
                      tags$div(id = "inline",
                               textInput("reg_agencia_name", "Nombre de la agencia"),
                               textInput("reg_agencia_mail", "Correo electrónico"),
                               textInput("reg_agencia_phone", "Teléfono"),
                               textInput("reg_agencia_addr", "Dirección"),
                      )
               ),
               column(6,
                      tags$div(id = "inline",
                               textInput("reg_agencia_razon", "Razón social"),
                               textInput("reg_agencia_ruc", "RUC"),
                               dateInput("reg_agencia_birthday", "Fecha de aniversario", language = "es", value = ""),
                               selectInput("reg_agencia_master", "Master Office que pertenece", choices = master)
                      )
               )
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionButton("crear_agencia_ok", "Crear"),
               actionButton(inputId = "modal", label = "Cancelar",
                            onclick = 'Shiny.setInputValue(\"perfil_open\", this.id, {priority: \"event\"})'),
               align = "center"),
      title = "Crear Agencia",
      easyClose = FALSE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  observeEvent(input$crear_agencia_ok, {
    print("agencia")
    print(vars$new_agencia)
    print(vars$place_agencia)
    if("" %in% c(input$reg_agencia_name, input$reg_agencia_phone, input$reg_agencia_mail, input$reg_agencia_addr)){
      shinyalert(
        type = "error",
        title = "Campos sin completar"
      )
    }else{
      if(is.na(vars$foto_perfil)){
        shinyalert(
          type = "error",
          title = "Debe agregar una foto de perfil al asesor"
        )
      }else{
        if(is.na(vars$place_agencia)){
          shinyalert(
            type = "error",
            title = "Debes agregar la ubicación de la agencia"
          )
        }else{
          if(vars$new_agencia){
            master <- load_mysql(paste0(co, "_franquicias_data"))
            id <- new_id_table_mysql("id", paste0(co, "_agencias_data"), "agencia_", 10)
            master <- master[master$name == input$reg_agencia_master,]
            master_id <- master$id
            pais <- master$pais
          }else{
            id <- new_id_table_mysql("id", paste0(co, "_franquicias_data"), "franquicia_", 10)
            pais <- strtrim(isolate(input$reg_agencia_pais), 30)
          }
          rand <- str_pad(round(runif(1, min=1, max=999)), 3, pad = "0")
          img <- paste0("https://place-storage.nyc3.digitaloceanspaces.com/", co, 
                        ifelse(vars$new_agencia, "/fotos-agencia/", "/fotos-franquicia/"), id, "_", rand, ".jpg")
          put_object_do(paste0("/", co, ifelse(vars$new_agencia, "/fotos-agencia/", "/fotos-franquicia/"), id, "_", rand, ".jpg"), "temp_foto_perfil.jpg")
          new_agencia <- data.frame(
            id = id,
            name = strtrim(isolate(input$reg_agencia_name), 30), 
            company = co,
            fecha = as.character(now("America/Asuncion")),
            phone = strtrim(as.character(isolate(input$reg_agencia_phone)), 30),
            mail = strtrim(isolate(input$reg_agencia_mail), 30),
            addr = strtrim(isolate(input$reg_agencia_addr), 30),
            ruc = strtrim(isolate(input$reg_agencia_ruc), 30),
            razon = strtrim(isolate(input$reg_agencia_razon), 30),
            img = img,
            birthday = ifelse(length(input$reg_agencia_birthday) == 0, "", as.character(input$reg_agencia_birthday)),
            pais = pais,
            lat = vars$place_agencia$lat,
            lon = vars$place_agencia$lon
          )
          if(vars$new_agencia)
            new_agencia$master <- master_id
          print(new_agencia)
          save_mysql(new_agencia, paste0(co, ifelse(vars$new_agencia, "_agencias_data", "_franquicias_data")), FALSE)
          vars$foto_perfil <- NA
          vars$new_agente <- FALSE
          vars$new_agencia <- FALSE
          vars$new_franquicia <- FALSE
          vars$image_perfil_new <- FALSE
          
          create_folder_do(paste0("/", co, "/minube/", str_replace_all(new_agencia$name, " ", "_"), "/"))
          removeModal()
        }
      }
    }
  })
  
  observeEvent(vars$new_agencia,{
    output$map_new_agencia <- renderLeaflet({
      leaflet() %>% addSearchOSM() %>% 
        setView(st_coordinates(vars$view)[1], st_coordinates(vars$view)[2], zoom = 12) %>%
        addMarkers(data = vars$view, icon = skyone_marker) %>%
        addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
        addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
        addLayersControl(baseGroups = c("mapa", "satélite"),
                         options = layersControlOptions(collapsed=FALSE), position = "bottomleft")
    })
  })
  
  observeEvent(input$map_new_agencia_click,{
    place <- data.frame(lat = input$map_new_agencia_click$lat, lon = input$map_new_agencia_click$lng)
    point <- place %>% st_as_sf(coords = c("lon", "lat"), crs = crs)
    vars$view <- point
    vars$place_agencia <- place
  })
  
  observeEvent(input$crear_franquicia, {
    vars$new_agente <- FALSE
    vars$new_agencia <- FALSE
    vars$new_franquicia <- TRUE
    vars$foto_perfil <- NA
    if(vars$image_perfil_new == FALSE) vars$foto_perfil <- NA
    showModal(modalDialog(
      fluidRow(style = "padding:0px",
               column(6,
                      uiOutput("image_perfil"),
                      div(id = "inline",
                          fileInput(inputId = "upload_perfil",
                                    label = NULL,
                                    buttonLabel = "Subir foto",
                                    placeholder = "no hay fotos",
                                    accept = c("image/jpeg", "image/x-png", "image/tiff", ".jpg", ".png")),
                          align = "center")
               ),
               column(6,
                      leafletOutput("map_new_agencia", height = 300)
               )
      ),
      fluidRow(style = "padding:0px",
               column(6,
                      tags$div(id = "inline",
                               textInput("reg_agencia_name", "Nombre de la Master Office"),
                               textInput("reg_agencia_mail", "Correo electrónico"),
                               textInput("reg_agencia_phone", "Teléfono"),
                               textInput("reg_agencia_addr", "Dirección"),
                      )
               ),
               column(6,
                      tags$div(id = "inline",
                               textInput("reg_agencia_razon", "Razón social"),
                               textInput("reg_agencia_ruc", "RUC"),
                               dateInput("reg_agencia_birthday", "Fecha de aniversario", language = "es", value = ""),
                               textInput("reg_agencia_pais", "País de la Master Office")
                      )
               )
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionButton("crear_agencia_ok", "Crear"),
               actionButton(inputId = "modal", label = "Cancelar",
                            onclick = 'Shiny.setInputValue(\"perfil_open\", this.id, {priority: \"event\"})'),
               align = "center"),
      title = "Crear Master Office",
      easyClose = FALSE,
      footer = NULL,
      size = "m",
      fade = TRUE
    ))
  })
  
  observeEvent(input$pass_change, {
    showModal(modalDialog(
      passwordInput("old_pass", "Contraseña actual"),
      passwordInput("new_pass1", "Nueva (8 caracteres"),
      passwordInput("new_pass2", "Repita nueva contraseña"),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("pass_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"), 
               align = "center"),
      br(), br(),
      actionBttn("pass_forget", "¿Olvidaste la contraseña?", size = "xs", style = "minimal", color = "primary"),
      title = "Cambio de contraseña",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$name_change, {
    showModal(modalDialog(
      textInput("new_name", "Nueno nombre"),
      tags$div(id="bttn_modal", 
               actionBttn("name_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de nombre",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$phone_change, {
    showModal(modalDialog(
      textInput("new_phone", "Nueno teléfono"),
      tags$div(id="bttn_modal", 
               actionBttn("phone_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de teléfono",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$birthday_change, {
    showModal(modalDialog(
      dateInput("new_birthday", "Fecha de nacimiento", language = "es", value = ""),
      tags$div(id="bttn_modal", 
               actionBttn("birthday_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de fecha de nacimiento",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$agencia_change, {
    all_agencias <- vars$agencias$name
    all_franquicias <- vars$franquicias$name 
    showModal(modalDialog(
      selectInput("new_agencia", "Oficina a la que pertenece", choices = c(all_agencias, all_franquicias, "Global Master Office")),
      tags$div(id="bttn_modal", 
               actionBttn("agencia_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de agencia",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$cargo_change, {
    showModal(modalDialog(
      selectInput("new_cargo", "Cargo", 
                  choices = c("Global Master Office", "Global Office Manager", "Global Office Assistant", "Country Master Office",
                              "Country Office Manager", "Country Office Assistant", "Broker Office", "Broker Manager",
                              "Broker Assistant", "Asesor")),
      tags$div(id="bttn_modal", 
               actionBttn("cargo_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de cargo",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$comision_change, {
    showModal(modalDialog(
      selectInput("new_comision", "Tipo de comisión", 
                  choices = c("Asesor Junior - 60%",
                              "Asesor Senior - 70%",
                              "Asesor Elite - 80%")),
      tags$div(id="bttn_modal", 
               actionBttn("comision_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de comisión",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$razon_change, {
    showModal(modalDialog(
      textInput("new_razon", "Razón Social"),
      tags$div(id="bttn_modal", 
               actionBttn("razon_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de razón social",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$ruc_change, {
    showModal(modalDialog(
      textInput("new_ruc", "RUC"),
      tags$div(id="bttn_modal", 
               actionBttn("ruc_change_ok", "Cambiar"),
               actionBttn("close_modal", "Cancelar"),
               align = "center"),
      title = "Cambio de RUC",
      easyClose = TRUE,
      footer = NULL,
      size = "s",
      fade = TRUE
    ))
  })
  
  observeEvent(input$name_change_ok, {
    if(input$new_name == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      vars$user$name <- strtrim(isolate(input$new_name), 30)
      new_info <- vars$user$name
      var <- "name"
      user <- vars$user$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      removeModal()
    }
  })
  
  observeEvent(input$phone_change_ok, {
    if(input$new_phone == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      vars$user$phone <- str_squish(isolate(input$new_phone))
      new_info <- vars$user$phone
      var <- "phone"
      user <- vars$user$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      removeModal()
    }
  })
  
  observeEvent(input$birthday_change_ok, {
    if(length(input$new_birthday) == 0){
      shinyalert(
        type = "error",
        title = "Ingrese su fecha de nacimiento"
      )
    }else{
      vars$user$birthday <- as.character(input$new_birthday)
      new_info <- vars$user$birthday
      var <- "birthday"
      user <- vars$user$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      removeModal()
    }
  })
  
  observeEvent(input$agencia_change_ok, {
    if(input$new_agencia == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      if(input$new_agencia == "Global Master Office"){
        id_agencia <- "Global Master Office"
      }else{
        if(input$new_agencia %in% vars$agencias$name){
          id_agencia <- vars$agencias$id[vars$agencias$name == input$new_agencia]
        }else{
          if(input$new_agencia %in% vars$franquicias$name){
            id_agencia <- vars$franquicias$id[vars$franquicias$name == input$new_agencia]
          }
        }
      }
      vars$user$agencia <- id_agencia
      new_info <- vars$user$agencia
      var <- "agencia"
      user <- vars$user$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      removeModal()
    }
  })
  
  observeEvent(input$cargo_change_ok, {
    if(input$new_cargo == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      vars$user$cargo <- input$new_cargo
      new_info <- vars$user$cargo
      var <- "cargo"
      user <- vars$user$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      removeModal()
    }
  })
  
  observeEvent(input$comision_change_ok, {
    if(input$new_comision == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      vars$user$comision <- input$new_comision
      new_info <- vars$user$comision
      var <- "comision"
      user <- vars$user$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      removeModal()
    }
  })
  
  observeEvent(input$razon_change_ok, {
    if(input$new_razon == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      vars$user$razon <- str_squish(isolate(input$new_razon))
      new_info <- vars$user$razon
      var <- "razon"
      user <- vars$user$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      removeModal()
    }
  })
  
  observeEvent(input$ruc_change_ok, {
    if(input$new_ruc == ""){
      shinyalert(
        type = "error",
        title = "Campo sin completar"
      )
    }else{
      vars$user$ruc <- str_squish(isolate(input$new_ruc))
      new_info <- vars$user$ruc
      var <- "ruc"
      user <- vars$user$user
      update_var_table_mysql(new_info, var, "user", user, "myplace_usuarios")
      update_var_table_mysql(as.character(now("America/Asuncion")), "date", "user", user, "myplace_usuarios")
      removeModal()
    }
  })
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #prop_todas
  
  output$prop_todas_ui <- renderUI({
    if(prop_todas_on() == 1){
      div(
        uiOutput("prop_todas_filtros_ui"),
        fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 2px"),
                  leafletOutput("map_prop_todas", height = "45vh")
                  ),
                  
                  div(uiOutput("box_inmo_list_ui"), align = "center"),
                  uiOutput("page_ui"),
                  uiOutput("cont_page_ui")
      )
    }
  })  
  
  output$prop_todas_filtros_ui <- renderUI({
    if(prop_todas_on() == 1){
      fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; margin: 0px; margin-bottom: 10px"),
                div(id = "inline",
                    div(style = "width: 110px; margin: 5px", class = "btn-group",
                        selectInput("prop_todas_filt_trans", "Transacción", 
                                    choices = c("Todos", "Venta", "Alquiler", "Alquiler temporal"))),
                    div(style = "width: 110px; margin: 5px", class = "btn-group",
                        selectInput("prop_todas_filt_tipo", "Tipo propiedad",
                                    choices = c("Todos", "Terreno", "Casa", "Duplex", "Departamento", "Proyecto", "Deposito", "Tinglado", "Oficina", "Salón comercial",
                                                "Propiedad rural", "Casa quinta", "Edificio", "Rural Externa"))),
                    div(style = "width: 110px; margin: 5px", class = "btn-group",
                        selectInput("prop_todas_filt_dormitorios", "Dormitorios",
                                    choices = c("Todos", "Mono" = "0", "1", "2", "3", "4", "5+"))),
                    div(style = "width: 110px; margin: 5px; margin-top: 10px", class = "btn-group",
                        selectInput("prop_todas_filt_cierres", "", choices = c("Publicadas", "Cerradas"))),
                    div(class = "btn-group", style = "margin: 5px; width: 150px;", 
                        selectInput("prop_todas_filt_ofi", "Oficina", choices = c("Todas", "Global Master Office", vars$franquicias$name, vars$agencias$name))
                    ),
                    div(class = "btn-group", uiOutput("prop_todas_filt_agente_ui"))
                ),
                fluidRow(
                  column(11, 
                         div(id = "inline",
                             style = "background-color: #fafaf8; border-radius: 10px; border-width: 1px;
                                         border-color: #aaaaaa; border-style: solid; z-index: 1000;
                                             margin: 10px; padding: 10px",
                             div(style = "width: 100px;", class = "btn-group",
                                 selectInput("prop_todas_filt_moneda", "Moneda",
                                             choices = c("Dólares", "Guaranies"))),
                             div(style = "width: 125px; margin: 5px", class = "btn-group",
                                 autonumericInput(inputId = "prop_todas_filt_precio_min", align = "left",
                                                  label = "Precio mínimo",
                                                  value = NULL, currencySymbol = NULL, currencySymbolPlacement = "p",
                                                  decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",",
                                                  minimumValue = 0)),
                             div(style = "width: 125px; margin: 5px", class = "btn-group",
                                 autonumericInput(inputId = "prop_todas_filt_precio_max", align = "left",
                                                  label = "Precio máximo",
                                                  value = NULL, currencySymbol = NULL, currencySymbolPlacement = "p",
                                                  decimalPlaces = 0, digitGroupSeparator = ".", decimalCharacter = ",",
                                                  minimumValue = 0)),
                             div(style = "width: 80px; margin: 5px; margin-top: -5px", class = "btn-group",
                                 numericInput3("prop_todas_filt_codigo", "Código", value = NULL)),
                             div(style = "width: 120px; margin: 5px; margin-left: 20px; margin-top: 10px", class = "btn-group",
                                 textInput("prop_todas_filt_palabra", "Buscar")),
                             div(style = "width: 40px; margin: 5px; margin-left: 10px", class = "btn-group",
                                 div(id="bttn_modal", style = "margin-top: 17px",
                                     actionButton("prop_todas_palabra_ok", NULL, icon = icon("search"))))
                         )
                  ),
                  column(1, uiOutput("contador_prop_todas_ui"), align = "right")
                )
      )
    }
  })
  
  output$prop_todas_filt_agente_ui <- renderUI({
    div(style = "width: 150px; margin: 5px;", 
        selectInput("prop_todas_filt_agente", "Asesor",
                    choices = c("Todos", vars$users_office$name)))
  })
  
  output$contador_prop_todas_ui <- renderUI({
    h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                   nrow(vars$prop_todas_list), "</span></p>")))
  })
  
  observe({
    if(prop_todas_on() == 1){
      req(vars$prop_todas_list_all, input$prop_todas_filt_ofi, input$prop_todas_filt_agente)
      input$prop_todas_palabra_ok
      if(!is.null(isolate(input$prop_todas_filt_codigo))){
        if(input$prop_todas_filt_agente != "Todos"){
          agente <- vars$users_office$user[vars$users_office$name == input$prop_todas_filt_agente]
          all_pages <- vars$prop_todas_list_all[vars$prop_todas_list_all$user == agente,]
          print(nrow(all_pages))
        }else{
          all_pages <- vars$prop_todas_list_all
        }
        if(input$prop_todas_filt_trans != "Todos"){
          all_pages <- all_pages[all_pages$venta_alquiler == input$prop_todas_filt_trans,]
        }
        if(input$prop_todas_filt_tipo != "Todos"){
          if(input$prop_todas_filt_tipo == "Rural Externa"){
            all_pages <- query_mysql("SELECT id, user, tipoPropiedad, venta_alquiler, externa, 
                                                       borrador, fecha, precio_cierre, titulo, lat, lon 
                                                       FROM myplace_inmuebles 
                                                       WHERE company = 'skyone' AND
                                                       externa = 'si' AND activo = 'si' AND 
                                                       tipoPropiedad = 'Propiedad rural';")
          }else{
            all_pages <- all_pages[all_pages$tipoPropiedad == input$prop_todas_filt_tipo,]
          }
        }
        
        if(input$prop_todas_filt_dormitorios != "Todos"){
          if(input$prop_todas_filt_tipo == "Proyecto"){
            tipos <- list_table_var_mysql("myplace_tipologias", "dormitorios", input$prop_todas_filt_dormitorios)
            ids_proyectos <- unique(tipos$id)
            all_pages <- all_pages[all_pages$id %in% ids_proyectos,]
          }else{
            if(input$prop_todas_filt_tipo == "Todos"){
              tipos <- list_table_var_mysql("myplace_tipologias", "dormitorios", input$prop_todas_filt_dormitorios)
              ids_proyectos <- unique(tipos$id)
              proyectos <- all_pages[all_pages$id %in% ids_proyectos,]
              all_pages <- all_pages[all_pages$tipoPropiedad != "Proyecto" & !is.na(all_pages$dormitorios) & all_pages$dormitorios == input$prop_todas_filt_dormitorios,]
              all_pages <- rbind(all_pages, proyectos)
              print(paste0(nrow(all_pages), " inmuebles encontrados"))
            }else{
              all_pages <- all_pages[all_pages$dormitorios == input$prop_todas_filt_dormitorios,]
            }
          }
        }
        
        if(input$prop_todas_filt_ofi == "Todas"){
          vars$users_office <- vars$users_office_all
        }else{
          if(input$prop_todas_filt_ofi == "Global Master Office"){
            id_agencia <- "Global Master Office"
          }else{
            if(input$prop_todas_filt_ofi %in% vars$agencias$name){
              id_agencia <- vars$agencias$id[vars$agencias$name == input$prop_todas_filt_ofi]
            }else{
              if(input$prop_todas_filt_ofi %in% vars$franquicias$name){
                id_agencia <- vars$franquicias$id[vars$franquicias$name == input$prop_todas_filt_ofi]
              }
            }
          }
          vars$users_office <- vars$users_office_all[vars$users_office_all$agencia == id_agencia,]
          print("inicial")
          print(nrow(all_pages))
          print(vars$users_office$user)
          all_pages <- all_pages %>% filter(user %in% vars$users_office$user)
          print(nrow(all_pages))
        }
        
        if(input$prop_todas_filt_cierres == "Publicadas"){
          if(input$prop_todas_filt_tipo != "Rural Externa"){
            print("Publicadas o cerradas")
            print(nrow(all_pages))
            all_pages <- all_pages[all_pages$borrador == "no" & all_pages$precio_cierre == 0,]
            print(nrow(all_pages))
          }
        }else{
          all_pages <- all_pages[all_pages$precio_cierre != 0,]
        }
        
        isolate({
          cambio_dolar <- dollarExchange()
          
          if(!is.null(input$prop_todas_filt_precio_min) && input$prop_todas_filt_precio_min > 0){
            
            if(input$prop_todas_filt_moneda == "Dólares"){
              tipos_dol <- list_table_var1_var2_cond_mysql("myplace_tipologias", "moneda_contrato", "USD", "precio", ">=", input$prop_todas_filt_precio_min)
              tipos_gua <- list_table_var1_var2_cond_mysql("myplace_tipologias", "moneda_contrato", "GS", "precio", ">=", input$prop_todas_filt_precio_min/cambio_dolar$venta)
            }else{
              tipos_dol <- list_table_var1_var2_cond_mysql("myplace_tipologias", "moneda_contrato", "USD", "precio", ">=", input$prop_todas_filt_precio_min*cambio_dolar$compra)
              tipos_gua <- list_table_var1_var2_cond_mysql("myplace_tipologias", "moneda_contrato", "GS", "precio", ">=", input$prop_todas_filt_precio_min)
            }
            tipos <- rbind(tipos_dol, tipos_gua)
            ids_proyectos <- unique(tipos$id)
            proyectos <- all_pages[all_pages$id %in% ids_proyectos,]
            
            all_pages <- all_pages[all_pages$tipoPropiedad != "Proyecto",]
            if(input$prop_todas_filt_moneda == "Dólares"){
              all_pages <- all_pages %>% mutate(precio_dolar = ifelse(moneda_contrato == "GS", precio/cambio_dolar$venta, precio))
              all_pages <- all_pages[all_pages$precio_dolar >= input$prop_todas_filt_precio_min,]
            }else{
              all_pages <- all_pages %>% mutate(precio_dolar = ifelse(moneda_contrato == "USD", precio*cambio_dolar$compra, precio))
              all_pages <- all_pages[all_pages$precio_dolar >= input$prop_todas_filt_precio_min,]
            }
            
            if(nrow(all_pages) != 0){
              all_pages$precio_dolar <- NULL
            }
            all_pages <- rbind(all_pages, proyectos)
          }
          
          if(!is.null(input$prop_todas_filt_precio_max) && input$prop_todas_filt_precio_max > 0){
            if(is.null(input$prop_todas_filt_precio_min) || input$prop_todas_filt_precio_max > input$prop_todas_filt_precio_min){
              if(input$prop_todas_filt_moneda == "Dólares"){
                tipos_dol <- list_table_var1_var2_cond_mysql("myplace_tipologias", "moneda_contrato", "USD", "precio", "<=", input$prop_todas_filt_precio_max)
                tipos_gua <- list_table_var1_var2_cond_mysql("myplace_tipologias", "moneda_contrato", "GS", "precio", "<=", input$prop_todas_filt_precio_max/cambio_dolar$venta)
              }else{
                tipos_dol <- list_table_var1_var2_cond_mysql("myplace_tipologias", "moneda_contrato", "USD", "precio", "<=", input$prop_todas_filt_precio_max*cambio_dolar$compra)
                tipos_gua <- list_table_var1_var2_cond_mysql("myplace_tipologias", "moneda_contrato", "GS", "precio", "<=", input$prop_todas_filt_precio_max)
              }
              tipos <- rbind(tipos_dol, tipos_gua)
              ids_proyectos <- unique(tipos$id)
              proyectos <- all_pages[all_pages$id %in% ids_proyectos,]
              
              all_pages <- all_pages[all_pages$tipoPropiedad != "Proyecto",]
              if(input$prop_todas_filt_moneda == "Dólares"){
                all_pages <- all_pages %>% mutate(precio_dolar = ifelse(moneda_contrato == "GS", precio/cambio_dolar$venta, precio))
                all_pages <- all_pages[all_pages$precio_dolar <= input$prop_todas_filt_precio_max,]
              }else{
                all_pages <- all_pages %>% mutate(precio_dolar = ifelse(moneda_contrato == "USD", precio*cambio_dolar$compra, precio))
                all_pages <- all_pages[all_pages$precio_dolar <= input$prop_todas_filt_precio_max,]
              }
              
              if(nrow(all_pages) != 0){
                all_pages$precio_dolar <- NULL
              }
              all_pages <- rbind(all_pages, proyectos)
            }
          }
        })
        
        if(!is.na(isolate(input$prop_todas_filt_codigo))){
          id_search <- paste0(co, "_inmueble_", str_pad(isolate(input$prop_todas_filt_codigo), 10, pad = "0"))
          all_pages <- vars$prop_todas_list_all %>% filter(id == id_search)
        }
        
        if(isolate(input$prop_todas_filt_palabra) != ""){
          all_pages <- vars$prop_todas_list_all %>% filter(str_detect(str_to_lower(titulo), str_to_lower(isolate(input$prop_todas_filt_palabra))) |
                                                             str_detect(str_to_lower(descripcion), str_to_lower(isolate(input$prop_todas_filt_palabra))))
        }
        
        print("Propiedades encontradas")
        print(nrow(all_pages))

        
        
        if(nrow(all_pages) != 0){
          vars$page_selected <- 1
          vars$data_all_pages <- all_pages %>% arrange(desc(fecha))
          vars$prop_todas_list <- all_pages
          vars$data_per_page <- generate_pages(vars$data_all_pages, vars$n_per_page, vars$max_pages, 1)$data
        }else{
          vars$page_selected <- 1
          vars$prop_todas_list <- data.frame()
          vars$data_all_pages <- data.frame()
          vars$data_per_page <- data.frame()
        }
        
        
        
      }
    }
  })
  
  output$map_prop_todas <- renderLeaflet({
    if(prop_todas_on() == 1){
      
      map_prop_todas_leaflet <- leaflet(options = leafletOptions(dragging=TRUE)) %>% addSearchOSM() %>%
        setView(st_coordinates(vars$view)[1], st_coordinates(vars$view)[2], zoom = 12) %>%
        addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
        addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
        #      addTiles("https://mt1.google.com/vt?lyrs=h@159000000,traffic|seconds_into_week:-1&style=3&x={x}&y={y}&z={z}", group = "tráfico") %>% 
        addLayersControl(baseGroups = c("mapa", "satélite"), #overlayGroups = c("propios", "otros", "cierres"),
                         options = layersControlOptions(collapsed=FALSE), position = "bottomleft") %>%
        setMapWidgetStyle(list(background = "transparent"))
      if(!is.null(vars$prop_todas_list) && nrow(vars$prop_todas_list) != 0){
        map_prop_todas_leaflet <- map_prop_todas_leaflet %>% addMarkers(data = vars$prop_todas_list, icon = ~icon_inmo(tipoPropiedad), layerId = ~id, group = "propios",
                                                                        clusterOptions = markerClusterOptions(iconCreateFunction=JS("function (cluster) {    
    var childCount = cluster.getChildCount(); 
    var c = ' marker-custom-';  
    if (childCount < 10) {  
      c += 'large';  
    } else if (childCount < 50) {  
      c += 'medium';  
    } else { 
      c += 'small';  
    }    
    return new L.DivIcon({ html: '<div><span>' + childCount + '</span></div>', className: 'marker-cluster' + c, iconSize: new L.Point(40, 40) });

  }")))
      }
      map_prop_todas_leaflet
    }
  })
  
  observeEvent(input$map_prop_todas_marker_click, {
    click <- input$map_prop_todas_marker_click
    vars$click <- list_table_var_mysql("myplace_inmuebles", "id", click$id)
    vars$show_inmo <- vars$click
    clien <- list_table_var1_var2_mysql(paste0(co, "_estados"), "user", vars$user$user, "id_inmo", vars$show_inmo$id) %>%
      select(id = id_clien, tipo_clien = tipo_cliente)
    clien$tipo_clien <- ifelse(clien$tipo_clien == "colocacion", "interesado", "vendedor")
    if(vars$show_inmo$user != vars$user$user){
      clien_tercero <- data.frame(id = vars$show_inmo$user, tipo_clien = "captador")
      clien <- rbind(clien_tercero, clien)
    }
    if(nrow(clien) != 0){
      vars$list_clientes_vinc <- clien
    }else{
      vars$list_clientes_vinc <- data.frame()
    }
    modal_inmo_description()
  })
  
  
  ################################################################################################################################## 
  ##################################################################################################################################
  #bus_todas
  
  output$bus_todas_ui <- renderUI({
    if(bus_todas_on() == 1){
      div(
        uiOutput("bus_todas_filtros_ui"),
        fluidPage(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; padding: 2px"),
                  leafletOutput("map_bus_todas", height = "75vh")
        )
      )
    }
  })  
  
  output$bus_todas_filtros_ui <- renderUI({
    if(bus_todas_on() == 1){
      fluidPage(
        fluidRow(style = paste0("border-style: solid; border-width: 2px; border-color: ", main_color, "; 
                       border-radius: 10px; background-color: white; margin-bottom: 10px; padding-bottom: 0px"),
                 #h4(HTML(paste0("<p><span style='color: ", main_color, "'>Filtros</span></p>")), width = "100%"),
                 column(10, tags$div(id = "inline", class = "btn-group",
                                     div(style = "width: 110px; margin: 5px", class = "btn-group",
                                         selectInput("busqueda_filt_trans", "Transacción", 
                                                     choices = c("Todos", "Venta", "Alquiler", "Alquiler temporal"))),
                                     div(style = "width: 110px; margin: 5px", class = "btn-group",
                                         selectInput("busqueda_filt_tipo", "Tipo propiedad",
                                                     choices = c("Todos", "Terreno", "Casa", "Duplex", "Departamento", "Proyecto", "Deposito", "Tinglado", "Oficina", "Salón comercial",
                                                                 "Propiedad rural", "Casa quinta", "Edificio")))
                 )
                 ),
                 column(2, uiOutput("contador_bus_todas_ui"), align = "right")
                 
        )
      )
    }
  })
  
  output$contador_bus_todas_ui <- renderUI({
    h4(HTML(paste0("<p><span style='color: ", main_color, "; font-weight: bold; margin-right: 10px'>", 
                   nrow(vars$bus_todas_list), "</span></p>")))
  })
  
  observe({
    req(input$busqueda_filt_tipo)
    if(bus_todas_on() == 1){
      all_pages <- vars$bus_todas_all
      
      if(input$busqueda_filt_trans != "Todos"){
        all_pages <- all_pages[all_pages$venta_alquiler == input$busqueda_filt_trans,]
      }
      if(input$busqueda_filt_tipo != "Todos"){
        all_pages <- all_pages[all_pages$tipoPropiedad == input$busqueda_filt_tipo,]
      }
      
      if(nrow(all_pages) != 0){
        vars$bus_todas_list <- all_pages
      }else{
        vars$bus_todas_list <- data.frame()
      }
    }
  })
  
  output$map_bus_todas <- renderLeaflet({
    if(bus_todas_on() == 1){
      
      map_bus_todas_leaflet <- leaflet(options = leafletOptions(dragging=TRUE)) %>% addSearchOSM() %>%
        setView(st_coordinates(vars$view)[1], st_coordinates(vars$view)[2], zoom = 12) %>%
        addCircleMarkers(data = vars$view, radius = 5, color = "blue", fillColor = "blue", 
                         fillOpacity = 0.4, opacity = 0.4, group = "pin", layerId = "pin") %>%
        addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}", group = "mapa") %>%
        addTiles("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}", group = "satélite") %>%
        #      addTiles("https://mt1.google.com/vt?lyrs=h@159000000,traffic|seconds_into_week:-1&style=3&x={x}&y={y}&z={z}", group = "tráfico") %>% 
        addLayersControl(baseGroups = c("mapa", "satélite"), #overlayGroups = c("propios", "otros", "cierres"),
                         options = layersControlOptions(collapsed=FALSE), position = "bottomleft") %>%
        setMapWidgetStyle(list(background = "transparent"))
      if(nrow(vars$bus_todas_list) != 0){
        map_bus_todas_leaflet <- map_bus_todas_leaflet %>% addMarkers(data = vars$bus_todas_list, icon = ~icon_inmo(tipoPropiedad), layerId = ~id, group = "propios",
                                                                      clusterOptions = markerClusterOptions(iconCreateFunction=JS("function (cluster) {    
    var childCount = cluster.getChildCount(); 
    var c = ' marker-custom-';  
    if (childCount < 10) {  
      c += 'large';  
    } else if (childCount < 50) {  
      c += 'medium';  
    } else { 
      c += 'small';  
    }    
    return new L.DivIcon({ html: '<div><span>' + childCount + '</span></div>', className: 'marker-cluster' + c, iconSize: new L.Point(40, 40) });

  }")))
      }
      map_bus_todas_leaflet
    }
  })
  
  observeEvent(input$map_bus_todas_marker_click, {
    click <- input$map_bus_todas_marker_click
    vars$show_busqueda <- vars$all_busquedas[vars$all_busquedas$id == click$id,][1,]
    busqueda <- vars$show_busqueda
    agente <- list_table_var1_var2_mysql("myplace_usuarios", "company", co, "user", busqueda$user)
    path <- paste0("www/temp/", vars$user$user, "temp_map1.html")
    saveWidget(
      widget = leaflet() %>% addTiles("https://mt1.google.com/vt/lyrs=r&x={x}&y={y}&z={z}")%>%
        addPolygons(data = busqueda), 
      file = path,
      selfcontained = FALSE,
      libdir = "files/"
    )
    agencia_nam <- agencia_name(agente$agencia, vars$agencias, vars$franquicias)
    showModal(tags$div(id="modal_inmo_double", modalDialog(
      div(align = "center",
          div(class = "btn-group",
              tags$iframe(seamless="seamless", 
                          src = paste0("temp/", vars$user$user, "temp_map1.html"), 
                          style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; margin: 0px; margin-bottom: 10px;
                            width: 342px; height: 335px; padding: 3px; margin-top: 10px")
          ),
          div(style = "width: 342px", class = "btn-group",
              div(
                fluidPage(style = paste0("border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 10px; min-height: 200px; margin: 0px;
                                                    margin-bottom: 10px"), align = "left",
                          
                          HTML(paste0("<p><span style='font-size: 180%; font-weight: bold; color: #888888'>", 
                                      "Busco ", ifelse(busqueda$venta_alquiler == "Venta", "comprar", "alquilar"),
                                      ifelse(busqueda$tipoPropiedad %in% c("Casa", "Casa quinta", "Oficina", "Propiedad rural"), " una ", " un "),
                                      busqueda$tipoPropiedad, "</span></p>")),   
                          HTML(popup_busqueda(busqueda, FALSE))
                ),
                fluidPage(style = "border-style: solid; border-width: 1px; border-color: #aaaaaa; 
                       border-radius: 10px; background-color: white; padding: 5px; min-height: 125px;
                                       margin: 0px; padding-left: 10px",
                          div(align = "left",
                              div(class = "btn-group", style = "width: 200px",
                                  HTML(paste0("<p><span style='font-size: 100%; font-weight: normal; color: #888888'>Asesor inmobiliario</span></p>")),
                                  h4(agente$name),
                                  h5(agencia_nam, style = "padding-bottom: 0px; margin-bottom: 4px"),
                                  if(agente$user != ""){
                                    div(class = "btn-group",
                                        a(href= paste0("mailto:", agente$user), target="_blank", 
                                          actionButton("nada", "" , icon = icon("envelope"),
                                                       style = "font-size: 150%; padding: 0px; padding-left: 0px; background-color: transparent; border-color: transparent"))
                                    )
                                  },
                                  if(!is.na(agente$phone)){
                                    text_wp <- paste0("https://wa.me/", agente$phone, "?text=", "")
                                    div(class = "btn-group",
                                        a(href= text_wp, target ="_blank", actionButton("nada", NULL , icon = icon("whatsapp"),
                                                                                        style = "font-size: 150%; padding: 0px; padding-left: 10px;
                                                                                                          background-color: transparent; border-color: transparent"))
                                    )
                                  },
                                  if(!is.na(agente$phone)){
                                    div(class = "btn-group",
                                        h5(agente$phone, style = "padding-left: 10px")
                                    )
                                  }
                              ),
                              div(class = "btn-group", style = "position: absolute; margin-left: 10px; margin-top: 0px",
                                  div(actionButton("nada", NULL, style = paste0('background-color: transparent;
                                                             border: 0px; width:110px; height: 110px; margin: 0px;
                                                             background-image: url("', agente$img, '");
                                                             background-size: cover, 110px 110px;
                                                             border-radius: 8px 8px 8px 8px')),
                                  )
                              )
                          )
                )
              )
          )
      ),
      br(),
      tags$div(id="bttn_modal", 
               actionBttn("close_modal", "OK"),
               align = "center"),
      title = paste0("Detalles de la búsqueda"),
      easyClose = TRUE,
      footer = NULL,
      size = "l",
      fade = TRUE
    )))
  })
  
}





































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































